# H∆∞·ªõng D·∫´n Ki·ªÉm Tra Gi√° Tr·ªã ƒê∆°n H√†ng v√† Thanh To√°n Qua PayOS

## üìã T·ªïng Quan

D·ª± √°n Restaurant Booking Platform ƒë√£ t√≠ch h·ª£p ƒë·∫ßy ƒë·ªß t√≠nh nƒÉng t√≠nh to√°n t·ªïng ti·ªÅn ƒë∆°n h√†ng v√† thanh to√°n qua PayOS. T√†i li·ªáu n√†y s·∫Ω gi·∫£i th√≠ch chi ti·∫øt c√°ch h·ªá th·ªëng ho·∫°t ƒë·ªông.

---

## üí∞ 1. C√°ch T√≠nh T·ªïng Ti·ªÅn ƒê∆°n H√†ng

### 1.1. C√¥ng Th·ª©c T√≠nh T·ªïng

T·ªïng ti·ªÅn ƒë∆°n h√†ng (booking) ƒë∆∞·ª£c t√≠nh b·∫±ng c√¥ng th·ª©c:

```
T·ªîNG TI·ªÄN = Ti·ªÅn ƒê·∫∑t C·ªçc + T·ªïng Ti·ªÅn M√≥n ƒÇn + T·ªïng Ti·ªÅn D·ªãch V·ª•
```

### 1.2. Chi Ti·∫øt Implementation

File: `src/main/java/com/example/booking/service/BookingService.java`

```java
/**
 * Method t√≠nh t·ªïng ti·ªÅn cho booking
 */
public BigDecimal calculateTotalAmount(Booking booking) {
    BigDecimal total = BigDecimal.ZERO;
    
    // 1. C·ªông ti·ªÅn ƒë·∫∑t c·ªçc (deposit)
    total = total.add(booking.getDepositAmount());
    
    // 2. C·ªông t·ªïng ti·ªÅn c√°c m√≥n ƒÉn ƒë√£ ƒë·∫∑t
    List<BookingDish> bookingDishes = bookingDishRepository.findByBooking(booking);
    if (!bookingDishes.isEmpty()) {
        for (BookingDish bookingDish : bookingDishes) {
            // M·ªói m√≥n: gi√° * s·ªë l∆∞·ª£ng
            total = total.add(bookingDish.getTotalPrice());
        }
    }
    
    // 3. C·ªông t·ªïng ti·ªÅn c√°c d·ªãch v·ª• ƒë√£ ch·ªçn
    List<BookingService> bookingServices = bookingServiceRepository.findByBooking(booking);
    if (!bookingServices.isEmpty()) {
        for (BookingService bookingService : bookingServices) {
            // M·ªói d·ªãch v·ª•: gi√° * s·ªë l∆∞·ª£ng
            total = total.add(bookingService.getTotalPrice());
        }
    }
    
    return total;
}
```

### 1.3. V√≠ D·ª• T√≠nh To√°n

```
Booking ID: 123
‚îú‚îÄ‚îÄ Ti·ªÅn ƒë·∫∑t c·ªçc: 100,000 VNƒê
‚îú‚îÄ‚îÄ M√≥n ƒÉn:
‚îÇ   ‚îú‚îÄ‚îÄ Ph·ªü B√≤ x 2 = 80,000 VNƒê
‚îÇ   ‚îî‚îÄ‚îÄ C∆°m G√† x 1 = 50,000 VNƒê
‚îî‚îÄ‚îÄ D·ªãch v·ª•:
    ‚îî‚îÄ‚îÄ Trang tr√≠ sinh nh·∫≠t x 1 = 200,000 VNƒê

‚ûú T·ªîNG TI·ªÄN = 100,000 + 130,000 + 200,000 = 430,000 VNƒê
```

---

## üîê 2. C·∫•u Tr√∫c Database

### 2.1. B·∫£ng Booking

```sql
CREATE TABLE booking (
    booking_id        INTEGER PRIMARY KEY,
    customer_id       UUID NOT NULL,
    restaurant_id     INTEGER NOT NULL,
    booking_time      TIMESTAMPTZ NOT NULL,
    number_of_guests  INTEGER NOT NULL,
    status            VARCHAR(20) DEFAULT 'pending',
    deposit_amount    NUMERIC(18,2) DEFAULT 0,  -- Ti·ªÅn ƒë·∫∑t c·ªçc
    note              TEXT,
    created_at        TIMESTAMPTZ DEFAULT now(),
    updated_at        TIMESTAMPTZ DEFAULT now()
);
```

### 2.2. B·∫£ng Payment

```sql
CREATE TABLE payment (
    payment_id              INTEGER PRIMARY KEY,
    customer_id             UUID NOT NULL,
    booking_id              INTEGER NOT NULL,
    amount                  NUMERIC(18,2) NOT NULL,  -- S·ªë ti·ªÅn thanh to√°n
    payment_method          VARCHAR(20),              -- PAYOS, CASH, MOMO, etc.
    status                  VARCHAR(20) DEFAULT 'PENDING',
    payment_type            VARCHAR(20) DEFAULT 'DEPOSIT',
    order_code              BIGINT UNIQUE,           -- M√£ ƒë∆°n h√†ng cho PayOS
    payos_payment_link_id   VARCHAR(255),
    payos_checkout_url      TEXT,
    paid_at                 TIMESTAMPTZ DEFAULT now()
);
```

### 2.3. B·∫£ng BookingDish (M√≥n ƒÉn trong ƒë∆°n)

```sql
CREATE TABLE booking_dish (
    booking_dish_id  INTEGER PRIMARY KEY,
    booking_id       INTEGER NOT NULL,
    dish_id          INTEGER NOT NULL,
    quantity         INTEGER NOT NULL,
    total_price      NUMERIC(18,2) NOT NULL  -- = dish.price * quantity
);
```

### 2.4. B·∫£ng BookingService (D·ªãch v·ª• trong ƒë∆°n)

```sql
CREATE TABLE booking_service (
    booking_service_id  INTEGER PRIMARY KEY,
    booking_id          INTEGER NOT NULL,
    service_id          INTEGER NOT NULL,
    quantity            INTEGER NOT NULL,
    total_price         NUMERIC(18,2) NOT NULL  -- = service.price * quantity
);
```

---

## üöÄ 3. Lu·ªìng Thanh To√°n Qua PayOS

### 3.1. S∆° ƒê·ªì Lu·ªìng Thanh To√°n

```
1. Kh√°ch h√†ng t·∫°o booking
   ‚Üì
2. H·ªá th·ªëng t√≠nh t·ªïng ti·ªÅn (calculateTotalAmount)
   ‚Üì
3. Kh√°ch ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n: PayOS
   ‚Üì
4. H·ªá th·ªëng t·∫°o Payment record (PaymentService.createPayment)
   ‚Üì
5. G·ªçi PayOS API t·∫°o payment link (PayOsService.createPaymentLink)
   ‚Üì
6. PayOS tr·∫£ v·ªÅ checkout URL
   ‚Üì
7. Redirect kh√°ch h√†ng ƒë·∫øn trang thanh to√°n PayOS
   ‚Üì
8. Kh√°ch thanh to√°n tr√™n PayOS
   ‚Üì
9. PayOS g·ª≠i webhook v·ªÅ server
   ‚Üì
10. H·ªá th·ªëng x·ª≠ l√Ω webhook (PaymentService.handlePayOsWebhook)
    ‚Üì
11. C·∫≠p nh·∫≠t tr·∫°ng th√°i Payment: COMPLETED
    ‚Üì
12. C·∫≠p nh·∫≠t tr·∫°ng th√°i Booking: CONFIRMED
```

### 3.2. Chi Ti·∫øt Implementation

#### B∆∞·ªõc 1: T·∫°o Payment Record

File: `src/main/java/com/example/booking/service/PaymentService.java`

```java
public Payment createPayment(Integer bookingId, UUID customerId, 
                            PaymentMethod paymentMethod, 
                            PaymentType paymentType, 
                            String voucherCode) {
    
    // 1. L·∫•y th√¥ng tin booking
    Booking booking = bookingRepository.findById(bookingId)
        .orElseThrow(() -> new IllegalArgumentException("Booking not found"));
    
    // 2. T√≠nh t·ªïng ti·ªÅn
    BigDecimal totalAmount = calculateTotalAmount(booking, paymentType, voucherCode);
    
    // 3. T·∫°o Payment record
    Payment payment = new Payment();
    payment.setCustomer(customer);
    payment.setBooking(booking);
    payment.setAmount(totalAmount);
    payment.setPaymentMethod(paymentMethod);
    payment.setPaymentType(paymentType);
    payment.setStatus(PaymentStatus.PENDING);
    
    // 4. Generate orderCode duy nh·∫•t cho PayOS
    Long orderCode = generateUniqueOrderCode(bookingId);
    payment.setOrderCode(orderCode);
    
    // 5. L∆∞u v√†o database
    return paymentRepository.save(payment);
}
```

#### B∆∞·ªõc 2: T·∫°o PayOS Payment Link

File: `src/main/java/com/example/booking/service/PayOsService.java`

```java
public CreateLinkResponse createPaymentLink(long orderCode, 
                                           long amount, 
                                           String description) {
    // 1. T·∫°o signature HMAC-SHA256
    String signature = signCreate(amount, cancelUrl, description, orderCode, returnUrl);
    
    // 2. Chu·∫©n b·ªã payload
    Map<String, Object> payload = new HashMap<>();
    payload.put("orderCode", orderCode);
    payload.put("amount", amount);                    // S·ªë ti·ªÅn (VNƒê)
    payload.put("description", description);          // M√¥ t·∫£ giao d·ªãch
    payload.put("cancelUrl", cancelUrl);             // URL khi h·ªßy
    payload.put("returnUrl", returnUrl);             // URL khi th√†nh c√¥ng
    payload.put("expiredAt", Instant.now().plusSeconds(15 * 60).getEpochSecond()); // H·∫øt h·∫°n sau 15 ph√∫t
    payload.put("signature", signature);
    
    // 3. G·ªçi PayOS API
    HttpHeaders headers = new HttpHeaders();
    headers.setContentType(MediaType.APPLICATION_JSON);
    headers.add("x-client-idx-api-key", clientId + apiKey);
    
    String url = endpoint + "/v2/payment-requests";
    ResponseEntity<CreateLinkResponse> resp = restTemplate.exchange(
        URI.create(url), HttpMethod.POST, new HttpEntity<>(payload, headers), 
        CreateLinkResponse.class
    );
    
    return resp.getBody();
}
```

#### B∆∞·ªõc 3: X·ª≠ L√Ω Webhook T·ª´ PayOS

File: `src/main/java/com/example/booking/service/PaymentService.java`

```java
public boolean handlePayOsWebhook(String rawBody) {
    try {
        // 1. Parse JSON webhook
        ObjectMapper mapper = new ObjectMapper();
        WebhookRequest webhookRequest = mapper.readValue(rawBody, WebhookRequest.class);
        WebhookData data = webhookRequest.getData();
        
        // 2. T√¨m Payment theo orderCode
        Integer orderCode = data.getOrderCode();
        Payment payment = paymentRepository.findByOrderCode(orderCode.longValue())
            .orElseThrow(() -> new IllegalArgumentException("Payment not found"));
        
        // 3. Ki·ªÉm tra tr·∫°ng th√°i thanh to√°n
        boolean success = Boolean.TRUE.equals(webhookRequest.getSuccess()) 
                       && "00".equals(data.getCode());
        
        if (success) {
            // ‚úÖ Thanh to√°n th√†nh c√¥ng
            payment.setStatus(PaymentStatus.COMPLETED);
            payment.setPaidAt(LocalDateTime.now());
            
            // Confirm booking
            bookingService.confirmBooking(payment.getBooking().getBookingId());
        } else {
            // ‚ùå Thanh to√°n th·∫•t b·∫°i
            payment.setStatus(PaymentStatus.FAILED);
        }
        
        // 4. L∆∞u l·∫°i raw webhook data
        payment.setIpnRaw(rawBody);
        paymentRepository.save(payment);
        
        return true;
    } catch (Exception e) {
        logger.error("Error processing PayOS webhook", e);
        return false;
    }
}
```

---

## ‚öôÔ∏è 4. C·∫•u H√¨nh PayOS

### 4.1. File C·∫•u H√¨nh

File: `src/main/resources/application.yml`

```yaml
payment:
  payos:
    client-id: ${PAYOS_CLIENT_ID}           # Client ID t·ª´ PayOS
    api-key: ${PAYOS_API_KEY}               # API Key t·ª´ PayOS
    checksum-key: ${PAYOS_CHECKSUM_KEY}     # Checksum Key ƒë·ªÉ verify signature
    endpoint: https://api-merchant.payos.vn  # PayOS API endpoint
    return-url: ${PAYOS_RETURN_URL:http://localhost:8081/payment/payos/return}
    cancel-url: ${PAYOS_CANCEL_URL:http://localhost:8081/payment/payos/cancel}
```

### 4.2. Bi·∫øn M√¥i Tr∆∞·ªùng

T·∫°o file `.env` ho·∫∑c set environment variables:

```bash
# PayOS Configuration
PAYOS_CLIENT_ID=your-client-id-here
PAYOS_API_KEY=your-api-key-here
PAYOS_CHECKSUM_KEY=your-checksum-key-here
PAYOS_RETURN_URL=http://localhost:8081/payment/payos/return
PAYOS_CANCEL_URL=http://localhost:8081/payment/payos/cancel
```

### 4.3. L·∫•y Th√¥ng Tin T·ª´ PayOS

1. ƒêƒÉng k√Ω t√†i kho·∫£n t·∫°i: https://payos.vn
2. V√†o **Dashboard** ‚Üí **C√†i ƒë·∫∑t** ‚Üí **API Keys**
3. Copy c√°c th√¥ng tin:
   - Client ID
   - API Key
   - Checksum Key
4. C·∫•u h√¨nh Webhook URL trong PayOS Dashboard:
   ```
   http://your-domain.com/api/payment/payos/webhook
   ```

---

## üß™ 5. Test API Endpoints

### 5.1. T·∫°o Payment v√† L·∫•y Link PayOS

**Endpoint:** `POST /payment/create`

**Request Body:**
```json
{
  "bookingId": 123,
  "paymentMethod": "PAYOS",
  "paymentType": "DEPOSIT",
  "voucherCode": ""
}
```

**Response:**
```json
{
  "success": true,
  "paymentId": 456,
  "amount": 430000,
  "orderCode": 20250107123456,
  "checkoutUrl": "https://pay.payos.vn/web/abc123xyz"
}
```

### 5.2. Ki·ªÉm Tra Tr·∫°ng Th√°i Payment

**Endpoint:** `GET /payment/{paymentId}`

**Response:**
```json
{
  "paymentId": 456,
  "bookingId": 123,
  "amount": 430000,
  "status": "COMPLETED",
  "paymentMethod": "PAYOS",
  "orderCode": 20250107123456,
  "paidAt": "2025-01-07T10:30:00"
}
```

### 5.3. Webhook t·ª´ PayOS (Auto)

**Endpoint:** `POST /api/payment/payos/webhook`

PayOS s·∫Ω t·ª± ƒë·ªông g·ªçi endpoint n√†y khi thanh to√°n th√†nh c√¥ng:

```json
{
  "code": "00",
  "desc": "Success",
  "success": true,
  "data": {
    "orderCode": 20250107123456,
    "amount": 430000,
    "description": "Thanh toan dat ban #123",
    "accountNumber": "12345678",
    "reference": "FT25010712345678",
    "transactionDateTime": "2025-01-07T10:30:00",
    "paymentLinkId": "abc123xyz"
  }
}
```

---

## üì± 6. Flow Ng∆∞·ªùi D√πng (Frontend)

### 6.1. Trang Thanh To√°n

File: `src/main/resources/templates/payment/create.html`

```html
<!-- Hi·ªÉn th·ªã t·ªïng ti·ªÅn -->
<div class="total-amount">
    <h4>T·ªïng ti·ªÅn: <span th:text="${#numbers.formatDecimal(totalAmount, 0, 'COMMA', 0, 'POINT')}"></span> VNƒê</h4>
</div>

<!-- Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n -->
<form method="post" th:action="@{/payment/create}">
    <input type="hidden" name="bookingId" th:value="${booking.bookingId}">
    
    <div class="payment-methods">
        <label>
            <input type="radio" name="paymentMethod" value="PAYOS" required>
            <img src="/images/payos-logo.png" alt="PayOS">
            Thanh to√°n qua PayOS
        </label>
        
        <label>
            <input type="radio" name="paymentMethod" value="CASH">
            Thanh to√°n ti·ªÅn m·∫∑t
        </label>
    </div>
    
    <button type="submit" class="btn btn-primary">Thanh to√°n</button>
</form>
```

### 6.2. Trang K·∫øt Qu·∫£ Thanh To√°n

**URL Return Success:** `/payment/payos/return?orderCode=xxx&status=PAID`

```html
<div class="payment-success">
    <h2>‚úÖ Thanh to√°n th√†nh c√¥ng!</h2>
    <p>M√£ ƒë∆°n h√†ng: <span th:text="${orderCode}"></span></p>
    <p>Booking c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n.</p>
    <a th:href="@{/booking/my}" class="btn btn-primary">Xem booking c·ªßa t√¥i</a>
</div>
```

**URL Cancel:** `/payment/payos/cancel`

```html
<div class="payment-cancelled">
    <h2>‚ùå Thanh to√°n ƒë√£ b·ªã h·ªßy</h2>
    <p>B·∫°n c√≥ th·ªÉ th·ª≠ l·∫°i ho·∫∑c ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n kh√°c.</p>
    <a th:href="@{/payment/{id}(id=${bookingId})}" class="btn btn-secondary">Th·ª≠ l·∫°i</a>
</div>
```

---

## üêõ 7. Debugging v√† Logging

### 7.1. Xem Log T√≠nh To√°n T·ªïng Ti·ªÅn

File: `src/main/java/com/example/booking/service/BookingService.java`

```java
public BigDecimal calculateTotalAmount(Booking booking) {
    System.out.println("üí∞ Deposit amount: " + booking.getDepositAmount());
    
    // Log t·ª´ng m√≥n ƒÉn
    for (BookingDish dish : bookingDishes) {
        System.out.println("üçΩÔ∏è Dish: " + dish.getDish().getName() + 
                         " x" + dish.getQuantity() + 
                         " = " + dish.getTotalPrice());
    }
    
    // Log t·ª´ng d·ªãch v·ª•
    for (BookingService service : bookingServices) {
        System.out.println("üîß Service: " + service.getService().getName() + 
                         " x" + service.getQuantity() + 
                         " = " + service.getTotalPrice());
    }
    
    System.out.println("üí∞ TOTAL AMOUNT: " + total);
    return total;
}
```

### 7.2. Test Locally v·ªõi ngrok

V√¨ PayOS c·∫ßn g·ªçi webhook v·ªÅ server, b·∫°n c·∫ßn expose localhost:

```bash
# Install ngrok
npm install -g ngrok

# Expose port 8081
ngrok http 8081

# Copy URL v√† c·∫•u h√¨nh trong PayOS Dashboard
# V√≠ d·ª•: https://abc123.ngrok.io/api/payment/payos/webhook
```

---

## üìä 8. Flow Chart T·ªïng Th·ªÉ

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Kh√°ch h√†ng     ‚îÇ
‚îÇ  t·∫°o booking    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ calculateTotalAmount()      ‚îÇ
‚îÇ = Deposit + Dishes + Svcs   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Ch·ªçn ph∆∞∆°ng th·ª©c: PayOS     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ PaymentService              ‚îÇ
‚îÇ .createPayment()            ‚îÇ
‚îÇ - Generate orderCode        ‚îÇ
‚îÇ - Save to DB                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ PayOsService                ‚îÇ
‚îÇ .createPaymentLink()        ‚îÇ
‚îÇ - Call PayOS API            ‚îÇ
‚îÇ - Get checkout URL          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Redirect kh√°ch ƒë·∫øn PayOS    ‚îÇ
‚îÇ Kh√°ch thanh to√°n            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ PayOS g·ª≠i webhook           ‚îÇ
‚îÇ POST /api/payment/webhook   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ handlePayOsWebhook()        ‚îÇ
‚îÇ - Update Payment: COMPLETED ‚îÇ
‚îÇ - Confirm Booking           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîí 9. Security Best Practices

### 9.1. Verify Webhook Signature

```java
public boolean verifyWebhook(String body, String signature) {
    try {
        String expected = hmacSHA256(body, checksumKey);
        return expected.equals(signature);
    } catch (Exception e) {
        logger.error("Verify webhook signature failed", e);
        return false;
    }
}
```

### 9.2. Validate Order Code

```java
// ƒê·∫£m b·∫£o orderCode l√† duy nh·∫•t
private Long generateUniqueOrderCode(Integer bookingId) {
    long timestamp = System.currentTimeMillis();
    long orderCode = timestamp * 1000 + bookingId;
    
    // Check if exists
    while (paymentRepository.existsByOrderCode(orderCode)) {
        orderCode++;
    }
    
    return orderCode;
}
```

---

## üìû 10. Support & Resources

### 10.1. PayOS Documentation
- API Docs: https://payos.vn/docs/
- Webhook Guide: https://payos.vn/docs/webhook
- Testing: https://payos.vn/docs/testing

### 10.2. Project Files
- PayOS Service: `src/main/java/com/example/booking/service/PayOsService.java`
- Payment Service: `src/main/java/com/example/booking/service/PaymentService.java`
- Booking Service: `src/main/java/com/example/booking/service/BookingService.java`
- Payment Controller: `src/main/java/com/example/booking/web/controller/PaymentController.java`

### 10.3. Li√™n H·ªá
- Nh√≥m ph√°t tri·ªÉn: SWP391 Restaurant Booking Team
- Email support: support@bookeat.vn (example)

---

## ‚úÖ Checklist Tri·ªÉn Khai

- [ ] ƒêƒÉng k√Ω t√†i kho·∫£n PayOS
- [ ] L·∫•y Client ID, API Key, Checksum Key
- [ ] C·∫•u h√¨nh bi·∫øn m√¥i tr∆∞·ªùng (.env)
- [ ] Deploy server l√™n production
- [ ] C·∫•u h√¨nh Webhook URL trong PayOS Dashboard
- [ ] Test thanh to√°n sandbox
- [ ] Test thanh to√°n production
- [ ] X√°c nh·∫≠n webhook ho·∫°t ƒë·ªông
- [ ] Monitor logs v√† errors
- [ ] Setup alerting cho payment failures

---

**Ch√∫c b·∫°n th√†nh c√¥ng v·ªõi t√≠ch h·ª£p PayOS!** üöÄ

