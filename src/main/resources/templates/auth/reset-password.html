<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đặt lại mật khẩu - Book Eat</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link th:href="@{/css/design-system.css}" rel="stylesheet">
    <link th:href="@{/css/auth-common.css}" rel="stylesheet">
</head>
<body class="ds-bg-white">
    <!-- Unified Header -->
    <div th:with="activeNav=''"
         th:replace="~{fragments/design-system-components :: unified-header}"></div>

    <main>
        <!-- Compact Header Section -->
        <section class="ds-bg-gray-50" style="padding: var(--ds-space-8) 0;">
            <div class="ds-container ds-text-center">
                <nav class="ds-breadcrumb ds-mb-2" aria-label="breadcrumb">
                    <ol class="ds-breadcrumb-list">
                        <li class="ds-breadcrumb-item"><a th:href="@{/}">Trang chủ</a></li>
                        <li class="ds-breadcrumb-item"><a th:href="@{/login}">Đăng nhập</a></li>
                        <li class="ds-breadcrumb-item active"><span>Đặt lại mật khẩu</span></li>
                    </ol>
                </nav>
            </div>
        </section>

        <!-- Reset Password Form Section -->
        <section style="padding: var(--ds-space-12) 0;">
            <div class="ds-container">
                <div class="auth-form-container">
                    <div class="ds-card">
                        <div class="ds-card-body">
                            <!-- Icon and Title -->
                            <div class="ds-text-center ds-mb-4">
                                <div class="ds-flex ds-items-center ds-justify-center ds-gap-2">
                                    <div class="feature-icon" style="width: 30px; height: 30px; font-size: var(--ds-font-size-base); display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-lock"></i>
                                    </div>
                                    <h5 class="ds-heading-5 ds-mb-0" style="line-height: 1;">Đặt lại mật khẩu</h5>
                                </div>
                            </div>
                            
                            <!-- Flash Messages -->
                            <div th:insert="fragments/flash :: flash"></div>

                            <!-- Reset Password Form -->
                            <form th:action="@{/auth/reset-password}" method="post" th:object="${resetPasswordForm}">
                                <input type="hidden" th:field="*{token}" />
                                
                                <!-- New Password -->
                                <div class="ds-form-group ds-mb-3">
                                    <label for="newPassword" class="ds-form-label">
                                        <i class="fas fa-lock form-icon"></i> 
                                        Mật khẩu mới <span class="required">*</span>
                                    </label>
                                    <input type="password" 
                                           class="ds-form-input" 
                                           id="newPassword" 
                                           name="newPassword"
                                           th:field="*{newPassword}"
                                           th:classappend="${#fields.hasErrors('newPassword')} ? 'ds-form-input-error' : ''"
                                           placeholder="Nhập mật khẩu mới"
                                           minlength="8"
                                           pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$"
                                           title="Mật khẩu phải có ít nhất 8 ký tự, bao gồm chữ hoa, chữ thường, số và ký tự đặc biệt"
                                           required>
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('newPassword')}" 
                                         th:errors="*{newPassword}"></div>
                                    
                                    <!-- Password strength info -->
                                    <div class="password-strength">
                                        <small class="form-text">
                                            Mật khẩu phải có ít nhất 8 ký tự, bao gồm chữ hoa, chữ thường, số và ký tự đặc biệt (@$!%*?&)
                                        </small>
                                    </div>
                                </div>
                                
                                <!-- Confirm Password -->
                                <div class="ds-form-group ds-mb-6">
                                    <label for="confirmNewPassword" class="ds-form-label">
                                        <i class="fas fa-lock form-icon"></i> 
                                        Xác nhận mật khẩu <span class="required">*</span>
                                    </label>
                                    <input type="password" 
                                           class="ds-form-input" 
                                           id="confirmNewPassword" 
                                           name="confirmNewPassword"
                                           th:field="*{confirmNewPassword}"
                                           th:classappend="${#fields.hasErrors('confirmNewPassword')} ? 'ds-form-input-error' : ''"
                                           placeholder="Nhập lại mật khẩu mới"
                                           required>
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('confirmNewPassword')}" 
                                         th:errors="*{confirmNewPassword}"></div>
                                </div>
                                
                                <!-- Submit Button -->
                                <div class="ds-mb-4">
                                    <button type="submit" class="ds-btn ds-btn-primary ds-btn-lg" style="width: 100%;">
                                        <i class="fas fa-check ds-mr-2"></i>
                                        Đặt lại mật khẩu
                                    </button>
                                </div>
                            </form>
                            
                            <!-- Action Links -->
                            <div class="ds-text-center">
                                <a th:href="@{/login}" class="ds-btn ds-btn-secondary">
                                    <i class="fas fa-sign-in-alt ds-mr-2"></i>
                                    Đăng nhập
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <div th:replace="~{fragments/design-system-components :: unified-footer}"></div>
    <div th:replace="~{fragments/resy-scripts :: basic-scripts}"></div>

    <script>
        // Password matching validation
        document.addEventListener('DOMContentLoaded', function() {
            const newPassword = document.getElementById('newPassword');
            const confirmPassword = document.getElementById('confirmNewPassword');
            
            function validatePasswordMatch() {
                if (newPassword.value !== confirmPassword.value) {
                    confirmPassword.setCustomValidity('Mật khẩu xác nhận không khớp');
                } else {
                    confirmPassword.setCustomValidity('');
                }
            }
            
            function validatePasswordStrength() {
                const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
                if (newPassword.value && !passwordRegex.test(newPassword.value)) {
                    newPassword.setCustomValidity('Mật khẩu phải có ít nhất 8 ký tự, bao gồm chữ hoa, chữ thường, số và ký tự đặc biệt');
                } else {
                    newPassword.setCustomValidity('');
                }
                validatePasswordMatch();
            }
            
            if (newPassword && confirmPassword) {
                newPassword.addEventListener('input', validatePasswordStrength);
                confirmPassword.addEventListener('input', validatePasswordMatch);
            }
        });
    </script>
</body>
</html>