<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đăng ký - Book Eat</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link th:href="@{/css/design-system.css}" rel="stylesheet">
    <link th:href="@{/css/auth-common.css}" rel="stylesheet">
    <style>
        .password-field-group .password-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }
        .password-field-group .password-input-wrapper input.ds-form-input {
            padding-right: 2.75rem;
        }
        .password-field-group .password-toggle {
            position: absolute;
            right: 0.75rem;
            z-index: 2;
            background: transparent;
            border: none;
            color: var(--ds-neutral-500, #6b7280);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            width: 2rem;
            height: 2rem;
            font-size: 1rem;
        }
        .password-field-group .password-toggle:focus {
            outline: none;
            color: var(--ds-primary-600, #2563eb);
        }
    </style>
</head>
<body class="ds-bg-white">
    <!-- Unified Header -->
    <div th:with="activeNav=''"
         th:replace="~{fragments/design-system-components :: unified-header}"></div>

    <main>
        <!-- Compact Header Section -->
        <section class="ds-bg-gray-50" style="padding: var(--ds-space-8) 0;">
            <div class="ds-container">
                <nav class="ds-breadcrumb" aria-label="breadcrumb">
                    <ol class="ds-breadcrumb-list">
                        <li class="ds-breadcrumb-item">
                            <a th:href="@{/}">Trang chủ</a>
                        </li>
                        <li class="ds-breadcrumb-item active">
                            <span>Đăng ký</span>
                        </li>
                    </ol>
                </nav>

                <div class="ds-flex ds-flex-col ds-items-center ds-text-center ds-gap-2">
                    <h4 class="ds-heading-4">Đăng ký tài khoản</h4>
                    <p class="ds-text-sm ds-text-secondary" style="max-width: 480px; font-style: italic;">
                        Tạo tài khoản để trải nghiệm dịch vụ đặt bàn nhà hàng tốt nhất
                    </p>
                </div>
            </div>
        </section>

        <!-- Register Form Section -->
        <section style="padding: var(--ds-space-12) 0;">
            <div class="ds-container">
                <div class="auth-form-container">
                    <div class="ds-card">
                        <div class="ds-card-body">
                            <!-- Icon and Title -->
                            <div class="ds-text-center ds-mb-4">
                                <div class="ds-flex ds-items-center ds-justify-center ds-gap-2">
                                    <div class="feature-icon" style="width: 30px; height: 30px; font-size: var(--ds-font-size-base); display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-user-plus"></i>
                                    </div>
                                    <h5 class="ds-heading-5 ds-mb-0" style="line-height: 1;">Đăng ký tài khoản</h5>
                                </div>
                            </div>
                            
                            <!-- Error Message -->
                            <div th:if="${errorMessage}" class="ds-alert ds-alert-error ds-mb-4">
                                <i class="fas fa-exclamation-triangle ds-mr-2"></i>
                                <span th:text="${errorMessage}"></span>
                            </div>
                            
                            <!-- Register Form -->
                            <form th:action="@{/auth/register}" method="post" th:object="${registerForm}" id="registerForm">
                                <input type="hidden" id="accountType" th:field="*{accountType}">
                                
                                <!-- Username -->
                                <div class="ds-form-group ds-mb-4">
                                    <label for="username" class="ds-form-label">
                                        <i class="fas fa-user form-icon"></i> 
                                        Username <span class="required">*</span>
                                    </label>
                                    <input type="text" 
                                           class="ds-form-input" 
                                           id="username" 
                                           name="username"
                                           th:field="*{username}"
                                           th:classappend="${#fields.hasErrors('username')} ? 'ds-form-input-error' : ''"
                                           placeholder="Nhập username">
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('username')}" 
                                         th:errors="*{username}"></div>
                                </div>
                                
                                <!-- Email -->
                                <div class="ds-form-group ds-mb-4">
                                    <label for="email" class="ds-form-label">
                                        <i class="fas fa-envelope form-icon"></i> 
                                        Email <span class="required">*</span>
                                    </label>
                                    <input type="email" 
                                           class="ds-form-input" 
                                           id="email" 
                                           name="email"
                                           th:field="*{email}"
                                           th:classappend="${#fields.hasErrors('email')} ? 'ds-form-input-error' : ''"
                                           placeholder="Nhập email (VD: example@gmail.com)"
                                           pattern=".*@(gmail\.com|outlook\.com\.vn|yahoo\.com|hotmail\.com|student\.ctu\.edu\.vn|ctu\.edu\.vn)$"
                                           title="Email phải thuộc một trong các domain: @gmail.com, @outlook.com.vn, @yahoo.com, @hotmail.com, @student.ctu.edu.vn, @ctu.edu.vn">
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('email')}" 
                                         th:errors="*{email}"></div>
                                    <small class="form-text">Chỉ chấp nhận: @gmail.com, @outlook.com.vn, @yahoo.com, @hotmail.com, @student.ctu.edu.vn, @ctu.edu.vn</small>
                                </div>
                                
                                <!-- Full Name -->
                                <div class="ds-form-group ds-mb-4">
                                    <label for="fullName" class="ds-form-label">
                                        <i class="fas fa-id-card form-icon"></i> 
                                        Họ và tên <span class="required">*</span>
                                    </label>
                                    <input type="text" 
                                           class="ds-form-input" 
                                           id="fullName" 
                                           name="fullName"
                                           th:field="*{fullName}"
                                           th:classappend="${#fields.hasErrors('fullName')} ? 'ds-form-input-error' : ''"
                                           placeholder="Nhập họ và tên">
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('fullName')}" 
                                         th:errors="*{fullName}"></div>
                                </div>
                                
                                <!-- Phone Number -->
                                <div class="ds-form-group ds-mb-4">
                                    <label for="phoneNumber" class="ds-form-label">
                                        <i class="fas fa-phone form-icon"></i> 
                                        Số điện thoại
                                    </label>
                                    <input type="tel" 
                                           class="ds-form-input" 
                                           id="phoneNumber" 
                                           name="phoneNumber"
                                           th:field="*{phoneNumber}"
                                           th:classappend="${#fields.hasErrors('phoneNumber')} ? 'ds-form-input-error' : ''"
                                           placeholder="Nhập số điện thoại (VD: 0987654321)"
                                           pattern="^(0[3|5|7|8|9])[0-9]{8}$"
                                           title="Số điện thoại phải là 10 số và bắt đầu bằng 03, 05, 07, 08, 09">
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('phoneNumber')}" 
                                         th:errors="*{phoneNumber}"></div>
                                    <small class="form-text">Định dạng: 0987654321 (10 số, bắt đầu bằng 03, 05, 07, 08, 09)</small>
                                </div>
                                
                                <!-- Address -->
                                <div class="ds-form-group ds-mb-4">
                                    <label for="address" class="ds-form-label">
                                        <i class="fas fa-map-marker-alt form-icon"></i> 
                                        Địa chỉ
                                    </label>
                                    <input type="text" 
                                           class="ds-form-input" 
                                           id="address" 
                                           name="address"
                                           th:field="*{address}"
                                           th:classappend="${#fields.hasErrors('address')} ? 'ds-form-input-error' : ''"
                                           placeholder="Nhập địa chỉ (tùy chọn)">
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('address')}" 
                                         th:errors="*{address}"></div>
                                </div>
                                
                                <!-- Password -->
                                <div class="ds-form-group ds-mb-4 password-field-group">
                                    <label for="password" class="ds-form-label">
                                        <i class="fas fa-lock form-icon"></i> 
                                        Mật khẩu <span class="required">*</span>
                                    </label>
                                    <div class="password-input-wrapper">
                                        <input type="password" 
                                               class="ds-form-input" 
                                               id="password" 
                                               name="password"
                                               th:field="*{password}"
                                               th:classappend="${#fields.hasErrors('password')} ? 'ds-form-input-error' : ''"
                                               placeholder="Nhập mật khẩu"
                                               minlength="8"
                                               pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$"
                                               title="Mật khẩu phải có ít nhất 8 ký tự, bao gồm chữ hoa, chữ thường, số và ký tự đặc biệt">
                                        <button type="button" class="password-toggle" data-target="password" aria-label="Hiển thị mật khẩu">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('password')}" 
                                         th:errors="*{password}"></div>
                                    <small class="form-text">Mật khẩu phải có ít nhất 8 ký tự, bao gồm chữ hoa, chữ thường, số và ký tự đặc biệt (@$!%*?&)</small>
                                </div>
                                
                                <!-- Confirm Password -->
                                <div class="ds-form-group ds-mb-6 password-field-group">
                                    <label for="confirmPassword" class="ds-form-label">
                                        <i class="fas fa-lock form-icon"></i> 
                                        Xác nhận mật khẩu <span class="required">*</span>
                                    </label>
                                    <div class="password-input-wrapper">
                                        <input type="password" 
                                               class="ds-form-input" 
                                               id="confirmPassword" 
                                               name="confirmPassword"
                                               th:field="*{confirmPassword}"
                                               th:classappend="${#fields.hasErrors('confirmPassword')} ? 'ds-form-input-error' : ''"
                                               placeholder="Nhập lại mật khẩu">
                                        <button type="button" class="password-toggle" data-target="confirmPassword" aria-label="Hiển thị lại mật khẩu">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('confirmPassword')}" 
                                         th:errors="*{confirmPassword}"></div>
                                </div>
                                
                                <!-- Register Button -->
                                <div class="ds-mb-4">
                                    <button type="submit" class="ds-btn ds-btn-primary ds-btn-lg" style="width: 100%;">
                                        <i class="fas fa-user-plus ds-mr-2"></i>
                                        Đăng ký
                                    </button>
                                </div>
                            </form>
                            
                            <!-- Divider -->
                            <div class="ds-flex ds-items-center ds-gap-4 ds-text-center ds-text-secondary ds-mb-4" style="text-transform: uppercase; font-size: var(--ds-font-size-xs);">
                                <span style="flex:1;height:1px;background: var(--ds-neutral-300);"></span>
                                <span>hoặc</span>
                                <span style="flex:1;height:1px;background: var(--ds-neutral-300);"></span>
                            </div>
                            
                            <!-- Google Register -->
                            <div class="ds-mb-4">
                                <a href="/oauth2/authorization/google" class="ds-btn ds-btn-secondary ds-btn-lg" style="width: 100%;">
                                    <i class="fab fa-google ds-mr-2"></i>
                                    Tiếp tục với Google
                                </a>
                            </div>
                            
                            <!-- Login Link -->
                            <div class="ds-text-center">
                                <p class="ds-mb-0 ds-text-secondary">
                                    Đã có tài khoản? 
                                    <button type="button" class="ds-link ds-link-primary" data-bs-toggle="modal" data-bs-target="#loginModal" style="background: none; border: none; padding: 0; text-decoration: none;">
                                        <i class="fas fa-sign-in-alt ds-mr-1"></i>
                                        Đăng nhập ngay
                                    </button>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Account Type Selection Modal -->
    <div id="accountTypeOverlay" class="account-type-overlay" role="dialog" aria-modal="true" aria-labelledby="accountTypeTitle" aria-hidden="false">
        <div class="account-type-modal">
            <div class="ds-card">
                <div class="ds-card-body" style="padding: var(--ds-space-8);">
                    <div class="ds-text-center ds-mb-6">
                        <h2 id="accountTypeTitle" class="ds-heading-3 ds-mb-2">Chọn loại tài khoản</h2>
                        <p class="ds-text-large ds-text-secondary">Bạn muốn đăng ký với vai trò nào?</p>
                    </div>
                    <div class="account-type-actions">
                        <button type="button" class="ds-card account-type-card" data-type="customer">
                            <div class="ds-card-body">
                                <span class="account-type-icon" aria-hidden="true"><i class="fas fa-user"></i></span>
                                <div>
                                    <h5 class="account-type-title">Đăng ký khách hàng</h5>
                                    <p class="account-type-desc">Dùng để đặt bàn, khám phá nhà hàng và nhận ưu đãi.</p>
                                </div>
                            </div>
                        </button>
                        <button type="button" class="ds-card account-type-card" data-type="restaurant_owner">
                            <div class="ds-card-body">
                                <span class="account-type-icon" aria-hidden="true"><i class="fas fa-store"></i></span>
                                <div>
                                    <h5 class="account-type-title">Đăng ký chủ nhà hàng</h5>
                                    <p class="account-type-desc">Quản lý nhà hàng, đặt bàn và chương trình ưu đãi dành riêng.</p>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div th:replace="~{fragments/design-system-components :: unified-footer}"></div>
    <div th:replace="~{fragments/resy-scripts :: basic-scripts}"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const registerForm = document.getElementById('registerForm');
            const password = registerForm ? registerForm.querySelector('#password') : null;
            const confirmPassword = registerForm ? registerForm.querySelector('#confirmPassword') : null;
            const accountTypeOverlay = document.getElementById('accountTypeOverlay');
            const accountTypeInput = document.getElementById('accountType');
        const accountTypeCards = document.querySelectorAll('.account-type-card');
        const formTitle = document.querySelector('.ds-heading-4');
        const formSubtitle = document.querySelector('.ds-text-sm');
        const passwordToggleButtons = document.querySelectorAll('.password-toggle');

            function validatePasswordMatch() {
                const normalize = (s) => (s || '')
                    .normalize('NFC')
                    .replace(/[\u200B-\u200D\u2060]/g, '')
                    .replace(/\r?\n/g, '')
                    .trim();
                const p1 = normalize(password.value);
                const p2 = normalize(confirmPassword.value);
                if (p1 !== p2) {
                    confirmPassword.setCustomValidity('Mật khẩu xác nhận không khớp');
                } else {
                    confirmPassword.setCustomValidity('');
                }
            }

            function validatePasswordStrength() {
                const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
                if (password.value && !passwordRegex.test(password.value)) {
                    password.setCustomValidity('Mật khẩu phải có ít nhất 8 ký tự, bao gồm chữ hoa, chữ thường, số và ký tự đặc biệt');
                } else {
                    password.setCustomValidity('');
                }
                validatePasswordMatch();
            }

            function validateEmail() {
                const email = registerForm ? registerForm.querySelector('#email') : document.getElementById('email');
                const emailRegex = /.*@(gmail\.com|outlook\.com\.vn|yahoo\.com|hotmail\.com|student\.ctu\.edu\.vn|ctu\.edu\.vn)$/;
                if (email.value && !emailRegex.test(email.value)) {
                    email.setCustomValidity('Email phải thuộc một trong các domain: @gmail.com, @outlook.com.vn, @yahoo.com, @hotmail.com, @student.ctu.edu.vn, @ctu.edu.vn');
                } else {
                    email.setCustomValidity('');
                }
            }

            function validatePhone() {
                const phone = registerForm ? registerForm.querySelector('#phoneNumber') : document.getElementById('phoneNumber');
                const phoneRegex = /^(0[3|5|7|8|9])[0-9]{8}$|^$/;
                if (phone.value && !phoneRegex.test(phone.value)) {
                    phone.setCustomValidity('Số điện thoại phải là 10 số và bắt đầu bằng 03, 05, 07, 08, 09 hoặc để trống');
                } else {
                    phone.setCustomValidity('');
                }
            }

            if (password && confirmPassword) {
                password.addEventListener('input', validatePasswordStrength);
                confirmPassword.addEventListener('input', validatePasswordMatch);
            }

            const emailField = registerForm ? registerForm.querySelector('#email') : document.getElementById('email');
            if (emailField) {
                emailField.addEventListener('input', validateEmail);
            }

        const phoneField = registerForm ? registerForm.querySelector('#phoneNumber') : document.getElementById('phoneNumber');
        if (phoneField) {
            phoneField.addEventListener('input', validatePhone);
        }

        passwordToggleButtons.forEach(button => {
            // Prefer input next to the toggle to avoid ID conflicts (e.g., login modal)
            const wrapperInput = button.closest('.password-input-wrapper') ? button.closest('.password-input-wrapper').querySelector('input') : null;
            const targetId = button.getAttribute('data-target');
            const targetInput = wrapperInput || document.getElementById(targetId);
            const icon = button.querySelector('i');
            if (!targetInput || !icon) {
                return;
            }

            button.addEventListener('click', () => {
                const isPassword = targetInput.getAttribute('type') === 'password';
                targetInput.setAttribute('type', isPassword ? 'text' : 'password');
                icon.classList.toggle('fa-eye', !isPassword);
                icon.classList.toggle('fa-eye-slash', isPassword);
                button.setAttribute('aria-label', isPassword ? 'Ẩn mật khẩu' : 'Hiển thị mật khẩu');
            });
        });

            function showOverlay() {
                if (accountTypeOverlay) {
                    accountTypeOverlay.classList.remove('hidden');
                    accountTypeOverlay.setAttribute('aria-hidden', 'false');
                    const firstCard = accountTypeOverlay.querySelector('.account-type-card');
                    if (firstCard) {
                        firstCard.focus();
                    }
                    document.body.classList.add('overflow-hidden');
                }
            }

            function hideOverlay() {
                if (accountTypeOverlay) {
                    accountTypeOverlay.classList.add('hidden');
                    accountTypeOverlay.setAttribute('aria-hidden', 'true');
                    document.body.classList.remove('overflow-hidden');
                }
            }

            function updateFormText(type) {
                if (!formTitle || !formSubtitle) return;
                if ('restaurant_owner' === type) {
                    formTitle.textContent = 'Đăng ký chủ nhà hàng';
                    formSubtitle.textContent = 'Quản lý nhà hàng và kết nối với khách hàng';
                } else {
                    formTitle.textContent = 'Đăng ký khách hàng';
                    formSubtitle.textContent = 'Tạo tài khoản để đặt bàn dễ dàng';
                }
            }

            accountTypeCards.forEach(card => {
                card.setAttribute('tabindex', '0');
                card.addEventListener('click', () => {
                    const type = card.getAttribute('data-type');
                    if (accountTypeInput) {
                        accountTypeInput.value = type;
                    }
                    updateFormText(type);
                    hideOverlay();
                    const usernameField = document.getElementById('username');
                    if (usernameField) {
                        setTimeout(() => usernameField.focus(), 150);
                    }
                });

                card.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter' || event.key === ' ') {
                        event.preventDefault();
                        card.click();
                    }
                });
            });

            if (registerForm) {
                registerForm.addEventListener('submit', (event) => {
                    if (accountTypeOverlay && !accountTypeOverlay.classList.contains('hidden')) {
                        event.preventDefault();
                        return;
                    }

                    if (!accountTypeInput || !accountTypeInput.value) {
                        event.preventDefault();
                        showOverlay();
                        return;
                    }

                    // Re-validate equality on submit to avoid stale state
                    validatePasswordMatch();
                    if (!registerForm.checkValidity()) {
                        event.preventDefault();
                        const firstInvalid = registerForm.querySelector(':invalid');
                        if (firstInvalid) firstInvalid.focus();
                    }
                });
            }

            // Always show overlay on page load to let user choose account type
            showOverlay();
            
            // If accountType is already set, hide overlay and update form text
            if (accountTypeInput && accountTypeInput.value) {
                hideOverlay();
                updateFormText(accountTypeInput.value);
            }
        });
    </script>

    <!-- Include Login Modal -->
    <div th:insert="~{fragments/login-modal :: login-modal}"></div>
</body>
</html>