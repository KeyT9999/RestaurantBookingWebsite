<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle} ?: 'Kết quả thanh toán - Book Eat'">Kết quả thanh toán - Book Eat</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link th:href="@{/css/design-system.css}" rel="stylesheet">

</head>
<body class="ds-bg-white">

    <div th:with="activeNav='restaurants'"
         th:replace="~{fragments/design-system-components :: unified-header}"></div>

    <main>
        <section class="ds-bg-gray-50 ds-section">
            <div class="ds-container"
                 th:with="statusName=${payment != null ? payment.status.name() : 'PENDING'}, pid=${payment != null ? payment.paymentId : 0}">
                <nav class="ds-breadcrumb" aria-label="breadcrumb">
                    <ol class="ds-breadcrumb-list">
                        <li class="ds-breadcrumb-item">
                            <a th:href="@{/}">Trang chủ</a>
                        </li>
                        <li class="ds-breadcrumb-item">
                            <a th:href="@{/booking/my}">Đặt bàn của tôi</a>
                        </li>
                        <li class="ds-breadcrumb-item active">
                            <span>Kết quả thanh toán</span>
                        </li>
                    </ol>
                </nav>

                <div th:insert="~{fragments/flash :: flash}"></div>

                <article class="ds-card ds-card-emphasis ds-text-center"
                         th:if="${payment == null}">
                    <div class="ds-card-body ds-flex ds-flex-col ds-gap-4 ds-items-center">
                        <div class="ds-status-ring ds-status-ring--lg ds-status--error">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h1 class="ds-heading-3">Không tìm thấy giao dịch</h1>
                        <p class="ds-text-secondary ds-text-base status-caption">
                            Không thể tìm thấy thông tin thanh toán. Vui lòng thử lại sau hoặc kiểm tra lại danh sách đặt bàn của bạn.
                        </p>
                        <div class="action-grid">
                            <a th:href="@{/booking/my}" class="ds-btn ds-btn-primary ds-btn-lg">
                                <i class="fas fa-list"></i>
                                Danh sách đặt bàn
                            </a>
                            <a th:href="@{/}" class="ds-btn ds-btn-secondary ds-btn-lg">
                                <i class="fas fa-home"></i>
                                Về trang chủ
                            </a>
                        </div>
                    </div>
                </article>

                <article class="ds-card ds-card-emphasis"
                         th:if="${payment != null}">
                    <div class="ds-card-body ds-flex ds-flex-col ds-gap-4 ds-items-center ds-text-center"
                         th:with="status=${statusName}">
                        <div class="ds-status-ring ds-status-ring--lg"
                             th:classappend="' ds-status--' + ${#strings.toLowerCase(status)}">
                            <i th:class="${status == 'COMPLETED' ? 'fas fa-check-circle'
                                         : (status == 'FAILED' ? 'fas fa-times-circle'
                                         : (status == 'PROCESSING' ? 'fas fa-clock'
                                         : 'fas fa-hourglass-half'))}"></i>
                        </div>

                        <h1 class="ds-heading-2" th:switch="${status}">
                            <span th:case="'COMPLETED'">Thanh toán thành công</span>
                            <span th:case="'FAILED'">Thanh toán thất bại</span>
                            <span th:case="'PROCESSING'">Đang xử lý thanh toán</span>
                            <span th:case="*">Chờ thanh toán</span>
                        </h1>

                        <p class="status-caption ds-text-base"
                           th:if="${status == 'COMPLETED'}">
                            <span th:if="${isDeposit}">
                                Bạn đã đặt cọc thành công
                                <strong th:text="${#numbers.formatDecimal(payment.amount, 0, 'COMMA', 0, 'POINT')}">0</strong> VNĐ
                                cho đặt bàn của mình.
                            </span>
                            <span th:unless="${isDeposit}">
                                Bạn đã hoàn tất thanh toán
                                <strong th:text="${#numbers.formatDecimal(payment.amount, 0, 'COMMA', 0, 'POINT')}">0</strong> VNĐ.
                            </span>
                            Chúng tôi đã gửi xác nhận qua email và sẽ đồng hành cùng bạn cho trải nghiệm sắp tới.
                        </p>

                        <p class="status-caption ds-text-base"
                           th:if="${status == 'FAILED'}"
                           th:text="${payment.payosDesc} ?: 'Thanh toán không thành công. Vui lòng thử lại hoặc chọn phương thức khác.'">
                        </p>

                        <div class="ds-flex ds-flex-col ds-items-center ds-gap-3"
                             th:if="${status == 'PROCESSING'}">
                            <p class="status-caption ds-text-base">
                                Giao dịch của bạn đang được xử lý. Vui lòng chờ trong giây lát hoặc kiểm tra trạng thái sau ít phút.
                            </p>
                            <div class="status-spinner" role="status" aria-label="Processing payment"></div>
                        </div>

                        <p class="status-caption ds-text-base"
                           th:if="${status == 'PENDING'}">
                            Vui lòng hoàn tất thanh toán theo phương thức bạn đã lựa chọn để giữ chỗ đặt bàn này.
                        </p>
                    </div>
                </article>
            </div>
        </section>

        <section th:if="${payment != null}"
                 class="ds-section-compact">
            <div class="ds-container">
                <article class="ds-card ds-text-center">
                    <div class="ds-card-body ds-flex ds-flex-col ds-gap-5"
                         th:with="status=${payment.status.name()}">
                        <h2 class="ds-heading-4 ds-mb-0">Các thao tác tiếp theo</h2>
                        <p class="ds-text-secondary ds-text-base ds-mb-0">
                            Lựa chọn hành động phù hợp để đảm bảo đặt bàn của bạn được xử lý trọn vẹn.
                        </p>

                        <div th:switch="${status}">
                            <div th:case="'COMPLETED'">
                                <div class="action-grid">
                                    <a href="/booking/my" class="ds-btn ds-btn-primary ds-btn-lg">
                                        <i class="fas fa-list"></i>
                                        Xem đặt bàn của tôi
                                    </a>
                                    <button type="button" class="ds-btn ds-btn-secondary ds-btn-lg"
                                            onclick="printReceipt()">
                                        <i class="fas fa-print"></i>
                                        In hóa đơn
                                    </button>
                                    <button type="button" class="ds-btn ds-btn-tertiary ds-btn-lg"
                                            onclick="viewInvoices(event)">
                                        <i class="fas fa-file-download"></i>
                                        Hóa đơn điện tử
                                    </button>
                                </div>

                                <div class="ds-note-warning"
                                     th:if="${isDeposit && remainingAmount > 0}">
                                    <h3 class="ds-heading-6 ds-mb-2">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        Bạn còn khoản cần thanh toán trực tiếp
                                    </h3>
                                    <p class="ds-text-base ds-mb-1">
                                        Vui lòng thanh toán phần còn lại khi đến nhà hàng:
                                    </p>
                                    <h4 class="ds-heading-5 ds-text-danger ds-m-0"
                                        th:text="${#numbers.formatDecimal(remainingAmount, 0, 'COMMA', 0, 'POINT') + ' VNĐ'}">
                                        0 VNĐ
                                    </h4>
                                </div>
                            </div>

                            <div th:case="'PROCESSING'">
                                <div class="action-grid">
                                    <button type="button" class="ds-btn ds-btn-primary ds-btn-lg"
                                            onclick="checkPaymentStatus()">
                                        <i class="fas fa-sync-alt"></i>
                                        Kiểm tra trạng thái
                                    </button>
                                    <a href="/booking/my" class="ds-btn ds-btn-secondary ds-btn-lg">
                                        <i class="fas fa-arrow-left"></i>
                                        Quay lại đặt bàn
                                    </a>
                                </div>
                            </div>

                            <div th:case="'FAILED'">
                                <div class="action-grid">
                                    <a th:href="@{/payment/{bookingId}(bookingId=${payment.booking.bookingId})}"
                                       class="ds-btn ds-btn-primary ds-btn-lg">
                                        <i class="fas fa-redo"></i>
                                        Thử lại thanh toán
                                    </a>
                                    <a href="/booking/my" class="ds-btn ds-btn-secondary ds-btn-lg">
                                        <i class="fas fa-arrow-left"></i>
                                        Quay lại đặt bàn
                                    </a>
                                </div>
                            </div>

                            <div th:case="'PENDING'">
                                <div class="ds-note-warning ds-mb-4"
                                     th:with="totalValue=${totalAmount != null ? totalAmount : payment.amount},
                                              remainingValue=${remainingAmount != null ? remainingAmount : (totalAmount != null ? totalAmount.subtract(payment.amount) : T(java.math.BigDecimal).ZERO)}">
                                    <h3 class="ds-heading-6 ds-mb-2">
                                        <i class="fas fa-bell me-2"></i> Hoàn tất thanh toán để giữ chỗ
                                    </h3>
                                    <p class="ds-text-base ds-mb-1">
                                        Tổng đơn: <strong th:text="${#numbers.formatDecimal(totalValue, 0, 'COMMA', 0, 'POINT')}">0</strong> VNĐ &nbsp;•&nbsp;
                                        Đã thanh toán: <strong th:text="${#numbers.formatDecimal(payment.amount, 0, 'COMMA', 0, 'POINT')}">0</strong> VNĐ
                                    </p>
                                    <p class="ds-text-base ds-m-0">
                                        <span th:if="${remainingValue.compareTo(T(java.math.BigDecimal).ZERO) > 0}">
                                            Vui lòng thanh toán thêm
                                            <strong th:text="${#numbers.formatDecimal(remainingValue, 0, 'COMMA', 0, 'POINT')}">0</strong> VNĐ
                                            qua <strong th:text="${payment.paymentMethod.displayName}">PayOS</strong> để xác nhận đặt chỗ.
                                        </span>
                                        <span th:unless="${remainingValue.compareTo(T(java.math.BigDecimal).ZERO) > 0}">
                                            Vui lòng hoàn tất thao tác với phương thức
                                            <strong th:text="${payment.paymentMethod.displayName}">PayOS</strong> để xác nhận đặt chỗ.
                                        </span>
                                    </p>
                                </div>

                                <div class="action-grid">
                                    <button type="button"
                                            th:if="${payment.paymentMethod.name() == 'PAYOS'}"
                                            class="ds-btn ds-btn-primary ds-btn-lg"
                                            onclick="initiatePayOSPayment(event)">
                                        <i class="fas fa-qrcode"></i>
                                        Thanh toán bằng PayOS
                                    </button>

                                    <button type="button"
                                            th:if="${payment.paymentMethod.name() == 'CASH'}"
                                            class="ds-btn ds-btn-primary ds-btn-lg"
                                            onclick="confirmCashPayment(event)">
                                        <i class="fas fa-money-bill-wave"></i>
                                        Xác nhận thanh toán tiền mặt
                                    </button>

                                    <a th:href="@{/payment/{bookingId}(bookingId=${payment.booking.bookingId})}"
                                       class="ds-btn ds-btn-secondary ds-btn-lg">
                                        <i class="fas fa-credit-card"></i>
                                        Đổi phương thức
                                    </a>

                                    <button type="button" class="ds-btn ds-btn-tertiary ds-btn-lg"
                                            onclick="checkPayOSStatus(event)">
                                        <i class="fas fa-sync"></i>
                                        Kiểm tra PayOS
                                    </button>

                                    <button type="button" class="ds-btn ds-btn-tertiary ds-btn-lg"
                                            onclick="cancelPayOSPayment(event)">
                                        <i class="fas fa-times"></i>
                                        Hủy thanh toán
                                    </button>
                                </div>

                                <div class="ds-text-center ds-mt-4">
                                    <a href="/booking/my" class="ds-link">
                                        <i class="fas fa-arrow-left me-2"></i>
                                        Quay lại danh sách đặt bàn
                                    </a>
                                </div>
                            </div>
                        </div>

                        <div class="ds-text-center">
                            <a th:href="@{/payment/{bookingId}(bookingId=${payment.booking.bookingId})}"
                               class="ds-link">
                                <i class="fas fa-external-link-alt me-2"></i>
                                Mở lại trang thanh toán
                            </a>
                        </div>
                    </div>
                </article>
            </div>
        </section>
        <section th:if="${payment != null}"
                 class="ds-section-compact">
            <div class="ds-container card-grid">
                <article class="ds-card">
                    <div class="ds-card-body ds-flex ds-flex-col ds-gap-5">
                        <header class="ds-flex ds-items-center ds-gap-3">
                            <div class="ds-status-ring ds-status--pending">
                                <i class="fas fa-file-invoice-dollar"></i>
                            </div>
                            <div>
                                <h2 class="ds-heading-4 ds-mb-1">Chi tiết giao dịch</h2>
                                <p class="ds-text-secondary ds-m-0">Thông tin thanh toán của bạn được tổng hợp bên dưới.</p>
                            </div>
                        </header>

                        <div class="ds-summary-grid"
                             th:if="${payment != null}"
                             th:with="totalValue=${totalAmount != null ? totalAmount : payment.amount},
                                      remainingValue=${remainingAmount != null ? remainingAmount : (totalAmount != null ? totalAmount.subtract(payment.amount) : T(java.math.BigDecimal).ZERO)}">
                            <div class="ds-summary-card">
                                <small>Tổng giá trị đơn</small>
                                <strong th:text="${#numbers.formatDecimal(totalValue, 0, 'COMMA', 0, 'POINT') + ' VNĐ'}">0 VNĐ</strong>
                            </div>
                            <div class="ds-summary-card">
                                <small>Đã thanh toán</small>
                                <strong th:text="${#numbers.formatDecimal(payment.amount, 0, 'COMMA', 0, 'POINT') + ' VNĐ'}">0 VNĐ</strong>
                            </div>
                            <div class="ds-summary-card">
                                <small>Còn lại</small>
                                <strong th:classappend="${remainingValue.compareTo(T(java.math.BigDecimal).ZERO) > 0} ? ' text-danger' : ' text-success'"
                                      th:text="${#numbers.formatDecimal(remainingValue, 0, 'COMMA', 0, 'POINT') + ' VNĐ'}">0 VNĐ</strong>
                            </div>
                        </div>

                        <div class="detail-grid">
                            <div class="detail-item">
                                <strong>Mã giao dịch</strong>
                                <span class="text-primary" th:text="${payment.paymentId}">PAY-000</span>
                            </div>
                            <div class="detail-item" th:if="${payment.orderCode != null}">
                                <strong>Mã đơn hàng</strong>
                                <span th:text="${payment.orderCode}">ORDER-000</span>
                            </div>
                            <div class="detail-item">
                                <strong>Phương thức</strong>
                                <span th:text="${payment.paymentMethod.displayName}">PayOS</span>
                            </div>
                            <div class="detail-item">
                                <strong>Loại thanh toán</strong>
                                <span>
                                    <span th:if="${isDeposit}">
                                        <i class="fas fa-coins text-warning"></i> Đặt cọc
                                    </span>
                                    <span th:unless="${isDeposit}">
                                        <i class="fas fa-credit-card text-success"></i> Thanh toán toàn bộ
                                    </span>
                                </span>
                            </div>
                            <div class="detail-item">
                                <strong>Số tiền</strong>
                                <span class="amount text-success"
                                      th:text="${#numbers.formatDecimal(payment.amount, 0, 'COMMA', 0, 'POINT')}">0</span> VNĐ
                            </div>
                            <div class="detail-item">
                                <strong>Trạng thái</strong>
                                <span th:text="${payment.status.displayName}">Hoàn tất</span>
                            </div>
                            <div class="detail-item" th:if="${payment.paidAt != null}">
                                <strong>Thời gian thanh toán</strong>
                                <span th:text="${#temporals.format(payment.paidAt, 'dd/MM/yyyy HH:mm:ss')}">01/01/2024 12:00</span>
                            </div>
                            <div class="detail-item" th:if="${payment.payosPaymentLinkId != null}">
                                <strong>Mã PayOS</strong>
                                <span class="small text-muted"
                                      th:text="${payment.payosPaymentLinkId}">Link-000</span>
                            </div>
                            <div class="detail-item" th:if="${payment.payosDesc != null}">
                                <strong>Mô tả</strong>
                                <span class="text-muted" th:text="${payment.payosDesc}">Success</span>
                            </div>
                        </div>
                    </div>
                </article>

                <article class="ds-card">
                    <div class="ds-card-body ds-flex ds-flex-col ds-gap-5">
                        <header class="ds-flex ds-items-center ds-gap-3">
                            <div class="ds-status-ring ds-status--success">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                            <div>
                                <h2 class="ds-heading-4 ds-mb-1">Thông tin đặt bàn</h2>
                                <p class="ds-text-secondary ds-m-0">Tóm tắt chi tiết đặt chỗ gắn với giao dịch này.</p>
                            </div>
                        </header>

                        <div class="detail-grid">
                            <div class="detail-item">
                                <strong>Nhà hàng</strong>
                                <span th:text="${payment.booking != null && payment.booking.restaurant != null ? payment.booking.restaurant.restaurantName : '—'}">Nhà hàng</span>
                            </div>
                            <div class="detail-item" th:if="${payment.booking != null && payment.booking.bookingTime != null}">
                                <strong>Thời gian</strong>
                                <span th:text="${#temporals.format(payment.booking.bookingTime, 'dd/MM/yyyy HH:mm')}">01/01/2024 19:00</span>
                            </div>
                            <div class="detail-item">
                                <strong>Số khách</strong>
                                <span th:text="${payment.booking.numberOfGuests}">0</span>
                            </div>
                            <div class="detail-item">
                                <strong>Mã đặt bàn</strong>
                                <span th:text="${payment.booking.bookingId}">0</span>
                            </div>
                            <div class="detail-item">
                                <strong>Trạng thái đặt bàn</strong>
                                <span th:text="${payment.booking.status.displayName}">Chờ xác nhận</span>
                            </div>
                        </div>
                    </div>
                </article>
            </div>
        </section>
    </main>

    <div th:replace="~{fragments/design-system-components :: unified-footer}"></div>
    <div th:replace="~{fragments/resy-scripts :: basic-scripts}"></div>

    <script th:inline="javascript">
        const paymentContext = {
            id: /*[[${payment != null ? payment.paymentId : 0}]]*/ 0,
            status: /*[[${payment != null ? payment.status.name() : 'NONE'}]]*/ 'NONE',
            method: /*[[${payment != null ? payment.paymentMethod.name() : 'NONE'}]]*/ 'NONE'
        };

        function getButton(evt) {
            if (!evt) {
                return null;
            }
            return evt.currentTarget instanceof HTMLElement
                ? evt.currentTarget
                : (evt.target instanceof HTMLElement ? evt.target.closest('button') : null);
        }

        if (paymentContext.status === 'PROCESSING') {
            const pollInterval = setInterval(checkPaymentStatus, 3000);
            setTimeout(() => clearInterval(pollInterval), 300000);
        }

        function loadPayOSQRCode() {
            if (paymentContext.method !== 'PAYOS' || !paymentContext.id) {
                return;
            }

            const placeholder = document.getElementById('qrPlaceholder');
            const imageWrapper = document.getElementById('qrImage');
            const qrImage = document.getElementById('qrCodeImg');

            if (!placeholder || !imageWrapper || !qrImage) {
                return;
            }

            placeholder.style.display = 'block';
            imageWrapper.style.display = 'none';
            placeholder.innerHTML = '<div class="status-spinner"></div><p class="mt-3 mb-0">Đang tải mã QR...</p>';

            fetch(`/payment/api/payos/status/${paymentContext.id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.paymentInfo && data.paymentInfo.qrCode) {
                        qrImage.src = data.paymentInfo.qrCode;
                        placeholder.style.display = 'none';
                        imageWrapper.style.display = 'block';
                    } else {
                        createNewPayOSLink(placeholder, imageWrapper, qrImage);
                    }
                })
                .catch(() => createNewPayOSLink(placeholder, imageWrapper, qrImage));
        }

        function createNewPayOSLink(placeholder, imageWrapper, qrImage) {
            if (!paymentContext.id) {
                return;
            }

            placeholder.innerHTML = '<div class="status-spinner"></div><p class="mt-3 mb-0">Đang tạo link thanh toán...</p>';

            fetch(`/payment/api/payos/create/${paymentContext.id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.paymentLink && data.paymentLink.qrCode) {
                        qrImage.src = data.paymentLink.qrCode;
                        placeholder.style.display = 'none';
                        imageWrapper.style.display = 'block';
                    } else {
                        placeholder.innerHTML = `
                            <i class="fas fa-exclamation-triangle fa-3x text-warning"></i>
                            <p class="mt-2 mb-1 text-warning">Không thể tải mã QR</p>
                            <p class="mb-0 small text-muted">Vui lòng thử lại sau</p>`;
                    }
                })
                .catch(() => {
                    placeholder.innerHTML = `
                        <i class="fas fa-exclamation-circle fa-3x text-danger"></i>
                        <p class="mt-2 mb-1 text-danger">Lỗi tải mã QR</p>
                        <p class="mb-0 small text-muted">Vui lòng thử lại sau</p>`;
                });
        }

        function refreshQRCode(evt) {
            const button = getButton(evt);
            if (!button) {
                return;
            }

            const original = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang làm mới...';
            button.disabled = true;

            const placeholder = document.getElementById('qrPlaceholder');
            const imageWrapper = document.getElementById('qrImage');
            if (placeholder && imageWrapper) {
                placeholder.style.display = 'block';
                imageWrapper.style.display = 'none';
            }

            setTimeout(() => {
                loadPayOSQRCode();
                button.innerHTML = original;
                button.disabled = false;
            }, 900);
        }

        function copyPaymentInfo() {
            const amountEl = document.querySelector('.amount');
            const orderEl = document.querySelector('.order-code');

            if (!amountEl || !orderEl) {
                showNotification('Không tìm thấy thông tin để sao chép', 'error');
                return;
            }

            const payload = `Mã đơn hàng: ${orderEl.textContent.trim()}\nSố tiền: ${amountEl.textContent.trim()} VNĐ\nPhương thức: ${paymentContext.method}`;
            navigator.clipboard.writeText(payload)
                .then(() => showNotification('Đã sao chép thông tin thanh toán', 'success'))
                .catch(() => showNotification('Không thể sao chép thông tin', 'error'));
        }

        function showNotification(message, type = 'info') {
            const wrapper = document.createElement('div');
            wrapper.className = 'toast-notify';
            wrapper.style.cssText = `
                position: fixed;
                top: 24px;
                right: 24px;
                padding: 0.9rem 1.25rem;
                border-radius: 14px;
                color: #fff;
                font-weight: 600;
                letter-spacing: 0.02em;
                z-index: 20000;
                box-shadow: 0 18px 40px rgba(15,23,42,0.18);
                transform: translateX(110%);
                transition: transform 0.25s ease;
                display: flex;
                align-items: center;
                gap: 0.75rem;`;

            const palettes = {
                success: 'linear-gradient(135deg, #22c55e, #16a34a)',
                warning: 'linear-gradient(135deg, #f97316, #facc15)',
                error: 'linear-gradient(135deg, #ef4444, #f97316)',
                info: 'linear-gradient(135deg, #6366f1, #8b5cf6)'
            };

            wrapper.style.background = palettes[type] || palettes.info;
            const icon = type === 'success' ? 'check-circle'
                : type === 'warning' ? 'exclamation-triangle'
                : type === 'error' ? 'times-circle'
                : 'info-circle';

            wrapper.innerHTML = `<i class="fas fa-${icon}"></i><span>${message}</span>`;
            document.body.appendChild(wrapper);

            requestAnimationFrame(() => wrapper.style.transform = 'translateX(0)');
            setTimeout(() => {
                wrapper.style.transform = 'translateX(110%)';
                setTimeout(() => wrapper.remove(), 250);
            }, 2800);
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (paymentContext.method === 'PAYOS' && paymentContext.status === 'PENDING') {
                setTimeout(loadPayOSQRCode, 600);
            }
        });

        function checkPaymentStatus() {
            if (!paymentContext.id) {
                return;
            }

            fetch(`/payment/api/status/${paymentContext.id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'COMPLETED' || data.status === 'FAILED') {
                        location.reload();
                    }
                })
                .catch(() => showNotification('Không thể kiểm tra trạng thái giao dịch', 'warning'));
        }

        function printReceipt() {
            window.print();
        }

        function viewInvoices(evt) {
            const button = getButton(evt);
            if (!button || !paymentContext.id) {
                return;
            }

            const original = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang tải...';
            button.disabled = true;

            fetch(`/payment/api/payos/invoices/${paymentContext.id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && Array.isArray(data.invoices) && data.invoices.length) {
                        showInvoiceList(data.invoices, paymentContext.id);
                    } else {
                        showNotification('Không tìm thấy hóa đơn điện tử cho giao dịch này', 'warning');
                    }
                })
                .catch(() => showNotification('Không thể tải danh sách hóa đơn', 'error'))
                .finally(() => {
                    button.innerHTML = original;
                    button.disabled = false;
                });
        }

        function showInvoiceList(invoices, paymentId) {
            const overlay = document.createElement('div');
            overlay.className = 'invoice-modal d-flex align-items-center justify-content-center';
            overlay.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(15, 23, 42, 0.55);
                z-index: 25000;
                padding: 1.5rem;`;

            const modal = document.createElement('div');
            modal.className = 'modal-content bg-white p-4 rounded-4 shadow-lg';
            modal.style.maxWidth = '640px';
            modal.style.maxHeight = '80vh';
            modal.style.overflowY = 'auto';

            const closeBtn = document.createElement('button');
            closeBtn.type = 'button';
            closeBtn.className = 'btn-close float-end';
            closeBtn.setAttribute('aria-label', 'Close');
            closeBtn.onclick = () => overlay.remove();

            const title = document.createElement('h5');
            title.className = 'mb-3';
            title.innerHTML = '<i class="fas fa-file-invoice me-2"></i>Hóa đơn điện tử';

            const list = document.createElement('div');
            list.className = 'd-flex flex-column gap-3';

            invoices.forEach(invoice => {
                const item = document.createElement('div');
                item.className = 'border rounded-3 p-3 d-flex justify-content-between align-items-start gap-3';
                item.innerHTML = `
                    <div class="text-start small">
                        <div><strong>Số hóa đơn:</strong> ${invoice.invoiceNumber || '—'}</div>
                        <div><strong>Ngày phát hành:</strong> ${invoice.issuedDatetime || '—'}</div>
                        <div><strong>Mã giao dịch:</strong> ${invoice.transactionId || '—'}</div>
                    </div>
                    <button type="button" class="ds-btn ds-btn-primary ds-btn-sm">
                        <i class="fas fa-download me-1"></i>Tải PDF
                    </button>`;
                item.querySelector('button').onclick = () => downloadInvoice(paymentId, invoice.invoiceId);
                list.appendChild(item);
            });

            modal.append(closeBtn, title, list);
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
        }

        function downloadInvoice(paymentId, invoiceId) {
            if (!paymentId || !invoiceId) {
                return;
            }
            const link = document.createElement('a');
            link.href = `/payment/api/payos/invoices/${paymentId}/download/${invoiceId}`;
            link.download = `invoice_${paymentId}_${invoiceId}.pdf`;
            document.body.appendChild(link);
            link.click();
            link.remove();
        }

        function initiatePayOSPayment(evt) {
            if (paymentContext.method !== 'PAYOS' || !paymentContext.id) {
                return;
            }

            const button = getButton(evt);
            if (!button) {
                return;
            }

            const original = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang tạo giao dịch...';
            button.disabled = true;

            fetch(`/payment/api/payos/create/${paymentContext.id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.paymentUrl) {
                        window.location.href = data.paymentUrl;
                    } else {
                        showNotification('Không thể tạo giao dịch PayOS. Vui lòng thử lại.', 'error');
                        button.innerHTML = original;
                        button.disabled = false;
                    }
                })
                .catch(() => {
                    showNotification('Có lỗi xảy ra khi tạo giao dịch PayOS.', 'error');
                    button.innerHTML = original;
                    button.disabled = false;
                });
        }

        function confirmCashPayment(evt) {
            if (paymentContext.method !== 'CASH' || !paymentContext.id) {
                return;
            }

            if (!window.confirm('Xác nhận bạn đã thanh toán tiền mặt tại nhà hàng?')) {
                return;
            }

            const button = getButton(evt);
            if (!button) {
                return;
            }

            const original = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xác nhận...';
            button.disabled = true;

            fetch(`/payment/api/cash/confirm/${paymentContext.id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Đã xác nhận thanh toán tiền mặt', 'success');
                        setTimeout(() => location.reload(), 600);
                    } else {
                        showNotification('Không thể xác nhận thanh toán. Vui lòng thử lại.', 'error');
                        button.innerHTML = original;
                        button.disabled = false;
                    }
                })
                .catch(() => {
                    showNotification('Có lỗi xảy ra khi xác nhận thanh toán.', 'error');
                    button.innerHTML = original;
                    button.disabled = false;
                });
        }

        function checkPayOSStatus(evt) {
            if (!paymentContext.id) {
                return;
            }

            const button = getButton(evt);
            const original = button ? button.innerHTML : null;
            if (button) {
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang kiểm tra...';
                button.disabled = true;
            }

            fetch(`/payment/api/payos/status/${paymentContext.id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const message = `Trạng thái: ${data.status}\nĐã thanh toán: ${data.amountPaid} VND\nCòn lại: ${data.amountRemaining} VND`;
                        alert(message);
                        if (data.status === 'PAID') {
                            location.reload();
                        }
                    } else {
                        showNotification('Không thể kiểm tra trạng thái PayOS', 'warning');
                    }
                })
                .catch(() => showNotification('Có lỗi xảy ra khi kiểm tra PayOS', 'error'))
                .finally(() => {
                    if (button && original) {
                        button.innerHTML = original;
                        button.disabled = false;
                    }
                });
        }

        function cancelPayOSPayment(evt) {
            if (!paymentContext.id) {
                return;
            }

            const reason = window.prompt('Lý do hủy thanh toán (tùy chọn):') || '';
            if (!window.confirm('Bạn có chắc chắn muốn hủy giao dịch này?')) {
                return;
            }

            const button = getButton(evt);
            const original = button ? button.innerHTML : null;
            if (button) {
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang hủy...';
                button.disabled = true;
            }

            const url = reason
                ? `/payment/api/payos/cancel/${paymentContext.id}?reason=${encodeURIComponent(reason)}`
                : `/payment/api/payos/cancel/${paymentContext.id}`;

            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Đã hủy giao dịch PayOS', 'success');
                        setTimeout(() => location.reload(), 600);
                    } else {
                        showNotification('Không thể hủy giao dịch. Vui lòng thử lại.', 'error');
                        if (button && original) {
                            button.innerHTML = original;
                            button.disabled = false;
                        }
                    }
                })
                .catch(() => {
                    showNotification('Có lỗi xảy ra khi hủy giao dịch.', 'error');
                    if (button && original) {
                        button.innerHTML = original;
                        button.disabled = false;
                    }
                });
        }

        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('resultCode') === '0') {
            showNotification('Thanh toán PayOS đã được xác nhận', 'success');
        }
    </script>
</body>
</html>
