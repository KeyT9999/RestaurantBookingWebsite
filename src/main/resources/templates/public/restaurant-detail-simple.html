<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle}">Chi tiết Nhà hàng</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Design System CSS -->
    <link th:href="@{/css/design-system.css}" rel="stylesheet">
    <!-- Restaurant Detail CSS -->
    <link th:href="@{/css/restaurant-detail.css}" rel="stylesheet">
    
    <style>
        /* Image Modal */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            animation: fadeIn 0.3s;
        }
        
        .image-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content-image {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            animation: zoomIn 0.3s;
        }
        
        .modal-close {
            position: absolute;
            top: 20px;
            right: 40px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10000;
            transition: color 0.2s;
        }
        
        .modal-close:hover {
            color: #ccc;
        }
        
        .modal-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            font-size: 30px;
            width: 50px;
            height: 50px;
            cursor: pointer;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s, transform 0.2s;
            user-select: none;
        }
        
        .modal-nav:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-50%) scale(1.1);
        }
        
        .modal-nav:active {
            transform: translateY(-50%) scale(0.95);
        }
        
        .modal-nav.prev {
            left: 20px;
        }
        
        .modal-nav.next {
            right: 20px;
        }
        
        .modal-nav:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .modal-nav:disabled:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-50%);
        }
        
        .modal-image-counter {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 10000;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes zoomIn {
            from { transform: scale(0.7); }
            to { transform: scale(1); }
        }
        
        @keyframes slideInLeft {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideInRight {
            from { transform: translateX(20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .modal-content-image.slide-left {
            animation: slideInLeft 0.3s;
        }
        
        .modal-content-image.slide-right {
            animation: slideInRight 0.3s;
        }
    </style>
</head>
<body class="ds-bg-white">
    <!-- Header -->
    <div th:replace="~{fragments/design-system-components :: unified-header}"></div>

    <main>
        <!-- Breadcrumb -->
        <section class="ds-bg-gray-50" style="padding: 16px 0;">
            <div class="ds-container">
                <nav class="ds-breadcrumb">
                    <ol class="ds-breadcrumb-list">
                        <li class="ds-breadcrumb-item"><a th:href="@{/}">Trang chủ</a></li>
                        <li class="ds-breadcrumb-item"><a th:href="@{/restaurants}">Nhà hàng</a></li>
                        <li class="ds-breadcrumb-item active"><span th:text="${restaurant.restaurantName}">Tên nhà hàng</span></li>
                    </ol>
                </nav>
            </div>
        </section>

        <!-- Banner Section -->
        <section class="banner-section">
            <div class="ds-container">
                <div class="banner-grid">
                    <!-- Main Banner - Ảnh lớn bên trái -->
                    <div class="main-banner" id="mainBanner">
                        <button class="banner-nav banner-nav-prev" id="bannerPrevBtn" onclick="bannerPreviousImage(event)" style="display: none;">
                            ‹
                        </button>
                        <button class="banner-nav banner-nav-next" id="bannerNextBtn" onclick="bannerNextImage(event)" style="display: none;">
                            ›
                        </button>
                        
                        <img id="mainBannerImage" th:if="${cover != null}" th:src="${cover.url}" alt="Restaurant" class="main-banner-image" th:attr="data-lightbox-url=${cover.url}" onclick="openImageLightbox(this)" style="cursor: pointer;">
                        <img id="mainBannerImage" th:unless="${cover != null}" th:if="${!#lists.isEmpty(interior)}" th:src="${interior[0].url}" alt="Restaurant" class="main-banner-image" th:attr="data-lightbox-url=${interior[0].url}" onclick="openImageLightbox(this)" style="cursor: pointer;">
                        <img id="mainBannerImage" th:unless="${cover != null or !#lists.isEmpty(interior)}" th:if="${!#lists.isEmpty(gallery)}" th:src="${gallery[0].url}" alt="Restaurant" class="main-banner-image" th:attr="data-lightbox-url=${gallery[0].url}" onclick="openImageLightbox(this)" style="cursor: pointer;">
                        <img id="mainBannerImage" th:unless="${cover != null or !#lists.isEmpty(interior) or !#lists.isEmpty(gallery)}" src="https://via.placeholder.com/800x500?text=Restaurant" alt="Restaurant" class="main-banner-image">
                        
                        <div class="main-banner-overlay">
                            <h1 class="banner-title" th:text="${restaurant.restaurantName}">Tên Nhà hàng</h1>
                            <div class="banner-meta">
                                <div class="banner-meta-item">
                                    <i class="fas fa-star"></i>
                                    <span th:text="${restaurant.formattedAverageRating} + ' (' + ${restaurant.reviewCount} + ' đánh giá)'">0.0 (0 đánh giá)</span>
                                </div>
                                <div class="banner-meta-item" th:if="${restaurant.cuisineType != null}">
                                    <i class="fas fa-utensils"></i>
                                    <span th:text="${restaurant.cuisineType}">Việt Nam</span>
                                </div>
                                <div class="banner-meta-item" th:if="${restaurant.address != null}">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span th:text="${restaurant.address}">Địa chỉ</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Image Grid - 2x3 bên phải -->
                    <div class="image-grid">
                        <!-- Hiển thị ảnh từ gallery -->
                        <div class="grid-image-item" th:each="image, iterStat : ${gallery}" th:if="${iterStat.index < 5}">
                            <img th:src="${image.url}" alt="Gallery" class="grid-image" th:attr="data-lightbox-url=${image.url}" onclick="openImageLightbox(this)">
                        </div>
                        
                        <!-- Ảnh thứ 6 với overlay "Xem tất cả" -->
                        <div class="grid-image-item" th:if="${!#lists.isEmpty(gallery) and gallery.size() >= 6}">
                            <img th:src="${gallery[5].url}" alt="Gallery" class="grid-image">
                            <div class="view-all-overlay" onclick="document.getElementById('gallery-tab').click();">Xem tất cả</div>
                        </div>
                        
                        <!-- Hiển thị ảnh từ interior/exterior nếu không có gallery -->
                        <div class="grid-image-item" th:if="${#lists.isEmpty(gallery)}" th:each="image, iterStat : ${interior}" th:unless="${iterStat.index >= 3}">
                            <img th:src="${image.url}" alt="Interior" class="grid-image" th:attr="data-lightbox-url=${image.url}" onclick="openImageLightbox(this)">
                        </div>
                        <div class="grid-image-item" th:if="${#lists.isEmpty(gallery)}" th:each="image, iterStat : ${exterior}" th:unless="${iterStat.index >= 3}">
                            <img th:src="${image.url}" alt="Exterior" class="grid-image" th:attr="data-lightbox-url=${image.url}" onclick="openImageLightbox(this)">
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Restaurant Info Section -->
        <section style="padding: 0 0 24px 0;">
            <div class="ds-container">
                <div class="page-section">
                    <!-- Tên và Rating -->
                    <div style="margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid #e5e7eb;">
                        <h1 class="section-title" style="font-size: 24px; margin-bottom: 8px;" th:text="${restaurant.restaurantName}">Tên Nhà hàng</h1>
                        <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <i class="fas fa-star" style="color: #fbbf24;"></i>
                                <span class="text-base" th:text="${restaurant.formattedAverageRating} + ' (' + ${restaurant.reviewCount} + ' đánh giá)'">0.0 (0 đánh giá)</span>
                            </div>
                            <span class="restaurant-badge" th:if="${restaurant.cuisineType != null}" th:text="${restaurant.cuisineType}">Việt Nam</span>
                        </div>
                    </div>
                    
                    <!-- Grid thông tin -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px;">
                        <div class="info-item">
                            <div class="info-icon"><i class="fas fa-clock"></i></div>
                            <div class="info-content">
                                <div class="info-label">Giờ mở cửa</div>
                                <div class="info-value" th:text="${restaurant.openingHours != null ? restaurant.openingHours : 'Đang cập nhật'}">Đang cập nhật</div>
                            </div>
                        </div>
                        
                        <div class="info-item">
                            <div class="info-icon"><i class="fas fa-map-marker-alt"></i></div>
                            <div class="info-content">
                                <div class="info-label">Địa chỉ</div>
                                <div class="info-value">
                                    <span th:text="${restaurant.address != null ? restaurant.address : 'Đang cập nhật'}">Đang cập nhật</span>
                                    <div th:if="${restaurant.address != null}" style="margin-top: 8px;">
                                        <a th:href="'https://www.google.com/maps/search/?api=1&query=' + ${#strings.replace(restaurant.address, ' ', '+')}" 
                                           target="_blank" class="btn-menu" style="font-size: 13px; padding: 6px 12px;">
                                            <i class="fas fa-map-marked-alt"></i> Xem bản đồ
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="info-item">
                            <div class="info-icon"><i class="fas fa-phone"></i></div>
                            <div class="info-content">
                                <div class="info-label">Điện thoại</div>
                                <div class="info-value">
                                    <a th:if="${restaurant.phone != null}" th:href="'tel:' + ${restaurant.phone}" th:text="${restaurant.phone}">Phone</a>
                                    <span th:unless="${restaurant.phone != null}">Đang cập nhật</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="info-item" th:if="${restaurant.averagePrice != null}">
                            <div class="info-icon"><i class="fas fa-dollar-sign"></i></div>
                            <div class="info-content">
                                <div class="info-label">Giá trung bình</div>
                                <div class="info-value" th:text="'₫' + ${#numbers.formatDecimal(restaurant.averagePrice, 0, 'COMMA', 0, 'POINT')}">₫500.000</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Main Content -->
        <section style="padding: 0 0 48px 0;">
            <div class="ds-container">
                <!-- Success/Error Messages -->
                <div th:if="${success != null}" class="alert-message alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    <span th:text="${success}">Thành công!</span>
                </div>
                <div th:if="${error != null}" class="alert-message alert-error">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <span th:text="${error}">Có lỗi xảy ra!</span>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 380px; gap: 24px;">
                    <!-- Left Column - Tabs -->
                    <div>
                        <!-- Tabs -->
                        <ul class="nav restaurant-tabs">
                            <li class="nav-item">
                                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#about">Giới thiệu</button>
                            </li>
                            <li class="nav-item" th:if="${!#lists.isEmpty(gallery) or !#lists.isEmpty(exterior) or !#lists.isEmpty(interior)}">
                                <button class="nav-link" id="gallery-tab" data-bs-toggle="tab" data-bs-target="#gallery">Hình ảnh</button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" id="menu-tab" data-bs-toggle="tab" data-bs-target="#menu">Thực đơn</button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tables">Bàn</button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews">Đánh giá</button>
                            </li>
                        </ul>

                        <!-- Tab Content -->
                        <div class="tab-content">
                            <!-- About Tab -->
                            <div class="tab-pane fade show active" id="about">
                                <div class="page-section">
                                    <div class="page-section-header">
                                        <h2 class="section-title">Giới thiệu nhà hàng</h2>
                                    </div>
                                    <div class="page-section-content">
                                        <div class="subsection" th:if="${restaurant.description != null}">
                                            <h3 class="subsection-title">Câu chuyện của chúng tôi</h3>
                                            <p class="text-base" th:utext="${restaurant.description}">Mô tả nhà hàng</p>
                                        </div>
                                        
                                        <div class="subsection" th:if="${restaurant.amenities != null and !#strings.isEmpty(restaurant.amenities)}">
                                            <h3 class="subsection-title">Tiện ích</h3>
                                            <p class="text-base" th:utext="${restaurant.amenities}">Tiện ích</p>
                                        </div>
                                        
                                        <div class="subsection" th:if="${restaurant.menuHighlights != null and !#strings.isEmpty(restaurant.menuHighlights)}">
                                            <h3 class="subsection-title">Điểm nổi bật thực đơn</h3>
                                            <p class="text-base" th:utext="${restaurant.menuHighlights}">Điểm nổi bật</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Gallery Tab -->
                            <div class="tab-pane fade" id="gallery">
                                <div class="page-section">
                                    <div class="page-section-header">
                                        <h2 class="section-title">Hình ảnh nhà hàng</h2>
                                    </div>
                                    <div class="page-section-content">
                                        <div class="subsection" th:if="${!#lists.isEmpty(gallery)}">
                                            <h3 class="subsection-title">Thư viện ảnh</h3>
                                            <div class="gallery-grid">
                                                <div class="gallery-item" th:each="image : ${gallery}">
                                                    <img th:src="${image.url}" alt="Gallery" th:attr="data-lightbox-url=${image.url}" onclick="openImageLightbox(this)">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="subsection" th:if="${!#lists.isEmpty(exterior)}">
                                            <h3 class="subsection-title">Ngoại thất</h3>
                                            <div class="gallery-grid">
                                                <div class="gallery-item" th:each="image : ${exterior}">
                                                    <img th:src="${image.url}" alt="Exterior" th:attr="data-lightbox-url=${image.url}" onclick="openImageLightbox(this)">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="subsection" th:if="${!#lists.isEmpty(interior)}">
                                            <h3 class="subsection-title">Nội thất</h3>
                                            <div class="gallery-grid">
                                                <div class="gallery-item" th:each="image : ${interior}">
                                                    <img th:src="${image.url}" alt="Interior" th:attr="data-lightbox-url=${image.url}" onclick="openImageLightbox(this)">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div th:if="${#lists.isEmpty(gallery) and #lists.isEmpty(exterior) and #lists.isEmpty(interior)}" style="text-align: center; padding: 48px 0;">
                                            <p class="text-base text-secondary">Hình ảnh đang được cập nhật.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Menu Tab -->
                            <div class="tab-pane fade" id="menu">
                                <div class="page-section">
                                    <div class="page-section-header">
                                        <h2 class="section-title">Thực đơn</h2>
                                    </div>
                                    <div class="page-section-content">
                                        <div class="subsection" th:if="${!#lists.isEmpty(menus)}">
                                            <h3 class="subsection-title">Menu PDF</h3>
                                            <div class="menu-grid">
                                                <div class="menu-card" th:each="menu : ${menus}">
                                                    <div class="menu-image-wrapper">
                                                        <img th:src="${menu.url}" alt="Menu" class="menu-image">
                                                    </div>
                                                    <div class="menu-actions">
                                                        <a th:href="${menu.url}" target="_blank" class="btn-menu"><i class="fas fa-eye"></i> Xem</a>
                                                        <a th:href="${menu.url}" download class="btn-menu"><i class="fas fa-download"></i> Tải</a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="subsection" th:if="${!#lists.isEmpty(dishes)}">
                                            <h3 class="subsection-title" th:if="${!#lists.isEmpty(menus)}">Món ăn</h3>
                                            <div class="dish-grid">
                                                <div class="dish-card" th:each="dish : ${dishes}">
                                                    <div class="dish-image-wrapper" th:if="${dish.imageUrl != null}">
                                                        <img th:src="${dish.imageUrl}" alt="Dish" class="dish-image">
                                                    </div>
                                                    <div class="dish-name" th:text="${dish.name}">Tên món</div>
                                                    <div class="dish-description" th:text="${dish.description}">Mô tả món ăn</div>
                                                    <div class="dish-footer">
                                                        <div>
                                                            <span class="dish-badge" th:if="${dish.category != null}" th:text="${dish.category}">Loại</span>
                                                        </div>
                                                        <div class="dish-price" th:text="'₫' + ${#numbers.formatDecimal(dish.price, 0, 'COMMA', 0, 'POINT')}">₫0</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div th:if="${#lists.isEmpty(dishes) and #lists.isEmpty(menus)}" style="text-align: center; padding: 48px 0;">
                                            <p class="text-base text-secondary">Thực đơn đang được cập nhật.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Tables Tab -->
                            <div class="tab-pane fade" id="tables">
                                <div class="page-section">
                                    <div class="page-section-header">
                                        <h2 class="section-title">Sơ đồ nhà hàng</h2>
                                    </div>
                                    <div class="page-section-content">
                                        <div class="subsection" th:if="${!#lists.isEmpty(tableLayouts)}">
                                            <h3 class="subsection-title">Sơ đồ bàn</h3>
                                            <div class="gallery-grid">
                                                <div class="gallery-item" th:each="layout : ${tableLayouts}">
                                                    <img th:src="${layout.url}" alt="Table Layout" th:attr="data-lightbox-url=${layout.url}" onclick="openImageLightbox(this)">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="subsection" th:if="${!#lists.isEmpty(tables)}">
                                            <h3 class="subsection-title" th:if="${!#lists.isEmpty(tableLayouts)}">Danh sách bàn</h3>
                                            <div class="table-grid">
                                                <div class="table-card" th:each="table : ${tables}">
                                                    <div class="table-header">
                                                        <span class="table-name" th:text="${table.tableName}">Bàn</span>
                                                        <span class="table-status available" th:classappend="${table.status.name() == 'OCCUPIED'} ? 'occupied' : (${table.status.name() == 'MAINTENANCE'} ? 'maintenance' : 'available')" th:text="${table.status.name() == 'AVAILABLE'} ? 'Trống' : (${table.status.name() == 'OCCUPIED'} ? 'Đã đặt' : 'Bảo trì')">Trống</span>
                                                    </div>
                                                    <div class="table-info">
                                                        <div class="table-info-item">
                                                            <i class="fas fa-users"></i>
                                                            <span th:text="${table.capacity} + ' chỗ'">0 chỗ</span>
                                                        </div>
                                                        <div class="table-info-item" th:if="${table.depositAmount != null and table.depositAmount > 0}">
                                                            <i class="fas fa-dollar-sign"></i>
                                                            <span th:text="'₫' + ${#numbers.formatDecimal(table.depositAmount, 0, 'COMMA', 0, 'POINT')}">₫0</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div th:if="${#lists.isEmpty(tables) and #lists.isEmpty(tableLayouts)}" style="text-align: center; padding: 48px 0;">
                                            <p class="text-base text-secondary">Thông tin bàn đang được cập nhật.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Reviews Tab -->
                            <div class="tab-pane fade" id="reviews">
                                <div class="page-section">
                                    <div class="page-section-header">
                                        <h2 class="section-title">Đánh giá khách hàng</h2>
                                    </div>
                                    <div class="page-section-content">
                                        <!-- Review Statistics -->
                                        <div class="subsection" th:if="${statistics != null}">
                                            <div class="review-stats">
                                                <div class="rating-display">
                                                    <div class="rating-number" th:text="${statistics.formattedAverageRating}">0.0</div>
                                                    <div class="rating-stars">
                                                        <i class="fas fa-star star-rating" th:each="i : ${#numbers.sequence(1, 5)}" th:classappend="${i <= statistics.averageRating} ? 'star-rating' : 'star-empty'"></i>
                                                    </div>
                                                    <div class="rating-count" th:text="'Dựa trên ' + ${statistics.totalReviews} + ' đánh giá'">Dựa trên 0 đánh giá</div>
                                                </div>
                                                <div class="rating-breakdown">
                                                    <div class="rating-row">
                                                        <span class="rating-label">5★</span>
                                                        <div class="progress"><div class="progress-bar" th:style="'width: ' + ${statistics.fiveStarPercentage} + '%'"></div></div>
                                                        <span class="rating-count-number" th:text="${statistics.fiveStarCount}">0</span>
                                                    </div>
                                                    <div class="rating-row">
                                                        <span class="rating-label">4★</span>
                                                        <div class="progress"><div class="progress-bar" th:style="'width: ' + ${statistics.fourStarPercentage} + '%'"></div></div>
                                                        <span class="rating-count-number" th:text="${statistics.fourStarCount}">0</span>
                                                    </div>
                                                    <div class="rating-row">
                                                        <span class="rating-label">3★</span>
                                                        <div class="progress"><div class="progress-bar" th:style="'width: ' + ${statistics.threeStarPercentage} + '%'"></div></div>
                                                        <span class="rating-count-number" th:text="${statistics.threeStarCount}">0</span>
                                                    </div>
                                                    <div class="rating-row">
                                                        <span class="rating-label">2★</span>
                                                        <div class="progress"><div class="progress-bar" th:style="'width: ' + ${statistics.twoStarPercentage} + '%'"></div></div>
                                                        <span class="rating-count-number" th:text="${statistics.twoStarCount}">0</span>
                                                    </div>
                                                    <div class="rating-row">
                                                        <span class="rating-label">1★</span>
                                                        <div class="progress"><div class="progress-bar" th:style="'width: ' + ${statistics.oneStarPercentage} + '%'"></div></div>
                                                        <span class="rating-count-number" th:text="${statistics.oneStarCount}">0</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Review Form -->
                                        <div class="subsection" th:if="${!hasReviewed}" sec:authorize="isAuthenticated()">
                                            <h3 class="subsection-title">Viết đánh giá của bạn</h3>
                                            <div class="review-form-card">
                                                <form th:action="@{/reviews}" th:object="${reviewForm}" method="post">
                                                    <input type="hidden" th:field="*{restaurantId}">
                                                    
                                                    <div class="form-group">
                                                        <label class="form-label">Đánh giá của bạn <span style="color: #ef4444;">*</span></label>
                                                        <div class="star-rating-input">
                                                            <i class="far fa-star star" data-rating="1"></i>
                                                            <i class="far fa-star star" data-rating="2"></i>
                                                            <i class="far fa-star star" data-rating="3"></i>
                                                            <i class="far fa-star star" data-rating="4"></i>
                                                            <i class="far fa-star star" data-rating="5"></i>
                                                            <input type="hidden" th:field="*{rating}" id="ratingInput" required>
                                                        </div>
                                                        <div class="rating-text" id="ratingText">Chọn số sao đánh giá</div>
                                                    </div>
                                                    
                                                    <div class="form-group">
                                                        <label for="comment" class="form-label">Bình luận</label>
                                                        <textarea th:field="*{comment}" id="comment" class="form-control" rows="4" placeholder="Chia sẻ trải nghiệm của bạn..." maxlength="1000"></textarea>
                                                        <div class="text-base text-secondary" style="margin-top: 8px;" id="charCount">0/1000 ký tự</div>
                                                    </div>
                                                    
                                                    <button type="submit" class="btn-book">
                                                        <i class="fas fa-paper-plane me-2"></i> Gửi đánh giá
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                        
                                        <!-- User's Review -->
                                        <div class="subsection" th:if="${hasReviewed and customerReview != null}">
                                            <h3 class="subsection-title">Đánh giá của bạn</h3>
                                            <div class="review-card">
                                                <div class="review-header">
                                                    <div class="review-avatar">Bạn</div>
                                                    <div class="review-info">
                                                        <div class="review-name">Đánh giá của bạn</div>
                                                        <div class="review-meta">
                                                            <div class="review-stars">
                                                                <i class="fas fa-star star-rating" th:each="i : ${#numbers.sequence(1, 5)}" th:classappend="${i <= customerReview.rating} ? 'star-rating' : 'star-empty'"></i>
                                                            </div>
                                                            <span th:text="${#temporals.format(customerReview.createdAt, 'dd/MM/yyyy')}">Date</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="review-text" th:text="${customerReview.comment}">Comment</div>
                                            </div>
                                        </div>
                                        
                                        <!-- Recent Reviews -->
                                        <div class="subsection" th:if="${!#lists.isEmpty(recentReviews)}">
                                            <h3 class="subsection-title" th:if="${hasReviewed}">Đánh giá khác</h3>
                                            <div class="review-grid">
                                                <div class="review-card" th:each="review : ${recentReviews}">
                                                    <div class="review-header">
                                                        <div class="review-avatar" th:text="${#strings.substring(review.customerName, 0, 2)}">SJ</div>
                                                        <div class="review-info">
                                                            <div class="review-name" th:text="${review.customerName}">Name</div>
                                                            <div class="review-meta">
                                                                <div class="review-stars">
                                                                    <i class="fas fa-star star-rating" th:each="i : ${#numbers.sequence(1, 5)}" th:classappend="${i <= review.rating} ? 'star-rating' : 'star-empty'"></i>
                                                                </div>
                                                                <span th:text="${#temporals.format(review.createdAt, 'dd/MM/yyyy')}">Date</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="review-text" th:text="${review.comment}">Comment</div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div th:if="${#lists.isEmpty(recentReviews) and !hasReviewed}" style="text-align: center; padding: 48px 0;">
                                            <p class="text-base text-secondary">Chưa có đánh giá nào.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Column - Booking Widget -->
                    <div>
                        <div class="reservation-widget">
                            <h3 class="reservation-title">Đặt bàn</h3>
                            <form th:action="@{/booking/new}" method="get">
                                <input type="hidden" name="restaurantId" th:value="${restaurant.restaurantId}">
                                
                                <div class="form-group">
                                    <label class="form-label">Chọn ngày</label>
                                    <div class="input-group">
                                        <i class="fas fa-calendar input-icon"></i>
                                        <input type="date" class="form-control" name="date" required>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Chọn giờ</label>
                                    <div class="input-group">
                                        <i class="fas fa-clock input-icon"></i>
                                        <select class="form-control" name="time" required>
                                            <option value="">Chọn giờ</option>
                                            <option value="17:00">17:00</option>
                                            <option value="17:30">17:30</option>
                                            <option value="18:00">18:00</option>
                                            <option value="18:30">18:30</option>
                                            <option value="19:00">19:00</option>
                                            <option value="19:30">19:30</option>
                                            <option value="20:00">20:00</option>
                                            <option value="20:30">20:30</option>
                                            <option value="21:00">21:00</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Số lượng khách</label>
                                    <div class="input-group">
                                        <i class="fas fa-user input-icon"></i>
                                        <select class="form-control" name="guests" required>
                                            <option value="">Chọn số lượng</option>
                                            <option value="1">1 khách</option>
                                            <option value="2">2 khách</option>
                                            <option value="3">3 khách</option>
                                            <option value="4">4 khách</option>
                                            <option value="5">5 khách</option>
                                            <option value="6">6 khách</option>
                                            <option value="7">7 khách</option>
                                            <option value="8">8 khách</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn-book">
                                    <i class="fas fa-calendar-check me-2"></i> Đặt bàn ngay
                                </button>
                                
                                <div class="cancellation-policy">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Bạn có thể hủy hoặc thay đổi đặt bàn trước 24 giờ
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <!-- Image Modal -->
    <div id="imageModal" class="image-modal" onclick="handleModalBackgroundClick(event)">
        <span class="modal-close" onclick="closeImageModal()">&times;</span>
        <button class="modal-nav prev" onclick="previousImage(event)" id="prevBtn">‹</button>
        <button class="modal-nav next" onclick="nextImage(event)" id="nextBtn">›</button>
        <img id="modalImage" class="modal-content-image" src="" alt="Image">
        <div class="modal-image-counter" id="imageCounter"></div>
    </div>
    
    <!-- Footer -->
    <div th:replace="~{fragments/design-system-components :: unified-footer}"></div>
    <div th:replace="~{fragments/resy-scripts :: basic-scripts}"></div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Image gallery state
        let imageGallery = [];
        let currentImageIndex = -1;
        
        // Collect all viewable images on page load
        function collectAllImages() {
            const images = [];
            const seenUrls = new Set();
            
            // Collect main banner image
            const mainBanner = document.querySelector('.main-banner-image[data-lightbox-url]');
            if (mainBanner) {
                const url = mainBanner.getAttribute('data-lightbox-url');
                if (url && !seenUrls.has(url)) {
                    images.push(url);
                    seenUrls.add(url);
                }
            }
            
            // Collect banner grid images
            document.querySelectorAll('.image-grid .grid-image[data-lightbox-url]').forEach(img => {
                const url = img.getAttribute('data-lightbox-url');
                if (url && !seenUrls.has(url)) {
                    images.push(url);
                    seenUrls.add(url);
                }
            });
            
            // Collect gallery images (from Gallery tab)
            document.querySelectorAll('.gallery-grid .gallery-item img[data-lightbox-url]').forEach(img => {
                const url = img.getAttribute('data-lightbox-url');
                if (url && !seenUrls.has(url)) {
                    images.push(url);
                    seenUrls.add(url);
                }
            });
            
            return images;
        }
        
        // Open image modal
        function openImageLightbox(imgElement) {
            const imageUrl = imgElement.getAttribute('data-lightbox-url') || imgElement.src;
            
            // Collect all images
            imageGallery = collectAllImages();
            currentImageIndex = imageGallery.indexOf(imageUrl);
            
            // If image not found, add it
            if (currentImageIndex === -1) {
                currentImageIndex = 0;
                imageGallery = [imageUrl];
            }
            
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            if (modal && modalImg) {
                modalImg.src = imageUrl;
                modalImg.classList.remove('slide-left', 'slide-right');
                modal.classList.add('show');
                document.body.style.overflow = 'hidden';
                updateNavigationButtons();
                updateImageCounter();
            }
        }
        
        // Update navigation buttons state
        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (prevBtn) {
                prevBtn.disabled = currentImageIndex <= 0 || imageGallery.length <= 1;
            }
            if (nextBtn) {
                nextBtn.disabled = currentImageIndex >= imageGallery.length - 1 || imageGallery.length <= 1;
            }
        }
        
        // Update image counter
        function updateImageCounter() {
            const counter = document.getElementById('imageCounter');
            if (counter && imageGallery.length > 1) {
                counter.textContent = `${currentImageIndex + 1} / ${imageGallery.length}`;
                counter.style.display = 'block';
            } else if (counter) {
                counter.style.display = 'none';
            }
        }
        
        // Show image at index
        function showImageAtIndex(index, direction) {
            if (index < 0 || index >= imageGallery.length) return;
            
            currentImageIndex = index;
            const modalImg = document.getElementById('modalImage');
            if (modalImg) {
                // Add animation class
                modalImg.classList.remove('slide-left', 'slide-right');
                if (direction === 'prev') {
                    modalImg.classList.add('slide-right');
                } else if (direction === 'next') {
                    modalImg.classList.add('slide-left');
                }
                
                // Update image source
                modalImg.src = imageGallery[index];
                updateNavigationButtons();
                updateImageCounter();
            }
        }
        
        // Previous image
        function previousImage(event) {
            event.stopPropagation();
            if (currentImageIndex > 0) {
                showImageAtIndex(currentImageIndex - 1, 'prev');
            }
        }
        
        // Next image
        function nextImage(event) {
            event.stopPropagation();
            if (currentImageIndex < imageGallery.length - 1) {
                showImageAtIndex(currentImageIndex + 1, 'next');
            }
        }
        
        // Handle modal background click (close only if clicking background, not buttons)
        function handleModalBackgroundClick(event) {
            if (event.target.id === 'imageModal') {
                closeImageModal();
            }
        }
        
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            if (modal) {
                modal.classList.remove('show');
                document.body.style.overflow = 'auto';
                // Reset state
                currentImageIndex = -1;
                imageGallery = [];
            }
        }
        
        // Keyboard navigation
        document.addEventListener('keydown', function(e) {
            const modal = document.getElementById('imageModal');
            if (!modal || !modal.classList.contains('show')) return;
            
            if (e.key === 'Escape') {
                closeImageModal();
            } else if (e.key === 'ArrowLeft') {
                e.preventDefault();
                previousImage(e);
            } else if (e.key === 'ArrowRight') {
                e.preventDefault();
                nextImage(e);
            }
        });
        
        // Banner image gallery state
        let bannerImages = [];
        let currentBannerIndex = 0;
        
        // Collect banner images from page
        function initBannerImages() {
            bannerImages = [];
            const seenUrls = new Set();
            
            // Collect cover image
            const coverImg = document.querySelector('.main-banner-image[data-lightbox-url]');
            if (coverImg) {
                const url = coverImg.getAttribute('data-lightbox-url');
                if (url && !seenUrls.has(url)) {
                    bannerImages.push(url);
                    seenUrls.add(url);
                }
            }
            
            // Collect all images from gallery, interior, exterior sections
            document.querySelectorAll('.gallery-grid .gallery-item img[data-lightbox-url], .image-grid .grid-image[data-lightbox-url]').forEach(img => {
                const url = img.getAttribute('data-lightbox-url');
                if (url && !seenUrls.has(url)) {
                    bannerImages.push(url);
                    seenUrls.add(url);
                }
            });
            
            // Set current index based on current displayed image
            const currentImg = document.getElementById('mainBannerImage');
            if (currentImg && currentImg.src) {
                const currentUrl = currentImg.getAttribute('data-lightbox-url') || currentImg.src;
                currentBannerIndex = bannerImages.indexOf(currentUrl);
                if (currentBannerIndex === -1) {
                    currentBannerIndex = 0;
                }
            } else {
                currentBannerIndex = 0;
            }
            
            updateBannerNavigation();
        }
        
        // Update banner image
        function updateBannerImage(index) {
            if (index < 0 || index >= bannerImages.length) return;
            
            const bannerImg = document.getElementById('mainBannerImage');
            if (bannerImg) {
                const newUrl = bannerImages[index];
                
                // Fade out
                bannerImg.style.opacity = '0';
                bannerImg.style.transition = 'opacity 0.3s ease';
                
                // Update image after fade out
                setTimeout(() => {
                    bannerImg.src = newUrl;
                    bannerImg.setAttribute('data-lightbox-url', newUrl);
                    
                    // Fade in
                    setTimeout(() => {
                        bannerImg.style.opacity = '1';
                    }, 50);
                }, 300);
                
                currentBannerIndex = index;
                updateBannerNavigation();
            }
        }
        
        // Update banner navigation buttons
        function updateBannerNavigation() {
            const prevBtn = document.getElementById('bannerPrevBtn');
            const nextBtn = document.getElementById('bannerNextBtn');
            
            if (bannerImages.length <= 1) {
                // Hide buttons if only 1 or no images
                if (prevBtn) prevBtn.style.display = 'none';
                if (nextBtn) nextBtn.style.display = 'none';
            } else {
                // Show buttons
                if (prevBtn) prevBtn.style.display = 'flex';
                if (nextBtn) nextBtn.style.display = 'flex';
                
                // Enable/disable based on position
                if (prevBtn) {
                    prevBtn.disabled = currentBannerIndex <= 0;
                }
                if (nextBtn) {
                    nextBtn.disabled = currentBannerIndex >= bannerImages.length - 1;
                }
            }
        }
        
        // Previous banner image
        function bannerPreviousImage(event) {
            event.stopPropagation();
            if (currentBannerIndex > 0) {
                updateBannerImage(currentBannerIndex - 1);
            }
        }
        
        // Next banner image
        function bannerNextImage(event) {
            event.stopPropagation();
            if (currentBannerIndex < bannerImages.length - 1) {
                updateBannerImage(currentBannerIndex + 1);
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize banner images
            initBannerImages();
            
            // Set default date to tomorrow
            const dateInput = document.querySelector('input[name="date"]');
            if (dateInput) {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                dateInput.value = tomorrow.toISOString().split('T')[0];
            }
            
            // Star rating
            const stars = document.querySelectorAll('.star-rating-input .star');
            const ratingInput = document.getElementById('ratingInput');
            const ratingText = document.getElementById('ratingText');
            
            if (stars.length > 0 && ratingInput) {
                const ratingTexts = {1: 'Rất tệ', 2: 'Tệ', 3: 'Bình thường', 4: 'Tốt', 5: 'Rất tốt'};
                
                stars.forEach(star => {
                    star.addEventListener('click', function() {
                        const rating = parseInt(this.getAttribute('data-rating'));
                        ratingInput.value = rating;
                        stars.forEach((s, index) => {
                            if (index < rating) {
                                s.classList.remove('far');
                                s.classList.add('fas', 'active');
                            } else {
                                s.classList.remove('fas', 'active');
                                s.classList.add('far');
                            }
                        });
                        if (ratingText) ratingText.textContent = ratingTexts[rating] || 'Chọn số sao đánh giá';
                    });
                    
                    star.addEventListener('mouseenter', function() {
                        const rating = parseInt(this.getAttribute('data-rating'));
                        stars.forEach((s, index) => {
                            s.style.color = (index < rating) ? '#fbbf24' : '#d1d5db';
                        });
                    });
                });
                
                document.querySelector('.star-rating-input')?.addEventListener('mouseleave', function() {
                    const currentRating = parseInt(ratingInput.value) || 0;
                    stars.forEach((s, index) => {
                        s.style.color = (index < currentRating) ? '#fbbf24' : '#d1d5db';
                    });
                });
            }
            
            // Character count
            const commentTextarea = document.getElementById('comment');
            const charCount = document.getElementById('charCount');
            if (commentTextarea && charCount) {
                commentTextarea.addEventListener('input', function() {
                    const length = this.value.length;
                    charCount.textContent = length + '/1000 ký tự';
                    charCount.style.color = (length > 1000) ? '#ef4444' : '#6b7280';
                });
            }
            
            // Smooth scroll to reviews
            if (window.location.hash === '#reviews') {
                const reviewsTab = document.getElementById('reviews-tab');
                if (reviewsTab) {
                    setTimeout(() => {
                        reviewsTab.click();
                        document.getElementById('reviews').scrollIntoView({ behavior: 'smooth' });
                    }, 300);
                }
            }
        });
    </script>
</body>
</html>
