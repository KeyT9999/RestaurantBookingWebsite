<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle}">Chi tiết Nhà hàng</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Design System CSS -->
    <link th:href="@{/css/design-system.css}" rel="stylesheet">
    <!-- Restaurant Detail CSS -->
    <link th:href="@{/css/restaurant-detail.css}" rel="stylesheet">
    
    <style>
        /* Image Modal */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            animation: fadeIn 0.3s;
        }
        
        .image-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content-image {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            animation: zoomIn 0.3s;
        }
        
        .modal-close {
            position: absolute;
            top: 20px;
            right: 40px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10000;
            transition: color 0.2s;
        }
        
        .modal-close:hover {
            color: #ccc;
        }
        
        .modal-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            font-size: 30px;
            width: 50px;
            height: 50px;
            cursor: pointer;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s, transform 0.2s;
            user-select: none;
        }
        
        .modal-nav:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-50%) scale(1.1);
        }
        
        .modal-nav:active {
            transform: translateY(-50%) scale(0.95);
        }
        
        .modal-nav.prev {
            left: 20px;
        }
        
        .modal-nav.next {
            right: 20px;
        }
        
        .modal-nav:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .modal-nav:disabled:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-50%);
        }
        
        .modal-image-counter {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 10000;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes zoomIn {
            from { transform: scale(0.7); }
            to { transform: scale(1); }
        }
        
        @keyframes slideInLeft {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideInRight {
            from { transform: translateX(20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .modal-content-image.slide-left {
            animation: slideInLeft 0.3s;
        }
        
        .modal-content-image.slide-right {
            animation: slideInRight 0.3s;
        }
        
        /* Notification animations */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        /* Favorite Button for Main Restaurant */
        .restaurant-detail-favorite {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 50%;
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(230, 0, 35, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .restaurant-detail-favorite:hover {
            background: #FFFFFF;
            border-color: #E60023;
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(230, 0, 35, 0.3);
        }
        
        .restaurant-detail-favorite i {
            font-size: 24px;
            color: #6B7280;
            transition: all 0.3s ease;
        }
        
        .restaurant-detail-favorite.active i,
        .restaurant-detail-favorite:hover i {
            color: #E60023;
        }
        
        .restaurant-detail-favorite.active {
            background: #FFFFFF;
            border-color: #E60023;
        }
        
        .restaurant-detail-favorite.active i {
            color: #E60023;
        }
        
        @keyframes favoritePulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(1);
            }
        }
        
        .restaurant-detail-favorite.animating {
            animation: favoritePulse 0.6s ease-in-out;
        }
        
        /* Chat Button Styles */
        .btn-chat-restaurant {
            background: #000000;
            border: 2px solid #000000;
            color: #FFFFFF;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
            text-decoration: none;
        }
        
        .btn-chat-restaurant:hover {
            background: #FFFFFF;
            color: #000000;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        .btn-chat-restaurant i {
            font-size: 14px;
        }
    </style>
</head>
<body class="ds-bg-white">
    <!-- Header -->
    <div th:replace="~{fragments/design-system-components :: unified-header}"></div>

    <main>
        <!-- Breadcrumb -->
        <section class="ds-bg-gray-50" style="padding: 16px 0;">
            <div class="ds-container">
                <nav class="ds-breadcrumb">
                    <ol class="ds-breadcrumb-list">
                        <li class="ds-breadcrumb-item"><a th:href="@{/}">Trang chủ</a></li>
                        <li class="ds-breadcrumb-item"><a th:href="@{/restaurants}">Nhà hàng</a></li>
                        <li class="ds-breadcrumb-item active"><span th:text="${restaurant.restaurantName}">Tên nhà hàng</span></li>
                    </ol>
                </nav>
            </div>
        </section>

        <!-- Banner Section -->
        <section class="banner-section">
            <div class="ds-container">
                <div class="banner-grid">
                    <!-- Main Banner - Ảnh lớn bên trái -->
                    <div class="main-banner" id="mainBanner">
                        <!-- Favorite Button -->
                        <button class="restaurant-detail-favorite" 
                                id="mainRestaurantFavorite"
                                type="button"
                                sec:authorize="hasRole('CUSTOMER')"
                                th:attr="data-restaurant-id=${restaurant.restaurantId}"
                                title="Thêm vào yêu thích">
                            <i class="far fa-heart"></i>
                        </button>
                        
                        <button class="banner-nav banner-nav-prev" id="bannerPrevBtn" onclick="bannerPreviousImage(event)" style="display: none;">
                            ‹
                        </button>
                        <button class="banner-nav banner-nav-next" id="bannerNextBtn" onclick="bannerNextImage(event)" style="display: none;">
                            ›
                        </button>
                        
                        <img id="mainBannerImage" th:if="${cover != null}" th:src="${cover.url}" alt="Restaurant" class="main-banner-image" th:attr="data-lightbox-url=${cover.url}" onclick="openImageLightbox(this)" style="cursor: pointer;">
                        <img id="mainBannerImage" th:unless="${cover != null}" th:if="${!#lists.isEmpty(interior)}" th:src="${interior[0].url}" alt="Restaurant" class="main-banner-image" th:attr="data-lightbox-url=${interior[0].url}" onclick="openImageLightbox(this)" style="cursor: pointer;">
                        <img id="mainBannerImage" th:unless="${cover != null or !#lists.isEmpty(interior)}" th:if="${!#lists.isEmpty(gallery)}" th:src="${gallery[0].url}" alt="Restaurant" class="main-banner-image" th:attr="data-lightbox-url=${gallery[0].url}" onclick="openImageLightbox(this)" style="cursor: pointer;">
                        <img id="mainBannerImage" th:unless="${cover != null or !#lists.isEmpty(interior) or !#lists.isEmpty(gallery)}" src="https://via.placeholder.com/800x500?text=Restaurant" alt="Restaurant" class="main-banner-image">
                        
                        <div class="main-banner-overlay">
                            <h1 class="banner-title" th:text="${restaurant.restaurantName}">Tên Nhà hàng</h1>
                            <div class="banner-meta">
                                <div class="banner-meta-item">
                                    <i class="fas fa-star"></i>
                                    <span th:text="${restaurant.formattedAverageRating} + ' (' + ${restaurant.reviewCount} + ' đánh giá)'">0.0 (0 đánh giá)</span>
                                </div>
                                <div class="banner-meta-item" th:if="${restaurant.cuisineType != null}">
                                    <i class="fas fa-utensils"></i>
                                    <span th:text="${restaurant.cuisineType}">Việt Nam</span>
                                </div>
                                <div class="banner-meta-item" th:if="${restaurant.address != null}">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span th:text="${restaurant.address}">Địa chỉ</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Image Grid - 2x3 bên phải -->
                    <div class="image-grid">
                        <!-- Hiển thị ảnh từ gallery -->
                        <div class="grid-image-item" th:each="image, iterStat : ${gallery}" th:if="${iterStat.index < 5}">
                            <img th:src="${image.url}" alt="Gallery" class="grid-image" th:attr="data-lightbox-url=${image.url}" onclick="openImageLightbox(this)">
                        </div>
                        
                        <!-- Ảnh thứ 6 với overlay "Xem tất cả" -->
                        <div class="grid-image-item" th:if="${!#lists.isEmpty(gallery) and gallery.size() >= 6}">
                            <img th:src="${gallery[5].url}" alt="Gallery" class="grid-image">
                            <div class="view-all-overlay" onclick="document.getElementById('gallery-tab').click();">Xem tất cả</div>
                        </div>
                        
                        <!-- Hiển thị ảnh từ interior/exterior nếu không có gallery -->
                        <div class="grid-image-item" th:if="${#lists.isEmpty(gallery)}" th:each="image, iterStat : ${interior}" th:unless="${iterStat.index >= 3}">
                            <img th:src="${image.url}" alt="Interior" class="grid-image" th:attr="data-lightbox-url=${image.url}" onclick="openImageLightbox(this)">
                        </div>
                        <div class="grid-image-item" th:if="${#lists.isEmpty(gallery)}" th:each="image, iterStat : ${exterior}" th:unless="${iterStat.index >= 3}">
                            <img th:src="${image.url}" alt="Exterior" class="grid-image" th:attr="data-lightbox-url=${image.url}" onclick="openImageLightbox(this)">
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Restaurant Info Section -->
        <section style="padding: 0 0 24px 0;">
            <div class="ds-container">
                <div class="page-section">
                    <!-- Tên và Rating -->
                    <div style="margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid #e5e7eb;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; margin-bottom: 8px;">
                            <div style="flex: 1;">
                                <h1 class="section-title" style="font-size: 24px; margin-bottom: 8px; margin-top: 0;" th:text="${restaurant.restaurantName}">Tên Nhà hàng</h1>
                                <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <i class="fas fa-star" style="color: #fbbf24;"></i>
                                        <span class="text-base" th:text="${restaurant.formattedAverageRating} + ' (' + ${restaurant.reviewCount} + ' đánh giá)'">0.0 (0 đánh giá)</span>
                                    </div>
                                    <span class="restaurant-badge" th:if="${restaurant.cuisineType != null}" th:text="${restaurant.cuisineType}">Việt Nam</span>
                                </div>
                            </div>
                            
                            <!-- Chat Button - Bên phải tiêu đề -->
                            <div sec:authorize="isAuthenticated() and (hasRole('CUSTOMER') or hasRole('customer'))" style="flex-shrink: 0;">
                                <button class="btn-chat-restaurant" 
                                        th:attr="data-restaurant-id=${restaurant.restaurantId}"
                                        onclick="openChatWithRestaurant(this)"
                                        style="white-space: nowrap;">
                                    <i class="fas fa-paper-plane"></i>
                                    Nhắn tin cho chúng tôi
                                </button>
                            </div>
                            
                            <!-- Chat Button for non-authenticated users -->
                            <div sec:authorize="!isAuthenticated()" style="flex-shrink: 0;">
                                <a th:href="@{/login(redirect=${#httpServletRequest.requestURI})}" class="btn-chat-restaurant" style="white-space: nowrap;">
                                    <i class="fas fa-paper-plane"></i>
                                    Nhắn tin cho chúng tôi
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Grid thông tin -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px;">
                        <div class="info-item">
                            <div class="info-icon"><i class="fas fa-clock"></i></div>
                            <div class="info-content">
                                <div class="info-label">Giờ mở cửa</div>
                                <div class="info-value" th:text="${restaurant.openingHours != null ? restaurant.openingHours : 'Đang cập nhật'}">Đang cập nhật</div>
                            </div>
                        </div>
                        
                        <div class="info-item">
                            <div class="info-icon"><i class="fas fa-map-marker-alt"></i></div>
                            <div class="info-content">
                                <div class="info-label">Địa chỉ</div>
                                <div class="info-value">
                                    <span th:text="${restaurant.address != null ? restaurant.address : 'Đang cập nhật'}">Đang cập nhật</span>
                                    <div th:if="${restaurant.address != null}" style="margin-top: 8px;">
                                        <a th:href="'https://www.google.com/maps/search/?api=1&query=' + ${#strings.replace(restaurant.address, ' ', '+')}" 
                                           target="_blank" class="btn-menu" style="font-size: 13px; padding: 6px 12px;">
                                            <i class="fas fa-map-marked-alt"></i> Xem bản đồ
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="info-item">
                            <div class="info-icon"><i class="fas fa-phone"></i></div>
                            <div class="info-content">
                                <div class="info-label">Điện thoại</div>
                                <div class="info-value">
                                    <a th:if="${restaurant.phone != null}" th:href="'tel:' + ${restaurant.phone}" th:text="${restaurant.phone}">Phone</a>
                                    <span th:unless="${restaurant.phone != null}">Đang cập nhật</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="info-item" th:if="${restaurant.averagePrice != null}">
                            <div class="info-icon"><i class="fas fa-dollar-sign"></i></div>
                            <div class="info-content">
                                <div class="info-label">Giá trung bình</div>
                                <div class="info-value" th:text="'₫' + ${#numbers.formatDecimal(restaurant.averagePrice, 0, 'COMMA', 0, 'POINT')}">₫500.000</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Main Content -->
        <section style="padding: 0 0 48px 0;">
            <div class="ds-container">
                <!-- Success/Error Messages -->
                <div th:if="${success != null}" class="alert-message alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    <span th:text="${success}">Thành công!</span>
                </div>
                <div th:if="${error != null}" class="alert-message alert-error">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <span th:text="${error}">Có lỗi xảy ra!</span>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 380px; gap: 24px;">
                    <!-- Left Column - Tabs -->
                    <div>
                        <!-- Tabs -->
                        <ul class="nav restaurant-tabs">
                            <li class="nav-item">
                                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#about">Giới thiệu</button>
                            </li>
                            <li class="nav-item" th:if="${!#lists.isEmpty(gallery) or !#lists.isEmpty(exterior) or !#lists.isEmpty(interior)}">
                                <button class="nav-link" id="gallery-tab" data-bs-toggle="tab" data-bs-target="#gallery">Hình ảnh</button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" id="menu-tab" data-bs-toggle="tab" data-bs-target="#menu">Thực đơn</button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tables">Bàn</button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews">Đánh giá</button>
                            </li>
                        </ul>

                        <!-- Tab Content -->
                        <div class="tab-content">
                            <!-- About Tab -->
                            <div class="tab-pane fade show active" id="about">
                                <div class="page-section">
                                    <div class="page-section-header">
                                        <h2 class="section-title">Giới thiệu nhà hàng</h2>
                                    </div>
                                    <div class="page-section-content">
                                        <div class="subsection" th:if="${restaurant.description != null}">
                                            <h3 class="subsection-title">Câu chuyện của chúng tôi</h3>
                                            <p class="text-base" th:utext="${restaurant.description}">Mô tả nhà hàng</p>
                                        </div>
                                        
                                        <div class="subsection" th:if="${restaurant.amenities != null and !#strings.isEmpty(restaurant.amenities)}">
                                            <h3 class="subsection-title">Tiện ích</h3>
                                            <p class="text-base" th:utext="${restaurant.amenities}">Tiện ích</p>
                                        </div>
                                        
                                        <div class="subsection" th:if="${restaurant.menuHighlights != null and !#strings.isEmpty(restaurant.menuHighlights)}">
                                            <h3 class="subsection-title">Điểm nổi bật thực đơn</h3>
                                            <p class="text-base" th:utext="${restaurant.menuHighlights}">Điểm nổi bật</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Gallery Tab -->
                            <div class="tab-pane fade" id="gallery">
                                <div class="page-section">
                                    <div class="page-section-header">
                                        <h2 class="section-title">Hình ảnh nhà hàng</h2>
                                    </div>
                                    <div class="page-section-content">
                                        <div class="subsection" th:if="${!#lists.isEmpty(gallery)}">
                                            <h3 class="subsection-title">Thư viện ảnh</h3>
                                            <div class="gallery-grid">
                                                <div class="gallery-item" th:each="image : ${gallery}">
                                                    <img th:src="${image.url}" alt="Gallery" th:attr="data-lightbox-url=${image.url}" onclick="openImageLightbox(this)">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="subsection" th:if="${!#lists.isEmpty(exterior)}">
                                            <h3 class="subsection-title">Ngoại thất</h3>
                                            <div class="gallery-grid">
                                                <div class="gallery-item" th:each="image : ${exterior}">
                                                    <img th:src="${image.url}" alt="Exterior" th:attr="data-lightbox-url=${image.url}" onclick="openImageLightbox(this)">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="subsection" th:if="${!#lists.isEmpty(interior)}">
                                            <h3 class="subsection-title">Nội thất</h3>
                                            <div class="gallery-grid">
                                                <div class="gallery-item" th:each="image : ${interior}">
                                                    <img th:src="${image.url}" alt="Interior" th:attr="data-lightbox-url=${image.url}" onclick="openImageLightbox(this)">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div th:if="${#lists.isEmpty(gallery) and #lists.isEmpty(exterior) and #lists.isEmpty(interior)}" style="text-align: center; padding: 48px 0;">
                                            <p class="text-base text-secondary">Hình ảnh đang được cập nhật.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Menu Tab -->
                            <div class="tab-pane fade" id="menu">
                                <div class="page-section">
                                    <div class="page-section-header">
                                        <h2 class="section-title">Thực đơn</h2>
                                    </div>
                                    <div class="page-section-content">
                                        <div class="subsection" th:if="${!#lists.isEmpty(menus)}">
                                            <h3 class="subsection-title">Menu PDF</h3>
                                            <div class="menu-grid">
                                                <div class="menu-card" th:each="menu : ${menus}">
                                                    <div class="menu-image-wrapper">
                                                        <img th:src="${menu.url}" alt="Menu" class="menu-image">
                                                    </div>
                                                    <div class="menu-actions">
                                                        <a th:href="${menu.url}" target="_blank" class="btn-menu"><i class="fas fa-eye"></i> Xem</a>
                                                        <a th:href="${menu.url}" download class="btn-menu"><i class="fas fa-download"></i> Tải</a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="subsection" th:if="${!#lists.isEmpty(dishes)}">
                                            <h3 class="subsection-title" th:if="${!#lists.isEmpty(menus)}">Món ăn</h3>
                                            <div class="dish-grid">
                                                <div class="dish-card" th:each="dish : ${dishes}">
                                                    <div class="dish-image-wrapper" th:if="${dish.imageUrl != null}">
                                                        <img th:src="${dish.imageUrl}" alt="Dish" class="dish-image">
                                                    </div>
                                                    <div class="dish-name" th:text="${dish.name}">Tên món</div>
                                                    <div class="dish-description" th:text="${dish.description}">Mô tả món ăn</div>
                                                    <div class="dish-footer">
                                                        <div>
                                                            <span class="dish-badge" th:if="${dish.category != null}" th:text="${dish.category}">Loại</span>
                                                        </div>
                                                        <div class="dish-price" th:text="'₫' + ${#numbers.formatDecimal(dish.price, 0, 'COMMA', 0, 'POINT')}">₫0</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div th:if="${#lists.isEmpty(dishes) and #lists.isEmpty(menus)}" style="text-align: center; padding: 48px 0;">
                                            <p class="text-base text-secondary">Thực đơn đang được cập nhật.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Tables Tab -->
                            <div class="tab-pane fade" id="tables">
                                <div class="page-section">
                                    <div class="page-section-header">
                                        <h2 class="section-title">Sơ đồ nhà hàng</h2>
                                    </div>
                                    <div class="page-section-content">
                                        <div class="subsection" th:if="${!#lists.isEmpty(tableLayouts)}">
                                            <h3 class="subsection-title">Sơ đồ bàn</h3>
                                            <div class="gallery-grid">
                                                <div class="gallery-item" th:each="layout : ${tableLayouts}">
                                                    <img th:src="${layout.url}" alt="Table Layout" th:attr="data-lightbox-url=${layout.url}" onclick="openImageLightbox(this)">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="subsection" th:if="${!#lists.isEmpty(tables)}">
                                            <h3 class="subsection-title" th:if="${!#lists.isEmpty(tableLayouts)}">Danh sách bàn</h3>
                                            <div class="table-grid">
                                                <div class="table-card" th:each="table : ${tables}">
                                                    <div class="table-header">
                                                        <span class="table-name" th:text="${table.tableName}">Bàn</span>
                                                        <span class="table-status available" th:classappend="${table.status.name() == 'OCCUPIED'} ? 'occupied' : (${table.status.name() == 'MAINTENANCE'} ? 'maintenance' : 'available')" th:text="${table.status.name() == 'AVAILABLE'} ? 'Trống' : (${table.status.name() == 'OCCUPIED'} ? 'Đã đặt' : 'Bảo trì')">Trống</span>
                                                    </div>
                                                    <div class="table-info">
                                                        <div class="table-info-item">
                                                            <i class="fas fa-users"></i>
                                                            <span th:text="${table.capacity} + ' chỗ'">0 chỗ</span>
                                                        </div>
                                                        <div class="table-info-item" th:if="${table.depositAmount != null and table.depositAmount > 0}">
                                                            <i class="fas fa-dollar-sign"></i>
                                                            <span th:text="'₫' + ${#numbers.formatDecimal(table.depositAmount, 0, 'COMMA', 0, 'POINT')}">₫0</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div th:if="${#lists.isEmpty(tables) and #lists.isEmpty(tableLayouts)}" style="text-align: center; padding: 48px 0;">
                                            <p class="text-base text-secondary">Thông tin bàn đang được cập nhật.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Reviews Tab -->
                            <div class="tab-pane fade" id="reviews">
                                <div class="page-section">
                                    <div class="page-section-header">
                                        <h2 class="section-title">Đánh giá khách hàng</h2>
                                    </div>
                                    <div class="page-section-content">
                                        <!-- Review Statistics -->
                                        <div class="subsection" th:if="${statistics != null}">
                                            <div class="review-stats">
                                                <div class="rating-display">
                                                    <div class="rating-number" th:text="${statistics.formattedAverageRating}">0.0</div>
                                                    <div class="rating-stars">
                                                        <i class="fas fa-star star-rating" th:each="i : ${#numbers.sequence(1, 5)}" th:classappend="${i <= statistics.averageRating} ? 'star-rating' : 'star-empty'"></i>
                                                    </div>
                                                    <div class="rating-count" th:text="'Dựa trên ' + ${statistics.totalReviews} + ' đánh giá'">Dựa trên 0 đánh giá</div>
                                                </div>
                                                <div class="rating-breakdown">
                                                    <div class="rating-row">
                                                        <span class="rating-label">5★</span>
                                                        <div class="progress"><div class="progress-bar" th:style="'width: ' + ${statistics.fiveStarPercentage} + '%'"></div></div>
                                                        <span class="rating-count-number" th:text="${statistics.fiveStarCount}">0</span>
                                                    </div>
                                                    <div class="rating-row">
                                                        <span class="rating-label">4★</span>
                                                        <div class="progress"><div class="progress-bar" th:style="'width: ' + ${statistics.fourStarPercentage} + '%'"></div></div>
                                                        <span class="rating-count-number" th:text="${statistics.fourStarCount}">0</span>
                                                    </div>
                                                    <div class="rating-row">
                                                        <span class="rating-label">3★</span>
                                                        <div class="progress"><div class="progress-bar" th:style="'width: ' + ${statistics.threeStarPercentage} + '%'"></div></div>
                                                        <span class="rating-count-number" th:text="${statistics.threeStarCount}">0</span>
                                                    </div>
                                                    <div class="rating-row">
                                                        <span class="rating-label">2★</span>
                                                        <div class="progress"><div class="progress-bar" th:style="'width: ' + ${statistics.twoStarPercentage} + '%'"></div></div>
                                                        <span class="rating-count-number" th:text="${statistics.twoStarCount}">0</span>
                                                    </div>
                                                    <div class="rating-row">
                                                        <span class="rating-label">1★</span>
                                                        <div class="progress"><div class="progress-bar" th:style="'width: ' + ${statistics.oneStarPercentage} + '%'"></div></div>
                                                        <span class="rating-count-number" th:text="${statistics.oneStarCount}">0</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Review Form -->
                                        <div class="subsection" th:if="${!hasReviewed}" sec:authorize="isAuthenticated()">
                                            <h3 class="subsection-title">Viết đánh giá của bạn</h3>
                                            <div class="review-form-card">
                                                <form th:action="@{/reviews}" th:object="${reviewForm}" method="post">
                                                    <input type="hidden" th:field="*{restaurantId}">
                                                    
                                                    <div class="form-group">
                                                        <label class="form-label">Đánh giá của bạn <span style="color: #ef4444;">*</span></label>
                                                        <div class="star-rating-input">
                                                            <i class="far fa-star star" data-rating="1"></i>
                                                            <i class="far fa-star star" data-rating="2"></i>
                                                            <i class="far fa-star star" data-rating="3"></i>
                                                            <i class="far fa-star star" data-rating="4"></i>
                                                            <i class="far fa-star star" data-rating="5"></i>
                                                            <input type="hidden" th:field="*{rating}" id="ratingInput" required>
                                                        </div>
                                                        <div class="rating-text" id="ratingText">Chọn số sao đánh giá</div>
                                                    </div>
                                                    
                                                    <div class="form-group">
                                                        <label for="comment" class="form-label">Bình luận</label>
                                                        <textarea th:field="*{comment}" id="comment" class="form-control" rows="4" placeholder="Chia sẻ trải nghiệm của bạn..." maxlength="1000"></textarea>
                                                        <div class="text-base text-secondary" style="margin-top: 8px;" id="charCount">0/1000 ký tự</div>
                                                    </div>
                                                    
                                                    <button type="submit" class="btn-book">
                                                        <i class="fas fa-paper-plane me-2"></i> Gửi đánh giá
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                        
                                        <!-- User's Review -->
                                        <div class="subsection" th:if="${hasReviewed and customerReview != null}">
                                            <h3 class="subsection-title">Đánh giá của bạn</h3>
                                            <div class="review-card">
                                                <div class="review-header">
                                                    <div class="review-avatar">Bạn</div>
                                                    <div class="review-info">
                                                        <div class="review-name">Đánh giá của bạn</div>
                                                        <div class="review-meta">
                                                            <div class="review-stars">
                                                                <i class="fas fa-star star-rating" th:each="i : ${#numbers.sequence(1, 5)}" th:classappend="${i <= customerReview.rating} ? 'star-rating' : 'star-empty'"></i>
                                                            </div>
                                                            <span th:text="${#temporals.format(customerReview.createdAt, 'dd/MM/yyyy')}">Date</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="review-text" th:text="${customerReview.comment}">Comment</div>
                                            </div>
                                        </div>
                                        
                                        <!-- Recent Reviews -->
                                        <div class="subsection" th:if="${!#lists.isEmpty(recentReviews)}">
                                            <h3 class="subsection-title" th:if="${hasReviewed}">Đánh giá khác</h3>
                                            <div class="review-grid">
                                                <div class="review-card" th:each="review : ${recentReviews}">
                                                    <div class="review-header">
                                                        <div class="review-avatar" th:text="${#strings.substring(review.customerName, 0, 2)}">SJ</div>
                                                        <div class="review-info">
                                                            <div class="review-name" th:text="${review.customerName}">Name</div>
                                                            <div class="review-meta">
                                                                <div class="review-stars">
                                                                    <i class="fas fa-star star-rating" th:each="i : ${#numbers.sequence(1, 5)}" th:classappend="${i <= review.rating} ? 'star-rating' : 'star-empty'"></i>
                                                                </div>
                                                                <span th:text="${#temporals.format(review.createdAt, 'dd/MM/yyyy')}">Date</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="review-text" th:text="${review.comment}">Comment</div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div th:if="${#lists.isEmpty(recentReviews) and !hasReviewed}" style="text-align: center; padding: 48px 0;">
                                            <p class="text-base text-secondary">Chưa có đánh giá nào.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Column - Booking Widget -->
                    <div>
                        <div class="reservation-widget">
                            <h3 class="reservation-title">Đặt bàn</h3>
                            <form th:action="@{/booking/new}" method="get">
                                <input type="hidden" name="restaurantId" th:value="${restaurant.restaurantId}">
                                
                                <div class="form-group">
                                    <label class="form-label">Chọn ngày</label>
                                    <div class="input-group">
                                        <i class="fas fa-calendar input-icon"></i>
                                        <input type="date" class="form-control" name="date" required>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Chọn giờ</label>
                                    <div class="input-group">
                                        <i class="fas fa-clock input-icon"></i>
                                        <select class="form-control" name="time" required>
                                            <option value="">Chọn giờ</option>
                                            <option value="17:00">17:00</option>
                                            <option value="17:30">17:30</option>
                                            <option value="18:00">18:00</option>
                                            <option value="18:30">18:30</option>
                                            <option value="19:00">19:00</option>
                                            <option value="19:30">19:30</option>
                                            <option value="20:00">20:00</option>
                                            <option value="20:30">20:30</option>
                                            <option value="21:00">21:00</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Số lượng khách</label>
                                    <div class="input-group">
                                        <i class="fas fa-user input-icon"></i>
                                        <select class="form-control" name="guests" required>
                                            <option value="">Chọn số lượng</option>
                                            <option value="1">1 khách</option>
                                            <option value="2">2 khách</option>
                                            <option value="3">3 khách</option>
                                            <option value="4">4 khách</option>
                                            <option value="5">5 khách</option>
                                            <option value="6">6 khách</option>
                                            <option value="7">7 khách</option>
                                            <option value="8">8 khách</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn-book">
                                    <i class="fas fa-calendar-check me-2"></i> Đặt bàn ngay
                                </button>
                                
                                <div class="cancellation-policy">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Bạn có thể hủy hoặc thay đổi đặt bàn trước 24 giờ
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Related Restaurants Section -->
        <section class="related-restaurants-section" th:if="${!#lists.isEmpty(relatedRestaurants)}">
            <div class="ds-container">
                <!-- Section Header -->
                <div class="related-restaurants-header">
                    <h2 class="related-restaurants-title">Các nhà hàng liên quan</h2>
                    <p class="related-restaurants-subtitle">Khám phá những địa điểm ẩm thực tương tự gần bạn</p>
                    <div class="related-restaurants-divider"></div>
                </div>

                <!-- Restaurant Cards Horizontal Scroll Container -->
                <div class="related-restaurants-wrapper">
                    <!-- Navigation Buttons (chỉ hiện khi có > 4 nhà hàng) -->
                    <button class="related-nav-btn related-nav-prev" id="relatedPrevBtn" 
                            th:if="${relatedRestaurants.size() > 4}" 
                            onclick="scrollRelatedRestaurants('left')" 
                            aria-label="Previous">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="related-nav-btn related-nav-next" id="relatedNextBtn" 
                            th:if="${relatedRestaurants.size() > 4}" 
                            onclick="scrollRelatedRestaurants('right')" 
                            aria-label="Next">
                        <i class="fas fa-chevron-right"></i>
                    </button>

                    <!-- Restaurant Cards Horizontal Scroll -->
                    <div class="related-restaurants-grid" id="relatedRestaurantsGrid">
                        <div class="related-restaurant-card" th:each="relatedRestaurant : ${relatedRestaurants}">
                            <!-- Image Container -->
                            <div class="restaurant-card-image-container">
                                <a th:href="@{/restaurants/{id}(id=${relatedRestaurant.restaurantId})}">
                                    <img th:src="${relatedRestaurant.mainImageUrl != null ? relatedRestaurant.mainImageUrl : '/images/default-restaurant.jpg'}" 
                                         th:alt="${relatedRestaurant.restaurantName}" 
                                         class="restaurant-card-image">
                                </a>
                                <div class="restaurant-card-overlay"></div>
                                <!-- Favorite Icon -->
                                <button class="restaurant-card-favorite" 
                                        type="button" 
                                        th:attr="data-restaurant-id=${relatedRestaurant.restaurantId}">
                                    <i class="far fa-heart"></i>
                                </button>
                            </div>

                            <!-- Card Content -->
                            <div class="restaurant-card-content">
                                <!-- Restaurant Name -->
                                <h3 class="restaurant-card-name">
                                    <a th:href="@{/restaurants/{id}(id=${relatedRestaurant.restaurantId})}" 
                                       th:text="${relatedRestaurant.restaurantName}"
                                       style="color: inherit; text-decoration: none;">Tên nhà hàng</a>
                                </h3>

                                <!-- Address -->
                                <div class="restaurant-card-info" th:if="${relatedRestaurant.address != null}">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span th:text="${relatedRestaurant.address}">Địa chỉ</span>
                                </div>

                                <!-- Cuisine Type -->
                                <div class="restaurant-card-info" th:if="${relatedRestaurant.cuisineType != null}">
                                    <i class="fas fa-utensils"></i>
                                    <span th:text="${relatedRestaurant.cuisineType}">Loại ẩm thực</span>
                                </div>

                                <!-- Price Range -->
                                <div class="restaurant-card-info" th:if="${relatedRestaurant.averagePrice != null}">
                                    <i class="fas fa-money-bill-wave"></i>
                                    <span th:text="'₫' + ${#numbers.formatDecimal(relatedRestaurant.averagePrice, 0, 'COMMA', 0, 'POINT')} + '/người'">Khoảng giá</span>
                                </div>

                                <!-- Status Badge -->
                                <div class="restaurant-card-status">
                                    <span class="status-badge status-open" 
                                          th:if="${relatedRestaurantsIsOpen != null and relatedRestaurantsIsOpen[relatedRestaurant.restaurantId]}">
                                        Đang mở cửa
                                    </span>
                                    <span class="status-badge status-closed" 
                                          th:unless="${relatedRestaurantsIsOpen != null and relatedRestaurantsIsOpen[relatedRestaurant.restaurantId]}">
                                        <span th:if="${relatedRestaurant.openingHours != null and !relatedRestaurant.openingHours.trim().isEmpty()}">
                                            Giờ mở cửa: 
                                            <span th:with="hours=${#strings.replace(relatedRestaurant.openingHours.trim(), ' ', '')}" 
                                                  th:text="${#strings.substringBefore(hours, '-')}">10:00</span>
                                        </span>
                                        <span th:unless="${relatedRestaurant.openingHours != null and !relatedRestaurant.openingHours.trim().isEmpty()}">
                                            Đã đóng cửa
                                        </span>
                                    </span>
                                </div>

                                <!-- CTA Button -->
                                <div class="restaurant-card-actions">
                                    <a th:href="@{/restaurants/{id}(id=${relatedRestaurant.restaurantId})}" class="btn-restaurant-card">
                                        Đặt bàn ngay
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <!-- Image Modal -->
    <div id="imageModal" class="image-modal" onclick="handleModalBackgroundClick(event)">
        <span class="modal-close" onclick="closeImageModal()">&times;</span>
        <button class="modal-nav prev" onclick="previousImage(event)" id="prevBtn">‹</button>
        <button class="modal-nav next" onclick="nextImage(event)" id="nextBtn">›</button>
        <img id="modalImage" class="modal-content-image" src="" alt="Image">
        <div class="modal-image-counter" id="imageCounter"></div>
    </div>
    
    <!-- Footer -->
    <div th:replace="~{fragments/design-system-components :: unified-footer}"></div>
    <div th:replace="~{fragments/resy-scripts :: basic-scripts}"></div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Image gallery state
        let imageGallery = [];
        let currentImageIndex = -1;
        
        // Collect all viewable images on page load
        function collectAllImages() {
            const images = [];
            const seenUrls = new Set();
            
            // Collect main banner image
            const mainBanner = document.querySelector('.main-banner-image[data-lightbox-url]');
            if (mainBanner) {
                const url = mainBanner.getAttribute('data-lightbox-url');
                if (url && !seenUrls.has(url)) {
                    images.push(url);
                    seenUrls.add(url);
                }
            }
            
            // Collect banner grid images
            document.querySelectorAll('.image-grid .grid-image[data-lightbox-url]').forEach(img => {
                const url = img.getAttribute('data-lightbox-url');
                if (url && !seenUrls.has(url)) {
                    images.push(url);
                    seenUrls.add(url);
                }
            });
            
            // Collect gallery images (from Gallery tab)
            document.querySelectorAll('.gallery-grid .gallery-item img[data-lightbox-url]').forEach(img => {
                const url = img.getAttribute('data-lightbox-url');
                if (url && !seenUrls.has(url)) {
                    images.push(url);
                    seenUrls.add(url);
                }
            });
            
            return images;
        }
        
        // Open image modal
        function openImageLightbox(imgElement) {
            const imageUrl = imgElement.getAttribute('data-lightbox-url') || imgElement.src;
            
            // Collect all images
            imageGallery = collectAllImages();
            currentImageIndex = imageGallery.indexOf(imageUrl);
            
            // If image not found, add it
            if (currentImageIndex === -1) {
                currentImageIndex = 0;
                imageGallery = [imageUrl];
            }
            
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            if (modal && modalImg) {
                modalImg.src = imageUrl;
                modalImg.classList.remove('slide-left', 'slide-right');
                modal.classList.add('show');
                document.body.style.overflow = 'hidden';
                updateNavigationButtons();
                updateImageCounter();
            }
        }
        
        // Update navigation buttons state
        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (prevBtn) {
                prevBtn.disabled = currentImageIndex <= 0 || imageGallery.length <= 1;
            }
            if (nextBtn) {
                nextBtn.disabled = currentImageIndex >= imageGallery.length - 1 || imageGallery.length <= 1;
            }
        }
        
        // Update image counter
        function updateImageCounter() {
            const counter = document.getElementById('imageCounter');
            if (counter && imageGallery.length > 1) {
                counter.textContent = `${currentImageIndex + 1} / ${imageGallery.length}`;
                counter.style.display = 'block';
            } else if (counter) {
                counter.style.display = 'none';
            }
        }
        
        // Show image at index
        function showImageAtIndex(index, direction) {
            if (index < 0 || index >= imageGallery.length) return;
            
            currentImageIndex = index;
            const modalImg = document.getElementById('modalImage');
            if (modalImg) {
                // Add animation class
                modalImg.classList.remove('slide-left', 'slide-right');
                if (direction === 'prev') {
                    modalImg.classList.add('slide-right');
                } else if (direction === 'next') {
                    modalImg.classList.add('slide-left');
                }
                
                // Update image source
                modalImg.src = imageGallery[index];
                updateNavigationButtons();
                updateImageCounter();
            }
        }
        
        // Previous image
        function previousImage(event) {
            event.stopPropagation();
            if (currentImageIndex > 0) {
                showImageAtIndex(currentImageIndex - 1, 'prev');
            }
        }
        
        // Next image
        function nextImage(event) {
            event.stopPropagation();
            if (currentImageIndex < imageGallery.length - 1) {
                showImageAtIndex(currentImageIndex + 1, 'next');
            }
        }
        
        // Handle modal background click (close only if clicking background, not buttons)
        function handleModalBackgroundClick(event) {
            if (event.target.id === 'imageModal') {
                closeImageModal();
            }
        }
        
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            if (modal) {
                modal.classList.remove('show');
                document.body.style.overflow = 'auto';
                // Reset state
                currentImageIndex = -1;
                imageGallery = [];
            }
        }
        
        // Keyboard navigation
        document.addEventListener('keydown', function(e) {
            const modal = document.getElementById('imageModal');
            if (!modal || !modal.classList.contains('show')) return;
            
            if (e.key === 'Escape') {
                closeImageModal();
            } else if (e.key === 'ArrowLeft') {
                e.preventDefault();
                previousImage(e);
            } else if (e.key === 'ArrowRight') {
                e.preventDefault();
                nextImage(e);
            }
        });
        
        // Banner image gallery state
        let bannerImages = [];
        let currentBannerIndex = 0;
        
        // Collect banner images from page
        function initBannerImages() {
            bannerImages = [];
            const seenUrls = new Set();
            
            // Collect cover image
            const coverImg = document.querySelector('.main-banner-image[data-lightbox-url]');
            if (coverImg) {
                const url = coverImg.getAttribute('data-lightbox-url');
                if (url && !seenUrls.has(url)) {
                    bannerImages.push(url);
                    seenUrls.add(url);
                }
            }
            
            // Collect all images from gallery, interior, exterior sections
            document.querySelectorAll('.gallery-grid .gallery-item img[data-lightbox-url], .image-grid .grid-image[data-lightbox-url]').forEach(img => {
                const url = img.getAttribute('data-lightbox-url');
                if (url && !seenUrls.has(url)) {
                    bannerImages.push(url);
                    seenUrls.add(url);
                }
            });
            
            // Set current index based on current displayed image
            const currentImg = document.getElementById('mainBannerImage');
            if (currentImg && currentImg.src) {
                const currentUrl = currentImg.getAttribute('data-lightbox-url') || currentImg.src;
                currentBannerIndex = bannerImages.indexOf(currentUrl);
                if (currentBannerIndex === -1) {
                    currentBannerIndex = 0;
                }
            } else {
                currentBannerIndex = 0;
            }
            
            updateBannerNavigation();
        }
        
        // Update banner image
        function updateBannerImage(index) {
            if (index < 0 || index >= bannerImages.length) return;
            
            const bannerImg = document.getElementById('mainBannerImage');
            if (bannerImg) {
                const newUrl = bannerImages[index];
                
                // Fade out
                bannerImg.style.opacity = '0';
                bannerImg.style.transition = 'opacity 0.3s ease';
                
                // Update image after fade out
                setTimeout(() => {
                    bannerImg.src = newUrl;
                    bannerImg.setAttribute('data-lightbox-url', newUrl);
                    
                    // Fade in
                    setTimeout(() => {
                        bannerImg.style.opacity = '1';
                    }, 50);
                }, 300);
                
                currentBannerIndex = index;
                updateBannerNavigation();
            }
        }
        
        // Update banner navigation buttons
        function updateBannerNavigation() {
            const prevBtn = document.getElementById('bannerPrevBtn');
            const nextBtn = document.getElementById('bannerNextBtn');
            
            if (bannerImages.length <= 1) {
                // Hide buttons if only 1 or no images
                if (prevBtn) prevBtn.style.display = 'none';
                if (nextBtn) nextBtn.style.display = 'none';
            } else {
                // Show buttons
                if (prevBtn) prevBtn.style.display = 'flex';
                if (nextBtn) nextBtn.style.display = 'flex';
                
                // Enable/disable based on position
                if (prevBtn) {
                    prevBtn.disabled = currentBannerIndex <= 0;
                }
                if (nextBtn) {
                    nextBtn.disabled = currentBannerIndex >= bannerImages.length - 1;
                }
            }
        }
        
        // Previous banner image
        function bannerPreviousImage(event) {
            event.stopPropagation();
            if (currentBannerIndex > 0) {
                updateBannerImage(currentBannerIndex - 1);
            }
        }
        
        // Next banner image
        function bannerNextImage(event) {
            event.stopPropagation();
            if (currentBannerIndex < bannerImages.length - 1) {
                updateBannerImage(currentBannerIndex + 1);
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize banner images
            initBannerImages();
            
            // Set default date to tomorrow
            const dateInput = document.querySelector('input[name="date"]');
            if (dateInput) {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                dateInput.value = tomorrow.toISOString().split('T')[0];
            }
            
            // Star rating
            const stars = document.querySelectorAll('.star-rating-input .star');
            const ratingInput = document.getElementById('ratingInput');
            const ratingText = document.getElementById('ratingText');
            
            if (stars.length > 0 && ratingInput) {
                const ratingTexts = {1: 'Rất tệ', 2: 'Tệ', 3: 'Bình thường', 4: 'Tốt', 5: 'Rất tốt'};
                
                stars.forEach(star => {
                    star.addEventListener('click', function() {
                        const rating = parseInt(this.getAttribute('data-rating'));
                        ratingInput.value = rating;
                        stars.forEach((s, index) => {
                            if (index < rating) {
                                s.classList.remove('far');
                                s.classList.add('fas', 'active');
                            } else {
                                s.classList.remove('fas', 'active');
                                s.classList.add('far');
                            }
                        });
                        if (ratingText) ratingText.textContent = ratingTexts[rating] || 'Chọn số sao đánh giá';
                    });
                    
                    star.addEventListener('mouseenter', function() {
                        const rating = parseInt(this.getAttribute('data-rating'));
                        stars.forEach((s, index) => {
                            s.style.color = (index < rating) ? '#fbbf24' : '#d1d5db';
                        });
                    });
                });
                
                document.querySelector('.star-rating-input')?.addEventListener('mouseleave', function() {
                    const currentRating = parseInt(ratingInput.value) || 0;
                    stars.forEach((s, index) => {
                        s.style.color = (index < currentRating) ? '#fbbf24' : '#d1d5db';
                    });
                });
            }
            
            // Character count
            const commentTextarea = document.getElementById('comment');
            const charCount = document.getElementById('charCount');
            if (commentTextarea && charCount) {
                commentTextarea.addEventListener('input', function() {
                    const length = this.value.length;
                    charCount.textContent = length + '/1000 ký tự';
                    charCount.style.color = (length > 1000) ? '#ef4444' : '#6b7280';
                });
            }
            
            // Smooth scroll to reviews
            if (window.location.hash === '#reviews') {
                const reviewsTab = document.getElementById('reviews-tab');
                if (reviewsTab) {
                    setTimeout(() => {
                        reviewsTab.click();
                        document.getElementById('reviews').scrollIntoView({ behavior: 'smooth' });
                    }, 300);
                }
            }
            
            // Setup favorite button event listeners
            function setupFavoriteButtons() {
                const favoriteButtons = document.querySelectorAll('.restaurant-card-favorite[data-restaurant-id]');
                console.log('Setting up ' + favoriteButtons.length + ' favorite buttons');
                
                favoriteButtons.forEach(button => {
                    // Remove existing listeners by cloning
                    const newButton = button.cloneNode(true);
                    button.parentNode.replaceChild(newButton, button);
                    
                    // Add click event listener
                    newButton.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const restaurantId = parseInt(this.getAttribute('data-restaurant-id'));
                        console.log('Favorite button clicked for restaurant:', restaurantId);
                        
                        if (restaurantId) {
                            toggleFavorite(this, restaurantId);
                        } else {
                            console.error('Restaurant ID not found');
                        }
                    });
                });
            }
            
            // Load favorite status for related restaurants on page load
            function loadFavoriteStatuses() {
                const favoriteButtons = document.querySelectorAll('.restaurant-card-favorite[data-restaurant-id]');
                if (favoriteButtons.length === 0) {
                    console.log('No favorite buttons found');
                    return;
                }
                
                console.log('Loading favorite statuses for ' + favoriteButtons.length + ' restaurants');
                
                // Call API to get favorited restaurant IDs
                fetch('/customer/favorites/ids')
                    .then(response => {
                        if (!response.ok) {
                            console.log('User not authenticated or error loading favorites (status: ' + response.status + ')');
                            return [];
                        }
                        return response.json();
                    })
                    .then(favoritedIds => {
                        console.log('Favorited restaurant IDs:', favoritedIds);
                        
                        // Update UI for each button
                        favoriteButtons.forEach(button => {
                            const restaurantId = parseInt(button.getAttribute('data-restaurant-id'));
                            const icon = button.querySelector('i');
                            
                            if (favoritedIds && favoritedIds.includes(restaurantId)) {
                                button.classList.add('active');
                                icon.classList.remove('far');
                                icon.classList.add('fas');
                                icon.style.color = '#E60023';
                                console.log('Restaurant ' + restaurantId + ' is favorited');
                            } else {
                                button.classList.remove('active');
                                icon.classList.remove('fas');
                                icon.classList.add('far');
                                icon.style.color = '';
                                console.log('Restaurant ' + restaurantId + ' is NOT favorited');
                            }
                        });
                    })
                    .catch(error => {
                        console.log('Error loading favorite statuses:', error);
                    });
            }
            
            // Favorite toggle function
            window.toggleFavorite = function(button, restaurantId) {
                const icon = button.querySelector('i');
                const wasFavorited = button.classList.contains('active');
                
                console.log('Toggle favorite for restaurant ' + restaurantId + ', current state: ' + (wasFavorited ? 'favorited' : 'not favorited'));
                
                // Disable button during request
                button.disabled = true;
                button.style.opacity = '0.6';
                
                // Toggle favorite via API (handle authentication in backend)
                fetch('/customer/favorites/toggle', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ restaurantId: restaurantId })
                })
                .then(response => {
                    console.log('Toggle response status:', response.status);
                    console.log('Toggle response headers:', response.headers);
                    
                    if (response.status === 401 || response.status === 403) {
                        // Not authenticated - redirect to login
                        button.disabled = false;
                        button.style.opacity = '1';
                        if (confirm('Bạn cần đăng nhập để thêm vào danh sách yêu thích. Bạn có muốn đăng nhập không?')) {
                            window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
                        }
                        return null;
                    }
                    
                    if (!response.ok) {
                        // Try to get error message
                        return response.text().then(text => {
                            console.error('Error response body:', text);
                            try {
                                return JSON.parse(text);
                            } catch {
                                throw new Error('Failed to toggle favorite: ' + response.status + ' - ' + text);
                            }
                        });
                    }
                    
                    return response.json().then(data => {
                        console.log('Parsed JSON response:', data);
                        return data;
                    }).catch(err => {
                        console.error('Error parsing JSON:', err);
                        return response.text().then(text => {
                            console.error('Response text:', text);
                            throw new Error('Invalid JSON response: ' + text);
                        });
                    });
                })
                .then(data => {
                    button.disabled = false;
                    button.style.opacity = '1';
                    
                    if (!data) return; // Not authenticated, already handled
                    
                    console.log('Toggle response data:', JSON.stringify(data));
                    
                    // Check if response has success property
                    if (data.success === false || (data.success === undefined && data.message)) {
                        // Show error message
                        console.error('Toggle favorite failed:', data.message);
                        showFavoriteNotification(data.message || 'Có lỗi xảy ra', 'error');
                        return;
                    }
                    
                    if (data.success === true || data.isFavorited !== undefined) {
                        // Update UI based on server response
                        const icon = button.querySelector('i');
                        
                        if (data.isFavorited === true) {
                            // Now favorited
                            console.log('Setting restaurant as favorited');
                            button.classList.add('active');
                            icon.classList.remove('far');
                            icon.classList.add('fas');
                            icon.style.color = '#E60023';
                            
                            // Only show message if state changed
                            if (!wasFavorited) {
                                showFavoriteNotification('Đã thêm vào danh sách yêu thích', 'success');
                            }
                        } else if (data.isFavorited === false) {
                            // Now not favorited
                            console.log('Setting restaurant as NOT favorited');
                            button.classList.remove('active');
                            icon.classList.remove('fas');
                            icon.classList.add('far');
                            icon.style.color = '';
                            
                            // Only show message if state changed
                            if (wasFavorited) {
                                showFavoriteNotification('Đã xóa khỏi danh sách yêu thích', 'info');
                            }
                        } else {
                            console.error('Unexpected isFavorited value:', data.isFavorited);
                        }
                    } else {
                        console.error('Unexpected response format:', data);
                        showFavoriteNotification('Phản hồi không hợp lệ từ server', 'error');
                    }
                })
                .catch(error => {
                    button.disabled = false;
                    button.style.opacity = '1';
                    console.error('Error toggling favorite:', error);
                    showFavoriteNotification('Có lỗi xảy ra khi cập nhật yêu thích', 'error');
                });
            };
            
            // Show notification (optional - you can customize this)
            function showFavoriteNotification(message, type) {
                // Simple notification - you can replace with a toast library
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${type === 'error' ? '#FEE2E2' : type === 'success' ? '#D1FAE5' : '#DBEAFE'};
                    color: ${type === 'error' ? '#991B1B' : type === 'success' ? '#065F46' : '#1E40AF'};
                    padding: 12px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 10000;
                    font-size: 14px;
                    animation: slideInRight 0.3s ease;
                `;
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'slideOutRight 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
            
            // Setup main restaurant favorite button
            function setupMainRestaurantFavorite() {
                const mainFavoriteBtn = document.getElementById('mainRestaurantFavorite');
                if (!mainFavoriteBtn) return;
                
                // Remove existing listeners by cloning
                const newButton = mainFavoriteBtn.cloneNode(true);
                mainFavoriteBtn.parentNode.replaceChild(newButton, mainFavoriteBtn);
                
                // Add click event listener
                newButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const restaurantId = parseInt(this.getAttribute('data-restaurant-id'));
                    console.log('Main restaurant favorite button clicked for restaurant:', restaurantId);
                    
                    if (restaurantId) {
                        toggleMainRestaurantFavorite(this, restaurantId);
                    } else {
                        console.error('Restaurant ID not found');
                    }
                });
            }
            
            // Load favorite status for main restaurant
            function loadMainRestaurantFavorite() {
                const mainFavoriteBtn = document.getElementById('mainRestaurantFavorite');
                if (!mainFavoriteBtn) return;
                
                const restaurantId = parseInt(mainFavoriteBtn.getAttribute('data-restaurant-id'));
                if (!restaurantId) return;
                
                fetch('/customer/favorites/ids')
                    .then(response => {
                        if (!response.ok) {
                            console.log('User not authenticated or error loading favorites');
                            return [];
                        }
                        return response.json();
                    })
                    .then(favoritedIds => {
                        const icon = mainFavoriteBtn.querySelector('i');
                        if (favoritedIds && favoritedIds.includes(restaurantId)) {
                            mainFavoriteBtn.classList.add('active');
                            icon.classList.remove('far');
                            icon.classList.add('fas');
                            console.log('Main restaurant ' + restaurantId + ' is favorited');
                        } else {
                            mainFavoriteBtn.classList.remove('active');
                            icon.classList.remove('fas');
                            icon.classList.add('far');
                            console.log('Main restaurant ' + restaurantId + ' is NOT favorited');
                        }
                    })
                    .catch(error => {
                        console.log('Error loading main restaurant favorite:', error);
                    });
            }
            
            // Toggle favorite for main restaurant
            window.toggleMainRestaurantFavorite = function(button, restaurantId) {
                const icon = button.querySelector('i');
                const wasFavorited = button.classList.contains('active');
                
                console.log('Toggle main restaurant favorite for ' + restaurantId + ', current state: ' + (wasFavorited ? 'favorited' : 'not favorited'));
                
                // Disable button during request
                button.disabled = true;
                button.style.opacity = '0.6';
                
                // Optimistic update
                if (wasFavorited) {
                    button.classList.remove('active');
                    icon.classList.remove('fas');
                    icon.classList.add('far');
                } else {
                    button.classList.add('active');
                    icon.classList.remove('far');
                    icon.classList.add('fas');
                    button.classList.add('animating');
                }
                
                fetch('/customer/favorites/toggle', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ restaurantId: restaurantId })
                })
                .then(response => {
                    if (response.status === 401 || response.status === 403) {
                        button.disabled = false;
                        button.style.opacity = '1';
                        if (confirm('Bạn cần đăng nhập để thêm vào danh sách yêu thích. Bạn có muốn đăng nhập không?')) {
                            window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
                        }
                        // Rollback UI
                        if (wasFavorited) {
                            button.classList.add('active');
                            icon.classList.remove('far');
                            icon.classList.add('fas');
                        } else {
                            button.classList.remove('active');
                            icon.classList.remove('fas');
                            icon.classList.add('far');
                        }
                        return null;
                    }
                    
                    if (!response.ok) {
                        throw new Error('Failed to toggle favorite: ' + response.status);
                    }
                    
                    return response.json();
                })
                .then(data => {
                    button.disabled = false;
                    button.style.opacity = '1';
                    button.classList.remove('animating');
                    
                    if (!data) return;
                    
                    console.log('Toggle main restaurant favorite response:', data);
                    
                    if (data.success) {
                        if (data.isFavorited === true) {
                            button.classList.add('active');
                            icon.classList.remove('far');
                            icon.classList.add('fas');
                            if (!wasFavorited) {
                                showFavoriteNotification('Đã thêm vào danh sách yêu thích', 'success');
                            }
                        } else if (data.isFavorited === false) {
                            button.classList.remove('active');
                            icon.classList.remove('fas');
                            icon.classList.add('far');
                            if (wasFavorited) {
                                showFavoriteNotification('Đã xóa khỏi danh sách yêu thích', 'info');
                            }
                        }
                    } else {
                        // Rollback on error
                        if (wasFavorited) {
                            button.classList.add('active');
                            icon.classList.remove('far');
                            icon.classList.add('fas');
                        } else {
                            button.classList.remove('active');
                            icon.classList.remove('fas');
                            icon.classList.add('far');
                        }
                        showFavoriteNotification(data.message || 'Có lỗi xảy ra', 'error');
                    }
                })
                .catch(error => {
                    button.disabled = false;
                    button.style.opacity = '1';
                    button.classList.remove('animating');
                    console.error('Error toggling main restaurant favorite:', error);
                    // Rollback on error
                    if (wasFavorited) {
                        button.classList.add('active');
                        icon.classList.remove('far');
                        icon.classList.add('fas');
                    } else {
                        button.classList.remove('active');
                        icon.classList.remove('fas');
                        icon.classList.add('far');
                    }
                    showFavoriteNotification('Có lỗi xảy ra khi cập nhật yêu thích', 'error');
                });
            };
            
            // Load favorite statuses on page load
            // Check if DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    // Wait a bit for Thymeleaf to render all elements
                    setTimeout(function() {
                        setupFavoriteButtons();
                        setupMainRestaurantFavorite();
                        loadFavoriteStatuses();
                        loadMainRestaurantFavorite();
                    }, 200);
                });
            } else {
                // DOM already loaded
                setTimeout(function() {
                    setupFavoriteButtons();
                    setupMainRestaurantFavorite();
                    loadFavoriteStatuses();
                    loadMainRestaurantFavorite();
                }, 200);
            }
            
            // Related Restaurants Horizontal Scroll
            const relatedGrid = document.getElementById('relatedRestaurantsGrid');
            const prevBtn = document.getElementById('relatedPrevBtn');
            const nextBtn = document.getElementById('relatedNextBtn');
            
            if (relatedGrid && (prevBtn || nextBtn)) {
                // Update navigation buttons state
                function updateRelatedNavButtons() {
                    if (!prevBtn || !nextBtn) return;
                    
                    const scrollLeft = relatedGrid.scrollLeft;
                    const scrollWidth = relatedGrid.scrollWidth;
                    const clientWidth = relatedGrid.clientWidth;
                    
                    prevBtn.disabled = scrollLeft <= 10;
                    nextBtn.disabled = scrollLeft >= scrollWidth - clientWidth - 10;
                }
                
                // Initial state
                updateRelatedNavButtons();
                
                // Update on scroll
                relatedGrid.addEventListener('scroll', updateRelatedNavButtons);
                
                // Update on resize
                window.addEventListener('resize', updateRelatedNavButtons);
            }
            
            // Scroll function
            window.scrollRelatedRestaurants = function(direction) {
                const grid = document.getElementById('relatedRestaurantsGrid');
                if (!grid) return;
                
                const cardWidth = 280 + 24; // card width + gap
                const scrollAmount = cardWidth * 2; // Scroll 2 cards at a time
                
                if (direction === 'left') {
                    grid.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
                } else if (direction === 'right') {
                    grid.scrollBy({ left: scrollAmount, behavior: 'smooth' });
                }
            };
        });
        
        // Function to open chat with restaurant
        async function openChatWithRestaurant(button) {
            const restaurantId = button.getAttribute('data-restaurant-id');
            if (!restaurantId) {
                alert('Không tìm thấy thông tin nhà hàng');
                return;
            }
            
            try {
                // Create or get chat room
                const response = await fetch(`/api/chat/rooms?restaurantId=${restaurantId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        window.location.href = `/login?redirect=${encodeURIComponent(window.location.pathname)}`;
                        return;
                    }
                    throw new Error('Failed to create chat room');
                }
                
                const data = await response.json();
                const roomId = data.roomId;
                
                // Get restaurant name from the page
                const restaurantName = document.querySelector('.section-title')?.textContent || 'Nhà hàng';
                
                // Check if messenger chat widget exists
                if (typeof messengerChatWidget !== 'undefined' && messengerChatWidget) {
                    // Open chat widget
                    messengerChatWidget.openChat();
                    // Open the specific room
                    await messengerChatWidget.openChatRoom(roomId, restaurantName);
                } else {
                    // If widget doesn't exist, redirect to chat page
                    window.location.href = `/customer/chat?roomId=${roomId}`;
                }
            } catch (error) {
                console.error('Error opening chat:', error);
                alert('Không thể mở chat. Vui lòng thử lại sau.');
            }
        }
        
        // Make function globally available
        window.openChatWithRestaurant = openChatWithRestaurant;
    </script>
    
    <!-- Messenger Style Chat Widget -->
    <div id="messenger-chat-widget" class="messenger-chat-widget" sec:authorize="isAuthenticated() and (hasRole('CUSTOMER') or hasRole('customer'))">
        <!-- Chat Toggle Button -->
        <button class="messenger-chat-toggle" id="messengerChatToggle" title="Chat với nhà hàng">
            <i class="fas fa-comments"></i>
            <span class="messenger-chat-pulse"></span>
            <span class="messenger-unread-badge" id="messengerUnreadBadge" style="display: none;">0</span>
        </button>
        
        <!-- Chat Window (Messenger Style) -->
        <div id="messengerChatWindow" class="messenger-chat-window" style="display: none;">
            <!-- Chat Header -->
            <div class="messenger-chat-header">
                <div class="messenger-chat-title">
                    <i class="fas fa-comments"></i>
                    <span>Tin nhắn</span>
                </div>
                <div class="messenger-chat-controls">
                    <button class="messenger-btn-minimize" id="messengerMinimizeBtn" title="Thu nhỏ">
                        <i class="fas fa-minus"></i>
                    </button>
                    <button class="messenger-btn-close" id="messengerCloseBtn" title="Đóng">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <!-- Chat Content -->
            <div class="messenger-chat-content">
                <!-- Rooms List View -->
                <div id="messengerRoomsView" class="messenger-rooms-view">
                    <div class="messenger-rooms-header">
                        <h6>Xem tất cả</h6>
                        <button class="messenger-btn-new-chat" id="messengerNewChatBtn" title="Chat mới">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    
                    <div id="messengerRoomsLoading" class="messenger-loading">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        <span>Đang tải...</span>
                    </div>
                    
                    <div id="messengerRoomsList" class="messenger-rooms-list" style="display: none;">
                        <!-- Rooms will be loaded here -->
                    </div>
                    
                    <div id="messengerRoomsEmpty" class="messenger-empty" style="display: none;">
                        <i class="fas fa-inbox"></i>
                        <p>Chưa có cuộc trò chuyện nào</p>
                        <a th:href="@{/customer/chat}" class="messenger-btn-link">Bắt đầu chat mới</a>
                    </div>
                </div>
                
                <!-- Chat Interface View -->
                <div id="messengerChatView" class="messenger-chat-view" style="display: none;">
                    <div class="messenger-chat-view-header">
                        <button class="messenger-btn-back" id="messengerBackBtn">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="messenger-chat-info">
                            <h6 id="messengerChatRoomName">Nhà hàng</h6>
                            <small id="messengerChatStatus">Đang online</small>
                        </div>
                    </div>
                    
                    <div id="messengerMessagesContainer" class="messenger-messages-container">
                        <!-- Messages will be loaded here -->
                    </div>
                    
                    <div id="messengerTypingIndicator" class="messenger-typing-indicator" style="display: none;">
                        <div class="messenger-typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                        <span>Đang gõ...</span>
                    </div>
                    
                    <div class="messenger-message-input">
                        <input type="text" id="messengerMessageInput" class="messenger-input" 
                               placeholder="Nhập tin nhắn..." maxlength="1000">
                        <button id="messengerSendBtn" class="messenger-btn-send" title="Gửi">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Messenger Chat Widget CSS -->
    <style>
        /* Messenger Style Chat Widget */
        .messenger-chat-widget {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 1000;
            font-family: 'Inter', sans-serif;
        }

        .messenger-chat-toggle {
            width: 60px;
            height: 60px;
            background: #FFFFFF;
            border: 2px solid #000000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            position: relative;
            padding: 0;
        }

        .messenger-chat-toggle:hover {
            transform: scale(1.1);
            background: #000000;
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.5);
        }

        .messenger-chat-toggle:hover i {
            color: #FFFFFF;
        }

        .messenger-chat-toggle i {
            font-size: 24px;
            color: #000000;
            z-index: 2;
            transition: color 0.3s;
        }

        .messenger-chat-pulse {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.3);
            animation: pulse-ring 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .messenger-unread-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #000000;
            color: #FFFFFF;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 11px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3;
            border: 2px solid #FFFFFF;
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }

        /* Messenger Chat Window */
        .messenger-chat-window {
            position: absolute;
            bottom: 0;
            right: 70px;
            width: 380px;
            height: 600px;
            background: #FFFFFF;
            border: 2px solid #000000;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .messenger-chat-header {
            background: #FFFFFF;
            border-bottom: 2px solid #000000;
            color: #000000;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .messenger-chat-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 16px;
        }

        .messenger-chat-controls {
            display: flex;
            gap: 8px;
        }

        .messenger-btn-minimize,
        .messenger-btn-close {
            background: #FFFFFF;
            border: 2px solid #000000;
            color: #000000;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .messenger-btn-minimize:hover,
        .messenger-btn-close:hover {
            background: #000000;
            color: #FFFFFF;
        }

        .messenger-chat-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Rooms View */
        .messenger-rooms-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .messenger-rooms-header {
            padding: 16px 20px;
            border-bottom: 2px solid #000000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .messenger-rooms-header h6 {
            margin: 0;
            font-weight: 600;
            font-size: 16px;
            color: #111827;
        }

        .messenger-btn-new-chat {
            background: #000000;
            border: 2px solid #000000;
            color: #FFFFFF;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .messenger-btn-new-chat:hover {
            background: #FFFFFF;
            color: #000000;
        }

        .messenger-loading,
        .messenger-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
        }

        .messenger-loading {
            gap: 12px;
        }

        .messenger-empty i {
            font-size: 48px;
            color: #9CA3AF;
            margin-bottom: 16px;
        }

        .messenger-empty p {
            color: #6B7280;
            margin-bottom: 16px;
        }

        .messenger-btn-link {
            color: #000000;
            text-decoration: none;
            font-weight: 500;
            border-bottom: 1px solid #000000;
        }

        .messenger-btn-link:hover {
            border-bottom: 2px solid #000000;
        }

        .messenger-rooms-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
        }

        .messenger-room-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid #E5E7EB;
        }

        .messenger-room-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .messenger-room-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #FFFFFF;
            border: 2px solid #000000;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .messenger-room-avatar i {
            color: #000000;
            font-size: 20px;
        }

        .messenger-room-info {
            flex: 1;
            min-width: 0;
        }

        .messenger-room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .messenger-room-name {
            font-weight: 600;
            font-size: 15px;
            color: #111827;
            margin: 0;
        }

        .messenger-room-time {
            font-size: 12px;
            color: #6B7280;
            white-space: nowrap;
        }

        .messenger-room-message {
            font-size: 14px;
            color: #6B7280;
            margin: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .messenger-room-unread {
            background: #000000;
            color: #FFFFFF;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: 600;
            min-width: 18px;
            text-align: center;
            margin-left: 8px;
        }

        /* Chat View */
        .messenger-chat-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .messenger-chat-view-header {
            padding: 12px 16px;
            border-bottom: 2px solid #000000;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .messenger-btn-back {
            background: #FFFFFF;
            border: 2px solid #000000;
            color: #000000;
            font-size: 18px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .messenger-btn-back:hover {
            background: #000000;
            color: #FFFFFF;
        }

        .messenger-chat-info h6 {
            margin: 0;
            font-weight: 600;
            font-size: 15px;
            color: #111827;
        }

        .messenger-chat-info small {
            color: #6B7280;
            font-size: 12px;
        }

        .messenger-messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: #FFFFFF;
        }

        .messenger-message-item {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            max-width: 75%;
        }

        .messenger-message-item.own-message {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .messenger-message-content {
            background: #FFFFFF;
            border: 2px solid #000000;
            border-radius: 18px;
            padding: 8px 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .messenger-message-item.own-message .messenger-message-content {
            background: #000000;
            border: 2px solid #000000;
            color: #FFFFFF;
        }

        .messenger-message-text {
            font-size: 14px;
            line-height: 1.4;
            color: #111827;
            margin: 0;
        }

        .messenger-message-item.own-message .messenger-message-text {
            color: white;
        }

        .messenger-message-time {
            font-size: 11px;
            color: #9CA3AF;
            margin-top: 4px;
        }

        .messenger-message-item.own-message .messenger-message-time {
            color: rgba(255, 255, 255, 0.8);
        }

        .messenger-typing-indicator {
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .messenger-typing-dots {
            display: flex;
            gap: 4px;
        }

        .messenger-typing-dots span {
            width: 8px;
            height: 8px;
            background: #9CA3AF;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .messenger-typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .messenger-typing-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        .messenger-message-input {
            padding: 12px 16px;
            border-top: 2px solid #000000;
            display: flex;
            gap: 8px;
            align-items: center;
            background: #FFFFFF;
        }

        .messenger-input {
            flex: 1;
            border: 2px solid #000000;
            border-radius: 20px;
            padding: 10px 16px;
            font-size: 14px;
            outline: none;
            background: #FFFFFF;
            color: #000000;
        }

        .messenger-input:focus {
            border-color: #000000;
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.2);
        }

        .messenger-btn-send {
            background: #000000;
            border: 2px solid #000000;
            color: #FFFFFF;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .messenger-btn-send:hover {
            background: #FFFFFF;
            color: #000000;
        }

        .messenger-btn-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .messenger-chat-widget {
                bottom: 16px;
                right: 16px;
            }

            .messenger-chat-toggle {
                width: 56px;
                height: 56px;
            }

            .messenger-chat-toggle i {
                font-size: 22px;
            }

            .messenger-chat-window {
                width: calc(100vw - 32px);
                height: calc(100vh - 100px);
                bottom: 0;
                right: 70px;
                left: auto;
                max-width: 100%;
            }

            .messenger-room-item {
                padding: 12px 16px;
            }

            .messenger-room-avatar {
                width: 40px;
                height: 40px;
                margin-right: 10px;
            }

            .messenger-message-item {
                max-width: 85%;
            }
        }
    </style>
    
    <!-- WebSocket Libraries for Chat -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    
    <!-- Messenger Chat Widget JavaScript -->
    <script>
        // Messenger Chat Widget
        class MessengerChatWidget {
            constructor() {
                this.socket = null;
                this.stompClient = null;
                this.currentRoomId = null;
                this.currentUserId = null;
                this.isConnected = false;
                this.isMinimized = false;
                this.typingTimer = null;
                
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                this.loadUnreadCount();
                this.initWebSocket();
            }
            
            setupEventListeners() {
                const toggleBtn = document.getElementById('messengerChatToggle');
                const minimizeBtn = document.getElementById('messengerMinimizeBtn');
                const closeBtn = document.getElementById('messengerCloseBtn');
                const backBtn = document.getElementById('messengerBackBtn');
                const sendBtn = document.getElementById('messengerSendBtn');
                const messageInput = document.getElementById('messengerMessageInput');
                const newChatBtn = document.getElementById('messengerNewChatBtn');
                
                if (toggleBtn) {
                    toggleBtn.addEventListener('click', () => this.toggleChat());
                }
                
                if (minimizeBtn) {
                    minimizeBtn.addEventListener('click', () => this.minimizeChat());
                }
                
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => this.closeChat());
                }
                
                if (backBtn) {
                    backBtn.addEventListener('click', () => this.backToRooms());
                }
                
                if (sendBtn) {
                    sendBtn.addEventListener('click', () => this.sendMessage());
                }
                
                if (messageInput) {
                    messageInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            this.sendMessage();
                        }
                    });
                    
                    messageInput.addEventListener('input', () => {
                        this.handleTyping();
                    });
                }
                
                if (newChatBtn) {
                    newChatBtn.addEventListener('click', () => {
                        window.location.href = '/customer/chat';
                    });
                }
            }
            
            toggleChat() {
                const window = document.getElementById('messengerChatWindow');
                if (window.style.display === 'none') {
                    this.openChat();
                } else {
                    this.closeChat();
                }
            }
            
            openChat() {
                const window = document.getElementById('messengerChatWindow');
                window.style.display = 'flex';
                this.isMinimized = false;
                this.loadChatRooms();
            }
            
            minimizeChat() {
                const window = document.getElementById('messengerChatWindow');
                window.style.display = 'none';
                this.isMinimized = true;
            }
            
            closeChat() {
                const window = document.getElementById('messengerChatWindow');
                window.style.display = 'none';
                this.currentRoomId = null;
                this.showRoomsView();
            }
            
            async loadChatRooms() {
                const loadingEl = document.getElementById('messengerRoomsLoading');
                const listEl = document.getElementById('messengerRoomsList');
                const emptyEl = document.getElementById('messengerRoomsEmpty');
                
                loadingEl.style.display = 'flex';
                listEl.style.display = 'none';
                emptyEl.style.display = 'none';
                
                try {
                    const response = await fetch('/api/chat/rooms');
                    if (!response.ok) throw new Error('Failed to load rooms');
                    
                    const rooms = await response.json();
                    loadingEl.style.display = 'none';
                    
                    if (rooms && rooms.length > 0) {
                        this.displayRooms(rooms);
                        listEl.style.display = 'block';
                    } else {
                        // Vẫn hiển thị AI Chat Assistant ngay cả khi không có room nào
                        this.displayRooms([]);
                        listEl.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error loading rooms:', error);
                    loadingEl.style.display = 'none';
                    // Vẫn hiển thị AI Chat Assistant khi có lỗi
                    this.displayRooms([]);
                    listEl.style.display = 'block';
                }
            }
            
            displayRooms(rooms) {
                const listEl = document.getElementById('messengerRoomsList');
                listEl.innerHTML = '';
                
                // Thêm AI Chat Assistant ở đầu danh sách (luôn luôn đầu tiên)
                const aiChatRoom = this.createAIChatRoom();
                listEl.appendChild(aiChatRoom);
                
                // Sắp xếp các room restaurant theo thời gian tin nhắn cuối cùng (mới nhất trước)
                const sortedRooms = [...rooms].sort((a, b) => {
                    const aTime = a.lastMessageAt ? new Date(a.lastMessageAt).getTime() : 0;
                    const bTime = b.lastMessageAt ? new Date(b.lastMessageAt).getTime() : 0;
                    return bTime - aTime; // Mới nhất trước
                });
                
                sortedRooms.forEach(room => {
                    const roomItem = this.createRoomItem(room);
                    listEl.appendChild(roomItem);
                });
            }
            
            createAIChatRoom() {
                const item = document.createElement('div');
                item.className = 'messenger-room-item';
                item.setAttribute('data-ai-chat', 'true');
                item.addEventListener('click', () => this.openAIChat());
                
                const avatar = document.createElement('div');
                avatar.className = 'messenger-room-avatar';
                avatar.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                avatar.innerHTML = '<i class="fas fa-robot"></i>';
                
                const info = document.createElement('div');
                info.className = 'messenger-room-info';
                
                const header = document.createElement('div');
                header.className = 'messenger-room-header';
                
                const name = document.createElement('h6');
                name.className = 'messenger-room-name';
                name.textContent = 'Trợ Lý AI';
                
                const status = document.createElement('span');
                status.className = 'messenger-room-time';
                status.textContent = 'Luôn sẵn sàng';
                status.style.color = '#4CAF50';
                
                header.appendChild(name);
                header.appendChild(status);
                
                const message = document.createElement('p');
                message.className = 'messenger-room-message';
                message.textContent = 'Chào bạn! Tôi có thể giúp gì cho bạn?';
                
                info.appendChild(header);
                info.appendChild(message);
                
                item.appendChild(avatar);
                item.appendChild(info);
                
                return item;
            }
            
            async openAIChat() {
                this.currentRoomId = 'AI_CHAT';
                this.showChatView('Trợ Lý AI');
                
                // Load AI chat messages từ localStorage hoặc tạo mới
                const aiMessages = this.getAIChatMessages();
                this.displayAIMessages(aiMessages);
                
                // Focus vào input
                const messageInput = document.getElementById('messengerMessageInput');
                if (messageInput) {
                    messageInput.focus();
                }
            }
            
            getAIChatMessages() {
                const stored = localStorage.getItem('ai_chat_messages');
                if (stored) {
                    try {
                        return JSON.parse(stored);
                    } catch (e) {
                        return [];
                    }
                }
                return [];
            }
            
            saveAIChatMessages(messages) {
                localStorage.setItem('ai_chat_messages', JSON.stringify(messages));
            }
            
            displayAIMessages(messages) {
                const container = document.getElementById('messengerMessagesContainer');
                container.innerHTML = '';
                
                if (messages.length === 0) {
                    // Tin nhắn chào mừng mặc định
                    const welcomeMsg = {
                        content: 'Xin chào! Tôi là Trợ Lý AI của Book Eat. Tôi có thể giúp bạn tìm nhà hàng, đặt bàn và trả lời các câu hỏi về dịch vụ. Bạn cần hỗ trợ gì?',
                        senderId: 'AI',
                        senderName: 'Trợ Lý AI',
                        sentAt: new Date().toISOString()
                    };
                    messages = [welcomeMsg];
                }
                
                messages.forEach(message => {
                    const messageEl = this.createMessageElement(message);
                    container.appendChild(messageEl);
                });
                
                this.scrollToBottom();
            }
            
            createRoomItem(room) {
                const item = document.createElement('div');
                item.className = 'messenger-room-item';
                item.addEventListener('click', () => this.openChatRoom(room.roomId, room.restaurantName));
                
                const avatar = document.createElement('div');
                avatar.className = 'messenger-room-avatar';
                avatar.innerHTML = '<i class="fas fa-store"></i>';
                
                const info = document.createElement('div');
                info.className = 'messenger-room-info';
                
                const header = document.createElement('div');
                header.className = 'messenger-room-header';
                
                const name = document.createElement('h6');
                name.className = 'messenger-room-name';
                name.textContent = room.restaurantName || 'Nhà hàng';
                
                const time = document.createElement('span');
                time.className = 'messenger-room-time';
                if (room.lastMessageAt) {
                    time.textContent = this.formatTime(room.lastMessageAt);
                }
                
                header.appendChild(name);
                if (room.lastMessageAt) header.appendChild(time);
                
                if (room.unreadCount && room.unreadCount > 0) {
                    const badge = document.createElement('span');
                    badge.className = 'messenger-room-unread';
                    badge.textContent = room.unreadCount > 99 ? '99+' : room.unreadCount;
                    header.appendChild(badge);
                }
                
                const message = document.createElement('p');
                message.className = 'messenger-room-message';
                message.textContent = room.lastMessage || 'Chưa có tin nhắn';
                
                info.appendChild(header);
                info.appendChild(message);
                
                item.appendChild(avatar);
                item.appendChild(info);
                
                return item;
            }
            
            async openChatRoom(roomId, roomName) {
                this.currentRoomId = roomId;
                this.showChatView(roomName);
                await this.loadMessages(roomId);
                await this.markMessagesAsRead(roomId);
                this.joinRoom(roomId);
            }
            
            showChatView(roomName) {
                document.getElementById('messengerRoomsView').style.display = 'none';
                document.getElementById('messengerChatView').style.display = 'flex';
                document.getElementById('messengerChatRoomName').textContent = roomName || 'Nhà hàng';
            }
            
            showRoomsView() {
                document.getElementById('messengerRoomsView').style.display = 'flex';
                document.getElementById('messengerChatView').style.display = 'none';
                this.currentRoomId = null;
            }
            
            backToRooms() {
                this.showRoomsView();
                this.loadChatRooms();
            }
            
            async loadMessages(roomId) {
                try {
                    const response = await fetch(`/api/chat/rooms/${roomId}/messages?page=0&size=50`);
                    if (response.ok) {
                        const messages = await response.json();
                        this.displayMessages(messages);
                    }
                } catch (error) {
                    console.error('Error loading messages:', error);
                }
            }
            
            displayMessages(messages) {
                const container = document.getElementById('messengerMessagesContainer');
                container.innerHTML = '';
                
                messages.forEach(message => {
                    const messageEl = this.createMessageElement(message);
                    container.appendChild(messageEl);
                });
                
                this.scrollToBottom();
            }
            
            createMessageElement(message) {
                const item = document.createElement('div');
                item.className = 'messenger-message-item';
                
                // Kiểm tra nếu là tin nhắn của user hoặc AI
                if (message.senderId === this.currentUserId || message.senderId === this.currentUserId?.toString()) {
                    item.classList.add('own-message');
                } else if (message.senderId === 'AI' || message.senderName === 'Trợ Lý AI') {
                    // Tin nhắn từ AI - không thêm own-message class
                    item.setAttribute('data-ai-message', 'true');
                }
                
                const content = document.createElement('div');
                content.className = 'messenger-message-content';
                
                const text = document.createElement('p');
                text.className = 'messenger-message-text';
                text.textContent = message.content || '';
                
                const time = document.createElement('div');
                time.className = 'messenger-message-time';
                time.textContent = this.formatTime(message.sentAt);
                
                content.appendChild(text);
                content.appendChild(time);
                item.appendChild(content);
                
                return item;
            }
            
            async sendMessage() {
                const input = document.getElementById('messengerMessageInput');
                const content = input.value.trim();
                
                if (!content) return;
                
                // Xử lý riêng cho AI Chat
                if (this.currentRoomId === 'AI_CHAT') {
                    await this.sendAIMessage(content);
                    input.value = '';
                    return;
                }
                
                // Xử lý chat với restaurant (WebSocket)
                if (!this.currentRoomId || !this.isConnected) return;
                
                try {
                    this.stompClient.send('/app/chat.sendMessage', {}, JSON.stringify({
                        roomId: this.currentRoomId,
                        content: content
                    }));
                    
                    input.value = '';
                    this.stopTyping();
                } catch (error) {
                    console.error('Error sending message:', error);
                }
            }
            
            async sendAIMessage(content) {
                const container = document.getElementById('messengerMessagesContainer');
                
                // Thêm tin nhắn của user
                const userMessage = {
                    content: content,
                    senderId: this.currentUserId,
                    senderName: 'Bạn',
                    sentAt: new Date().toISOString()
                };
                const userMsgEl = this.createMessageElement(userMessage);
                container.appendChild(userMsgEl);
                this.scrollToBottom();
                
                // Lưu tin nhắn vào localStorage
                const messages = this.getAIChatMessages();
                messages.push(userMessage);
                this.saveAIChatMessages(messages);
                
                // Hiển thị typing indicator
                const typingEl = document.createElement('div');
                typingEl.className = 'messenger-message-item';
                typingEl.id = 'ai-typing-indicator';
                typingEl.innerHTML = '<div class="messenger-message-content"><p class="messenger-message-text">Đang suy nghĩ...</p></div>';
                container.appendChild(typingEl);
                this.scrollToBottom();
                
                try {
                    // Gọi API AI
                    const response = await fetch('/ai/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({
                            message: content,
                            context: 'messenger_chat'
                        })
                    });
                    
                    // Xóa typing indicator
                    const typingIndicator = document.getElementById('ai-typing-indicator');
                    if (typingIndicator) {
                        typingIndicator.remove();
                    }
                    
                    if (response.ok) {
                        const data = await response.json();
                        const aiResponse = data.response || 'Xin lỗi, tôi không thể trả lời câu hỏi này. Vui lòng thử lại.';
                        
                        // Thêm tin nhắn của AI
                        const aiMessage = {
                            content: aiResponse,
                            senderId: 'AI',
                            senderName: 'Trợ Lý AI',
                            sentAt: new Date().toISOString()
                        };
                        const aiMsgEl = this.createMessageElement(aiMessage);
                        container.appendChild(aiMsgEl);
                        this.scrollToBottom();
                        
                        // Lưu tin nhắn vào localStorage
                        messages.push(aiMessage);
                        this.saveAIChatMessages(messages);
                    } else {
                        throw new Error('AI API error');
                    }
                } catch (error) {
                    console.error('Error sending AI message:', error);
                    
                    // Xóa typing indicator
                    const typingIndicator = document.getElementById('ai-typing-indicator');
                    if (typingIndicator) {
                        typingIndicator.remove();
                    }
                    
                    // Hiển thị lỗi
                    const errorMessage = {
                        content: 'Xin lỗi, có lỗi xảy ra. Vui lòng thử lại sau.',
                        senderId: 'AI',
                        senderName: 'Trợ Lý AI',
                        sentAt: new Date().toISOString()
                    };
                    const errorMsgEl = this.createMessageElement(errorMessage);
                    container.appendChild(errorMsgEl);
                    this.scrollToBottom();
                }
            }
            
            handleIncomingMessage(data) {
                if (!data || !data.messageId || !data.content) return;
                
                if (data.roomId === this.currentRoomId) {
                    const messageEl = this.createMessageElement(data);
                    document.getElementById('messengerMessagesContainer').appendChild(messageEl);
                    this.scrollToBottom();
                }
                
                this.loadChatRooms();
                this.loadUnreadCount();
            }
            
            handleTyping() {
                if (!this.currentRoomId || !this.isConnected) return;
                
                this.stompClient.send('/app/chat.typing', {}, JSON.stringify({
                    roomId: this.currentRoomId,
                    typing: true
                }));
                
                if (this.typingTimer) clearTimeout(this.typingTimer);
                this.typingTimer = setTimeout(() => this.stopTyping(), 1000);
            }
            
            stopTyping() {
                if (!this.currentRoomId || !this.isConnected) return;
                
                this.stompClient.send('/app/chat.typing', {}, JSON.stringify({
                    roomId: this.currentRoomId,
                    typing: false
                }));
                
                if (this.typingTimer) {
                    clearTimeout(this.typingTimer);
                    this.typingTimer = null;
                }
            }
            
            initWebSocket() {
                try {
                    this.socket = new SockJS('/ws');
                    this.stompClient = Stomp.over(this.socket);
                    
                    this.stompClient.connect({}, (frame) => {
                        this.isConnected = true;
                        this.subscribeToMessages();
                    }, (error) => {
                        console.error('WebSocket error:', error);
                        this.isConnected = false;
                    });
                } catch (error) {
                    console.error('Failed to init WebSocket:', error);
                }
            }
            
            subscribeToMessages() {
                if (!this.isConnected) return;
                
                this.stompClient.subscribe('/topic/room/*', (message) => {
                    const data = JSON.parse(message.body);
                    this.handleIncomingMessage(data);
                });
            }
            
            joinRoom(roomId) {
                if (!this.isConnected) return;
                this.stompClient.send('/app/chat.joinRoom', {}, JSON.stringify({ roomId }));
            }
            
            async markMessagesAsRead(roomId) {
                try {
                    await fetch(`/api/chat/rooms/${roomId}/read`, { method: 'POST' });
                } catch (error) {
                    console.error('Error marking as read:', error);
                }
            }
            
            async loadUnreadCount() {
                try {
                    const response = await fetch('/api/chat/unread-count');
                    if (response.ok) {
                        const data = await response.json();
                        const badge = document.getElementById('messengerUnreadBadge');
                        if (badge) {
                            if (data.unreadCount > 0) {
                                badge.textContent = data.unreadCount > 99 ? '99+' : data.unreadCount;
                                badge.style.display = 'flex';
                            } else {
                                badge.style.display = 'none';
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error loading unread count:', error);
                }
            }
            
            scrollToBottom() {
                const container = document.getElementById('messengerMessagesContainer');
                container.scrollTop = container.scrollHeight;
            }
            
            formatTime(dateTimeString) {
                if (!dateTimeString) return '';
                const date = new Date(dateTimeString);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);
                
                if (diffMins < 1) return 'Vừa xong';
                if (diffMins < 60) return `${diffMins} phút trước`;
                if (diffHours < 24) return `${diffHours} giờ trước`;
                if (diffDays < 7) return `${diffDays} ngày trước`;
                return date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' });
            }
        }
        
        // Initialize Messenger Chat Widget
        let messengerChatWidget;
        document.addEventListener('DOMContentLoaded', function() {
            // Load user info for chat
            fetch('/api/user/current')
                .then(response => response.json())
                .then(user => {
                    messengerChatWidget = new MessengerChatWidget();
                    messengerChatWidget.currentUserId = user.id;
                })
                .catch(error => {
                    console.error('Error loading user info:', error);
                    messengerChatWidget = new MessengerChatWidget();
                });
        });
    </script>
</body>
</html>
