<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf?.token}">
    <meta name="_csrf_header" th:content="${_csrf?.headerName}">
    <title>Book Eat – Đặt bàn online, giữ chỗ ngay</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Home Resy Style CSS -->
    <link th:href="@{/css/home-resy.css}" rel="stylesheet">
    <!-- Login Modal CSS -->
    <link th:href="@{/css/login-modal.css}" rel="stylesheet">
    <style>
      /* CSS Variables for notification bell */
      :root {
        --border-light: #E8E5D8;
        --background-white: #FFFEF7;
        --primary-blue: #4A90E2;
      }
      
      .nearby-section { display:block; }
      .nearby-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(240px,1fr)); gap:16px; }
      .nearby-card { border:1px solid #eee; border-radius:12px; padding:12px; background:#fff; }
      .nearby-card h4 { font-size:1.05rem; margin:0 0 6px; }
      .nearby-meta { font-size:0.9rem; color:#555; display:flex; gap:8px; align-items:center; }
      .nearby-actions { margin-top:8px; }
      
      /* Notification Bell Styles for Home Page */
      .notification-bell-wrapper {
        display: inline-block;
        margin-right: 12px;
      }
      
      .notification-bell-container {
        position: relative;
      }
      
      .notification-bell__trigger {
        background: none;
        border: none;
        color: #333;
        font-size: 18px;
        padding: 8px;
        border-radius: 6px;
        transition: all 0.2s ease;
      }
      
      .notification-bell__trigger:hover {
        background-color: rgba(0, 0, 0, 0.05);
        color: #007bff;
      }
      
      .notification-bell__badge {
        font-size: 10px;
        min-width: 16px;
        height: 16px;
        line-height: 16px;
        padding: 0 4px;
      }
      
      .notification-bell__menu {
        min-width: 320px;
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #e0e0e0;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        border-radius: 8px;
        background-color: #ffffff !important;
        backdrop-filter: none !important;
      }
      
      .notification-bell__menu .dropdown-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #e0e0e0;
        font-weight: 600;
        color: #333;
      }
      
      /* Make "Thông báo" text larger */
      .notification-bell__menu .dropdown-header .notification-bell__all-link {
        color: #333 !important;
        font-size: 1.25rem !important;
        font-weight: 700 !important;
      }
      
      .notification-bell__menu .dropdown-header .notification-bell__all-link i {
        color: #333 !important;
        font-size: 1.25rem !important;
      }
      
      .notification-bell__menu .dropdown-header .badge.bg-primary {
        background-color: #dc3545 !important;
        color: #fff !important;
      }
      
      /* Remove blue from notification links */
      .notification-bell__menu .notification-bell__link {
        color: #333 !important;
        text-decoration: none !important;
      }
      
      .notification-bell__menu .notification-bell__link:hover {
        color: #333 !important;
      }
      
      .notification-bell__menu .notification-bell__link .fw-bold {
        color: #333 !important;
      }
      
      .notification-bell__menu .notification-bell__link .small {
        color: #666 !important;
      }
      
      /* Remove blue from status dot */
      .notification-bell__menu .notification-bell__status {
        color: #dc3545 !important;
      }
      
      /* Remove blue from empty state icon */
      .notification-bell__menu .fa-bell-slash {
        color: #999 !important;
      }
      
      /* Change "Xem tất cả thông báo" text color to black */
      .notification-bell__menu .notification-bell__view-all {
        color: #000 !important;
      }
      
      .notification-bell__menu .notification-bell__view-all:hover {
        color: #000 !important;
      }
      
      .notification-bell__menu .notification-bell__view-all i {
        color: #000 !important;
      }
      
      /* Enhanced notification item styling with clear separation */
      .notification-bell__list li {
        list-style: none;
        margin: 0.5rem 0.75rem;
        padding: 0;
      }
      
      .notification-bell__link {
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        border-radius: 12px;
        border: 1px solid var(--border-light, #E8E5D8);
        background-color: var(--background-white, #FFFEF7);
        display: block;
        transition: all 0.2s ease;
        margin: 0;
      }
      
      .notification-bell__link:hover {
        background-color: rgba(74, 144, 226, 0.08);
        border-color: var(--primary-blue, #4A90E2);
        box-shadow: 0 2px 8px rgba(74, 144, 226, 0.15);
        transform: translateY(-1px);
      }
      
      .notification-bell__menu .dropdown-item {
        padding: 12px 16px;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s ease;
      }
      
      .notification-bell__menu .dropdown-item:hover {
        background-color: #f8f9fa;
      }
      
      .notification-bell__menu .dropdown-item:last-child {
        border-bottom: none;
      }
      
      /* Override for notification items in list */
      .notification-bell__menu .notification-bell__list li {
        margin: 0.5rem 0.75rem !important;
        padding: 0 !important;
      }
      
      .notification-bell__menu .notification-bell__link {
        border: 1px solid var(--border-light, #E8E5D8) !important;
        border-radius: 12px !important;
        padding: 0.75rem 1rem !important;
        margin: 0 !important;
        background-color: var(--background-white, #FFFEF7) !important;
        transition: all 0.2s ease !important;
      }
      
      .notification-bell__menu .notification-bell__link:hover {
        border-color: var(--primary-blue, #4A90E2) !important;
        box-shadow: 0 2px 8px rgba(74, 144, 226, 0.15) !important;
        transform: translateY(-1px) !important;
        background-color: rgba(74, 144, 226, 0.08) !important;
      }

      /* AI Search styles */
      .ai-search-section {
        padding: 80px 0;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(241, 246, 253, 0.95) 100%);
      }

      .ai-search-wrapper {
        display: flex;
        flex-wrap: wrap;
        gap: 32px;
        align-items: stretch;
      }

      .ai-search-card, .ai-result-card {
        flex: 1 1 360px;
        background: #fff;
        border-radius: 20px;
        box-shadow: 0 18px 45px rgba(16, 36, 94, 0.08);
        padding: 32px 28px;
        position: relative;
        overflow: hidden;
      }

      .ai-search-card::after {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: 20px;
        padding: 1px;
        background: linear-gradient(135deg, rgba(65, 105, 225, 0.35), rgba(65, 105, 225, 0));
        mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
        mask-composite: exclude;
        pointer-events: none;
      }

      .ai-search-heading {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
      }

      .ai-search-heading i {
        font-size: 26px;
        color: #1b4dd8;
      }

      .ai-search-title {
        margin: 0;
        font-size: 1.55rem;
        font-weight: 600;
        color: #1c2a4b;
      }

      .ai-search-subtitle {
        color: #55627a;
        margin-bottom: 24px;
        line-height: 1.5;
      }

      .ai-search-card label {
        display: block;
        font-weight: 600;
        color: #263760;
        margin-bottom: 10px;
      }

      .ai-query-input {
        width: 100%;
        min-height: 120px;
        border-radius: 16px;
        border: 1px solid #c9d5ec;
        padding: 16px 18px;
        resize: vertical;
        font-size: 1rem;
        color: #1c2a4b;
        box-shadow: inset 0 2px 12px rgba(28, 42, 75, 0.06);
        transition: border 0.2s ease, box-shadow 0.2s ease;
      }

      .ai-query-input:focus {
        border-color: #1b4dd8;
        outline: none;
        box-shadow: 0 0 0 3px rgba(27, 77, 216, 0.15);
      }

      .ai-form-footer {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        align-items: center;
        justify-content: space-between;
        margin-top: 20px;
      }

      .ai-max-results {
        display: flex;
        align-items: center;
        gap: 12px;
        background: rgba(27, 77, 216, 0.08);
        padding: 10px 16px;
        border-radius: 999px;
        color: #193166;
      }

      .ai-max-results input {
        width: 70px;
        border: none;
        background: transparent;
        text-align: center;
        font-weight: 600;
        color: inherit;
      }

      .ai-max-results input:focus {
        outline: none;
      }

      .btn-ai-search {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 12px 28px;
        border-radius: 999px;
        border: none;
        background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
        color: #fff;
        font-weight: 600;
        letter-spacing: 0.4px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
      }

      .btn-ai-search:hover {
        transform: translateY(-1px);
        box-shadow: 0 16px 32px rgba(0, 0, 0, 0.5);
        background: linear-gradient(135deg, #1a1a1a 0%, #333333 100%);
      }

      .ai-status {
        margin-top: 16px;
        font-size: 0.95rem;
        color: #314063;
        min-height: 24px;
      }

      .ai-status.error {
        color: #d64045;
      }

      .ai-result-card {
        padding: 32px 30px 28px;
        display: flex;
        flex-direction: column;
      }

      .ai-summary {
        display: flex;
        flex-wrap: wrap;
        gap: 14px;
        align-items: center;
        margin-bottom: 18px;
        color: #1c2a4b;
      }

      .ai-summary strong {
        font-size: 1.2rem;
      }

      .ai-explanation {
        font-style: italic;
        color: #4a618d;
        margin-bottom: 24px;
      }

      .ai-confidence {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: rgba(27, 77, 216, 0.08);
        color: #1b4dd8;
        border-radius: 999px;
        padding: 6px 14px;
        font-weight: 500;
      }

      .ai-recommendations {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
        gap: 16px;
      }

      .ai-recommendation-card {
        border: 1px solid #e5ecfa;
        border-radius: 16px;
        padding: 18px;
        background: #fdfdff;
        display: flex;
        flex-direction: column;
        gap: 8px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .ai-recommendation-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 16px 28px rgba(31, 60, 136, 0.08);
      }

      .ai-rec-header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        gap: 8px;
      }

      .ai-rec-name {
        font-weight: 600;
        font-size: 1.05rem;
        color: #213152;
        margin: 0;
        flex: 1;
      }

      .ai-rec-rating {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        background: rgba(252, 196, 25, 0.16);
        color: #b27a00;
        padding: 4px 8px;
        border-radius: 999px;
        font-size: 0.9rem;
      }

      .ai-rec-meta {
        font-size: 0.92rem;
        color: #4d5f86;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      .ai-rec-actions {
        display: flex;
        gap: 10px;
        margin-top: 8px;
      }

      .ai-rec-actions a {
        flex: 1;
        text-align: center;
        padding: 8px 10px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.92rem;
        text-decoration: none;
      }

      .ai-rec-actions .primary {
        background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
        color: #fff;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }

      .ai-rec-actions .primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        background: linear-gradient(135deg, #1a1a1a 0%, #333333 100%);
      }

      .ai-rec-actions .secondary {
        background: #edf2fe;
        color: #1c2a4b;
      }

      .ai-empty-state {
        border: 1px dashed #c7d4f6;
        border-radius: 16px;
        padding: 24px;
        text-align: center;
        color: #4a618d;
        background: rgba(237, 242, 254, 0.6);
      }

      .ai-loading-spinner {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        color: #1b4dd8;
      }

      .ai-loading-spinner::before {
        content: "";
        width: 16px;
        height: 16px;
        border: 3px solid rgba(27, 77, 216, 0.3);
        border-top-color: #1b4dd8;
        border-radius: 50%;
        animation: ai-spin 0.8s linear infinite;
      }

      @keyframes ai-spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      @media (max-width: 991px) {
        .ai-search-section {
          padding: 60px 0;
        }

        .ai-search-card, .ai-result-card {
          padding: 24px;
        }
      }

      @media (max-width: 575px) {
        .ai-form-footer {
          flex-direction: column;
          align-items: stretch;
        }

        .ai-max-results {
          justify-content: center;
        }
      }
    </style>
    
</head>
<body>
    
    <!-- Customer Header Fragment -->
    <div th:with="activeNav='home'" th:replace="~{fragments/customer-header :: customer-header}"></div>

    <!-- Video Hero Section -->
    <section class="video-hero" id="home">
        <div class="video-background">
            <!-- YouTube Video Embed -->
            <iframe 
                src="https://www.youtube.com/embed/xPPLbEFbCAo?autoplay=1&mute=1&loop=1&playlist=xPPLbEFbCAo&controls=0&showinfo=0&rel=0&modestbranding=1"
                frameborder="0"
                allow="autoplay; encrypted-media"
                allowfullscreen>
            </iframe>
        </div>
        <div class="video-overlay">
            <div class="video-content">
                <h1 class="video-title">Khám phá ẩm thực tại Book Eat</h1>
                <p class="video-subtitle">Đặt bàn tại những nhà hàng tốt nhất với Book Eat</p>
                
                
                <div class="video-buttons">
                    <a th:href="@{/restaurants}" class="btn-video">
                        <i class="fas fa-utensils"></i>
                        Khám phá ngay
                    </a>
                    <a href="#intro" class="btn-video-outline">
                        <i class="fas fa-play"></i>
                        Xem thêm
                    </a>
                </div>
            </div>
        </div>
    </section>

    <!-- AI Recommendation Section -->
    <section class="ai-search-section" id="ai-search">
        <div class="container">
            <div class="ai-search-wrapper">
                <div class="ai-search-card">
                    <div class="ai-search-heading">
                        <i class="fas fa-magic"></i>
                        <h2 class="ai-search-title">Trợ lý AI gợi ý nhà hàng</h2>
                    </div>
                    <p class="ai-search-subtitle">
                        Mô tả mong muốn của bạn và để Book Eat AI đề xuất những lựa chọn phù hợp nhất dựa trên dữ liệu nhà hàng thực tế.
                    </p>
                    <form id="aiSearchForm" novalidate>
                        <div class="mb-3">
                            <label for="aiSearchQuery">Bạn muốn ăn gì hôm nay?</label>
                            <textarea id="aiSearchQuery"
                                      class="ai-query-input"
                                      placeholder="Ví dụ: Tôi muốn ăn phở bò cho 2 người ở quận 1, tầm 150k mỗi người"
                                      minlength="5"
                                      required></textarea>
                        </div>
                        <div class="ai-form-footer">
                            <div class="ai-max-results">
                                <i class="fas fa-list-ol"></i>
                                <span>Số kết quả:</span>
                                <input type="number" id="aiMaxResults" min="1" max="10" value="5" aria-label="Số kết quả mong muốn">
                            </div>
                            <button type="submit" class="btn-ai-search">
                                <i class="fas fa-wand-magic-sparkles"></i>
                                Tìm nhà hàng bằng AI
                            </button>
                        </div>
                        <div class="ai-status" id="aiSearchStatus" role="status" aria-live="polite"></div>
                    </form>
                </div>

                <div class="ai-result-card" id="aiResultsPanel" hidden>
                    <div class="ai-summary" id="aiResultsSummary"></div>
                    <!-- AI Interpretation Box -->
                    <div class="ai-interpretation-box" id="aiInterpretationBox" style="display: none; background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%); border-radius: 15px; padding: 20px; margin: 20px 0; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);">
                        <div style="display: flex; align-items: start; gap: 15px;">
                            <i class="fas fa-lightbulb" style="font-size: 1.8rem; color: #ffd700; margin-top: 5px;"></i>
                            <div style="flex: 1;">
                                <h5 style="color: white; font-weight: 600; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-robot"></i>
                                    Gợi ý của AI
                                </h5>
                                <p id="aiInterpretationText" style="color: white; font-size: 1.1rem; line-height: 1.6; margin-bottom: 0;"></p>
                                <div id="aiSuggestedFoods" style="margin-top: 15px; display: none;">
                                    <small style="color: rgba(255,255,255,0.8); font-weight: 500; display: block; margin-bottom: 8px;">Món ăn được đề xuất:</small>
                                    <div id="aiSuggestedFoodsList" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="ai-explanation" id="aiResultsExplanation"></div>
                    <div class="ai-confidence" id="aiResultsConfidence" hidden>
                        <i class="fas fa-signal"></i>
                        <span></span>
                    </div>
                    <div class="ai-recommendations" id="aiRecommendations"></div>
                    <div class="ai-empty-state" id="aiEmptyState" hidden>
                        <i class="fas fa-info-circle me-2"></i>
                        <span>Chưa tìm thấy nhà hàng phù hợp với yêu cầu này. Bạn có thể thử mô tả cụ thể hơn.</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Intro Section -->
    <section class="intro-section" id="intro">
        <div class="container">
            <div class="intro-container">
                <div class="intro-content">
                    <h2>Nền tảng đặt bàn nhà hàng hàng đầu Việt Nam</h2>
                    <p>
                        Book Eat là giải pháp đặt bàn thông minh, kết nối bạn với hàng ngàn nhà hàng chất lượng cao 
                        trên toàn quốc. Chúng tôi cam kết mang đến trải nghiệm ẩm thực tuyệt vời nhất cho mọi thực khách.
                    </p>
                    <p>
                        Với công nghệ hiện đại và dịch vụ chuyên nghiệp, việc đặt bàn chưa bao giờ dễ dàng đến thế. 
                        Chỉ vài cú click, bạn đã có thể đảm bảo chỗ ngồi tại nhà hàng yêu thích.
                    </p>
                    
                    <div class="intro-features">
                        <div class="intro-feature">
                            <div class="intro-feature-icon">
                                <i class="fas fa-bolt"></i>
                            </div>
                            <div class="intro-feature-text">
                                <h4>Đặt bàn nhanh chóng</h4>
                                <p>Xác nhận tức thì trong vài giây</p>
                            </div>
                        </div>
                        
                        <div class="intro-feature">
                            <div class="intro-feature-icon">
                                <i class="fas fa-shield-alt"></i>
                                </div>
                            <div class="intro-feature-text">
                                <h4>An toàn & Bảo mật</h4>
                                <p>Thông tin được mã hóa bảo mật</p>
                            </div>
                        </div>
                        
                        <div class="intro-feature">
                            <div class="intro-feature-icon">
                                <i class="fas fa-star"></i>
                                </div>
                            <div class="intro-feature-text">
                                <h4>Chất lượng đảm bảo</h4>
                                <p>Nhà hàng được chọn lọc kỹ càng</p>
                            </div>
                        </div>
                        
                        <div class="intro-feature">
                            <div class="intro-feature-icon">
                                <i class="fas fa-headset"></i>
                            </div>
                            <div class="intro-feature-text">
                                <h4>Hỗ trợ 24/7</h4>
                                <p>Luôn sẵn sàng hỗ trợ bạn</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                <div class="intro-image">
                    <!-- YouTube Video Embed -->
                    <iframe 
                        src="https://www.youtube.com/embed/lcU3pruVyUw?autoplay=1&mute=1&loop=1&playlist=lcU3pruVyUw&controls=0&showinfo=0&rel=0&modestbranding=1"
                        frameborder="0"
                        allow="autoplay; encrypted-media"
                        allowfullscreen>
                    </iframe>
                    <div class="intro-video-overlay"></div>
                    <div class="intro-stats">
                        <div class="intro-stat">
                            <span class="intro-stat-number">1,200+</span>
                            <span class="intro-stat-label">Nhà hàng</span>
                        </div>
                        <div class="intro-stat">
                            <span class="intro-stat-number">50K+</span>
                            <span class="intro-stat-label">Khách hàng</span>
                        </div>
                        <div class="intro-stat">
                            <span class="intro-stat-number">4.8</span>
                            <span class="intro-stat-label">Đánh giá</span>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        </section>

    <!-- Recommended Near You (dynamic) - Location feature enabled -->
    <section class="nearby-section" id="nearby">
        <div class="container">
            <div class="section-header">
                <h2 class="section-title">Gợi ý gần bạn</h2>
                <p class="section-subtitle">Nhà hàng gần vị trí hiện tại của bạn</p>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="text-muted small" id="nearbySummary"></div>
                <button class="btn btn-sm btn-outline-secondary" id="btnDisableLocation" type="button">Tắt định vị</button>
            </div>
            <div id="nearbyGrid" class="nearby-grid"></div>
        </div>
    </section>

    <!-- Popular Restaurants - New Design -->
    <section class="featured-restaurants-section" id="restaurants">
        <div class="container">
            <div class="featured-section-header">
                <div class="featured-header-content">
                    <h2 class="featured-title">Nhà hàng nổi bật</h2>
                    <p class="featured-subtitle">Khám phá những địa điểm ẩm thực được yêu thích nhất</p>
                </div>
                <a th:href="@{/restaurants}" class="featured-view-all">
                    Xem tất cả
                    <i class="fas fa-arrow-right"></i>
                </a>
            </div>
            
            <!-- Empty State -->
            <div class="featured-empty-state" th:if="${#lists.isEmpty(popularRestaurants)}">
                <div class="empty-icon">
                    <i class="fas fa-utensils"></i>
                </div>
                <h3>Đang cập nhật</h3>
                <p>Dữ liệu nhà hàng nổi bật đang được cập nhật. Vui lòng quay lại sau.</p>
                <a th:href="@{/restaurants}" class="btn-featured-primary">Xem tất cả nhà hàng</a>
            </div>

            <!-- Featured Restaurants Grid -->
            <div class="featured-restaurants-grid" th:if="${!#lists.isEmpty(popularRestaurants)}">
                <article class="featured-restaurant-card" 
                         th:each="restaurant, iterStat : ${popularRestaurants}" 
                         th:if="${iterStat.index < 3}"
                         th:data-restaurant-id="${restaurant.id}"
                         onclick="const id = this.getAttribute('data-restaurant-id'); if(id) window.location.href = '/restaurants/' + id;"
                         style="cursor: pointer;">
                    <!-- Card Image -->
                    <div class="featured-card-image">
                        <img th:if="${restaurant.hasCoverImage()}" 
                             th:src="${restaurant.coverImageUrl}"
                             th:alt="${restaurant.name}"
                             loading="lazy"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <div class="featured-card-image-placeholder" 
                             th:style="'background: ' + ${restaurant.fallbackGradient}"
                             th:if="${!restaurant.hasCoverImage()}">
                            <i class="fas fa-utensils"></i>
                        </div>
                        
                        <!-- Badge -->
                        <div class="featured-card-badge" 
                             th:text="${restaurant.badge}"
                             th:if="${restaurant.badge != null}"></div>
                        
                        <!-- Image Overlay on Hover -->
                        <div class="featured-card-overlay">
                            <span class="overlay-text">Xem chi tiết</span>
                        </div>
                    </div>
                    
                    <!-- Card Content -->
                    <div class="featured-card-content">
                        <div class="featured-card-header">
                            <h3 class="featured-card-title" th:text="${restaurant.name}">Tên nhà hàng</h3>
                            <div class="featured-card-rating">
                                <div class="featured-stars">
                                    <i class="fas fa-star featured-star-filled"
                                       th:each="star : ${#numbers.sequence(1, 5)}"
                                       th:if="${star <= restaurant.roundedRating}"></i>
                                    <i class="fas fa-star featured-star-empty"
                                       th:each="star : ${#numbers.sequence(1, 5)}"
                                       th:if="${star > restaurant.roundedRating}"></i>
                                </div>
                                <span class="featured-rating-score" 
                                      th:text="${restaurant.formattedRating}">5.0</span>
                            </div>
                        </div>
                        
                        <div class="featured-card-meta">
                            <span class="featured-cuisine-type" 
                                  th:text="${#strings.defaultString(restaurant.cuisineType, 'Đang cập nhật')}">Italian</span>
                            <span class="featured-meta-separator" th:if="${restaurant.address != null and !#strings.isEmpty(restaurant.address)}">•</span>
                            <span class="featured-location" 
                                  th:text="${restaurant.address}"
                                  th:if="${restaurant.address != null and !#strings.isEmpty(restaurant.address)}">Địa chỉ</span>
                        </div>
                        
                        <div class="featured-card-footer">
                            <div class="featured-card-stats">
                                <span class="featured-review-count" 
                                      th:text="|${restaurant.reviewCount} đánh giá|">20 đánh giá</span>
                                <span class="featured-price" th:text="${restaurant.priceLabel}">₫200,000</span>
                            </div>
                            <a th:href="@{/restaurants/{id}(id=${restaurant.id})}" 
                               class="featured-book-button"
                               onclick="event.stopPropagation();">
                                <i class="fas fa-calendar-check"></i>
                                Đặt bàn ngay
                            </a>
                        </div>
                    </div>
                </article>
            </div>
        </div>
    </section>

    <!-- Categories Section -->
    <section class="categories-section" id="categories">
        <div class="container">
            <div class="section-header">
                <h2 class="section-title">Khám phá theo loại hình</h2>
                <p class="section-subtitle">Tìm nhà hàng phù hợp với sở thích của bạn</p>
            </div>
            
            <div class="category-grid">
                <div class="category-card">
                    <div class="category-icon">
                        <i class="fas fa-utensils"></i>
                    </div>
                    <h3 class="category-name">Fine Dining</h3>
                    <p class="category-count">45 nhà hàng</p>
                </div>
                
                <div class="category-card">
                    <div class="category-icon">
                        <i class="fas fa-pizza-slice"></i>
                    </div>
                    <h3 class="category-name">Casual Dining</h3>
                    <p class="category-count">128 nhà hàng</p>
                </div>
                
                <div class="category-card">
                    <div class="category-icon">
                        <i class="fas fa-coffee"></i>
                    </div>
                    <h3 class="category-name">Café & Bistro</h3>
                    <p class="category-count">67 nhà hàng</p>
                </div>
                
                <div class="category-card">
                    <div class="category-icon">
                        <i class="fas fa-building"></i>
                    </div>
                    <h3 class="category-name">Rooftop</h3>
                    <p class="category-count">23 nhà hàng</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Restaurant Partners Section -->
    <section class="partners-section">
        <div class="container">
            <div class="partners-intro">
                <h2>Đối tác nhà hàng của chúng tôi</h2>
                <p>Hợp tác với những thương hiệu ẩm thực hàng đầu để mang đến trải nghiệm tuyệt vời nhất</p>
                    </div>
                    
            <div class="partners-grid">
                <!-- Partner 1 -->
                <div class="partner-card">
                    <div class="partner-logo" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <i class="fas fa-crown"></i>
                    </div>
                    <h3 class="partner-name">Le Cordon Bleu</h3>
                    <p class="partner-type">Fine Dining • French Cuisine</p>
                    <div class="partner-stats">
                        <div class="partner-stat">
                            <div class="partner-stat-number">4.9</div>
                            <div class="partner-stat-label">Rating</div>
                            </div>
                        <div class="partner-stat">
                            <div class="partner-stat-number">350+</div>
                            <div class="partner-stat-label">Reviews</div>
                                </div>
                                </div>
                </div>
                
                <!-- Partner 2 -->
                <div class="partner-card">
                    <div class="partner-logo" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <i class="fas fa-fire"></i>
                    </div>
                    <h3 class="partner-name">Sushi Master</h3>
                    <p class="partner-type">Japanese • Premium</p>
                    <div class="partner-stats">
                        <div class="partner-stat">
                            <div class="partner-stat-number">4.8</div>
                            <div class="partner-stat-label">Rating</div>
                        </div>
                        <div class="partner-stat">
                            <div class="partner-stat-number">280+</div>
                            <div class="partner-stat-label">Reviews</div>
                            </div>
                        </div>
                    </div>
                    
                <!-- Partner 3 -->
                <div class="partner-card">
                    <div class="partner-logo" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <i class="fas fa-leaf"></i>
                    </div>
                    <h3 class="partner-name">Green Garden</h3>
                    <p class="partner-type">Vegetarian • Organic</p>
                    <div class="partner-stats">
                        <div class="partner-stat">
                            <div class="partner-stat-number">4.7</div>
                            <div class="partner-stat-label">Rating</div>
                            </div>
                        <div class="partner-stat">
                            <div class="partner-stat-number">195+</div>
                            <div class="partner-stat-label">Reviews</div>
                                </div>
                                </div>
                            </div>
                
                <!-- Partner 4 -->
                <div class="partner-card">
                    <div class="partner-logo" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                        <i class="fas fa-pizza-slice"></i>
                    </div>
                    <h3 class="partner-name">Bella Italia</h3>
                    <p class="partner-type">Italian • Family Style</p>
                    <div class="partner-stats">
                        <div class="partner-stat">
                            <div class="partner-stat-number">4.6</div>
                            <div class="partner-stat-label">Rating</div>
                        </div>
                        <div class="partner-stat">
                            <div class="partner-stat-number">420+</div>
                            <div class="partner-stat-label">Reviews</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Partners CTA -->
            <div class="partners-cta">
                <h3>Bạn là chủ nhà hàng?</h3>
                <p>Hợp tác với Book Eat để tiếp cận hàng ngàn khách hàng tiềm năng mỗi ngày</p>
                <a th:href="@{/auth/register}" class="btn-partner">
                    <i class="fas fa-handshake"></i>
                    Trở thành đối tác
                </a>
                </div>
            </div>
        </section>

    <!-- Footer Video CTA -->
    <section class="footer-video-cta">
        <div class="footer-video-background">
            <!-- YouTube Video Embed -->
            <iframe 
                src="https://www.youtube.com/embed/lcU3pruVyUw?autoplay=1&mute=1&loop=1&playlist=lcU3pruVyUw&controls=0&showinfo=0&rel=0&modestbranding=1"
                frameborder="0"
                allow="autoplay; encrypted-media"
                allowfullscreen>
            </iframe>
        </div>
        <div class="footer-video-overlay">
            <div class="footer-video-content">
                <h2 class="footer-video-title">Bắt đầu trải nghiệm ngay hôm nay</h2>
                <p class="footer-video-subtitle">Đặt bàn nhanh chóng, dễ dàng và miễn phí</p>
                <div class="footer-video-buttons">
                    <a th:href="@{/restaurants}" class="btn-footer-video">
                        <i class="fas fa-calendar-check"></i>
                        Đặt bàn ngay
                    </a>
                    <a th:href="@{/auth/register}" class="btn-footer-video-outline">
                        <i class="fas fa-store"></i>
                        Dành cho nhà hàng
                    </a>
                </div>
            </div>
        </div>
    </section>

    <!-- Resy Footer -->
    <div th:replace="~{fragments/resy-footer :: resy-footer}"></div>

    <!-- Resy Scripts -->
    <div th:replace="~{fragments/resy-scripts :: resy-scripts}"></div>

    <!-- Location Modal Fragment -->
    <div th:insert="~{fragments/location-modal :: location-modal}"></div>
    
    <!-- Login Modal Fragment -->
    <div th:insert="~{fragments/login-modal :: login-modal}"></div>

    <!-- Location Feature Bootstrapper -->
    <script th:inline="javascript">
      window.APP_CTX = window.APP_CTX || {};
      APP_CTX.authenticated = /*[[${#authorization.expression('isAuthenticated()')}]]*/ false;
      APP_CTX.isRestaurantOwner = /*[[${#authorization.expression('hasRole(''RESTAURANT_OWNER'')')}]]*/ false;
      APP_CTX.showLocationPrompt = /*[[${session.SHOW_LOCATION_PROMPT}]]*/ false;
      APP_CTX.baseUrl = /*[[@{/}]]*/ '/';
    </script>
    <script th:src="@{/js/ai-search.js}"></script>
    <script th:src="@{/js/location.js}"></script>
    
    <!-- Login Modal Functions -->
    <script>
        function closeLoginModal() {
            const modal = document.getElementById('loginModal');
            if (modal) {
                const bsModal = bootstrap.Modal.getInstance(modal);
                if (bsModal) {
                    bsModal.hide();
                }
            }
        }
        
        function openRegisterModal() {
            // This function can be implemented when register modal is created
            console.log('Opening register modal...');
        }
        
        // Auto-focus on username input when modal opens
        document.addEventListener('shown.bs.modal', function(event) {
            if (event.target.id === 'loginModal') {
                const usernameInput = event.target.querySelector('#username');
                if (usernameInput) {
                    usernameInput.focus();
                }
            }
        });
        
    </script>
    
    <!-- Messenger Style Chat Widget -->
    <div id="messenger-chat-widget" class="messenger-chat-widget" sec:authorize="isAuthenticated() and (hasRole('CUSTOMER') or hasRole('customer') or hasRole('RESTAURANT_OWNER') or hasRole('restaurant_owner') or hasRole('ADMIN') or hasRole('admin'))">
        <!-- Chat Toggle Button -->
        <button class="messenger-chat-toggle" id="messengerChatToggle" title="Chat với nhà hàng">
            <i class="fas fa-comments"></i>
            <span class="messenger-chat-pulse"></span>
            <span class="messenger-unread-badge" id="messengerUnreadBadge" style="display: none;">0</span>
        </button>
        
        <!-- Chat Window (Messenger Style) -->
        <div id="messengerChatWindow" class="messenger-chat-window" style="display: none;">
            <!-- Chat Header -->
            <div class="messenger-chat-header">
                <div class="messenger-chat-title">
                    <i class="fas fa-comments"></i>
                    <span>Tin nhắn</span>
                </div>
                <div class="messenger-chat-controls">
                    <button class="messenger-btn-minimize" id="messengerMinimizeBtn" title="Thu nhỏ">
                        <i class="fas fa-minus"></i>
                    </button>
                    <button class="messenger-btn-close" id="messengerCloseBtn" title="Đóng">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <!-- Chat Content -->
            <div class="messenger-chat-content">
                <!-- Rooms List View -->
                <div id="messengerRoomsView" class="messenger-rooms-view">
                    <div class="messenger-rooms-header">
                        <h6 id="messengerRoomsHeaderTitle">Xem tất cả</h6>
                        <div class="messenger-rooms-actions">
                            <!-- Nút chọn nhà hàng - hiển thị cho ADMIN và RESTAURANT_OWNER -->
                            <button class="messenger-btn-select-restaurant" id="messengerSelectRestaurantBtn" title="Chọn nhà hàng" style="display: none;">
                                <i class="fas fa-store"></i>
                            </button>
                            <!-- Nút quay lại chọn nhà hàng - chỉ cho restaurant owner -->
                            <button class="messenger-btn-select-restaurant" id="messengerBackToRestaurantBtn" title="Chọn nhà hàng khác" style="display: none;">
                                <i class="fas fa-arrow-left"></i>
                            </button>
                            <button class="messenger-btn-new-chat" id="messengerNewChatBtn" title="Chat mới">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Nút chọn loại chat (chỉ cho restaurant owner) -->
                    <div class="messenger-chat-type-selector" id="messengerChatTypeSelector" style="display: none;">
                        <button class="messenger-chat-type-btn" id="messengerChatWithCustomerBtn">
                            <i class="fas fa-users"></i>
                            <span>Customer</span>
                        </button>
                        <button class="messenger-chat-type-btn" id="messengerChatWithAdminBtn">
                            <i class="fas fa-user-shield"></i>
                            <span>Admin</span>
                        </button>
                    </div>
                    
                    <div id="messengerRoomsLoading" class="messenger-loading">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        <span>Đang tải...</span>
                    </div>
                    
                    <div id="messengerRoomsList" class="messenger-rooms-list" style="display: none;">
                        <!-- Rooms will be loaded here -->
                    </div>
                    
                    <div id="messengerRoomsEmpty" class="messenger-empty" style="display: none;">
                        <i class="fas fa-inbox"></i>
                        <p>Chưa có cuộc trò chuyện nào</p>
                        <a id="messengerEmptyChatLink" href="#" class="messenger-btn-link">Bắt đầu chat mới</a>
                    </div>
                </div>
                
                <!-- Restaurant Selection View (cho ADMIN và RESTAURANT_OWNER) -->
                <div id="messengerRestaurantSelectionView" class="messenger-restaurant-selection-view" style="display: none;">
                    <div class="messenger-restaurant-selection-header">
                        <button class="messenger-btn-back" id="messengerBackFromRestaurantBtn" style="display: none;">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <h6 id="messengerRestaurantSelectionTitle">Chọn nhà hàng để chat</h6>
                    </div>
                    
                    <div id="messengerRestaurantLoading" class="messenger-loading">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        <span>Đang tải...</span>
                    </div>
                    
                    <div id="messengerRestaurantList" class="messenger-restaurant-list" style="display: none;">
                        <!-- Restaurants will be loaded here -->
                    </div>
                    
                    <div id="messengerRestaurantEmpty" class="messenger-empty" style="display: none;">
                        <i class="fas fa-store"></i>
                        <p>Không có nhà hàng nào</p>
                    </div>
                </div>
                
                <!-- Chat Interface View -->
                <div id="messengerChatView" class="messenger-chat-view" style="display: none;">
                    <div class="messenger-chat-view-header">
                        <button class="messenger-btn-back" id="messengerBackBtn">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="messenger-chat-info">
                            <h6 id="messengerChatRoomName">Nhà hàng</h6>
                            <small id="messengerChatStatus">Đang online</small>
                        </div>
                    </div>
                    
                    <div id="messengerMessagesContainer" class="messenger-messages-container">
                        <!-- Messages will be loaded here -->
                    </div>
                    
                    <div id="messengerTypingIndicator" class="messenger-typing-indicator" style="display: none;">
                        <div class="messenger-typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                        <span>Đang gõ...</span>
                    </div>
                    
                    <div class="messenger-message-input">
                        <input type="text" id="messengerMessageInput" class="messenger-input" 
                               placeholder="Nhập tin nhắn..." maxlength="1000">
                        <button id="messengerSendBtn" class="messenger-btn-send" title="Gửi">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Messenger Chat Widget CSS -->
    <style>
        /* Messenger Style Chat Widget */
        .messenger-chat-widget {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 1000;
            font-family: 'Inter', sans-serif;
        }

        .messenger-chat-toggle {
            width: 60px;
            height: 60px;
            background: #FFFFFF;
            border: 2px solid #000000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            position: relative;
            padding: 0;
        }

        .messenger-chat-toggle:hover {
            transform: scale(1.1);
            background: #000000;
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.5);
        }

        .messenger-chat-toggle:hover i {
            color: #FFFFFF;
        }

        .messenger-chat-toggle i {
            font-size: 24px;
            color: #000000;
            z-index: 2;
            transition: color 0.3s;
        }

        .messenger-chat-pulse {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.3);
            animation: pulse-ring 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .messenger-unread-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #000000;
            color: #FFFFFF;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 11px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3;
            border: 2px solid #FFFFFF;
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }

        /* Messenger Chat Window */
        .messenger-chat-window {
            position: absolute;
            bottom: 0;
            right: 70px;
            width: 380px;
            height: 600px;
            background: #FFFFFF;
            border: 2px solid #000000;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .messenger-chat-header {
            background: #FFFFFF;
            border-bottom: 2px solid #000000;
            color: #000000;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .messenger-chat-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 16px;
        }

        .messenger-chat-controls {
            display: flex;
            gap: 8px;
        }

        .messenger-btn-minimize,
        .messenger-btn-close {
            background: #FFFFFF;
            border: 2px solid #000000;
            color: #000000;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .messenger-btn-minimize:hover,
        .messenger-btn-close:hover {
            background: #000000;
            color: #FFFFFF;
        }

        .messenger-chat-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Rooms View */
        .messenger-rooms-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .messenger-rooms-header {
            padding: 16px 20px;
            border-bottom: 2px solid #000000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .messenger-rooms-header h6 {
            margin: 0;
            font-weight: 600;
            font-size: 16px;
            color: #111827;
        }

        .messenger-rooms-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .messenger-btn-select-restaurant {
            background: #000000;
            border: 2px solid #000000;
            color: #FFFFFF;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .messenger-btn-select-restaurant:hover {
            background: #FFFFFF;
            color: #000000;
        }

        .messenger-btn-new-chat {
            background: #000000;
            border: 2px solid #000000;
            color: #FFFFFF;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .messenger-btn-new-chat:hover {
            background: #FFFFFF;
            color: #000000;
        }

        .messenger-loading,
        .messenger-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
        }

        .messenger-loading {
            gap: 12px;
        }

        .messenger-empty i {
            font-size: 48px;
            color: #9CA3AF;
            margin-bottom: 16px;
        }

        .messenger-empty p {
            color: #6B7280;
            margin-bottom: 16px;
        }

        .messenger-btn-link {
            color: #000000;
            text-decoration: none;
            font-weight: 500;
            border-bottom: 1px solid #000000;
        }

        .messenger-btn-link:hover {
            border-bottom: 2px solid #000000;
        }

        .messenger-rooms-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
        }

        .messenger-room-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid #E5E7EB;
        }

        .messenger-room-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .messenger-room-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #FFFFFF;
            border: 2px solid #000000;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .messenger-room-avatar i {
            color: #000000;
            font-size: 20px;
        }

        .messenger-room-info {
            flex: 1;
            min-width: 0;
        }

        .messenger-room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .messenger-room-name {
            font-weight: 600;
            font-size: 15px;
            color: #111827;
            margin: 0;
        }

        .messenger-room-time {
            font-size: 12px;
            color: #6B7280;
            white-space: nowrap;
        }

        .messenger-room-message {
            font-size: 14px;
            color: #6B7280;
            margin: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .messenger-room-unread {
            background: #000000;
            color: #FFFFFF;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: 600;
            min-width: 18px;
            text-align: center;
            margin-left: 8px;
        }

        /* Restaurant Selection View */
        .messenger-restaurant-selection-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .messenger-restaurant-selection-header {
            padding: 16px 20px;
            border-bottom: 2px solid #000000;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .messenger-restaurant-selection-header h6 {
            margin: 0;
            font-weight: 600;
            font-size: 16px;
            color: #111827;
            flex: 1;
        }

        .messenger-restaurant-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
        }

        .messenger-restaurant-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid #E5E7EB;
        }

        .messenger-restaurant-item:hover {
            background-color: #F9FAFB;
        }

        .messenger-restaurant-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #FFFFFF;
            font-size: 20px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .messenger-restaurant-info {
            flex: 1;
            min-width: 0;
        }

        .messenger-restaurant-name {
            font-weight: 600;
            font-size: 15px;
            color: #111827;
            margin: 0 0 4px 0;
        }

        .messenger-restaurant-owner {
            font-size: 13px;
            color: #6B7280;
            margin: 0;
        }

        .messenger-restaurant-unread {
            background: #000000;
            color: #FFFFFF;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: 600;
            min-width: 18px;
            text-align: center;
            margin-left: 8px;
        }

        /* Chat Type Selector (cho restaurant owner) */
        .messenger-chat-type-selector {
            display: flex;
            gap: 8px;
            padding: 12px 20px;
            border-top: 1px solid #E5E7EB;
            background: #FFFFFF;
        }

        .messenger-chat-type-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 16px;
            border: 2px solid #000000;
            background: #FFFFFF;
            color: #000000;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .messenger-chat-type-btn:hover {
            background: #000000;
            color: #FFFFFF;
        }

        .messenger-chat-type-btn.active {
            background: #000000;
            color: #FFFFFF;
        }

        .messenger-chat-type-btn i {
            font-size: 16px;
        }

        /* Chat View */
        .messenger-chat-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .messenger-chat-view-header {
            padding: 12px 16px;
            border-bottom: 2px solid #000000;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .messenger-btn-back {
            background: #FFFFFF;
            border: 2px solid #000000;
            color: #000000;
            font-size: 18px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .messenger-btn-back:hover {
            background: #000000;
            color: #FFFFFF;
        }

        .messenger-chat-info h6 {
            margin: 0;
            font-weight: 600;
            font-size: 15px;
            color: #111827;
        }

        .messenger-chat-info small {
            color: #6B7280;
            font-size: 12px;
        }

        .messenger-messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: #FFFFFF;
        }

        .messenger-message-item {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            max-width: 75%;
        }

        .messenger-message-item.own-message {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .messenger-message-content {
            background: #FFFFFF;
            border: 2px solid #000000;
            border-radius: 18px;
            padding: 8px 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .messenger-message-item.own-message .messenger-message-content {
            background: #000000;
            border: 2px solid #000000;
            color: #FFFFFF;
        }

        .messenger-message-text {
            font-size: 14px;
            line-height: 1.4;
            color: #111827;
            margin: 0;
        }

        .messenger-message-item.own-message .messenger-message-text {
            color: white;
        }

        .messenger-message-time {
            font-size: 11px;
            color: #9CA3AF;
            margin-top: 4px;
        }

        .messenger-message-item.own-message .messenger-message-time {
            color: rgba(255, 255, 255, 0.8);
        }

        .messenger-typing-indicator {
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .messenger-typing-dots {
            display: flex;
            gap: 4px;
        }

        .messenger-typing-dots span {
            width: 8px;
            height: 8px;
            background: #9CA3AF;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .messenger-typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .messenger-typing-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        .messenger-message-input {
            padding: 12px 16px;
            border-top: 2px solid #000000;
            display: flex;
            gap: 8px;
            align-items: center;
            background: #FFFFFF;
        }

        .messenger-input {
            flex: 1;
            border: 2px solid #000000;
            border-radius: 20px;
            padding: 10px 16px;
            font-size: 14px;
            outline: none;
            background: #FFFFFF;
            color: #000000;
        }

        .messenger-input:focus {
            border-color: #000000;
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.2);
        }

        .messenger-btn-send {
            background: #000000;
            border: 2px solid #000000;
            color: #FFFFFF;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .messenger-btn-send:hover {
            background: #FFFFFF;
            color: #000000;
        }

        .messenger-btn-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .messenger-chat-widget {
                bottom: 16px;
                right: 16px;
            }

            .messenger-chat-toggle {
                width: 56px;
                height: 56px;
            }

            .messenger-chat-toggle i {
                font-size: 22px;
            }

            .messenger-chat-window {
                width: calc(100vw - 32px);
                height: calc(100vh - 100px);
                bottom: 0;
                right: 70px;
                left: auto;
                max-width: 100%;
            }

            .messenger-room-item {
                padding: 12px 16px;
            }

            .messenger-room-avatar {
                width: 40px;
                height: 40px;
                margin-right: 10px;
            }

            .messenger-message-item {
                max-width: 85%;
            }
        }
    </style>
    
    <!-- WebSocket Libraries for Chat -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    
    <!-- Messenger Chat Widget JavaScript -->
    <script>
        // Messenger Chat Widget
        class MessengerChatWidget {
            constructor() {
                this.socket = null;
                this.stompClient = null;
                this.currentRoomId = null;
                this.currentUserId = null;
                this.userRole = null;
                this.selectedRestaurantId = null; // Lưu restaurant đã chọn (cho restaurant owner)
                this.chatType = 'customer'; // 'customer' hoặc 'admin' (cho restaurant owner)
                this.isConnected = false;
                this.isMinimized = false;
                this.typingTimer = null;
                this.unreadCountInterval = null;
                
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                this.loadUnreadCount();
                this.initWebSocket();
                
                // Cập nhật unread count định kỳ mỗi 30 giây
                this.unreadCountInterval = setInterval(() => {
                    this.loadUnreadCount();
                }, 30000);
            }
            
            setupEventListeners() {
                const toggleBtn = document.getElementById('messengerChatToggle');
                const minimizeBtn = document.getElementById('messengerMinimizeBtn');
                const closeBtn = document.getElementById('messengerCloseBtn');
                const backBtn = document.getElementById('messengerBackBtn');
                const sendBtn = document.getElementById('messengerSendBtn');
                const messageInput = document.getElementById('messengerMessageInput');
                const newChatBtn = document.getElementById('messengerNewChatBtn');
                const selectRestaurantBtn = document.getElementById('messengerSelectRestaurantBtn');
                const backToRestaurantBtn = document.getElementById('messengerBackToRestaurantBtn');
                const backFromRestaurantBtn = document.getElementById('messengerBackFromRestaurantBtn');
                
                if (toggleBtn) {
                    toggleBtn.addEventListener('click', () => this.toggleChat());
                }
                
                if (minimizeBtn) {
                    minimizeBtn.addEventListener('click', () => this.minimizeChat());
                }
                
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => this.closeChat());
                }
                
                if (backBtn) {
                    backBtn.addEventListener('click', () => this.backToRooms());
                }
                
                if (sendBtn) {
                    sendBtn.addEventListener('click', () => this.sendMessage());
                }
                
                if (messageInput) {
                    messageInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            this.sendMessage();
                        }
                    });
                    
                    messageInput.addEventListener('input', () => {
                        this.handleTyping();
                    });
                }
                
                if (newChatBtn) {
                    newChatBtn.addEventListener('click', () => {
                        const chatUrl = this.getChatUrlByRole();
                        window.location.href = chatUrl;
                    });
                }
                
                // Set link cho empty state
                const emptyChatLink = document.getElementById('messengerEmptyChatLink');
                if (emptyChatLink) {
                    emptyChatLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        const chatUrl = this.getChatUrlByRole();
                        window.location.href = chatUrl;
                    });
                }
                
                // Xử lý nút chọn nhà hàng (cho ADMIN và RESTAURANT_OWNER)
                if (selectRestaurantBtn) {
                    selectRestaurantBtn.addEventListener('click', () => {
                        this.showRestaurantSelection();
                    });
                }
                
                // Xử lý nút quay lại chọn nhà hàng (chỉ cho restaurant owner)
                if (backToRestaurantBtn) {
                    backToRestaurantBtn.addEventListener('click', () => {
                        this.showRestaurantSelection();
                    });
                }
                
                // Xử lý nút quay lại từ restaurant selection
                if (backFromRestaurantBtn) {
                    backFromRestaurantBtn.addEventListener('click', () => {
                        // Đối với restaurant owner: quay lại restaurant selection
                        // Đối với admin: quay lại rooms view
                        if (this.userRole === 'RESTAURANT_OWNER' || this.userRole === 'restaurant_owner') {
                            this.showRestaurantSelection();
                        } else {
                            this.showRoomsView();
                        }
                    });
                }
                
                // Xử lý nút chọn loại chat (Customer/Admin) - chỉ cho restaurant owner
                const chatWithCustomerBtn = document.getElementById('messengerChatWithCustomerBtn');
                const chatWithAdminBtn = document.getElementById('messengerChatWithAdminBtn');
                
                if (chatWithCustomerBtn) {
                    chatWithCustomerBtn.addEventListener('click', () => {
                        this.selectChatType('customer');
                    });
                }
                
                if (chatWithAdminBtn) {
                    chatWithAdminBtn.addEventListener('click', () => {
                        this.selectChatType('admin');
                    });
                }
            }
            
            getChatUrlByRole() {
                // Trả về URL chat phù hợp dựa trên role
                if (this.userRole === 'CUSTOMER' || this.userRole === 'customer') {
                    return '/customer/chat';
                } else if (this.userRole === 'RESTAURANT_OWNER' || this.userRole === 'restaurant_owner') {
                    return '/restaurant-owner/chat';
                } else if (this.userRole === 'ADMIN' || this.userRole === 'admin') {
                    return '/admin/chat';
                }
                // Default fallback
                return '/customer/chat';
            }
            
            toggleChat() {
                const window = document.getElementById('messengerChatWindow');
                if (window.style.display === 'none') {
                    this.openChat();
                } else {
                    this.closeChat();
                }
            }
            
            openChat() {
                const window = document.getElementById('messengerChatWindow');
                window.style.display = 'flex';
                this.isMinimized = false;
                this.loadUnreadCount(); // Cập nhật unread count khi mở chat
                
                // Đối với restaurant owner: hiển thị rooms view với nút Customer/Admin
                if (this.userRole === 'RESTAURANT_OWNER' || this.userRole === 'restaurant_owner') {
                    // Nếu chưa chọn restaurant và đang ở chế độ customer → hiển thị restaurant selection
                    if (!this.selectedRestaurantId && this.chatType === 'customer') {
                        this.showRestaurantSelection();
                    } else {
                        // Hiển thị rooms view
                        this.showRoomsView();
                        this.loadChatRooms();
                    }
                } else {
                    // Admin và Customer: hiển thị rooms trực tiếp
                    this.showRoomsView();
                    this.loadChatRooms();
                }
                
                // Hiển thị nút chọn nhà hàng nếu là ADMIN hoặc RESTAURANT_OWNER
                const selectRestaurantBtn = document.getElementById('messengerSelectRestaurantBtn');
                const backToRestaurantBtn = document.getElementById('messengerBackToRestaurantBtn');
                
                if (this.userRole === 'ADMIN' || this.userRole === 'admin') {
                    // Admin: hiển thị nút chọn nhà hàng
                    if (selectRestaurantBtn) selectRestaurantBtn.style.display = 'flex';
                    if (backToRestaurantBtn) backToRestaurantBtn.style.display = 'none';
                } else if (this.userRole === 'RESTAURANT_OWNER' || this.userRole === 'restaurant_owner') {
                    // Restaurant owner: 
                    // - Nếu chưa chọn restaurant: hiển thị nút chọn nhà hàng
                    // - Nếu đã chọn restaurant: hiển thị nút quay lại chọn nhà hàng
                    if (this.selectedRestaurantId) {
                        if (selectRestaurantBtn) selectRestaurantBtn.style.display = 'none';
                        if (backToRestaurantBtn) backToRestaurantBtn.style.display = 'flex';
                    } else {
                        if (selectRestaurantBtn) selectRestaurantBtn.style.display = 'flex';
                        if (backToRestaurantBtn) backToRestaurantBtn.style.display = 'none';
                    }
                } else {
                    if (selectRestaurantBtn) selectRestaurantBtn.style.display = 'none';
                    if (backToRestaurantBtn) backToRestaurantBtn.style.display = 'none';
                }
            }
            
            minimizeChat() {
                const window = document.getElementById('messengerChatWindow');
                window.style.display = 'none';
                this.isMinimized = true;
            }
            
            closeChat() {
                const window = document.getElementById('messengerChatWindow');
                window.style.display = 'none';
                this.currentRoomId = null;
                this.showRoomsView();
            }
            
            async loadChatRooms() {
                const loadingEl = document.getElementById('messengerRoomsLoading');
                const listEl = document.getElementById('messengerRoomsList');
                const emptyEl = document.getElementById('messengerRoomsEmpty');
                
                loadingEl.style.display = 'flex';
                listEl.style.display = 'none';
                emptyEl.style.display = 'none';
                
                try {
                    let url = '/api/chat/rooms';
                    const params = new URLSearchParams();
                    
                    // Đối với restaurant owner
                    if (this.userRole === 'RESTAURANT_OWNER' || this.userRole === 'restaurant_owner') {
                        // Nếu đang chọn Customer: filter theo restaurant đã chọn
                        if (this.chatType === 'customer' && this.selectedRestaurantId) {
                            params.append('restaurantId', this.selectedRestaurantId);
                        }
                        // Nếu đang chọn Admin: không filter, sẽ filter ở client side
                    }
                    
                    if (params.toString()) {
                        url += '?' + params.toString();
                    }
                    
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Failed to load rooms');
                    
                    const rooms = await response.json();
                    loadingEl.style.display = 'none';
                    
                    // Filter rooms dựa trên chat type cho restaurant owner
                    let filteredRooms = rooms;
                    if (this.userRole === 'RESTAURANT_OWNER' || this.userRole === 'restaurant_owner') {
                        if (this.chatType === 'customer') {
                            // Chỉ lấy rooms có customer (participantRole === 'CUSTOMER')
                            filteredRooms = rooms.filter(room => room.participantRole === 'CUSTOMER');
                        } else if (this.chatType === 'admin') {
                            // Chỉ lấy rooms có admin (participantRole === 'ADMIN')
                            filteredRooms = rooms.filter(room => room.participantRole === 'ADMIN');
                        }
                    }
                    
                    if (filteredRooms && filteredRooms.length > 0) {
                        this.displayRooms(filteredRooms);
                        listEl.style.display = 'block';
                    } else {
                        // Vẫn hiển thị AI Chat Assistant ngay cả khi không có room nào (chỉ cho customer)
                        this.displayRooms([]);
                        listEl.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error loading rooms:', error);
                    loadingEl.style.display = 'none';
                    // Vẫn hiển thị AI Chat Assistant khi có lỗi (chỉ cho customer)
                    this.displayRooms([]);
                    listEl.style.display = 'block';
                }
            }
            
            displayRooms(rooms) {
                const listEl = document.getElementById('messengerRoomsList');
                listEl.innerHTML = '';
                
                // Chỉ thêm AI Chat Assistant cho CUSTOMER
                if (this.userRole === 'CUSTOMER' || this.userRole === 'customer') {
                    const aiChatRoom = this.createAIChatRoom();
                    listEl.appendChild(aiChatRoom);
                }
                
                // Sắp xếp các room restaurant theo thời gian tin nhắn cuối cùng (mới nhất trước)
                const sortedRooms = [...rooms].sort((a, b) => {
                    const aTime = a.lastMessageAt ? new Date(a.lastMessageAt).getTime() : 0;
                    const bTime = b.lastMessageAt ? new Date(b.lastMessageAt).getTime() : 0;
                    return bTime - aTime; // Mới nhất trước
                });
                
                sortedRooms.forEach(room => {
                    const roomItem = this.createRoomItem(room);
                    listEl.appendChild(roomItem);
                });
            }
            
            createAIChatRoom() {
                const item = document.createElement('div');
                item.className = 'messenger-room-item';
                item.setAttribute('data-ai-chat', 'true');
                item.addEventListener('click', () => this.openAIChat());
                
                const avatar = document.createElement('div');
                avatar.className = 'messenger-room-avatar';
                avatar.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                avatar.innerHTML = '<i class="fas fa-robot"></i>';
                
                const info = document.createElement('div');
                info.className = 'messenger-room-info';
                
                const header = document.createElement('div');
                header.className = 'messenger-room-header';
                
                const name = document.createElement('h6');
                name.className = 'messenger-room-name';
                name.textContent = 'Trợ Lý AI';
                
                const status = document.createElement('span');
                status.className = 'messenger-room-time';
                status.textContent = 'Luôn sẵn sàng';
                status.style.color = '#4CAF50';
                
                header.appendChild(name);
                header.appendChild(status);
                
                const message = document.createElement('p');
                message.className = 'messenger-room-message';
                message.textContent = 'Chào bạn! Tôi có thể giúp gì cho bạn?';
                
                info.appendChild(header);
                info.appendChild(message);
                
                item.appendChild(avatar);
                item.appendChild(info);
                
                return item;
            }
            
            async openAIChat() {
                // Chỉ CUSTOMER mới có thể mở AI Chat
                if (this.userRole !== 'CUSTOMER' && this.userRole !== 'customer') {
                    console.warn('AI Chat is only available for CUSTOMER role');
                    return;
                }
                
                this.currentRoomId = 'AI_CHAT';
                this.showChatView('Trợ Lý AI');
                
                // Load AI chat messages từ localStorage hoặc tạo mới
                const aiMessages = this.getAIChatMessages();
                this.displayAIMessages(aiMessages);
                
                // Focus vào input
                const messageInput = document.getElementById('messengerMessageInput');
                if (messageInput) {
                    messageInput.focus();
                }
            }
            
            getAIChatMessages() {
                const stored = localStorage.getItem('ai_chat_messages');
                if (stored) {
                    try {
                        return JSON.parse(stored);
                    } catch (e) {
                        return [];
                    }
                }
                return [];
            }
            
            saveAIChatMessages(messages) {
                localStorage.setItem('ai_chat_messages', JSON.stringify(messages));
            }
            
            displayAIMessages(messages) {
                const container = document.getElementById('messengerMessagesContainer');
                container.innerHTML = '';
                
                if (messages.length === 0) {
                    // Tin nhắn chào mừng mặc định
                    const welcomeMsg = {
                        content: 'Xin chào! Tôi là Trợ Lý AI của Book Eat. Tôi có thể giúp bạn tìm nhà hàng, đặt bàn và trả lời các câu hỏi về dịch vụ. Bạn cần hỗ trợ gì?',
                        senderId: 'AI',
                        senderName: 'Trợ Lý AI',
                        sentAt: new Date().toISOString()
                    };
                    messages = [welcomeMsg];
                }
                
                messages.forEach(message => {
                    const messageEl = this.createMessageElement(message);
                    container.appendChild(messageEl);
                });
                
                this.scrollToBottom();
            }
            
            createRoomItem(room) {
                const item = document.createElement('div');
                item.className = 'messenger-room-item';
                
                // Xác định tên hiển thị dựa trên role
                let displayName;
                let roomNameForChat;
                if (this.userRole === 'RESTAURANT_OWNER' || this.userRole === 'restaurant_owner') {
                    // Restaurant owner: hiển thị tên customer
                    displayName = room.participantName || 'Khách hàng';
                    roomNameForChat = room.participantName || 'Khách hàng';
                } else {
                    // Customer và Admin: hiển thị tên nhà hàng
                    displayName = room.restaurantName || 'Nhà hàng';
                    roomNameForChat = room.restaurantName || 'Nhà hàng';
                }
                
                item.addEventListener('click', () => this.openChatRoom(room.roomId, roomNameForChat));
                
                const avatar = document.createElement('div');
                avatar.className = 'messenger-room-avatar';
                
                // Đối với restaurant owner: hiển thị avatar customer hoặc icon user
                // Đối với customer/admin: hiển thị icon store
                if (this.userRole === 'RESTAURANT_OWNER' || this.userRole === 'restaurant_owner') {
                    if (room.participantAvatarUrl) {
                        avatar.style.backgroundImage = `url(${room.participantAvatarUrl})`;
                        avatar.style.backgroundSize = 'cover';
                        avatar.style.backgroundPosition = 'center';
                    } else {
                        avatar.innerHTML = '<i class="fas fa-user"></i>';
                        avatar.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    }
                } else {
                    avatar.innerHTML = '<i class="fas fa-store"></i>';
                }
                
                const info = document.createElement('div');
                info.className = 'messenger-room-info';
                
                const header = document.createElement('div');
                header.className = 'messenger-room-header';
                
                const name = document.createElement('h6');
                name.className = 'messenger-room-name';
                name.textContent = displayName;
                
                const time = document.createElement('span');
                time.className = 'messenger-room-time';
                if (room.lastMessageAt) {
                    time.textContent = this.formatTime(room.lastMessageAt);
                }
                
                header.appendChild(name);
                if (room.lastMessageAt) header.appendChild(time);
                
                if (room.unreadCount && room.unreadCount > 0) {
                    const badge = document.createElement('span');
                    badge.className = 'messenger-room-unread';
                    badge.textContent = room.unreadCount > 99 ? '99+' : room.unreadCount;
                    header.appendChild(badge);
                }
                
                const message = document.createElement('p');
                message.className = 'messenger-room-message';
                message.textContent = room.lastMessage || 'Chưa có tin nhắn';
                
                info.appendChild(header);
                info.appendChild(message);
                
                item.appendChild(avatar);
                item.appendChild(info);
                
                return item;
            }
            
            async openChatRoom(roomId, roomName) {
                this.currentRoomId = roomId;
                this.showChatView(roomName);
                await this.loadMessages(roomId);
                await this.markMessagesAsRead(roomId);
                this.joinRoom(roomId);
            }
            
            showChatView(roomName) {
                document.getElementById('messengerRoomsView').style.display = 'none';
                document.getElementById('messengerRestaurantSelectionView').style.display = 'none';
                document.getElementById('messengerChatView').style.display = 'flex';
                document.getElementById('messengerChatRoomName').textContent = roomName || 'Nhà hàng';
            }
            
            showRoomsView() {
                document.getElementById('messengerRestaurantSelectionView').style.display = 'none';
                document.getElementById('messengerChatView').style.display = 'none';
                document.getElementById('messengerRoomsView').style.display = 'flex';
                this.currentRoomId = null;
                
                // Hiển thị nút chọn loại chat cho restaurant owner
                const chatTypeSelector = document.getElementById('messengerChatTypeSelector');
                if (this.userRole === 'RESTAURANT_OWNER' || this.userRole === 'restaurant_owner') {
                    if (chatTypeSelector) {
                        chatTypeSelector.style.display = 'flex';
                        // Cập nhật active state
                        const customerBtn = document.getElementById('messengerChatWithCustomerBtn');
                        const adminBtn = document.getElementById('messengerChatWithAdminBtn');
                        if (customerBtn && adminBtn) {
                            if (this.chatType === 'customer') {
                                customerBtn.classList.add('active');
                                adminBtn.classList.remove('active');
                            } else {
                                customerBtn.classList.remove('active');
                                adminBtn.classList.add('active');
                            }
                        }
                    }
                } else {
                    if (chatTypeSelector) chatTypeSelector.style.display = 'none';
                }
                
                // Cập nhật header: hiển thị tên restaurant nếu đã chọn
                const roomsHeader = document.getElementById('messengerRoomsHeaderTitle');
                if (roomsHeader) {
                    if ((this.userRole === 'RESTAURANT_OWNER' || this.userRole === 'restaurant_owner') && this.selectedRestaurantId) {
                        // Load tên restaurant từ API
                        this.updateRestaurantHeaderName();
                    } else if ((this.userRole === 'RESTAURANT_OWNER' || this.userRole === 'restaurant_owner') && this.chatType === 'admin') {
                        roomsHeader.textContent = 'Chat với Admin';
                    } else {
                        roomsHeader.textContent = 'Xem tất cả';
                    }
                }
            }
            
            async updateRestaurantHeaderName() {
                const roomsHeader = document.getElementById('messengerRoomsHeaderTitle');
                if (!roomsHeader || !this.selectedRestaurantId) return;
                
                try {
                    // Load restaurants để lấy tên
                    const restaurants = await this.getUserRestaurants();
                    const restaurant = restaurants.find(r => r.restaurantId === this.selectedRestaurantId);
                    if (restaurant) {
                        let restaurantName = restaurant.restaurantName || 'Nhà hàng';
                        // Bỏ phần sau dấu "-"
                        restaurantName = restaurantName.split(/[-–]/)[0].trim();
                        roomsHeader.textContent = restaurantName;
                    } else {
                        roomsHeader.textContent = 'Xem tất cả';
                    }
                } catch (error) {
                    console.error('Error loading restaurant name:', error);
                    roomsHeader.textContent = 'Xem tất cả';
                }
            }
            
            showRestaurantSelection() {
                // Chỉ cho phép ADMIN và RESTAURANT_OWNER
                if (this.userRole !== 'ADMIN' && this.userRole !== 'admin' && 
                    this.userRole !== 'RESTAURANT_OWNER' && this.userRole !== 'restaurant_owner') {
                    console.warn('Restaurant selection is only available for ADMIN and RESTAURANT_OWNER roles');
                    return;
                }
                
                document.getElementById('messengerRoomsView').style.display = 'none';
                document.getElementById('messengerChatView').style.display = 'none';
                document.getElementById('messengerRestaurantSelectionView').style.display = 'flex';
                
                // Reset selected restaurant khi quay lại selection view (chỉ cho restaurant owner)
                if (this.userRole === 'RESTAURANT_OWNER' || this.userRole === 'restaurant_owner') {
                    this.selectedRestaurantId = null;
                }
                
                // Cập nhật title và nút back
                const titleEl = document.getElementById('messengerRestaurantSelectionTitle');
                const backBtn = document.getElementById('messengerBackFromRestaurantBtn');
                if (this.userRole === 'RESTAURANT_OWNER' || this.userRole === 'restaurant_owner') {
                    if (titleEl) titleEl.textContent = 'Chọn nhà hàng để xem tin nhắn';
                    if (backBtn) backBtn.style.display = 'none'; // Không có nút back cho restaurant owner
                } else {
                    if (titleEl) titleEl.textContent = 'Chọn nhà hàng để chat';
                    if (backBtn) backBtn.style.display = 'flex'; // Có nút back cho admin
                }
                
                // Load danh sách restaurants
                this.loadAvailableRestaurants();
            }
            
            selectChatType(type) {
                // Chỉ cho phép restaurant owner
                if (this.userRole !== 'RESTAURANT_OWNER' && this.userRole !== 'restaurant_owner') {
                    return;
                }
                
                this.chatType = type; // 'customer' hoặc 'admin'
                
                // Cập nhật active state của các nút
                const customerBtn = document.getElementById('messengerChatWithCustomerBtn');
                const adminBtn = document.getElementById('messengerChatWithAdminBtn');
                
                if (customerBtn && adminBtn) {
                    if (type === 'customer') {
                        customerBtn.classList.add('active');
                        adminBtn.classList.remove('active');
                        // Nếu chưa chọn restaurant, hiển thị restaurant selection
                        if (!this.selectedRestaurantId) {
                            this.showRestaurantSelection();
                        } else {
                            // Đã chọn restaurant, hiển thị rooms với customers
                            this.showRoomsView();
                            this.loadChatRooms();
                        }
                    } else {
                        customerBtn.classList.remove('active');
                        adminBtn.classList.add('active');
                        // Hiển thị rooms với admin
                        this.showRoomsView();
                        this.loadChatRooms();
                    }
                }
            }
            
            async getUserRestaurants() {
                try {
                    const response = await fetch('/api/chat/available-restaurants');
                    if (!response.ok) throw new Error('Failed to load restaurants');
                    return await response.json();
                } catch (error) {
                    console.error('Error loading restaurants:', error);
                    return [];
                }
            }
            
            async loadAvailableRestaurants() {
                const loadingEl = document.getElementById('messengerRestaurantLoading');
                const listEl = document.getElementById('messengerRestaurantList');
                const emptyEl = document.getElementById('messengerRestaurantEmpty');
                
                loadingEl.style.display = 'flex';
                listEl.style.display = 'none';
                emptyEl.style.display = 'none';
                
                try {
                    const response = await fetch('/api/chat/available-restaurants');
                    if (!response.ok) throw new Error('Failed to load restaurants');
                    
                    const restaurants = await response.json();
                    loadingEl.style.display = 'none';
                    
                    if (restaurants && restaurants.length > 0) {
                        this.displayRestaurants(restaurants);
                        listEl.style.display = 'block';
                    } else {
                        emptyEl.style.display = 'flex';
                    }
                } catch (error) {
                    console.error('Error loading restaurants:', error);
                    loadingEl.style.display = 'none';
                    emptyEl.style.display = 'flex';
                }
            }
            
            displayRestaurants(restaurants) {
                const listEl = document.getElementById('messengerRestaurantList');
                listEl.innerHTML = '';
                
                // Tính tổng unread count cho restaurant owner
                if (this.userRole === 'RESTAURANT_OWNER' || this.userRole === 'restaurant_owner') {
                    const totalUnread = restaurants.reduce((sum, r) => sum + (r.unreadCount || 0), 0);
                    this.updateUnreadBadge(totalUnread);
                }
                
                restaurants.forEach(restaurant => {
                    const restaurantItem = this.createRestaurantItem(restaurant);
                    listEl.appendChild(restaurantItem);
                });
            }
            
            createRestaurantItem(restaurant) {
                const item = document.createElement('div');
                item.className = 'messenger-restaurant-item';
                item.setAttribute('data-restaurant-id', restaurant.restaurantId);
                
                // Đối với restaurant owner: chọn restaurant để xem rooms
                // Đối với admin: tạo room mới để chat
                if (this.userRole === 'RESTAURANT_OWNER' || this.userRole === 'restaurant_owner') {
                    item.addEventListener('click', () => this.selectRestaurantForChat(restaurant.restaurantId, restaurant.restaurantName));
                } else {
                    item.addEventListener('click', () => this.startChatWithRestaurant(restaurant.restaurantId));
                }
                
                const avatar = document.createElement('div');
                avatar.className = 'messenger-restaurant-avatar';
                avatar.innerHTML = '<i class="fas fa-store"></i>';
                
                const info = document.createElement('div');
                info.className = 'messenger-restaurant-info';
                
                const nameRow = document.createElement('div');
                nameRow.style.display = 'flex';
                nameRow.style.alignItems = 'center';
                nameRow.style.justifyContent = 'space-between';
                nameRow.style.marginBottom = '4px';
                
                const name = document.createElement('h6');
                name.className = 'messenger-restaurant-name';
                name.textContent = restaurant.restaurantName || 'Nhà hàng';
                name.style.margin = '0';
                name.style.flex = '1';
                
                nameRow.appendChild(name);
                
                // Hiển thị unread count nếu có (bên phải tên)
                if (restaurant.unreadCount && restaurant.unreadCount > 0) {
                    const unreadBadge = document.createElement('span');
                    unreadBadge.className = 'messenger-restaurant-unread';
                    unreadBadge.textContent = restaurant.unreadCount > 99 ? '99+' : restaurant.unreadCount.toString();
                    nameRow.appendChild(unreadBadge);
                }
                
                const owner = document.createElement('p');
                owner.className = 'messenger-restaurant-owner';
                owner.textContent = restaurant.ownerName || restaurant.address || 'Chủ nhà hàng';
                
                info.appendChild(nameRow);
                info.appendChild(owner);
                
                item.appendChild(avatar);
                item.appendChild(info);
                
                return item;
            }
            
            async startChatWithRestaurant(restaurantId) {
                try {
                    // Tìm tên nhà hàng từ danh sách đã load
                    const restaurantItem = document.querySelector(`[data-restaurant-id="${restaurantId}"]`);
                    let restaurantName = 'Nhà hàng';
                    if (restaurantItem) {
                        const nameEl = restaurantItem.querySelector('.messenger-restaurant-name');
                        if (nameEl) {
                            restaurantName = nameEl.textContent;
                        }
                    }
                    
                    // Đối với restaurant owner, tìm room đã có hoặc tạo mới
                    let roomId;
                    if (this.userRole === 'RESTAURANT_OWNER' || this.userRole === 'restaurant_owner') {
                        // Restaurant owner chat với customers của restaurant này
                        // Tìm room đã có hoặc tạo mới qua API rooms
                        const response = await fetch('/api/chat/rooms', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: `restaurantId=${restaurantId}`
                        });
                        
                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(errorText || 'Failed to create chat room');
                        }
                        
                        const result = await response.json();
                        roomId = result.roomId;
                    } else {
                        // Admin chat với restaurant
                        const response = await fetch('/api/chat/rooms/restaurant', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: `restaurantId=${restaurantId}`
                        });
                        
                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(errorText || 'Failed to create chat room');
                        }
                        
                        const result = await response.json();
                        roomId = result.roomId;
                    }
                    
                    // Mở chat room
                    this.openChatRoom(roomId, restaurantName);
                } catch (error) {
                    console.error('Error starting chat with restaurant:', error);
                    alert('Không thể bắt đầu chat với nhà hàng: ' + error.message);
                }
            }
            
            backToRooms() {
                this.showRoomsView();
                this.loadChatRooms();
            }
            
            selectRestaurantForChat(restaurantId, restaurantName) {
                // Lưu restaurant đã chọn
                this.selectedRestaurantId = restaurantId;
                
                // Đảm bảo chat type là customer
                this.chatType = 'customer';
                
                // Hiển thị rooms view và load rooms của restaurant này
                this.showRoomsView();
                this.loadChatRooms();
                
                // Cập nhật header để hiển thị tên restaurant đã chọn
                this.updateRestaurantHeaderName();
            }
            
            async loadMessages(roomId) {
                try {
                    const response = await fetch(`/api/chat/rooms/${roomId}/messages?page=0&size=50`);
                    if (response.ok) {
                        const messages = await response.json();
                        this.displayMessages(messages);
                    }
                } catch (error) {
                    console.error('Error loading messages:', error);
                }
            }
            
            displayMessages(messages) {
                const container = document.getElementById('messengerMessagesContainer');
                container.innerHTML = '';
                
                messages.forEach(message => {
                    const messageEl = this.createMessageElement(message);
                    container.appendChild(messageEl);
                });
                
                this.scrollToBottom();
            }
            
            createMessageElement(message) {
                const item = document.createElement('div');
                item.className = 'messenger-message-item';
                
                // Kiểm tra nếu là tin nhắn của user hoặc AI
                if (message.senderId === this.currentUserId || message.senderId === this.currentUserId?.toString()) {
                    item.classList.add('own-message');
                } else if (message.senderId === 'AI' || message.senderName === 'Trợ Lý AI') {
                    // Tin nhắn từ AI - không thêm own-message class
                    item.setAttribute('data-ai-message', 'true');
                }
                
                const content = document.createElement('div');
                content.className = 'messenger-message-content';
                
                const text = document.createElement('p');
                text.className = 'messenger-message-text';
                text.textContent = message.content || '';
                
                const time = document.createElement('div');
                time.className = 'messenger-message-time';
                time.textContent = this.formatTime(message.sentAt);
                
                content.appendChild(text);
                content.appendChild(time);
                item.appendChild(content);
                
                return item;
            }
            
            async sendMessage() {
                const input = document.getElementById('messengerMessageInput');
                const content = input.value.trim();
                
                if (!content) return;
                
                // Xử lý riêng cho AI Chat - chỉ cho phép CUSTOMER
                if (this.currentRoomId === 'AI_CHAT') {
                    // Chỉ CUSTOMER mới có thể sử dụng AI Chat
                    if (this.userRole !== 'CUSTOMER' && this.userRole !== 'customer') {
                        console.warn('AI Chat is only available for CUSTOMER role');
                        return;
                    }
                    await this.sendAIMessage(content);
                    input.value = '';
                    return;
                }
                
                // Xử lý chat với restaurant (WebSocket)
                if (!this.currentRoomId || !this.isConnected) return;
                
                try {
                    this.stompClient.send('/app/chat.sendMessage', {}, JSON.stringify({
                        roomId: this.currentRoomId,
                        content: content
                    }));
                    
                    input.value = '';
                    this.stopTyping();
                } catch (error) {
                    console.error('Error sending message:', error);
                }
            }
            
            async sendAIMessage(content) {
                const container = document.getElementById('messengerMessagesContainer');
                
                // Thêm tin nhắn của user
                const userMessage = {
                    content: content,
                    senderId: this.currentUserId,
                    senderName: 'Bạn',
                    sentAt: new Date().toISOString()
                };
                const userMsgEl = this.createMessageElement(userMessage);
                container.appendChild(userMsgEl);
                this.scrollToBottom();
                
                // Lưu tin nhắn vào localStorage
                const messages = this.getAIChatMessages();
                messages.push(userMessage);
                this.saveAIChatMessages(messages);
                
                // Hiển thị typing indicator
                const typingEl = document.createElement('div');
                typingEl.className = 'messenger-message-item';
                typingEl.id = 'ai-typing-indicator';
                typingEl.innerHTML = '<div class="messenger-message-content"><p class="messenger-message-text">Đang suy nghĩ...</p></div>';
                container.appendChild(typingEl);
                this.scrollToBottom();
                
                try {
                    // Gọi API AI
                    const response = await fetch('/ai/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({
                            message: content,
                            context: 'messenger_chat'
                        })
                    });
                    
                    // Xóa typing indicator
                    const typingIndicator = document.getElementById('ai-typing-indicator');
                    if (typingIndicator) {
                        typingIndicator.remove();
                    }
                    
                    if (response.ok) {
                        const data = await response.json();
                        const aiResponse = data.response || 'Xin lỗi, tôi không thể trả lời câu hỏi này. Vui lòng thử lại.';
                        
                        // Thêm tin nhắn của AI
                        const aiMessage = {
                            content: aiResponse,
                            senderId: 'AI',
                            senderName: 'Trợ Lý AI',
                            sentAt: new Date().toISOString()
                        };
                        const aiMsgEl = this.createMessageElement(aiMessage);
                        container.appendChild(aiMsgEl);
                        this.scrollToBottom();
                        
                        // Lưu tin nhắn vào localStorage
                        messages.push(aiMessage);
                        this.saveAIChatMessages(messages);
                    } else {
                        throw new Error('AI API error');
                    }
                } catch (error) {
                    console.error('Error sending AI message:', error);
                    
                    // Xóa typing indicator
                    const typingIndicator = document.getElementById('ai-typing-indicator');
                    if (typingIndicator) {
                        typingIndicator.remove();
                    }
                    
                    // Hiển thị lỗi
                    const errorMessage = {
                        content: 'Xin lỗi, có lỗi xảy ra. Vui lòng thử lại sau.',
                        senderId: 'AI',
                        senderName: 'Trợ Lý AI',
                        sentAt: new Date().toISOString()
                    };
                    const errorMsgEl = this.createMessageElement(errorMessage);
                    container.appendChild(errorMsgEl);
                    this.scrollToBottom();
                }
            }
            
            handleIncomingMessage(data) {
                if (!data || !data.messageId || !data.content) return;
                
                // Chỉ hiển thị tin nhắn nếu đang ở room đó
                if (data.roomId === this.currentRoomId) {
                    const messageEl = this.createMessageElement(data);
                    document.getElementById('messengerMessagesContainer').appendChild(messageEl);
                    this.scrollToBottom();
                    
                    // Đánh dấu đã đọc nếu đang xem room này
                    this.markMessagesAsRead(data.roomId);
                } else {
                    // Nếu không đang xem room này, cập nhật unread count
                    this.loadUnreadCount();
                }
                
                // Luôn reload rooms để cập nhật last message
                this.loadChatRooms();
                
                // Nếu đang ở restaurant selection view, reload để cập nhật unread count
                const restaurantSelectionView = document.getElementById('messengerRestaurantSelectionView');
                if (restaurantSelectionView && restaurantSelectionView.style.display !== 'none') {
                    this.loadAvailableRestaurants();
                }
            }
            
            handleTyping() {
                if (!this.currentRoomId || !this.isConnected) return;
                
                this.stompClient.send('/app/chat.typing', {}, JSON.stringify({
                    roomId: this.currentRoomId,
                    typing: true
                }));
                
                if (this.typingTimer) clearTimeout(this.typingTimer);
                this.typingTimer = setTimeout(() => this.stopTyping(), 1000);
            }
            
            stopTyping() {
                if (!this.currentRoomId || !this.isConnected) return;
                
                this.stompClient.send('/app/chat.typing', {}, JSON.stringify({
                    roomId: this.currentRoomId,
                    typing: false
                }));
                
                if (this.typingTimer) {
                    clearTimeout(this.typingTimer);
                    this.typingTimer = null;
                }
            }
            
            initWebSocket() {
                try {
                    this.socket = new SockJS('/ws');
                    this.stompClient = Stomp.over(this.socket);
                    
                    this.stompClient.connect({}, (frame) => {
                        this.isConnected = true;
                        this.subscribeToMessages();
                    }, (error) => {
                        console.error('WebSocket error:', error);
                        this.isConnected = false;
                    });
                } catch (error) {
                    console.error('Failed to init WebSocket:', error);
                }
            }
            
            subscribeToMessages() {
                if (!this.isConnected) return;
                
                // Subscribe to room messages
                this.stompClient.subscribe('/topic/room/*', (message) => {
                    const data = JSON.parse(message.body);
                    this.handleIncomingMessage(data);
                });
                
                // Subscribe to unread count updates
                this.stompClient.subscribe('/user/queue/unread-updates', (message) => {
                    const data = JSON.parse(message.body);
                    this.updateUnreadBadge(data.unreadCount || 0);
                });
            }
            
            joinRoom(roomId) {
                if (!this.isConnected) return;
                this.stompClient.send('/app/chat.joinRoom', {}, JSON.stringify({ roomId }));
            }
            
            async markMessagesAsRead(roomId) {
                try {
                    await fetch(`/api/chat/rooms/${roomId}/read`, { method: 'POST' });
                    // Cập nhật unread count sau khi đánh dấu đã đọc
                    this.loadUnreadCount();
                } catch (error) {
                    console.error('Error marking as read:', error);
                }
            }
            
            async loadUnreadCount() {
                try {
                    const response = await fetch('/api/chat/unread-count');
                    if (response.ok) {
                        const data = await response.json();
                        this.updateUnreadBadge(data.unreadCount || 0);
                    }
                } catch (error) {
                    console.error('Error loading unread count:', error);
                }
            }
            
            updateUnreadBadge(count) {
                const badge = document.getElementById('messengerUnreadBadge');
                if (badge) {
                    if (count > 0) {
                        badge.textContent = count > 99 ? '99+' : count.toString();
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            }
            
            scrollToBottom() {
                const container = document.getElementById('messengerMessagesContainer');
                container.scrollTop = container.scrollHeight;
            }
            
            formatTime(dateTimeString) {
                if (!dateTimeString) return '';
                const date = new Date(dateTimeString);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);
                
                if (diffMins < 1) return 'Vừa xong';
                if (diffMins < 60) return `${diffMins} phút trước`;
                if (diffHours < 24) return `${diffHours} giờ trước`;
                if (diffDays < 7) return `${diffDays} ngày trước`;
                return date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' });
            }
        }
        
        // Initialize Messenger Chat Widget
        let messengerChatWidget;
        document.addEventListener('DOMContentLoaded', function() {
            // Load user info for chat
            fetch('/api/user/current')
                .then(response => response.json())
                .then(user => {
                    messengerChatWidget = new MessengerChatWidget();
                    messengerChatWidget.currentUserId = user.id;
                    messengerChatWidget.userRole = user.role;
                    
                    // Cập nhật link cho empty state nếu có
                    const emptyChatLink = document.getElementById('messengerEmptyChatLink');
                    if (emptyChatLink) {
                        emptyChatLink.href = messengerChatWidget.getChatUrlByRole();
                    }
                })
                .catch(error => {
                    console.error('Error loading user info:', error);
                    messengerChatWidget = new MessengerChatWidget();
                });
        });
    </script>
</body>
</html>
