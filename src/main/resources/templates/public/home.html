<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf?.token}">
    <meta name="_csrf_header" th:content="${_csrf?.headerName}">
    <title>Book Eat ‚Äì ƒê·∫∑t b√†n online, gi·ªØ ch·ªó ngay</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Home Resy Style CSS -->
    <link th:href="@{/css/home-resy.css}" rel="stylesheet">
    <!-- Login Modal CSS -->
    <link th:href="@{/css/login-modal.css}" rel="stylesheet">
    <style>
      /* CSS Variables for notification bell */
      :root {
        --border-light: #E8E5D8;
        --background-white: #FFFEF7;
        --primary-blue: #4A90E2;
      }
      
      .nearby-section { display:block; }
      .nearby-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(240px,1fr)); gap:16px; }
      .nearby-card { border:1px solid #eee; border-radius:12px; padding:12px; background:#fff; }
      .nearby-card h4 { font-size:1.05rem; margin:0 0 6px; }
      .nearby-meta { font-size:0.9rem; color:#555; display:flex; gap:8px; align-items:center; }
      .nearby-actions { margin-top:8px; }
      
      /* Notification Bell Styles for Home Page */
      .notification-bell-wrapper {
        display: inline-block;
        margin-right: 12px;
      }
      
      .notification-bell-container {
        position: relative;
      }
      
      .notification-bell__trigger {
        background: none;
        border: none;
        color: #333;
        font-size: 18px;
        padding: 8px;
        border-radius: 6px;
        transition: all 0.2s ease;
      }
      
      .notification-bell__trigger:hover {
        background-color: rgba(0, 0, 0, 0.05);
        color: #007bff;
      }
      
      .notification-bell__badge {
        font-size: 10px;
        min-width: 16px;
        height: 16px;
        line-height: 16px;
        padding: 0 4px;
      }
      
      .notification-bell__menu {
        min-width: 320px;
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #e0e0e0;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        border-radius: 8px;
        background-color: #ffffff !important;
        backdrop-filter: none !important;
      }
      
      .notification-bell__menu .dropdown-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #e0e0e0;
        font-weight: 600;
        color: #333;
      }
      
      /* Make "Th√¥ng b√°o" text larger */
      .notification-bell__menu .dropdown-header .notification-bell__all-link {
        color: #333 !important;
        font-size: 1.25rem !important;
        font-weight: 700 !important;
      }
      
      .notification-bell__menu .dropdown-header .notification-bell__all-link i {
        color: #333 !important;
        font-size: 1.25rem !important;
      }
      
      .notification-bell__menu .dropdown-header .badge.bg-primary {
        background-color: #dc3545 !important;
        color: #fff !important;
      }
      
      /* Remove blue from notification links */
      .notification-bell__menu .notification-bell__link {
        color: #333 !important;
        text-decoration: none !important;
      }
      
      .notification-bell__menu .notification-bell__link:hover {
        color: #333 !important;
      }
      
      .notification-bell__menu .notification-bell__link .fw-bold {
        color: #333 !important;
      }
      
      .notification-bell__menu .notification-bell__link .small {
        color: #666 !important;
      }
      
      /* Remove blue from status dot */
      .notification-bell__menu .notification-bell__status {
        color: #dc3545 !important;
      }
      
      /* Remove blue from empty state icon */
      .notification-bell__menu .fa-bell-slash {
        color: #999 !important;
      }
      
      /* Change "Xem t·∫•t c·∫£ th√¥ng b√°o" text color to black */
      .notification-bell__menu .notification-bell__view-all {
        color: #000 !important;
      }
      
      .notification-bell__menu .notification-bell__view-all:hover {
        color: #000 !important;
      }
      
      .notification-bell__menu .notification-bell__view-all i {
        color: #000 !important;
      }
      
      /* Enhanced notification item styling with clear separation */
      .notification-bell__list li {
        list-style: none;
        margin: 0.5rem 0.75rem;
        padding: 0;
      }
      
      .notification-bell__link {
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        border-radius: 12px;
        border: 1px solid var(--border-light, #E8E5D8);
        background-color: var(--background-white, #FFFEF7);
        display: block;
        transition: all 0.2s ease;
        margin: 0;
      }
      
      .notification-bell__link:hover {
        background-color: rgba(74, 144, 226, 0.08);
        border-color: var(--primary-blue, #4A90E2);
        box-shadow: 0 2px 8px rgba(74, 144, 226, 0.15);
        transform: translateY(-1px);
      }
      
      .notification-bell__menu .dropdown-item {
        padding: 12px 16px;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s ease;
      }
      
      .notification-bell__menu .dropdown-item:hover {
        background-color: #f8f9fa;
      }
      
      .notification-bell__menu .dropdown-item:last-child {
        border-bottom: none;
      }
      
      /* Override for notification items in list */
      .notification-bell__menu .notification-bell__list li {
        margin: 0.5rem 0.75rem !important;
        padding: 0 !important;
      }
      
      .notification-bell__menu .notification-bell__link {
        border: 1px solid var(--border-light, #E8E5D8) !important;
        border-radius: 12px !important;
        padding: 0.75rem 1rem !important;
        margin: 0 !important;
        background-color: var(--background-white, #FFFEF7) !important;
        transition: all 0.2s ease !important;
      }
      
      .notification-bell__menu .notification-bell__link:hover {
        border-color: var(--primary-blue, #4A90E2) !important;
        box-shadow: 0 2px 8px rgba(74, 144, 226, 0.15) !important;
        transform: translateY(-1px) !important;
        background-color: rgba(74, 144, 226, 0.08) !important;
      }

      /* AI Search styles */
      .ai-search-section {
        padding: 80px 0;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(241, 246, 253, 0.95) 100%);
      }

      .ai-search-wrapper {
        display: flex;
        flex-wrap: wrap;
        gap: 32px;
        align-items: stretch;
      }

      .ai-search-card, .ai-result-card {
        flex: 1 1 360px;
        background: #fff;
        border-radius: 20px;
        box-shadow: 0 18px 45px rgba(16, 36, 94, 0.08);
        padding: 32px 28px;
        position: relative;
        overflow: hidden;
      }

      .ai-search-card::after {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: 20px;
        padding: 1px;
        background: linear-gradient(135deg, rgba(65, 105, 225, 0.35), rgba(65, 105, 225, 0));
        mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
        mask-composite: exclude;
        pointer-events: none;
      }

      .ai-search-heading {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
      }

      .ai-search-heading i {
        font-size: 26px;
        color: #1b4dd8;
      }

      .ai-search-title {
        margin: 0;
        font-size: 1.55rem;
        font-weight: 600;
        color: #1c2a4b;
      }

      .ai-search-subtitle {
        color: #55627a;
        margin-bottom: 24px;
        line-height: 1.5;
      }

      .ai-search-card label {
        display: block;
        font-weight: 600;
        color: #263760;
        margin-bottom: 10px;
      }

      .ai-query-input {
        width: 100%;
        min-height: 120px;
        border-radius: 16px;
        border: 1px solid #c9d5ec;
        padding: 16px 18px;
        resize: vertical;
        font-size: 1rem;
        color: #1c2a4b;
        box-shadow: inset 0 2px 12px rgba(28, 42, 75, 0.06);
        transition: border 0.2s ease, box-shadow 0.2s ease;
      }

      .ai-query-input:focus {
        border-color: #1b4dd8;
        outline: none;
        box-shadow: 0 0 0 3px rgba(27, 77, 216, 0.15);
      }

      .ai-form-footer {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        align-items: center;
        justify-content: space-between;
        margin-top: 20px;
      }

      .ai-max-results {
        display: flex;
        align-items: center;
        gap: 12px;
        background: rgba(27, 77, 216, 0.08);
        padding: 10px 16px;
        border-radius: 999px;
        color: #193166;
      }

      .ai-max-results input {
        width: 70px;
        border: none;
        background: transparent;
        text-align: center;
        font-weight: 600;
        color: inherit;
      }

      .ai-max-results input:focus {
        outline: none;
      }

      .btn-ai-search {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 12px 28px;
        border-radius: 999px;
        border: none;
        background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
        color: #fff;
        font-weight: 600;
        letter-spacing: 0.4px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
      }

      .btn-ai-search:hover {
        transform: translateY(-1px);
        box-shadow: 0 16px 32px rgba(0, 0, 0, 0.5);
        background: linear-gradient(135deg, #1a1a1a 0%, #333333 100%);
      }

      .ai-status {
        margin-top: 16px;
        font-size: 0.95rem;
        color: #314063;
        min-height: 24px;
      }

      .ai-status.error {
        color: #d64045;
      }

      .ai-result-card {
        padding: 32px 30px 28px;
        display: flex;
        flex-direction: column;
      }

      .ai-summary {
        display: flex;
        flex-wrap: wrap;
        gap: 14px;
        align-items: center;
        margin-bottom: 18px;
        color: #1c2a4b;
      }

      .ai-summary strong {
        font-size: 1.2rem;
      }

      .ai-explanation {
        font-style: italic;
        color: #4a618d;
        margin-bottom: 24px;
      }

      .ai-confidence {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: rgba(27, 77, 216, 0.08);
        color: #1b4dd8;
        border-radius: 999px;
        padding: 6px 14px;
        font-weight: 500;
      }

      .ai-recommendations {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
        gap: 16px;
      }

      .ai-recommendation-card {
        border: 1px solid #e5ecfa;
        border-radius: 16px;
        padding: 18px;
        background: #fdfdff;
        display: flex;
        flex-direction: column;
        gap: 8px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .ai-recommendation-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 16px 28px rgba(31, 60, 136, 0.08);
      }

      .ai-rec-header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        gap: 8px;
      }

      .ai-rec-name {
        font-weight: 600;
        font-size: 1.05rem;
        color: #213152;
        margin: 0;
        flex: 1;
      }

      .ai-rec-rating {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        background: rgba(252, 196, 25, 0.16);
        color: #b27a00;
        padding: 4px 8px;
        border-radius: 999px;
        font-size: 0.9rem;
      }

      .ai-rec-meta {
        font-size: 0.92rem;
        color: #4d5f86;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      .ai-rec-actions {
        display: flex;
        gap: 10px;
        margin-top: 8px;
      }

      .ai-rec-actions a {
        flex: 1;
        text-align: center;
        padding: 8px 10px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.92rem;
        text-decoration: none;
      }

      .ai-rec-actions .primary {
        background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
        color: #fff;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }

      .ai-rec-actions .primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        background: linear-gradient(135deg, #1a1a1a 0%, #333333 100%);
      }

      .ai-rec-actions .secondary {
        background: #edf2fe;
        color: #1c2a4b;
      }

      .ai-empty-state {
        border: 1px dashed #c7d4f6;
        border-radius: 16px;
        padding: 24px;
        text-align: center;
        color: #4a618d;
        background: rgba(237, 242, 254, 0.6);
      }

      .ai-loading-spinner {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        color: #1b4dd8;
      }

      .ai-loading-spinner::before {
        content: "";
        width: 16px;
        height: 16px;
        border: 3px solid rgba(27, 77, 216, 0.3);
        border-top-color: #1b4dd8;
        border-radius: 50%;
        animation: ai-spin 0.8s linear infinite;
      }

      @keyframes ai-spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      @media (max-width: 991px) {
        .ai-search-section {
          padding: 60px 0;
        }

        .ai-search-card, .ai-result-card {
          padding: 24px;
        }
      }

      @media (max-width: 575px) {
        .ai-form-footer {
          flex-direction: column;
          align-items: stretch;
        }

        .ai-max-results {
          justify-content: center;
        }
      }
    </style>
    
</head>
<body>
    
    <!-- Main Header -->
    <header class="header">
        <div class="container">
            <!-- Left Section: Logo only -->
            <div class="header-left">
                <a th:href="@{/}" class="logo">Book Eat</a>
            </div>
            
            <!-- Center Section: Navigation -->
            <div class="header-center">
                <nav>
                    <ul class="nav-menu">
                        <li><a th:href="@{/}" th:classappend="${activeNav == 'home' ? 'active' : ''}">Trang ch·ªß</a></li>
                        <li><a th:href="@{/restaurants}" th:classappend="${activeNav == 'restaurants' ? 'active' : ''}">Nh√† h√†ng</a></li>
                    </ul>
                </nav>
            </div>
            
            <!-- Right Section: Search + Actions -->
            <div class="header-right">
                <!-- Header Search Dropdown -->
                <div class="header-search">
                    <button class="search-toggle" onclick="toggleSearchDropdown()">
                        <i class="fas fa-search"></i>
                    </button>
                    <div class="search-dropdown" id="searchDropdown">
                        <form th:action="@{/restaurants}" method="get" class="search-form">
                            <div class="search-row">
                                <div class="search-field">
                                    <i class="fas fa-search search-icon"></i>
                                    <input type="text" 
                                           name="search" 
                                           placeholder="T√™n nh√† h√†ng, ƒë·ªãa ch·ªâ..." 
                                           class="search-input"
                                           th:value="${search}">
                                </div>
                            </div>
                            <div class="search-row">
                                <div class="search-field">
                                    <i class="fas fa-utensils search-icon"></i>
                                    <select name="cuisineType" class="search-select">
                                        <option value="">Lo·∫°i ·∫©m th·ª±c</option>
                                        <option value="Vietnamese" th:selected="${cuisineType == 'Vietnamese'}">Vi·ªát Nam</option>
                                        <option value="Korean" th:selected="${cuisineType == 'Korean'}">H√†n Qu·ªëc</option>
                                        <option value="Japanese" th:selected="${cuisineType == 'Japanese'}">Nh·∫≠t B·∫£n</option>
                                        <option value="Chinese" th:selected="${cuisineType == 'Chinese'}">Trung Qu·ªëc</option>
                                        <option value="Western" th:selected="${cuisineType == 'Western'}">Ph∆∞∆°ng T√¢y</option>
                                        <option value="Thai" th:selected="${cuisineType == 'Thai'}">Th√°i Lan</option>
                                        <option value="Italian" th:selected="${cuisineType == 'Italian'}">√ù</option>
                                    </select>
                                </div>
                                <div class="search-field">
                                    <i class="fas fa-dollar-sign search-icon"></i>
                                    <select name="priceRange" class="search-select">
                                        <option value="">Kho·∫£ng gi√°</option>
                                        <option value="under-50k" th:selected="${priceRange == 'under-50k'}">D∆∞·ªõi 50k</option>
                                        <option value="50k-100k" th:selected="${priceRange == '50k-100k'}">50k - 100k</option>
                                        <option value="100k-200k" th:selected="${priceRange == '100k-200k'}">100k - 200k</option>
                                        <option value="over-200k" th:selected="${priceRange == 'over-200k'}">Tr√™n 200k</option>
                                    </select>
                                </div>
                            </div>
                            <div class="search-actions">
                                <button type="submit" class="search-submit">
                                    <i class="fas fa-search"></i>
                                    T√¨m ki·∫øm
                                </button>
                                <button type="button" class="search-clear" onclick="clearSearch()">
                                    <i class="fas fa-times"></i>
                                    X√≥a
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="header-actions">
                <!-- Guest User Actions -->
                <button type="button" class="btn-resy-outline" data-bs-toggle="modal" data-bs-target="#loginModal" sec:authorize="!isAuthenticated()">ƒêƒÉng nh·∫≠p</button>
                <a th:href="@{/auth/register}" class="btn-resy" sec:authorize="!isAuthenticated()">ƒêƒÉng k√Ω</a>
                
                <!-- Authenticated User Actions -->
                <div sec:authorize="isAuthenticated()" class="user-actions">
                    <!-- Notification Bell -->
                    <div class="notification-bell-wrapper">
                        <div th:insert="~{fragments/notification-bell :: notification-bell}"></div>
                    </div>
                    
                    <!-- Restaurant Owner Dashboard -->
                    <a th:href="@{/restaurant-owner/dashboard}" class="btn-resy" sec:authorize="hasRole('RESTAURANT_OWNER')">
                        <i class="fas fa-tachometer-alt"></i>
                        Dashboard
                    </a>
                    
                    <!-- Admin Dashboard -->
                    <a th:href="@{/admin/dashboard}" class="btn-resy" sec:authorize="hasRole('ADMIN')">
                        <i class="fas fa-cog"></i>
                        Admin
                    </a>
                    
                    <!-- User Profile Dropdown -->
                    <div class="user-dropdown">
                        <button class="btn-resy-outline dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-user-circle"></i>
                            <span sec:authentication="name">User</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li>
                                <a class="dropdown-item" th:href="@{/auth/profile}">
                                    <i class="fas fa-user me-2"></i>
                                    Profile
                                </a>
                            </li>
                            <li sec:authorize="hasRole('CUSTOMER')">
                                <a class="dropdown-item" th:href="@{/booking/my}">
                                    <i class="fas fa-calendar-check me-2"></i>
                                    My Reservations
                                </a>
                            </li>
                            <li sec:authorize="hasRole('CUSTOMER')">
                                <a class="dropdown-item" th:href="@{/customer/favorites}">
                                    <i class="fas fa-star me-2"></i>
                                    Favorites
                                </a>
                            </li>
                            <li sec:authorize="hasRole('RESTAURANT_OWNER')">
                                <a class="dropdown-item" th:href="@{/restaurant-owner/dashboard}">
                                    <i class="fas fa-tachometer-alt me-2"></i>
                                    Restaurant Dashboard
                                </a>
                            </li>
                            <li sec:authorize="hasRole('ADMIN')">
                                <a class="dropdown-item" th:href="@{/admin/dashboard}">
                                    <i class="fas fa-cog me-2"></i>
                                    Admin Dashboard
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <form th:action="@{/logout}" method="post" class="d-inline">
                                    <button type="submit" class="dropdown-item border-0 bg-transparent w-100 text-start">
                                        <i class="fas fa-sign-out-alt me-2"></i>
                                        ƒêƒÉng xu·∫•t
                                    </button>
                                </form>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Video Hero Section -->
    <section class="video-hero" id="home">
        <div class="video-background">
            <!-- YouTube Video Embed -->
            <iframe 
                src="https://www.youtube.com/embed/xPPLbEFbCAo?autoplay=1&mute=1&loop=1&playlist=xPPLbEFbCAo&controls=0&showinfo=0&rel=0&modestbranding=1"
                frameborder="0"
                allow="autoplay; encrypted-media"
                allowfullscreen>
            </iframe>
        </div>
        <div class="video-overlay">
            <div class="video-content">
                <h1 class="video-title">Kh√°m ph√° ·∫©m th·ª±c t·∫°i Book Eat</h1>
                <p class="video-subtitle">ƒê·∫∑t b√†n t·∫°i nh·ªØng nh√† h√†ng t·ªët nh·∫•t v·ªõi Book Eat</p>
                
                
                <div class="video-buttons">
                    <a th:href="@{/restaurants}" class="btn-video">
                        <i class="fas fa-utensils"></i>
                        Kh√°m ph√° ngay
                    </a>
                    <a href="#intro" class="btn-video-outline">
                        <i class="fas fa-play"></i>
                        Xem th√™m
                    </a>
                </div>
            </div>
        </div>
    </section>

    <!-- AI Recommendation Section -->
    <section class="ai-search-section" id="ai-search">
        <div class="container">
            <div class="ai-search-wrapper">
                <div class="ai-search-card">
                    <div class="ai-search-heading">
                        <i class="fas fa-magic"></i>
                        <h2 class="ai-search-title">Tr·ª£ l√Ω AI g·ª£i √Ω nh√† h√†ng</h2>
                    </div>
                    <p class="ai-search-subtitle">
                        M√¥ t·∫£ mong mu·ªën c·ªßa b·∫°n v√† ƒë·ªÉ Book Eat AI ƒë·ªÅ xu·∫•t nh·ªØng l·ª±a ch·ªçn ph√π h·ª£p nh·∫•t d·ª±a tr√™n d·ªØ li·ªáu nh√† h√†ng th·ª±c t·∫ø.
                    </p>
                    <form id="aiSearchForm" novalidate>
                        <div class="mb-3">
                            <label for="aiSearchQuery">B·∫°n mu·ªën ƒÉn g√¨ h√¥m nay?</label>
                            <textarea id="aiSearchQuery"
                                      class="ai-query-input"
                                      placeholder="V√≠ d·ª•: T√¥i mu·ªën ƒÉn ph·ªü b√≤ cho 2 ng∆∞·ªùi ·ªü qu·∫≠n 1, t·∫ßm 150k m·ªói ng∆∞·ªùi"
                                      minlength="5"
                                      required></textarea>
                        </div>
                        <div class="ai-form-footer">
                            <div class="ai-max-results">
                                <i class="fas fa-list-ol"></i>
                                <span>S·ªë k·∫øt qu·∫£:</span>
                                <input type="number" id="aiMaxResults" min="1" max="10" value="5" aria-label="S·ªë k·∫øt qu·∫£ mong mu·ªën">
                            </div>
                            <button type="submit" class="btn-ai-search">
                                <i class="fas fa-wand-magic-sparkles"></i>
                                T√¨m nh√† h√†ng b·∫±ng AI
                            </button>
                        </div>
                        <div class="ai-status" id="aiSearchStatus" role="status" aria-live="polite"></div>
                    </form>
                </div>

                <div class="ai-result-card" id="aiResultsPanel" hidden>
                    <div class="ai-summary" id="aiResultsSummary"></div>
                    <!-- AI Interpretation Box -->
                    <div class="ai-interpretation-box" id="aiInterpretationBox" style="display: none; background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%); border-radius: 15px; padding: 20px; margin: 20px 0; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);">
                        <div style="display: flex; align-items: start; gap: 15px;">
                            <i class="fas fa-lightbulb" style="font-size: 1.8rem; color: #ffd700; margin-top: 5px;"></i>
                            <div style="flex: 1;">
                                <h5 style="color: white; font-weight: 600; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-robot"></i>
                                    G·ª£i √Ω c·ªßa AI
                                </h5>
                                <p id="aiInterpretationText" style="color: white; font-size: 1.1rem; line-height: 1.6; margin-bottom: 0;"></p>
                                <div id="aiSuggestedFoods" style="margin-top: 15px; display: none;">
                                    <small style="color: rgba(255,255,255,0.8); font-weight: 500; display: block; margin-bottom: 8px;">M√≥n ƒÉn ƒë∆∞·ª£c ƒë·ªÅ xu·∫•t:</small>
                                    <div id="aiSuggestedFoodsList" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="ai-explanation" id="aiResultsExplanation"></div>
                    <div class="ai-confidence" id="aiResultsConfidence" hidden>
                        <i class="fas fa-signal"></i>
                        <span></span>
                    </div>
                    <div class="ai-recommendations" id="aiRecommendations"></div>
                    <div class="ai-empty-state" id="aiEmptyState" hidden>
                        <i class="fas fa-info-circle me-2"></i>
                        <span>Ch∆∞a t√¨m th·∫•y nh√† h√†ng ph√π h·ª£p v·ªõi y√™u c·∫ßu n√†y. B·∫°n c√≥ th·ªÉ th·ª≠ m√¥ t·∫£ c·ª• th·ªÉ h∆°n.</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Intro Section -->
    <section class="intro-section" id="intro">
        <div class="container">
            <div class="intro-container">
                <div class="intro-content">
                    <h2>N·ªÅn t·∫£ng ƒë·∫∑t b√†n nh√† h√†ng h√†ng ƒë·∫ßu Vi·ªát Nam</h2>
                    <p>
                        Book Eat l√† gi·∫£i ph√°p ƒë·∫∑t b√†n th√¥ng minh, k·∫øt n·ªëi b·∫°n v·ªõi h√†ng ng√†n nh√† h√†ng ch·∫•t l∆∞·ª£ng cao 
                        tr√™n to√†n qu·ªëc. Ch√∫ng t√¥i cam k·∫øt mang ƒë·∫øn tr·∫£i nghi·ªám ·∫©m th·ª±c tuy·ªát v·ªùi nh·∫•t cho m·ªçi th·ª±c kh√°ch.
                    </p>
                    <p>
                        V·ªõi c√¥ng ngh·ªá hi·ªán ƒë·∫°i v√† d·ªãch v·ª• chuy√™n nghi·ªáp, vi·ªác ƒë·∫∑t b√†n ch∆∞a bao gi·ªù d·ªÖ d√†ng ƒë·∫øn th·∫ø. 
                        Ch·ªâ v√†i c√∫ click, b·∫°n ƒë√£ c√≥ th·ªÉ ƒë·∫£m b·∫£o ch·ªó ng·ªìi t·∫°i nh√† h√†ng y√™u th√≠ch.
                    </p>
                    
                    <div class="intro-features">
                        <div class="intro-feature">
                            <div class="intro-feature-icon">
                                <i class="fas fa-bolt"></i>
                            </div>
                            <div class="intro-feature-text">
                                <h4>ƒê·∫∑t b√†n nhanh ch√≥ng</h4>
                                <p>X√°c nh·∫≠n t·ª©c th√¨ trong v√†i gi√¢y</p>
                            </div>
                        </div>
                        
                        <div class="intro-feature">
                            <div class="intro-feature-icon">
                                <i class="fas fa-shield-alt"></i>
                                </div>
                            <div class="intro-feature-text">
                                <h4>An to√†n & B·∫£o m·∫≠t</h4>
                                <p>Th√¥ng tin ƒë∆∞·ª£c m√£ h√≥a b·∫£o m·∫≠t</p>
                            </div>
                        </div>
                        
                        <div class="intro-feature">
                            <div class="intro-feature-icon">
                                <i class="fas fa-star"></i>
                                </div>
                            <div class="intro-feature-text">
                                <h4>Ch·∫•t l∆∞·ª£ng ƒë·∫£m b·∫£o</h4>
                                <p>Nh√† h√†ng ƒë∆∞·ª£c ch·ªçn l·ªçc k·ªπ c√†ng</p>
                            </div>
                        </div>
                        
                        <div class="intro-feature">
                            <div class="intro-feature-icon">
                                <i class="fas fa-headset"></i>
                            </div>
                            <div class="intro-feature-text">
                                <h4>H·ªó tr·ª£ 24/7</h4>
                                <p>Lu√¥n s·∫µn s√†ng h·ªó tr·ª£ b·∫°n</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                <div class="intro-image">
                    <!-- YouTube Video Embed -->
                    <iframe 
                        src="https://www.youtube.com/embed/lcU3pruVyUw?autoplay=1&mute=1&loop=1&playlist=lcU3pruVyUw&controls=0&showinfo=0&rel=0&modestbranding=1"
                        frameborder="0"
                        allow="autoplay; encrypted-media"
                        allowfullscreen>
                    </iframe>
                    <div class="intro-video-overlay"></div>
                    <div class="intro-stats">
                        <div class="intro-stat">
                            <span class="intro-stat-number">1,200+</span>
                            <span class="intro-stat-label">Nh√† h√†ng</span>
                        </div>
                        <div class="intro-stat">
                            <span class="intro-stat-number">50K+</span>
                            <span class="intro-stat-label">Kh√°ch h√†ng</span>
                        </div>
                        <div class="intro-stat">
                            <span class="intro-stat-number">4.8</span>
                            <span class="intro-stat-label">ƒê√°nh gi√°</span>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        </section>

    <!-- Recommended Near You (dynamic) - Location feature enabled -->
    <section class="nearby-section" id="nearby">
        <div class="container">
            <div class="section-header">
                <h2 class="section-title">G·ª£i √Ω g·∫ßn b·∫°n</h2>
                <p class="section-subtitle">Nh√† h√†ng g·∫ßn v·ªã tr√≠ hi·ªán t·∫°i c·ªßa b·∫°n</p>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="text-muted small" id="nearbySummary"></div>
                <button class="btn btn-sm btn-outline-secondary" id="btnDisableLocation" type="button">T·∫Øt ƒë·ªãnh v·ªã</button>
            </div>
            <div id="nearbyGrid" class="nearby-grid"></div>
        </div>
    </section>

    <!-- Popular Restaurants - New Design -->
    <section class="featured-restaurants-section" id="restaurants">
        <div class="container">
            <div class="featured-section-header">
                <div class="featured-header-content">
                    <h2 class="featured-title">Nh√† h√†ng n·ªïi b·∫≠t</h2>
                    <p class="featured-subtitle">Kh√°m ph√° nh·ªØng ƒë·ªãa ƒëi·ªÉm ·∫©m th·ª±c ƒë∆∞·ª£c y√™u th√≠ch nh·∫•t</p>
                </div>
                <a th:href="@{/restaurants}" class="featured-view-all">
                    Xem t·∫•t c·∫£
                    <i class="fas fa-arrow-right"></i>
                </a>
            </div>
            
            <!-- Empty State -->
            <div class="featured-empty-state" th:if="${#lists.isEmpty(popularRestaurants)}">
                <div class="empty-icon">
                    <i class="fas fa-utensils"></i>
                </div>
                <h3>ƒêang c·∫≠p nh·∫≠t</h3>
                <p>D·ªØ li·ªáu nh√† h√†ng n·ªïi b·∫≠t ƒëang ƒë∆∞·ª£c c·∫≠p nh·∫≠t. Vui l√≤ng quay l·∫°i sau.</p>
                <a th:href="@{/restaurants}" class="btn-featured-primary">Xem t·∫•t c·∫£ nh√† h√†ng</a>
            </div>

            <!-- Featured Restaurants Grid -->
            <div class="featured-restaurants-grid" th:if="${!#lists.isEmpty(popularRestaurants)}">
                <article class="featured-restaurant-card" 
                         th:each="restaurant, iterStat : ${popularRestaurants}" 
                         th:if="${iterStat.index < 3}"
                         th:data-restaurant-id="${restaurant.id}"
                         onclick="const id = this.getAttribute('data-restaurant-id'); if(id) window.location.href = '/restaurants/' + id;"
                         style="cursor: pointer;">
                    <!-- Card Image -->
                    <div class="featured-card-image">
                        <img th:if="${restaurant.hasCoverImage()}" 
                             th:src="${restaurant.coverImageUrl}"
                             th:alt="${restaurant.name}"
                             loading="lazy"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <div class="featured-card-image-placeholder" 
                             th:style="'background: ' + ${restaurant.fallbackGradient}"
                             th:if="${!restaurant.hasCoverImage()}">
                            <i class="fas fa-utensils"></i>
                        </div>
                        
                        <!-- Badge -->
                        <div class="featured-card-badge" 
                             th:text="${restaurant.badge}"
                             th:if="${restaurant.badge != null}"></div>
                        
                        <!-- Image Overlay on Hover -->
                        <div class="featured-card-overlay">
                            <span class="overlay-text">Xem chi ti·∫øt</span>
                        </div>
                    </div>
                    
                    <!-- Card Content -->
                    <div class="featured-card-content">
                        <div class="featured-card-header">
                            <h3 class="featured-card-title" th:text="${restaurant.name}">T√™n nh√† h√†ng</h3>
                            <div class="featured-card-rating">
                                <div class="featured-stars">
                                    <i class="fas fa-star featured-star-filled"
                                       th:each="star : ${#numbers.sequence(1, 5)}"
                                       th:if="${star <= restaurant.roundedRating}"></i>
                                    <i class="fas fa-star featured-star-empty"
                                       th:each="star : ${#numbers.sequence(1, 5)}"
                                       th:if="${star > restaurant.roundedRating}"></i>
                                </div>
                                <span class="featured-rating-score" 
                                      th:text="${restaurant.formattedRating}">5.0</span>
                            </div>
                        </div>
                        
                        <div class="featured-card-meta">
                            <span class="featured-cuisine-type" 
                                  th:text="${#strings.defaultString(restaurant.cuisineType, 'ƒêang c·∫≠p nh·∫≠t')}">Italian</span>
                            <span class="featured-meta-separator" th:if="${restaurant.address != null and !#strings.isEmpty(restaurant.address)}">‚Ä¢</span>
                            <span class="featured-location" 
                                  th:text="${restaurant.address}"
                                  th:if="${restaurant.address != null and !#strings.isEmpty(restaurant.address)}">ƒê·ªãa ch·ªâ</span>
                        </div>
                        
                        <div class="featured-card-footer">
                            <div class="featured-card-stats">
                                <span class="featured-review-count" 
                                      th:text="|${restaurant.reviewCount} ƒë√°nh gi√°|">20 ƒë√°nh gi√°</span>
                                <span class="featured-price" th:text="${restaurant.priceLabel}">‚Ç´200,000</span>
                            </div>
                            <a th:href="@{/restaurants/{id}(id=${restaurant.id})}" 
                               class="featured-book-button"
                               onclick="event.stopPropagation();">
                                <i class="fas fa-calendar-check"></i>
                                ƒê·∫∑t b√†n ngay
                            </a>
                        </div>
                    </div>
                </article>
            </div>
        </div>
    </section>

    <!-- Categories Section -->
    <section class="categories-section" id="categories">
        <div class="container">
            <div class="section-header">
                <h2 class="section-title">Kh√°m ph√° theo lo·∫°i h√¨nh</h2>
                <p class="section-subtitle">T√¨m nh√† h√†ng ph√π h·ª£p v·ªõi s·ªü th√≠ch c·ªßa b·∫°n</p>
            </div>
            
            <div class="category-grid">
                <div class="category-card">
                    <div class="category-icon">
                        <i class="fas fa-utensils"></i>
                    </div>
                    <h3 class="category-name">Fine Dining</h3>
                    <p class="category-count">45 nh√† h√†ng</p>
                </div>
                
                <div class="category-card">
                    <div class="category-icon">
                        <i class="fas fa-pizza-slice"></i>
                    </div>
                    <h3 class="category-name">Casual Dining</h3>
                    <p class="category-count">128 nh√† h√†ng</p>
                </div>
                
                <div class="category-card">
                    <div class="category-icon">
                        <i class="fas fa-coffee"></i>
                    </div>
                    <h3 class="category-name">Caf√© & Bistro</h3>
                    <p class="category-count">67 nh√† h√†ng</p>
                </div>
                
                <div class="category-card">
                    <div class="category-icon">
                        <i class="fas fa-building"></i>
                    </div>
                    <h3 class="category-name">Rooftop</h3>
                    <p class="category-count">23 nh√† h√†ng</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Restaurant Partners Section -->
    <section class="partners-section">
        <div class="container">
            <div class="partners-intro">
                <h2>ƒê·ªëi t√°c nh√† h√†ng c·ªßa ch√∫ng t√¥i</h2>
                <p>H·ª£p t√°c v·ªõi nh·ªØng th∆∞∆°ng hi·ªáu ·∫©m th·ª±c h√†ng ƒë·∫ßu ƒë·ªÉ mang ƒë·∫øn tr·∫£i nghi·ªám tuy·ªát v·ªùi nh·∫•t</p>
                    </div>
                    
            <div class="partners-grid">
                <!-- Partner 1 -->
                <div class="partner-card">
                    <div class="partner-logo" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <i class="fas fa-crown"></i>
                    </div>
                    <h3 class="partner-name">Le Cordon Bleu</h3>
                    <p class="partner-type">Fine Dining ‚Ä¢ French Cuisine</p>
                    <div class="partner-stats">
                        <div class="partner-stat">
                            <div class="partner-stat-number">4.9</div>
                            <div class="partner-stat-label">Rating</div>
                            </div>
                        <div class="partner-stat">
                            <div class="partner-stat-number">350+</div>
                            <div class="partner-stat-label">Reviews</div>
                                </div>
                                </div>
                </div>
                
                <!-- Partner 2 -->
                <div class="partner-card">
                    <div class="partner-logo" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <i class="fas fa-fire"></i>
                    </div>
                    <h3 class="partner-name">Sushi Master</h3>
                    <p class="partner-type">Japanese ‚Ä¢ Premium</p>
                    <div class="partner-stats">
                        <div class="partner-stat">
                            <div class="partner-stat-number">4.8</div>
                            <div class="partner-stat-label">Rating</div>
                        </div>
                        <div class="partner-stat">
                            <div class="partner-stat-number">280+</div>
                            <div class="partner-stat-label">Reviews</div>
                            </div>
                        </div>
                    </div>
                    
                <!-- Partner 3 -->
                <div class="partner-card">
                    <div class="partner-logo" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <i class="fas fa-leaf"></i>
                    </div>
                    <h3 class="partner-name">Green Garden</h3>
                    <p class="partner-type">Vegetarian ‚Ä¢ Organic</p>
                    <div class="partner-stats">
                        <div class="partner-stat">
                            <div class="partner-stat-number">4.7</div>
                            <div class="partner-stat-label">Rating</div>
                            </div>
                        <div class="partner-stat">
                            <div class="partner-stat-number">195+</div>
                            <div class="partner-stat-label">Reviews</div>
                                </div>
                                </div>
                            </div>
                
                <!-- Partner 4 -->
                <div class="partner-card">
                    <div class="partner-logo" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                        <i class="fas fa-pizza-slice"></i>
                    </div>
                    <h3 class="partner-name">Bella Italia</h3>
                    <p class="partner-type">Italian ‚Ä¢ Family Style</p>
                    <div class="partner-stats">
                        <div class="partner-stat">
                            <div class="partner-stat-number">4.6</div>
                            <div class="partner-stat-label">Rating</div>
                        </div>
                        <div class="partner-stat">
                            <div class="partner-stat-number">420+</div>
                            <div class="partner-stat-label">Reviews</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Partners CTA -->
            <div class="partners-cta">
                <h3>B·∫°n l√† ch·ªß nh√† h√†ng?</h3>
                <p>H·ª£p t√°c v·ªõi Book Eat ƒë·ªÉ ti·∫øp c·∫≠n h√†ng ng√†n kh√°ch h√†ng ti·ªÅm nƒÉng m·ªói ng√†y</p>
                <a th:href="@{/auth/register}" class="btn-partner">
                    <i class="fas fa-handshake"></i>
                    Tr·ªü th√†nh ƒë·ªëi t√°c
                </a>
                </div>
            </div>
        </section>

    <!-- Footer Video CTA -->
    <section class="footer-video-cta">
        <div class="footer-video-background">
            <!-- YouTube Video Embed -->
            <iframe 
                src="https://www.youtube.com/embed/lcU3pruVyUw?autoplay=1&mute=1&loop=1&playlist=lcU3pruVyUw&controls=0&showinfo=0&rel=0&modestbranding=1"
                frameborder="0"
                allow="autoplay; encrypted-media"
                allowfullscreen>
            </iframe>
        </div>
        <div class="footer-video-overlay">
            <div class="footer-video-content">
                <h2 class="footer-video-title">B·∫Øt ƒë·∫ßu tr·∫£i nghi·ªám ngay h√¥m nay</h2>
                <p class="footer-video-subtitle">ƒê·∫∑t b√†n nhanh ch√≥ng, d·ªÖ d√†ng v√† mi·ªÖn ph√≠</p>
                <div class="footer-video-buttons">
                    <a th:href="@{/restaurants}" class="btn-footer-video">
                        <i class="fas fa-calendar-check"></i>
                        ƒê·∫∑t b√†n ngay
                    </a>
                    <a th:href="@{/auth/register}" class="btn-footer-video-outline">
                        <i class="fas fa-store"></i>
                        D√†nh cho nh√† h√†ng
                    </a>
                </div>
            </div>
        </div>
    </section>

    <!-- Resy Footer -->
    <div th:replace="~{fragments/resy-footer :: resy-footer}"></div>

    <!-- Resy Scripts -->
    <div th:replace="~{fragments/resy-scripts :: resy-scripts}"></div>

    <!-- Location Modal Fragment -->
    <div th:insert="~{fragments/location-modal :: location-modal}"></div>
    
    <!-- Login Modal Fragment -->
    <div th:insert="~{fragments/login-modal :: login-modal}"></div>

    <!-- Location Feature Bootstrapper -->
    <script th:inline="javascript">
      window.APP_CTX = window.APP_CTX || {};
      APP_CTX.authenticated = /*[[${#authorization.expression('isAuthenticated()')}]]*/ false;
      APP_CTX.isRestaurantOwner = /*[[${#authorization.expression('hasRole(''RESTAURANT_OWNER'')')}]]*/ false;
      APP_CTX.showLocationPrompt = /*[[${session.SHOW_LOCATION_PROMPT != null ? session.SHOW_LOCATION_PROMPT : false}]]*/ false;
      APP_CTX.baseUrl = /*[[@{/}]]*/ '/';
      console.log('üöÄ APP_CTX initialized:', {
        authenticated: APP_CTX.authenticated,
        isRestaurantOwner: APP_CTX.isRestaurantOwner,
        showLocationPrompt: APP_CTX.showLocationPrompt,
        sessionValue: /*[[${session.SHOW_LOCATION_PROMPT}]]*/ null
      });
    </script>
    <script th:src="@{/js/ai-search.js}"></script>
    <script th:src="@{/js/location.js}"></script>
    
    <!-- Header Search JavaScript -->
    <script>
        function toggleSearchDropdown() {
            const dropdown = document.getElementById('searchDropdown');
            const isOpen = dropdown.classList.contains('show');
            
            // Close all other dropdowns first
            document.querySelectorAll('.search-dropdown').forEach(dd => {
                dd.classList.remove('show');
            });
            
            // Toggle current dropdown
            if (!isOpen) {
                dropdown.classList.add('show');
                // Focus on search input when opened
                setTimeout(() => {
                    const searchInput = dropdown.querySelector('.search-input');
                    if (searchInput) {
                        searchInput.focus();
                    }
                }, 100);
            }
        }
        
        function clearSearch() {
            const form = document.querySelector('.search-form');
            if (form) {
                form.reset();
            }
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const searchContainer = document.querySelector('.header-search');
            const dropdown = document.getElementById('searchDropdown');
            
            if (!searchContainer.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });
        
        // Close dropdown on escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const dropdown = document.getElementById('searchDropdown');
                dropdown.classList.remove('show');
            }
        });
        
        // Login Modal Functions
        function closeLoginModal() {
            const modal = document.getElementById('loginModal');
            if (modal) {
                const bsModal = bootstrap.Modal.getInstance(modal);
                if (bsModal) {
                    bsModal.hide();
                }
            }
        }
        
        function openRegisterModal() {
            // This function can be implemented when register modal is created
            console.log('Opening register modal...');
        }
        
        // Auto-focus on username input when modal opens
        document.addEventListener('shown.bs.modal', function(event) {
            if (event.target.id === 'loginModal') {
                const usernameInput = event.target.querySelector('#username');
                if (usernameInput) {
                    usernameInput.focus();
                }
            }
        });
        
    </script>
    
    <!-- Messenger Style Chat Widget -->
    <div id="messenger-chat-widget" class="messenger-chat-widget" sec:authorize="isAuthenticated() and (hasRole('CUSTOMER') or hasRole('customer'))">
        <!-- Chat Toggle Button -->
        <button class="messenger-chat-toggle" id="messengerChatToggle" title="Chat v·ªõi nh√† h√†ng">
            <i class="fas fa-comments"></i>
            <span class="messenger-chat-pulse"></span>
            <span class="messenger-unread-badge" id="messengerUnreadBadge" style="display: none;">0</span>
        </button>
        
        <!-- Chat Window (Messenger Style) -->
        <div id="messengerChatWindow" class="messenger-chat-window" style="display: none;">
            <!-- Chat Header -->
            <div class="messenger-chat-header">
                <div class="messenger-chat-title">
                    <i class="fas fa-comments"></i>
                    <span>Tin nh·∫Øn</span>
                </div>
                <div class="messenger-chat-controls">
                    <button class="messenger-btn-minimize" id="messengerMinimizeBtn" title="Thu nh·ªè">
                        <i class="fas fa-minus"></i>
                    </button>
                    <button class="messenger-btn-close" id="messengerCloseBtn" title="ƒê√≥ng">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <!-- Chat Content -->
            <div class="messenger-chat-content">
                <!-- Rooms List View -->
                <div id="messengerRoomsView" class="messenger-rooms-view">
                    <div class="messenger-rooms-header">
                        <h6>Xem t·∫•t c·∫£</h6>
                        <button class="messenger-btn-new-chat" id="messengerNewChatBtn" title="Chat m·ªõi">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    
                    <div id="messengerRoomsLoading" class="messenger-loading">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        <span>ƒêang t·∫£i...</span>
                    </div>
                    
                    <div id="messengerRoomsList" class="messenger-rooms-list" style="display: none;">
                        <!-- Rooms will be loaded here -->
                    </div>
                    
                    <div id="messengerRoomsEmpty" class="messenger-empty" style="display: none;">
                        <i class="fas fa-inbox"></i>
                        <p>Ch∆∞a c√≥ cu·ªôc tr√≤ chuy·ªán n√†o</p>
                        <a th:href="@{/customer/chat}" class="messenger-btn-link">B·∫Øt ƒë·∫ßu chat m·ªõi</a>
                    </div>
                </div>
                
                <!-- Chat Interface View -->
                <div id="messengerChatView" class="messenger-chat-view" style="display: none;">
                    <div class="messenger-chat-view-header">
                        <button class="messenger-btn-back" id="messengerBackBtn">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="messenger-chat-info">
                            <h6 id="messengerChatRoomName">Nh√† h√†ng</h6>
                            <small id="messengerChatStatus">ƒêang online</small>
                        </div>
                    </div>
                    
                    <div id="messengerMessagesContainer" class="messenger-messages-container">
                        <!-- Messages will be loaded here -->
                    </div>
                    
                    <div id="messengerTypingIndicator" class="messenger-typing-indicator" style="display: none;">
                        <div class="messenger-typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                        <span>ƒêang g√µ...</span>
                    </div>
                    
                    <div class="messenger-message-input">
                        <input type="text" id="messengerMessageInput" class="messenger-input" 
                               placeholder="Nh·∫≠p tin nh·∫Øn..." maxlength="1000">
                        <button id="messengerSendBtn" class="messenger-btn-send" title="G·ª≠i">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Messenger Chat Widget CSS -->
    <style>
        /* Messenger Style Chat Widget */
        .messenger-chat-widget {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 1000;
            font-family: 'Inter', sans-serif;
        }

        .messenger-chat-toggle {
            width: 60px;
            height: 60px;
            background: #FFFFFF;
            border: 2px solid #000000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            position: relative;
            padding: 0;
        }

        .messenger-chat-toggle:hover {
            transform: scale(1.1);
            background: #000000;
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.5);
        }

        .messenger-chat-toggle:hover i {
            color: #FFFFFF;
        }

        .messenger-chat-toggle i {
            font-size: 24px;
            color: #000000;
            z-index: 2;
            transition: color 0.3s;
        }

        .messenger-chat-pulse {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.3);
            animation: pulse-ring 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .messenger-unread-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #000000;
            color: #FFFFFF;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 11px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3;
            border: 2px solid #FFFFFF;
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }

        /* Messenger Chat Window */
        .messenger-chat-window {
            position: absolute;
            bottom: 0;
            right: 70px;
            width: 380px;
            height: 600px;
            background: #FFFFFF;
            border: 2px solid #000000;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .messenger-chat-header {
            background: #FFFFFF;
            border-bottom: 2px solid #000000;
            color: #000000;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .messenger-chat-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 16px;
        }

        .messenger-chat-controls {
            display: flex;
            gap: 8px;
        }

        .messenger-btn-minimize,
        .messenger-btn-close {
            background: #FFFFFF;
            border: 2px solid #000000;
            color: #000000;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .messenger-btn-minimize:hover,
        .messenger-btn-close:hover {
            background: #000000;
            color: #FFFFFF;
        }

        .messenger-chat-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Rooms View */
        .messenger-rooms-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .messenger-rooms-header {
            padding: 16px 20px;
            border-bottom: 2px solid #000000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .messenger-rooms-header h6 {
            margin: 0;
            font-weight: 600;
            font-size: 16px;
            color: #111827;
        }

        .messenger-btn-new-chat {
            background: #000000;
            border: 2px solid #000000;
            color: #FFFFFF;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .messenger-btn-new-chat:hover {
            background: #FFFFFF;
            color: #000000;
        }

        .messenger-loading,
        .messenger-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
        }

        .messenger-loading {
            gap: 12px;
        }

        .messenger-empty i {
            font-size: 48px;
            color: #9CA3AF;
            margin-bottom: 16px;
        }

        .messenger-empty p {
            color: #6B7280;
            margin-bottom: 16px;
        }

        .messenger-btn-link {
            color: #000000;
            text-decoration: none;
            font-weight: 500;
            border-bottom: 1px solid #000000;
        }

        .messenger-btn-link:hover {
            border-bottom: 2px solid #000000;
        }

        .messenger-rooms-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
        }

        .messenger-room-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid #E5E7EB;
        }

        .messenger-room-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .messenger-room-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #FFFFFF;
            border: 2px solid #000000;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .messenger-room-avatar i {
            color: #000000;
            font-size: 20px;
        }

        .messenger-room-info {
            flex: 1;
            min-width: 0;
        }

        .messenger-room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .messenger-room-name {
            font-weight: 600;
            font-size: 15px;
            color: #111827;
            margin: 0;
        }

        .messenger-room-time {
            font-size: 12px;
            color: #6B7280;
            white-space: nowrap;
        }

        .messenger-room-message {
            font-size: 14px;
            color: #6B7280;
            margin: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .messenger-room-unread {
            background: #000000;
            color: #FFFFFF;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: 600;
            min-width: 18px;
            text-align: center;
            margin-left: 8px;
        }

        /* Chat View */
        .messenger-chat-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .messenger-chat-view-header {
            padding: 12px 16px;
            border-bottom: 2px solid #000000;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .messenger-btn-back {
            background: #FFFFFF;
            border: 2px solid #000000;
            color: #000000;
            font-size: 18px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .messenger-btn-back:hover {
            background: #000000;
            color: #FFFFFF;
        }

        .messenger-chat-info h6 {
            margin: 0;
            font-weight: 600;
            font-size: 15px;
            color: #111827;
        }

        .messenger-chat-info small {
            color: #6B7280;
            font-size: 12px;
        }

        .messenger-messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: #FFFFFF;
        }

        .messenger-message-item {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            max-width: 75%;
        }

        .messenger-message-item.own-message {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .messenger-message-content {
            background: #FFFFFF;
            border: 2px solid #000000;
            border-radius: 18px;
            padding: 8px 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .messenger-message-item.own-message .messenger-message-content {
            background: #000000;
            border: 2px solid #000000;
            color: #FFFFFF;
        }

        .messenger-message-text {
            font-size: 14px;
            line-height: 1.4;
            color: #111827;
            margin: 0;
        }

        .messenger-message-item.own-message .messenger-message-text {
            color: white;
        }

        .messenger-message-time {
            font-size: 11px;
            color: #9CA3AF;
            margin-top: 4px;
        }

        .messenger-message-item.own-message .messenger-message-time {
            color: rgba(255, 255, 255, 0.8);
        }

        .messenger-typing-indicator {
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .messenger-typing-dots {
            display: flex;
            gap: 4px;
        }

        .messenger-typing-dots span {
            width: 8px;
            height: 8px;
            background: #9CA3AF;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .messenger-typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .messenger-typing-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        .messenger-message-input {
            padding: 12px 16px;
            border-top: 2px solid #000000;
            display: flex;
            gap: 8px;
            align-items: center;
            background: #FFFFFF;
        }

        .messenger-input {
            flex: 1;
            border: 2px solid #000000;
            border-radius: 20px;
            padding: 10px 16px;
            font-size: 14px;
            outline: none;
            background: #FFFFFF;
            color: #000000;
        }

        .messenger-input:focus {
            border-color: #000000;
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.2);
        }

        .messenger-btn-send {
            background: #000000;
            border: 2px solid #000000;
            color: #FFFFFF;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .messenger-btn-send:hover {
            background: #FFFFFF;
            color: #000000;
        }

        .messenger-btn-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .messenger-chat-widget {
                bottom: 16px;
                right: 16px;
            }

            .messenger-chat-toggle {
                width: 56px;
                height: 56px;
            }

            .messenger-chat-toggle i {
                font-size: 22px;
            }

            .messenger-chat-window {
                width: calc(100vw - 32px);
                height: calc(100vh - 100px);
                bottom: 0;
                right: 70px;
                left: auto;
                max-width: 100%;
            }

            .messenger-room-item {
                padding: 12px 16px;
            }

            .messenger-room-avatar {
                width: 40px;
                height: 40px;
                margin-right: 10px;
            }

            .messenger-message-item {
                max-width: 85%;
            }
        }
    </style>
    
    <!-- WebSocket Libraries for Chat -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    
    <!-- Messenger Chat Widget JavaScript -->
    <script>
        // Messenger Chat Widget
        class MessengerChatWidget {
            constructor() {
                this.socket = null;
                this.stompClient = null;
                this.currentRoomId = null;
                this.currentUserId = null;
                this.isConnected = false;
                this.isMinimized = false;
                this.typingTimer = null;
                
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                this.loadUnreadCount();
                this.initWebSocket();
                // Restore chat state from localStorage
                this.restoreChatState();
            }
            
            restoreChatState() {
                // Check if chat was open in previous session
                const wasOpen = localStorage.getItem('messengerChatOpen') === 'true';
                if (wasOpen) {
                    // Small delay to ensure DOM is ready
                    setTimeout(() => {
                        this.openChat();
                    }, 500);
                }
            }
            
            setupEventListeners() {
                const toggleBtn = document.getElementById('messengerChatToggle');
                const minimizeBtn = document.getElementById('messengerMinimizeBtn');
                const closeBtn = document.getElementById('messengerCloseBtn');
                const backBtn = document.getElementById('messengerBackBtn');
                const sendBtn = document.getElementById('messengerSendBtn');
                const messageInput = document.getElementById('messengerMessageInput');
                const newChatBtn = document.getElementById('messengerNewChatBtn');
                
                if (toggleBtn) {
                    toggleBtn.addEventListener('click', () => this.toggleChat());
                }
                
                if (minimizeBtn) {
                    minimizeBtn.addEventListener('click', () => this.minimizeChat());
                }
                
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => this.closeChat());
                }
                
                if (backBtn) {
                    backBtn.addEventListener('click', () => this.backToRooms());
                }
                
                if (sendBtn) {
                    sendBtn.addEventListener('click', () => this.sendMessage());
                }
                
                if (messageInput) {
                    messageInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            this.sendMessage();
                        }
                    });
                    
                    messageInput.addEventListener('input', () => {
                        this.handleTyping();
                    });
                }
                
                if (newChatBtn) {
                    newChatBtn.addEventListener('click', () => {
                        window.location.href = '/customer/chat';
                    });
                }
            }
            
            toggleChat() {
                const window = document.getElementById('messengerChatWindow');
                if (window.style.display === 'none') {
                    this.openChat();
                } else {
                    this.closeChat();
                }
            }
            
            openChat() {
                const window = document.getElementById('messengerChatWindow');
                window.style.display = 'flex';
                this.isMinimized = false;
                this.loadChatRooms();
                // Save state to localStorage
                localStorage.setItem('messengerChatOpen', 'true');
            }
            
            minimizeChat() {
                const window = document.getElementById('messengerChatWindow');
                window.style.display = 'none';
                this.isMinimized = true;
            }
            
            closeChat() {
                const window = document.getElementById('messengerChatWindow');
                window.style.display = 'none';
                this.currentRoomId = null;
                this.showRoomsView();
                // Save closed state to localStorage
                localStorage.setItem('messengerChatOpen', 'false');
            }
            
            async loadChatRooms() {
                const loadingEl = document.getElementById('messengerRoomsLoading');
                const listEl = document.getElementById('messengerRoomsList');
                const emptyEl = document.getElementById('messengerRoomsEmpty');
                
                loadingEl.style.display = 'flex';
                listEl.style.display = 'none';
                emptyEl.style.display = 'none';
                
                try {
                    const response = await fetch('/api/chat/rooms');
                    if (!response.ok) throw new Error('Failed to load rooms');
                    
                    const rooms = await response.json();
                    loadingEl.style.display = 'none';
                    
                    if (rooms && rooms.length > 0) {
                        this.displayRooms(rooms);
                        listEl.style.display = 'block';
                    } else {
                        // V·∫´n hi·ªÉn th·ªã AI Chat Assistant ngay c·∫£ khi kh√¥ng c√≥ room n√†o
                        this.displayRooms([]);
                        listEl.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error loading rooms:', error);
                    loadingEl.style.display = 'none';
                    // V·∫´n hi·ªÉn th·ªã AI Chat Assistant khi c√≥ l·ªói
                    this.displayRooms([]);
                    listEl.style.display = 'block';
                }
            }
            
            displayRooms(rooms) {
                const listEl = document.getElementById('messengerRoomsList');
                listEl.innerHTML = '';
                
                // Th√™m AI Chat Assistant ·ªü ƒë·∫ßu danh s√°ch (lu√¥n lu√¥n ƒë·∫ßu ti√™n)
                const aiChatRoom = this.createAIChatRoom();
                listEl.appendChild(aiChatRoom);
                
                // S·∫Øp x·∫øp c√°c room restaurant theo th·ªùi gian tin nh·∫Øn cu·ªëi c√πng (m·ªõi nh·∫•t tr∆∞·ªõc)
                const sortedRooms = [...rooms].sort((a, b) => {
                    const aTime = a.lastMessageAt ? new Date(a.lastMessageAt).getTime() : 0;
                    const bTime = b.lastMessageAt ? new Date(b.lastMessageAt).getTime() : 0;
                    return bTime - aTime; // M·ªõi nh·∫•t tr∆∞·ªõc
                });
                
                sortedRooms.forEach(room => {
                    const roomItem = this.createRoomItem(room);
                    listEl.appendChild(roomItem);
                });
            }
            
            createAIChatRoom() {
                const item = document.createElement('div');
                item.className = 'messenger-room-item';
                item.setAttribute('data-ai-chat', 'true');
                item.addEventListener('click', () => this.openAIChat());
                
                const avatar = document.createElement('div');
                avatar.className = 'messenger-room-avatar';
                avatar.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                avatar.innerHTML = '<i class="fas fa-robot"></i>';
                
                const info = document.createElement('div');
                info.className = 'messenger-room-info';
                
                const header = document.createElement('div');
                header.className = 'messenger-room-header';
                
                const name = document.createElement('h6');
                name.className = 'messenger-room-name';
                name.textContent = 'Tr·ª£ L√Ω AI';
                
                const status = document.createElement('span');
                status.className = 'messenger-room-time';
                status.textContent = 'Lu√¥n s·∫µn s√†ng';
                status.style.color = '#4CAF50';
                
                header.appendChild(name);
                header.appendChild(status);
                
                const message = document.createElement('p');
                message.className = 'messenger-room-message';
                message.textContent = 'Ch√†o b·∫°n! T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n?';
                
                info.appendChild(header);
                info.appendChild(message);
                
                item.appendChild(avatar);
                item.appendChild(info);
                
                return item;
            }
            
            async openAIChat() {
                this.currentRoomId = 'AI_CHAT';
                this.showChatView('Tr·ª£ L√Ω AI');
                
                // Load AI chat messages t·ª´ localStorage ho·∫∑c t·∫°o m·ªõi
                const aiMessages = this.getAIChatMessages();
                this.displayAIMessages(aiMessages);
                
                // Focus v√†o input
                const messageInput = document.getElementById('messengerMessageInput');
                if (messageInput) {
                    messageInput.focus();
                }
            }
            
            getAIChatMessages() {
                const stored = localStorage.getItem('ai_chat_messages');
                if (stored) {
                    try {
                        return JSON.parse(stored);
                    } catch (e) {
                        return [];
                    }
                }
                return [];
            }
            
            saveAIChatMessages(messages) {
                localStorage.setItem('ai_chat_messages', JSON.stringify(messages));
            }
            
            displayAIMessages(messages) {
                const container = document.getElementById('messengerMessagesContainer');
                container.innerHTML = '';
                
                if (messages.length === 0) {
                    // Tin nh·∫Øn ch√†o m·ª´ng m·∫∑c ƒë·ªãnh
                    const welcomeMsg = {
                        content: 'Xin ch√†o! T√¥i l√† Tr·ª£ L√Ω AI c·ªßa Book Eat. T√¥i c√≥ th·ªÉ gi√∫p b·∫°n t√¨m nh√† h√†ng, ƒë·∫∑t b√†n v√† tr·∫£ l·ªùi c√°c c√¢u h·ªèi v·ªÅ d·ªãch v·ª•. B·∫°n c·∫ßn h·ªó tr·ª£ g√¨?',
                        senderId: 'AI',
                        senderName: 'Tr·ª£ L√Ω AI',
                        sentAt: new Date().toISOString()
                    };
                    messages = [welcomeMsg];
                }
                
                messages.forEach(message => {
                    const messageEl = this.createMessageElement(message);
                    container.appendChild(messageEl);
                });
                
                this.scrollToBottom();
            }
            
            createRoomItem(room) {
                const item = document.createElement('div');
                item.className = 'messenger-room-item';
                item.addEventListener('click', () => this.openChatRoom(room.roomId, room.restaurantName));
                
                const avatar = document.createElement('div');
                avatar.className = 'messenger-room-avatar';
                avatar.innerHTML = '<i class="fas fa-store"></i>';
                
                const info = document.createElement('div');
                info.className = 'messenger-room-info';
                
                const header = document.createElement('div');
                header.className = 'messenger-room-header';
                
                const name = document.createElement('h6');
                name.className = 'messenger-room-name';
                name.textContent = room.restaurantName || 'Nh√† h√†ng';
                
                const time = document.createElement('span');
                time.className = 'messenger-room-time';
                if (room.lastMessageAt) {
                    time.textContent = this.formatTime(room.lastMessageAt);
                }
                
                header.appendChild(name);
                if (room.lastMessageAt) header.appendChild(time);
                
                if (room.unreadCount && room.unreadCount > 0) {
                    const badge = document.createElement('span');
                    badge.className = 'messenger-room-unread';
                    badge.textContent = room.unreadCount > 99 ? '99+' : room.unreadCount;
                    header.appendChild(badge);
                }
                
                const message = document.createElement('p');
                message.className = 'messenger-room-message';
                message.textContent = room.lastMessage || 'Ch∆∞a c√≥ tin nh·∫Øn';
                
                info.appendChild(header);
                info.appendChild(message);
                
                item.appendChild(avatar);
                item.appendChild(info);
                
                return item;
            }
            
            async openChatRoom(roomId, roomName) {
                this.currentRoomId = roomId;
                this.showChatView(roomName);
                await this.loadMessages(roomId);
                await this.markMessagesAsRead(roomId);
                this.joinRoom(roomId);
            }
            
            showChatView(roomName) {
                document.getElementById('messengerRoomsView').style.display = 'none';
                document.getElementById('messengerChatView').style.display = 'flex';
                document.getElementById('messengerChatRoomName').textContent = roomName || 'Nh√† h√†ng';
            }
            
            showRoomsView() {
                document.getElementById('messengerRoomsView').style.display = 'flex';
                document.getElementById('messengerChatView').style.display = 'none';
                this.currentRoomId = null;
            }
            
            backToRooms() {
                this.showRoomsView();
                this.loadChatRooms();
            }
            
            async loadMessages(roomId) {
                try {
                    const response = await fetch(`/api/chat/rooms/${roomId}/messages?page=0&size=50`);
                    if (response.ok) {
                        const messages = await response.json();
                        this.displayMessages(messages);
                    }
                } catch (error) {
                    console.error('Error loading messages:', error);
                }
            }
            
            displayMessages(messages) {
                const container = document.getElementById('messengerMessagesContainer');
                container.innerHTML = '';
                
                messages.forEach(message => {
                    const messageEl = this.createMessageElement(message);
                    container.appendChild(messageEl);
                });
                
                this.scrollToBottom();
            }
            
            createMessageElement(message) {
                const item = document.createElement('div');
                item.className = 'messenger-message-item';
                
                // Ki·ªÉm tra n·∫øu l√† tin nh·∫Øn c·ªßa user ho·∫∑c AI
                if (message.senderId === this.currentUserId || message.senderId === this.currentUserId?.toString()) {
                    item.classList.add('own-message');
                } else if (message.senderId === 'AI' || message.senderName === 'Tr·ª£ L√Ω AI') {
                    // Tin nh·∫Øn t·ª´ AI - kh√¥ng th√™m own-message class
                    item.setAttribute('data-ai-message', 'true');
                }
                
                const content = document.createElement('div');
                content.className = 'messenger-message-content';
                
                const text = document.createElement('p');
                text.className = 'messenger-message-text';
                text.textContent = message.content || '';
                
                const time = document.createElement('div');
                time.className = 'messenger-message-time';
                time.textContent = this.formatTime(message.sentAt);
                
                content.appendChild(text);
                content.appendChild(time);
                item.appendChild(content);
                
                return item;
            }
            
            async sendMessage() {
                const input = document.getElementById('messengerMessageInput');
                const content = input.value.trim();
                
                if (!content) return;
                
                // X·ª≠ l√Ω ri√™ng cho AI Chat
                if (this.currentRoomId === 'AI_CHAT') {
                    await this.sendAIMessage(content);
                    input.value = '';
                    return;
                }
                
                // X·ª≠ l√Ω chat v·ªõi restaurant (WebSocket)
                if (!this.currentRoomId || !this.isConnected) return;
                
                try {
                    this.stompClient.send('/app/chat.sendMessage', {}, JSON.stringify({
                        roomId: this.currentRoomId,
                        content: content
                    }));
                    
                    input.value = '';
                    this.stopTyping();
                } catch (error) {
                    console.error('Error sending message:', error);
                }
            }
            
            async sendAIMessage(content) {
                const container = document.getElementById('messengerMessagesContainer');
                
                // Th√™m tin nh·∫Øn c·ªßa user
                const userMessage = {
                    content: content,
                    senderId: this.currentUserId,
                    senderName: 'B·∫°n',
                    sentAt: new Date().toISOString()
                };
                const userMsgEl = this.createMessageElement(userMessage);
                container.appendChild(userMsgEl);
                this.scrollToBottom();
                
                // L∆∞u tin nh·∫Øn v√†o localStorage
                const messages = this.getAIChatMessages();
                messages.push(userMessage);
                this.saveAIChatMessages(messages);
                
                // Hi·ªÉn th·ªã typing indicator
                const typingEl = document.createElement('div');
                typingEl.className = 'messenger-message-item';
                typingEl.id = 'ai-typing-indicator';
                typingEl.innerHTML = '<div class="messenger-message-content"><p class="messenger-message-text">ƒêang suy nghƒ©...</p></div>';
                container.appendChild(typingEl);
                this.scrollToBottom();
                
                try {
                    // G·ªçi API AI
                    const response = await fetch('/ai/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({
                            message: content,
                            context: 'messenger_chat'
                        })
                    });
                    
                    // X√≥a typing indicator
                    const typingIndicator = document.getElementById('ai-typing-indicator');
                    if (typingIndicator) {
                        typingIndicator.remove();
                    }
                    
                    if (response.ok) {
                        const data = await response.json();
                        const aiResponse = data.response || 'Xin l·ªói, t√¥i kh√¥ng th·ªÉ tr·∫£ l·ªùi c√¢u h·ªèi n√†y. Vui l√≤ng th·ª≠ l·∫°i.';
                        
                        // Th√™m tin nh·∫Øn c·ªßa AI
                        const aiMessage = {
                            content: aiResponse,
                            senderId: 'AI',
                            senderName: 'Tr·ª£ L√Ω AI',
                            sentAt: new Date().toISOString()
                        };
                        const aiMsgEl = this.createMessageElement(aiMessage);
                        container.appendChild(aiMsgEl);
                        this.scrollToBottom();
                        
                        // L∆∞u tin nh·∫Øn v√†o localStorage
                        messages.push(aiMessage);
                        this.saveAIChatMessages(messages);
                    } else {
                        throw new Error('AI API error');
                    }
                } catch (error) {
                    console.error('Error sending AI message:', error);
                    
                    // X√≥a typing indicator
                    const typingIndicator = document.getElementById('ai-typing-indicator');
                    if (typingIndicator) {
                        typingIndicator.remove();
                    }
                    
                    // Hi·ªÉn th·ªã l·ªói
                    const errorMessage = {
                        content: 'Xin l·ªói, c√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i sau.',
                        senderId: 'AI',
                        senderName: 'Tr·ª£ L√Ω AI',
                        sentAt: new Date().toISOString()
                    };
                    const errorMsgEl = this.createMessageElement(errorMessage);
                    container.appendChild(errorMsgEl);
                    this.scrollToBottom();
                }
            }
            
            handleIncomingMessage(data) {
                if (!data || !data.messageId || !data.content) return;
                
                if (data.roomId === this.currentRoomId) {
                    const messageEl = this.createMessageElement(data);
                    document.getElementById('messengerMessagesContainer').appendChild(messageEl);
                    this.scrollToBottom();
                }
                
                this.loadChatRooms();
                this.loadUnreadCount();
            }
            
            handleTyping() {
                if (!this.currentRoomId || !this.isConnected) return;
                
                this.stompClient.send('/app/chat.typing', {}, JSON.stringify({
                    roomId: this.currentRoomId,
                    typing: true
                }));
                
                if (this.typingTimer) clearTimeout(this.typingTimer);
                this.typingTimer = setTimeout(() => this.stopTyping(), 1000);
            }
            
            stopTyping() {
                if (!this.currentRoomId || !this.isConnected) return;
                
                this.stompClient.send('/app/chat.typing', {}, JSON.stringify({
                    roomId: this.currentRoomId,
                    typing: false
                }));
                
                if (this.typingTimer) {
                    clearTimeout(this.typingTimer);
                    this.typingTimer = null;
                }
            }
            
            initWebSocket() {
                try {
                    this.socket = new SockJS('/ws');
                    this.stompClient = Stomp.over(this.socket);
                    
                    this.stompClient.connect({}, (frame) => {
                        this.isConnected = true;
                        this.subscribeToMessages();
                    }, (error) => {
                        console.error('WebSocket error:', error);
                        this.isConnected = false;
                    });
                } catch (error) {
                    console.error('Failed to init WebSocket:', error);
                }
            }
            
            subscribeToMessages() {
                if (!this.isConnected) return;
                
                this.stompClient.subscribe('/topic/room/*', (message) => {
                    const data = JSON.parse(message.body);
                    this.handleIncomingMessage(data);
                });
            }
            
            joinRoom(roomId) {
                if (!this.isConnected) return;
                this.stompClient.send('/app/chat.joinRoom', {}, JSON.stringify({ roomId }));
            }
            
            async markMessagesAsRead(roomId) {
                try {
                    await fetch(`/api/chat/rooms/${roomId}/read`, { method: 'POST' });
                } catch (error) {
                    console.error('Error marking as read:', error);
                }
            }
            
            async loadUnreadCount() {
                try {
                    const response = await fetch('/api/chat/unread-count');
                    if (response.ok) {
                        const data = await response.json();
                        const badge = document.getElementById('messengerUnreadBadge');
                        if (badge) {
                            if (data.unreadCount > 0) {
                                badge.textContent = data.unreadCount > 99 ? '99+' : data.unreadCount;
                                badge.style.display = 'flex';
                            } else {
                                badge.style.display = 'none';
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error loading unread count:', error);
                }
            }
            
            scrollToBottom() {
                const container = document.getElementById('messengerMessagesContainer');
                container.scrollTop = container.scrollHeight;
            }
            
            formatTime(dateTimeString) {
                if (!dateTimeString) return '';
                const date = new Date(dateTimeString);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);
                
                if (diffMins < 1) return 'V·ª´a xong';
                if (diffMins < 60) return `${diffMins} ph√∫t tr∆∞·ªõc`;
                if (diffHours < 24) return `${diffHours} gi·ªù tr∆∞·ªõc`;
                if (diffDays < 7) return `${diffDays} ng√†y tr∆∞·ªõc`;
                return date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' });
            }
        }
        
        // Initialize Messenger Chat Widget
        let messengerChatWidget;
        document.addEventListener('DOMContentLoaded', function() {
            // Load user info for chat
            fetch('/api/user/current', {
                credentials: 'include' // Important: include cookies for session
            })
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) {
                            // User not authenticated, widget will not be initialized
                            console.log('User not authenticated, chat widget disabled');
                            return null;
                        }
                        throw new Error('Failed to load user info');
                    }
                    return response.json();
                })
                .then(user => {
                    if (user && user.id) {
                        messengerChatWidget = new MessengerChatWidget();
                        messengerChatWidget.currentUserId = user.id;
                        console.log('Messenger chat widget initialized for user:', user.id);
                    } else {
                        console.log('No user data, chat widget not initialized');
                    }
                })
                .catch(error => {
                    console.error('Error loading user info:', error);
                    // Don't initialize widget if we can't get user info
                    // This prevents errors when trying to use the widget
                });
        });
    </script>
</body>
</html>
