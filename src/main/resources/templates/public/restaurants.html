<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nhà hàng - Book Eat – Đặt bàn online, giữ chỗ ngay</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link th:href="@{/css/design-system.css}" rel="stylesheet">

    <style>
        /* ============================================
           RESTAURANT LIST PAGE - ENHANCED COLOR DESIGN
           ============================================ */
        
        /* Container */
        .restaurants-page-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 24px;
        }
        
        @media (max-width: 768px) {
            .restaurants-page-container {
                padding: 0 16px;
            }
        }
        
        /* Restaurant Cards Grid */
        .restaurant-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 32px;
            margin: 32px 0;
        }
        
        @media (max-width: 1024px) {
            .restaurant-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 24px;
            }
        }
        
        @media (max-width: 768px) {
            .restaurant-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }
        
        /* Restaurant Card */
        .restaurant-card-new {
            background: #FFFFFF;
            border: 1px solid #E5E7EB;
            border-radius: 16px;
            overflow: hidden;
            min-height: 520px;
            height: auto;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        .restaurant-card-new:hover {
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.15);
            transform: translateY(-4px);
            border-color: #D1D5DB;
        }
        
        /* Image Container (60% height) */
        .restaurant-card-image-new {
            position: relative;
            height: 280px;
            min-height: 280px;
            overflow: hidden;
            border-radius: 16px 16px 0 0;
            background: linear-gradient(135deg, #F3F4F6 0%, #E5E7EB 100%);
        }
        
        .restaurant-card-image-new img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.4s ease;
        }
        
        .restaurant-card-new:hover .restaurant-card-image-new img {
            transform: scale(1.08);
        }
        
        .restaurant-card-new:hover .restaurant-card-image-new::after {
            opacity: 0.3;
        }
        
        .restaurant-card-image-new::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to bottom, transparent 0%, rgba(0,0,0,0.1) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        /* Badge (Giảm 15% hoặc Hot) */
        .restaurant-badge-new {
            position: absolute;
            top: 12px;
            left: 12px;
            background: linear-gradient(135deg, #E60023 0%, #C0001D 100%);
            color: #FFFFFF;
            padding: 8px 14px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
            z-index: 5;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 12px rgba(230, 0, 35, 0.3);
        }
        
        /* Favorite Button */
        .heart-toggle {
            position: absolute;
            top: 12px;
            right: 12px;
            z-index: 10;
        }

        .heart-icon {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.25rem;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(0, 0, 0, 0.4);
            padding: 8px;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .heart-icon:hover {
            color: #E60023;
            background: rgba(255, 255, 255, 0.95);
            transform: scale(1.1);
        }

        .heart-icon.favorited {
            color: #E60023;
            background: rgba(255, 255, 255, 0.95);
            animation: heartbeat 0.6s ease-in-out;
        }

        @keyframes heartbeat {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.25);
            }
            100% {
                transform: scale(1);
            }
        }
        
        /* Info Section (40% height) */
        .restaurant-card-info-new {
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 240px;
            background: #FFFFFF;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        /* Restaurant Name */
        .restaurant-name-new {
            font-size: 20px;
            font-weight: 700;
            color: #111111;
            margin: 0 0 14px 0;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            transition: color 0.3s ease;
        }
        
        .restaurant-card-new:hover .restaurant-name-new {
            color: #E60023;
        }
        
        /* Restaurant Details */
        .restaurant-details-new {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 14px;
        }
        
        .restaurant-detail-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            font-size: 14px;
            color: #374151;
            line-height: 1.5;
            font-weight: 400;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        .restaurant-detail-item .icon {
            color: #374151;
            width: 18px;
            text-align: center;
            flex-shrink: 0;
            font-size: 16px;
            margin-top: 2px;
        }
        
        .restaurant-detail-item i.icon {
            color: #374151;
            font-size: 16px;
            width: 18px;
            flex-shrink: 0;
        }
        
        .restaurant-detail-item.cuisine {
            color: #374151;
            font-size: 14px;
            font-weight: 400;
        }
        
        .restaurant-detail-item.price {
            color: #374151;
            font-weight: 500;
            font-size: 14px;
        }
        
        /* Status Badge */
        .restaurant-status-new {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 12px;
            border-radius: 16px;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 12px;
            width: fit-content;
            max-width: 100%;
            border: 1px solid;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        .restaurant-status-new.open {
            background: #ECFDF5;
            color: #047857;
            border-color: #A7F3D0;
        }
        
        .restaurant-status-new.closed {
            background: #FEF2F2;
            color: #991B1B;
            border-color: #FECACA;
        }
        
        .restaurant-status-new.closed span {
            white-space: nowrap;
        }
        
        .restaurant-status-new span:first-child {
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .restaurant-status-new i {
            font-size: 14px;
            flex-shrink: 0;
            color: inherit;
        }
        
        .restaurant-status-new span:not(:first-child) {
            white-space: normal;
            word-break: break-word;
        }
        
        /* Rating */
        .restaurant-rating-new {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 14px;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        .stars-new {
            display: flex;
            gap: 3px;
        }
        
        .stars-new i {
            color: #F59E0B;
            font-size: 14px;
        }
        
        .stars-new i.far {
            color: #E5E7EB;
        }
        
        .rating-text-new {
            font-size: 14px;
            color: #6B7280;
            font-weight: 400;
        }
        
        /* CTA Button */
        .restaurant-cta-new {
            width: 100%;
            padding: 14px;
            background: #111111;
            color: #FFFFFF;
            border: 2px solid #111111;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            text-decoration: none;
            display: block;
            margin-top: auto;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            letter-spacing: 0.3px;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        .restaurant-cta-new:hover {
            background: #000000;
            border-color: #000000;
            color: #FFFFFF;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        
        .restaurant-cta-new:active {
            transform: translateY(0);
            background: #1F1F1F;
        }
        
        /* Pagination */
        .pagination-new {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin: 48px 0;
        }
        
        .pagination-btn-new {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 2px solid #E5E7EB;
            background: #FFFFFF;
            color: #374151;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .pagination-btn-new:hover:not(.disabled):not(.active) {
            border-color: #E60023;
            color: #E60023;
            background: #FFF5F5;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(230, 0, 35, 0.15);
        }
        
        .pagination-btn-new.active {
            background: linear-gradient(135deg, #E60023 0%, #C0001D 100%);
            color: #FFFFFF;
            border-color: #E60023;
            box-shadow: 0 4px 12px rgba(230, 0, 35, 0.3);
        }
        
        .pagination-btn-new.disabled {
            opacity: 0.3;
            cursor: not-allowed;
            background: #F9FAFB;
        }
        
        /* Toast Container */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
        }
        
        /* Empty State */
        .empty-state-new {
            text-align: center;
            padding: 80px 24px;
            background: #F9FAFB;
            border-radius: 16px;
            margin: 32px 0;
        }
        
        .empty-state-new h3 {
            font-size: 24px;
            font-weight: 700;
            color: #111111;
            margin-bottom: 12px;
        }
        
        .empty-state-new p {
            color: #6B7280;
            font-size: 16px;
        }
        
        /* Section Background */
        .restaurants-section {
            background: #F9FAFB;
            padding: 48px 0;
        }
        
        .restaurants-section .restaurants-page-container {
            background: #FFFFFF;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        @media (max-width: 768px) {
            .restaurants-section .restaurants-page-container {
                padding: 20px;
                border-radius: 12px;
            }
        }

        @media (max-width: 768px) {
            .ds-restaurant-overlay {
                opacity: 1;
                transform: none;
            }
        }

        .filter-item {
            min-width: 180px;
            flex: 1;
        }
        
        .filter-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        /* Compact breadcrumb */
        .ds-breadcrumb {
            font-size: 0.875rem;
            line-height: 1.25rem;
        }
        
        .ds-breadcrumb-list {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .ds-breadcrumb-item {
            display: flex;
            align-items: center;
        }
        
        .ds-breadcrumb-item:not(:last-child)::after {
            content: '/';
            margin-left: 0.5rem;
            color: #6b7280;
        }
        
        /* Restaurant List Layout */
        .restaurant-list {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .ds-restaurant-card {
            display: flex;
            flex-direction: row;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: all 0.3s ease;
            border: 2px solid #d1d5db;
            cursor: pointer;
        }
        
        .ds-restaurant-card:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
            border-color: #9ca3af;
        }
        
        .ds-restaurant-image {
            flex: 0 0 250px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .ds-restaurant-photo {
            width: 100%;
            height: 200px;
            object-fit: cover;
            object-position: center;
            transition: transform 0.3s ease;
        }
        
        .ds-restaurant-card:hover .ds-restaurant-photo {
            transform: scale(1.05);
        }
        
        /* Perfect centering for heart icon */
        .heart-toggle {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 10;
        }
        
        .heart-icon {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            color: #ef4444;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .heart-icon:hover {
            background: white;
            transform: scale(1.1);
        }
        
        /* Perfect centering for overlay buttons */
        .ds-restaurant-overlay {
            position: absolute;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
        }
        
        .ds-restaurant-overlay .ds-btn {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .ds-restaurant-overlay .ds-btn:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: translateY(-1px);
        }
        
        .ds-restaurant-info {
            flex: 1;
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        /* Perfect icon alignment for OCD */
        .ds-restaurant-info .ds-flex {
            align-items: center;
            line-height: 1.5;
        }
        
        .ds-restaurant-info i {
            width: 16px;
            text-align: center;
            font-size: 0.875rem;
            color: #6b7280;
            flex-shrink: 0;
        }
        
        .ds-restaurant-info span {
            font-size: 0.875rem;
            color: #374151;
            line-height: 1.5;
        }
        
        .ds-restaurant-name {
            font-size: 1.125rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }
        
        /* Restaurant Header with NEW Badge */
        .restaurant-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        .new-badge {
            background: #ef4444;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            text-transform: uppercase;
        }
        
        /* Rating Stars */
        .restaurant-rating {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .stars {
            display: flex;
            gap: 0.125rem;
        }
        
        .stars .fa-star {
            font-size: 0.875rem;
        }
        
        .star-filled {
            color: #fbbf24;
        }
        
        .star-empty {
            color: #d1d5db;
        }
        
        .rating-text {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        /* Restaurant Details */
        .restaurant-details {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .price-indicator {
            font-weight: 600;
            color: #374151;
        }
        
        .cuisine-type {
            font-weight: 500;
        }
        
        .location {
            color: #6b7280;
        }
        
        /* Availability Status */
        .availability-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
            color: #059669;
        }
        
        .availability-status .fa-clock {
            color: #ef4444;
        }
        
        /* Time Slots */
        .time-slots {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .time-slot-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .time-slot-btn:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }
        
        .time-slot-btn:first-child {
            background: #dc2626;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
        }
        
        /* Button optimization */
        .ds-restaurant-info .ds-btn {
            margin-top: 0.75rem;
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 500;
        }
        
        /* Perfect spacing for OCD */
        .ds-restaurant-info > *:not(:last-child) {
            margin-bottom: 0.5rem;
        }
        
        .ds-restaurant-info > *:last-child {
            margin-bottom: 0;
        }
        
        .filter-row {
            display: flex;
            gap: 0.75rem;
            align-items: end;
            flex-wrap: wrap;
        }
        
        .filter-row .filter-item {
            flex: 1;
            min-width: 120px;
        }
        
        .filter-actions {
            display: flex;
            gap: 0.75rem;
            align-items: end;
            flex-shrink: 0;
        }
        
        /* Compact form styling */
        .ds-form-label {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.125rem;
        }
        
        .ds-form-input,
        .ds-form-select {
            font-size: 0.875rem;
            padding: 0.5rem 0.75rem;
            height: 2.25rem;
        }
        
        .ds-btn {
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
            height: 2.25rem;
        }
        
        /* Remove default form group margins */
        .ds-form-group {
            margin-bottom: 0;
        }
        
        .ds-form-group .ds-form-label {
            margin-bottom: 0.125rem;
        }
        
        @media (max-width: 1200px) {
            .filter-row {
                flex-wrap: wrap;
            }
            
            .filter-item {
                min-width: 140px;
            }
        }
        
        @media (max-width: 768px) {
            .filter-row {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .filter-item {
                min-width: 100%;
            }
            
            .filter-actions {
                width: 100%;
                justify-content: stretch;
            }
            
            .filter-actions button {
                flex: 1;
            }
        }
        
        @media (max-width: 480px) {
            .filter-actions {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .filter-actions button {
                width: 100%;
            }
        }
        
        /* Restaurant List Responsive */
        @media (max-width: 768px) {
            .ds-restaurant-card {
                flex-direction: column;
            }
            
            .ds-restaurant-image {
                flex: none;
                height: 200px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .ds-restaurant-photo {
                height: 200px;
                object-fit: cover;
                object-position: center;
            }
            
            .ds-restaurant-info {
                padding: 1rem;
            }
            
            .ds-restaurant-name {
                font-size: 1rem;
                margin-bottom: 0.75rem;
            }
            
            .ds-restaurant-info .ds-flex {
                margin-bottom: 0.5rem;
            }
            
            .restaurant-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .time-slots {
                flex-direction: column;
                gap: 0.25rem;
            }
            
            .time-slot-btn {
                width: 100%;
                text-align: center;
            }
        }
        
        @media (max-width: 480px) {
            .restaurant-list {
                gap: 1rem;
            }
            
            .ds-restaurant-info {
                padding: 0.75rem;
            }
        }
    </style>
</head>
<body class="ds-bg-white">
    <div th:with="activeNav='restaurants'"
         th:replace="~{fragments/design-system-components :: unified-header}"></div>

    <main>
        <section class="ds-bg-gray-50" style="padding: var(--ds-space-4) 0;">
            <div class="ds-container">
                <nav class="ds-breadcrumb" aria-label="breadcrumb" style="margin: 0; padding: 0.5rem 0;">
                    <ol class="ds-breadcrumb-list" style="margin: 0; padding: 0;">
                        <li class="ds-breadcrumb-item">
                            <a th:href="@{/}">Trang chủ</a>
                        </li>
                        <li class="ds-breadcrumb-item active">
                            <span>Nhà hàng</span>
                        </li>
                    </ol>
                </nav>
            </div>
        </section>

        <section class="restaurants-section" style="padding: 48px 0;">
            <div class="restaurants-page-container">
                <article class="ds-card ds-mb-4">
                    <div class="ds-card-body ds-flex ds-flex-col ds-gap-2" style="padding: 1rem;">
                        <div class="filter-container">
                            <div class="filter-row">
                            <div class="ds-form-group filter-item">
                                <label class="ds-form-label" for="searchInput">Tìm kiếm</label>
                                <input type="text" id="searchInput"
                                       class="ds-form-input"
                                       th:value="${search}"
                                       placeholder="Tên nhà hàng...">
                            </div>
                            <div class="ds-form-group filter-item">
                                <label class="ds-form-label" for="cuisineFilter">Loại ẩm thực</label>
                                <select id="cuisineFilter" class="ds-form-select">
                                    <option value="">Tất cả</option>
                                    <option value="Vietnamese" th:selected="${cuisineType == 'Vietnamese'}">Việt Nam</option>
                                    <option value="Chinese" th:selected="${cuisineType == 'Chinese'}">Trung Quốc</option>
                                    <option value="Japanese" th:selected="${cuisineType == 'Japanese'}">Nhật Bản</option>
                                    <option value="Korean" th:selected="${cuisineType == 'Korean'}">Hàn Quốc</option>
                                    <option value="Italian" th:selected="${cuisineType == 'Italian'}">Ý</option>
                                    <option value="American" th:selected="${cuisineType == 'American'}">Mỹ</option>
                                </select>
                            </div>
                            <div class="ds-form-group filter-item">
                                <label class="ds-form-label" for="priceFilter">Khoảng giá</label>
                                <select id="priceFilter" class="ds-form-select">
                                    <option value="">Tất cả</option>
                                        <option value="low" th:selected="${priceRange == 'low'}">Dưới 200k</option>
                                        <option value="medium" th:selected="${priceRange == 'medium'}">200k - 500k</option>
                                        <option value="high" th:selected="${priceRange == 'high'}">Trên 500k</option>
                                </select>
                            </div>
                            <div class="ds-form-group filter-item">
                                <label class="ds-form-label" for="sortSelect">Sắp xếp</label>
                                <select id="sortSelect" class="ds-form-select">
                                    <option value="restaurantName-asc" th:selected="${sortBy == 'restaurantName' and sortDir == 'asc'}">Tên (A-Z)</option>
                                    <option value="restaurantName-desc" th:selected="${sortBy == 'restaurantName' and sortDir == 'desc'}">Tên (Z-A)</option>
                                    <option value="averageRating-desc" th:selected="${sortBy == 'averageRating' and sortDir == 'desc'}">Đánh giá cao nhất</option>
                                    <option value="averagePrice-asc" th:selected="${sortBy == 'averagePrice' and sortDir == 'asc'}">Giá thấp nhất</option>
                                    <option value="averagePrice-desc" th:selected="${sortBy == 'averagePrice' and sortDir == 'desc'}">Giá cao nhất</option>
                                    <option value="distance-asc" th:selected="${sortBy == 'distance' and sortDir == 'asc'}" th:if="${nearbySearch != null and nearbySearch == true}">Gần nhất</option>
                                </select>
                            </div>
                            <!-- Distance Filter - Only show when location is available -->
                            <div class="ds-form-group filter-item" th:if="${nearbySearch != null and nearbySearch == true}">
                                <label class="ds-form-label" for="distanceFilter">
                                    <i class="fas fa-route"></i> Khoảng cách (km)
                                </label>
                                <select id="distanceFilter" class="ds-form-select">
                                    <option value="">Tất cả khoảng cách</option>
                                    <option value="1" th:selected="${maxDistance != null and maxDistance == 1.0}">Trong 1 km</option>
                                    <option value="3" th:selected="${maxDistance != null and maxDistance == 3.0}">Trong 3 km</option>
                                    <option value="5" th:selected="${maxDistance != null and maxDistance == 5.0}">Trong 5 km</option>
                                    <option value="10" th:selected="${maxDistance != null and maxDistance == 10.0}">Trong 10 km</option>
                                    <option value="20" th:selected="${maxDistance != null and maxDistance == 20.0}">Trong 20 km</option>
                                    <option value="50" th:selected="${maxDistance != null and maxDistance == 50.0}">Trong 50 km</option>
                                </select>
                            </div>
                                <div class="filter-actions">
                                    <button type="button" id="nearbyRestaurantsBtn"
                                            class="ds-btn ds-btn-primary"
                                            onclick="findNearbyRestaurants()"
                                            style="background: linear-gradient(135deg, #E60023 0%, #C0001D 100%); border: none;">
                                        <i class="fas fa-map-marker-alt"></i>
                                        Nhà hàng gần bạn
                                    </button>
                                    <button type="button" id="filterActions"
                                            class="ds-btn ds-btn-primary"
                                            onclick="applyFilters()">
                                        <i class="fas fa-filter"></i>
                                        Lọc
                                    </button>
                                    <button type="button" id="clearFilters"
                                            class="ds-btn ds-btn-secondary"
                                            onclick="clearFilters()">
                                        <i class="fas fa-times"></i>
                                        Xóa
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>
                </article>

                <!-- Restaurant Grid -->
                <div class="restaurant-grid">
                    <div class="restaurant-card-new"
                         th:each="restaurant : ${restaurants.content}"
                         th:onclick="|window.location.href='/restaurants/' + ${restaurant.restaurantId}|">
                        
                        <!-- Image Container -->
                        <div class="restaurant-card-image-new">
                            <img th:if="${restaurant.mainImageUrl != null and !restaurant.mainImageUrl.isEmpty()}"
                                 th:src="${restaurant.mainImageUrl}"
                                 th:alt="${restaurant.restaurantName}"
                                 loading="lazy"
                                 onerror="this.src='https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80';">
                            <img th:unless="${restaurant.mainImageUrl != null and !restaurant.mainImageUrl.isEmpty()}"
                                 src="https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80"
                                 th:alt="${restaurant.restaurantName}"
                                 loading="lazy">
                            
                            <!-- Badge (Hot/Giảm) -->
                            <div class="restaurant-badge-new" th:if="${restaurant.averageRating >= 4.5}">HOT</div>
                            
                            <!-- Favorite Button -->
                            <div class="heart-toggle" sec:authorize="hasRole('CUSTOMER')">
                                <i class="far fa-heart heart-icon"
                                   th:data-restaurant-id="${restaurant.restaurantId}"
                                   onclick="event.stopPropagation(); toggleFavorite(this)"
                                   title="Thêm vào yêu thích"></i>
                            </div>
                        </div>
                        
                        <!-- Info Section -->
                        <div class="restaurant-card-info-new">
                            <!-- Restaurant Name -->
                            <h3 class="restaurant-name-new" th:text="${restaurant.restaurantName}">Tên nhà hàng</h3>
                            
                            <!-- Details -->
                            <div class="restaurant-details-new">
                                <!-- Address -->
                                <div class="restaurant-detail-item" th:if="${restaurant.address != null}">
                                    <i class="fas fa-map-marker-alt icon"></i>
                                    <span th:text="${restaurant.address}">Địa chỉ</span>
                                </div>
                                
                                <!-- Distance (when available) -->
                                <div class="restaurant-detail-item" th:if="${restaurant.distance != null}">
                                    <i class="fas fa-route icon"></i>
                                    <span th:text="${#numbers.formatDecimal(restaurant.distance, 1, 'COMMA', 1, 'POINT')} + ' km'">Khoảng cách</span>
                                </div>
                                
                                <!-- Cuisine Type -->
                                <div class="restaurant-detail-item cuisine" th:if="${restaurant.cuisineType != null}">
                                    <i class="fas fa-utensils icon"></i>
                                    <span th:text="${restaurant.cuisineType}">Loại hình</span>
                                </div>
                                
                                <!-- Price Range -->
                                <div class="restaurant-detail-item price" th:if="${restaurant.averagePrice != null}">
                                    <i class="fas fa-money-bill-wave icon"></i>
                                    <span th:text="'₫' + ${#numbers.formatDecimal(restaurant.averagePrice, 0, 'COMMA', 0, 'POINT')} + '/người'">Khoảng giá</span>
                                </div>
                            </div>
                            
                            <!-- Status Badge -->
                            <div class="restaurant-status-new" 
                                 th:classappend="${restaurantsIsOpen != null and restaurantsIsOpen[restaurant.restaurantId]} ? 'open' : 'closed'">
                                <i class="fas fa-clock"></i>
                                <span th:if="${restaurantsIsOpen != null and restaurantsIsOpen[restaurant.restaurantId]}">Đang mở cửa</span>
                                <span th:unless="${restaurantsIsOpen != null and restaurantsIsOpen[restaurant.restaurantId]}">
                                    <span th:if="${restaurant.openingHours != null and !restaurant.openingHours.trim().isEmpty()}">
                                        Giờ mở cửa: 
                                        <span th:with="hours=${#strings.replace(restaurant.openingHours.trim(), ' ', '')}" 
                                              th:text="${#strings.substringBefore(hours, '-')}">10:00</span>
                                    </span>
                                    <span th:unless="${restaurant.openingHours != null and !restaurant.openingHours.trim().isEmpty()}">Đóng cửa</span>
                                </span>
                            </div>
                            
                            <!-- Rating -->
                            <div class="restaurant-rating-new" th:if="${restaurant.averageRating > 0}">
                                <div class="stars-new">
                                    <i class="fas fa-star" th:each="i : ${#numbers.sequence(1, 5)}" 
                                       th:classappend="${i <= restaurant.averageRating} ? '' : 'far'"></i>
                                </div>
                                <span class="rating-text-new" th:text="${restaurant.formattedAverageRating} + ' (' + ${restaurant.reviewCount} + ' đánh giá)'">4.7 (120 đánh giá)</span>
                            </div>
                            
                            <!-- CTA Button -->
                            <a th:href="@{/restaurants/{id}(id=${restaurant.restaurantId})}"
                               class="restaurant-cta-new"
                               onclick="event.stopPropagation()">
                                Đặt bàn ngay
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Empty State -->
                <div class="empty-state-new" th:if="${restaurants.empty}">
                    <h3>Không tìm thấy nhà hàng</h3>
                    <p>Không có nhà hàng nào phù hợp với bộ lọc của bạn. Hãy thử điều chỉnh các tiêu chí tìm kiếm.</p>
                </div>

                <!-- Pagination -->
                <nav th:if="${totalPages > 1}" class="pagination-new" aria-label="Pagination">
                    <a class="pagination-btn-new"
                       th:classappend="${currentPage == 0} ? 'disabled' : ''"
                       th:href="${currentPage == 0} ? '#' : @{/restaurants(page=${currentPage - 1}, size=${restaurants.size}, sortBy=${sortBy}, sortDir=${sortDir}, search=${search}, cuisineType=${cuisineType}, priceRange=${priceRange}, ratingFilter=${ratingFilter}, latitude=${latitude}, longitude=${longitude}, nearby=${nearby}, maxDistance=${maxDistance})}">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                    
                    <a th:each="pageNum : ${#numbers.sequence(0, totalPages - 1)}"
                       class="pagination-btn-new"
                       th:classappend="${pageNum == currentPage} ? 'active' : ''"
                       th:href="@{/restaurants(page=${pageNum}, size=${restaurants.size}, sortBy=${sortBy}, sortDir=${sortDir}, search=${search}, cuisineType=${cuisineType}, priceRange=${priceRange}, ratingFilter=${ratingFilter}, latitude=${latitude}, longitude=${longitude}, nearby=${nearby}, maxDistance=${maxDistance})}"
                       th:text="${pageNum + 1}">1</a>
                    
                    <a class="pagination-btn-new"
                       th:classappend="${currentPage == totalPages - 1} ? 'disabled' : ''"
                       th:href="${currentPage == totalPages - 1} ? '#' : @{/restaurants(page=${currentPage + 1}, size=${restaurants.size}, sortBy=${sortBy}, sortDir=${sortDir}, search=${search}, cuisineType=${cuisineType}, priceRange=${priceRange}, ratingFilter=${ratingFilter}, latitude=${latitude}, longitude=${longitude}, nearby=${nearby}, maxDistance=${maxDistance})}">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </nav>

                <div class="ds-flex ds-justify-center ds-gap-4 ds-flex-wrap ds-mt-8">
                    <a th:href="@{/}"
                       class="ds-btn ds-btn-secondary ds-btn-lg">
                        <i class="fas fa-home"></i>
                        Về trang chủ
                    </a>
                </div>
            </div>
        </section>
    </main>

    <div th:replace="~{fragments/design-system-components :: unified-footer}"></div>

    <!-- Messenger Style Chat Widget -->
    <div id="messenger-chat-widget" class="messenger-chat-widget" sec:authorize="isAuthenticated() and (hasRole('CUSTOMER') or hasRole('customer'))">
        <!-- Chat Toggle Button -->
        <button class="messenger-chat-toggle" id="messengerChatToggle" title="Chat với nhà hàng">
            <i class="fas fa-comments"></i>
            <span class="messenger-chat-pulse"></span>
            <span class="messenger-unread-badge" id="messengerUnreadBadge" style="display: none;">0</span>
        </button>
        
        <!-- Chat Window (Messenger Style) -->
        <div id="messengerChatWindow" class="messenger-chat-window" style="display: none;">
            <!-- Chat Header -->
            <div class="messenger-chat-header">
                <div class="messenger-chat-title">
                    <i class="fas fa-comments"></i>
                    <span>Tin nhắn</span>
                </div>
                <div class="messenger-chat-controls">
                    <button class="messenger-btn-minimize" id="messengerMinimizeBtn" title="Thu nhỏ">
                        <i class="fas fa-minus"></i>
                    </button>
                    <button class="messenger-btn-close" id="messengerCloseBtn" title="Đóng">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <!-- Chat Content -->
            <div class="messenger-chat-content">
                <!-- Rooms List View -->
                <div id="messengerRoomsView" class="messenger-rooms-view">
                    <div class="messenger-rooms-header">
                        <h6>Xem tất cả</h6>
                        <button class="messenger-btn-new-chat" id="messengerNewChatBtn" title="Chat mới">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    
                    <div id="messengerRoomsLoading" class="messenger-loading">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        <span>Đang tải...</span>
                    </div>
                    
                    <div id="messengerRoomsList" class="messenger-rooms-list" style="display: none;">
                        <!-- Rooms will be loaded here -->
                    </div>
                    
                    <div id="messengerRoomsEmpty" class="messenger-empty" style="display: none;">
                        <i class="fas fa-inbox"></i>
                        <p>Chưa có cuộc trò chuyện nào</p>
                        <a th:href="@{/customer/chat}" class="messenger-btn-link">Bắt đầu chat mới</a>
                    </div>
                </div>
                
                <!-- Chat Interface View -->
                <div id="messengerChatView" class="messenger-chat-view" style="display: none;">
                    <div class="messenger-chat-view-header">
                        <button class="messenger-btn-back" id="messengerBackBtn">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="messenger-chat-info">
                            <h6 id="messengerChatRoomName">Nhà hàng</h6>
                            <small id="messengerChatStatus">Đang online</small>
                        </div>
                    </div>
                    
                    <div id="messengerMessagesContainer" class="messenger-messages-container">
                        <!-- Messages will be loaded here -->
                    </div>
                    
                    <div id="messengerTypingIndicator" class="messenger-typing-indicator" style="display: none;">
                        <div class="messenger-typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                        <span>Đang gõ...</span>
                    </div>
                    
                    <div class="messenger-message-input">
                        <input type="text" id="messengerMessageInput" class="messenger-input" 
                               placeholder="Nhập tin nhắn..." maxlength="1000">
                        <button id="messengerSendBtn" class="messenger-btn-send" title="Gửi">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Bubble for non-authenticated users -->
    <div class="chat-bubble-container" sec:authorize="!isAuthenticated()">
        <a href="/login?redirect=/restaurants" class="chat-bubble" title="Đăng nhập để chat">
            <i class="fas fa-comments"></i>
            <span class="chat-bubble-pulse"></span>
        </a>
    </div>

    <style>
        /* Chat Bubble Styles */
        .chat-bubble-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 1000;
        }

        .chat-bubble {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #E60023 0%, #C0001D 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(230, 0, 35, 0.4);
            transition: all 0.3s ease;
            position: relative;
            text-decoration: none;
            color: white;
            border: none;
            padding: 0;
        }

        .chat-bubble:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(230, 0, 35, 0.6);
        }

        .chat-bubble:active {
            transform: scale(0.95);
        }

        .chat-bubble i {
            font-size: 24px;
            color: white;
            z-index: 2;
        }

        .chat-bubble-pulse {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(230, 0, 35, 0.6);
            animation: pulse-ring 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .chat-unread-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4444;
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 11px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3;
            border: 2px solid white;
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }

        /* Messenger Style Chat Widget */
        .messenger-chat-widget {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 1000;
            font-family: 'Inter', sans-serif;
        }

        .messenger-chat-toggle {
            width: 60px;
            height: 60px;
            background: #FFFFFF;
            border: 2px solid #000000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            position: relative;
            padding: 0;
        }

        .messenger-chat-toggle:hover {
            transform: scale(1.1);
            background: #000000;
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.5);
        }

        .messenger-chat-toggle:hover i {
            color: #FFFFFF;
        }

        .messenger-chat-toggle i {
            font-size: 24px;
            color: #000000;
            z-index: 2;
            transition: color 0.3s;
        }

        .messenger-chat-pulse {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.3);
            animation: pulse-ring 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .messenger-unread-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #000000;
            color: #FFFFFF;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 11px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3;
            border: 2px solid #FFFFFF;
        }

        /* Messenger Chat Window */
        .messenger-chat-window {
            position: absolute;
            bottom: 0;
            right: 70px;
            width: 380px;
            height: 600px;
            background: #FFFFFF;
            border: 2px solid #000000;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .messenger-chat-header {
            background: #FFFFFF;
            border-bottom: 2px solid #000000;
            color: #000000;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .messenger-chat-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 16px;
        }

        .messenger-chat-controls {
            display: flex;
            gap: 8px;
        }

        .messenger-btn-minimize,
        .messenger-btn-close {
            background: #FFFFFF;
            border: 2px solid #000000;
            color: #000000;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .messenger-btn-minimize:hover,
        .messenger-btn-close:hover {
            background: #000000;
            color: #FFFFFF;
        }

        .messenger-chat-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Rooms View */
        .messenger-rooms-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .messenger-rooms-header {
            padding: 16px 20px;
            border-bottom: 2px solid #000000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .messenger-rooms-header h6 {
            margin: 0;
            font-weight: 600;
            font-size: 16px;
            color: #111827;
        }

        .messenger-btn-new-chat {
            background: #000000;
            border: 2px solid #000000;
            color: #FFFFFF;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .messenger-btn-new-chat:hover {
            background: #FFFFFF;
            color: #000000;
        }

        .messenger-loading,
        .messenger-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
        }

        .messenger-loading {
            gap: 12px;
        }

        .messenger-empty i {
            font-size: 48px;
            color: #9CA3AF;
            margin-bottom: 16px;
        }

        .messenger-empty p {
            color: #6B7280;
            margin-bottom: 16px;
        }

        .messenger-btn-link {
            color: #000000;
            text-decoration: none;
            font-weight: 500;
            border-bottom: 1px solid #000000;
        }

        .messenger-btn-link:hover {
            border-bottom: 2px solid #000000;
        }

        .messenger-rooms-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
        }

        .messenger-room-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid #E5E7EB;
        }

        .messenger-room-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .messenger-room-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #FFFFFF;
            border: 2px solid #000000;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .messenger-room-avatar i {
            color: #000000;
            font-size: 20px;
        }

        .messenger-room-info {
            flex: 1;
            min-width: 0;
        }

        .messenger-room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .messenger-room-name {
            font-weight: 600;
            font-size: 15px;
            color: #111827;
            margin: 0;
        }

        .messenger-room-time {
            font-size: 12px;
            color: #6B7280;
            white-space: nowrap;
        }

        .messenger-room-message {
            font-size: 14px;
            color: #6B7280;
            margin: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .messenger-room-unread {
            background: #000000;
            color: #FFFFFF;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: 600;
            min-width: 18px;
            text-align: center;
            margin-left: 8px;
        }

        /* Chat View */
        .messenger-chat-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .messenger-chat-view-header {
            padding: 12px 16px;
            border-bottom: 2px solid #000000;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .messenger-btn-back {
            background: #FFFFFF;
            border: 2px solid #000000;
            color: #000000;
            font-size: 18px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .messenger-btn-back:hover {
            background: #000000;
            color: #FFFFFF;
        }

        .messenger-chat-info h6 {
            margin: 0;
            font-weight: 600;
            font-size: 15px;
            color: #111827;
        }

        .messenger-chat-info small {
            color: #6B7280;
            font-size: 12px;
        }

        .messenger-messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: #FFFFFF;
        }

        .messenger-message-item {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            max-width: 75%;
        }

        .messenger-message-item.own-message {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .messenger-message-content {
            background: #FFFFFF;
            border: 2px solid #000000;
            border-radius: 18px;
            padding: 8px 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .messenger-message-item.own-message .messenger-message-content {
            background: #000000;
            border: 2px solid #000000;
            color: #FFFFFF;
        }

        .messenger-message-text {
            font-size: 14px;
            line-height: 1.4;
            color: #111827;
            margin: 0;
        }

        .messenger-message-item.own-message .messenger-message-text {
            color: white;
        }

        .messenger-message-time {
            font-size: 11px;
            color: #9CA3AF;
            margin-top: 4px;
        }

        .messenger-message-item.own-message .messenger-message-time {
            color: rgba(255, 255, 255, 0.8);
        }

        .messenger-typing-indicator {
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .messenger-typing-dots {
            display: flex;
            gap: 4px;
        }

        .messenger-typing-dots span {
            width: 8px;
            height: 8px;
            background: #9CA3AF;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .messenger-typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .messenger-typing-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        .messenger-message-input {
            padding: 12px 16px;
            border-top: 2px solid #000000;
            display: flex;
            gap: 8px;
            align-items: center;
            background: #FFFFFF;
        }

        .messenger-input {
            flex: 1;
            border: 2px solid #000000;
            border-radius: 20px;
            padding: 10px 16px;
            font-size: 14px;
            outline: none;
            background: #FFFFFF;
            color: #000000;
        }

        .messenger-input:focus {
            border-color: #000000;
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.2);
        }

        .messenger-btn-send {
            background: #000000;
            border: 2px solid #000000;
            color: #FFFFFF;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .messenger-btn-send:hover {
            background: #FFFFFF;
            color: #000000;
        }

        .messenger-btn-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .chat-bubble-container {
                bottom: 16px;
                right: 16px;
            }

            .chat-bubble {
                width: 56px;
                height: 56px;
            }

            .chat-bubble i {
                font-size: 22px;
            }

            .messenger-chat-widget {
                bottom: 16px;
                right: 16px;
            }

            .messenger-chat-toggle {
                width: 56px;
                height: 56px;
            }

            .messenger-chat-toggle i {
                font-size: 22px;
            }

            .messenger-chat-window {
                width: calc(100vw - 32px);
                height: calc(100vh - 100px);
                bottom: 0;
                right: 70px;
                left: auto;
                max-width: 100%;
            }

            .messenger-room-item {
                padding: 12px 16px;
            }

            .messenger-room-avatar {
                width: 40px;
                height: 40px;
                margin-right: 10px;
            }

            .messenger-message-item {
                max-width: 85%;
            }
        }
    </style>

    <div class="toast-container">
        <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="fas fa-heart text-danger me-2"></i>
                <strong class="me-auto">Thông báo</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Đóng"></button>
            </div>
            <div class="toast-body" id="toastMessage"></div>
        </div>
    </div>

    <!-- APP_CTX Bootstrapper (must be before location.js) -->
    <script th:inline="javascript">
      window.APP_CTX = window.APP_CTX || {};
      APP_CTX.authenticated = /*[[${#authorization.expression('isAuthenticated()')}]]*/ false;
      APP_CTX.isRestaurantOwner = /*[[${#authorization.expression('hasRole(''RESTAURANT_OWNER'')')}]]*/ false;
      APP_CTX.showLocationPrompt = /*[[${session.SHOW_LOCATION_PROMPT != null ? session.SHOW_LOCATION_PROMPT : false}]]*/ false;
      APP_CTX.baseUrl = /*[[@{/}]]*/ '/';
      console.log('🚀 APP_CTX initialized on restaurants page:', {
        authenticated: APP_CTX.authenticated,
        isRestaurantOwner: APP_CTX.isRestaurantOwner,
        showLocationPrompt: APP_CTX.showLocationPrompt
      });
    </script>

    <div th:replace="~{fragments/resy-scripts :: basic-scripts}"></div>

    <!-- WebSocket Libraries for Chat -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Wait a bit for Thymeleaf to render all elements
            setTimeout(loadFavoriteStatus, 100);

            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', function (event) {
                    if (event.key === 'Enter') {
                        applyFilters();
                    }
                });
            }
            
            // Note: We don't auto-add location to URL anymore
            // Location will only be added when user clicks "Nhà hàng gần bạn" button
        });

        function loadFavoriteStatus() {
            fetch('/customer/favorites/ids')
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) {
                            return [];
                        }
                        throw new Error('Failed to fetch favorite restaurant IDs');
                    }
                    return response.json();
                })
                .then(restaurantIds => {
                    console.log('Loaded favorite restaurant IDs:', restaurantIds);
                    restaurantIds.forEach(restaurantId => {
                        const heartIcon = document.querySelector(`.heart-icon[data-restaurant-id="${restaurantId}"]`);
                        if (heartIcon) {
                            // Change from outline to filled icon
                            heartIcon.classList.remove('far');
                            heartIcon.classList.add('fas', 'favorited');
                            console.log('Marked restaurant ' + restaurantId + ' as favorited');
                        }
                    });
                })
                .catch(error => console.error('Error loading favorites:', error));
        }

        function toggleFavorite(heartIcon) {
            const restaurantId = heartIcon.getAttribute('data-restaurant-id');
            const wasFavorited = heartIcon.classList.contains('favorited');

            if (!restaurantId) {
                return;
            }

            heartIcon.style.pointerEvents = 'none';
            heartIcon.style.opacity = '0.6';

            // Optimistic update (temporary UI change)
            if (wasFavorited) {
                heartIcon.classList.remove('favorited', 'fas');
                heartIcon.classList.add('far');
            } else {
                heartIcon.classList.remove('far');
                heartIcon.classList.add('fas', 'favorited');
                heartIcon.style.animation = 'heartbeat 0.6s ease-in-out';
            }

            const request = {
                restaurantId: parseInt(restaurantId)
            };

            fetch('/customer/favorites/toggle', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin',
                body: JSON.stringify(request)
            })
                .then(response => {
                    if (response.status === 401 || response.status === 403) {
                        // Not authenticated - redirect to login
                        if (confirm('Bạn cần đăng nhập để thêm vào danh sách yêu thích. Bạn có muốn đăng nhập không?')) {
                            window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname + window.location.search);
                        }
                        // Rollback UI
                        if (wasFavorited) {
                            heartIcon.classList.remove('far');
                            heartIcon.classList.add('fas', 'favorited');
                        } else {
                            heartIcon.classList.remove('favorited', 'fas');
                            heartIcon.classList.add('far');
                        }
                        return null;
                    }
                    
                    if (!response.ok) {
                        throw new Error('Failed to toggle favorite: ' + response.status);
                    }
                    
                    return response.json();
                })
                .then(data => {
                    if (!data) return; // Not authenticated, already handled
                    
                    console.log('Toggle favorite response:', data);
                    
                    if (data.success) {
                        // Update UI based on server response
                        if (data.isFavorited === true) {
                            // Now favorited - change to filled icon
                            heartIcon.classList.remove('far');
                            heartIcon.classList.add('fas', 'favorited');
                            if (!wasFavorited) {
                                heartIcon.style.animation = 'heartbeat 0.6s ease-in-out';
                            }
                        } else if (data.isFavorited === false) {
                            // Now not favorited - change to outline icon
                            heartIcon.classList.remove('favorited', 'fas');
                            heartIcon.classList.add('far');
                        }
                        
                        showToast(data.message, 'success');
                    } else {
                        // Rollback UI on error
                        if (wasFavorited) {
                            heartIcon.classList.remove('far');
                            heartIcon.classList.add('fas', 'favorited');
                        } else {
                            heartIcon.classList.remove('favorited', 'fas');
                            heartIcon.classList.add('far');
                        }
                        showToast(data.message || 'Có lỗi xảy ra', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Rollback UI on error
                    if (wasFavorited) {
                        heartIcon.classList.remove('far');
                        heartIcon.classList.add('fas', 'favorited');
                    } else {
                        heartIcon.classList.remove('favorited', 'fas');
                        heartIcon.classList.add('far');
                    }
                    showToast('Có lỗi xảy ra khi cập nhật yêu thích', 'error');
                })
                .finally(() => {
                    heartIcon.style.pointerEvents = 'auto';
                    heartIcon.style.opacity = '1';
                    // Clear animation after it completes
                    setTimeout(() => {
                        heartIcon.style.animation = '';
                    }, 600);
                });
        }

        function showToast(message, type) {
            const toastElement = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');

            toastMessage.textContent = message;

            if (type === 'success') {
                toastElement.classList.add('bg-success', 'text-white');
            } else if (type === 'error') {
                toastElement.classList.add('bg-danger', 'text-white');
            }

            const toast = new bootstrap.Toast(toastElement);
            toast.show();

            toastElement.addEventListener('hidden.bs.toast', function () {
                toastElement.classList.remove('bg-success', 'bg-danger', 'text-white');
            }, { once: true });
        }

        function applyFilters() {
            const searchInput = document.getElementById('searchInput');
            const cuisineFilter = document.getElementById('cuisineFilter');
            const priceFilter = document.getElementById('priceFilter');
            const sortSelect = document.getElementById('sortSelect');
            const distanceFilter = document.getElementById('distanceFilter');
            
            if (!searchInput || !cuisineFilter || !priceFilter || !sortSelect) {
                console.error('Filter elements not found');
                return;
            }
            
            const search = searchInput.value.trim();
            const cuisineType = cuisineFilter.value;
            const priceRange = priceFilter.value;
            const sortValue = sortSelect.value;
            const [sortBy, sortDir] = sortValue.split('-');
            const maxDistance = distanceFilter ? distanceFilter.value : null;

            const url = new URL(window.location);
            
            // Set search params
            if (search) {
                url.searchParams.set('search', search);
            } else {
                url.searchParams.delete('search');
            }
            
            if (cuisineType) {
                url.searchParams.set('cuisineType', cuisineType);
            } else {
                url.searchParams.delete('cuisineType');
            }
            
            if (priceRange) {
                url.searchParams.set('priceRange', priceRange);
            } else {
                url.searchParams.delete('priceRange');
            }
            
            // Preserve location parameters if they exist
            const urlParams = new URLSearchParams(window.location.search);
            const latitude = urlParams.get('latitude');
            const longitude = urlParams.get('longitude');
            const nearby = urlParams.get('nearby');
            
            // Set distance filter if provided and location is available (for nearby search)
            if (maxDistance && maxDistance !== '' && latitude && longitude && nearby === 'true') {
                url.searchParams.set('maxDistance', maxDistance);
                // When applying distance filter with location, sort by distance
                url.searchParams.set('sortBy', 'distance');
                url.searchParams.set('sortDir', 'asc');
            } else if (maxDistance && maxDistance !== '') {
                // Distance filter selected but no location - remove it
                url.searchParams.delete('maxDistance');
            } else {
                url.searchParams.delete('maxDistance');
            }
            
            if (latitude && longitude && nearby === 'true') {
                url.searchParams.set('latitude', latitude);
                url.searchParams.set('longitude', longitude);
                url.searchParams.set('nearby', 'true');
                // If distance filter is applied, ensure sort by distance
                if (maxDistance && maxDistance !== '') {
                    url.searchParams.set('sortBy', 'distance');
                    url.searchParams.set('sortDir', 'asc');
                } else {
                    // Use selected sort, but prefer distance if available
                    url.searchParams.set('sortBy', sortBy);
                    url.searchParams.set('sortDir', sortDir);
                }
            } else {
                // No location - use selected sort
                url.searchParams.set('sortBy', sortBy);
                url.searchParams.set('sortDir', sortDir);
            }
            
            url.searchParams.set('page', '0');

            console.log('Applying filters:', { search, cuisineType, priceRange, maxDistance, sortBy, sortDir });
            window.location.href = url.toString();
        }

        function clearFilters() {
            const searchInput = document.getElementById('searchInput');
            const cuisineFilter = document.getElementById('cuisineFilter');
            const priceFilter = document.getElementById('priceFilter');
            const sortSelect = document.getElementById('sortSelect');
            const distanceFilter = document.getElementById('distanceFilter');
            
            if (searchInput) searchInput.value = '';
            if (cuisineFilter) cuisineFilter.value = '';
            if (priceFilter) priceFilter.value = '';
            if (sortSelect) sortSelect.value = 'restaurantName-asc';
            if (distanceFilter) distanceFilter.value = '';

            const url = new URL(window.location);
            url.searchParams.delete('search');
            url.searchParams.delete('cuisineType');
            url.searchParams.delete('priceRange');
            url.searchParams.delete('ratingFilter');
            url.searchParams.delete('maxDistance');
            
            // Preserve location parameters if they exist (keep nearby search active)
            const urlParams = new URLSearchParams(window.location.search);
            const latitude = urlParams.get('latitude');
            const longitude = urlParams.get('longitude');
            const nearby = urlParams.get('nearby');
            
            if (latitude && longitude && nearby === 'true') {
                url.searchParams.set('latitude', latitude);
                url.searchParams.set('longitude', longitude);
                url.searchParams.set('nearby', 'true');
                url.searchParams.set('sortBy', 'distance');
                url.searchParams.set('sortDir', 'asc');
            } else {
                url.searchParams.set('sortBy', 'restaurantName');
                url.searchParams.set('sortDir', 'asc');
            }
            
            url.searchParams.set('page', '0');

            window.location.href = url.toString();
        }
        
        function findNearbyRestaurants() {
            const btn = document.getElementById('nearbyRestaurantsBtn');
            if (!btn) return;
            
            // Disable button and show loading state
            btn.disabled = true;
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang tìm...';
            
            // Wait for LocationUtils to be available
            function tryGetLocation() {
                if (window.LocationUtils && window.LocationUtils.getUserLocation) {
                    console.log('✅ LocationUtils is available, getting location...');
                    window.LocationUtils.getUserLocation(
                        function(position) {
                            const latitude = position.latitude;
                            const longitude = position.longitude;
                            
                            console.log('✅ User location retrieved (from cache or new):', latitude, longitude);
                            console.log('📍 Location details:', {
                                latitude: latitude,
                                longitude: longitude,
                                accuracy: position.accuracy || 'N/A',
                                timestamp: new Date().toISOString()
                            });
                            
                            // Validate coordinates
                            if (latitude < -90 || latitude > 90 || longitude < -180 || longitude > 180) {
                                console.error('❌ Invalid coordinates:', latitude, longitude);
                                btn.disabled = false;
                                btn.innerHTML = originalHTML;
                                showToast('Tọa độ không hợp lệ. Vui lòng thử lại.', 'error');
                                return;
                            }
                            
                            // Check if coordinates seem reasonable for Vietnam
                            // Vietnam bounds: ~8.5°N to 23.5°N, ~102°E to 110°E
                            if (latitude < 8 || latitude > 24 || longitude < 102 || longitude > 111) {
                                console.warn('⚠️ Coordinates outside Vietnam bounds:', latitude, longitude);
                                console.warn('   Expected range: lat 8-24, lon 102-111');
                                console.warn('   Đà Nẵng should be around: lat 16.047079, lon 108.206230');
                                // Still proceed, but log warning
                            }
                            
                            // Get maxDistance from distance filter if available
                            const distanceFilter = document.getElementById('distanceFilter');
                            const maxDistance = distanceFilter ? distanceFilter.value : '';
                            
                            // Redirect to restaurants page with location parameters
                            const url = new URL(window.location);
                            url.searchParams.set('latitude', latitude);
                            url.searchParams.set('longitude', longitude);
                            url.searchParams.set('nearby', 'true');
                            url.searchParams.set('page', '0');
                            
                            // Clear other filters when using nearby search
                            url.searchParams.delete('search');
                            url.searchParams.delete('cuisineType');
                            url.searchParams.delete('priceRange');
                            url.searchParams.delete('ratingFilter');
                            
                            // Apply maxDistance filter if selected
                            if (maxDistance) {
                                url.searchParams.set('maxDistance', maxDistance);
                                console.log('📍 Applying distance filter: ' + maxDistance + ' km');
                            } else {
                                url.searchParams.delete('maxDistance');
                            }
                            
                            url.searchParams.set('sortBy', 'distance');
                            url.searchParams.set('sortDir', 'asc');
                            
                            console.log('🔄 Redirecting to:', url.toString());
                            window.location.href = url.toString();
                        },
                        function(errorMessage) {
                            console.error('❌ Error getting location:', errorMessage);
                            btn.disabled = false;
                            btn.innerHTML = originalHTML;
                            showToast(errorMessage, 'error');
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 30 * 60 * 1000  // Allow using cached location up to 30 minutes old
                        }
                    );
                } else {
                    console.log('⏳ Waiting for LocationUtils...');
                    // Retry after a short delay
                    setTimeout(tryGetLocation, 100);
                }
            }
            
            // Start trying to get location
            tryGetLocation();
            
            // Fallback to direct geolocation if LocationUtils not available after 2 seconds
            let fallbackTimeout = setTimeout(function() {
                if (!window.LocationUtils || !window.LocationUtils.getUserLocation) {
                    console.log('⚠️ LocationUtils not available after 2 seconds, using fallback geolocation');
                    
                    if (!navigator.geolocation) {
                        showToast('Trình duyệt của bạn không hỗ trợ định vị. Vui lòng sử dụng trình duyệt khác.', 'error');
                        btn.disabled = false;
                        btn.innerHTML = originalHTML;
                        return;
                    }
                    
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            const latitude = position.coords.latitude;
                            const longitude = position.coords.longitude;
                            
                            // Save to LocationUtils if available
                            if (window.LocationUtils && window.LocationUtils.setLocation) {
                                window.LocationUtils.setLocation(latitude, longitude);
                            }
                            
                            console.log('✅ User location (fallback):', latitude, longitude);
                            
                            // Redirect to restaurants page with location parameters
                            const url = new URL(window.location);
                            url.searchParams.set('latitude', latitude);
                            url.searchParams.set('longitude', longitude);
                            url.searchParams.set('nearby', 'true');
                            url.searchParams.set('page', '0');
                            
                            // Clear other filters when using nearby search
                            url.searchParams.delete('search');
                            url.searchParams.delete('cuisineType');
                            url.searchParams.delete('priceRange');
                            url.searchParams.delete('ratingFilter');
                            url.searchParams.set('sortBy', 'distance');
                            url.searchParams.set('sortDir', 'asc');
                            
                            window.location.href = url.toString();
                        },
                        function(error) {
                            btn.disabled = false;
                            btn.innerHTML = originalHTML;
                            
                            let errorMessage = 'Không thể lấy vị trí của bạn. ';
                            switch(error.code) {
                                case error.PERMISSION_DENIED:
                                    errorMessage += 'Bạn đã từ chối quyền truy cập vị trí. Vui lòng cho phép truy cập vị trí trong cài đặt trình duyệt.';
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                    errorMessage += 'Vị trí không khả dụng.';
                                    break;
                                case error.TIMEOUT:
                                    errorMessage += 'Yêu cầu lấy vị trí đã hết thời gian chờ.';
                                    break;
                                default:
                                    errorMessage += 'Đã xảy ra lỗi không xác định.';
                                    break;
                            }
                            showToast(errorMessage, 'error');
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 30 * 60 * 1000  // Allow using cached location up to 30 minutes old
                        }
                    );
                }
            }, 2000);
            
            // Clear fallback timeout if LocationUtils becomes available
            const checkInterval = setInterval(function() {
                if (window.LocationUtils && window.LocationUtils.getUserLocation) {
                    clearTimeout(fallbackTimeout);
                    clearInterval(checkInterval);
                }
            }, 100);
        }
        
        // Make functions globally available
        window.applyFilters = applyFilters;
        window.clearFilters = clearFilters;
        window.findNearbyRestaurants = findNearbyRestaurants;
        
        // Auto-apply distance filter when changed (if location is available)
        document.addEventListener('DOMContentLoaded', function() {
            const distanceFilter = document.getElementById('distanceFilter');
            if (distanceFilter) {
                // Check if location is available in URL
                const urlParams = new URLSearchParams(window.location.search);
                const latitude = urlParams.get('latitude');
                const longitude = urlParams.get('longitude');
                const nearby = urlParams.get('nearby');
                
                // Only auto-apply if location is available (nearby search is active)
                if (latitude && longitude && nearby === 'true') {
                    distanceFilter.addEventListener('change', function() {
                        const maxDistance = this.value;
                        console.log('📍 Distance filter changed:', maxDistance);
                        
                        // Apply filter immediately if location is available
                        if (maxDistance) {
                            console.log('✅ Auto-applying distance filter:', maxDistance + ' km');
                            applyFilters();
                        } else {
                            // Clear distance filter
                            console.log('🗑️ Clearing distance filter');
                            applyFilters();
                        }
                    });
                }
            }
        });

        // Messenger Chat Widget
        class MessengerChatWidget {
            constructor() {
                this.socket = null;
                this.stompClient = null;
                this.currentRoomId = null;
                this.currentUserId = null;
                this.isConnected = false;
                this.isMinimized = false;
                this.typingTimer = null;
                
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                this.loadUnreadCount();
                this.initWebSocket();
            }
            
            setupEventListeners() {
                const toggleBtn = document.getElementById('messengerChatToggle');
                const minimizeBtn = document.getElementById('messengerMinimizeBtn');
                const closeBtn = document.getElementById('messengerCloseBtn');
                const backBtn = document.getElementById('messengerBackBtn');
                const sendBtn = document.getElementById('messengerSendBtn');
                const messageInput = document.getElementById('messengerMessageInput');
                const newChatBtn = document.getElementById('messengerNewChatBtn');
                
                if (toggleBtn) {
                    toggleBtn.addEventListener('click', () => this.toggleChat());
                }
                
                if (minimizeBtn) {
                    minimizeBtn.addEventListener('click', () => this.minimizeChat());
                }
                
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => this.closeChat());
                }
                
                if (backBtn) {
                    backBtn.addEventListener('click', () => this.backToRooms());
                }
                
                if (sendBtn) {
                    sendBtn.addEventListener('click', () => this.sendMessage());
                }
                
                if (messageInput) {
                    messageInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            this.sendMessage();
                        }
                    });
                    
                    messageInput.addEventListener('input', () => {
                        this.handleTyping();
                    });
                }
                
                if (newChatBtn) {
                    newChatBtn.addEventListener('click', () => {
                        window.location.href = '/customer/chat';
                    });
                }
            }
            
            toggleChat() {
                const window = document.getElementById('messengerChatWindow');
                if (window.style.display === 'none') {
                    this.openChat();
                } else {
                    this.closeChat();
                }
            }
            
            openChat() {
                const window = document.getElementById('messengerChatWindow');
                window.style.display = 'flex';
                this.isMinimized = false;
                this.loadChatRooms();
            }
            
            minimizeChat() {
                const window = document.getElementById('messengerChatWindow');
                window.style.display = 'none';
                this.isMinimized = true;
            }
            
            closeChat() {
                const window = document.getElementById('messengerChatWindow');
                window.style.display = 'none';
                this.currentRoomId = null;
                this.showRoomsView();
            }
            
            async loadChatRooms() {
                const loadingEl = document.getElementById('messengerRoomsLoading');
                const listEl = document.getElementById('messengerRoomsList');
                const emptyEl = document.getElementById('messengerRoomsEmpty');
                
                loadingEl.style.display = 'flex';
                listEl.style.display = 'none';
                emptyEl.style.display = 'none';
                
                try {
                    const response = await fetch('/api/chat/rooms');
                    if (!response.ok) throw new Error('Failed to load rooms');
                    
                    const rooms = await response.json();
                    loadingEl.style.display = 'none';
                    
                    if (rooms && rooms.length > 0) {
                        this.displayRooms(rooms);
                        listEl.style.display = 'block';
                    } else {
                        // Vẫn hiển thị AI Chat Assistant ngay cả khi không có room nào
                        this.displayRooms([]);
                        listEl.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error loading rooms:', error);
                    loadingEl.style.display = 'none';
                    // Vẫn hiển thị AI Chat Assistant khi có lỗi
                    this.displayRooms([]);
                    listEl.style.display = 'block';
                }
            }
            
            displayRooms(rooms) {
                const listEl = document.getElementById('messengerRoomsList');
                listEl.innerHTML = '';
                
                // Thêm AI Chat Assistant ở đầu danh sách (luôn luôn đầu tiên)
                const aiChatRoom = this.createAIChatRoom();
                listEl.appendChild(aiChatRoom);
                
                // Sắp xếp các room restaurant theo thời gian tin nhắn cuối cùng (mới nhất trước)
                const sortedRooms = [...rooms].sort((a, b) => {
                    const aTime = a.lastMessageAt ? new Date(a.lastMessageAt).getTime() : 0;
                    const bTime = b.lastMessageAt ? new Date(b.lastMessageAt).getTime() : 0;
                    return bTime - aTime; // Mới nhất trước
                });
                
                sortedRooms.forEach(room => {
                    const roomItem = this.createRoomItem(room);
                    listEl.appendChild(roomItem);
                });
            }
            
            createAIChatRoom() {
                const item = document.createElement('div');
                item.className = 'messenger-room-item';
                item.setAttribute('data-ai-chat', 'true');
                item.addEventListener('click', () => this.openAIChat());
                
                const avatar = document.createElement('div');
                avatar.className = 'messenger-room-avatar';
                avatar.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                avatar.innerHTML = '<i class="fas fa-robot"></i>';
                
                const info = document.createElement('div');
                info.className = 'messenger-room-info';
                
                const header = document.createElement('div');
                header.className = 'messenger-room-header';
                
                const name = document.createElement('h6');
                name.className = 'messenger-room-name';
                name.textContent = 'Trợ Lý AI';
                
                const status = document.createElement('span');
                status.className = 'messenger-room-time';
                status.textContent = 'Luôn sẵn sàng';
                status.style.color = '#4CAF50';
                
                header.appendChild(name);
                header.appendChild(status);
                
                const message = document.createElement('p');
                message.className = 'messenger-room-message';
                message.textContent = 'Chào bạn! Tôi có thể giúp gì cho bạn?';
                
                info.appendChild(header);
                info.appendChild(message);
                
                item.appendChild(avatar);
                item.appendChild(info);
                
                return item;
            }
            
            async openAIChat() {
                this.currentRoomId = 'AI_CHAT';
                this.showChatView('Trợ Lý AI');
                
                // Load AI chat messages từ localStorage hoặc tạo mới
                const aiMessages = this.getAIChatMessages();
                this.displayAIMessages(aiMessages);
                
                // Focus vào input
                const messageInput = document.getElementById('messengerMessageInput');
                if (messageInput) {
                    messageInput.focus();
                }
            }
            
            getAIChatMessages() {
                const stored = localStorage.getItem('ai_chat_messages');
                if (stored) {
                    try {
                        return JSON.parse(stored);
                    } catch (e) {
                        return [];
                    }
                }
                return [];
            }
            
            saveAIChatMessages(messages) {
                localStorage.setItem('ai_chat_messages', JSON.stringify(messages));
            }
            
            displayAIMessages(messages) {
                const container = document.getElementById('messengerMessagesContainer');
                container.innerHTML = '';
                
                if (messages.length === 0) {
                    // Tin nhắn chào mừng mặc định
                    const welcomeMsg = {
                        content: 'Xin chào! Tôi là Trợ Lý AI của Book Eat. Tôi có thể giúp bạn tìm nhà hàng, đặt bàn và trả lời các câu hỏi về dịch vụ. Bạn cần hỗ trợ gì?',
                        senderId: 'AI',
                        senderName: 'Trợ Lý AI',
                        sentAt: new Date().toISOString()
                    };
                    messages = [welcomeMsg];
                }
                
                messages.forEach(message => {
                    const messageEl = this.createMessageElement(message);
                    container.appendChild(messageEl);
                });
                
                this.scrollToBottom();
            }
            
            createRoomItem(room) {
                const item = document.createElement('div');
                item.className = 'messenger-room-item';
                item.addEventListener('click', () => this.openChatRoom(room.roomId, room.restaurantName));
                
                const avatar = document.createElement('div');
                avatar.className = 'messenger-room-avatar';
                avatar.innerHTML = '<i class="fas fa-store"></i>';
                
                const info = document.createElement('div');
                info.className = 'messenger-room-info';
                
                const header = document.createElement('div');
                header.className = 'messenger-room-header';
                
                const name = document.createElement('h6');
                name.className = 'messenger-room-name';
                name.textContent = room.restaurantName || 'Nhà hàng';
                
                const time = document.createElement('span');
                time.className = 'messenger-room-time';
                if (room.lastMessageAt) {
                    time.textContent = this.formatTime(room.lastMessageAt);
                }
                
                header.appendChild(name);
                if (room.lastMessageAt) header.appendChild(time);
                
                if (room.unreadCount && room.unreadCount > 0) {
                    const badge = document.createElement('span');
                    badge.className = 'messenger-room-unread';
                    badge.textContent = room.unreadCount > 99 ? '99+' : room.unreadCount;
                    header.appendChild(badge);
                }
                
                const message = document.createElement('p');
                message.className = 'messenger-room-message';
                message.textContent = room.lastMessage || 'Chưa có tin nhắn';
                
                info.appendChild(header);
                info.appendChild(message);
                
                item.appendChild(avatar);
                item.appendChild(info);
                
                return item;
            }
            
            async openChatRoom(roomId, roomName) {
                this.currentRoomId = roomId;
                this.showChatView(roomName);
                await this.loadMessages(roomId);
                await this.markMessagesAsRead(roomId);
                this.joinRoom(roomId);
            }
            
            showChatView(roomName) {
                document.getElementById('messengerRoomsView').style.display = 'none';
                document.getElementById('messengerChatView').style.display = 'flex';
                document.getElementById('messengerChatRoomName').textContent = roomName || 'Nhà hàng';
            }
            
            showRoomsView() {
                document.getElementById('messengerRoomsView').style.display = 'flex';
                document.getElementById('messengerChatView').style.display = 'none';
                this.currentRoomId = null;
            }
            
            backToRooms() {
                this.showRoomsView();
                this.loadChatRooms();
            }
            
            async loadMessages(roomId) {
                try {
                    const response = await fetch(`/api/chat/rooms/${roomId}/messages?page=0&size=50`);
                    if (response.ok) {
                        const messages = await response.json();
                        this.displayMessages(messages);
                    }
                } catch (error) {
                    console.error('Error loading messages:', error);
                }
            }
            
            displayMessages(messages) {
                const container = document.getElementById('messengerMessagesContainer');
                container.innerHTML = '';
                
                messages.forEach(message => {
                    const messageEl = this.createMessageElement(message);
                    container.appendChild(messageEl);
                });
                
                this.scrollToBottom();
            }
            
            createMessageElement(message) {
                const item = document.createElement('div');
                item.className = 'messenger-message-item';
                
                // Kiểm tra nếu là tin nhắn của user hoặc AI
                if (message.senderId === this.currentUserId || message.senderId === this.currentUserId?.toString()) {
                    item.classList.add('own-message');
                } else if (message.senderId === 'AI' || message.senderName === 'Trợ Lý AI') {
                    // Tin nhắn từ AI - không thêm own-message class
                    item.setAttribute('data-ai-message', 'true');
                }
                
                const content = document.createElement('div');
                content.className = 'messenger-message-content';
                
                const text = document.createElement('p');
                text.className = 'messenger-message-text';
                text.textContent = message.content || '';
                
                const time = document.createElement('div');
                time.className = 'messenger-message-time';
                time.textContent = this.formatTime(message.sentAt);
                
                content.appendChild(text);
                content.appendChild(time);
                item.appendChild(content);
                
                return item;
            }
            
            async sendMessage() {
                const input = document.getElementById('messengerMessageInput');
                const content = input.value.trim();
                
                if (!content || !this.currentRoomId || !this.isConnected) return;
                
                try {
                    this.stompClient.send('/app/chat.sendMessage', {}, JSON.stringify({
                        roomId: this.currentRoomId,
                        content: content
                    }));
                    
                    input.value = '';
                    this.stopTyping();
                } catch (error) {
                    console.error('Error sending message:', error);
                }
            }
            
            handleIncomingMessage(data) {
                if (!data || !data.messageId || !data.content) return;
                
                if (data.roomId === this.currentRoomId) {
                    const messageEl = this.createMessageElement(data);
                    document.getElementById('messengerMessagesContainer').appendChild(messageEl);
                    this.scrollToBottom();
                }
                
                this.loadChatRooms();
                this.loadUnreadCount();
            }
            
            handleTyping() {
                if (!this.currentRoomId || !this.isConnected) return;
                
                this.stompClient.send('/app/chat.typing', {}, JSON.stringify({
                    roomId: this.currentRoomId,
                    typing: true
                }));
                
                if (this.typingTimer) clearTimeout(this.typingTimer);
                this.typingTimer = setTimeout(() => this.stopTyping(), 1000);
            }
            
            stopTyping() {
                if (!this.currentRoomId || !this.isConnected) return;
                
                this.stompClient.send('/app/chat.typing', {}, JSON.stringify({
                    roomId: this.currentRoomId,
                    typing: false
                }));
                
                if (this.typingTimer) {
                    clearTimeout(this.typingTimer);
                    this.typingTimer = null;
                }
            }
            
            initWebSocket() {
                try {
                    this.socket = new SockJS('/ws');
                    this.stompClient = Stomp.over(this.socket);
                    
                    this.stompClient.connect({}, (frame) => {
                        this.isConnected = true;
                        this.subscribeToMessages();
                    }, (error) => {
                        console.error('WebSocket error:', error);
                        this.isConnected = false;
                    });
                } catch (error) {
                    console.error('Failed to init WebSocket:', error);
                }
            }
            
            subscribeToMessages() {
                if (!this.isConnected) return;
                
                this.stompClient.subscribe('/topic/room/*', (message) => {
                    const data = JSON.parse(message.body);
                    this.handleIncomingMessage(data);
                });
            }
            
            joinRoom(roomId) {
                if (!this.isConnected) return;
                this.stompClient.send('/app/chat.joinRoom', {}, JSON.stringify({ roomId }));
            }
            
            async markMessagesAsRead(roomId) {
                try {
                    await fetch(`/api/chat/rooms/${roomId}/read`, { method: 'POST' });
                } catch (error) {
                    console.error('Error marking as read:', error);
                }
            }
            
            async loadUnreadCount() {
                try {
                    const response = await fetch('/api/chat/unread-count');
                    if (response.ok) {
                        const data = await response.json();
                        const badge = document.getElementById('messengerUnreadBadge');
                        if (badge) {
                            if (data.unreadCount > 0) {
                                badge.textContent = data.unreadCount > 99 ? '99+' : data.unreadCount;
                                badge.style.display = 'flex';
                            } else {
                                badge.style.display = 'none';
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error loading unread count:', error);
                }
            }
            
            scrollToBottom() {
                const container = document.getElementById('messengerMessagesContainer');
                container.scrollTop = container.scrollHeight;
            }
            
            formatTime(dateTimeString) {
                if (!dateTimeString) return '';
                const date = new Date(dateTimeString);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);
                
                if (diffMins < 1) return 'Vừa xong';
                if (diffMins < 60) return `${diffMins} phút trước`;
                if (diffHours < 24) return `${diffHours} giờ trước`;
                if (diffDays < 7) return `${diffDays} ngày trước`;
                return date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' });
            }
        }
        
        // Initialize Messenger Chat Widget
        let messengerChatWidget;
        document.addEventListener('DOMContentLoaded', function() {
            // Load user info for chat
            fetch('/api/user/current')
                .then(response => response.json())
                .then(user => {
                    messengerChatWidget = new MessengerChatWidget();
                    messengerChatWidget.currentUserId = user.id;
                })
                .catch(error => {
                    console.error('Error loading user info:', error);
                    messengerChatWidget = new MessengerChatWidget();
                });
        });
    </script>
</body>
</html>
