<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
</head>
<body>
    <!-- Luxury Header Fragment -->
    <header th:fragment="site-header" class="luxury-header">
        <nav class="navbar navbar-expand-lg luxury-navbar fixed-top" id="luxuryNavbar">
            <div class="container">
                <!-- Logo -->
                <a class="navbar-brand" th:href="@{/}">
                    <i class="fas fa-utensils luxury-icon"></i>
                    <span class="brand-text">Book Eat</span>
                </a>
                
                <!-- Mobile Toggle Button -->
                <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" 
                        data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" 
                        aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon">
                        <i class="fas fa-bars"></i>
                    </span>
                </button>
                
                <!-- Navigation Menu -->
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav mx-auto">
                        <li class="nav-item">
                            <a class="nav-link" th:href="@{/}" th:classappend="${currentPath == '/'} ? 'active' : ''">
                                <i class="fas fa-home nav-icon"></i>
                                <span>Home</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" th:href="@{/restaurants}" th:classappend="${#strings.startsWith(currentPath, '/restaurants')} ? 'active' : ''">
                                <i class="fas fa-utensils nav-icon"></i>
                                <span>Restaurants</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" th:href="@{/about}" th:classappend="${currentPath == '/about'} ? 'active' : ''">
                                <i class="fas fa-info-circle nav-icon"></i>
                                <span>About</span>
                            </a>
                        </li>
                        <li class="nav-item" sec:authorize="hasRole('CUSTOMER')">
                            <a class="nav-link" th:href="@{/reviews/my-reviews}" th:classappend="${#strings.startsWith(currentPath, '/reviews')} ? 'active' : ''">
                                <i class="fas fa-star nav-icon"></i>
                                <span>My Reviews</span>
                            </a>
                        </li>
                        <li class="nav-item" sec:authorize="hasRole('RESTAURANT_OWNER')">
                            <a class="nav-link" th:href="@{/restaurant-owner/reviews}" th:classappend="${#strings.startsWith(currentPath, '/restaurant-owner/reviews')} ? 'active' : ''">
                                <i class="fas fa-comments nav-icon"></i>
                                <span>Reviews</span>
                            </a>
                        </li>
                        <li class="nav-item" sec:authorize="hasRole('RESTAURANT_OWNER')">
                            <a class="nav-link" th:href="@{/restaurant-owner/chat}" th:classappend="${#strings.startsWith(currentPath, '/restaurant-owner/chat')} ? 'active' : ''">
                                <i class="fas fa-comments nav-icon"></i>
                                <span>Chat</span>
                            </a>
                        </li>
                        <li class="nav-item" sec:authorize="isAuthenticated() and !hasRole('RESTAURANT_OWNER')">
                            <a class="nav-link" th:href="@{/booking/my}" th:classappend="${#strings.startsWith(currentPath, '/booking/my')} ? 'active' : ''">
                                <i class="fas fa-calendar-alt nav-icon"></i>
                                <span>My Reservations</span>
                            </a>
                        </li>
                    </ul>
                    
                    <!-- Auth & CTA Buttons -->
                    <ul class="navbar-nav">
                        <!-- Guest Buttons -->
                        <li class="nav-item" sec:authorize="!isAuthenticated()">
                            <a th:href="@{/login}" class="btn btn--outline me-2">
                                <i class="fas fa-sign-in-alt"></i>
                                <span>Sign In</span>
                            </a>
                        </li>
                        <li class="nav-item" sec:authorize="!isAuthenticated()">
                            <a th:href="@{/auth/register}" class="btn btn--outline me-2">
                                <i class="fas fa-user-plus"></i>
                                <span>Sign Up</span>
                            </a>
                        </li>
                        
                        <!-- Notification Bell (for authenticated non-admin users) -->
                        <li class="nav-item" sec:authorize="isAuthenticated() and !hasRole('ADMIN')">
                            <div th:insert="~{fragments/notification-bell :: notification-bell}"></div>
                        </li>
                        
                        <!-- User Dropdown -->
                        <li class="nav-item dropdown" sec:authorize="isAuthenticated()">
                            <a class="nav-link dropdown-toggle user-dropdown" href="#" role="button" 
                               data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-user-circle nav-icon"></i>
                                <span sec:authentication="name">User</span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end luxury-dropdown">
                                <li>
                                    <a class="dropdown-item" th:href="@{/auth/profile}">
                                        <i class="fas fa-user luxury-icon"></i>
                                        Profile
                                    </a>
                                </li>
                                <li sec:authorize="!hasRole('RESTAURANT_OWNER')">
                                    <a class="dropdown-item" th:href="@{/booking/my}">
                                        <i class="fas fa-calendar-alt luxury-icon"></i>
                                        My Reservations
                                    </a>
                                </li>
                                <!-- Admin Dropdown Item -->
                                <li sec:authorize="hasRole('ADMIN')">
                                    <a class="dropdown-item" th:href="@{/admin/dashboard}">
                                        <i class="fas fa-user-shield luxury-icon"></i>
                                        Admin Dashboard
                                    </a>
                                </li>
                                <li sec:authorize="hasRole('ADMIN')">
                                    <a class="dropdown-item" th:href="@{/admin/users}">
                                        <i class="fas fa-users luxury-icon"></i>
                                        User Management
                                    </a>
                                </li>

                                
                                <!-- Restaurant Owner Dropdown Item -->
                                <li sec:authorize="hasRole('RESTAURANT_OWNER')">
                                    <a class="dropdown-item" th:href="@{/restaurant-owner/dashboard}">
                                        <i class="fas fa-store luxury-icon"></i>
                                        Quản lý nhà hàng
                                    </a>
                                </li>
                                <li sec:authorize="hasRole('RESTAURANT_OWNER')">
                                    <a class="dropdown-item" th:href="@{/restaurant-owner/profile}">
                                        <i class="fas fa-building luxury-icon"></i>
                                        Hồ sơ nhà hàng
                                    </a>
                                </li>
                                <li sec:authorize="hasRole('RESTAURANT_OWNER')">
                                    <a class="dropdown-item" th:href="@{/restaurant-owner/chat}">
                                        <i class="fas fa-comments luxury-icon"></i>
                                        Chat với khách hàng
                                    </a>
                                </li>

                                <li sec:authorize="hasRole('ADMIN')">
                                    <a class="dropdown-item" th:href="@{/admin/notifications}">
                                        <i class="fas fa-bell luxury-icon"></i>
                                        Notification Management

                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <form th:action="@{/logout}" method="post" class="d-inline">
                                        <button type="submit" class="dropdown-item">
                                            <i class="fas fa-sign-out-alt luxury-icon"></i>
                                            Sign Out
                                        </button>
                                    </form>
                                </li>
                            </ul>
                        </li>
                        
                        <!-- Main CTA Button - Only for customers (NOT restaurant owners) -->
                        <li class="nav-item" sec:authorize="isAuthenticated() and !hasRole('RESTAURANT_OWNER')">
                            <a th:href="@{/booking/new}" class="btn btn-book-table ms-2">
                                <i class="fas fa-calendar-plus"></i>
                                <span>Book Table</span>
                            </a>
                        </li>
                        
                        <!-- Restaurant Owner Dashboard Button -->
                        <li class="nav-item" sec:authorize="hasRole('RESTAURANT_OWNER')">
                            <a th:href="@{/restaurant-owner/dashboard}" class="btn btn-book-table ms-2" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                <i class="fas fa-tachometer-alt"></i>
                                <span>Dashboard</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
        
        
        <!-- WebSocket Libraries -->
        <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
        
        <!-- Simple Chat Widget Test -->
        <div sec:authorize="isAuthenticated() and hasRole('CUSTOMER') or hasRole('customer')" id="chat-widget" class="chat-widget" style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
            <div class="chat-toggle" onclick="toggleChatWidget()" style="width: 60px; height: 60px; background: linear-gradient(135deg, #D4AF37, #FFD700); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);">
                <i class="fas fa-comments" style="color: #121212; font-size: 24px;"></i>
            </div>
            
            <!-- Simple Chat Panel -->
            <div id="chat-panel" class="chat-panel" style="position: absolute; bottom: 70px; right: 0; width: 380px; height: 600px; background: #1A1A1A; border-radius: 12px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); border: 1px solid #D4AF37; overflow: hidden; display: none;">
                <div style="background: linear-gradient(135deg, #D4AF37, #FFD700); color: #121212; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 10px; font-weight: 600;">
                        <i class="fas fa-comments" style="font-size: 18px;"></i>
                        <span>Chat</span>
                    </div>
                    <button onclick="toggleChatWidget()" style="background: none; border: none; color: #121212; font-size: 18px; cursor: pointer; padding: 5px; border-radius: 50%;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div style="flex: 1; padding: 20px; color: white;">
                    <h6 style="color: #D4AF37; margin-bottom: 15px;">Chọn nhà hàng để chat</h6>
                    <select id="restaurant-dropdown" style="background: #2A2A2A; border: 1px solid #444; color: #E0E0E0; border-radius: 8px; padding: 12px; font-size: 14px; width: 100%; margin-bottom: 15px;">
                        <option value="">Chọn nhà hàng...</option>
                    </select>
                    <button onclick="startChat()" style="background: linear-gradient(135deg, #D4AF37, #FFD700); border: none; color: #121212; font-weight: 600; border-radius: 8px; padding: 12px 20px; width: 100%;">
                        <i class="fas fa-comment"></i> Bắt đầu chat
                    </button>
                </div>
            </div>
        </div>
        
        <!-- JavaScript for Chat Widget -->
        <script>
            function toggleChatWidget() {
                console.log('Toggle chat widget clicked');
                const panel = document.getElementById('chat-panel');
                if (panel.style.display === 'none') {
                    panel.style.display = 'flex';
                    console.log('Chat panel opened');
                    loadRestaurants(); // Load restaurants when panel opens
                } else {
                    panel.style.display = 'none';
                    console.log('Chat panel closed');
                }
            }
            
            async function loadRestaurants() {
                try {
                    console.log('Loading restaurants...');
                    
                    // Test with credentials to ensure session is sent
                    const response = await fetch('/api/chat/available-restaurants', {
                        method: 'GET',
                        credentials: 'same-origin', // Include cookies/session
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    console.log('Restaurants API response status:', response.status);
                    console.log('Response headers:', response.headers.get('content-type'));
                    console.log('Response URL:', response.url);
                    
                    if (response.ok) {
                        // Check if response is JSON
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            const restaurants = await response.json();
                            console.log('Restaurants loaded:', restaurants);
                            populateRestaurantDropdown(restaurants);
                        } else {
                            // Server returned HTML instead of JSON
                            const htmlText = await response.text();
                            console.error('Server returned HTML instead of JSON:', htmlText.substring(0, 200));
                            alert('Lỗi: Server trả về HTML thay vì JSON. Response URL: ' + response.url);
                        }
                    } else {
                        // Handle error responses
                        const errorText = await response.text();
                        console.error('API Error:', response.status, errorText);
                        
                        if (response.status === 401) {
                            alert('Lỗi: Chưa đăng nhập hoặc session hết hạn. Vui lòng đăng nhập lại.');
                        } else if (response.status === 403) {
                            alert('Lỗi: Không có quyền truy cập API này.');
                        } else if (response.status === 404) {
                            alert('Lỗi: API endpoint không tồn tại. Kiểm tra đường dẫn API.');
                        } else if (response.status === 500) {
                            alert('Lỗi: Server internal error. Kiểm tra logs server.');
                        } else {
                            alert('Lỗi tải nhà hàng (' + response.status + '): ' + errorText.substring(0, 100));
                        }
                    }
                } catch (error) {
                    console.error('Failed to load restaurants:', error);
                    if (error.name === 'SyntaxError' && error.message.includes('Unexpected token')) {
                        alert('Lỗi: Server trả về HTML thay vì JSON. Kiểm tra API endpoint.');
                    } else {
                        alert('Lỗi kết nối: ' + error.message);
                    }
                }
            }
            
            function populateRestaurantDropdown(restaurants) {
                const dropdown = document.getElementById('restaurant-dropdown');
                dropdown.innerHTML = '<option value="">Chọn nhà hàng...</option>';
                
                restaurants.forEach(restaurant => {
                    const option = document.createElement('option');
                    option.value = restaurant.restaurantId;
                    option.textContent = restaurant.restaurantName;
                    dropdown.appendChild(option);
                });
                
                console.log('Restaurant dropdown populated with', restaurants.length, 'restaurants');
            }
            
            async function startChat() {
                const restaurantId = document.getElementById('restaurant-dropdown').value;
                if (!restaurantId) {
                    alert('Vui lòng chọn nhà hàng');
                    return;
                }
                
                try {
                    console.log('Starting chat with restaurant:', restaurantId);
                    const response = await fetch('/api/chat/rooms?restaurantId=' + restaurantId, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        }
                    });
                    
                    console.log('Response status:', response.status);
                    console.log('Response headers:', response.headers.get('content-type'));
                    
                    if (response.ok) {
                        // Check if response is JSON
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            const result = await response.json();
                            console.log('Chat room created:', result);
                            
                            // Open chat interface with the created room
                            openChatRoom(result.roomId, result.restaurantId);
                        } else {
                            // Server returned HTML instead of JSON
                            const htmlText = await response.text();
                            console.error('Server returned HTML instead of JSON:', htmlText.substring(0, 200));
                            alert('Lỗi: Server trả về HTML thay vì JSON. Có thể API chưa được triển khai hoặc có lỗi authentication.');
                        }
                    } else {
                        // Handle error responses
                        const errorText = await response.text();
                        console.error('Error creating chat room:', response.status, errorText);
                        
                        if (response.status === 401) {
                            alert('Lỗi: Chưa đăng nhập hoặc session hết hạn. Vui lòng đăng nhập lại.');
                        } else if (response.status === 403) {
                            alert('Lỗi: Không có quyền truy cập API này.');
                        } else if (response.status === 404) {
                            alert('Lỗi: API endpoint không tồn tại. Kiểm tra đường dẫn API.');
                        } else if (response.status === 500) {
                            alert('Lỗi: Server internal error. Kiểm tra logs server.');
                        } else {
                            alert('Lỗi tạo chat room (' + response.status + '): ' + errorText.substring(0, 100));
                        }
                    }
                } catch (error) {
                    console.error('Failed to create chat room:', error);
                    if (error.name === 'SyntaxError' && error.message.includes('Unexpected token')) {
                        alert('Lỗi: Server trả về HTML thay vì JSON. Kiểm tra API endpoint.');
                    } else {
                        alert('Lỗi kết nối: ' + error.message);
                    }
                }
            }
            
            async function openChatRoom(roomId, restaurantId) {
                console.log('Opening chat room:', roomId, 'for restaurant:', restaurantId);
                
                // Hide restaurant selection panel
                const restaurantPanel = document.querySelector('.chat-panel > div:last-child');
                if (restaurantPanel) {
                    restaurantPanel.style.display = 'none';
                }
                
                // Create chat interface
                const chatInterface = document.createElement('div');
                chatInterface.id = 'chat-interface';
                chatInterface.style.cssText = `
                    display: flex;
                    flex-direction: column;
                    height: 100%;
                    background: #1A1A1A;
                `;
                
                // Chat header
                const chatHeader = document.createElement('div');
                chatHeader.className = 'chat-header';
                chatHeader.style.cssText = `
                    background: linear-gradient(135deg, #D4AF37, #FFD700);
                    color: #121212;
                    padding: 15px 20px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    font-weight: 600;
                `;
                chatHeader.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-comments" style="font-size: 18px;"></i>
                        <span>Chat Room: ${roomId}</span>
                    </div>
                    <button onclick="closeChatRoom()" style="background: none; border: none; color: #121212; font-size: 18px; cursor: pointer; padding: 5px; border-radius: 50%;">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                // Messages area
                const messagesArea = document.createElement('div');
                messagesArea.id = 'messages-area';
                messagesArea.style.cssText = `
                    flex: 1;
                    padding: 20px;
                    overflow-y: auto;
                    background: #1A1A1A;
                    color: #E0E0E0;
                `;
                messagesArea.innerHTML = '<div style="text-align: center; color: #D4AF37;">Loading messages...</div>';
                
                // Message input area
                const inputArea = document.createElement('div');
                inputArea.style.cssText = `
                    padding: 20px;
                    background: #2A2A2A;
                    border-top: 1px solid #444;
                    display: flex;
                    gap: 10px;
                `;
                inputArea.innerHTML = `
                    <input type="text" id="message-input" placeholder="Type your message..." style="
                        flex: 1;
                        background: #1A1A1A;
                        border: 1px solid #444;
                        color: #E0E0E0;
                        padding: 12px;
                        border-radius: 8px;
                        font-size: 14px;
                    ">
                    <button onclick="sendMessage()" style="
                        background: linear-gradient(135deg, #D4AF37, #FFD700);
                        border: none;
                        color: #121212;
                        padding: 12px 20px;
                        border-radius: 8px;
                        font-weight: 600;
                        cursor: pointer;
                    ">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                `;
                
                // Assemble chat interface
                chatInterface.appendChild(chatHeader);
                chatInterface.appendChild(messagesArea);
                chatInterface.appendChild(inputArea);
                
                // Replace chat panel content
                const chatPanel = document.getElementById('chat-panel');
                chatPanel.innerHTML = '';
                chatPanel.appendChild(chatInterface);
                
                // Load messages
                await loadMessages(roomId);
                
                // Connect WebSocket
                connectWebSocket(roomId);
                
                console.log('Chat interface opened for room:', roomId);
            }
            
            function closeChatRoom() {
                console.log('Closing chat room');
                
                // Disconnect WebSocket
                if (window.stompClient) {
                    window.stompClient.disconnect();
                    window.stompClient = null;
                }
                
                // Reset chat panel to restaurant selection
                const chatPanel = document.getElementById('chat-panel');
                chatPanel.innerHTML = `
                    <div style="background: linear-gradient(135deg, #D4AF37, #FFD700); color: #121212; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 10px; font-weight: 600;">
                            <i class="fas fa-comments" style="font-size: 18px;"></i>
                            <span>Chat</span>
                        </div>
                        <button onclick="toggleChatWidget()" style="background: none; border: none; color: #121212; font-size: 18px; cursor: pointer; padding: 5px; border-radius: 50%;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div style="flex: 1; padding: 20px; color: white;">
                        <h6 style="color: #D4AF37; margin-bottom: 15px;">Chọn nhà hàng để chat</h6>
                        <select id="restaurant-dropdown" style="background: #2A2A2A; border: 1px solid #444; color: #E0E0E0; border-radius: 8px; padding: 12px; font-size: 14px; width: 100%; margin-bottom: 15px;">
                            <option value="">Chọn nhà hàng...</option>
                        </select>
                        <button onclick="startChat()" style="background: linear-gradient(135deg, #D4AF37, #FFD700); border: none; color: #121212; font-weight: 600; border-radius: 8px; padding: 12px 20px; width: 100%;">
                            <i class="fas fa-comment"></i> Bắt đầu chat
                        </button>
                    </div>
                `;
                
                // Reload restaurants
                loadRestaurants();
            }
            
            async function loadMessages(roomId) {
                try {
                    console.log('Loading messages for room:', roomId);
                    const response = await fetch(`/api/chat/rooms/${roomId}/messages`, {
                        credentials: 'same-origin',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const messages = await response.json();
                        console.log('Messages loaded:', messages);
                        displayMessages(messages);
                    } else {
                        console.error('Failed to load messages:', response.status);
                        document.getElementById('messages-area').innerHTML = '<div style="text-align: center; color: #ff6b6b;">Failed to load messages</div>';
                    }
                } catch (error) {
                    console.error('Error loading messages:', error);
                    document.getElementById('messages-area').innerHTML = '<div style="text-align: center; color: #ff6b6b;">Error loading messages</div>';
                }
            }
            
            function displayMessages(messages) {
                const messagesArea = document.getElementById('messages-area');
                if (!messages || messages.length === 0) {
                    messagesArea.innerHTML = '<div style="text-align: center; color: #D4AF37;">No messages yet. Start the conversation!</div>';
                    return;
                }
                
                const messagesHtml = messages.map(msg => {
                    // Safe handling of senderName
                    const senderName = msg.senderName || 'Người dùng';
                    
                    // Safe handling of sentAt
                    let timeText = 'Thời gian không xác định';
                    if (msg.sentAt) {
                        try {
                            const date = new Date(msg.sentAt);
                            if (!isNaN(date.getTime())) {
                                timeText = date.toLocaleString('vi-VN');
                            }
                        } catch (e) {
                            timeText = 'Thời gian không hợp lệ';
                        }
                    }
                    
                    // Safe handling of content
                    const content = msg.content || '';
                    
                    return `
                        <div style="margin-bottom: 15px; padding: 10px; background: #2A2A2A; border-radius: 8px;">
                            <div style="font-size: 12px; color: #D4AF37; margin-bottom: 5px;">
                                ${senderName} • ${timeText}
                            </div>
                            <div style="color: #E0E0E0;">${content}</div>
                        </div>
                    `;
                }).join('');
                
                messagesArea.innerHTML = messagesHtml;
                messagesArea.scrollTop = messagesArea.scrollHeight;
            }
            
            function connectWebSocket(roomId) {
                console.log('Connecting WebSocket for room:', roomId);
                
                // Disconnect existing connection
                if (window.stompClient) {
                    window.stompClient.disconnect();
                }
                
                const socket = new SockJS('/ws');
                window.stompClient = Stomp.over(socket);
                
                window.stompClient.connect({}, function(frame) {
                    console.log('WebSocket connected:', frame);
                    
                    // Subscribe to room messages
                    window.stompClient.subscribe(`/topic/room/${roomId}`, function(message) {
                        const messageData = JSON.parse(message.body);
                        console.log('Received message:', messageData);
                        
                        // Only process valid chat messages (not join notifications or other events)
                        if (!messageData || !messageData.messageId || !messageData.content || !messageData.senderName || !messageData.sentAt) {
                            console.log('Ignoring non-message data:', messageData);
                            return;
                        }
                        
                        // Add new message to display
                        const messagesArea = document.getElementById('messages-area');
                        const messageDiv = document.createElement('div');
                        messageDiv.style.cssText = 'margin-bottom: 15px; padding: 10px; background: #2A2A2A; border-radius: 8px;';
                        
                        // Safe handling of senderName
                        const senderName = messageData.senderName || 'Người dùng';
                        
                        // Safe handling of sentAt
                        let timeText = 'Thời gian không xác định';
                        if (messageData.sentAt) {
                            try {
                                const date = new Date(messageData.sentAt);
                                if (!isNaN(date.getTime())) {
                                    timeText = date.toLocaleString('vi-VN');
                                }
                            } catch (e) {
                                timeText = 'Thời gian không hợp lệ';
                            }
                        }
                        
                        // Safe handling of content
                        const content = messageData.content || '';
                        
                        messageDiv.innerHTML = `
                            <div style="font-size: 12px; color: #D4AF37; margin-bottom: 5px;">
                                ${senderName} • ${timeText}
                            </div>
                            <div style="color: #E0E0E0;">${content}</div>
                        `;
                        messagesArea.appendChild(messageDiv);
                        messagesArea.scrollTop = messagesArea.scrollHeight;
                    });
                    
                }, function(error) {
                    console.error('WebSocket connection error:', error);
                });
            }
            
            function sendMessage() {
                const messageInput = document.getElementById('message-input');
                const content = messageInput.value.trim();
                
                if (!content) return;
                
                // Get room ID from chat header
                const chatHeader = document.querySelector('#chat-interface .chat-header');
                if (!chatHeader) {
                    console.error('Chat header not found');
                    alert('Chat header not found. Please refresh and try again.');
                    return;
                }
                
                const roomIdSpan = chatHeader.querySelector('span');
                if (!roomIdSpan) {
                    console.error('Room ID span not found');
                    alert('Room ID not found. Please refresh and try again.');
                    return;
                }
                
                const roomId = roomIdSpan.textContent.split(': ')[1];
                console.log('Sending message to room:', roomId);
                
                if (window.stompClient && window.stompClient.connected) {
                    window.stompClient.send('/app/chat.sendMessage', {}, JSON.stringify({
                        roomId: roomId,
                        content: content,
                        type: 'TEXT'
                    }));
                    
                    messageInput.value = '';
                    console.log('Message sent:', content);
                } else {
                    console.error('WebSocket not connected');
                    alert('WebSocket not connected. Please refresh and try again.');
                }
            }
        </script>
        
        
    </header>
</body>
</html> 
