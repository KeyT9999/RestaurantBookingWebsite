<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${bookingId != null ? 'Chỉnh sửa đặt bàn - Book Eat' : 'Đặt bàn mới - Book Eat'}">Book Eat – Đặt bàn</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Shared styles -->
    <link th:href="@{/css/home-resy.css}" rel="stylesheet">
    <link th:href="@{/css/luxury.css}" rel="stylesheet">
    <link th:href="@{/css/booking-resy.css}" rel="stylesheet">
</head>

<body class="booking-page" th:with="activeNav='restaurants'">
    <div th:replace="~{fragments/resy-header :: resy-header}"></div>
    
    <section class="booking-hero">
        <div class="container">
            <div class="booking-hero__content">
                <span class="booking-hero__badge">Book Eat Experience</span>
                <h1 th:text="${bookingId != null ? 'Chỉnh sửa đặt bàn' : 'Đặt bàn mới'}"></h1>
                <p>Đặt bàn trực quan và đồng bộ với trải nghiệm trang chủ Book Eat.</p>
                <div class="booking-hero__meta">
                    <div class="booking-hero__meta-item">
                        <i class="fas fa-utensils"></i>
                        <span>Chọn nhà hàng &amp; bàn yêu thích</span>
                    </div>
                    <div class="booking-hero__meta-item">
                        <i class="fas fa-clock"></i>
                        <span>Giữ chỗ chỉ trong vài bước</span>
                    </div>
                    <div class="booking-hero__meta-item">
                        <i class="fas fa-ticket-alt"></i>
                        <span>Áp dụng voucher tức thì</span>
                    </div>
                </div>
                <div class="booking-hero__actions">
                    <a href="#section-basic" class="btn-resy anchor-link">
                        <i class="fas fa-calendar-plus me-2"></i> Bắt đầu đặt bàn
                    </a>
                    <a href="#section-tables" class="btn-resy-outline anchor-link">
                        <i class="fas fa-chair me-2"></i> Xem lựa chọn bàn
                    </a>
                </div>
            </div>
        </div>
    </section>

    <main class="booking-main">
        <div class="container booking-shell">
            <div class="booking-panel">
                <div class="booking-alert-stack">
                    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="fas fa-exclamation-triangle luxury-icon"></i>
                        <span th:text="${errorMessage}"></span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                    <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="fas fa-check-circle luxury-icon"></i>
                        <span th:text="${successMessage}"></span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                </div>

                <nav class="booking-steps-nav" aria-label="Điều hướng nhanh">
                    <a href="#section-basic">
                        <span>1.</span> Thông tin chính
                    </a>
                    <a href="#section-tables">
                        <span>2.</span> Bàn &amp; món
                    </a>
                    <a href="#section-services">
                        <span>3.</span> Dịch vụ &amp; ưu đãi
                    </a>
                    <a href="#section-notes">
                        <span>4.</span> Ghi chú &amp; xác nhận
                    </a>
                </nav>

                <form th:action="${bookingId != null ? '/booking/' + bookingId + '/update' : '/booking'}"
                      method="post"
                      th:object="${bookingForm}"
                      id="bookingForm"
                      onsubmit="return validateForm()">

                    <div class="booking-form-grid">
                        <div class="booking-fields">
                            <!-- Restaurant Selection -->
                            <div class="mb-4 booking-section" id="section-basic">
                                <label for="restaurantId" class="form-label">
                                    <i class="fas fa-utensils luxury-icon"></i>
                                    Nhà hàng
                                    <span class="required-asterisk">*</span>
                                </label>
                                <select class="form-control"
                                        id="restaurantId"
                                        name="restaurantId"
                                        th:field="*{restaurantId}"
                                        th:classappend="${#fields.hasErrors('restaurantId')} ? 'is-invalid' : ''"
                                        onchange="loadTables()">
                                    <option value="">Chọn nhà hàng</option>
                                    <option th:each="restaurant : ${restaurants}"
                                            th:value="${restaurant.restaurantId}"
                                            th:text="${restaurant.restaurantName}"></option>
                                </select>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('restaurantId')}"
                                     th:errors="*{restaurantId}"></div>
                                <small class="booking-hint">
                                    Chọn nhà hàng để hiển thị bàn, thực đơn và dịch vụ phù hợp.
                                </small>

                                <div class="row g-4 mt-3">
                                    <div class="col-md-6">
                                        <label for="guestCount" class="form-label">
                                            <i class="fas fa-users luxury-icon"></i>
                                            Số lượng khách
                                            <span class="required-asterisk">*</span>
                                        </label>
                                        <input type="number"
                                               class="form-control"
                                               id="guestCount"
                                               name="guestCount"
                                               th:field="*{guestCount}"
                                               th:classappend="${#fields.hasErrors('guestCount')} ? 'is-invalid' : ''"
                                               min="1"
                                               max="12"
                                               placeholder="Ví dụ: 4">
                                        <div class="invalid-feedback" th:if="${#fields.hasErrors('guestCount')}"
                                             th:errors="*{guestCount}"></div>
                                        <small class="booking-hint">
                                            Dành cho tối đa 12 khách mỗi lần đặt. Chọn thêm bàn nếu cần nhiều hơn.
                                        </small>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="bookingTime" class="form-label">
                                            <i class="fas fa-clock luxury-icon"></i>
                                            Khung giờ
                                            <span class="required-asterisk">*</span>
                                        </label>
                                        <input type="datetime-local"
                                               class="form-control"
                                               id="bookingTime"
                                               name="bookingTime"
                                               th:field="*{bookingTime}"
                                               th:classappend="${#fields.hasErrors('bookingTime')} ? 'is-invalid' : ''">
                                        <div class="invalid-feedback" th:if="${#fields.hasErrors('bookingTime')}"
                                             th:errors="*{bookingTime}"></div>
                                        <small class="booking-hint">
                                            Nên đặt trước ít nhất 2 giờ để đảm bảo nhà hàng chuẩn bị chu đáo.
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- Table Selection -->
                            <div class="mb-4 booking-section" id="section-tables">
                                <label class="form-label d-flex align-items-center gap-2 mb-2">
                                    <i class="fas fa-chair luxury-icon"></i>
                                    Chọn bàn
                                    <span class="optional-label">(không bắt buộc)</span>
                                </label>
                                <div class="d-flex flex-wrap align-items-center gap-2">
                                    <button type="button"
                                            class="btn btn-outline-primary"
                                            id="viewTablesBtn"
                                            onclick="openTablePopup()"
                                            disabled>
                                        <i class="fas fa-eye"></i> Xem sơ đồ bàn
                                    </button>
                                    <span id="selectedTablesCount" class="text-muted small">Chưa chọn bàn</span>
                                </div>
                                <small class="booking-hint">
                                    Xem sơ đồ để chọn nhiều bàn phù hợp với nhóm của bạn.
                                </small>
                                <div id="selectedTablesSummary" class="mt-3" style="display: none;">
                                    <div class="alert alert-info">
                                        <h6><i class="fas fa-chair"></i> Bàn đã chọn</h6>
                                        <div id="selectedTablesList"></div>
                                    </div>
                                </div>
                                <input type="hidden" id="selectedTableId" name="tableId" th:value="${bookingForm.tableId}" />
                                <input type="hidden" id="selectedTableIds" name="tableIds" th:value="${bookingForm.tableIds}" />
                            </div>

                            <!-- Menu Selection -->
                            <div class="mb-4 booking-section" id="section-menu">
                                <label class="form-label d-flex align-items-center gap-2">
                                    <i class="fas fa-utensils luxury-icon"></i>
                                    Thực đơn gọi trước
                                    <span class="optional-label">(không bắt buộc)</span>
                                </label>
                                <div class="d-flex flex-wrap align-items-center gap-2">
                                    <button type="button"
                                            class="btn btn-outline-primary"
                                            id="viewMenuBtn"
                                            onclick="openMenuPopup()"
                                            disabled>
                                        <i class="fas fa-eye"></i> Xem menu
                                    </button>
                                    <span id="selectedDishesCount" class="text-muted small">Chưa chọn món</span>
                                </div>
                                <small class="booking-hint">
                                    Đặt món trước để giữ mức giá và giúp nhà hàng chuẩn bị nhanh chóng.
                                </small>
                                <div id="selectedDishesSummary" class="mt-3" style="display: none;">
                                    <div class="alert alert-info">
                                        <h6><i class="fas fa-utensils"></i> Món đã chọn</h6>
                                        <div id="selectedDishesList"></div>
                                    </div>
                                </div>
                                <input type="hidden" id="selectedDishIds" name="dishIds" th:value="${bookingForm.dishIds}" />
                            </div>

                            <!-- Services Selection -->
                            <div class="mb-4 booking-section" id="section-services">
                                <label class="form-label d-flex align-items-center gap-2">
                                    <i class="fas fa-concierge-bell luxury-icon"></i>
                                    Dịch vụ bổ sung
                                    <span class="optional-label">(không bắt buộc)</span>
                                </label>
                                <div class="services-container" id="servicesContainer">
                                    <!-- Services will be injected bằng JavaScript -->
                                </div>
                                <small class="booking-hint">
                                    Thêm các dịch vụ như trang trí, hoa hoặc yêu cầu hỗ trợ để nâng tầm trải nghiệm.
                                </small>
                                <input type="hidden" id="selectedServiceIds" name="serviceIds" th:value="${bookingForm.serviceIds}" />
                            </div>

                            <!-- Special Requests -->
                            <div class="mb-4 booking-section" id="section-notes">
                                <label for="note" class="form-label">
                                    <i class="fas fa-comment-dots luxury-icon"></i>
                                    Ghi chú đặc biệt
                                    <span class="optional-label">(tùy chọn)</span>
                                </label>
                                <textarea class="form-control"
                                          id="note"
                                          name="note"
                                          th:field="*{note}"
                                          th:classappend="${#fields.hasErrors('note')} ? 'is-invalid' : ''"
                                          rows="4"
                                          maxlength="500"
                                          placeholder="Ví dụ: Sinh nhật, không ăn hải sản, cần set up nến..."></textarea>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('note')}"
                                     th:errors="*{note}"></div>
                                <small class="booking-hint">
                                    Tối đa 500 ký tự. Thông tin của bạn sẽ được gửi trực tiếp đến nhà hàng.
                                </small>
                            </div>
                        </div>

                        <aside class="booking-sidebar">
                            <!-- Summary -->
                            <div class="booking-card booking-summary-card">
                                <span class="booking-summary-card__badge">
                                    <i class="fas fa-calculator"></i> Tổng quan
                                </span>
                                <h3>Chi phí đặt cọc</h3>
                                <div class="booking-summary-rows">
                                    <div class="booking-summary-row">
                                        <span>Đặt cọc bàn</span>
                                        <span id="tableDepositAmount">0 VNĐ</span>
                                    </div>
                                    <div class="booking-summary-row">
                                        <span>Món đã chọn</span>
                                        <span id="dishesTotalAmount">0 VNĐ</span>
                                    </div>
                                    <div class="booking-summary-row">
                                        <span>Dịch vụ bổ sung</span>
                                        <span id="servicesTotalAmount">0 VNĐ</span>
                                    </div>
                                    <div class="booking-summary-row" id="subtotalRow">
                                        <span>Tạm tính</span>
                                        <span id="subtotalAmount">0 VNĐ</span>
                                    </div>
                                    <div class="booking-summary-row" id="voucherDiscountRow" style="display: none;">
                                        <span><i class="fas fa-ticket-alt"></i> Ưu đãi voucher</span>
                                        <span id="voucherDiscountDisplay">-0 VNĐ</span>
                                    </div>
                                </div>
                                <div class="booking-summary-card__total">
                                    <span>Tổng đặt cọc</span>
                                    <span id="totalDepositAmount">0 VNĐ</span>
                                </div>
                                <p class="booking-summary-card__note">
                                    <i class="fas fa-info-circle"></i>
                                    Số tiền này sẽ được tạm giữ để đảm bảo chỗ ngồi của bạn.
                                </p>
                                <input type="hidden"
                                       id="depositAmount"
                                       name="depositAmount"
                                       th:field="*{depositAmount}">
                            </div>

                            <!-- Voucher -->
                            <div class="booking-card booking-voucher-card">
                                <h4 class="h6 d-flex align-items-center gap-2 mb-3">
                                    <i class="fas fa-ticket-alt luxury-icon"></i>
                                    Voucher
                                    <span class="optional-label">(không bắt buộc)</span>
                                </h4>
                                <div class="input-group">
                                    <select class="form-control" id="voucherSelect" name="voucherCode">
                                        <option value="">Chọn voucher của bạn</option>
                                    </select>
                                    <button type="button"
                                            class="btn btn-outline-primary"
                                            id="validateVoucherBtn"
                                            onclick="validateSelectedVoucher()">
                                        <i class="fas fa-check"></i> Áp dụng
                                    </button>
                                </div>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('voucherCode')}"
                                     th:errors="*{voucherCode}"></div>
                                <div id="voucherResult" class="mt-2" style="display: none;">
                                    <div id="voucherSuccess" class="alert alert-success" style="display: none;">
                                        <i class="fas fa-check-circle"></i>
                                        <span id="voucherSuccessText"></span>
                                    </div>
                                    <div id="voucherError" class="alert alert-danger" style="display: none;">
                                        <i class="fas fa-exclamation-circle"></i>
                                        <span id="voucherErrorText"></span>
                                    </div>
                                </div>
                                <small class="booking-hint">
                                    Áp dụng voucher để được trừ trực tiếp vào số tiền đặt cọc.
                                </small>
                                <input type="hidden" id="voucherDiscountAmount" name="voucherDiscountAmount" value="0">
                                <input type="hidden" id="voucherCodeApplied" name="voucherCodeApplied" value="">
                            </div>

                            <!-- Tips -->
                            <div class="booking-tip-card">
                                <h6><i class="fas fa-lightbulb"></i> Gợi ý nhanh</h6>
                                <ul>
                                    <li>Chọn nhiều bàn để ghép nhóm lớn hoặc không gian riêng tư.</li>
                                    <li>Đặt trước món signature để giữ mức giá ưu đãi.</li>
                                    <li>Nhập ghi chú chi tiết để nhà hàng chuẩn bị chính xác.</li>
                                </ul>
                            </div>
                        </aside>
                    </div>

                    <div class="booking-submit">
                        <button type="submit" class="btn-resy">
                            <i class="fas fa-check-circle"></i>
                            <span th:text="${bookingId != null ? 'Cập nhật đặt bàn' : 'Xác nhận đặt bàn'}"></span>
                        </button>
                        <a th:href="@{/booking/my}" class="btn-resy-outline">
                            <i class="fas fa-arrow-left"></i>
                            Quay lại đặt bàn của tôi
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </main>
    
    <!-- Table Selection Modal -->
    <div class="modal fade" id="tableModal" tabindex="-1" aria-labelledby="tableModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tableModalLabel">
                        <i class="fas fa-chair"></i> Chọn bàn
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- View Toggle Buttons -->
                    <div class="row mb-4" id="tableLayoutToggle" style="display: none;">
                        <div class="col-12">
                            <div class="btn-group w-100" role="group" aria-label="View toggle">
                                <button type="button" class="btn btn-outline-info btn-lg active" 
                                        id="layoutViewBtn" onclick="switchToLayoutView()">
                                    <i class="fas fa-map me-2"></i>
                                    Sơ đồ bàn ăn
                                </button>
                                <button type="button" class="btn btn-outline-success btn-lg" 
                                        id="tablesViewBtn" onclick="switchToTablesView()">
                                    <i class="fas fa-chair me-2"></i>
                                    Danh sách bàn
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Layout View -->
                    <div id="layoutView" class="view-content" style="display: none;">
                        <div id="tableLayoutCarousel" class="carousel slide" data-bs-ride="carousel">
                            <div class="carousel-indicators" id="tableLayoutIndicators">
                                <!-- Indicators will be generated by JavaScript -->
                            </div>
                            
                            <div class="carousel-inner" id="tableLayoutInner">
                                <!-- Carousel items will be generated by JavaScript -->
                            </div>
                            
                            <button class="carousel-control-prev" type="button" data-bs-target="#tableLayoutCarousel" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Trước</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#tableLayoutCarousel" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Sau</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Tables View -->
                    <div id="tablesView" class="view-content">
                        <!-- Tables Search -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-search"></i>
                                    </span>
                                    <input type="text" class="form-control" id="tablesSearchInput" 
                                           placeholder="Tìm kiếm bàn ăn..." onkeyup="searchTables()">
                                    <button class="btn btn-outline-secondary" type="button" onclick="clearTablesSearch()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="tablesList" class="row">
                            <!-- Tables will be loaded here -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Huỷ</button>
                    <button type="button" class="btn btn-primary" onclick="confirmTableSelection()">Xác nhận</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Menu Selection Modal -->
    <div class="modal fade" id="menuModal" tabindex="-1" aria-labelledby="menuModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="menuModalLabel">
                        <i class="fas fa-utensils"></i> Chọn món ăn
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Menu Search -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control" id="menuSearchInput" 
                                       placeholder="Tìm kiếm món ăn..." onkeyup="searchMenu()">
                                <button class="btn btn-outline-secondary" type="button" onclick="clearMenuSearch()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Menu Pagination -->
                    <div id="menuPagination" class="d-flex justify-content-center mb-4">
                        <nav aria-label="Menu pagination">
                            <ul class="pagination" id="menuPaginationList">
                                <!-- Pagination items will be generated by JavaScript -->
                            </ul>
                        </nav>
                    </div>
                    
                    <div id="menuList" class="row">
                        <!-- Menu items will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Huỷ</button>
                    <button type="button" class="btn btn-primary" onclick="confirmMenuSelection()">Xác nhận</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Table Images Modal -->
    <div class="modal fade" id="tableImagesModal" tabindex="-1" aria-labelledby="tableImagesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tableImagesModalLabel">
                        <i class="fas fa-images me-2"></i>
                        Hình ảnh bàn
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Table Images Carousel -->
                    <div id="tableImagesCarousel" class="carousel slide" data-bs-ride="carousel">
                        <div class="carousel-indicators" id="tableImagesIndicators">
                            <!-- Indicators will be generated by JavaScript -->
                        </div>
                        
                        <div class="carousel-inner" id="tableImagesInner">
                            <!-- Carousel items will be generated by JavaScript -->
                        </div>
                        
                        <button class="carousel-control-prev" type="button" data-bs-target="#tableImagesCarousel" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Trước</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#tableImagesCarousel" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Sau</span>
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Smart Waitlist Modal -->
    <div class="modal fade" id="smartWaitlistModal" tabindex="-1" aria-labelledby="smartWaitlistModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="smartWaitlistModalLabel">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span id="popupTitle">Không thể giữ bàn ngay</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Dynamic content based on conflict type -->
                    <div id="conflictContent">
                        <!-- Will be populated by JavaScript -->
                    </div>
                    
                    <!-- Waitlist Information -->
                    <div class="waitlist-info bg-light p-3 rounded mt-3">
                        <h6><i class="fas fa-clock text-warning"></i> Thông tin danh sách chờ:</h6>
                        <p><strong>Thời gian chờ ước tính:</strong> <span id="waitTime"></span></p>
                        <p><strong>Nguyên nhân:</strong> <span id="waitReason"></span></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Huỷ
                    </button>
                    <button type="button" class="btn btn-warning" onclick="joinSmartWaitlist()">
                        <i class="fas fa-clock"></i> Tham gia danh sách chờ
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div th:replace="~{fragments/resy-footer :: resy-footer}"></div>
    <div th:replace="~{fragments/resy-scripts :: resy-scripts}"></div>
    <script th:src="@{/js/main.js}" defer></script>
    
    <script>
        // Global variables to store selections
        let selectedTables = [];
        let selectedDishes = [];
        let selectedServices = [];
        let availableTables = [];
        let availableDishes = [];
        let availableServices = [];
        let voucherDiscount = 0; // Store voucher discount amount
        let availableVouchers = []; // Store available vouchers
        let tableLayouts = []; // Store table layouts
        let filteredTables = []; // For search functionality
        let filteredDishes = []; // For search functionality
        let currentMenuPage = 1;
        const itemsPerPage = 6;
        let tablesLoaded = false;
        let tablesLoading = false;
        

        function extractTableId(table) {
            if (!table) {
                return '';
            }
            if (table.id !== undefined && table.id !== null && table.id !== '') {
                return String(table.id);
            }
            if (table.tableId !== undefined && table.tableId !== null && table.tableId !== '') {
                return String(table.tableId);
            }
            return '';
        }

        function updateSelectedTableIds() {
            const multipleTablesInput = document.getElementById('selectedTableIds');
            const singleTableInput = document.getElementById('selectedTableId');
            const ids = selectedTables
                .map(extractTableId)
                .filter(id => id !== '');

            if (multipleTablesInput) {
                multipleTablesInput.value = ids.join(',');
            }

            if (singleTableInput) {
                singleTableInput.value = ids.length === 1 ? ids[0] : '';
            }
        }

        // Debug function to log all selections
        function logAllSelections() {
            console.log('📊 === CURRENT SELECTIONS DEBUG ===');
            console.log('🔍 selectedTables:', selectedTables);
            console.log('🔍 selectedTables.length:', selectedTables.length);
            console.log('🔍 selectedDishes:', selectedDishes);
            console.log('🔍 selectedDishes.length:', selectedDishes.length);
            console.log('🔍 selectedServices:', selectedServices);
            console.log('🔍 selectedServices.length:', selectedServices.length);
            console.log('🔍 availableTables:', availableTables);
            console.log('🔍 availableTables.length:', availableTables.length);
            console.log('🔍 availableDishes:', availableDishes);
            console.log('🔍 availableDishes.length:', availableDishes.length);
            console.log('🔍 availableServices:', availableServices);
            console.log('🔍 availableServices.length:', availableServices.length);
            console.log('📊 === END SELECTIONS DEBUG ===');
        }

        function loadTables() {
            tablesLoading = true;
            tablesLoaded = false;
            const restaurantId = document.getElementById('restaurantId').value;
            const viewTablesBtn = document.getElementById('viewTablesBtn');
            
            console.log('🔍 Loading tables for restaurant ID:', restaurantId);
            logAllSelections();
            
            if (restaurantId) {
                viewTablesBtn.disabled = false;
                return fetch(`/api/booking/restaurants/${restaurantId}/tables`)
                    .then(response => {
                        console.log('📡 API Response status:', response.status);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(tables => {
                        console.log('📋 Received tables:', tables);
                        availableTables = tables;
                        console.log('📋 availableTables updated:', availableTables);
                        logAllSelections();
                        
                        // Load table layouts
                        return fetch(`/api/booking/restaurants/${restaurantId}/table-layouts`)
                            .then(response => {
                                if (response.ok) {
                                    return response.json();
                                }
                                return [];
                            })
                            .then(layouts => {
                                console.log('📋 Received table layouts:', layouts);
                                tableLayouts = layouts;
                                return tables;
                            })
                            .catch(error => {
                                console.log('⚠️ No table layouts found:', error);
                                tableLayouts = [];
                                return tables;
                            });
                    })
                    .then(tables => {
                        tablesLoaded = true;
                        tablesLoading = false;
                        if (tables.length === 0) {
                            console.log('⚠️ No tables found for restaurant ID:', restaurantId);
                        } else {
                            renderTablesInModal(tables);
                        }
                        
                        return Promise.all([
                            loadDishes(restaurantId),
                            loadServices(restaurantId)
                        ]).then(() => {
                            console.log('✅ All data (tables, dishes, services, layouts) loaded successfully');
                            return tables;
                        });
                    })
                    .catch(error => {
                        console.error('❌ Error loading tables:', error);
                        availableTables = [];
                        tablesLoaded = true;
                        tablesLoading = false;
                        return Promise.all([
                            loadDishes(restaurantId),
                            loadServices(restaurantId)
                        ]).then(() => {
                            console.log('✅ Dishes and services loaded despite table error');
                            return []; // Return empty array on error
                        }).catch(() => {
                            console.log('❌ Error loading dishes/services too');
                            return []; // Return empty array on error
                        });
                    });
            } else {
                viewTablesBtn.disabled = true;
                tablesLoaded = false;
                availableTables = [];
                filteredTables = [];
                tablesLoading = false;
                const viewMenuBtn = document.getElementById('viewMenuBtn');
                viewMenuBtn.innerHTML = '<i class="fas fa-eye"></i> Xem menu';
                viewMenuBtn.disabled = true;
                updateTotalAmount();
                return Promise.resolve([]); // Return resolved promise with empty array
            }
        }

        // Toggle Table Selection
        function toggleTableSelection(tableId) {
            const checkbox = document.getElementById(`table-${tableId}`);
            if (!checkbox) return;
            
            // Toggle checkbox
            checkbox.checked = !checkbox.checked;
            
            // Update selected tables array
            if (checkbox.checked) {
                if (!selectedTables.find(t => t.tableId === tableId)) {
                    const table = availableTables.find(t => t.tableId === tableId);
                    if (table) {
                        selectedTables.push(table);
                    }
                }
            } else {
                selectedTables = selectedTables.filter(t => t.tableId !== tableId);
            }
            
            // Update hidden input
            updateSelectedTableIds();
            
            // Update total amount
            updateTotalAmount();
            
            console.log('✅ Table selection toggled:', tableId, 'Selected tables:', selectedTables.length);
        }

        // Show Table Images Modal
        function showTableImages(tableId) {
            const table = availableTables.find(t => t.tableId === tableId);
            if (!table) return;
            
            const tableImages = table.images || [];
            if (tableImages.length === 0) {
                alert('Bàn này chưa có hình ảnh');
                return;
            }
            
            // Update modal title
            const modalTitle = document.getElementById('tableImagesModalLabel');
            modalTitle.innerHTML = `<i class="fas fa-images me-2"></i>Hình ảnh bàn ${table.tableName}`;
            
            // Render carousel indicators
            const indicators = document.getElementById('tableImagesIndicators');
            indicators.innerHTML = '';
            tableImages.forEach((image, index) => {
                const button = document.createElement('button');
                button.type = 'button';
                button.setAttribute('data-bs-target', '#tableImagesCarousel');
                button.setAttribute('data-bs-slide-to', index);
                button.setAttribute('aria-label', `Slide ${index + 1}`);
                if (index === 0) {
                    button.className = 'active';
                    button.setAttribute('aria-current', 'true');
                }
                indicators.appendChild(button);
            });
            
            // Render carousel items
            const carouselInner = document.getElementById('tableImagesInner');
            carouselInner.innerHTML = '';
            tableImages.forEach((image, index) => {
                const item = document.createElement('div');
                item.className = `carousel-item ${index === 0 ? 'active' : ''}`;
                item.innerHTML = `
                    <img src="${image.url}" class="d-block w-100 carousel-image" alt="Bàn ${table.tableName} - Ảnh ${index + 1}">
                    <div class="carousel-caption d-none d-md-block">
                        <h5>Bàn ${table.tableName}</h5>
                        <p>Ảnh ${index + 1}/${tableImages.length}</p>
                    </div>
                `;
                carouselInner.appendChild(item);
            });
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('tableImagesModal'));
            modal.show();
        }

        function renderTablesInModal(tables) {
            const tablesList = document.getElementById('tablesList');
            tablesList.innerHTML = '';
            
            // Update filtered tables
            filteredTables = tables;
            
            tables.forEach(table => {
                const statusValue = getTableStatusValue(table.status);
                const statusClass = getStatusBadgeClass(table.status);
                const statusText = getStatusDisplayName(table.status);
                
                // Create table image placeholder
                const imageUrl = table.mainImage || `data:image/svg+xml;base64,${btoa(`
                    <svg width="300" height="200" xmlns="http://www.w3.org/2000/svg">
                        <rect width="300" height="200" fill="#f8f9fa"/>
                        <text x="150" y="100" text-anchor="middle" font-family="Arial" font-size="14" fill="#6c757d">
                            ${table.tableName || 'Table'}
                        </text>
                    </svg>
                `)}`;
                
                const tableCard = document.createElement('div');
                tableCard.className = 'col-md-4 mb-3';
                tableCard.innerHTML = `
                    <div class="card table-card" data-table-id="${table.tableId}" data-deposit="${table.depositAmount || 0}">
                        <div class="card-body p-0">
                            <!-- Image section - separate click event -->
                            <div class="image-section" onclick="showTableImages(${table.tableId})" 
                                 style="cursor: pointer; position: relative;" title="Click để xem tất cả ảnh của bàn">
                                <img src="${imageUrl}" class="card-img-top" alt="${table.tableName}" 
                                     style="height: 200px; object-fit: cover;">
                                <div class="image-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; 
                                     background: rgba(0,0,0,0); transition: background 0.3s ease; display: flex; 
                                     align-items: center; justify-content: center;">
                                    <i class="fas fa-images text-white" style="opacity: 0; transition: opacity 0.3s ease; font-size: 2rem;"></i>
                                </div>
                            </div>
                            
                            <!-- Content section - select table event -->
                            <div class="content-section" onclick="toggleTableSelection(${table.tableId})" 
                                 style="cursor: pointer; padding: 1rem;">
                                <div class="form-check d-flex align-items-center">
                                    <input class="form-check-input table-checkbox me-2" 
                                           type="checkbox" 
                                           value="${table.tableId}"
                                           id="table-${table.tableId}"
                                           onclick="event.stopPropagation(); toggleTableSelection(${table.tableId})">
                                    <label class="form-check-label flex-grow-1" for="table-${table.tableId}">
                                        <h6 class="card-title mb-1">${table.tableName}</h6>
                                        <p class="card-text mb-1">
                                            <small class="text-muted">Sức chứa: ${table.capacity} khách</small><br>
                                            <small class="text-muted">Deposit: ${formatCurrency(table.depositAmount || 0)}</small>
                                        </p>
                                        <span class="badge ${statusClass}">${statusText}</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                tablesList.appendChild(tableCard);
            });
            
            console.log('✅ Tables rendered in modal successfully');
        }

        function loadDishes(restaurantId) {
            fetch(`/api/booking/restaurants/${restaurantId}/dishes`)
                .then(response => response.json())
                .then(dishes => {
                    console.log('🔍 Raw dishes API response:', dishes);
                    console.log('🔍 First dish structure:', dishes[0]);
                    
                    // Load dish images
                    const dishesWithImages = dishes.map(dish => {
                        return {
                            ...dish,
                            imageUrl: dish.imageUrl || `data:image/svg+xml;base64,${btoa(`
                                <svg width="300" height="200" xmlns="http://www.w3.org/2000/svg">
                                    <rect width="300" height="200" fill="#f8f9fa"/>
                                    <text x="150" y="100" text-anchor="middle" font-family="Arial" font-size="14" fill="#6c757d">
                                        ${dish.name || 'No Image'}
                                    </text>
                                </svg>
                            `)}`
                        };
                    });
                    
                    availableDishes = dishesWithImages;
                    console.log('🔍 Dishes with images:', availableDishes);
                    
                    // Update button text based on dishes availability
                    const viewMenuBtn = document.getElementById('viewMenuBtn');
                    if (dishes.length === 0) {
                        viewMenuBtn.innerHTML = '<i class="fas fa-eye"></i> Xem menu (chưa có món nào phù hợp)';
                        viewMenuBtn.disabled = true;
                    } else {
                        viewMenuBtn.innerHTML = '<i class="fas fa-eye"></i> Xem menu';
                        viewMenuBtn.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error loading dishes:', error);
                    const viewMenuBtn = document.getElementById('viewMenuBtn');
                    viewMenuBtn.innerHTML = '<i class="fas fa-eye"></i> Xem menu (lỗi tải dữ liệu)';
                    viewMenuBtn.disabled = true;
                });
        }

        function loadServices(restaurantId) {
            console.log('🔍 Loading services for restaurant ID:', restaurantId);
            
            return fetch(`/api/booking/restaurants/${restaurantId}/services`)
                .then(response => {
                    console.log('📡 Services API response status:', response.status);
                    return response.json();
                })
                .then(services => {
                    console.log('🔍 Raw services API response:', services);
                    console.log('🔍 First service structure:', services[0]);
                    console.log('📋 Services received:', services);
                    console.log('📋 Services count:', services.length);
                    
                    // Store services in global variable
                    availableServices = services;
                    
                    const servicesContainer = document.getElementById('servicesContainer');
                    servicesContainer.innerHTML = '';
                    
                    // Always show services section for debugging
                    document.getElementById('servicesSection').style.display = 'block';
                    
                    if (services.length === 0) {
                        console.log('⚠️ No services found, adding placeholder');
                        servicesContainer.innerHTML = `
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-concierge-bell fa-2x mb-2"></i>
                                <p>No additional services available for this restaurant.</p>
                            </div>
                        `;
                        return;
                    }
                    
                    services.forEach(service => {
                        console.log('➕ Adding service:', service.name, 'Price:', service.price);
                        const serviceCard = createServiceCard(service);
                        servicesContainer.appendChild(serviceCard);
                    });
                    
                    console.log('✅ Services cards created successfully');
                })
                .catch(error => {
                    console.error('❌ Error loading services:', error);
                    // Still show services section even on error
                    document.getElementById('servicesSection').style.display = 'block';
                    const servicesContainer = document.getElementById('servicesContainer');
                    servicesContainer.innerHTML = `
                        <div class="text-center text-danger py-4">
                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <p>Không thể tải dịch vụ, vui lòng thử lại.</p>
                        </div>
                    `;
                });
        }

        function createServiceCard(service) {
            const card = document.createElement('div');
            card.className = 'service-card';
            card.dataset.serviceId = service.serviceId;
            card.dataset.price = service.price || 0;
            
            // Service icon mapping
            const iconMap = {
                'WIFI': 'fas fa-wifi',
                'PARKING': 'fas fa-parking',
                'VALET': 'fas fa-car',
                'LIVE_MUSIC': 'fas fa-music',
                'PRIVATE_ROOM': 'fas fa-door-open',
                'OUTDOOR_SEATING': 'fas fa-tree',
                'BAR': 'fas fa-cocktail',
                'KIDS_MENU': 'fas fa-child',
                'DELIVERY': 'fas fa-truck',
                'TAKEAWAY': 'fas fa-shopping-bag'
            };
            
            const iconClass = iconMap[service.name] || 'fas fa-concierge-bell';
            
            card.innerHTML = `
                <div class="service-checkbox"></div>
                <i class="service-icon ${iconClass}"></i>
                <div class="service-name">${service.name}</div>
                <div class="service-description">${service.description || 'Enhance your dining experience'}</div>
                <div class="service-price">
                    <i class="fas fa-tag"></i>
                    ${formatCurrency(service.price || 0)}
                </div>
            `;
            
            // Add click event listener
            card.addEventListener('click', function() {
                toggleServiceSelection(this);
            });
            
            return card;
        }

        function toggleServiceSelection(card) {
            console.log('🔍 toggleServiceSelection() called');
            console.log('🔍 Card details:', {
                serviceId: card.dataset.serviceId,
                serviceName: card.querySelector('.service-name')?.textContent,
                price: card.dataset.price,
                isSelected: card.classList.contains('selected')
            });
            
            const isSelected = card.classList.contains('selected');
            const serviceId = card.dataset.serviceId;
            const serviceName = card.querySelector('.service-name').textContent;
            const servicePrice = parseFloat(card.dataset.price) || 0;
            
            console.log('🔍 Before toggle - selectedServices.length:', selectedServices.length);
            console.log('🔍 Before toggle - selectedServices:', selectedServices);
            
            if (isSelected) {
                // Remove from selectedServices array
                card.classList.remove('selected');
                selectedServices = selectedServices.filter(s => s.id !== serviceId);
                console.log('❌ Removed service from selectedServices:', serviceName);
            } else {
                // Add to selectedServices array
                card.classList.add('selected');
                selectedServices.push({
                    id: serviceId,
                    name: serviceName,
                    price: servicePrice
                });
                console.log('✅ Added service to selectedServices:', serviceName);
            }
            
            console.log('🔍 After toggle - selectedServices.length:', selectedServices.length);
            console.log('🔍 After toggle - selectedServices:', selectedServices);
            
            updateTotalAmount();
            saveFormState();
        }

        function getSelectedServices() {
            const selectedCards = document.querySelectorAll('.service-card.selected');
            return Array.from(selectedCards).map(card => ({
                id: card.dataset.serviceId,
                price: parseFloat(card.dataset.price) || 0
            }));
        }

        // Search and Carousel Functions
        function searchTables() {
            const searchTerm = document.getElementById('tablesSearchInput').value.toLowerCase();
            filteredTables = availableTables.filter(table => 
                table.tableName.toLowerCase().includes(searchTerm) ||
                table.capacity.toString().includes(searchTerm) ||
                table.status.toLowerCase().includes(searchTerm)
            );
            renderTablesInModal(filteredTables);
        }
        
        function clearTablesSearch() {
            document.getElementById('tablesSearchInput').value = '';
            filteredTables = availableTables;
            renderTablesInModal(filteredTables);
        }
        
        function searchMenu() {
            const searchTerm = document.getElementById('menuSearchInput').value.toLowerCase();
            filteredDishes = availableDishes.filter(dish => 
                dish.name.toLowerCase().includes(searchTerm) ||
                dish.description.toLowerCase().includes(searchTerm) ||
                dish.category.toLowerCase().includes(searchTerm)
            );
            currentMenuPage = 1;
            renderMenuPage(1);
        }
        
        function clearMenuSearch() {
            document.getElementById('menuSearchInput').value = '';
            filteredDishes = availableDishes;
            currentMenuPage = 1;
            renderMenuPage(1);
        }
        
        function switchToLayoutView() {
            document.getElementById('layoutViewBtn').classList.add('active');
            document.getElementById('tablesViewBtn').classList.remove('active');
            document.getElementById('layoutView').style.display = 'block';
            document.getElementById('tablesView').style.display = 'none';
            
            if (tableLayouts.length > 0 && document.getElementById('tableLayoutInner').children.length === 0) {
                showTableLayout();
            }
        }
        
        function switchToTablesView() {
            document.getElementById('layoutViewBtn').classList.remove('active');
            document.getElementById('tablesViewBtn').classList.add('active');
            document.getElementById('layoutView').style.display = 'none';
            document.getElementById('tablesView').style.display = 'block';
            
            if (document.getElementById('tablesList').children.length === 0) {
                renderTablesInModal(filteredTables);
            }
        }
        
        function showTableLayout() {
            if (tableLayouts.length === 0) {
                alert('Nhà hàng này chưa có sơ đồ bàn ăn');
                return;
            }
            
            const indicators = document.getElementById('tableLayoutIndicators');
            indicators.innerHTML = '';
            tableLayouts.forEach((layout, index) => {
                const button = document.createElement('button');
                button.type = 'button';
                button.setAttribute('data-bs-target', '#tableLayoutCarousel');
                button.setAttribute('data-bs-slide-to', index);
                button.setAttribute('aria-label', `Layout ${index + 1}`);
                if (index === 0) {
                    button.className = 'active';
                    button.setAttribute('aria-current', 'true');
                }
                indicators.appendChild(button);
            });
            
            const carouselInner = document.getElementById('tableLayoutInner');
            carouselInner.innerHTML = '';
            tableLayouts.forEach((layout, index) => {
                const item = document.createElement('div');
                item.className = `carousel-item ${index === 0 ? 'active' : ''}`;
                item.innerHTML = `
                    <img src="${layout.url}" class="d-block w-100 carousel-image" alt="Sơ đồ bàn ăn ${index + 1}" style="max-height: 70vh; object-fit: contain;">
                    <div class="carousel-caption d-none d-md-block">
                        <h5>Sơ đồ bàn ăn</h5>
                        <p>Layout ${index + 1}/${tableLayouts.length}</p>
                    </div>
                `;
                carouselInner.appendChild(item);
            });
        }
        
        function renderMenuPage(page) {
            currentMenuPage = page;
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageDishes = filteredDishes.slice(startIndex, endIndex);
            
            const menuList = document.getElementById('menuList');
            if (menuList) {
                menuList.innerHTML = '';
                pageDishes.forEach(dish => {
                    const dishCard = createDishCard(dish);
                    menuList.appendChild(dishCard);
                });
            }
            renderMenuPagination();
        }
        
        function renderMenuPagination() {
            const totalPages = Math.ceil(filteredDishes.length / itemsPerPage);
            const paginationList = document.getElementById('menuPaginationList');
            
            if (paginationList && totalPages > 1) {
                paginationList.innerHTML = '';
                
                const prevLi = document.createElement('li');
                prevLi.className = `page-item ${currentMenuPage === 1 ? 'disabled' : ''}`;
                prevLi.innerHTML = `<a class="page-link" href="#" onclick="renderMenuPage(${currentMenuPage - 1}); return false;">Trước</a>`;
                paginationList.appendChild(prevLi);
                
                for (let i = 1; i <= totalPages; i++) {
                    const li = document.createElement('li');
                    li.className = `page-item ${i === currentMenuPage ? 'active' : ''}`;
                    li.innerHTML = `<a class="page-link" href="#" onclick="renderMenuPage(${i}); return false;">${i}</a>`;
                    paginationList.appendChild(li);
                }
                
                const nextLi = document.createElement('li');
                nextLi.className = `page-item ${currentMenuPage === totalPages ? 'disabled' : ''}`;
                nextLi.innerHTML = `<a class="page-link" href="#" onclick="renderMenuPage(${currentMenuPage + 1}); return false;">Sau</a>`;
                paginationList.appendChild(nextLi);
            }
        }
        
        function createDishCard(dish) {
            const col = document.createElement('div');
            col.className = 'col-md-4 col-sm-6';
            
            const imageUrl = dish.imageUrl || `data:image/svg+xml;base64,${btoa(`
                <svg width="300" height="200" xmlns="http://www.w3.org/2000/svg">
                    <rect width="300" height="200" fill="#f8f9fa"/>
                    <text x="150" y="100" text-anchor="middle" font-family="Arial" font-size="14" fill="#6c757d">
                        ${dish.name || 'No Image'}
                    </text>
                </svg>
            `)}`;
            const price = new Intl.NumberFormat('vi-VN').format(dish.price) + ' VNĐ';
            
            col.innerHTML = `
                <div class="card dish-card" data-dish-id="${dish.dishId}" data-price="${dish.price}">
                    <div class="card-body">
                        <div class="form-check">
                            <input class="form-check-input dish-checkbox" type="checkbox" value="${dish.dishId}" id="dish-${dish.dishId}">
                            <label class="form-check-label w-100" for="dish-${dish.dishId}">
                                <img src="${imageUrl}" class="card-img-top" alt="${dish.name}" style="height: 200px; object-fit: cover;">
                                <div class="mt-2">
                                    <h6 class="dish-name">${dish.name}</h6>
                                    <p class="dish-description">${dish.description || 'Không có mô tả'}</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="dish-price">${price}</span>
                                        <span class="dish-category">${dish.category || 'Khác'}</span>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
            `;
            
            return col;
        }

        function renderTablePopupContent() {
            console.log('🚀 Rendering table popup content...');
            console.log('📋 Current selectedTables:', selectedTables);
            console.log('📋 Current selectedTableIds value:', document.getElementById('selectedTableIds').value);
            
            // Reset search box and filtered data
            const tableSearchInput = document.getElementById('tablesSearchInput');
            if (tableSearchInput) {
                tableSearchInput.value = '';
            }

            filteredTables = Array.isArray(availableTables) ? [...availableTables] : [];

            // Check if table layouts exist
            if (tableLayouts.length > 0) {
                document.getElementById('tableLayoutToggle').style.display = 'block';
                switchToLayoutView();
            } else {
                document.getElementById('tableLayoutToggle').style.display = 'none';
                switchToTablesView();
            }
            
            const tablesList = document.getElementById('tablesList');
            tablesList.innerHTML = '';

            if (!filteredTables || filteredTables.length === 0) {
                if (tablesLoading && !tablesLoaded) {
                    tablesList.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-info text-center mb-0">
                                <i class="fas fa-spinner fa-spin me-2"></i>Đang tải danh sách bàn...
                            </div>
                        </div>
                    `;
                } else {
                    tablesList.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-info text-center mb-0">
                                <i class="fas fa-info-circle me-2"></i>Chưa có bàn khả dụng cho nhà hàng này.
                            </div>
                        </div>
                    `;
                }
            } else {
                filteredTables.forEach(table => {
                const statusValue = getTableStatusValue(table.status);
                const statusClass = getStatusBadgeClass(table.status);
                const statusText = getStatusDisplayName(table.status);
                console.log('🎨 Table:', table.tableName, 'Original Status:', table.status, 'Processed Status:', statusValue, 'Class:', statusClass, 'Text:', statusText);
                
                // Create table image placeholder
                const imageUrl = table.mainImage || `data:image/svg+xml;base64,${btoa(`
                    <svg width="300" height="200" xmlns="http://www.w3.org/2000/svg">
                        <rect width="300" height="200" fill="#f8f9fa"/>
                        <text x="150" y="100" text-anchor="middle" font-family="Arial" font-size="14" fill="#6c757d">
                            ${table.tableName || 'Table'}
                        </text>
                    </svg>
                `)}`;
                
                const tableCard = document.createElement('div');
                tableCard.className = 'col-md-4 mb-3';
                tableCard.innerHTML = `
                    <div class="card table-card" data-table-id="${table.tableId}" data-deposit="${table.depositAmount || 0}">
                        <div class="card-body p-0">
                            <!-- Image section - separate click event -->
                            <div class="image-section" onclick="showTableImages(${table.tableId})" 
                                 style="cursor: pointer; position: relative;" title="Click để xem tất cả ảnh của bàn">
                                <img src="${imageUrl}" class="card-img-top" alt="${table.tableName}" 
                                     style="height: 200px; object-fit: cover;">
                                <div class="image-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; 
                                     background: rgba(0,0,0,0); transition: background 0.3s ease; display: flex; 
                                     align-items: center; justify-content: center;">
                                    <i class="fas fa-images text-white" style="opacity: 0; transition: opacity 0.3s ease; font-size: 2rem;"></i>
                                </div>
                            </div>
                            
                            <!-- Content section - select table event -->
                            <div class="content-section" onclick="toggleTableSelection(${table.tableId})" 
                                 style="cursor: pointer; padding: 1rem;">
                                <div class="form-check d-flex align-items-center">
                                    <input class="form-check-input table-checkbox me-2" 
                                           type="checkbox" 
                                           value="${table.tableId}"
                                           id="table-${table.tableId}"
                                           onclick="event.stopPropagation(); toggleTableSelection(${table.tableId})">
                                    <label class="form-check-label flex-grow-1" for="table-${table.tableId}">
                                        <h6 class="card-title mb-1">${table.tableName}</h6>
                                        <p class="card-text mb-1">
                                            <small class="text-muted">Sức chứa: ${table.capacity} khách</small><br>
                                            <small class="text-muted">Deposit: ${formatCurrency(table.depositAmount || 0)}</small>
                                        </p>
                                        <span class="badge ${statusClass}">${statusText}</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                tablesList.appendChild(tableCard);
            });
            }
            
            // Restore previous selections from hidden input
            const selectedTableIds = document.getElementById('selectedTableIds').value;
            if (selectedTableIds) {
                const tableIds = selectedTableIds.split(',');
                console.log('🔄 Restoring table selections:', tableIds);
                
                setTimeout(() => {
                    selectedTables = []; // Reset selectedTables array
                    console.log('🔄 Starting restore process for tables:', tableIds);
                    
                    tableIds.forEach(tableId => {
                        console.log('🔍 Looking for checkbox with value:', tableId);
                        const checkbox = document.querySelector(`#tableModal input[value="${tableId}"]`);
                        console.log('🔍 Found checkbox:', checkbox);
                        
                        if (checkbox) {
                            checkbox.checked = true;
                            console.log('✅ Checkbox checked for table:', tableId);
                            
                            const tableCard = checkbox.closest('.table-card');
                            console.log('🔍 Found tableCard:', tableCard);
                            
                            if (tableCard) {
                                const deposit = parseFloat(tableCard.getAttribute('data-deposit'));
                                const tableName = tableCard.querySelector('.card-title').textContent;
                                const capacityText = tableCard.querySelector('.card-text small').textContent;
                                const capacity = parseInt(capacityText.match(/\d+/)[0]);
                                
                                console.log('📊 Table data:', {
                                    id: tableId,
                                    name: tableName,
                                    deposit: deposit,
                                    capacity: capacity
                                });
                                
                                selectedTables.push({
                                    id: tableId,
                                    name: tableName,
                                    deposit: deposit,
                                    capacity: capacity
                                });
                                console.log('✅ Added to selectedTables:', tableId, tableName);
                            } else {
                                console.log('❌ Could not find tableCard for checkbox:', checkbox);
                            }
                        } else {
                            console.log('❌ Could not find checkbox for table:', tableId);
                        }
                    });
                    
                    console.log('📋 Final selectedTables array:', selectedTables);
                    updateTableSelectionUI(); // Update UI after restoring
                }, 100);
            }
        }

        function openTablePopup(forceReload = false) {
            console.log('🚀 openTablePopup called - forceReload:', forceReload);

            const restaurantId = document.getElementById('restaurantId').value;
            if (!restaurantId) {
                alert('Vui lòng chọn nhà hàng trước khi xem sơ đồ bàn.');
                return;
            }

            const showModalWithContent = () => {
                renderTablePopupContent();
                const modal = new bootstrap.Modal(document.getElementById('tableModal'));
                modal.show();
            };

            if (forceReload || !availableTables || availableTables.length === 0) {
                console.log('🔄 Reloading tables before showing popup...');
                loadTables().then(tables => {
                    if (tables && tables.length) {
                        showModalWithContent();
                    } else {
                        renderTablePopupContent();
                        const warningMsg = 'Không tìm thấy bàn khả dụng cho nhà hàng này.';
                        console.warn(warningMsg);
                        const modal = new bootstrap.Modal(document.getElementById('tableModal'));
                        modal.show();
                    }
                }).catch(error => {
                    console.error('❌ Error reloading tables before popup:', error);
                    renderTablePopupContent();
                    const modal = new bootstrap.Modal(document.getElementById('tableModal'));
                    modal.show();
                });
            } else {
                showModalWithContent();
            }
        }

        function openMenuPopup() {
            // Initialize filtered dishes
            filteredDishes = availableDishes;
            
            const menuList = document.getElementById('menuList');
            menuList.innerHTML = '';
            
            if (availableDishes.length === 0) {
                menuList.innerHTML = `
                    <div class="col-12 text-center">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            No menu items available for this restaurant.
                        </div>
                    </div>
                `;
            } else {
                // Render first page with pagination
                renderMenuPage(1);
            }
            
            const modal = new bootstrap.Modal(document.getElementById('menuModal'));
            modal.show();
        }

        function confirmTableSelection() {
            console.log('🎯 confirmTableSelection() called');
            const checkboxes = document.querySelectorAll('.table-checkbox:checked');
            console.log('🎯 Found checked checkboxes:', checkboxes.length);
            selectedTables = [];
            
            checkboxes.forEach(checkbox => {
                console.log('🎯 Processing checkbox:', checkbox.value);
                const tableCard = checkbox.closest('.table-card');
                console.log('🎯 Found tableCard:', tableCard);
                
                const tableId = tableCard.getAttribute('data-table-id');
                const deposit = parseFloat(tableCard.getAttribute('data-deposit'));
                const tableName = tableCard.querySelector('.card-title').textContent;
                const capacityText = tableCard.querySelector('.card-text small').textContent;
                const capacity = parseInt(capacityText.match(/\d+/)[0]);
                
                console.log('🎯 Table data:', {
                    id: tableId,
                    name: tableName,
                    deposit: deposit,
                    capacity: capacity
                });
                
                selectedTables.push({
                    id: tableId,
                    name: tableName,
                    deposit: deposit,
                    capacity: capacity
                });
                console.log('🎯 Added to selectedTables:', tableId);
            });
            
            console.log('🎯 Final selectedTables in confirmTableSelection:', selectedTables);
            
            // Update UI
            updateTableSelectionUI();
            updateTotalAmount();
            
            // Save form state
            saveFormState();
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('tableModal'));
            modal.hide();
        }

        function confirmMenuSelection() {
            const checkboxes = document.querySelectorAll('.dish-checkbox:checked');
            selectedDishes = [];
            
            checkboxes.forEach(checkbox => {
                const dishCard = checkbox.closest('.dish-card');
                if (!dishCard) return; // Safety check
                
                const dishId = dishCard.getAttribute('data-dish-id');
                const price = parseFloat(dishCard.getAttribute('data-price'));
                const dishNameElement = dishCard.querySelector('.dish-name');
                const dishName = dishNameElement ? dishNameElement.textContent : 'Unknown Dish';
                const quantityInput = dishCard.querySelector('.quantity-control input');
                const quantity = quantityInput ? parseInt(quantityInput.value) || 1 : 1;
                
                selectedDishes.push({
                    id: dishId,
                    name: dishName,
                    price: price,
                    quantity: quantity
                });
            });
            
            // Update UI
            updateMenuSelectionUI();
            updateTotalAmount();
            
            // Save form state
            saveFormState();
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('menuModal'));
            modal.hide();
        }

        function updateTableSelectionUI() {
            const countSpan = document.getElementById('selectedTablesCount');
            const summaryDiv = document.getElementById('selectedTablesSummary');
            const listDiv = document.getElementById('selectedTablesList');

            updateSelectedTableIds();

            if (!countSpan || !summaryDiv || !listDiv) {
                return;
            }

            if (selectedTables.length === 0) {
                countSpan.textContent = 'Chưa chọn bàn';
                summaryDiv.style.display = 'none';
                listDiv.innerHTML = '';
                return;
            }

            countSpan.textContent = `${selectedTables.length} table(s) selected`;
            summaryDiv.style.display = 'block';
            listDiv.innerHTML = selectedTables.map(table => {
                const tableName = table.name || table.tableName || 'Bàn';
                const capacityValue = table.capacity ?? table.tableCapacity ?? table.maxCapacity;
                const capacity = capacityValue !== undefined && capacityValue !== null ? capacityValue : '?';
                const depositValue = table.deposit ?? table.depositAmount ?? 0;
                const normalizedDeposit = Number(depositValue) || 0;

                return `
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span><strong>${tableName}</strong> (Sức chứa: ${capacity} khách)</span>
                        <span class="text-success">${formatCurrency(normalizedDeposit)}</span>
                    </div>
                `;
            }).join('');
        }

        function updateMenuSelectionUI() {
            const countSpan = document.getElementById('selectedDishesCount');
            const hiddenInput = document.getElementById('selectedDishIds');
            const summaryDiv = document.getElementById('selectedDishesSummary');
            const listDiv = document.getElementById('selectedDishesList');
            
            if (selectedDishes.length === 0) {
                countSpan.textContent = 'Chưa chọn món';
                hiddenInput.value = '';
                summaryDiv.style.display = 'none';
            } else {
                countSpan.textContent = `${selectedDishes.length} item(s) selected`;
                hiddenInput.value = selectedDishes.map(d => `${d.id}:${d.quantity}`).join(',');
                
                // Show detailed summary
                summaryDiv.style.display = 'block';
                listDiv.innerHTML = selectedDishes.map(dish => `
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span><strong>${dish.name}</strong> x${dish.quantity}</span>
                        <span class="text-success">${formatCurrency(dish.price * dish.quantity)}</span>
                    </div>
                `).join('');
            }
        }

        function updateTotalAmount() {
            let tableDeposit = 0;
            let dishesTotal = 0;
            let servicesTotal = 0;

            // Calculate table deposit
            selectedTables.forEach(table => {
                tableDeposit += Number(table.deposit) || 0;
            });

            // Calculate dishes total
            selectedDishes.forEach(dish => {
                dishesTotal += (Number(dish.price) || 0) * (Number(dish.quantity) || 1);
            });

            // Calculate services total
            selectedServices.forEach(service => {
                servicesTotal += Number(service.price) || 0;
            });

            // Update hidden input with selected service IDs only if services exist
            const serviceIdsInput = document.getElementById('selectedServiceIds');
            if (serviceIdsInput) {
                serviceIdsInput.value = selectedServices.length > 0 ? selectedServices.map(s => s.id).join(',') : serviceIdsInput.value;
            }

            // Calculate subtotal
            const subtotal = tableDeposit + dishesTotal + servicesTotal;
            
            // Update display
            document.getElementById('tableDepositAmount').textContent = formatCurrency(tableDeposit);
            document.getElementById('dishesTotalAmount').textContent = formatCurrency(dishesTotal);
            document.getElementById('servicesTotalAmount').textContent = formatCurrency(servicesTotal);
            document.getElementById('subtotalAmount').textContent = formatCurrency(subtotal);
            
            // Calculate final total with voucher discount
            const finalTotal = Math.max(0, subtotal - voucherDiscount);
            document.getElementById('totalDepositAmount').textContent = formatCurrency(finalTotal);
            
            // Update hidden input
            document.getElementById('depositAmount').value = finalTotal;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }
        
        // Form validation before submit
        function validateForm() {
            console.log('🔍 validateForm() called - starting validation...');
            
            // Log current selections before validation
            logAllSelections();
            
            // First, run our comprehensive validation
            if (!validateFormBeforeSubmit()) {
                console.log('❌ validateFormBeforeSubmit() failed, stopping form submission');
                console.log('🔍 After validation failure - checking if selections are preserved...');
                logAllSelections();
                
                // Restore form state after validation failure
                console.log('🔄 Restoring form state after validation failure...');
                restoreFormState();
                
                return false;
            }
            
            console.log('✅ validateFormBeforeSubmit() passed, proceeding with Smart Waitlist check...');
            
            // Save current form state before validation
            saveFormState();
            
            // Check if form elements exist
            const restaurantSelect = document.getElementById('restaurantId');
            const guestCountInput = document.getElementById('guestCount');
            const bookingTimeInput = document.getElementById('bookingTime');
            const selectedTableIdsInput = document.getElementById('selectedTableIds');
            
            const restaurantId = restaurantSelect.value;
            const guestCount = guestCountInput.value;
            const bookingTime = bookingTimeInput.value;
            const selectedTableIds = selectedTableIdsInput.value;
            
            // Basic validation (redundant but keeping for safety)
            if (!restaurantId || !guestCount || !bookingTime) {
                alert('Vui lòng điền đầy đủ các trường bắt buộc.');
                return false;
            }
            
            // Check availability with Smart Waitlist
            console.log('🔍 Starting Smart Waitlist availability check...');
            checkAvailabilityAndShowPopup(restaurantId, bookingTime, guestCount, selectedTableIds);
            
            // Prevent default form submission - we'll handle it in the callback
            return false;
        }
        
        // Save form state to hidden inputs
        function saveFormState() {
            console.log('💾 saveFormState() called - saving current selections...');
            logAllSelections();
            
            // Save table selections
            const tableIds = selectedTables
                .map(extractTableId)
                .filter(id => id !== '')
                .join(',');
            document.getElementById('selectedTableIds').value = tableIds;
            console.log('💾 Saved tableIds:', tableIds);
            
            // Save dish selections
            const dishIds = selectedDishes.map(d => `${d.id}:${d.quantity}`).join(',');
            document.getElementById('selectedDishIds').value = dishIds;
            console.log('💾 Saved dishIds:', dishIds);
            
            // Save service selections
            const serviceIds = selectedServices.map(s => s.id).join(',');
            document.getElementById('selectedServiceIds').value = serviceIds;
            console.log('💾 Saved serviceIds:', serviceIds);
            
            console.log('💾 Form state saved successfully');
        }
        
        // Set minimum datetime to now + 30 minutes
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            now.setMinutes(now.getMinutes() + 30);
            const minDateTime = now.toISOString().slice(0, 16);
            const bookingTimeInput = document.getElementById('bookingTime');            
            
            // Load tables if restaurant is already selected (edit mode)
            if (document.getElementById('restaurantId').value) {
                loadTables().then(() => {
                    console.log('✅ Tables loaded, now restoring form state...');
                    restoreFormState();
                }).catch((error) => {
                    console.error('❌ Error loading tables:', error);
                    // Still try to restore form state even if tables fail to load
                    restoreFormState();
                });
            } else {
                // Restore form state immediately if no restaurant selected
                restoreFormState();
            }
            
            // Add change listener for restaurant selection
            document.getElementById('restaurantId').addEventListener('change', function() {
                loadTables();
                clearFormData();
            });
            
            // Initialize total amount calculation will be handled after restore
            
            // Add event listeners for dish checkboxes to show/hide quantity controls
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('dish-checkbox')) {
                    const quantityControl = e.target.parentElement.querySelector('.quantity-control');
                    if (quantityControl) {
                        quantityControl.style.display = e.target.checked ? 'block' : 'none';
                    }
                }
            });
            
            // Load available vouchers
            loadAvailableVouchers();
            
            // Reload vouchers when restaurant changes
            document.getElementById('restaurantId').addEventListener('change', function() {
                console.log('Restaurant changed, reloading vouchers...');
                loadAvailableVouchers();
            });
        });
        
        // Load available vouchers for the customer
        function loadAvailableVouchers() {
            const restaurantId = document.getElementById('restaurantId').value;
            console.log('Loading vouchers for restaurant:', restaurantId);
            
            // Always use demo endpoint which handles authentication internally
            const url = restaurantId ? `/api/vouchers/demo?restaurantId=${restaurantId}` : '/api/vouchers/demo';
            
            fetch(url, {
                method: 'GET',
                credentials: 'include', // Include cookies for authentication
                headers: {
                    'X-Requested-With': 'XMLHttpRequest' // Indicate AJAX request
                }
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Failed to load vouchers');
                }
            })
            .then(vouchers => {
                availableVouchers = vouchers;
                console.log('Loaded vouchers:', vouchers);
                populateVoucherDropdown();
            })
            .catch(error => {
                console.error('Error loading vouchers:', error);
                // Show empty dropdown on error
                availableVouchers = [];
                populateVoucherDropdown();
            });
        }
        
        // Populate voucher dropdown
        function populateVoucherDropdown() {
            const voucherSelect = document.getElementById('voucherSelect');
            voucherSelect.innerHTML = '<option value="">Chọn voucher của bạn</option>';
            
            availableVouchers.forEach(voucher => {
                const option = document.createElement('option');
                option.value = voucher.code;
                option.textContent = `${voucher.code} - ${voucher.description} (${voucher.discountType === 'PERCENT' ? voucher.discountValue + '%' : '₫' + voucher.discountValue})`;
                option.dataset.voucherId = voucher.voucherId;
                option.dataset.discountType = voucher.discountType;
                option.dataset.discountValue = voucher.discountValue;
                option.dataset.maxDiscountAmount = voucher.maxDiscountAmount;
                voucherSelect.appendChild(option);
            });
        }
        
        // Validate selected voucher
        function validateSelectedVoucher() {
            const voucherSelect = document.getElementById('voucherSelect');
            const selectedOption = voucherSelect.options[voucherSelect.selectedIndex];
            
            if (!selectedOption.value) {
                showVoucherError('Vui lòng chọn voucher');
                return;
            }
            
            const restaurantId = document.getElementById('restaurantId').value;
            const bookingTime = document.getElementById('bookingTime').value;
            const guestCount = document.getElementById('guestCount').value;
            
            if (!restaurantId) {
                showVoucherError('Vui lòng chọn nhà hàng trước');
                return;
            }
            
            if (!bookingTime) {
                showVoucherError('Vui lòng chọn thời gian đặt bàn trước');
                return;
            }
            
            if (!guestCount) {
                showVoucherError('Vui lòng nhập số lượng khách trước');
                return;
            }
            
            // Show loading state
            const validateBtn = document.getElementById('validateVoucherBtn');
            const originalText = validateBtn.innerHTML;
            validateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Applying...';
            validateBtn.disabled = true;
            
            // Prepare request data
            const requestData = {
                code: selectedOption.value,
                restaurantId: parseInt(restaurantId),
                bookingTime: bookingTime,
                guestCount: parseInt(guestCount),
                orderAmount: 1000000 // Placeholder amount - should be calculated from actual order
            };
            
            // Make API call
            fetch('/api/vouchers/validate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.valid) {
                    // Store voucher discount amount
                    voucherDiscount = data.calculatedDiscount ? parseFloat(data.calculatedDiscount) : 0;
                    
                    const discountText = data.calculatedDiscount ? 
                        `Giảm: ${formatCurrency(data.calculatedDiscount)}` : 
                        'Voucher hợp lệ';
                    showVoucherSuccess(discountText);
                } else {
                    // Reset voucher discount on error
                    voucherDiscount = 0;
                    const errorMessage = getVoucherErrorMessage(data.reason);
                    showVoucherError(errorMessage);
                }
            })
            .catch(error => {
                console.error('Error validating voucher:', error);
                showVoucherError('Không thể kiểm tra voucher, vui lòng thử lại.');
            })
            .finally(() => {
                // Reset button state
                validateBtn.innerHTML = originalText;
                validateBtn.disabled = false;
            });
        }
        
        // Voucher validation function (legacy - keep for compatibility)
        function validateVoucher() {
            const voucherCode = document.getElementById('voucherCode').value.trim();
            const restaurantId = document.getElementById('restaurantId').value;
            const bookingTime = document.getElementById('bookingTime').value;
            const guestCount = document.getElementById('guestCount').value;
            
            if (!voucherCode) {
                showVoucherError('Vui lòng nhập mã voucher');
                return;
            }
            
            if (!restaurantId) {
                showVoucherError('Vui lòng chọn nhà hàng trước');
                return;
            }
            
            if (!bookingTime) {
                showVoucherError('Vui lòng chọn thời gian đặt bàn trước');
                return;
            }
            
            if (!guestCount) {
                showVoucherError('Vui lòng nhập số lượng khách trước');
                return;
            }
            
            // Show loading state
            const validateBtn = document.getElementById('validateVoucherBtn');
            const originalText = validateBtn.innerHTML;
            validateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang kiểm tra...';
            validateBtn.disabled = true;
            
            // Prepare request data
            const requestData = {
                code: voucherCode,
                restaurantId: parseInt(restaurantId),
                bookingTime: bookingTime,
                guestCount: parseInt(guestCount),
                orderAmount: 1000000 // Placeholder amount - should be calculated from actual order
            };
            
            // Make API call
            fetch('/api/vouchers/validate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.valid) {
                    // Store voucher discount amount
                    voucherDiscount = data.calculatedDiscount ? parseFloat(data.calculatedDiscount) : 0;
                    
                    const discountText = data.calculatedDiscount ? 
                        `Giảm: ${formatCurrency(data.calculatedDiscount)}` : 
                        'Voucher hợp lệ';
                    showVoucherSuccess(discountText);
                } else {
                    // Reset voucher discount on error
                    voucherDiscount = 0;
                    const errorMessage = getVoucherErrorMessage(data.reason);
                    showVoucherError(errorMessage);
                }
            })
            .catch(error => {
                console.error('Error validating voucher:', error);
                showVoucherError('Không thể kiểm tra voucher, vui lòng thử lại.');
            })
            .finally(() => {
                // Reset button state
                validateBtn.innerHTML = originalText;
                validateBtn.disabled = false;
            });
        }
        
        function showVoucherSuccess(message) {
            hideVoucherMessages();
            document.getElementById('voucherSuccessText').textContent = message;
            document.getElementById('voucherSuccess').style.display = 'block';
            document.getElementById('voucherResult').style.display = 'block';
            
            // Update voucher discount in Booking Summary
            updateVoucherDiscountInSummary();
        }
        
        function showVoucherError(message) {
            hideVoucherMessages();
            document.getElementById('voucherErrorText').textContent = message;
            document.getElementById('voucherError').style.display = 'block';
            document.getElementById('voucherResult').style.display = 'block';
        }
        
        function hideVoucherMessages() {
            document.getElementById('voucherSuccess').style.display = 'none';
            document.getElementById('voucherError').style.display = 'none';
        }
        
        function getVoucherErrorMessage(reason) {
            const errorMessages = {
                'EMPTY_CODE': 'Vui lòng nhập mã voucher',
                'NOT_FOUND': 'Không tìm thấy voucher phù hợp',
                'INACTIVE': 'Voucher này hiện không hoạt động',
                'NOT_STARTED': 'Voucher này chưa bắt đầu áp dụng',
                'EXPIRED': 'Voucher này đã hết hạn',
                'RESTAURANT_SCOPE_MISMATCH': 'Voucher không áp dụng cho nhà hàng đã chọn',
                'MIN_ORDER_NOT_MET': 'Giá trị đặt bàn chưa đạt mức tối thiểu',
                'GLOBAL_LIMIT_REACHED': 'Voucher đã đạt số lượng sử dụng tối đa',
                'PER_CUSTOMER_LIMIT_REACHED': 'Bạn đã sử dụng voucher này đủ số lần cho phép',
                'NOT_ASSIGNED': 'Voucher này không thuộc về tài khoản của bạn',
                'LIMIT_REACHED': 'Bạn đã dùng voucher quá số lần quy định',
                'APPLICATION_ERROR': 'Có lỗi khi áp dụng voucher, vui lòng thử lại.'
            };
            return errorMessages[reason] || 'Mã voucher không hợp lệ';
        }

        
        // Restore form state after conflict/error
        function restoreFormState() {
            console.log('🔄 restoreFormState() called - restoring form state...');
            console.log('🔍 Current URL:', window.location.href);
            console.log('🔍 Is edit mode:', window.location.href.includes('/edit'));
            
            // Debug: Check hidden input values at the start of restoreFormState
            const selectedTableIds = document.getElementById('selectedTableIds').value;
            const selectedDishIds = document.getElementById('selectedDishIds').value;
            const serviceIdsInput = document.getElementById('selectedServiceIds');
            let selectedServiceIds = serviceIdsInput ? serviceIdsInput.value : '';

            if (serviceIdsInput && !selectedServiceIds && serviceIdsInput.dataset.initialValue) {
                selectedServiceIds = serviceIdsInput.dataset.initialValue;
                serviceIdsInput.value = selectedServiceIds;
                console.log('🔁 Restored serviceIds from initial dataset:', selectedServiceIds);
            }
            console.log('🔍 Hidden input values at START of restoreFormState():');
            console.log('  - selectedTableIds:', selectedTableIds);
            console.log('  - selectedDishIds:', selectedDishIds);
            console.log('  - selectedServiceIds:', selectedServiceIds);
            
            logAllSelections();
            
            // Check if we need to load data first
            const restaurantId = document.getElementById('restaurantId').value;
            if (restaurantId && (availableTables.length === 0 || availableDishes.length === 0 || availableServices.length === 0)) {
                console.log('🔄 Data not loaded yet, loading first...');
                loadTables().then(() => {
                    console.log('✅ Data loaded, now restoring form state...');
                    performRestore();
                }).catch((error) => {
                    console.error('❌ Error loading data:', error);
                    // Still try to restore with whatever data we have
                    performRestore();
                });
            } else {
                console.log('🔄 Data already loaded, proceeding with restore...');
                performRestore();
            }
            
            function performRestore() {
                console.log('🔄 performRestore() called...');
                console.log('🔍 Data availability check:');
                console.log('  - availableTables.length:', availableTables.length);
                console.log('  - availableDishes.length:', availableDishes.length);
                console.log('  - availableServices.length:', availableServices.length);
                logAllSelections();
            
            // Debug: Check booking time input value
            const bookingTimeInput = document.getElementById('bookingTime');
            console.log('🔍 Booking time input value:', bookingTimeInput.value);
            console.log('🔍 Booking time input type:', bookingTimeInput.type);
            
            // Fix datetime format if needed
            const dataBookingTime = bookingTimeInput.getAttribute('data-booking-time');
            console.log('🔍 Data booking time attribute:', dataBookingTime);
            
            if (dataBookingTime) {
                try {
                    if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/.test(dataBookingTime)) {
                        bookingTimeInput.value = dataBookingTime;
                        console.log('🔍 Set booking time to (direct):', dataBookingTime);
                    } else if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}$/.test(dataBookingTime)) {
                        bookingTimeInput.value = dataBookingTime.slice(0, 16);
                        console.log('🔍 Set booking time to (trimmed seconds):', bookingTimeInput.value);
                    } else if (/Z|[+-]\d{2}:?\d{2}$/.test(dataBookingTime)) {
                        const asDate = new Date(dataBookingTime);
                        const localDate = new Date(asDate.getTime() - asDate.getTimezoneOffset() * 60000);
                        bookingTimeInput.value = localDate.toISOString().slice(0, 16);
                        console.log('🔍 Set booking time to (timezone adjusted):', bookingTimeInput.value);
                    } else {
                        const normalized = dataBookingTime.replace(' ', 'T');
                        bookingTimeInput.value = normalized.length >= 16 ? normalized.slice(0, 16) : normalized;
                        console.log('🔍 Set booking time to (normalized):', bookingTimeInput.value);
                    }
                } catch (error) {
                    console.error('❌ Error formatting booking time:', error);
                }
            }
            
            // If still no value, try to get from Thymeleaf
            if (!bookingTimeInput.value) {
                const thValue = bookingTimeInput.getAttribute('th:value');
                console.log('🔍 Thymeleaf value attribute:', thValue);
                
                if (thValue) {
                    bookingTimeInput.value = thValue;
                    console.log('🔍 Set booking time from Thymeleaf:', bookingTimeInput.value);
                }
            }
            
            // Restore table selection if any
            const selectedTableIds = document.getElementById('selectedTableIds').value;
            console.log('🔍 selectedTableIds from hidden input:', selectedTableIds);
            if (selectedTableIds) {
                const tableIds = selectedTableIds.split(',');
                selectedTables = [];
                
                // Find tables from availableTables array and add to selectedTables
                tableIds.forEach(tableId => {
                    console.log('🔍 Looking for table with ID:', tableId, 'type:', typeof tableId);
                    console.log('🔍 Available tables:', availableTables.map(t => ({ id: t.tableId, type: typeof t.tableId, name: t.tableName })));
                    
                    const table = availableTables.find(t => t.tableId == tableId);
                    if (table) {
                        selectedTables.push({
                            id: tableId,
                            name: table.tableName,
                            deposit: table.depositAmount || 0,
                            capacity: table.capacity
                        });
                        console.log('✅ Added table to selectedTables:', table.tableName);
                    } else {
                        console.log('❌ Table not found in availableTables:', tableId);
                    }
                });
                
                console.log(`✅ Restored ${selectedTables.length}/${tableIds.length} tables to selectedTables array`);
                updateTableSelectionUI();
            }
            
            // Restore dish selections if any
            const selectedDishIds = document.getElementById('selectedDishIds').value;
            console.log('🔍 selectedDishIds from hidden input:', selectedDishIds);
            if (selectedDishIds) {
                const dishSelections = selectedDishIds.split(',');
                selectedDishes = [];
                
                // Find dishes from availableDishes array and add to selectedDishes
                dishSelections.forEach(selection => {
                    const [dishId, quantity] = selection.split(':');
                    if (dishId && quantity) {
                        console.log('🔍 Looking for dish with ID:', dishId, 'type:', typeof dishId);
                    console.log('🔍 Available dishes:', availableDishes.map(d => ({ 
                        dishId: d.dishId, 
                        type: typeof d.dishId, 
                        name: d.name 
                    })));
                        
                    // Find dish by dishId field
                    const dish = availableDishes.find(d => d.dishId == dishId);
                        if (dish) {
                            selectedDishes.push({
                                id: dishId,
                                name: dish.name,
                                price: dish.price,
                                quantity: parseInt(quantity)
                            });
                            console.log('✅ Added dish to selectedDishes:', dish.name, 'x' + quantity);
                        } else {
                            console.log('❌ Dish not found in availableDishes:', dishId);
                        }
                    }
                });
                
                console.log(`✅ Restored ${selectedDishes.length}/${dishSelections.length} dishes to selectedDishes array`);
                updateMenuSelectionUI();
            }
            
            // Restore service selections if any
            const selectedServiceIds = document.getElementById('selectedServiceIds').value;
            console.log('🔍 selectedServiceIds from hidden input:', selectedServiceIds);
            if (selectedServiceIds) {
                const serviceIds = selectedServiceIds.split(',');
                selectedServices = [];
                
                // Find services from availableServices array and add to selectedServices
                console.log('🔍 Starting services restore process...');
                console.log('🔍 serviceIds to restore:', serviceIds);
                console.log('🔍 availableServices before restore:', availableServices.map(s => ({ 
                    serviceId: s.serviceId, 
                    type: typeof s.serviceId, 
                    name: s.name 
                })));
                
                serviceIds.forEach((serviceId, index) => {
                    console.log(`🔍 Processing service ${index + 1}/${serviceIds.length}:`, serviceId, 'type:', typeof serviceId);
                    
                    // Find service by serviceId field
                    const service = availableServices.find(s => s.serviceId == serviceId);
                    console.log('🔍 Found service:', service ? service.name : 'NOT FOUND');
                    
                    if (service) {
                        selectedServices.push({
                            id: serviceId,
                            name: service.name,
                            price: service.price || 0
                        });
                        console.log('✅ Added service to selectedServices:', service.name, 'price:', service.price);
                    } else {
                        console.log('❌ Service not found in availableServices:', serviceId);
                        console.log('🔍 Available serviceIds:', availableServices.map(s => s.serviceId));
                    }
                });
                
                console.log(`✅ Restored ${selectedServices.length}/${serviceIds.length} services to selectedServices array`);
                
                // Also mark services as selected in DOM
                console.log('🔍 Starting DOM marking for services...');
                serviceIds.forEach((serviceId, index) => {
                    console.log(`🔍 Looking for service card ${index + 1}/${serviceIds.length} with ID:`, serviceId);
                    
                    const serviceCard = document.querySelector(`.service-card[data-service-id="${serviceId}"]`) || 
                                      document.querySelector(`.service-card[data-id="${serviceId}"]`);
                    
                    console.log('🔍 Found service card:', serviceCard ? 'YES' : 'NO');
                    if (serviceCard) {
                        console.log('🔍 Service card details:', {
                            id: serviceCard.getAttribute('data-service-id') || serviceCard.getAttribute('data-id'),
                            name: serviceCard.querySelector('.card-title')?.textContent || 'No title',
                            classes: serviceCard.className
                        });
                        
                        serviceCard.classList.add('selected');
                        console.log('✅ Marked service as selected in DOM:', serviceId);
                    } else {
                        console.log('❌ Service card not found in DOM:', serviceId);
                        console.log('🔍 All service cards in DOM:', document.querySelectorAll('.service-card').length);
                        console.log('🔍 Available service card IDs:', Array.from(document.querySelectorAll('.service-card')).map(card => 
                            card.getAttribute('data-service-id') || card.getAttribute('data-id')
                        ));
                    }
                });
            }
            
            // Update total amount after restoring all selections
            setTimeout(() => {
                updateTotalAmount();
            }, 2000);
            
            console.log('🔄 performRestore() completed');
            logAllSelections();
            }
            
            console.log('🔄 restoreFormState() completed');

            // Recalculate totals once restore is done to avoid early resets
            setTimeout(() => updateTotalAmount(), 0);
        }
        
        function updateVoucherDiscountInSummary() {
            console.log('updateVoucherDiscountInSummary called, voucherDiscount:', voucherDiscount);
            const voucherDiscountRow = document.getElementById('voucherDiscountRow');
            const voucherDiscountDisplay = document.getElementById('voucherDiscountDisplay');
            
            console.log('voucherDiscountRow element:', voucherDiscountRow);
            console.log('voucherDiscountDisplay element:', voucherDiscountDisplay);
            
            if (voucherDiscount > 0) {
                // Show voucher discount row
                if (voucherDiscountRow) {
                    voucherDiscountRow.style.display = 'flex';
                    console.log('Voucher discount row shown');
                }
                if (voucherDiscountDisplay) {
                    voucherDiscountDisplay.textContent = '-' + formatCurrency(voucherDiscount);
                    console.log('Voucher discount amount updated to:', '-' + formatCurrency(voucherDiscount));
                }
                
                // Update hidden inputs
                const hiddenDiscountAmount = document.getElementById('voucherDiscountAmount');
                const hiddenCodeApplied = document.getElementById('voucherCodeApplied');
                
                if (hiddenDiscountAmount) {
                    hiddenDiscountAmount.value = voucherDiscount;
                }
                
                const voucherSelect = document.getElementById('voucherSelect');
                if (voucherSelect && hiddenCodeApplied) {
                    const selectedOption = voucherSelect.options[voucherSelect.selectedIndex];
                    hiddenCodeApplied.value = selectedOption ? selectedOption.value : '';
                }
                
                // Update total amount
                updateTotalAmount();
            } else {
                // Hide voucher discount row
                if (voucherDiscountRow) {
                    voucherDiscountRow.style.display = 'none';
                    console.log('Voucher discount row hidden');
                }
                
                // Reset hidden inputs
                const hiddenDiscountAmount = document.getElementById('voucherDiscountAmount');
                const hiddenCodeApplied = document.getElementById('voucherCodeApplied');
                
                if (hiddenDiscountAmount) {
                    hiddenDiscountAmount.value = '0';
                }
                if (hiddenCodeApplied) {
                    hiddenCodeApplied.value = '';
                }
                
                updateTotalAmount();
            }
        }
        
        // Helper functions for table status display
        function getStatusBadgeClass(status) {
            const statusValue = getTableStatusValue(status);
            switch(statusValue) {
                case 'AVAILABLE':
                    return 'table-status-badge table-status-available';
                case 'OCCUPIED':
                    return 'table-status-badge table-status-occupied';
                case 'RESERVED':
                    return 'table-status-badge table-status-reserved';
                case 'CLEANING':
                    return 'table-status-badge table-status-cleaning';
                case 'MAINTENANCE':
                    return 'table-status-badge table-status-maintenance';
                default:
                    return 'table-status-badge table-status-unknown';
            }
        }
        
        function getStatusDisplayName(status) {
            const statusValue = getTableStatusValue(status);
            switch(statusValue) {
                case 'AVAILABLE':
                    return 'Có sẵn';
                case 'OCCUPIED':
                    return 'Đang sử dụng';
                case 'RESERVED':
                    return 'Đã đặt';
                case 'CLEANING':
                    return 'Đang dọn dẹp';
                case 'MAINTENANCE':
                    return 'Bảo trì';
                default:
                    return statusValue;
            }
        }
        
        function getTableStatusValue(status) {
            // Handle both string and object status
            if (typeof status === 'string') {
                return status.toUpperCase(); // Convert to uppercase for consistent comparison
            } else if (status && typeof status === 'object') {
                const value = status.value || status.name || 'UNKNOWN';
                return value.toUpperCase();
            }
            return 'UNKNOWN';
        }
        
        // ==================== SMART WAITLIST FUNCTIONALITY ====================
        
        // Global variables for Smart Waitlist
        let currentAvailabilityData = null;
        let selectedAlternativeTable = null;
        
        /**
         * Check availability before form submission
         */
        function checkAvailabilityAndShowPopup(restaurantId, bookingTime, guestCount, selectedTableIds) {
            console.log('🔍 Checking availability before booking...');
            
            const params = new URLSearchParams({
                restaurantId: restaurantId,
                bookingTime: bookingTime,
                guestCount: guestCount
            });
            
            if (selectedTableIds && selectedTableIds.trim() !== '') {
                params.append('selectedTableIds', selectedTableIds);
            }
            
            fetch(`/api/booking/availability-check?${params}`)
                .then(response => response.json())
                .then(data => {
                    console.log('📊 Availability check response:', data);
                    currentAvailabilityData = data;
                    
                    if (data.hasConflict) {
                        console.log('⚠️ Conflict detected, showing Smart Waitlist popup');
                        showSmartWaitlistPopup(data);
                    } else {
                        console.log('✅ No conflicts, proceeding with booking');
                        submitBookingForm();
                    }
                })
                .catch(error => {
                    console.error('❌ Error checking availability:', error);
                    // Fallback to normal booking if API fails
                    submitBookingForm();
                });
        }
        
        /**
         * Show Smart Waitlist popup with conflict information
         */
        function showSmartWaitlistPopup(data) {
            console.log('🎭 Showing Smart Waitlist popup with data:', data);
            
            // Update popup title based on conflict type
            const popupTitle = document.getElementById('popupTitle');
            if (data.conflictType === 'SPECIFIC_TABLE') {
                popupTitle.textContent = 'Bàn bạn chọn đang trùng lịch';
            } else if (data.conflictType === 'NO_AVAILABLE_TABLES') {
                popupTitle.textContent = 'Không còn bàn phù hợp với số khách';
            }
            
            // Populate conflict content
            populateConflictContent(data);
            
            // Populate waitlist information
            populateWaitlistInfo(data.waitlistInfo);
            
            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('smartWaitlistModal'));
            modal.show();
        }
        
        /**
         * Populate conflict content based on conflict type
         */
        function populateConflictContent(data) {
            const conflictContent = document.getElementById('conflictContent');
            
            if (data.conflictType === 'SPECIFIC_TABLE') {
                let html = '<div class="alert alert-warning"><h6><i class="fas fa-exclamation-triangle"></i> Bàn đang được giữ bởi người khác:</h6>';
                
                data.conflictDetails.selectedTables.forEach(table => {
                    html += `<div class="mb-2">
                        <strong>${table.tableName}</strong> (Sức chứa: ${table.capacity} khách)
                        <ul class="mb-0 mt-1">`;
                    
                    table.conflicts.forEach(conflict => {
                        const bookingTime = new Date(conflict.bookingTime).toLocaleString('vi-VN');
                        const endTime = new Date(conflict.endTime).toLocaleString('vi-VN');
                        html += `<li>Đặt bàn #${conflict.bookingId}: ${bookingTime} - ${endTime} (${conflict.guestCount} khách, ${conflict.status})</li>`;
                    });
                    
                    html += '</ul></div>';
                });
                
                html += '</div>';
                conflictContent.innerHTML = html;
                
            } else if (data.conflictType === 'NO_AVAILABLE_TABLES') {
                conflictContent.innerHTML = `
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-ban"></i> No Available Tables</h6>
                        <p class="mb-0">All tables suitable for your party size are currently booked.</p>
                    </div>
                `;
            }
        }
        
        /**
         * Populate waitlist information
         */
        function populateWaitlistInfo(waitlistInfo) {
            if (!waitlistInfo) return;
            
            const waitTimeElement = document.getElementById('waitTime');
            const waitReasonElement = document.getElementById('waitReason');
            
            if (waitlistInfo.estimatedWaitTime) {
                const waitTime = new Date(waitlistInfo.estimatedWaitTime).toLocaleString('vi-VN');
                waitTimeElement.textContent = waitTime;
            }
            
            if (waitlistInfo.reason) {
                waitReasonElement.textContent = waitlistInfo.reason;
            }
        }
        
        /**
         * Join Smart Waitlist
         */
        function joinSmartWaitlist() {
            console.log('⏰ User chose to join waitlist');
            
            // Get form data with null checks
            const restaurantIdElement = document.getElementById('restaurantId');
            const guestCountElement = document.getElementById('guestCount');
            const bookingTimeElement = document.getElementById('bookingTime');
            
            if (!restaurantIdElement || !guestCountElement || !bookingTimeElement) {
                console.error('❌ Required form elements not found');
                showNotification('Không tìm thấy dữ liệu biểu mẫu, vui lòng tải lại trang và thử lại.', 'error');
                return;
            }
            
            const restaurantId = restaurantIdElement.value;
            const guestCount = parseInt(guestCountElement.value);
            const preferredBookingTime = bookingTimeElement.value;
            const specialRequests = ''; // No special requests field in current form
            
            // Get selected items
            const dishIds = document.getElementById('selectedDishIds').value || '';
            const serviceIds = document.getElementById('selectedServiceIds').value || '';
            const tableIds = document.getElementById('selectedTableIds').value || '';
            
            console.log('🔍 Join waitlist data:', {
                restaurantId: restaurantId,
                guestCount: guestCount,
                preferredBookingTime: preferredBookingTime,
                specialRequests: specialRequests,
                dishIds: dishIds,
                serviceIds: serviceIds,
                tableIds: tableIds
            });
            
            // Call API to join waitlist
            fetch('/api/booking/join-waitlist', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    restaurantId: parseInt(restaurantId),
                    guestCount: guestCount,
                    preferredBookingTime: preferredBookingTime,
                    specialRequests: specialRequests,
                    dishIds: dishIds,
                    serviceIds: serviceIds,
                    tableIds: tableIds
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('✅ Join waitlist response:', data);
                
                if (data.success) {
                    // Close the popup
                    const modal = bootstrap.Modal.getInstance(document.getElementById('smartWaitlistModal'));
                    modal.hide();
                    
                    // Show success message
                    showNotification(`Đã tham gia danh sách chờ! Vị trí của bạn: ${data.queuePosition}, thời gian chờ ước tính: ${data.estimatedWaitTime} phút`, 'success');
                } else {
                    showNotification(data.error || 'Không thể tham gia danh sách chờ', 'error');
                }
            })
            .catch(error => {
                console.error('❌ Error joining waitlist:', error);
                showNotification('Không thể tham gia danh sách chờ, vui lòng thử lại.', 'error');
            });
        }
        
        /**
         * Validate form before submission
         */
        function validateFormBeforeSubmit() {
            console.log('🔍 Validating form before submission...');
            
            // Get form data
            const restaurantId = document.getElementById('restaurantId').value;
            const guestCount = parseInt(document.getElementById('guestCount').value);
            const bookingTime = document.getElementById('bookingTime').value;
            const tableId = document.getElementById('tableId').value;
            const tableIds = document.getElementById('selectedTableIds').value;
            
            console.log('   Restaurant ID:', restaurantId);
            console.log('   Guest Count:', guestCount);
            console.log('   Booking Time:', bookingTime);
            console.log('   Table ID:', tableId);
            console.log('   Table IDs:', tableIds);
            
            // 1. Validate required fields
            if (!restaurantId) {
                showNotification('Vui lòng chọn nhà hàng', 'error');
                return false;
            }
            
            if (!guestCount || guestCount < 1) {
                showNotification('Số lượng khách phải ít nhất 1 người', 'error');
                return false;
            }
            
            if (guestCount > 20) {
                showNotification('Số lượng khách không được vượt quá 20 người', 'error');
                return false;
            }
            
            if (!bookingTime) {
                showNotification('Vui lòng chọn thời gian đặt bàn', 'error');
                return false;
            }
            
            // 2. Validate table selection
            if (!tableId && !tableIds) {
                showNotification('Vui lòng chọn ít nhất một bàn', 'error');
                return false;
            }
            
            // 3. Validate table capacity
            if (!validateTableCapacityBeforeSubmit(guestCount, tableId, tableIds)) {
                return false;
            }
            
            console.log('✅ Form validation passed');
            return true;
        }
        
        /**
         * Validate table capacity before submission
         */
        function validateTableCapacityBeforeSubmit(guestCount, tableId, tableIds) {
            console.log('🔍 Validating table capacity...');
            
            if (tableId) {
                // Single table validation
                const table = availableTables.find(t => t.tableId == tableId);
                if (table) {
                    console.log('   Table capacity:', table.capacity);
                    if (guestCount > table.capacity) {
                        showNotification(`Số khách (${guestCount}) vượt quá sức chứa của bàn ${table.tableName} (${table.capacity} người)`, 'error');
                        return false;
                    }
                }
            } else if (tableIds) {
                // Multiple tables validation
                const tableIdArray = tableIds.split(',');
                let totalCapacity = 0;
                let tableNames = [];
                
                for (const tableIdStr of tableIdArray) {
                    const table = availableTables.find(t => t.tableId == tableIdStr.trim());
                    if (table) {
                        totalCapacity += table.capacity;
                        tableNames.push(table.tableName);
                    }
                }
                
                console.log('   Total capacity:', totalCapacity);
                if (guestCount > totalCapacity) {
                    showNotification(`Số khách (${guestCount}) vượt quá tổng sức chứa của các bàn đã chọn (${totalCapacity} người)`, 'error');
                    return false;
                }
            }
            
            console.log('✅ Table capacity validation passed');
            return true;
        }
        
        /**
         * Submit booking form (original function)
         */
        function submitBookingForm() {
            console.log('📝 Submitting booking form...');
            
            // Validate form before submission
            if (!validateFormBeforeSubmit()) {
                console.log('❌ Form validation failed, not submitting');
                return;
            }
            
            // Save form state before submission
            saveFormState();
            
            // Find and submit the form
            const form = document.getElementById('bookingForm');
            if (!form) {
                console.error('❌ Booking form not found');
                showNotification('Không tìm thấy biểu mẫu, vui lòng tải lại trang và thử lại.', 'error');
                return;
            }
            
            console.log('✅ Form validation passed, submitting form...');
            form.submit();
        }
        
        /**
         * Show notification
         */
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }
        
        /**
         * Clear all form data when restaurant changes
         */
        function clearFormData() {
            tablesLoaded = false;
            tablesLoading = false;
            availableTables = [];
            filteredTables = [];
            console.log('🔄 Clearing form data...');
            
            // Clear selected tables
            selectedTables = [];
            document.getElementById('selectedTableIds').value = '';
            document.getElementById('selectedTablesCount').textContent = 'Chưa chọn bàn';
            document.getElementById('selectedTablesSummary').style.display = 'none';
            document.getElementById('selectedTablesList').innerHTML = '';
            
            // Clear selected dishes
            selectedDishes = [];
            document.getElementById('selectedDishIds').value = '';
            document.getElementById('selectedDishesCount').textContent = 'Chưa chọn món';
            document.getElementById('selectedDishesSummary').style.display = 'none';
            document.getElementById('selectedDishesList').innerHTML = '';
            
            // Clear selected services
            document.getElementById('selectedServiceIds').value = '';
            document.querySelectorAll('#servicesContainer input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Clear guest count
            document.getElementById('guestCount').value = '';
            
            // Clear booking time
            document.getElementById('bookingTime').value = '';
            
            console.log('✅ Form data cleared');
        }
        
        // ==================== END SMART WAITLIST FUNCTIONALITY ====================
    </script>
</body>
</html> 

