<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${bookingId != null ? 'Chỉnh sửa đặt bàn - Book Eat' : 'Đặt bàn mới - Book Eat'}">Book Eat – Đặt bàn</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Shared styles -->
    <link th:href="@{/css/home-resy.css}" rel="stylesheet">
    <link th:href="@{/css/luxury.css}" rel="stylesheet">
    <link th:href="@{/css/booking-resy.css}" rel="stylesheet">
    
    <!-- Custom styles for booking form -->
    <style>
        /* Menu and Service Cards Styling */
        .dish-card, .service-card {
            transition: all 0.3s ease;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .dish-card:hover, .service-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-color: #007bff;
        }
        
        .dish-card.selected, .service-card.selected {
            border-color: #28a745;
            background-color: #f8fff9;
        }

        /* Quantity input styling */
        .quantity-btn {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }

        .quantity-input {
            width: 60px;
            text-align: center;
            font-weight: 600;
        }

        /* Dish image styling */
        .dish-image {
            transition: transform 0.3s ease;
        }

        .dish-image:hover {
            transform: scale(1.05);
        }
        
        /* Dish Card Specific */
        .dish-card .card-img-top {
            height: 180px !important;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .dish-card:hover .card-img-top {
            transform: scale(1.05);
        }
        
        .dish-card .dish-name {
            font-size: 1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
            line-height: 1.3;
        }
        
        .dish-card .dish-description {
            font-size: 0.85rem;
            color: #6c757d;
            line-height: 1.4;
            height: 2.8rem;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .dish-card .dish-price {
            font-size: 1.1rem;
            font-weight: 700;
            color: #e74c3c;
        }
        
        .dish-card .dish-category {
            font-size: 0.75rem;
            background: #f8f9fa;
            color: #6c757d;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
        }
        
        /* Service Card Specific */
        .service-card .service-icon {
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .service-card .service-name {
            font-size: 1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
            line-height: 1.3;
        }
        
        .service-card .service-description {
            font-size: 0.85rem;
            color: #6c757d;
            line-height: 1.4;
            height: 2.8rem;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .service-card .service-price {
            font-size: 1.1rem;
            font-weight: 700;
            color: #e74c3c;
        }
        
        /* Checkbox Styling */
        .dish-card .form-check-input, .service-card .form-check-input {
            width: 1.2rem;
            height: 1.2rem;
            margin-top: 0.1rem;
        }
        
        .dish-card .form-check-input:checked, .service-card .form-check-input:checked {
            background-color: #28a745;
            border-color: #28a745;
        }
        
        /* Container Spacing */
        #menuItemsContainer, #servicesContainer {
            margin-top: 1rem;
        }
        
        /* Selection Count Styling */
        #selectedDishesCount, #selectedServicesCount {
            background: #f8f9fa;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 500;
            border: 1px solid #dee2e6;
        }
        
        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .dish-card .dish-description, .service-card .service-description {
                height: auto;
                -webkit-line-clamp: 3;
            }
            
            .dish-card .card-img-top {
                height: 150px !important;
            }
            
            .col-md-4 {
                margin-bottom: 1rem;
            }
        }
        
        @media (max-width: 576px) {
            .dish-card .card-body, .service-card .card-body {
                padding: 1rem !important;
            }
            
            .dish-card .dish-name, .service-card .service-name {
                font-size: 0.9rem;
            }
            
            .dish-card .dish-description, .service-card .service-description {
                font-size: 0.8rem;
            }
        }
        
        /* Grid spacing improvements */
        .row {
            margin-left: -0.5rem;
            margin-right: -0.5rem;
        }
        
        .row > [class*="col-"] {
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }
        
        /* Loading State */
        .loading-placeholder {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Table List Styles */
        .table-list-item {
            transition: all 0.2s ease;
        }
        
        .table-list-item:hover {
            border-color: #007bff !important;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.15) !important;
            transform: translateY(-1px);
        }
        
        .table-list-item.selected {
            border-color: #007bff !important;
            background-color: #f8f9ff !important;
        }
        
        .table-info h6 {
            color: #2c3e50;
        }
        
        .table-actions .btn {
            border-radius: 6px;
            padding: 6px 10px;
        }
        
        .table-actions .btn:hover {
            background-color: #007bff;
            border-color: #007bff;
            color: white;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .table-list-item {
                padding: 10px !important;
            }
            
            .table-info .d-flex {
                flex-direction: column;
                align-items: flex-start !important;
                gap: 4px !important;
            }
            
            .table-actions {
                margin-top: 8px;
            }
        }
    </style>
</head>

<body class="booking-page" th:with="activeNav='restaurants'">
    <div th:replace="~{fragments/resy-header :: resy-header}"></div>
    
    <main class="booking-main">
        <div class="container booking-shell">
            <div class="booking-panel">
                <div class="booking-alert-stack">
                    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="fas fa-exclamation-triangle luxury-icon"></i>
                        <span th:text="${errorMessage}"></span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                    <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="fas fa-check-circle luxury-icon"></i>
                        <span th:text="${successMessage}"></span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                </div>

                <nav class="booking-steps-nav" aria-label="Điều hướng nhanh">
                    <a href="#section-basic">
                        <span>1.</span> Thông tin chính
                    </a>
                    <a href="#section-tables">
                        <span>2.</span> Bàn &amp; món
                    </a>
                    <a href="#section-services">
                        <span>3.</span> Dịch vụ &amp; ưu đãi
                    </a>
                    <a href="#section-notes">
                        <span>4.</span> Ghi chú &amp; xác nhận
                    </a>
                </nav>

                <form th:action="${bookingId != null ? '/booking/' + bookingId + '/update' : '/booking'}"
                      method="post"
                      th:object="${bookingForm}"
                      id="bookingForm"
                      onsubmit="return validateForm()">

                    <div class="booking-form-grid">
                        <div class="booking-fields">
                            <!-- Restaurant Selection -->
                            <div class="mb-4 booking-section" id="section-basic">
                                <label for="restaurantId" class="form-label">
                                    <i class="fas fa-utensils luxury-icon"></i>
                                    Nhà hàng
                                    <span class="required-asterisk">*</span>
                                </label>
                                <select class="form-control"
                                        id="restaurantId"
                                        name="restaurantId"
                                        th:field="*{restaurantId}"
                                        th:classappend="${#fields.hasErrors('restaurantId')} ? 'is-invalid' : ''"
                                        onchange="loadTables()">
                                    <option value="">Chọn nhà hàng</option>
                                    <option th:each="restaurant : ${restaurants}"
                                            th:value="${restaurant.restaurantId}"
                                            th:text="${restaurant.restaurantName}"></option>
                                </select>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('restaurantId')}"
                                     th:errors="*{restaurantId}"></div>
                                <small class="booking-hint">
                                    Chọn nhà hàng để hiển thị bàn, thực đơn và dịch vụ phù hợp.
                                </small>

                                <div class="row g-4 mt-3">
                                    <div class="col-md-6">
                                        <label for="guestCount" class="form-label">
                                            <i class="fas fa-users luxury-icon"></i>
                                            Số lượng khách
                                            <span class="required-asterisk">*</span>
                                        </label>
                                        <input type="number"
                                               class="form-control"
                                               id="guestCount"
                                               name="guestCount"
                                               th:field="*{guestCount}"
                                               th:classappend="${#fields.hasErrors('guestCount')} ? 'is-invalid' : ''"
                                               min="1"
                                               max="12"
                                               placeholder="Ví dụ: 4">
                                        <div class="invalid-feedback" th:if="${#fields.hasErrors('guestCount')}"
                                             th:errors="*{guestCount}"></div>
                                        <small class="booking-hint">
                                            Dành cho tối đa 12 khách mỗi lần đặt. Chọn thêm bàn nếu cần nhiều hơn.
                                        </small>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="bookingTime" class="form-label">
                                            <i class="fas fa-clock luxury-icon"></i>
                                            Khung giờ
                                            <span class="required-asterisk">*</span>
                                        </label>
                                        <input type="datetime-local"
                                               class="form-control"
                                               id="bookingTime"
                                               name="bookingTime"
                                               th:field="*{bookingTime}"
                                               th:classappend="${#fields.hasErrors('bookingTime')} ? 'is-invalid' : ''">
                                        <div class="invalid-feedback" th:if="${#fields.hasErrors('bookingTime')}"
                                             th:errors="*{bookingTime}"></div>
                                        <small class="booking-hint">
                                            Nên đặt trước ít nhất 2 giờ để đảm bảo nhà hàng chuẩn bị chu đáo.
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- Table Selection -->
                            <div class="mb-4 booking-section" id="section-tables">
                                <label class="form-label d-flex align-items-center gap-2 mb-2">
                                    <i class="fas fa-chair luxury-icon"></i>
                                    Chọn bàn
                                    <span class="optional-label">(không bắt buộc)</span>
                                </label>
                                <div class="d-flex flex-wrap align-items-center gap-2">
                                    <button type="button"
                                            class="btn btn-outline-primary"
                                            id="viewTablesBtn"
                                            onclick="openTablePopup()"
                                            disabled>
                                        <i class="fas fa-eye"></i> Xem sơ đồ bàn
                                    </button>
                                    <span id="selectedTablesCount" class="text-muted small">Chưa chọn bàn</span>
                                </div>
                                <small class="booking-hint">
                                    Xem sơ đồ để chọn nhiều bàn phù hợp với nhóm của bạn.
                                </small>
                                <div id="selectedTablesSummary" class="mt-3" style="display: none;">
                                    <div class="alert alert-info">
                                        <h6><i class="fas fa-chair"></i> Bàn đã chọn</h6>
                                        <div id="selectedTablesList"></div>
                                    </div>
                                </div>
                                <input type="hidden" id="selectedTableId" name="tableId" th:value="${bookingForm.tableId}" />
                                <input type="hidden" id="selectedTableIds" name="tableIds" th:value="${bookingForm.tableIds}" />
                            </div>

                            <!-- Menu Selection -->
                            <div class="mb-4 booking-section" id="section-menu">
                                <label class="form-label d-flex align-items-center gap-2">
                                    <i class="fas fa-utensils luxury-icon"></i>
                                    Thực đơn gọi trước
                                    <span class="optional-label">(không bắt buộc)</span>
                                </label>
                                <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
                                    <button type="button"
                                            class="btn btn-outline-secondary"
                                            id="selectMenuBtn"
                                            onclick="openMenuPopup()">
                                        <i class="fas fa-utensils"></i> Chọn món ăn
                                    </button>
                                    <span id="selectedDishesCount" class="text-muted small">Chưa chọn món</span>
                                </div>
                                
                                <!-- Menu Items Display -->
                                <div id="menuItemsContainer" class="mt-3" style="display: none;">
                                    <div class="row" id="menuItemsList">
                                        <!-- Menu items will be loaded here -->
                                    </div>
                                </div>
                                <small class="booking-hint">
                                    Đặt món trước để giữ mức giá và giúp nhà hàng chuẩn bị nhanh chóng.
                                </small>
                                <div id="selectedDishesSummary" class="mt-3" style="display: none;">
                                    <div class="alert alert-info">
                                        <h6><i class="fas fa-utensils"></i> Món đã chọn</h6>
                                        <div id="selectedDishesList"></div>
                                    </div>
                                </div>
                                <input type="hidden" id="selectedDishIds" name="dishIds" th:value="${bookingForm.dishIds}" />
                            </div>

                            <!-- Services Selection -->
                            <div class="mb-4 booking-section" id="section-services">
                                <label class="form-label d-flex align-items-center gap-2">
                                    <i class="fas fa-concierge-bell luxury-icon"></i>
                                    Dịch vụ bổ sung
                                    <span class="optional-label">(không bắt buộc)</span>
                                </label>
                                <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
                                    <span id="selectedServicesCount" class="text-muted small">Chưa chọn dịch vụ</span>
                                </div>
                                
                                <!-- Services Display -->
                                <div id="servicesContainer" class="mt-3">
                                    <!-- Services will be injected by JavaScript -->
                                </div>
                                
                                <small class="booking-hint">
                                    Thêm các dịch vụ như trang trí, hoa hoặc yêu cầu hỗ trợ để nâng tầm trải nghiệm.
                                </small>
                                <input type="hidden" id="selectedServiceIds" name="serviceIds" th:value="${bookingForm.serviceIds}" />
                            </div>

                            <!-- Special Requests -->
                            <div class="mb-4 booking-section" id="section-notes">
                                <label for="note" class="form-label">
                                    <i class="fas fa-comment-dots luxury-icon"></i>
                                    Ghi chú đặc biệt
                                    <span class="optional-label">(tùy chọn)</span>
                                </label>
                                <textarea class="form-control"
                                          id="note"
                                          name="note"
                                          th:field="*{note}"
                                          th:classappend="${#fields.hasErrors('note')} ? 'is-invalid' : ''"
                                          rows="4"
                                          maxlength="500"
                                          placeholder="Ví dụ: Sinh nhật, không ăn hải sản, cần set up nến..."></textarea>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('note')}"
                                     th:errors="*{note}"></div>
                                <small class="booking-hint">
                                    Tối đa 500 ký tự. Thông tin của bạn sẽ được gửi trực tiếp đến nhà hàng.
                                </small>
                            </div>
                        </div>

                        <aside class="booking-sidebar">
                            <!-- Summary -->
                            <div class="booking-card booking-summary-card">
                                <span class="booking-summary-card__badge">
                                    <i class="fas fa-calculator"></i> Tổng quan
                                </span>
                                <h3>Chi phí đặt cọc</h3>
                                <div class="booking-summary-rows">
                                    <div class="booking-summary-row">
                                        <span>Đặt cọc bàn</span>
                                        <span id="tableDepositAmount">0 VNĐ</span>
                                    </div>
                                    <div class="booking-summary-row">
                                        <span>Món đã chọn</span>
                                        <span id="dishesTotalAmount">0 VNĐ</span>
                                    </div>
                                    <div class="booking-summary-row">
                                        <span>Dịch vụ bổ sung</span>
                                        <span id="servicesTotalAmount">0 VNĐ</span>
                                    </div>
                                    <div class="booking-summary-row" id="subtotalRow">
                                        <span>Tạm tính</span>
                                        <span id="subtotalAmount">0 VNĐ</span>
                                    </div>
                                    <div class="booking-summary-row" id="voucherDiscountRow" style="display: none;">
                                        <span><i class="fas fa-ticket-alt"></i> Ưu đãi voucher</span>
                                        <span id="voucherDiscountDisplay">-0 VNĐ</span>
                                    </div>
                                </div>
                                <div class="booking-summary-card__total">
                                    <span>Tổng đặt cọc</span>
                                    <span id="totalDepositAmount">0 VNĐ</span>
                                </div>
                                <p class="booking-summary-card__note">
                                    <i class="fas fa-info-circle"></i>
                                    Số tiền này sẽ được tạm giữ để đảm bảo chỗ ngồi của bạn.
                                </p>
                                <input type="hidden"
                                       id="depositAmount"
                                       name="depositAmount"
                                       th:field="*{depositAmount}">
                            </div>

                            <!-- Voucher -->
                            <div class="booking-card booking-voucher-card">
                                <h4 class="h6 d-flex align-items-center gap-2 mb-3">
                                    <i class="fas fa-ticket-alt luxury-icon"></i>
                                    Voucher
                                    <span class="optional-label">(không bắt buộc)</span>
                                </h4>
                                <div class="input-group">
                                    <select class="form-control" id="voucherSelect" name="voucherCode">
                                        <option value="">Chọn voucher của bạn</option>
                                    </select>
                                    <button type="button"
                                            class="btn btn-outline-primary"
                                            id="validateVoucherBtn"
                                            onclick="validateSelectedVoucher()">
                                        <i class="fas fa-check"></i> Áp dụng
                                    </button>
                                </div>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('voucherCode')}"
                                     th:errors="*{voucherCode}"></div>
                                <div id="voucherResult" class="mt-2" style="display: none;">
                                    <div id="voucherSuccess" class="alert alert-success" style="display: none;">
                                        <i class="fas fa-check-circle"></i>
                                        <span id="voucherSuccessText"></span>
                                    </div>
                                    <div id="voucherError" class="alert alert-danger" style="display: none;">
                                        <i class="fas fa-exclamation-circle"></i>
                                        <span id="voucherErrorText"></span>
                                    </div>
                                </div>
                                <small class="booking-hint">
                                    Áp dụng voucher để được trừ trực tiếp vào số tiền đặt cọc.
                                </small>
                                <input type="hidden" id="voucherDiscountAmount" name="voucherDiscountAmount" value="0">
                                <input type="hidden" id="voucherCodeApplied" name="voucherCodeApplied" value="">
                            </div>

                            <!-- Tips -->
                            <div class="booking-tip-card">
                                <h6><i class="fas fa-lightbulb"></i> Gợi ý nhanh</h6>
                                <ul>
                                    <li>Chọn nhiều bàn để ghép nhóm lớn hoặc không gian riêng tư.</li>
                                    <li>Đặt trước món signature để giữ mức giá ưu đãi.</li>
                                    <li>Nhập ghi chú chi tiết để nhà hàng chuẩn bị chính xác.</li>
                                </ul>
                            </div>
                        </aside>
                    </div>

                    <div class="booking-submit">
                        <button type="submit" class="btn-resy">
                            <i class="fas fa-check-circle"></i>
                            <span th:text="${bookingId != null ? 'Cập nhật đặt bàn' : 'Xác nhận đặt bàn'}"></span>
                        </button>
                        <a th:href="@{/booking/my}" class="btn-resy-outline">
                            <i class="fas fa-arrow-left"></i>
                            Quay lại đặt bàn của tôi
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </main>
    
    <!-- Table Selection Modal -->
    <div class="modal fade" id="tableModal" tabindex="-1" aria-labelledby="tableModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tableModalLabel">
                        <i class="fas fa-chair"></i> Chọn bàn
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- View Toggle Buttons -->
                    <div class="row mb-4" id="tableLayoutToggle" style="display: none;">
                        <div class="col-12">
                            <div class="btn-group w-100" role="group" aria-label="View toggle">
                                <button type="button" class="btn btn-outline-info btn-lg active" 
                                        id="layoutViewBtn" onclick="switchToLayoutView()">
                                    <i class="fas fa-map me-2"></i>
                                    Sơ đồ bàn ăn
                                </button>
                                <button type="button" class="btn btn-outline-success btn-lg" 
                                        id="tablesViewBtn" onclick="switchToTablesView()">
                                    <i class="fas fa-chair me-2"></i>
                                    Danh sách bàn
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Layout View -->
                    <div id="layoutView" class="view-content" style="display: none;">
                        <div id="tableLayoutCarousel" class="carousel slide" data-bs-ride="carousel">
                            <div class="carousel-indicators" id="tableLayoutIndicators">
                                <!-- Indicators will be generated by JavaScript -->
                            </div>
                            
                            <div class="carousel-inner" id="tableLayoutInner">
                                <!-- Carousel items will be generated by JavaScript -->
                            </div>
                            
                            <button class="carousel-control-prev" type="button" data-bs-target="#tableLayoutCarousel" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Trước</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#tableLayoutCarousel" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Sau</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Tables View -->
                    <div id="tablesView" class="view-content">
                        <!-- Tables Search -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-search"></i>
                                    </span>
                                    <input type="text" class="form-control" id="tablesSearchInput" 
                                           placeholder="Tìm kiếm bàn ăn..." onkeyup="searchTables()">
                                    <button class="btn btn-outline-secondary" type="button" onclick="clearTablesSearch()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="tablesList" class="row">
                            <!-- Tables will be loaded here -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Huỷ</button>
                    <button type="button" class="btn btn-primary" onclick="confirmTableSelection()">Xác nhận</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Menu Selection Modal -->
    <div class="modal fade" id="menuModal" tabindex="-1" aria-labelledby="menuModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="menuModalLabel">
                        <i class="fas fa-utensils"></i> Chọn món ăn
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Menu Search -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control" id="menuSearchInput" 
                                       placeholder="Tìm kiếm món ăn..." onkeyup="searchMenu()">
                                <button class="btn btn-outline-secondary" type="button" onclick="clearMenuSearch()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Menu Pagination -->
                    <div id="menuPagination" class="d-flex justify-content-center mb-4">
                        <nav aria-label="Menu pagination">
                            <ul class="pagination" id="menuPaginationList">
                                <!-- Pagination items will be generated by JavaScript -->
                            </ul>
                        </nav>
                    </div>
                    
                    <div id="menuList" class="row">
                        <!-- Menu items will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Huỷ</button>
                    <button type="button" class="btn btn-primary" onclick="confirmMenuSelection()">Xác nhận</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Table Images Modal -->
    <div class="modal fade" id="tableImagesModal" tabindex="-1" aria-labelledby="tableImagesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tableImagesModalLabel">
                        <i class="fas fa-images me-2"></i>
                        Hình ảnh bàn
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Table Images Carousel -->
                    <div id="tableImagesCarousel" class="carousel slide" data-bs-ride="carousel">
                        <div class="carousel-indicators" id="tableImagesIndicators">
                            <!-- Indicators will be generated by JavaScript -->
                        </div>
                        
                        <div class="carousel-inner" id="tableImagesInner">
                            <!-- Carousel items will be generated by JavaScript -->
                        </div>
                        
                        <button class="carousel-control-prev" type="button" data-bs-target="#tableImagesCarousel" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Trước</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#tableImagesCarousel" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Sau</span>
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Smart Waitlist Modal -->
    <div class="modal fade" id="smartWaitlistModal" tabindex="-1" aria-labelledby="smartWaitlistModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="smartWaitlistModalLabel">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span id="popupTitle">Không thể giữ bàn ngay</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Dynamic content based on conflict type -->
                    <div id="conflictContent">
                        <!-- Will be populated by JavaScript -->
                    </div>
                    
                    <!-- Waitlist Information -->
                    <div class="waitlist-info bg-light p-3 rounded mt-3">
                        <h6><i class="fas fa-clock text-warning"></i> Thông tin danh sách chờ:</h6>
                        <p><strong>Thời gian có thể đặt bàn:</strong> <span id="waitTime"></span></p>
                        <p><strong>Nguyên nhân:</strong> <span id="waitReason"></span></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Huỷ
                    </button>
                    <button type="button" class="btn btn-warning" onclick="joinSmartWaitlist()">
                        <i class="fas fa-clock"></i> Tham gia danh sách chờ
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div th:replace="~{fragments/resy-footer :: resy-footer}"></div>
    <div th:replace="~{fragments/resy-scripts :: resy-scripts}"></div>
    <script th:src="@{/js/main.js}" defer></script>
    
    <script>
        // Global variables to store selections
        let selectedTables = [];
        let selectedDishes = [];
        let selectedServices = [];
        let availableTables = [];
        let availableDishes = [];
        let availableServices = [];
        let voucherDiscount = 0; // Store voucher discount amount
        let availableVouchers = []; // Store available vouchers
        let tableLayouts = []; // Store table layouts
        let filteredTables = []; // For search functionality
        let filteredDishes = []; // For search functionality
        let currentMenuPage = 1;
        const itemsPerPage = 6;
        let tablesLoaded = false;
        let tablesLoading = false;
        

        function extractTableId(table) {
            if (!table) {
                return '';
            }
            if (table.id !== undefined && table.id !== null && table.id !== '') {
                return String(table.id);
            }
            if (table.tableId !== undefined && table.tableId !== null && table.tableId !== '') {
                return String(table.tableId);
            }
            return '';
        }

        function updateSelectedTableIds() {
            const multipleTablesInput = document.getElementById('selectedTableIds');
            const singleTableInput = document.getElementById('selectedTableId');
            const ids = selectedTables
                .map(extractTableId)
                .filter(id => id !== '');

            if (multipleTablesInput) {
                multipleTablesInput.value = ids.join(',');
            }

            if (singleTableInput) {
                singleTableInput.value = ids.length === 1 ? ids[0] : '';
            }
        }

        // Debug function to log all selections
        function logAllSelections() {
        }

        function loadTables() {
            tablesLoading = true;
            tablesLoaded = false;
            const restaurantId = document.getElementById('restaurantId').value;
            const viewTablesBtn = document.getElementById('viewTablesBtn');
            
            logAllSelections();
            
            if (restaurantId) {
                viewTablesBtn.disabled = false;
                return fetch(`/api/booking/restaurants/${restaurantId}/tables`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(tables => {
                        availableTables = tables;
                        logAllSelections();
                        
                        // Load table layouts
                        return fetch(`/api/booking/restaurants/${restaurantId}/table-layouts`)
                            .then(response => {
                                if (response.ok) {
                                    return response.json();
                                }
                                return [];
                            })
                            .then(layouts => {
                                tableLayouts = layouts;
                                return tables;
                            })
                            .catch(error => {
                                tableLayouts = [];
                                return tables;
                            });
                    })
                    .then(tables => {
                        tablesLoaded = true;
                        tablesLoading = false;
                        if (tables.length === 0) {
                        } else {
                            renderTablesInModal(tables);
                        }
                        
                        return Promise.all([
                            loadDishes(restaurantId),
                            loadServices(restaurantId)
                        ]).then(() => {
                            return tables;
                        });
                    })
                    .catch(error => {
                        availableTables = [];
                        tablesLoaded = true;
                        tablesLoading = false;
                        return Promise.all([
                            loadDishes(restaurantId),
                            loadServices(restaurantId)
                        ]).then(() => {
                            return []; // Return empty array on error
                        }).catch(() => {
                            return []; // Return empty array on error
                        });
                    });
            } else {
                viewTablesBtn.disabled = true;
                tablesLoaded = false;
                availableTables = [];
                filteredTables = [];
                tablesLoading = false;
                const viewMenuBtn = document.getElementById('viewMenuBtn');
                viewMenuBtn.innerHTML = '<i class="fas fa-eye"></i> Xem menu';
                viewMenuBtn.disabled = true;
                updateTotalAmount();
                return Promise.resolve([]); // Return resolved promise with empty array
            }
        }

        // Toggle Table Selection
        function toggleTableSelection(tableId) {
            const checkbox = document.getElementById(`table-${tableId}`);
            if (!checkbox) return;
            
            // Toggle checkbox
            checkbox.checked = !checkbox.checked;
            
            // Update visual selection
            const tableItem = checkbox.closest('.table-list-item');
            if (checkbox.checked) {
                tableItem.classList.add('selected');
            } else {
                tableItem.classList.remove('selected');
            }
            
            // Update selected tables array
            if (checkbox.checked) {
                if (!selectedTables.find(t => t.tableId === tableId)) {
                    const table = availableTables.find(t => t.tableId === tableId);
                    if (table) {
                        selectedTables.push(table);
                    }
                }
            } else {
                selectedTables = selectedTables.filter(t => t.tableId !== tableId);
            }
            
            // Update hidden input
            updateSelectedTableIds();
            
            // Update total amount
            updateTotalAmount();
            
        }

        // Show Table Images Modal
        function showTableImages(tableId) {
            const table = availableTables.find(t => t.tableId === tableId);
            if (!table) return;
            
            const tableImages = table.images || [];
            if (tableImages.length === 0) {
                alert('Bàn này chưa có hình ảnh');
                return;
            }
            
            // Update modal title
            const modalTitle = document.getElementById('tableImagesModalLabel');
            modalTitle.innerHTML = `<i class="fas fa-images me-2"></i>Hình ảnh bàn ${table.tableName}`;
            
            // Render carousel indicators
            const indicators = document.getElementById('tableImagesIndicators');
            indicators.innerHTML = '';
            tableImages.forEach((image, index) => {
                const button = document.createElement('button');
                button.type = 'button';
                button.setAttribute('data-bs-target', '#tableImagesCarousel');
                button.setAttribute('data-bs-slide-to', index);
                button.setAttribute('aria-label', `Slide ${index + 1}`);
                if (index === 0) {
                    button.className = 'active';
                    button.setAttribute('aria-current', 'true');
                }
                indicators.appendChild(button);
            });
            
            // Render carousel items
            const carouselInner = document.getElementById('tableImagesInner');
            carouselInner.innerHTML = '';
            tableImages.forEach((image, index) => {
                const item = document.createElement('div');
                item.className = `carousel-item ${index === 0 ? 'active' : ''}`;
                item.innerHTML = `
                    <img src="${image.url}" class="d-block w-100 carousel-image" alt="Bàn ${table.tableName} - Ảnh ${index + 1}">
                    <div class="carousel-caption d-none d-md-block">
                        <h5>Bàn ${table.tableName}</h5>
                        <p>Ảnh ${index + 1}/${tableImages.length}</p>
                    </div>
                `;
                carouselInner.appendChild(item);
            });
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('tableImagesModal'));
            modal.show();
        }

        function renderTablesInModal(tables) {
            const tablesList = document.getElementById('tablesList');
            tablesList.innerHTML = '';
            
            // Update filtered tables
            filteredTables = tables;
            
            tables.forEach(table => {
                const statusValue = getTableStatusValue(table.status);
                const statusClass = getStatusBadgeClass(table.status);
                const statusText = getStatusDisplayName(table.status);
                
                const tableItem = document.createElement('div');
                tableItem.className = 'col-12 mb-2';
                tableItem.innerHTML = `
                    <div class="table-list-item" data-table-id="${table.tableId}" data-deposit="${table.depositAmount || 0}" 
                         onclick="toggleTableSelection(${table.tableId})" 
                         style="cursor: pointer; border: 1px solid #dee2e6; border-radius: 8px; padding: 12px; background: white; transition: all 0.2s ease; hover:border-color: #007bff; hover:box-shadow: 0 2px 4px rgba(0,123,255,0.1);">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center flex-grow-1">
                                <div class="form-check me-3">
                                    <input class="form-check-input table-checkbox" 
                                           type="checkbox" 
                                           value="${table.tableId}"
                                           id="table-${table.tableId}"
                                           onclick="event.stopPropagation(); toggleTableSelection(${table.tableId})">
                                </div>
                                
                                <div class="table-info flex-grow-1">
                                    <div class="d-flex align-items-center gap-2 mb-1">
                                        <h6 class="mb-0 fw-bold">${table.tableName}</h6>
                                        <span class="badge ${statusClass}">${statusText}</span>
                                    </div>
                                    <div class="d-flex align-items-center gap-3 text-muted small">
                                        <span><i class="fas fa-users me-1"></i>${table.capacity} khách</span>
                                        <span><i class="fas fa-money-bill-wave me-1"></i>${formatCurrency(table.depositAmount || 0)}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="table-actions">
                                <button type="button" class="btn btn-sm btn-outline-secondary" 
                                        onclick="event.stopPropagation(); showTableImages(${table.tableId})" 
                                        title="Xem ảnh bàn">
                                    <i class="fas fa-images"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                tablesList.appendChild(tableItem);
            });
            
        }

        function loadDishes(restaurantId) {
            return fetch(`/api/booking/restaurants/${restaurantId}/dishes`)
                .then(response => response.json())
                .then(dishes => {
                    
                    // Load dish images
                    const dishesWithImages = dishes.map(dish => {
                        return {
                            ...dish,
                            imageUrl: dish.imageUrl || `data:image/svg+xml;base64,${btoa(`
                                <svg width="300" height="200" xmlns="http://www.w3.org/2000/svg">
                                    <rect width="300" height="200" fill="#f8f9fa"/>
                                    <text x="150" y="100" text-anchor="middle" font-family="Arial" font-size="14" fill="#6c757d">
                                        ${dish.name || 'No Image'}
                                    </text>
                                </svg>
                            `)}`
                        };
                    });
                    
                    availableDishes = dishesWithImages;
                    
                    // Display menu items directly
                    const menuItemsContainer = document.getElementById('menuItemsContainer');
                    const menuItemsList = document.getElementById('menuItemsList');
                    
                    if (dishes.length === 0) {
                        menuItemsContainer.style.display = 'none';
                    } else {
                        menuItemsContainer.style.display = 'block';
                        menuItemsList.innerHTML = '';
                        
                        // Add loading state
                        menuItemsList.innerHTML = '<div class="col-12 text-center"><div class="loading-placeholder" style="height: 200px; border-radius: 12px;"></div></div>';
                        
                        // Simulate loading delay for better UX
                        setTimeout(() => {
                            menuItemsList.innerHTML = '';
                            dishes.forEach(dish => {
                                const dishCard = createDishCard(dish);
                                menuItemsList.appendChild(dishCard);
                            });
                        }, 300);
                    }
                })
                .catch(error => {
                    const menuItemsContainer = document.getElementById('menuItemsContainer');
                    menuItemsContainer.style.display = 'none';
                });
        }

        function loadServices(restaurantId) {
            
            return fetch(`/api/booking/restaurants/${restaurantId}/services`)
                .then(response => {
                    return response.json();
                })
                .then(services => {
                    
                    // Store services in global variable
                    availableServices = services;
                    
                    const servicesContainer = document.getElementById('servicesContainer');
                    servicesContainer.innerHTML = '';
                    
                    // Always show services section for debugging
                    document.getElementById('section-services').style.display = 'block';
                    
                    if (services.length === 0) {
                        servicesContainer.innerHTML = `
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-concierge-bell fa-2x mb-2"></i>
                                <p>No additional services available for this restaurant.</p>
                            </div>
                        `;
                        return;
                    }
                    
                    // Add loading state
                    servicesContainer.innerHTML = '<div class="row"><div class="col-12 text-center"><div class="loading-placeholder" style="height: 150px; border-radius: 12px;"></div></div></div>';
                    
                    // Simulate loading delay for better UX
                    setTimeout(() => {
                        // Create row container for services
                        const servicesRow = document.createElement('div');
                        servicesRow.className = 'row';
                        
                        services.forEach(service => {
                            const serviceCard = createServiceCard(service);
                            servicesRow.appendChild(serviceCard);
                        });
                        
                        servicesContainer.innerHTML = '';
                        servicesContainer.appendChild(servicesRow);
                    }, 300);
                    
                })
                .catch(error => {
                    // Still show services section even on error
                    document.getElementById('section-services').style.display = 'block';
                    const servicesContainer = document.getElementById('servicesContainer');
                    servicesContainer.innerHTML = `
                        <div class="text-center text-danger py-4">
                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <p>Không thể tải dịch vụ, vui lòng thử lại.</p>
                        </div>
                    `;
                });
        }

        function createServiceCard(service) {
            const col = document.createElement('div');
            col.className = 'col-12 mb-2';
            col.dataset.serviceId = service.serviceId;
            col.dataset.price = service.price || 0;
            
            // Service icon mapping
            const iconMap = {
                'WIFI': 'fas fa-wifi',
                'PARKING': 'fas fa-parking',
                'VALET': 'fas fa-car',
                'LIVE_MUSIC': 'fas fa-music',
                'PRIVATE_ROOM': 'fas fa-door-open',
                'OUTDOOR_SEATING': 'fas fa-tree',
                'BAR': 'fas fa-cocktail',
                'KIDS_MENU': 'fas fa-child',
                'DELIVERY': 'fas fa-truck',
                'TAKEAWAY': 'fas fa-shopping-bag'
            };
            
            const iconClass = iconMap[service.name] || 'fas fa-concierge-bell';
            const price = new Intl.NumberFormat('vi-VN').format(service.price || 0) + ' VNĐ';
            
            col.innerHTML = `
                <div class="card service-card" data-service-id="${service.serviceId}" data-price="${service.price || 0}">
                    <div class="card-body p-3">
                        <div class="row align-items-center">
                            <div class="col-4">
                                <h6 class="service-name mb-1">${service.name}</h6>
                            </div>
                            <div class="col-4">
                                <p class="service-description small text-muted mb-0">${service.description || 'Enhance your dining experience'}</p>
                            </div>
                            <div class="col-4">
                                <span class="service-price text-danger fw-bold">${price}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add click event listener
            col.addEventListener('click', function(e) {
                toggleServiceSelectionByCard(col);
            });
            
            return col;
        }

        function toggleServiceSelection(card) {
            
            const isSelected = card.classList.contains('selected');
            const serviceId = card.dataset.serviceId;
            const serviceName = card.querySelector('.service-name').textContent;
            const servicePrice = parseFloat(card.dataset.price) || 0;
            
            
            if (isSelected) {
                // Remove from selectedServices array
                card.classList.remove('selected');
                selectedServices = selectedServices.filter(s => s.id !== serviceId);
            } else {
                // Add to selectedServices array
                card.classList.add('selected');
                selectedServices.push({
                    id: serviceId,
                    name: serviceName,
                    price: servicePrice
                });
            }
            
            
            updateServiceSelectionUI();
            updateTotalAmount();
            saveFormState();
        }

        function toggleServiceSelectionByCard(card) {
            const serviceId = card.dataset.serviceId;
            const serviceCard = card.querySelector('.service-card');
            const serviceName = serviceCard.querySelector('.service-name').textContent;
            const servicePrice = parseFloat(serviceCard.dataset.price) || 0;
            
            // Check if service is already selected
            const existingIndex = selectedServices.findIndex(s => s.id === serviceId);
            
            if (existingIndex === -1) {
                // Add to selectedServices array
                selectedServices.push({
                    id: serviceId,
                    name: serviceName,
                    price: servicePrice
                });
                serviceCard.classList.add('selected');
            } else {
                // Remove from selectedServices array
                selectedServices = selectedServices.filter(s => s.id !== serviceId);
                serviceCard.classList.remove('selected');
            }
            
            updateServiceSelectionUI();
            updateTotalAmount();
            saveFormState();
        }

        function getSelectedServices() {
            const selectedCards = document.querySelectorAll('.service-card.selected');
            return Array.from(selectedCards).map(card => ({
                id: card.dataset.serviceId,
                price: parseFloat(card.dataset.price) || 0
            }));
        }

        // Search and Carousel Functions
        function searchTables() {
            const searchTerm = document.getElementById('tablesSearchInput').value.toLowerCase();
            filteredTables = availableTables.filter(table => 
                table.tableName.toLowerCase().includes(searchTerm) ||
                table.capacity.toString().includes(searchTerm) ||
                table.status.toLowerCase().includes(searchTerm)
            );
            renderTablesInModal(filteredTables);
        }
        
        function clearTablesSearch() {
            document.getElementById('tablesSearchInput').value = '';
            filteredTables = availableTables;
            renderTablesInModal(filteredTables);
        }
        
        function searchMenu() {
            const searchTerm = document.getElementById('menuSearchInput').value.toLowerCase();
            filteredDishes = availableDishes.filter(dish => 
                dish.name.toLowerCase().includes(searchTerm) ||
                dish.description.toLowerCase().includes(searchTerm) ||
                dish.category.toLowerCase().includes(searchTerm)
            );
            currentMenuPage = 1;
            renderMenuPage(1);
        }
        
        function clearMenuSearch() {
            document.getElementById('menuSearchInput').value = '';
            filteredDishes = availableDishes;
            currentMenuPage = 1;
            renderMenuPage(1);
        }
        
        function switchToLayoutView() {
            document.getElementById('layoutViewBtn').classList.add('active');
            document.getElementById('tablesViewBtn').classList.remove('active');
            document.getElementById('layoutView').style.display = 'block';
            document.getElementById('tablesView').style.display = 'none';
            
            if (tableLayouts.length > 0 && document.getElementById('tableLayoutInner').children.length === 0) {
                showTableLayout();
            }
        }
        
        function switchToTablesView() {
            document.getElementById('layoutViewBtn').classList.remove('active');
            document.getElementById('tablesViewBtn').classList.add('active');
            document.getElementById('layoutView').style.display = 'none';
            document.getElementById('tablesView').style.display = 'block';
            
            if (document.getElementById('tablesList').children.length === 0) {
                renderTablesInModal(filteredTables);
            }
        }
        
        function showTableLayout() {
            if (tableLayouts.length === 0) {
                alert('Nhà hàng này chưa có sơ đồ bàn ăn');
                return;
            }
            
            const indicators = document.getElementById('tableLayoutIndicators');
            indicators.innerHTML = '';
            tableLayouts.forEach((layout, index) => {
                const button = document.createElement('button');
                button.type = 'button';
                button.setAttribute('data-bs-target', '#tableLayoutCarousel');
                button.setAttribute('data-bs-slide-to', index);
                button.setAttribute('aria-label', `Layout ${index + 1}`);
                if (index === 0) {
                    button.className = 'active';
                    button.setAttribute('aria-current', 'true');
                }
                indicators.appendChild(button);
            });
            
            const carouselInner = document.getElementById('tableLayoutInner');
            carouselInner.innerHTML = '';
            tableLayouts.forEach((layout, index) => {
                const item = document.createElement('div');
                item.className = `carousel-item ${index === 0 ? 'active' : ''}`;
                item.innerHTML = `
                    <img src="${layout.url}" class="d-block w-100 carousel-image" alt="Sơ đồ bàn ăn ${index + 1}" style="max-height: 70vh; object-fit: contain;">
                    <div class="carousel-caption d-none d-md-block">
                        <h5>Sơ đồ bàn ăn</h5>
                        <p>Layout ${index + 1}/${tableLayouts.length}</p>
                    </div>
                `;
                carouselInner.appendChild(item);
            });
        }
        
        function renderMenuPage(page) {
            currentMenuPage = page;
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageDishes = filteredDishes.slice(startIndex, endIndex);
            
            const menuList = document.getElementById('menuList');
            if (menuList) {
                menuList.innerHTML = '';
                pageDishes.forEach(dish => {
                    const dishCard = createDishCard(dish);
                    menuList.appendChild(dishCard);
                });
            }
            renderMenuPagination();
        }
        
        function renderMenuPagination() {
            const totalPages = Math.ceil(filteredDishes.length / itemsPerPage);
            const paginationList = document.getElementById('menuPaginationList');
            
            if (paginationList && totalPages > 1) {
                paginationList.innerHTML = '';
                
                const prevLi = document.createElement('li');
                prevLi.className = `page-item ${currentMenuPage === 1 ? 'disabled' : ''}`;
                prevLi.innerHTML = `<a class="page-link" href="#" onclick="renderMenuPage(${currentMenuPage - 1}); return false;">Trước</a>`;
                paginationList.appendChild(prevLi);
                
                for (let i = 1; i <= totalPages; i++) {
                    const li = document.createElement('li');
                    li.className = `page-item ${i === currentMenuPage ? 'active' : ''}`;
                    li.innerHTML = `<a class="page-link" href="#" onclick="renderMenuPage(${i}); return false;">${i}</a>`;
                    paginationList.appendChild(li);
                }
                
                const nextLi = document.createElement('li');
                nextLi.className = `page-item ${currentMenuPage === totalPages ? 'disabled' : ''}`;
                nextLi.innerHTML = `<a class="page-link" href="#" onclick="renderMenuPage(${currentMenuPage + 1}); return false;">Sau</a>`;
                paginationList.appendChild(nextLi);
            }
        }
        
        function createDishCard(dish) {
            const col = document.createElement('div');
            col.className = 'col-12 mb-2';
            
            const price = new Intl.NumberFormat('vi-VN').format(dish.price) + ' VNĐ';
            const imageUrl = dish.imageUrl || `data:image/svg+xml;base64,${btoa(`
                <svg width="80" height="80" xmlns="http://www.w3.org/2000/svg">
                    <rect width="80" height="80" fill="#f8f9fa"/>
                    <text x="40" y="40" text-anchor="middle" font-family="Arial" font-size="12" fill="#6c757d">
                        ${dish.name || 'No Image'}
                    </text>
                </svg>
            `)}`;
            
            col.innerHTML = `
                <div class="card dish-card" data-dish-id="${dish.dishId}" data-price="${dish.price}">
                    <div class="card-body p-3">
                        <div class="row align-items-center">
                            <div class="col-2">
                                <img src="${imageUrl}" class="dish-image" alt="${dish.name}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;">
                            </div>
                            <div class="col-3">
                                <h6 class="dish-name mb-1">${dish.name}</h6>
                                <small class="text-muted dish-category">${dish.category || 'Khác'}</small>
                            </div>
                            <div class="col-4">
                                <p class="dish-description mb-1 small">${dish.description || 'Không có mô tả'}</p>
                                <span class="dish-price text-danger fw-bold">${price}</span>
                            </div>
                            <div class="col-3">
                                <div class="input-group input-group-sm">
                                    <button class="btn btn-outline-secondary btn-sm quantity-btn" type="button" onclick="decreaseQuantity(${dish.dishId})">-</button>
                                    <input type="number" class="form-control text-center quantity-input" value="1" min="1" max="99" id="quantity-${dish.dishId}" onchange="updateDishQuantity(${dish.dishId})">
                                    <button class="btn btn-outline-secondary btn-sm quantity-btn" type="button" onclick="increaseQuantity(${dish.dishId})">+</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add click event listener for card to toggle selection
            col.addEventListener('click', function(e) {
                if (!e.target.closest('.input-group')) {
                    toggleDishSelectionByCard(col);
                }
            });
            
            // Add event listener for quantity input changes
            const quantityInput = col.querySelector('.quantity-input');
            if (quantityInput) {
                quantityInput.addEventListener('input', function() {
                    updateDishQuantity(dishId);
                });
            }
            
            return col;
        }

        function toggleDishSelection(checkbox) {
            const dishId = checkbox.value;
            const dishCard = checkbox.closest('.dish-card');
            const dishName = dishCard.querySelector('.dish-name').textContent;
            const dishPrice = parseFloat(dishCard.dataset.price) || 0;
            const quantity = parseInt(dishCard.querySelector('.quantity-input').value) || 1;
            
            if (checkbox.checked) {
                // Add to selectedDishes array
                selectedDishes.push({
                    id: dishId,
                    name: dishName,
                    price: dishPrice,
                    quantity: quantity
                });
                dishCard.classList.add('selected');
            } else {
                // Remove from selectedDishes array
                selectedDishes = selectedDishes.filter(d => d.id !== dishId);
                dishCard.classList.remove('selected');
            }
            
            updateDishSelectionUI();
            updateTotalAmount();
            saveFormState();
        }

        function toggleDishSelectionByCard(card) {
            const dishCard = card.querySelector('.dish-card');
            const dishId = dishCard.dataset.dishId;
            const dishName = dishCard.querySelector('.dish-name').textContent;
            const dishPrice = parseFloat(dishCard.dataset.price) || 0;
            const quantity = parseInt(dishCard.querySelector('.quantity-input').value) || 1;
            
            // Check if dish is already selected using classList like service
            const isSelected = dishCard.classList.contains('selected');
            
            
            if (!isSelected) {
                // Add to selectedDishes array
                selectedDishes.push({
                    id: dishId,
                    name: dishName,
                    price: dishPrice,
                    quantity: quantity
                });
                dishCard.classList.add('selected');
            } else {
                // Remove from selectedDishes array - ensure proper comparison
                const beforeLength = selectedDishes.length;
                
                selectedDishes = selectedDishes.filter(d => {
                    const shouldKeep = String(d.id) !== String(dishId);
                    return shouldKeep;
                });
                
                const afterLength = selectedDishes.length;
                dishCard.classList.remove('selected');
            }
            
            
            updateDishSelectionUI();
            updateTotalAmount();
            saveFormState();
        }

        function increaseQuantity(dishId) {
            const quantityInput = document.getElementById(`quantity-${dishId}`);
            const currentValue = parseInt(quantityInput.value) || 1;
            if (currentValue < 99) {
                quantityInput.value = currentValue + 1;
                // Check if dish is selected and update quantity
                const dishCard = quantityInput.closest('.dish-card');
                if (dishCard && dishCard.classList.contains('selected')) {
                    const actualDishId = dishCard.dataset.dishId;
                    const dishIndex = selectedDishes.findIndex(d => String(d.id) === String(actualDishId));
                    if (dishIndex !== -1) {
                        selectedDishes[dishIndex].quantity = currentValue + 1;
                        updateDishSelectionUI();
                        updateTotalAmount();
                        saveFormState();
                    }
                }
            }
        }

        function decreaseQuantity(dishId) {
            const quantityInput = document.getElementById(`quantity-${dishId}`);
            const currentValue = parseInt(quantityInput.value) || 1;
            if (currentValue > 1) {
                quantityInput.value = currentValue - 1;
                // Check if dish is selected and update quantity
                const dishCard = quantityInput.closest('.dish-card');
                if (dishCard && dishCard.classList.contains('selected')) {
                    const actualDishId = dishCard.dataset.dishId;
                    const dishIndex = selectedDishes.findIndex(d => String(d.id) === String(actualDishId));
                    if (dishIndex !== -1) {
                        selectedDishes[dishIndex].quantity = currentValue - 1;
                        updateDishSelectionUI();
                        updateTotalAmount();
                        saveFormState();
                    }
                }
            }
        }

        function updateDishQuantity(dishId) {
            const quantityInput = document.getElementById(`quantity-${dishId}`);
            const quantity = parseInt(quantityInput.value) || 1;
            
            // Validate quantity range
            if (quantity < 1) {
                quantityInput.value = 1;
                return;
            }
            if (quantity > 99) {
                quantityInput.value = 99;
                return;
            }
            
            // Check if dish is selected and update quantity
            const dishCard = quantityInput.closest('.dish-card');
            if (dishCard && dishCard.classList.contains('selected')) {
                const actualDishId = dishCard.dataset.dishId;
                const dishIndex = selectedDishes.findIndex(d => String(d.id) === String(actualDishId));
                if (dishIndex !== -1) {
                    selectedDishes[dishIndex].quantity = quantity;
                    updateDishSelectionUI();
                    updateTotalAmount();
                    saveFormState();
                }
            }
        }

        function updateDishSelectionUI() {
            
            const selectedDishesCount = document.getElementById('selectedDishesCount');
            const selectedDishesSummary = document.getElementById('selectedDishesSummary');
            const selectedDishesList = document.getElementById('selectedDishesList');
            const selectedDishIds = document.getElementById('selectedDishIds');
            
            if (selectedDishes.length > 0) {
                const totalQuantity = selectedDishes.reduce((sum, dish) => sum + (dish.quantity || 1), 0);
                selectedDishesCount.textContent = `Đã chọn ${selectedDishes.length} món (${totalQuantity} phần)`;
                selectedDishesSummary.style.display = 'block';
                
                selectedDishesList.innerHTML = selectedDishes.map(dish => {
                    const quantity = dish.quantity || 1;
                    const totalPrice = dish.price * quantity;
                    return `<div class="d-flex justify-content-between align-items-center mb-1">
                        <span>${dish.name} x${quantity}</span>
                        <span class="text-primary">${formatCurrency(totalPrice)}</span>
                    </div>`;
                }).join('');
                
                selectedDishIds.value = selectedDishes.map(d => d.id).join(',');
            } else {
                selectedDishesCount.textContent = 'Chưa chọn món';
                selectedDishesSummary.style.display = 'none';
                selectedDishIds.value = '';
            }
        }

        function syncDishSelectionState() {
            // Sync the selected state of dish cards with selectedDishes array
            document.querySelectorAll('.dish-card').forEach(card => {
                const dishId = card.dataset.dishId;
                const isInArray = selectedDishes.some(d => d.id === dishId);
                const hasSelectedClass = card.classList.contains('selected');
                
                if (isInArray && !hasSelectedClass) {
                    card.classList.add('selected');
                } else if (!isInArray && hasSelectedClass) {
                    card.classList.remove('selected');
                }
            });
        }

        function updateServiceSelectionUI() {
            const selectedServicesCount = document.getElementById('selectedServicesCount');
            
            if (selectedServices.length > 0) {
                selectedServicesCount.textContent = `Đã chọn ${selectedServices.length} dịch vụ`;
            } else {
                selectedServicesCount.textContent = 'Chưa chọn dịch vụ';
            }
        }

        function renderTablePopupContent() {
            
            // Reset search box and filtered data
            const tableSearchInput = document.getElementById('tablesSearchInput');
            if (tableSearchInput) {
                tableSearchInput.value = '';
            }

            filteredTables = Array.isArray(availableTables) ? [...availableTables] : [];

            // Check if table layouts exist
            if (tableLayouts.length > 0) {
                document.getElementById('tableLayoutToggle').style.display = 'block';
                switchToLayoutView();
            } else {
                document.getElementById('tableLayoutToggle').style.display = 'none';
                switchToTablesView();
            }
            
            const tablesList = document.getElementById('tablesList');
            tablesList.innerHTML = '';

            if (!filteredTables || filteredTables.length === 0) {
                if (tablesLoading && !tablesLoaded) {
                    tablesList.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-info text-center mb-0">
                                <i class="fas fa-spinner fa-spin me-2"></i>Đang tải danh sách bàn...
                            </div>
                        </div>
                    `;
                } else {
                    tablesList.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-info text-center mb-0">
                                <i class="fas fa-info-circle me-2"></i>Chưa có bàn khả dụng cho nhà hàng này.
                            </div>
                        </div>
                    `;
                }
            } else {
                // Use the new list layout function
                renderTablesInModal(filteredTables);
            }
            
            // Restore previous selections from hidden input
            const selectedTableIds = document.getElementById('selectedTableIds').value;
            if (selectedTableIds) {
                const tableIds = selectedTableIds.split(',');
                
                setTimeout(() => {
                    selectedTables = []; // Reset selectedTables array
                    
                    tableIds.forEach(tableId => {
                        const checkbox = document.querySelector(`#tableModal input[value="${tableId}"]`);
                        
                        if (checkbox) {
                            checkbox.checked = true;
                            
                            const tableItem = checkbox.closest('.table-list-item');
                            
                            if (tableItem) {
                                const deposit = parseFloat(tableItem.getAttribute('data-deposit'));
                                const tableName = tableItem.querySelector('h6').textContent;
                                const capacityText = tableItem.querySelector('.d-flex .small span:first-child').textContent;
                                const capacity = parseInt(capacityText.match(/\d+/)[0]);
                                
                                selectedTables.push({
                                    id: tableId,
                                    name: tableName,
                                    deposit: deposit,
                                    capacity: capacity
                                });
                            }
                        }
                    });
                    
                    updateTableSelectionUI(); // Update UI after restoring
                }, 100);
            }
        }

        function openTablePopup(forceReload = false) {

            const restaurantId = document.getElementById('restaurantId').value;
            if (!restaurantId) {
                alert('Vui lòng chọn nhà hàng trước khi xem sơ đồ bàn.');
                return;
            }

            const showModalWithContent = () => {
                renderTablePopupContent();
                const modal = new bootstrap.Modal(document.getElementById('tableModal'));
                modal.show();
            };

            if (forceReload || !availableTables || availableTables.length === 0) {
                loadTables().then(tables => {
                    if (tables && tables.length) {
                        showModalWithContent();
                    } else {
                        renderTablePopupContent();
                        const warningMsg = 'Không tìm thấy bàn khả dụng cho nhà hàng này.';
                        const modal = new bootstrap.Modal(document.getElementById('tableModal'));
                        modal.show();
                    }
                }).catch(error => {
                    renderTablePopupContent();
                    const modal = new bootstrap.Modal(document.getElementById('tableModal'));
                    modal.show();
                });
            } else {
                showModalWithContent();
            }
        }

        function openMenuPopup() {
            // Initialize filtered dishes
            filteredDishes = availableDishes;
            
            const menuList = document.getElementById('menuList');
            menuList.innerHTML = '';
            
            if (availableDishes.length === 0) {
                menuList.innerHTML = `
                    <div class="col-12 text-center">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            No menu items available for this restaurant.
                        </div>
                    </div>
                `;
            } else {
                // Render first page with pagination
                renderMenuPage(1);
            }
            
            const modal = new bootstrap.Modal(document.getElementById('menuModal'));
            modal.show();
        }

        function confirmTableSelection() {
            const checkboxes = document.querySelectorAll('.table-checkbox:checked');
            selectedTables = [];
            
            checkboxes.forEach(checkbox => {
                const tableItem = checkbox.closest('.table-list-item');
                
                const tableId = tableItem.getAttribute('data-table-id');
                const deposit = parseFloat(tableItem.getAttribute('data-deposit'));
                const tableName = tableItem.querySelector('h6').textContent;
                const capacityText = tableItem.querySelector('.d-flex .small span:first-child').textContent;
                const capacity = parseInt(capacityText.match(/\d+/)[0]);
                
                selectedTables.push({
                    id: tableId,
                    name: tableName,
                    deposit: deposit,
                    capacity: capacity
                });
            });
            
            // Update UI
            updateTableSelectionUI();
            updateTotalAmount();
            
            // Save form state
            saveFormState();
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('tableModal'));
            modal.hide();
        }

        function confirmMenuSelection() {
            const checkboxes = document.querySelectorAll('.dish-checkbox:checked');
            selectedDishes = [];
            
            checkboxes.forEach(checkbox => {
                const dishCard = checkbox.closest('.dish-card');
                if (!dishCard) return; // Safety check
                
                const dishId = dishCard.getAttribute('data-dish-id');
                const price = parseFloat(dishCard.getAttribute('data-price'));
                const dishNameElement = dishCard.querySelector('.dish-name');
                const dishName = dishNameElement ? dishNameElement.textContent : 'Unknown Dish';
                const quantityInput = dishCard.querySelector('.quantity-control input');
                const quantity = quantityInput ? parseInt(quantityInput.value) || 1 : 1;
                
                selectedDishes.push({
                    id: dishId,
                    name: dishName,
                    price: price,
                    quantity: quantity
                });
            });
            
            // Update UI
            updateMenuSelectionUI();
            updateTotalAmount();
            
            // Save form state
            saveFormState();
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('menuModal'));
            modal.hide();
        }

        function updateTableSelectionUI() {
            const countSpan = document.getElementById('selectedTablesCount');
            const summaryDiv = document.getElementById('selectedTablesSummary');
            const listDiv = document.getElementById('selectedTablesList');

            updateSelectedTableIds();

            if (!countSpan || !summaryDiv || !listDiv) {
                return;
            }

            if (selectedTables.length === 0) {
                countSpan.textContent = 'Chưa chọn bàn';
                summaryDiv.style.display = 'none';
                listDiv.innerHTML = '';
                return;
            }

            countSpan.textContent = `${selectedTables.length} table(s) selected`;
            summaryDiv.style.display = 'block';
            listDiv.innerHTML = selectedTables.map(table => {
                const tableName = table.name || table.tableName || 'Bàn';
                const capacityValue = table.capacity ?? table.tableCapacity ?? table.maxCapacity;
                const capacity = capacityValue !== undefined && capacityValue !== null ? capacityValue : '?';
                const depositValue = table.deposit ?? table.depositAmount ?? 0;
                const normalizedDeposit = Number(depositValue) || 0;

                return `
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span><strong>${tableName}</strong> (Sức chứa: ${capacity} khách)</span>
                        <span class="text-success">${formatCurrency(normalizedDeposit)}</span>
                    </div>
                `;
            }).join('');
        }

        function updateMenuSelectionUI() {
            const countSpan = document.getElementById('selectedDishesCount');
            const hiddenInput = document.getElementById('selectedDishIds');
            const summaryDiv = document.getElementById('selectedDishesSummary');
            const listDiv = document.getElementById('selectedDishesList');
            
            if (selectedDishes.length === 0) {
                countSpan.textContent = 'Chưa chọn món';
                hiddenInput.value = '';
                summaryDiv.style.display = 'none';
            } else {
                countSpan.textContent = `${selectedDishes.length} item(s) selected`;
                hiddenInput.value = selectedDishes.map(d => `${d.id}:${d.quantity}`).join(',');
                
                // Show detailed summary
                summaryDiv.style.display = 'block';
                listDiv.innerHTML = selectedDishes.map(dish => `
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span><strong>${dish.name}</strong> x${dish.quantity}</span>
                        <span class="text-success">${formatCurrency(dish.price * dish.quantity)}</span>
                    </div>
                `).join('');
            }
        }

        function updateTotalAmount() {
            let tableDeposit = 0;
            let dishesTotal = 0;
            let servicesTotal = 0;

            // Calculate table deposit
            selectedTables.forEach(table => {
                tableDeposit += Number(table.deposit) || 0;
            });

            // Calculate dishes total
            selectedDishes.forEach(dish => {
                dishesTotal += (Number(dish.price) || 0) * (Number(dish.quantity) || 1);
            });

            // Calculate services total
            selectedServices.forEach(service => {
                servicesTotal += Number(service.price) || 0;
            });

            // Update hidden input with selected service IDs only if services exist
            const serviceIdsInput = document.getElementById('selectedServiceIds');
            if (serviceIdsInput) {
                serviceIdsInput.value = selectedServices.length > 0 ? selectedServices.map(s => s.id).join(',') : serviceIdsInput.value;
            }

            // Calculate subtotal
            const subtotal = tableDeposit + dishesTotal + servicesTotal;
            
            // Update display
            document.getElementById('tableDepositAmount').textContent = formatCurrency(tableDeposit);
            document.getElementById('dishesTotalAmount').textContent = formatCurrency(dishesTotal);
            document.getElementById('servicesTotalAmount').textContent = formatCurrency(servicesTotal);
            document.getElementById('subtotalAmount').textContent = formatCurrency(subtotal);
            
            // Calculate final total with voucher discount
            const finalTotal = Math.max(0, subtotal - voucherDiscount);
            
            // Calculate deposit = 10% of final total (after voucher discount)
            const depositAmount = Math.round(finalTotal * 0.1);
            document.getElementById('totalDepositAmount').textContent = formatCurrency(depositAmount);
            
            // Update hidden input
            document.getElementById('depositAmount').value = depositAmount;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }
        
        // Form validation before submit
        function validateForm() {
            
            // Log current selections before validation
            logAllSelections();
            
            // First, run our comprehensive validation
            if (!validateFormBeforeSubmit()) {
                logAllSelections();
                
                // Restore form state after validation failure
                restoreFormState();
                
                return false;
            }
            
            
            // Save current form state before validation
            saveFormState();
            
            // Check if form elements exist
            const restaurantSelect = document.getElementById('restaurantId');
            const guestCountInput = document.getElementById('guestCount');
            const bookingTimeInput = document.getElementById('bookingTime');
            const selectedTableIdsInput = document.getElementById('selectedTableIds');
            
            const restaurantId = restaurantSelect.value;
            const guestCount = guestCountInput.value;
            const bookingTime = bookingTimeInput.value;
            const selectedTableIds = selectedTableIdsInput.value;
            
            // Basic validation (redundant but keeping for safety)
            if (!restaurantId || !guestCount || !bookingTime) {
                alert('Vui lòng điền đầy đủ các trường bắt buộc.');
                return false;
            }
            
            // Check availability with Smart Waitlist
            checkAvailabilityAndShowPopup(restaurantId, bookingTime, guestCount, selectedTableIds);
            
            // Prevent default form submission - we'll handle it in the callback
            return false;
        }
        
        // Save form state to hidden inputs
        function saveFormState() {
            logAllSelections();
            
            // Save table selections
            const tableIds = selectedTables
                .map(extractTableId)
                .filter(id => id !== '')
                .join(',');
            document.getElementById('selectedTableIds').value = tableIds;
            
            // Save dish selections
            const dishIds = selectedDishes.map(d => `${d.id}:${d.quantity}`).join(',');
            document.getElementById('selectedDishIds').value = dishIds;
            
            // Save service selections
            const serviceIds = selectedServices.map(s => s.id).join(',');
            document.getElementById('selectedServiceIds').value = serviceIds;
            
        }
        
        // Set minimum datetime to now + 30 minutes
        document.addEventListener('DOMContentLoaded', function() {
            // Check if there's a conflict error message and show waitlist popup instead
            checkAndShowWaitlistPopupFromError();
            
            const now = new Date();
            now.setMinutes(now.getMinutes() + 30);
            const minDateTime = now.toISOString().slice(0, 16);
            const bookingTimeInput = document.getElementById('bookingTime');            
            
            // Load tables if restaurant is already selected (edit mode)
            if (document.getElementById('restaurantId').value) {
                loadTables().then(() => {
                    restoreFormState();
                }).catch((error) => {
                    // Still try to restore form state even if tables fail to load
                    restoreFormState();
                });
            } else {
                // Restore form state immediately if no restaurant selected
                restoreFormState();
            }
            
            // Add change listener for restaurant selection
            document.getElementById('restaurantId').addEventListener('change', function() {
                loadTables();
                clearFormData();
            });
            
            // Initialize total amount calculation will be handled after restore
            
            // Add event listeners for dish checkboxes to show/hide quantity controls
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('dish-checkbox')) {
                    const quantityControl = e.target.parentElement.querySelector('.quantity-control');
                    if (quantityControl) {
                        quantityControl.style.display = e.target.checked ? 'block' : 'none';
                    }
                }
            });
            
            // Load available vouchers
            loadAvailableVouchers();
            
            // Reload vouchers when restaurant changes
            document.getElementById('restaurantId').addEventListener('change', function() {
                loadAvailableVouchers();
            });
        });
        
        // Load available vouchers for the customer
        function loadAvailableVouchers() {
            const restaurantId = document.getElementById('restaurantId').value;
            
            // Always use demo endpoint which handles authentication internally
            const url = restaurantId ? `/api/vouchers/demo?restaurantId=${restaurantId}` : '/api/vouchers/demo';
            
            fetch(url, {
                method: 'GET',
                credentials: 'include', // Include cookies for authentication
                headers: {
                    'X-Requested-With': 'XMLHttpRequest' // Indicate AJAX request
                }
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Failed to load vouchers');
                }
            })
            .then(vouchers => {
                availableVouchers = vouchers;
                populateVoucherDropdown();
            })
            .catch(error => {
                // Show empty dropdown on error
                availableVouchers = [];
                populateVoucherDropdown();
            });
        }
        
        // Populate voucher dropdown
        function populateVoucherDropdown() {
            const voucherSelect = document.getElementById('voucherSelect');
            voucherSelect.innerHTML = '<option value="">Chọn voucher của bạn</option>';
            
            availableVouchers.forEach(voucher => {
                const option = document.createElement('option');
                option.value = voucher.code;
                option.textContent = `${voucher.code} - ${voucher.description} (${voucher.discountType === 'PERCENT' ? voucher.discountValue + '%' : '₫' + voucher.discountValue})`;
                option.dataset.voucherId = voucher.voucherId;
                option.dataset.discountType = voucher.discountType;
                option.dataset.discountValue = voucher.discountValue;
                option.dataset.maxDiscountAmount = voucher.maxDiscountAmount;
                voucherSelect.appendChild(option);
            });
        }
        
        // Validate selected voucher
        function validateSelectedVoucher() {
            const voucherSelect = document.getElementById('voucherSelect');
            const selectedOption = voucherSelect.options[voucherSelect.selectedIndex];
            
            if (!selectedOption.value) {
                showVoucherError('Vui lòng chọn voucher');
                return;
            }
            
            const restaurantId = document.getElementById('restaurantId').value;
            const bookingTime = document.getElementById('bookingTime').value;
            const guestCount = document.getElementById('guestCount').value;
            
            if (!restaurantId) {
                showVoucherError('Vui lòng chọn nhà hàng trước');
                return;
            }
            
            if (!bookingTime) {
                showVoucherError('Vui lòng chọn thời gian đặt bàn trước');
                return;
            }
            
            if (!guestCount) {
                showVoucherError('Vui lòng nhập số lượng khách trước');
                return;
            }
            
            // Show loading state
            const validateBtn = document.getElementById('validateVoucherBtn');
            const originalText = validateBtn.innerHTML;
            validateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Applying...';
            validateBtn.disabled = true;
            
            // Prepare request data
            const requestData = {
                code: selectedOption.value,
                restaurantId: parseInt(restaurantId),
                bookingTime: bookingTime,
                guestCount: parseInt(guestCount),
                orderAmount: 1000000 // Placeholder amount - should be calculated from actual order
            };
            
            // Make API call
            fetch('/api/vouchers/validate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.valid) {
                    // Store voucher discount amount
                    voucherDiscount = data.calculatedDiscount ? parseFloat(data.calculatedDiscount) : 0;
                    
                    const discountText = data.calculatedDiscount ? 
                        `Giảm: ${formatCurrency(data.calculatedDiscount)}` : 
                        'Voucher hợp lệ';
                    showVoucherSuccess(discountText);
                } else {
                    // Reset voucher discount on error
                    voucherDiscount = 0;
                    const errorMessage = getVoucherErrorMessage(data.reason);
                    showVoucherError(errorMessage);
                }
            })
            .catch(error => {
                showVoucherError('Không thể kiểm tra voucher, vui lòng thử lại.');
            })
            .finally(() => {
                // Reset button state
                validateBtn.innerHTML = originalText;
                validateBtn.disabled = false;
            });
        }
        
        // Voucher validation function (legacy - keep for compatibility)
        function validateVoucher() {
            const voucherCode = document.getElementById('voucherCode').value.trim();
            const restaurantId = document.getElementById('restaurantId').value;
            const bookingTime = document.getElementById('bookingTime').value;
            const guestCount = document.getElementById('guestCount').value;
            
            if (!voucherCode) {
                showVoucherError('Vui lòng nhập mã voucher');
                return;
            }
            
            if (!restaurantId) {
                showVoucherError('Vui lòng chọn nhà hàng trước');
                return;
            }
            
            if (!bookingTime) {
                showVoucherError('Vui lòng chọn thời gian đặt bàn trước');
                return;
            }
            
            if (!guestCount) {
                showVoucherError('Vui lòng nhập số lượng khách trước');
                return;
            }
            
            // Show loading state
            const validateBtn = document.getElementById('validateVoucherBtn');
            const originalText = validateBtn.innerHTML;
            validateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang kiểm tra...';
            validateBtn.disabled = true;
            
            // Prepare request data
            const requestData = {
                code: voucherCode,
                restaurantId: parseInt(restaurantId),
                bookingTime: bookingTime,
                guestCount: parseInt(guestCount),
                orderAmount: 1000000 // Placeholder amount - should be calculated from actual order
            };
            
            // Make API call
            fetch('/api/vouchers/validate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.valid) {
                    // Store voucher discount amount
                    voucherDiscount = data.calculatedDiscount ? parseFloat(data.calculatedDiscount) : 0;
                    
                    const discountText = data.calculatedDiscount ? 
                        `Giảm: ${formatCurrency(data.calculatedDiscount)}` : 
                        'Voucher hợp lệ';
                    showVoucherSuccess(discountText);
                } else {
                    // Reset voucher discount on error
                    voucherDiscount = 0;
                    const errorMessage = getVoucherErrorMessage(data.reason);
                    showVoucherError(errorMessage);
                }
            })
            .catch(error => {
                showVoucherError('Không thể kiểm tra voucher, vui lòng thử lại.');
            })
            .finally(() => {
                // Reset button state
                validateBtn.innerHTML = originalText;
                validateBtn.disabled = false;
            });
        }
        
        function showVoucherSuccess(message) {
            hideVoucherMessages();
            document.getElementById('voucherSuccessText').textContent = message;
            document.getElementById('voucherSuccess').style.display = 'block';
            document.getElementById('voucherResult').style.display = 'block';
            
            // Update voucher discount in Booking Summary
            updateVoucherDiscountInSummary();
        }
        
        function showVoucherError(message) {
            hideVoucherMessages();
            document.getElementById('voucherErrorText').textContent = message;
            document.getElementById('voucherError').style.display = 'block';
            document.getElementById('voucherResult').style.display = 'block';
        }
        
        function hideVoucherMessages() {
            document.getElementById('voucherSuccess').style.display = 'none';
            document.getElementById('voucherError').style.display = 'none';
        }
        
        function getVoucherErrorMessage(reason) {
            const errorMessages = {
                'EMPTY_CODE': 'Vui lòng nhập mã voucher',
                'NOT_FOUND': 'Không tìm thấy voucher phù hợp',
                'INACTIVE': 'Voucher này hiện không hoạt động',
                'NOT_STARTED': 'Voucher này chưa bắt đầu áp dụng',
                'EXPIRED': 'Voucher này đã hết hạn',
                'RESTAURANT_SCOPE_MISMATCH': 'Voucher không áp dụng cho nhà hàng đã chọn',
                'MIN_ORDER_NOT_MET': 'Giá trị đặt bàn chưa đạt mức tối thiểu',
                'GLOBAL_LIMIT_REACHED': 'Voucher đã đạt số lượng sử dụng tối đa',
                'PER_CUSTOMER_LIMIT_REACHED': 'Bạn đã sử dụng voucher này đủ số lần cho phép',
                'NOT_ASSIGNED': 'Voucher này không thuộc về tài khoản của bạn',
                'LIMIT_REACHED': 'Bạn đã dùng voucher quá số lần quy định',
                'APPLICATION_ERROR': 'Có lỗi khi áp dụng voucher, vui lòng thử lại.'
            };
            return errorMessages[reason] || 'Mã voucher không hợp lệ';
        }

        
        // Restore form state after conflict/error
        function restoreFormState() {
            
            // Debug: Check hidden input values at the start of restoreFormState
            const selectedTableIds = document.getElementById('selectedTableIds').value;
            const selectedDishIds = document.getElementById('selectedDishIds').value;
            const serviceIdsInput = document.getElementById('selectedServiceIds');
            let selectedServiceIds = serviceIdsInput ? serviceIdsInput.value : '';

            if (serviceIdsInput && !selectedServiceIds && serviceIdsInput.dataset.initialValue) {
                selectedServiceIds = serviceIdsInput.dataset.initialValue;
                serviceIdsInput.value = selectedServiceIds;
            }
            
            // Debug: Check if selectedDishes array is being modified
            
            logAllSelections();
            
            // Check if we need to load data first
            const restaurantId = document.getElementById('restaurantId').value;
            if (restaurantId && (availableTables.length === 0 || availableDishes.length === 0 || availableServices.length === 0)) {
                loadTables().then(() => {
                    performRestore();
                }).catch((error) => {
                    // Still try to restore with whatever data we have
                    performRestore();
                });
            } else {
                performRestore();
            }
            
            function performRestore() {
                logAllSelections();
            
            // Debug: Check booking time input value
            const bookingTimeInput = document.getElementById('bookingTime');
            
            // Fix datetime format if needed
            const dataBookingTime = bookingTimeInput.getAttribute('data-booking-time');
            
            if (dataBookingTime) {
                try {
                    if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/.test(dataBookingTime)) {
                        bookingTimeInput.value = dataBookingTime;
                    } else if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}$/.test(dataBookingTime)) {
                        bookingTimeInput.value = dataBookingTime.slice(0, 16);
                    } else if (/Z|[+-]\d{2}:?\d{2}$/.test(dataBookingTime)) {
                        const asDate = new Date(dataBookingTime);
                        const localDate = new Date(asDate.getTime() - asDate.getTimezoneOffset() * 60000);
                        bookingTimeInput.value = localDate.toISOString().slice(0, 16);
                    } else {
                        const normalized = dataBookingTime.replace(' ', 'T');
                        bookingTimeInput.value = normalized.length >= 16 ? normalized.slice(0, 16) : normalized;
                    }
                } catch (error) {
                }
            }
            
            // If still no value, try to get from Thymeleaf
            if (!bookingTimeInput.value) {
                const thValue = bookingTimeInput.getAttribute('th:value');
                
                if (thValue) {
                    bookingTimeInput.value = thValue;
                }
            }
            
            // Restore table selection if any
            const selectedTableIds = document.getElementById('selectedTableIds').value;
            if (selectedTableIds) {
                const tableIds = selectedTableIds.split(',');
                selectedTables = [];
                
                // Find tables from availableTables array and add to selectedTables
                tableIds.forEach(tableId => {
                    
                    const table = availableTables.find(t => t.tableId == tableId);
                    if (table) {
                        selectedTables.push({
                            id: tableId,
                            name: table.tableName,
                            deposit: table.depositAmount || 0,
                            capacity: table.capacity
                        });
                    } else {
                    }
                });
                
                updateTableSelectionUI();
            }
            
            // Restore dish selections if any
            const selectedDishIds = document.getElementById('selectedDishIds').value;
            if (selectedDishIds) {
                const dishSelections = selectedDishIds.split(',');
                selectedDishes = [];
                
                // Find dishes from availableDishes array and add to selectedDishes
                dishSelections.forEach(selection => {
                    const [dishId, quantity] = selection.split(':');
                    if (dishId && quantity) {
                        
                    // Find dish by dishId field
                    const dish = availableDishes.find(d => d.dishId == dishId);
                        if (dish) {
                            selectedDishes.push({
                                id: dishId,
                                name: dish.name,
                                price: dish.price,
                                quantity: parseInt(quantity)
                            });
                        } else {
                        }
                    }
                });
                
                updateMenuSelectionUI();
            }
            
            // Restore service selections if any
            const selectedServiceIds = document.getElementById('selectedServiceIds').value;
            if (selectedServiceIds) {
                const serviceIds = selectedServiceIds.split(',');
                selectedServices = [];
                
                // Find services from availableServices array and add to selectedServices
                
                serviceIds.forEach((serviceId, index) => {
                    
                    // Find service by serviceId field
                    const service = availableServices.find(s => s.serviceId == serviceId);
                    
                    if (service) {
                        selectedServices.push({
                            id: serviceId,
                            name: service.name,
                            price: service.price || 0
                        });
                    } else {
                    }
                });
                
                
                // Also mark services as selected in DOM
                serviceIds.forEach((serviceId, index) => {
                    
                    const serviceCard = document.querySelector(`.service-card[data-service-id="${serviceId}"]`) || 
                                      document.querySelector(`.service-card[data-id="${serviceId}"]`);
                    
                    if (serviceCard) {
                        
                        serviceCard.classList.add('selected');
                    } else {
                    }
                });
            }
            
            // Update total amount after restoring all selections
            setTimeout(() => {
                updateTotalAmount();
            }, 2000);
            
            logAllSelections();
            }
            

            // Recalculate totals once restore is done to avoid early resets
            setTimeout(() => updateTotalAmount(), 0);
        }
        
        function updateVoucherDiscountInSummary() {
            const voucherDiscountRow = document.getElementById('voucherDiscountRow');
            const voucherDiscountDisplay = document.getElementById('voucherDiscountDisplay');
            
            
            if (voucherDiscount > 0) {
                // Show voucher discount row
                if (voucherDiscountRow) {
                    voucherDiscountRow.style.display = 'flex';
                }
                if (voucherDiscountDisplay) {
                    voucherDiscountDisplay.textContent = '-' + formatCurrency(voucherDiscount);
                }
                
                // Update hidden inputs
                const hiddenDiscountAmount = document.getElementById('voucherDiscountAmount');
                const hiddenCodeApplied = document.getElementById('voucherCodeApplied');
                
                if (hiddenDiscountAmount) {
                    hiddenDiscountAmount.value = voucherDiscount;
                }
                
                const voucherSelect = document.getElementById('voucherSelect');
                if (voucherSelect && hiddenCodeApplied) {
                    const selectedOption = voucherSelect.options[voucherSelect.selectedIndex];
                    hiddenCodeApplied.value = selectedOption ? selectedOption.value : '';
                }
                
                // Update total amount
                updateTotalAmount();
            } else {
                // Hide voucher discount row
                if (voucherDiscountRow) {
                    voucherDiscountRow.style.display = 'none';
                }
                
                // Reset hidden inputs
                const hiddenDiscountAmount = document.getElementById('voucherDiscountAmount');
                const hiddenCodeApplied = document.getElementById('voucherCodeApplied');
                
                if (hiddenDiscountAmount) {
                    hiddenDiscountAmount.value = '0';
                }
                if (hiddenCodeApplied) {
                    hiddenCodeApplied.value = '';
                }
                
                updateTotalAmount();
            }
        }
        
        // Helper functions for table status display
        function getStatusBadgeClass(status) {
            const statusValue = getTableStatusValue(status);
            switch(statusValue) {
                case 'AVAILABLE':
                    return 'table-status-badge table-status-available';
                case 'OCCUPIED':
                    return 'table-status-badge table-status-occupied';
                case 'RESERVED':
                    return 'table-status-badge table-status-reserved';
                case 'CLEANING':
                    return 'table-status-badge table-status-cleaning';
                case 'MAINTENANCE':
                    return 'table-status-badge table-status-maintenance';
                default:
                    return 'table-status-badge table-status-unknown';
            }
        }
        
        function getStatusDisplayName(status) {
            const statusValue = getTableStatusValue(status);
            switch(statusValue) {
                case 'AVAILABLE':
                    return 'Có sẵn';
                case 'OCCUPIED':
                    return 'Đang sử dụng';
                case 'RESERVED':
                    return 'Đã đặt';
                case 'CLEANING':
                    return 'Đang dọn dẹp';
                case 'MAINTENANCE':
                    return 'Bảo trì';
                default:
                    return statusValue;
            }
        }
        
        function getTableStatusValue(status) {
            // Handle both string and object status
            if (typeof status === 'string') {
                return status.toUpperCase(); // Convert to uppercase for consistent comparison
            } else if (status && typeof status === 'object') {
                const value = status.value || status.name || 'UNKNOWN';
                return value.toUpperCase();
            }
            return 'UNKNOWN';
        }
        
        // ==================== SMART WAITLIST FUNCTIONALITY ====================
        
        // Global variables for Smart Waitlist
        let currentAvailabilityData = null;
        let selectedAlternativeTable = null;
        
        /**
         * Check if there's a conflict error message and show waitlist popup instead
         */
        function checkAndShowWaitlistPopupFromError() {
            // Check if there's an error message about booking conflict
            const errorMessageElement = document.querySelector('.alert-danger span');
            if (!errorMessageElement) return;
            
            const errorMessage = errorMessageElement.textContent || '';
            console.log('🔍 Checking error message:', errorMessage);
            
            // Check if error message contains conflict keywords
            const conflictKeywords = ['conflict', 'trùng', 'đã được đặt', 'đang được sử dụng', 'không còn bàn', 'bàn đã được'];
            const hasConflict = conflictKeywords.some(keyword => 
                errorMessage.toLowerCase().includes(keyword.toLowerCase())
            );
            
            if (hasConflict) {
                console.log('✅ Conflict detected in error message - Showing waitlist popup...');
                
                // Hide the error message
                const errorAlert = errorMessageElement.closest('.alert-danger');
                if (errorAlert) {
                    errorAlert.style.display = 'none';
                }
                
                // Get form data to call availability check API
                const restaurantId = document.getElementById('restaurantId')?.value;
                const guestCount = document.getElementById('guestCount')?.value;
                const bookingTime = document.getElementById('bookingTime')?.value;
                const selectedTableIds = document.getElementById('selectedTableIds')?.value || '';
                
                if (restaurantId && guestCount && bookingTime) {
                    // Call availability check API to get waitlist info
                    console.log('📞 Calling availability check API with form data...');
                    checkAvailabilityAndShowPopup(restaurantId, bookingTime, guestCount, selectedTableIds);
                } else {
                    // If form data is not available, show generic waitlist popup
                    console.log('⚠️ Form data not available, showing generic waitlist popup');
                    const genericWaitlistData = {
                        hasConflict: true,
                        conflictType: 'NO_AVAILABLE_TABLES',
                        waitlistInfo: {
                            canJoinWaitlist: true,
                            estimatedWaitTime: new Date(Date.now() + 30 * 60 * 1000).toISOString(),
                            reason: errorMessage || 'Bàn đang được sử dụng hoặc không còn trống',
                            waitTimeMinutes: 30
                        },
                        conflictDetails: {
                            selectedTables: []
                        }
                    };
                    showSmartWaitlistPopup(genericWaitlistData);
                }
            }
        }
        
        /**
         * Check availability before form submission
         */
        function checkAvailabilityAndShowPopup(restaurantId, bookingTime, guestCount, selectedTableIds) {
            
            // Check for test mode (force show popup)
            const urlParams = new URLSearchParams(window.location.search);
            const testMode = urlParams.get('testWaitlist') === 'true';
            
            if (testMode) {
                console.log('🧪 TEST MODE: Forcing waitlist popup to show');
                const testData = {
                    hasConflict: true,
                    conflictType: 'NO_AVAILABLE_TABLES',
                    waitlistInfo: {
                        canJoinWaitlist: true,
                        estimatedWaitTime: new Date(Date.now() + 30 * 60 * 1000).toISOString(),
                        reason: 'Test mode - All tables are booked',
                        waitTimeMinutes: 30
                    },
                    conflictDetails: {
                        selectedTables: []
                    }
                };
                showSmartWaitlistPopup(testData);
                return;
            }
            
            const params = new URLSearchParams({
                restaurantId: restaurantId,
                bookingTime: bookingTime,
                guestCount: guestCount
            });
            
            if (selectedTableIds && selectedTableIds.trim() !== '') {
                params.append('selectedTableIds', selectedTableIds);
            }
            
            console.log('🔍 Checking availability with params:', params.toString());
            
            fetch(`/api/booking/availability-check?${params}`)
                .then(response => {
                    console.log('📡 API Response Status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('📦 API Response Data:', data);
                    console.log('🔍 hasConflict:', data.hasConflict);
                    console.log('🔍 conflictType:', data.conflictType);
                    console.log('🔍 waitlistInfo:', data.waitlistInfo);
                    
                    currentAvailabilityData = data;
                    
                    // Check if hasConflict is explicitly false or undefined
                    if (data.hasConflict === true) {
                        console.log('✅ Has conflict - Showing waitlist popup...');
                        showSmartWaitlistPopup(data);
                    } else {
                        console.log('ℹ️ No conflict - Submitting form directly...');
                        // Double check: if waitlistInfo exists, maybe we should show popup anyway?
                        if (data.waitlistInfo && data.waitlistInfo.canJoinWaitlist) {
                            console.log('⚠️ Waitlist info exists but hasConflict is false - showing popup anyway');
                            // Force show popup if waitlist info is available
                            const modifiedData = { ...data, hasConflict: true };
                            showSmartWaitlistPopup(modifiedData);
                        } else {
                            submitBookingForm();
                        }
                    }
                })
                .catch(error => {
                    console.error('❌ Error in availability check:', error);
                    console.error('❌ Error details:', error.message);
                    // Fallback to normal booking if API fails
                    console.log('⚠️ Falling back to normal booking submission...');
                    submitBookingForm();
                });
        }
        
        /**
         * Show Smart Waitlist popup with conflict information
         */
        function showSmartWaitlistPopup(data) {
            console.log('🎯 showSmartWaitlistPopup called with data:', data);
            
            // Check if modal element exists
            const modalElement = document.getElementById('smartWaitlistModal');
            if (!modalElement) {
                console.error('❌ Modal element not found!');
                alert('Lỗi: Không tìm thấy popup waitlist. Vui lòng tải lại trang.');
                return;
            }
            console.log('✅ Modal element found');
            
            // Update popup title based on conflict type
            const popupTitle = document.getElementById('popupTitle');
            if (!popupTitle) {
                console.error('❌ popupTitle element not found!');
            } else {
                if (data.conflictType === 'SPECIFIC_TABLE') {
                    popupTitle.textContent = 'Bàn bạn chọn đang trùng lịch';
                } else if (data.conflictType === 'NO_AVAILABLE_TABLES') {
                    popupTitle.textContent = 'Không còn bàn phù hợp với số khách';
                } else {
                    popupTitle.textContent = 'Không thể giữ bàn ngay';
                }
                console.log('✅ Popup title updated');
            }
            
            // Populate conflict content
            populateConflictContent(data);
            
            // Populate waitlist information
            populateWaitlistInfo(data.waitlistInfo);
            
            // Show the modal
            try {
                // Check if Bootstrap is available
                if (typeof bootstrap === 'undefined') {
                    console.error('❌ Bootstrap is not loaded!');
                    alert('Lỗi: Bootstrap không được tải. Vui lòng tải lại trang.');
                    return;
                }
                
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
                console.log('✅ Modal shown successfully');
            } catch (error) {
                console.error('❌ Error showing modal:', error);
                alert('Lỗi khi hiển thị popup waitlist: ' + error.message);
            }
        }
        
        /**
         * Populate conflict content based on conflict type
         */
        function populateConflictContent(data) {
            const conflictContent = document.getElementById('conflictContent');
            if (!conflictContent) {
                console.error('❌ conflictContent element not found!');
                return;
            }
            
            if (data.conflictType === 'SPECIFIC_TABLE') {
                let html = '<div class="alert alert-warning"><h6><i class="fas fa-exclamation-triangle"></i> Bàn đang được giữ bởi người khác:</h6>';
                
                if (data.conflictDetails && data.conflictDetails.selectedTables) {
                    data.conflictDetails.selectedTables.forEach(table => {
                        html += `<div class="mb-2">
                            <strong>${table.tableName}</strong> (Sức chứa: ${table.capacity} khách)
                            <ul class="mb-0 mt-1">`;
                        
                        if (table.conflicts && table.conflicts.length > 0) {
                            table.conflicts.forEach(conflict => {
                                try {
                                    // Format time from booking conflict
                                    const bookingTime = new Date(conflict.bookingTime);
                                    const endTime = new Date(conflict.endTime);
                                    
                                    // Format as HH:mm
                                    const bookingTimeStr = bookingTime.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                                    const endTimeStr = endTime.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                                    
                                    html += `<li>Đặt bàn #${conflict.bookingId}: ${bookingTimeStr} - ${endTimeStr} (${conflict.guestCount} khách)</li>`;
                                } catch (error) {
                                    console.error('❌ Error formatting conflict time:', error);
                                    html += `<li>Đặt bàn #${conflict.bookingId} (${conflict.guestCount} khách)</li>`;
                                }
                            });
                        }
                        
                        html += '</ul></div>';
                    });
                } else {
                    html += '<p>Bàn bạn chọn đang được sử dụng.</p>';
                }
                
                html += '</div>';
                conflictContent.innerHTML = html;
                
            } else if (data.conflictType === 'NO_AVAILABLE_TABLES') {
                // Don't show "Không còn bàn trống" message - just show reason from waitlistInfo
                conflictContent.innerHTML = '';
            } else {
                console.warn('⚠️ Unknown conflict type:', data.conflictType);
                conflictContent.innerHTML = '<div class="alert alert-warning">Có xung đột với đặt bàn của bạn.</div>';
            }
            
            console.log('✅ Conflict content populated');
        }
        
        /**
         * Populate waitlist information
         */
        function populateWaitlistInfo(waitlistInfo) {
            console.log('📋 populateWaitlistInfo called with:', waitlistInfo);
            
            if (!waitlistInfo) {
                console.warn('⚠️ waitlistInfo is null or undefined');
                return;
            }
            
            const waitTimeElement = document.getElementById('waitTime');
            const waitReasonElement = document.getElementById('waitReason');
            
            if (waitTimeElement) {
                if (waitlistInfo.estimatedWaitTime) {
                    try {
                        // estimatedWaitTime is when booking can be made (after conflict ends + buffer)
                        const estimatedTime = new Date(waitlistInfo.estimatedWaitTime);
                        
                        // Format as: "HH:mm dd/MM/yyyy" (when booking can be made)
                        const dateStr = estimatedTime.toLocaleDateString('vi-VN', { 
                            day: '2-digit', 
                            month: '2-digit', 
                            year: 'numeric' 
                        });
                        const timeStr = estimatedTime.toLocaleTimeString('vi-VN', { 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        });
                        
                        waitTimeElement.textContent = `${timeStr} ${dateStr}`;
                        console.log('✅ Wait time set:', waitTimeElement.textContent);
                    } catch (error) {
                        console.error('❌ Error parsing wait time:', error);
                        waitTimeElement.textContent = 'Đang tính toán...';
                    }
                } else if (waitlistInfo.waitTimeMinutes) {
                    // Fallback: show minutes if estimatedWaitTime is not available
                    waitTimeElement.textContent = `Khoảng ${waitlistInfo.waitTimeMinutes} phút`;
                    console.log('✅ Wait time minutes set:', waitlistInfo.waitTimeMinutes);
                } else {
                    waitTimeElement.textContent = 'Đang tính toán...';
                }
            } else {
                console.error('❌ waitTime element not found!');
            }
            
            if (waitReasonElement) {
                if (waitlistInfo.reason) {
                    waitReasonElement.textContent = waitlistInfo.reason;
                    console.log('✅ Wait reason set:', waitlistInfo.reason);
                } else {
                    waitReasonElement.textContent = 'Bàn đang được sử dụng';
                }
            } else {
                console.error('❌ waitReason element not found!');
            }
            
            console.log('✅ Waitlist info populated');
        }
        
        /**
         * Join Smart Waitlist
         */
        function joinSmartWaitlist() {
            
            // Get form data with null checks
            const restaurantIdElement = document.getElementById('restaurantId');
            const guestCountElement = document.getElementById('guestCount');
            const bookingTimeElement = document.getElementById('bookingTime');
            
            if (!restaurantIdElement || !guestCountElement || !bookingTimeElement) {
                showNotification('Không tìm thấy dữ liệu biểu mẫu, vui lòng tải lại trang và thử lại.', 'error');
                return;
            }
            
            const restaurantId = restaurantIdElement.value;
            const guestCount = parseInt(guestCountElement.value);
            const preferredBookingTime = bookingTimeElement.value;
            const specialRequests = ''; // No special requests field in current form
            
            // Get selected items
            const dishIds = document.getElementById('selectedDishIds').value || '';
            const serviceIds = document.getElementById('selectedServiceIds').value || '';
            const tableIds = document.getElementById('selectedTableIds').value || '';
            
            
            // Call API to join waitlist
            fetch('/api/booking/join-waitlist', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    restaurantId: parseInt(restaurantId),
                    guestCount: guestCount,
                    preferredBookingTime: preferredBookingTime,
                    specialRequests: specialRequests,
                    dishIds: dishIds,
                    serviceIds: serviceIds,
                    tableIds: tableIds
                })
            })
            .then(response => response.json())
            .then(data => {
                
                if (data.success) {
                    // Close the popup
                    const modal = bootstrap.Modal.getInstance(document.getElementById('smartWaitlistModal'));
                    modal.hide();
                    
                    // Show success message
                    showNotification(`Đã tham gia danh sách chờ! Vị trí của bạn: ${data.queuePosition}, thời gian chờ ước tính: ${data.estimatedWaitTime} phút`, 'success');
                } else {
                    showNotification(data.error || 'Không thể tham gia danh sách chờ', 'error');
                }
            })
            .catch(error => {
                showNotification('Không thể tham gia danh sách chờ, vui lòng thử lại.', 'error');
            });
        }
        
        /**
         * Validate form before submission
         */
        function validateFormBeforeSubmit() {
            
            // Get form data
            const restaurantId = document.getElementById('restaurantId').value;
            const guestCount = parseInt(document.getElementById('guestCount').value);
            const bookingTime = document.getElementById('bookingTime').value;
            const tableId = document.getElementById('tableId').value;
            const tableIds = document.getElementById('selectedTableIds').value;
            
            
            // 1. Validate required fields
            if (!restaurantId) {
                showNotification('Vui lòng chọn nhà hàng', 'error');
                return false;
            }
            
            if (!guestCount || guestCount < 1) {
                showNotification('Số lượng khách phải ít nhất 1 người', 'error');
                return false;
            }
            
            if (guestCount > 20) {
                showNotification('Số lượng khách không được vượt quá 20 người', 'error');
                return false;
            }
            
            if (!bookingTime) {
                showNotification('Vui lòng chọn thời gian đặt bàn', 'error');
                return false;
            }
            
            // 2. Validate table selection
            if (!tableId && !tableIds) {
                showNotification('Vui lòng chọn ít nhất một bàn', 'error');
                return false;
            }
            
            // 3. Validate table capacity
            if (!validateTableCapacityBeforeSubmit(guestCount, tableId, tableIds)) {
                return false;
            }
            
            return true;
        }
        
        /**
         * Validate table capacity before submission
         */
        function validateTableCapacityBeforeSubmit(guestCount, tableId, tableIds) {
            
            if (tableId) {
                // Single table validation
                const table = availableTables.find(t => t.tableId == tableId);
                if (table) {
                    if (guestCount > table.capacity) {
                        showNotification(`Số khách (${guestCount}) vượt quá sức chứa của bàn ${table.tableName} (${table.capacity} người)`, 'error');
                        return false;
                    }
                }
            } else if (tableIds) {
                // Multiple tables validation
                const tableIdArray = tableIds.split(',');
                let totalCapacity = 0;
                let tableNames = [];
                
                for (const tableIdStr of tableIdArray) {
                    const table = availableTables.find(t => t.tableId == tableIdStr.trim());
                    if (table) {
                        totalCapacity += table.capacity;
                        tableNames.push(table.tableName);
                    }
                }
                
                if (guestCount > totalCapacity) {
                    showNotification(`Số khách (${guestCount}) vượt quá tổng sức chứa của các bàn đã chọn (${totalCapacity} người)`, 'error');
                    return false;
                }
            }
            
            return true;
        }
        
        /**
         * Submit booking form (original function)
         */
        function submitBookingForm() {
            
            // Check authentication first
            if (!checkAuthentication()) {
                return;
            }
            
            // Validate form before submission
            if (!validateFormBeforeSubmit()) {
                return;
            }
            
            // Save form state before submission
            saveFormState();
            
            // Find and submit the form
            const form = document.getElementById('bookingForm');
            if (!form) {
                showNotification('Không tìm thấy biểu mẫu, vui lòng tải lại trang và thử lại.', 'error');
                return;
            }
            
            form.submit();
        }
        
        /**
         * Check if user is authenticated
         */
        function checkAuthentication() {
            // Check if user is logged in by looking for authentication indicators
            const isLoggedIn = document.body.getAttribute('data-user-logged-in') === 'true' || 
                              document.querySelector('[data-user-id]') !== null ||
                              document.querySelector('.user-menu') !== null;
            
            if (!isLoggedIn) {
                // Show login modal
                showLoginModal();
                return false;
            }
            
            return true;
        }
        
        /**
         * Show login modal
         */
        function showLoginModal() {
            // Save current form state before redirecting to login
            saveFormState();
            
            // Create login modal if it doesn't exist
            let loginModal = document.getElementById('loginModal');
            if (!loginModal) {
                loginModal = document.createElement('div');
                loginModal.id = 'loginModal';
                loginModal.className = 'modal fade';
                loginModal.setAttribute('tabindex', '-1');
                loginModal.setAttribute('aria-labelledby', 'loginModalLabel');
                loginModal.setAttribute('aria-hidden', 'true');
                loginModal.innerHTML = `
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="loginModalLabel">
                                    <i class="fas fa-sign-in-alt me-2"></i>Đăng nhập để đặt bàn
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="text-center mb-4">
                                    <i class="fas fa-user-lock text-primary" style="font-size: 3rem;"></i>
                                    <p class="mt-3 text-muted">Bạn cần đăng nhập để có thể đặt bàn</p>
                                </div>
                                <div class="d-grid gap-2">
                                    <a href="/login?returnUrl=${encodeURIComponent(window.location.href)}" class="btn btn-primary btn-lg">
                                        <i class="fas fa-sign-in-alt me-2"></i>Đăng nhập
                                    </a>
                                    <a href="/register?returnUrl=${encodeURIComponent(window.location.href)}" class="btn btn-outline-primary">
                                        <i class="fas fa-user-plus me-2"></i>Đăng ký tài khoản
                                    </a>
                                </div>
                                <div class="mt-3 text-center">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Thông tin đặt bàn của bạn sẽ được lưu tạm thời
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(loginModal);
            }
            
            // Show the modal
            const modal = new bootstrap.Modal(loginModal);
            modal.show();
            
            // Show notification
            showNotification('Vui lòng đăng nhập để tiếp tục đặt bàn', 'warning');
        }
        
        /**
         * Show notification
         */
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }
        
        /**
         * Clear all form data when restaurant changes
         */
        function clearFormData() {
            tablesLoaded = false;
            tablesLoading = false;
            availableTables = [];
            filteredTables = [];
            
            // Clear selected tables
            selectedTables = [];
            document.getElementById('selectedTableIds').value = '';
            document.getElementById('selectedTablesCount').textContent = 'Chưa chọn bàn';
            document.getElementById('selectedTablesSummary').style.display = 'none';
            document.getElementById('selectedTablesList').innerHTML = '';
            
            // Clear selected dishes
            selectedDishes = [];
            document.getElementById('selectedDishIds').value = '';
            document.getElementById('selectedDishesCount').textContent = 'Chưa chọn món';
            document.getElementById('selectedDishesSummary').style.display = 'none';
            document.getElementById('selectedDishesList').innerHTML = '';
            
            // Clear selected services
            document.getElementById('selectedServiceIds').value = '';
            document.querySelectorAll('#servicesContainer input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Clear guest count
            document.getElementById('guestCount').value = '';
            
            // Clear booking time
            document.getElementById('bookingTime').value = '';
            
        }
        
        // ==================== END SMART WAITLIST FUNCTIONALITY ====================
    </script>
    
    <!-- Simple JavaScript Pre-fill (No Thymeleaf conflicts) -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔍 DEBUG: Booking form JavaScript loaded');
            
            // Get URL parameters - support both 'date/time/guests' and 'prefillDate/prefillTime/prefillGuests'
            const urlParams = new URLSearchParams(window.location.search);
            const date = urlParams.get('date');
            const time = urlParams.get('time');
            const guests = urlParams.get('guests');
            const prefillDate = urlParams.get('prefillDate');
            const prefillTime = urlParams.get('prefillTime');
            const prefillGuests = urlParams.get('prefillGuests');
            const restaurantId = urlParams.get('restaurantId');
            
            // Use date/time/guests if provided (from restaurant detail page), otherwise use prefill* parameters
            const finalDate = date || prefillDate;
            const finalTime = time || prefillTime;
            const finalGuests = guests || prefillGuests;
            
            console.log('🔍 DEBUG: URL parameters:');
            console.log('  restaurantId:', restaurantId);
            console.log('  date:', date, 'prefillDate:', prefillDate, '-> finalDate:', finalDate);
            console.log('  time:', time, 'prefillTime:', prefillTime, '-> finalTime:', finalTime);
            console.log('  guests:', guests, 'prefillGuests:', prefillGuests, '-> finalGuests:', finalGuests);
            
            // Pre-fill restaurant selection
            if (restaurantId) {
                const restaurantSelect = document.getElementById('restaurantId');
                if (restaurantSelect) {
                    restaurantSelect.value = restaurantId;
                    console.log('✅ DEBUG: Set restaurantId to:', restaurantId);
                    
                    // Auto-load tables
                    if (typeof loadTables === 'function') {
                        loadTables();
                        console.log('🔍 DEBUG: Auto-loading tables for restaurant:', restaurantId);
                    }
                }
            }
            
            // Pre-fill date and time
            if (finalDate && finalTime) {
                // Format date if needed (YYYY-MM-DD) and time (HH:mm)
                let dateValue = finalDate;
                let timeValue = finalTime;
                
                // Ensure time is in HH:mm format (remove any :ss if present)
                if (timeValue && timeValue.length > 5) {
                    timeValue = timeValue.substring(0, 5);
                }
                
                const dateTimeString = dateValue + 'T' + timeValue;
                console.log('🔍 DEBUG: Combined datetime:', dateTimeString);
                
                const bookingTimeInput = document.getElementById('bookingTime');
                if (bookingTimeInput) {
                    bookingTimeInput.value = dateTimeString;
                    console.log('✅ DEBUG: Set bookingTime to:', dateTimeString);
                } else {
                    console.log('❌ DEBUG: bookingTime input not found');
                }
            } else {
                console.log('⚠️ DEBUG: Missing date/time data. finalDate:', finalDate, 'finalTime:', finalTime);
            }
            
            // Pre-fill guest count
            if (finalGuests) {
                const guestCountInput = document.getElementById('guestCount');
                if (guestCountInput) {
                    guestCountInput.value = finalGuests;
                    console.log('✅ DEBUG: Set guestCount to:', finalGuests);
                } else {
                    console.log('❌ DEBUG: guestCount input not found');
                }
            } else {
                console.log('⚠️ DEBUG: finalGuests is null or empty');
            }
            
            // Show success message if all data is pre-filled
            if (restaurantId && finalDate && finalTime && finalGuests) {
                console.log('🎉 DEBUG: All data successfully pre-filled!');
                
                // Optional: Show a success message to user
                const successMsg = document.createElement('div');
                successMsg.className = 'alert alert-success';
                successMsg.innerHTML = '<i class="fas fa-check-circle"></i> Thông tin đã được điền sẵn từ trang chi tiết nhà hàng!';
                
                const form = document.querySelector('form');
                if (form) {
                    form.insertBefore(successMsg, form.firstChild);
                    
                    // Auto-hide after 5 seconds
                    setTimeout(() => {
                        successMsg.remove();
                    }, 5000);
                }
            }
            
            // Check if user just logged in and restore form state
            checkAndRestoreFormState();
        });
        
        /**
         * Check if user just logged in and restore form state
         */
        function checkAndRestoreFormState() {
            // Check if there's a saved form state in localStorage
            const savedState = localStorage.getItem('bookingFormState');
            if (savedState) {
                try {
                    const formData = JSON.parse(savedState);
                    
                    // Check if user is now logged in
                    const isLoggedIn = document.body.getAttribute('data-user-logged-in') === 'true' || 
                                      document.querySelector('[data-user-id]') !== null;
                    
                    if (isLoggedIn) {
                        // Restore form state
                        restoreFormState(formData);
                        
                        // Clear saved state
                        localStorage.removeItem('bookingFormState');
                        
                        // Show success message
                        showNotification('Chào mừng bạn quay lại! Thông tin đặt bàn đã được khôi phục.', 'success');
                    }
                } catch (error) {
                    console.error('Error restoring form state:', error);
                    localStorage.removeItem('bookingFormState');
                }
            }
        }
        
        /**
         * Restore form state from saved data
         */
        function restoreFormState(formData) {
            // Restore basic form fields
            if (formData.restaurantId) {
                const restaurantSelect = document.getElementById('restaurantId');
                if (restaurantSelect) {
                    restaurantSelect.value = formData.restaurantId;
                }
            }
            
            if (formData.bookingTime) {
                const bookingTimeInput = document.getElementById('bookingTime');
                if (bookingTimeInput) {
                    bookingTimeInput.value = formData.bookingTime;
                }
            }
            
            if (formData.guestCount) {
                const guestCountInput = document.getElementById('guestCount');
                if (guestCountInput) {
                    guestCountInput.value = formData.guestCount;
                }
            }
            
            // Restore selected tables, dishes, services if any
            if (formData.selectedTableIds) {
                document.getElementById('selectedTableIds').value = formData.selectedTableIds;
            }
            
            if (formData.selectedDishIds) {
                document.getElementById('selectedDishIds').value = formData.selectedDishIds;
            }
            
            if (formData.selectedServiceIds) {
                document.getElementById('selectedServiceIds').value = formData.selectedServiceIds;
            }
            
            // Update UI if needed
            if (typeof updateTableSelectionUI === 'function') {
                updateTableSelectionUI();
            }
            
            if (typeof updateTotalAmount === 'function') {
                updateTotalAmount();
            }
        }
    </script>
</body>
</html> 

