<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${bookingId != null ? 'Edit Reservation - Aurelius' : 'New Reservation - Aurelius'}">Booking Form</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Lato:wght@300;400;500&display=swap" rel="stylesheet">
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Custom Luxury CSS -->
    <link th:href="@{/css/luxury.css}" rel="stylesheet">
    
    <style>
        .table-card, .dish-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .table-card:hover, .dish-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .table-card.selected, .dish-card.selected {
            border-color: #007bff;
            background-color: #f8f9fa;
        }
        
        .form-check-input:checked + .form-check-label .card {
            border-color: #007bff;
            background-color: #e3f2fd;
        }
        
        .quantity-control {
            margin-top: 10px;
        }
        
        .modal-xl {
            max-width: 90%;
        }
        
        /* Service Cards Styling */
        .services-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        
        .service-card {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            position: relative;
        }
        
        .service-card:hover {
            border-color: #007bff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,123,255,0.15);
        }
        
        .service-card.selected {
            border-color: #28a745;
            background-color: #f8fff9;
            box-shadow: 0 4px 12px rgba(40,167,69,0.15);
        }
        
        .service-card.selected::before {
            content: '‚úì';
            position: absolute;
            top: 8px;
            right: 8px;
            background: #28a745;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .service-icon {
            font-size: 24px;
            color: #007bff;
            margin-bottom: 8px;
        }
        
        .service-card.selected .service-icon {
            color: #28a745;
        }
        
        .service-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
            color: #333;
        }
        
        .service-description {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            line-height: 1.3;
        }
        
        .service-price {
            font-size: 13px;
            font-weight: 600;
            color: #28a745;
        }
        
        .selected {
            border-color: var(--primary);
            background: rgba(255, 107, 129, 0.15);
        }
        /* Carousel Styles */
        .carousel {
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            margin-top: 2rem;
        }
        
        .carousel-image {
            height: 500px;
            object-fit: contain;
            width: 100%;
        }
        
        .carousel-indicators {
            margin-bottom: 1rem;
        }
        
        .carousel-indicators [data-bs-target] {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.5);
            border: 2px solid white;
            margin: 0 5px;
            transition: all 0.3s ease;
        }
        
        .carousel-indicators .active {
            background-color: #007bff;
            transform: scale(1.2);
        }
        
        .carousel-control-prev,
        .carousel-control-next {
            width: 50px;
            height: 50px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            top: 50%;
            transform: translateY(-50%);
            transition: all 0.3s ease;
        }
        
        .carousel-control-prev {
            left: 20px;
        }
        
        .carousel-control-next {
            right: 20px;
        }
        
        .carousel-control-prev:hover,
        .carousel-control-next:hover {
            background-color: rgba(0, 0, 0, 0.7);
            transform: translateY(-50%) scale(1.1);
        }
        
        .carousel-caption {
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            border-radius: 0 0 1rem 1rem;
            padding: 2rem 1rem 1rem;
            bottom: 0;
            left: 0;
            right: 0;
        }
        
        .carousel-caption h5 {
            color: white;
            font-weight: 600;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        
        .carousel-caption p {
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 0;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        
        /* Table Images Modal specific styles */
        #tableImagesModal .carousel {
            max-height: 600px;
            margin-top: 0;
        }
        
        #tableImagesModal .carousel-image {
            height: 600px;
            object-fit: cover;
        }
        
        #tableImagesModal .carousel-indicators {
            margin-bottom: 1rem;
        }
        
        #tableImagesModal .carousel-control-prev,
        #tableImagesModal .carousel-control-next {
            width: 60px;
            height: 60px;
        }
        
        #tableImagesModal .carousel-control-prev {
            left: 30px;
        }
        
        #tableImagesModal .carousel-control-next {
            right: 30px;
        }
        
        /* Table Card Hover Effects */
        .image-section:hover .image-overlay {
            background: rgba(0,0,0,0.3) !important;
        }
        
        .image-section:hover .image-overlay i {
            opacity: 1 !important;
        }
        
        .content-section:hover {
            background-color: rgba(0,123,255,0.05);
            transition: background-color 0.3s ease;
        }
        
        /* View Toggle Button Styles */
        .btn-group .btn {
            flex: 1;
            transition: all 0.3s ease;
        }
        
        .btn-group .btn.active {
            background-color: var(--bs-btn-active-bg);
            border-color: var(--bs-btn-active-border-color);
            color: var(--bs-btn-active-color);
        }
        
        .btn-group .btn-outline-info.active {
            background-color: #17a2b8;
            border-color: #17a2b8;
            color: white;
        }
        
        .btn-group .btn-outline-success.active {
            background-color: #198754;
            border-color: #198754;
            color: white;
        }
        
        .view-content {
            min-height: 400px;
        }
        
        /* Search Box Styles */
        .input-group .form-control {
            border-radius: 0.5rem 0 0 0.5rem;
        }
        
        .input-group .btn {
            border-radius: 0 0.5rem 0.5rem 0;
        }
        
        .input-group-text {
            background-color: #f8f9fa;
            border-color: #dee2e6;
        }
        
        .form-control:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        
        /* Pagination Styles */
        .pagination .page-link {
            color: #007bff;
            border-color: #007bff;
            background: transparent;
        }
        
        .pagination .page-item.active .page-link {
            background-color: #007bff;
            border-color: #007bff;
            color: white;
        }
        
        .pagination .page-link:hover {
            color: white;
            background-color: rgba(0, 123, 255, 0.1);
            border-color: #007bff;
        }
    </style>
</head>

<body>
    <!-- Header Fragment -->
    <div th:insert="~{fragments/header :: site-header}"></div>
    
    <!-- Main Content -->
    <main class="main-content">
        <div class="container mt-4">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="luxury-card">
                        <div class="text-center mb-4">
                            <h2 class="luxury-title">
                                <i class="fas fa-calendar-plus luxury-icon"></i>
                                <span th:text="${bookingId != null ? 'Edit Reservation' : 'New Reservation'}"></span>
                            </h2>
                            <p class="text-muted">Create your perfect dining experience</p>
                        </div>
                        
                        <!-- Error Messages -->
                        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-triangle luxury-icon"></i>
                            <span th:text="${errorMessage}"></span>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
                        </div>
                        
                        <!-- Success Messages -->
                        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="fas fa-check-circle luxury-icon"></i>
                            <span th:text="${successMessage}"></span>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
                        </div>
                        
                        <form th:action="${bookingId != null ? '/booking/' + bookingId + '/update' : '/booking'}" 
                              method="post" 
                              th:object="${bookingForm}"
                              id="bookingForm"
                              onsubmit="return validateForm()">
                            
                            <!-- Restaurant Selection -->
                            <div class="mb-4">
                                <label for="restaurantId" class="form-label">
                                    <i class="fas fa-utensils luxury-icon"></i> Restaurant <span style="color: #ff6b6b;">*</span>
                                </label>
                                <select class="form-control" 
                                        id="restaurantId" 
                                        name="restaurantId" 
                                        th:field="*{restaurantId}"
                                        th:classappend="${#fields.hasErrors('restaurantId')} ? 'is-invalid' : ''"
                                        onchange="loadTables()">
                                    <option value="">-- Select Restaurant --</option>
                                    <option th:each="restaurant : ${restaurants}" 
                                            th:value="${restaurant.restaurantId}" 
                                            th:text="${restaurant.restaurantName}"></option>
                                </select>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('restaurantId')}" 
                                     th:errors="*{restaurantId}"></div>
                            </div>
                            
                            <!-- Table Selection -->
                            <div class="mb-4">
                                <label class="form-label">
                                    <i class="fas fa-chair luxury-icon"></i> Tables (Optional)
                                </label>
                                <div class="d-flex gap-2">
                                    <button type="button" 
                                            class="btn btn-outline-primary" 
                                            id="viewTablesBtn"
                                            onclick="openTablePopup()"
                                            disabled>
                                        <i class="fas fa-eye"></i> View Tables
                                    </button>
                                    <span id="selectedTablesCount" class="text-muted small align-self-center">No tables selected</span>
                                </div>
                                <small style="color: var(--luxury-gray-dark); font-size: 0.9rem; margin-top: 8px; display: block;">
                                    Click to view and select multiple tables
                                </small>
                                <!-- Selected Tables Summary -->
                                <div id="selectedTablesSummary" class="mt-2" style="display: none;">
                                    <div class="alert alert-info">
                                        <h6><i class="fas fa-chair"></i> Selected Tables:</h6>
                                        <div id="selectedTablesList"></div>
                                    </div>
                                </div>
                                <!-- Hidden input to store selected table IDs -->
                                <input type="hidden" id="selectedTableId" name="tableId" th:value="${bookingForm.tableId}" />
                                <input type="hidden" id="selectedTableIds" name="tableIds" th:value="${bookingForm.tableIds}" />
                            </div>
                            
                            <div class="row">
                                <!-- Guest Count -->
                                <div class="col-md-6 mb-4">
                                    <label for="guestCount" class="form-label">
                                        <i class="fas fa-users luxury-icon"></i> Number of Guests <span style="color: #ff6b6b;">*</span>
                                    </label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="guestCount" 
                                           name="guestCount"
                                           th:field="*{guestCount}"
                                           th:classappend="${#fields.hasErrors('guestCount')} ? 'is-invalid' : ''"
                                           min="1" max="20" 
                                           placeholder="Enter number of guests">
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('guestCount')}" 
                                         th:errors="*{guestCount}"></div>
                                </div>
                                
                                <!-- Booking Time -->
                                <div class="col-md-6 mb-4">
                                    <label for="bookingTime" class="form-label">
                                        <i class="fas fa-clock luxury-icon"></i> Reservation Time <span style="color: #ff6b6b;">*</span>
                                    </label>
                                    <input type="datetime-local" 
                                           class="form-control" 
                                           id="bookingTime" 
                                           name="bookingTime"
                                           th:field="*{bookingTime}"
                                           th:value="${bookingForm.bookingTime != null ? #temporals.format(bookingForm.bookingTime, 'yyyy-MM-dd''T''HH:mm') : ''}"
                                           th:attr="data-booking-time=${bookingForm.bookingTime}"
                                           th:classappend="${#fields.hasErrors('bookingTime')} ? 'is-invalid' : ''">
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('bookingTime')}" 
                                         th:errors="*{bookingTime}"></div>
                                    <small style="color: var(--luxury-gray-dark); font-size: 0.9rem; margin-top: 8px; display: block;">
                                        Reservation must be at least 30 minutes from now
                                    </small>
                                </div>
                            </div>
                            
                            <!-- Dishes Selection -->
                            <div class="mb-4" id="dishesSection">
                                <label class="form-label">
                                    <i class="fas fa-utensils luxury-icon"></i> Menu Items
                                </label>
                                <div class="d-flex gap-2">
                                    <button type="button" 
                                            class="btn btn-outline-primary" 
                                            id="viewMenuBtn"
                                            onclick="openMenuPopup()"
                                            disabled>
                                        <i class="fas fa-eye"></i> View Menu
                                    </button>
                                    <span id="selectedDishesCount" class="text-muted small align-self-center">No items selected</span>
                                </div>
                                <small style="color: var(--luxury-gray-dark); font-size: 0.9rem; margin-top: 8px; display: block;">
                                    Click to view and select multiple menu items
                                </small>
                                <!-- Selected Menu Items Summary -->
                                <div id="selectedDishesSummary" class="mt-2" style="display: none;">
                                    <div class="alert alert-info">
                                        <h6><i class="fas fa-utensils"></i> Selected Menu Items:</h6>
                                        <div id="selectedDishesList"></div>
                                    </div>
                                </div>
                                <!-- Hidden input to store selected dish IDs -->
                                <input type="hidden" id="selectedDishIds" name="dishIds" th:value="${bookingForm.dishIds}" />
                            </div>

                            <!-- Services Selection -->
                            <div class="mb-4" id="servicesSection" style="display: block;">
                                <label class="form-label">
                                    <i class="fas fa-concierge-bell luxury-icon"></i> Additional Services
                                </label>
                                <div class="services-container" id="servicesContainer">
                                    <!-- Services will be loaded here as cards -->
                                </div>
                                <small style="color: var(--text-light); font-size: 0.9rem; margin-top: 8px; display: block;">
                                    Select services to enhance your dining experience
                                </small>
                            <!-- Hidden input to store selected service IDs -->
                            <!-- Debug: Check serviceIds value -->
                            <script th:inline="javascript">
                                console.log('üîç DEBUG - Thymeleaf serviceIds value:', /*[[${bookingForm.serviceIds}]]*/ 'null');
                                console.log('üîç DEBUG - Thymeleaf serviceIds type:', typeof /*[[${bookingForm.serviceIds}]]*/ 'null');
                                console.log('üîç DEBUG - Thymeleaf serviceIds is null:', /*[[${bookingForm.serviceIds == null}]]*/ 'null');
                                console.log('üîç DEBUG - Thymeleaf serviceIds is empty:', /*[[${bookingForm.serviceIds == ''}]]*/ 'null');
                                console.log('üîç DEBUG - Thymeleaf serviceIds length:', /*[[${bookingForm.serviceIds != null ? bookingForm.serviceIds.length() : 'null'}]]*/ 'null');
                                
                                // Check hidden input after DOM is ready
                                document.addEventListener('DOMContentLoaded', function() {
                                    const serviceIdsInput = document.getElementById('selectedServiceIds');
                                    console.log('üîç DEBUG - Hidden input selectedServiceIds value:', serviceIdsInput ? serviceIdsInput.value : 'NOT FOUND');
                                    console.log('üîç DEBUG - Hidden input selectedServiceIds attributes:', serviceIdsInput ? {
                                        id: serviceIdsInput.id,
                                        name: serviceIdsInput.name,
                                        value: serviceIdsInput.value,
                                        type: serviceIdsInput.type
                                    } : 'NOT FOUND');
                                });
                            </script>
                            <input type="hidden" id="selectedServiceIds" name="serviceIds" th:value="${bookingForm.serviceIds}" />
                            
                            <!-- Hidden inputs for voucher information -->
                            <input type="hidden" id="voucherDiscountAmount" name="voucherDiscountAmount" value="0">
                            <input type="hidden" id="voucherCodeApplied" name="voucherCodeApplied" value="">
                            </div>

                            <!-- Total Amount Display -->
                            <div class="mb-4">
                                <div class="luxury-card bg-light">
                                    <div class="row">
                                        <div class="col-md-1212">
                                            <h6 class="mb-2">
                                                <i class="fas fa-calculator luxury-icon"></i> Booking Summary
                                            </h6>
                                            <div class="d-flex justify-content-between mb-1">
                                                <span>Table Deposit:</span>
                                                <span id="tableDepositAmount">0 VNƒê</span>
                                            </div>
                                            <div class="d-flex justify-content-between mb-1">
                                                <span>Dishes Total:</span>
                                                <span id="dishesTotalAmount">0 VNƒê</span>
                                            </div>
                                            <div class="d-flex justify-content-between mb-1">
                                                <span>Services Total:</span>
                                                <span id="servicesTotalAmount">0 VNƒê</span>
                                            </div>
                                            <div class="d-flex justify-content-between mb-1" id="subtotalRow">
                                                <span>Subtotal:</span>
                                                <span id="subtotalAmount">0 VNƒê</span>
                                            </div>
                                            <!-- Voucher Discount Row (initially hidden) -->
                                            <div class="d-flex justify-content-between mb-1" id="voucherDiscountRow" style="display: none;">
                                                <span class="text-success">
                                                    <i class="fas fa-ticket-alt"></i> Voucher Discount:
                                                </span>
                                                <span class="text-success" id="voucherDiscountDisplay">-0 VNƒê</span>
                                            </div>
                                            <hr>
                                            <div class="d-flex justify-content-between">
                                                <strong>Total Deposit:</strong>
                                                <strong id="totalDepositAmount" style="color: var(--luxury-gold);">0 VNƒê</strong>
                                            </div>
                                        </div>
                                        <div class="col-md-1212">
                                            <div class="text-center">
                                                <i class="fas fa-info-circle luxury-icon text-info"></i>
                                                <p class="small text-muted mb-0 mt-2">
                                                    This amount will be charged as deposit for your reservation
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Hidden input to store the calculated deposit amount -->
                                <input type="hidden" 
                                       id="depositAmount" 
                                       name="depositAmount"
                                       th:field="*{depositAmount}">
                            </div>
                            
                            <!-- Voucher Code -->
                            <div class="mb-4">
                                <label for="voucherSelect" class="form-label">
                                    <i class="fas fa-ticket-alt luxury-icon"></i> Voucher Code (Optional)
                                </label>
                                <div class="input-group">
                                    <select class="form-control" id="voucherSelect" name="voucherCode">
                                        <option value="">-- Select a voucher --</option>
                                    </select>
                                    <button type="button" 
                                            class="btn btn-outline-primary" 
                                            id="validateVoucherBtn"
                                            onclick="validateSelectedVoucher()">
                                        <i class="fas fa-check"></i> Apply
                                    </button>
                                    <button type="button" 
                                            class="btn btn-outline-secondary ms-2" 
                                            onclick="testVoucherDiscount()">
                                        <i class="fas fa-bug"></i> Test
                                    </button>
                                </div>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('voucherCode')}" 
                                     th:errors="*{voucherCode}"></div>
                                
                                <!-- Voucher validation result -->
                                <div id="voucherResult" class="mt-2" style="display: none;">
                                    <div id="voucherSuccess" class="alert alert-success" style="display: none;">
                                        <i class="fas fa-check-circle"></i>
                                        <span id="voucherSuccessText"></span>
                                    </div>
                                    <div id="voucherError" class="alert alert-danger" style="display: none;">
                                        <i class="fas fa-exclamation-circle"></i>
                                        <span id="voucherErrorText"></span>
                                    </div>
                                </div>
                                
                                <small style="color: var(--luxury-gray-dark); font-size: 0.9rem; margin-top: 8px; display: block;">
                                    Select a voucher from your available vouchers to get discount on your reservation
                                </small>
                            </div>
                            
                            <!-- Special Requests -->
                            <div class="mb-4">
                                <label for="note" class="form-label">
                                    <i class="fas fa-comment-dots luxury-icon"></i> Special Requests
                                </label>
                                <textarea class="form-control" 
                                          id="note" 
                                          name="note"
                                          th:field="*{note}"
                                          th:classappend="${#fields.hasErrors('note')} ? 'is-invalid' : ''"
                                          rows="4" 
                                          maxlength="500" 
                                          placeholder="Dietary restrictions, celebration details, special arrangements, etc."></textarea>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('note')}" 
                                     th:errors="*{note}"></div>
                                <small style="color: var(--luxury-gray-dark); font-size: 0.9rem; margin-top: 8px; display: block;">
                                    Maximum 500 characters
                                </small>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="text-center">
                                <button type="submit" class="btn btn--gold me-3">
                                    <i class="fas fa-check-circle"></i>
                                    <span th:text="${bookingId != null ? 'Update Reservation' : 'Confirm Reservation'}"></span>
                                </button>
                                
                                <a href="/booking/my" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left"></i> Back to My Reservations
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Table Selection Modal -->
    <div class="modal fade" id="tableModal" tabindex="-1" aria-labelledby="tableModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tableModalLabel">
                        <i class="fas fa-chair"></i> Select Tables
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- View Toggle Buttons -->
                    <div class="row mb-4" id="tableLayoutToggle" style="display: none;">
                        <div class="col-12">
                            <div class="btn-group w-100" role="group" aria-label="View toggle">
                                <button type="button" class="btn btn-outline-info btn-lg active" 
                                        id="layoutViewBtn" onclick="switchToLayoutView()">
                                    <i class="fas fa-map me-2"></i>
                                    S∆° ƒë·ªì b√†n ƒÉn
                                </button>
                                <button type="button" class="btn btn-outline-success btn-lg" 
                                        id="tablesViewBtn" onclick="switchToTablesView()">
                                    <i class="fas fa-chair me-2"></i>
                                    Danh s√°ch b√†n
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Layout View -->
                    <div id="layoutView" class="view-content" style="display: none;">
                        <div id="tableLayoutCarousel" class="carousel slide" data-bs-ride="carousel">
                            <div class="carousel-indicators" id="tableLayoutIndicators">
                                <!-- Indicators will be generated by JavaScript -->
                            </div>
                            
                            <div class="carousel-inner" id="tableLayoutInner">
                                <!-- Carousel items will be generated by JavaScript -->
                            </div>
                            
                            <button class="carousel-control-prev" type="button" data-bs-target="#tableLayoutCarousel" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Previous</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#tableLayoutCarousel" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Next</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Tables View -->
                    <div id="tablesView" class="view-content">
                        <!-- Tables Search -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-search"></i>
                                    </span>
                                    <input type="text" class="form-control" id="tablesSearchInput" 
                                           placeholder="T√¨m ki·∫øm b√†n ƒÉn..." onkeyup="searchTables()">
                                    <button class="btn btn-outline-secondary" type="button" onclick="clearTablesSearch()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="tablesList" class="row">
                            <!-- Tables will be loaded here -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="confirmTableSelection()">Confirm Selection</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Menu Selection Modal -->
    <div class="modal fade" id="menuModal" tabindex="-1" aria-labelledby="menuModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="menuModalLabel">
                        <i class="fas fa-utensils"></i> Select Menu Items
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Menu Search -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control" id="menuSearchInput" 
                                       placeholder="T√¨m ki·∫øm m√≥n ƒÉn..." onkeyup="searchMenu()">
                                <button class="btn btn-outline-secondary" type="button" onclick="clearMenuSearch()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Menu Pagination -->
                    <div id="menuPagination" class="d-flex justify-content-center mb-4">
                        <nav aria-label="Menu pagination">
                            <ul class="pagination" id="menuPaginationList">
                                <!-- Pagination items will be generated by JavaScript -->
                            </ul>
                        </nav>
                    </div>
                    
                    <div id="menuList" class="row">
                        <!-- Menu items will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="confirmMenuSelection()">Confirm Selection</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Table Images Modal -->
    <div class="modal fade" id="tableImagesModal" tabindex="-1" aria-labelledby="tableImagesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tableImagesModalLabel">
                        <i class="fas fa-images me-2"></i>
                        H√¨nh ·∫£nh b√†n
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Table Images Carousel -->
                    <div id="tableImagesCarousel" class="carousel slide" data-bs-ride="carousel">
                        <div class="carousel-indicators" id="tableImagesIndicators">
                            <!-- Indicators will be generated by JavaScript -->
                        </div>
                        
                        <div class="carousel-inner" id="tableImagesInner">
                            <!-- Carousel items will be generated by JavaScript -->
                        </div>
                        
                        <button class="carousel-control-prev" type="button" data-bs-target="#tableImagesCarousel" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Previous</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#tableImagesCarousel" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Next</span>
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Smart Waitlist Modal -->
    <div class="modal fade" id="smartWaitlistModal" tabindex="-1" aria-labelledby="smartWaitlistModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="smartWaitlistModalLabel">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span id="popupTitle">Table Availability Issue</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Dynamic content based on conflict type -->
                    <div id="conflictContent">
                        <!-- Will be populated by JavaScript -->
                    </div>
                    
                    <!-- Waitlist Information -->
                    <div class="waitlist-info bg-light p-3 rounded mt-3">
                        <h6><i class="fas fa-clock text-warning"></i> Waitlist Information:</h6>
                        <p><strong>Estimated Wait Time:</strong> <span id="waitTime"></span></p>
                        <p><strong>Reason:</strong> <span id="waitReason"></span></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancel
                    </button>
                    <button type="button" class="btn btn-warning" onclick="joinSmartWaitlist()">
                        <i class="fas fa-clock"></i> Join Waitlist
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer Fragment -->
    <div th:insert="~{fragments/footer :: site-footer}"></div>
    
    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JS -->
    <script th:src="@{/js/main.js}" defer></script>
    
    <script>
        // Global variables to store selections
        let selectedTables = [];
        let selectedDishes = [];
        let selectedServices = [];
        let availableTables = [];
        let availableDishes = [];
        let availableServices = [];
        let voucherDiscount = 0; // Store voucher discount amount
        let availableVouchers = []; // Store available vouchers
        let tableLayouts = []; // Store table layouts
        let filteredTables = []; // For search functionality
        let filteredDishes = []; // For search functionality
        let currentMenuPage = 1;
        const itemsPerPage = 6;

        // Debug function to log all selections
        function logAllSelections() {
            console.log('üìä === CURRENT SELECTIONS DEBUG ===');
            console.log('üîç selectedTables:', selectedTables);
            console.log('üîç selectedTables.length:', selectedTables.length);
            console.log('üîç selectedDishes:', selectedDishes);
            console.log('üîç selectedDishes.length:', selectedDishes.length);
            console.log('üîç selectedServices:', selectedServices);
            console.log('üîç selectedServices.length:', selectedServices.length);
            console.log('üîç availableTables:', availableTables);
            console.log('üîç availableTables.length:', availableTables.length);
            console.log('üîç availableDishes:', availableDishes);
            console.log('üîç availableDishes.length:', availableDishes.length);
            console.log('üîç availableServices:', availableServices);
            console.log('üîç availableServices.length:', availableServices.length);
            console.log('üìä === END SELECTIONS DEBUG ===');
        }

           function loadTables() {
               const restaurantId = document.getElementById('restaurantId').value;
               const viewTablesBtn = document.getElementById('viewTablesBtn');
               
               console.log('üîç Loading tables for restaurant ID:', restaurantId);
               logAllSelections();
               
               if (restaurantId) {
                   viewTablesBtn.disabled = false;
                   return fetch(`/api/booking/restaurants/${restaurantId}/tables`)
                       .then(response => {
                           console.log('üì° API Response status:', response.status);
                           if (!response.ok) {
                               throw new Error(`HTTP error! status: ${response.status}`);
                           }
                           return response.json();
                       })
                       .then(tables => {
                           console.log('üìã Received tables:', tables);
                           availableTables = tables;
                           console.log('üìã availableTables updated:', availableTables);
                           logAllSelections();
                           
                           // Load table layouts
                           return fetch(`/api/booking/restaurants/${restaurantId}/table-layouts`)
                               .then(response => {
                                   if (response.ok) {
                                       return response.json();
                                   }
                                   return [];
                               })
                               .then(layouts => {
                                   console.log('üìã Received table layouts:', layouts);
                                   tableLayouts = layouts;
                                   return tables;
                               })
                               .catch(error => {
                                   console.log('‚ö†Ô∏è No table layouts found:', error);
                                   tableLayouts = [];
                                   return tables;
                               });
                       })
                       .then(tables => {
                           if (tables.length === 0) {
                               console.log('‚ö†Ô∏è No tables found for restaurant ID:', restaurantId);
                           } else {
                               // Render tables into modal immediately for edit mode
                               renderTablesInModal(tables);
                           }
                           
                           // Load dishes and services for this restaurant
                           return Promise.all([
                               loadDishes(restaurantId),
                               loadServices(restaurantId)
                           ]).then(() => {
                               console.log('‚úÖ All data (tables, dishes, services, layouts) loaded successfully');
                               return tables;
                           });
                       })
                       .catch(error => {
                           console.error('‚ùå Error loading tables:', error);
                           availableTables = [];
                           // Still try to load dishes and services
                           return Promise.all([
                               loadDishes(restaurantId),
                               loadServices(restaurantId)
                           ]).then(() => {
                               console.log('‚úÖ Dishes and services loaded despite table error');
                               return []; // Return empty array on error
                           }).catch(() => {
                               console.log('‚ùå Error loading dishes/services too');
                               return []; // Return empty array on error
                           });
                       });
               } else {
                   viewTablesBtn.disabled = true;
                   // Keep services section visible for debugging
                   // document.getElementById('servicesSection').style.display = 'none';
                   // Reset menu button when no restaurant selected
                   const viewMenuBtn = document.getElementById('viewMenuBtn');
                   viewMenuBtn.innerHTML = '<i class="fas fa-eye"></i> View Menu';
                   viewMenuBtn.disabled = true;
                   updateTotalAmount();
                   return Promise.resolve([]); // Return resolved promise with empty array
               }
           }

        // Toggle Table Selection
        function toggleTableSelection(tableId) {
            const checkbox = document.getElementById(`table-${tableId}`);
            if (!checkbox) return;
            
            // Toggle checkbox
            checkbox.checked = !checkbox.checked;
            
            // Update selected tables array
            if (checkbox.checked) {
                if (!selectedTables.find(t => t.tableId === tableId)) {
                    const table = availableTables.find(t => t.tableId === tableId);
                    if (table) {
                        selectedTables.push(table);
                    }
                }
            } else {
                selectedTables = selectedTables.filter(t => t.tableId !== tableId);
            }
            
            // Update hidden input
            updateSelectedTableIds();
            
            // Update total amount
            updateTotalAmount();
            
            console.log('‚úÖ Table selection toggled:', tableId, 'Selected tables:', selectedTables.length);
        }

        // Show Table Images Modal
        function showTableImages(tableId) {
            const table = availableTables.find(t => t.tableId === tableId);
            if (!table) return;
            
            const tableImages = table.images || [];
            if (tableImages.length === 0) {
                alert('B√†n n√†y ch∆∞a c√≥ h√¨nh ·∫£nh');
                return;
            }
            
            // Update modal title
            const modalTitle = document.getElementById('tableImagesModalLabel');
            modalTitle.innerHTML = `<i class="fas fa-images me-2"></i>H√¨nh ·∫£nh b√†n ${table.tableName}`;
            
            // Render carousel indicators
            const indicators = document.getElementById('tableImagesIndicators');
            indicators.innerHTML = '';
            tableImages.forEach((image, index) => {
                const button = document.createElement('button');
                button.type = 'button';
                button.setAttribute('data-bs-target', '#tableImagesCarousel');
                button.setAttribute('data-bs-slide-to', index);
                button.setAttribute('aria-label', `Slide ${index + 1}`);
                if (index === 0) {
                    button.className = 'active';
                    button.setAttribute('aria-current', 'true');
                }
                indicators.appendChild(button);
            });
            
            // Render carousel items
            const carouselInner = document.getElementById('tableImagesInner');
            carouselInner.innerHTML = '';
            tableImages.forEach((image, index) => {
                const item = document.createElement('div');
                item.className = `carousel-item ${index === 0 ? 'active' : ''}`;
                item.innerHTML = `
                    <img src="${image.url}" class="d-block w-100 carousel-image" alt="B√†n ${table.tableName} - ·∫¢nh ${index + 1}">
                    <div class="carousel-caption d-none d-md-block">
                        <h5>B√†n ${table.tableName}</h5>
                        <p>·∫¢nh ${index + 1}/${tableImages.length}</p>
                    </div>
                `;
                carouselInner.appendChild(item);
            });
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('tableImagesModal'));
            modal.show();
        }

        function renderTablesInModal(tables) {
            const tablesList = document.getElementById('tablesList');
            tablesList.innerHTML = '';
            
            // Update filtered tables
            filteredTables = tables;
            
            tables.forEach(table => {
                const statusValue = getTableStatusValue(table.status);
                const statusClass = getStatusBadgeClass(table.status);
                const statusText = getStatusDisplayName(table.status);
                
                // Create table image placeholder
                const imageUrl = table.mainImage || `data:image/svg+xml;base64,${btoa(`
                    <svg width="300" height="200" xmlns="http://www.w3.org/2000/svg">
                        <rect width="300" height="200" fill="#f8f9fa"/>
                        <text x="150" y="100" text-anchor="middle" font-family="Arial" font-size="14" fill="#6c757d">
                            ${table.tableName || 'Table'}
                        </text>
                    </svg>
                `)}`;
                
                const tableCard = document.createElement('div');
                tableCard.className = 'col-md-4 mb-3';
                tableCard.innerHTML = `
                    <div class="card table-card" data-table-id="${table.tableId}" data-deposit="${table.depositAmount || 0}">
                        <div class="card-body p-0">
                            <!-- Image section - separate click event -->
                            <div class="image-section" onclick="showTableImages(${table.tableId})" 
                                 style="cursor: pointer; position: relative;" title="Click ƒë·ªÉ xem t·∫•t c·∫£ ·∫£nh c·ªßa b√†n">
                                <img src="${imageUrl}" class="card-img-top" alt="${table.tableName}" 
                                     style="height: 200px; object-fit: cover;">
                                <div class="image-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; 
                                     background: rgba(0,0,0,0); transition: background 0.3s ease; display: flex; 
                                     align-items: center; justify-content: center;">
                                    <i class="fas fa-images text-white" style="opacity: 0; transition: opacity 0.3s ease; font-size: 2rem;"></i>
                                </div>
                            </div>
                            
                            <!-- Content section - select table event -->
                            <div class="content-section" onclick="toggleTableSelection(${table.tableId})" 
                                 style="cursor: pointer; padding: 1rem;">
                                <div class="form-check d-flex align-items-center">
                                    <input class="form-check-input table-checkbox me-2" 
                                           type="checkbox" 
                                           value="${table.tableId}"
                                           id="table-${table.tableId}"
                                           onclick="event.stopPropagation(); toggleTableSelection(${table.tableId})">
                                    <label class="form-check-label flex-grow-1" for="table-${table.tableId}">
                                        <h6 class="card-title mb-1">${table.tableName}</h6>
                                        <p class="card-text mb-1">
                                            <small class="text-muted">Capacity: ${table.capacity} people</small><br>
                                            <small class="text-muted">Deposit: ${formatCurrency(table.depositAmount || 0)}</small>
                                        </p>
                                        <span class="badge ${statusClass}">${statusText}</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                tablesList.appendChild(tableCard);
            });
            
            console.log('‚úÖ Tables rendered in modal successfully');
        }

        function loadDishes(restaurantId) {
            fetch(`/api/booking/restaurants/${restaurantId}/dishes`)
                .then(response => response.json())
                .then(dishes => {
                    console.log('üîç Raw dishes API response:', dishes);
                    console.log('üîç First dish structure:', dishes[0]);
                    
                    // Load dish images
                    const dishesWithImages = dishes.map(dish => {
                        return {
                            ...dish,
                            imageUrl: dish.imageUrl || `data:image/svg+xml;base64,${btoa(`
                                <svg width="300" height="200" xmlns="http://www.w3.org/2000/svg">
                                    <rect width="300" height="200" fill="#f8f9fa"/>
                                    <text x="150" y="100" text-anchor="middle" font-family="Arial" font-size="14" fill="#6c757d">
                                        ${dish.name || 'No Image'}
                                    </text>
                                </svg>
                            `)}`
                        };
                    });
                    
                    availableDishes = dishesWithImages;
                    console.log('üîç Dishes with images:', availableDishes);
                    
                    // Update button text based on dishes availability
                    const viewMenuBtn = document.getElementById('viewMenuBtn');
                    if (dishes.length === 0) {
                        viewMenuBtn.innerHTML = '<i class="fas fa-eye"></i> View Menu (No items available)';
                        viewMenuBtn.disabled = true;
                    } else {
                        viewMenuBtn.innerHTML = '<i class="fas fa-eye"></i> View Menu';
                        viewMenuBtn.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error loading dishes:', error);
                    const viewMenuBtn = document.getElementById('viewMenuBtn');
                    viewMenuBtn.innerHTML = '<i class="fas fa-eye"></i> View Menu (Error loading)';
                    viewMenuBtn.disabled = true;
                });
        }

        function loadServices(restaurantId) {
            console.log('üîç Loading services for restaurant ID:', restaurantId);
            
            return fetch(`/api/booking/restaurants/${restaurantId}/services`)
                .then(response => {
                    console.log('üì° Services API response status:', response.status);
                    return response.json();
                })
                .then(services => {
                    console.log('üîç Raw services API response:', services);
                    console.log('üîç First service structure:', services[0]);
                    console.log('üìã Services received:', services);
                    console.log('üìã Services count:', services.length);
                    
                    // Store services in global variable
                    availableServices = services;
                    
                    const servicesContainer = document.getElementById('servicesContainer');
                    servicesContainer.innerHTML = '';
                    
                    // Always show services section for debugging
                    document.getElementById('servicesSection').style.display = 'block';
                    
                    if (services.length === 0) {
                        console.log('‚ö†Ô∏è No services found, adding placeholder');
                        servicesContainer.innerHTML = `
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-concierge-bell fa-2x mb-2"></i>
                                <p>No additional services available for this restaurant.</p>
                            </div>
                        `;
                        return;
                    }
                    
                    services.forEach(service => {
                        console.log('‚ûï Adding service:', service.name, 'Price:', service.price);
                        const serviceCard = createServiceCard(service);
                        servicesContainer.appendChild(serviceCard);
                    });
                    
                    console.log('‚úÖ Services cards created successfully');
                })
                .catch(error => {
                    console.error('‚ùå Error loading services:', error);
                    // Still show services section even on error
                    document.getElementById('servicesSection').style.display = 'block';
                    const servicesContainer = document.getElementById('servicesContainer');
                    servicesContainer.innerHTML = `
                        <div class="text-center text-danger py-4">
                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                            <p>Error loading services. Please try again.</p>
                        </div>
                    `;
                });
        }

        function createServiceCard(service) {
            const card = document.createElement('div');
            card.className = 'service-card';
            card.dataset.serviceId = service.serviceId;
            card.dataset.price = service.price || 0;
            
            // Service icon mapping
            const iconMap = {
                'WIFI': 'fas fa-wifi',
                'PARKING': 'fas fa-parking',
                'VALET': 'fas fa-car',
                'LIVE_MUSIC': 'fas fa-music',
                'PRIVATE_ROOM': 'fas fa-door-open',
                'OUTDOOR_SEATING': 'fas fa-tree',
                'BAR': 'fas fa-cocktail',
                'KIDS_MENU': 'fas fa-child',
                'DELIVERY': 'fas fa-truck',
                'TAKEAWAY': 'fas fa-shopping-bag'
            };
            
            const iconClass = iconMap[service.name] || 'fas fa-concierge-bell';
            
            card.innerHTML = `
                <div class="service-checkbox"></div>
                <i class="service-icon ${iconClass}"></i>
                <div class="service-name">${service.name}</div>
                <div class="service-description">${service.description || 'Enhance your dining experience'}</div>
                <div class="service-price">
                    <i class="fas fa-tag"></i>
                    ${formatCurrency(service.price || 0)}
                </div>
            `;
            
            // Add click event listener
            card.addEventListener('click', function() {
                toggleServiceSelection(this);
            });
            
            return card;
        }

        function toggleServiceSelection(card) {
            console.log('üîç toggleServiceSelection() called');
            console.log('üîç Card details:', {
                serviceId: card.dataset.serviceId,
                serviceName: card.querySelector('.service-name')?.textContent,
                price: card.dataset.price,
                isSelected: card.classList.contains('selected')
            });
            
            const isSelected = card.classList.contains('selected');
            const serviceId = card.dataset.serviceId;
            const serviceName = card.querySelector('.service-name').textContent;
            const servicePrice = parseFloat(card.dataset.price) || 0;
            
            console.log('üîç Before toggle - selectedServices.length:', selectedServices.length);
            console.log('üîç Before toggle - selectedServices:', selectedServices);
            
            if (isSelected) {
                // Remove from selectedServices array
                card.classList.remove('selected');
                selectedServices = selectedServices.filter(s => s.id !== serviceId);
                console.log('‚ùå Removed service from selectedServices:', serviceName);
            } else {
                // Add to selectedServices array
                card.classList.add('selected');
                selectedServices.push({
                    id: serviceId,
                    name: serviceName,
                    price: servicePrice
                });
                console.log('‚úÖ Added service to selectedServices:', serviceName);
            }
            
            console.log('üîç After toggle - selectedServices.length:', selectedServices.length);
            console.log('üîç After toggle - selectedServices:', selectedServices);
            
            updateTotalAmount();
            saveFormState();
        }

        function getSelectedServices() {
            const selectedCards = document.querySelectorAll('.service-card.selected');
            return Array.from(selectedCards).map(card => ({
                id: card.dataset.serviceId,
                price: parseFloat(card.dataset.price) || 0
            }));
        }

        // Search and Carousel Functions
        function searchTables() {
            const searchTerm = document.getElementById('tablesSearchInput').value.toLowerCase();
            filteredTables = availableTables.filter(table => 
                table.tableName.toLowerCase().includes(searchTerm) ||
                table.capacity.toString().includes(searchTerm) ||
                table.status.toLowerCase().includes(searchTerm)
            );
            renderTablesInModal(filteredTables);
        }
        
        function clearTablesSearch() {
            document.getElementById('tablesSearchInput').value = '';
            filteredTables = availableTables;
            renderTablesInModal(filteredTables);
        }
        
        function searchMenu() {
            const searchTerm = document.getElementById('menuSearchInput').value.toLowerCase();
            filteredDishes = availableDishes.filter(dish => 
                dish.name.toLowerCase().includes(searchTerm) ||
                dish.description.toLowerCase().includes(searchTerm) ||
                dish.category.toLowerCase().includes(searchTerm)
            );
            currentMenuPage = 1;
            renderMenuPage(1);
        }
        
        function clearMenuSearch() {
            document.getElementById('menuSearchInput').value = '';
            filteredDishes = availableDishes;
            currentMenuPage = 1;
            renderMenuPage(1);
        }
        
        function switchToLayoutView() {
            document.getElementById('layoutViewBtn').classList.add('active');
            document.getElementById('tablesViewBtn').classList.remove('active');
            document.getElementById('layoutView').style.display = 'block';
            document.getElementById('tablesView').style.display = 'none';
            
            if (tableLayouts.length > 0 && document.getElementById('tableLayoutInner').children.length === 0) {
                showTableLayout();
            }
        }
        
        function switchToTablesView() {
            document.getElementById('layoutViewBtn').classList.remove('active');
            document.getElementById('tablesViewBtn').classList.add('active');
            document.getElementById('layoutView').style.display = 'none';
            document.getElementById('tablesView').style.display = 'block';
            
            if (document.getElementById('tablesList').children.length === 0) {
                renderTablesInModal(filteredTables);
            }
        }
        
        function showTableLayout() {
            if (tableLayouts.length === 0) {
                alert('Nh√† h√†ng n√†y ch∆∞a c√≥ s∆° ƒë·ªì b√†n ƒÉn');
                return;
            }
            
            const indicators = document.getElementById('tableLayoutIndicators');
            indicators.innerHTML = '';
            tableLayouts.forEach((layout, index) => {
                const button = document.createElement('button');
                button.type = 'button';
                button.setAttribute('data-bs-target', '#tableLayoutCarousel');
                button.setAttribute('data-bs-slide-to', index);
                button.setAttribute('aria-label', `Layout ${index + 1}`);
                if (index === 0) {
                    button.className = 'active';
                    button.setAttribute('aria-current', 'true');
                }
                indicators.appendChild(button);
            });
            
            const carouselInner = document.getElementById('tableLayoutInner');
            carouselInner.innerHTML = '';
            tableLayouts.forEach((layout, index) => {
                const item = document.createElement('div');
                item.className = `carousel-item ${index === 0 ? 'active' : ''}`;
                item.innerHTML = `
                    <img src="${layout.url}" class="d-block w-100 carousel-image" alt="S∆° ƒë·ªì b√†n ƒÉn ${index + 1}" style="max-height: 70vh; object-fit: contain;">
                    <div class="carousel-caption d-none d-md-block">
                        <h5>S∆° ƒë·ªì b√†n ƒÉn</h5>
                        <p>Layout ${index + 1}/${tableLayouts.length}</p>
                    </div>
                `;
                carouselInner.appendChild(item);
            });
        }
        
        function renderMenuPage(page) {
            currentMenuPage = page;
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageDishes = filteredDishes.slice(startIndex, endIndex);
            
            const menuList = document.getElementById('menuList');
            if (menuList) {
                menuList.innerHTML = '';
                pageDishes.forEach(dish => {
                    const dishCard = createDishCard(dish);
                    menuList.appendChild(dishCard);
                });
            }
            renderMenuPagination();
        }
        
        function renderMenuPagination() {
            const totalPages = Math.ceil(filteredDishes.length / itemsPerPage);
            const paginationList = document.getElementById('menuPaginationList');
            
            if (paginationList && totalPages > 1) {
                paginationList.innerHTML = '';
                
                const prevLi = document.createElement('li');
                prevLi.className = `page-item ${currentMenuPage === 1 ? 'disabled' : ''}`;
                prevLi.innerHTML = `<a class="page-link" href="#" onclick="renderMenuPage(${currentMenuPage - 1}); return false;">Tr∆∞·ªõc</a>`;
                paginationList.appendChild(prevLi);
                
                for (let i = 1; i <= totalPages; i++) {
                    const li = document.createElement('li');
                    li.className = `page-item ${i === currentMenuPage ? 'active' : ''}`;
                    li.innerHTML = `<a class="page-link" href="#" onclick="renderMenuPage(${i}); return false;">${i}</a>`;
                    paginationList.appendChild(li);
                }
                
                const nextLi = document.createElement('li');
                nextLi.className = `page-item ${currentMenuPage === totalPages ? 'disabled' : ''}`;
                nextLi.innerHTML = `<a class="page-link" href="#" onclick="renderMenuPage(${currentMenuPage + 1}); return false;">Sau</a>`;
                paginationList.appendChild(nextLi);
            }
        }
        
        function createDishCard(dish) {
            const col = document.createElement('div');
            col.className = 'col-md-4 col-sm-6';
            
            const imageUrl = dish.imageUrl || `data:image/svg+xml;base64,${btoa(`
                <svg width="300" height="200" xmlns="http://www.w3.org/2000/svg">
                    <rect width="300" height="200" fill="#f8f9fa"/>
                    <text x="150" y="100" text-anchor="middle" font-family="Arial" font-size="14" fill="#6c757d">
                        ${dish.name || 'No Image'}
                    </text>
                </svg>
            `)}`;
            const price = new Intl.NumberFormat('vi-VN').format(dish.price) + ' VNƒê';
            
            col.innerHTML = `
                <div class="card dish-card" data-dish-id="${dish.dishId}" data-price="${dish.price}">
                    <div class="card-body">
                        <div class="form-check">
                            <input class="form-check-input dish-checkbox" type="checkbox" value="${dish.dishId}" id="dish-${dish.dishId}">
                            <label class="form-check-label w-100" for="dish-${dish.dishId}">
                                <img src="${imageUrl}" class="card-img-top" alt="${dish.name}" style="height: 200px; object-fit: cover;">
                                <div class="mt-2">
                                    <h6 class="dish-name">${dish.name}</h6>
                                    <p class="dish-description">${dish.description || 'Kh√¥ng c√≥ m√¥ t·∫£'}</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="dish-price">${price}</span>
                                        <span class="dish-category">${dish.category || 'Kh√°c'}</span>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
            `;
            
            return col;
        }

        function openTablePopup() {
            console.log('üöÄ Opening table popup...');
            console.log('üìã Current selectedTables:', selectedTables);
            console.log('üìã Current selectedTableIds value:', document.getElementById('selectedTableIds').value);
            
            // Initialize filtered tables
            filteredTables = availableTables;
            
            // Check if table layouts exist
            if (tableLayouts.length > 0) {
                document.getElementById('tableLayoutToggle').style.display = 'block';
                switchToLayoutView();
            } else {
                document.getElementById('tableLayoutToggle').style.display = 'none';
                switchToTablesView();
            }
            
            const tablesList = document.getElementById('tablesList');
            tablesList.innerHTML = '';
            
            filteredTables.forEach(table => {
                const statusValue = getTableStatusValue(table.status);
                const statusClass = getStatusBadgeClass(table.status);
                const statusText = getStatusDisplayName(table.status);
                console.log('üé® Table:', table.tableName, 'Original Status:', table.status, 'Processed Status:', statusValue, 'Class:', statusClass, 'Text:', statusText);
                
                // Create table image placeholder
                const imageUrl = table.mainImage || `data:image/svg+xml;base64,${btoa(`
                    <svg width="300" height="200" xmlns="http://www.w3.org/2000/svg">
                        <rect width="300" height="200" fill="#f8f9fa"/>
                        <text x="150" y="100" text-anchor="middle" font-family="Arial" font-size="14" fill="#6c757d">
                            ${table.tableName || 'Table'}
                        </text>
                    </svg>
                `)}`;
                
                const tableCard = document.createElement('div');
                tableCard.className = 'col-md-4 mb-3';
                tableCard.innerHTML = `
                    <div class="card table-card" data-table-id="${table.tableId}" data-deposit="${table.depositAmount || 0}">
                        <div class="card-body p-0">
                            <!-- Image section - separate click event -->
                            <div class="image-section" onclick="showTableImages(${table.tableId})" 
                                 style="cursor: pointer; position: relative;" title="Click ƒë·ªÉ xem t·∫•t c·∫£ ·∫£nh c·ªßa b√†n">
                                <img src="${imageUrl}" class="card-img-top" alt="${table.tableName}" 
                                     style="height: 200px; object-fit: cover;">
                                <div class="image-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; 
                                     background: rgba(0,0,0,0); transition: background 0.3s ease; display: flex; 
                                     align-items: center; justify-content: center;">
                                    <i class="fas fa-images text-white" style="opacity: 0; transition: opacity 0.3s ease; font-size: 2rem;"></i>
                                </div>
                            </div>
                            
                            <!-- Content section - select table event -->
                            <div class="content-section" onclick="toggleTableSelection(${table.tableId})" 
                                 style="cursor: pointer; padding: 1rem;">
                                <div class="form-check d-flex align-items-center">
                                    <input class="form-check-input table-checkbox me-2" 
                                           type="checkbox" 
                                           value="${table.tableId}"
                                           id="table-${table.tableId}"
                                           onclick="event.stopPropagation(); toggleTableSelection(${table.tableId})">
                                    <label class="form-check-label flex-grow-1" for="table-${table.tableId}">
                                        <h6 class="card-title mb-1">${table.tableName}</h6>
                                        <p class="card-text mb-1">
                                            <small class="text-muted">Capacity: ${table.capacity} people</small><br>
                                            <small class="text-muted">Deposit: ${formatCurrency(table.depositAmount || 0)}</small>
                                        </p>
                                        <span class="badge ${statusClass}">${statusText}</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                tablesList.appendChild(tableCard);
            });
            
            // Restore previous selections from hidden input
            const selectedTableIds = document.getElementById('selectedTableIds').value;
            if (selectedTableIds) {
                const tableIds = selectedTableIds.split(',');
                console.log('üîÑ Restoring table selections:', tableIds);
                
                setTimeout(() => {
                    selectedTables = []; // Reset selectedTables array
                    console.log('üîÑ Starting restore process for tables:', tableIds);
                    
                    tableIds.forEach(tableId => {
                        console.log('üîç Looking for checkbox with value:', tableId);
                        const checkbox = document.querySelector(`#tableModal input[value="${tableId}"]`);
                        console.log('üîç Found checkbox:', checkbox);
                        
                        if (checkbox) {
                            checkbox.checked = true;
                            console.log('‚úÖ Checkbox checked for table:', tableId);
                            
                            const tableCard = checkbox.closest('.table-card');
                            console.log('üîç Found tableCard:', tableCard);
                            
                            if (tableCard) {
                                const deposit = parseFloat(tableCard.getAttribute('data-deposit'));
                                const tableName = tableCard.querySelector('.card-title').textContent;
                                const capacityText = tableCard.querySelector('.card-text small').textContent;
                                const capacity = parseInt(capacityText.match(/\d+/)[0]);
                                
                                console.log('üìä Table data:', {
                                    id: tableId,
                                    name: tableName,
                                    deposit: deposit,
                                    capacity: capacity
                                });
                                
                                selectedTables.push({
                                    id: tableId,
                                    name: tableName,
                                    deposit: deposit,
                                    capacity: capacity
                                });
                                console.log('‚úÖ Added to selectedTables:', tableId, tableName);
                            } else {
                                console.log('‚ùå Could not find tableCard for checkbox:', checkbox);
                            }
                        } else {
                            console.log('‚ùå Could not find checkbox for table:', tableId);
                        }
                    });
                    
                    console.log('üìã Final selectedTables array:', selectedTables);
                    updateTableSelectionUI(); // Update UI after restoring
                }, 100);
            }
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('tableModal'));
            modal.show();
        }

        function openMenuPopup() {
            // Initialize filtered dishes
            filteredDishes = availableDishes;
            
            const menuList = document.getElementById('menuList');
            menuList.innerHTML = '';
            
            if (availableDishes.length === 0) {
                menuList.innerHTML = `
                    <div class="col-12 text-center">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            No menu items available for this restaurant.
                        </div>
                    </div>
                `;
            } else {
                // Render first page with pagination
                renderMenuPage(1);
            }
            
            const modal = new bootstrap.Modal(document.getElementById('menuModal'));
            modal.show();
        }

        function confirmTableSelection() {
            console.log('üéØ confirmTableSelection() called');
            const checkboxes = document.querySelectorAll('.table-checkbox:checked');
            console.log('üéØ Found checked checkboxes:', checkboxes.length);
            selectedTables = [];
            
            checkboxes.forEach(checkbox => {
                console.log('üéØ Processing checkbox:', checkbox.value);
                const tableCard = checkbox.closest('.table-card');
                console.log('üéØ Found tableCard:', tableCard);
                
                const tableId = tableCard.getAttribute('data-table-id');
                const deposit = parseFloat(tableCard.getAttribute('data-deposit'));
                const tableName = tableCard.querySelector('.card-title').textContent;
                const capacityText = tableCard.querySelector('.card-text small').textContent;
                const capacity = parseInt(capacityText.match(/\d+/)[0]);
                
                console.log('üéØ Table data:', {
                    id: tableId,
                    name: tableName,
                    deposit: deposit,
                    capacity: capacity
                });
                
                selectedTables.push({
                    id: tableId,
                    name: tableName,
                    deposit: deposit,
                    capacity: capacity
                });
                console.log('üéØ Added to selectedTables:', tableId);
            });
            
            console.log('üéØ Final selectedTables in confirmTableSelection:', selectedTables);
            
            // Update UI
            updateTableSelectionUI();
            updateTotalAmount();
            
            // Save form state
            saveFormState();
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('tableModal'));
            modal.hide();
        }

        function confirmMenuSelection() {
            const checkboxes = document.querySelectorAll('.dish-checkbox:checked');
            selectedDishes = [];
            
            checkboxes.forEach(checkbox => {
                const dishCard = checkbox.closest('.dish-card');
                if (!dishCard) return; // Safety check
                
                const dishId = dishCard.getAttribute('data-dish-id');
                const price = parseFloat(dishCard.getAttribute('data-price'));
                const dishNameElement = dishCard.querySelector('.dish-name');
                const dishName = dishNameElement ? dishNameElement.textContent : 'Unknown Dish';
                const quantityInput = dishCard.querySelector('.quantity-control input');
                const quantity = quantityInput ? parseInt(quantityInput.value) || 1 : 1;
                
                selectedDishes.push({
                    id: dishId,
                    name: dishName,
                    price: price,
                    quantity: quantity
                });
            });
            
            // Update UI
            updateMenuSelectionUI();
            updateTotalAmount();
            
            // Save form state
            saveFormState();
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('menuModal'));
            modal.hide();
        }

        function updateTableSelectionUI() {
            const countSpan = document.getElementById('selectedTablesCount');
            const hiddenInput = document.getElementById('selectedTableIds');
            const summaryDiv = document.getElementById('selectedTablesSummary');
            const listDiv = document.getElementById('selectedTablesList');
            
            if (selectedTables.length === 0) {
                countSpan.textContent = 'No tables selected';
                hiddenInput.value = '';
                summaryDiv.style.display = 'none';
            } else {
                countSpan.textContent = `${selectedTables.length} table(s) selected`;
                // Store multiple table IDs separated by comma
                hiddenInput.value = selectedTables.map(t => t.id).join(',');
                
                // Show detailed summary
                summaryDiv.style.display = 'block';
                listDiv.innerHTML = selectedTables.map(table => `
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span><strong>${table.name}</strong> (Capacity: ${table.capacity} people)</span>
                        <span class="text-success">${formatCurrency(table.deposit)}</span>
                    </div>
                `).join('');
            }
        }

        function updateMenuSelectionUI() {
            const countSpan = document.getElementById('selectedDishesCount');
            const hiddenInput = document.getElementById('selectedDishIds');
            const summaryDiv = document.getElementById('selectedDishesSummary');
            const listDiv = document.getElementById('selectedDishesList');
            
            if (selectedDishes.length === 0) {
                countSpan.textContent = 'No items selected';
                hiddenInput.value = '';
                summaryDiv.style.display = 'none';
            } else {
                countSpan.textContent = `${selectedDishes.length} item(s) selected`;
                hiddenInput.value = selectedDishes.map(d => `${d.id}:${d.quantity}`).join(',');
                
                // Show detailed summary
                summaryDiv.style.display = 'block';
                listDiv.innerHTML = selectedDishes.map(dish => `
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span><strong>${dish.name}</strong> x${dish.quantity}</span>
                        <span class="text-success">${formatCurrency(dish.price * dish.quantity)}</span>
                    </div>
                `).join('');
            }
        }

        function updateTotalAmount() {
            let tableDeposit = 0;
            let dishesTotal = 0;
            let servicesTotal = 0;

            // Calculate table deposit
            selectedTables.forEach(table => {
                tableDeposit += Number(table.deposit) || 0;
            });

            // Calculate dishes total
            selectedDishes.forEach(dish => {
                dishesTotal += (Number(dish.price) || 0) * (Number(dish.quantity) || 1);
            });

            // Calculate services total
            selectedServices.forEach(service => {
                servicesTotal += Number(service.price) || 0;
            });

            // Update hidden input with selected service IDs only if services exist
            const serviceIdsInput = document.getElementById('selectedServiceIds');
            if (serviceIdsInput) {
                serviceIdsInput.value = selectedServices.length > 0 ? selectedServices.map(s => s.id).join(',') : serviceIdsInput.value;
            }

            // Calculate subtotal
            const subtotal = tableDeposit + dishesTotal + servicesTotal;
            
            // Update display
            document.getElementById('tableDepositAmount').textContent = formatCurrency(tableDeposit);
            document.getElementById('dishesTotalAmount').textContent = formatCurrency(dishesTotal);
            document.getElementById('servicesTotalAmount').textContent = formatCurrency(servicesTotal);
            document.getElementById('subtotalAmount').textContent = formatCurrency(subtotal);
            
            // Calculate final total with voucher discount
            const finalTotal = Math.max(0, subtotal - voucherDiscount);
            document.getElementById('totalDepositAmount').textContent = formatCurrency(finalTotal);
            
            // Update hidden input
            document.getElementById('depositAmount').value = finalTotal;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }
        
        // Form validation before submit
        function validateForm() {
            console.log('üîç validateForm() called - starting validation...');
            
            // Log current selections before validation
            logAllSelections();
            
            // First, run our comprehensive validation
            if (!validateFormBeforeSubmit()) {
                console.log('‚ùå validateFormBeforeSubmit() failed, stopping form submission');
                console.log('üîç After validation failure - checking if selections are preserved...');
                logAllSelections();
                
                // Restore form state after validation failure
                console.log('üîÑ Restoring form state after validation failure...');
                restoreFormState();
                
                return false;
            }
            
            console.log('‚úÖ validateFormBeforeSubmit() passed, proceeding with Smart Waitlist check...');
            
            // Save current form state before validation
            saveFormState();
            
            // Check if form elements exist
            const restaurantSelect = document.getElementById('restaurantId');
            const guestCountInput = document.getElementById('guestCount');
            const bookingTimeInput = document.getElementById('bookingTime');
            const selectedTableIdsInput = document.getElementById('selectedTableIds');
            
            const restaurantId = restaurantSelect.value;
            const guestCount = guestCountInput.value;
            const bookingTime = bookingTimeInput.value;
            const selectedTableIds = selectedTableIdsInput.value;
            
            // Basic validation (redundant but keeping for safety)
            if (!restaurantId || !guestCount || !bookingTime) {
                alert('Please fill in all required fields.');
                return false;
            }
            
            // Check availability with Smart Waitlist
            console.log('üîç Starting Smart Waitlist availability check...');
            checkAvailabilityAndShowPopup(restaurantId, bookingTime, guestCount, selectedTableIds);
            
            // Prevent default form submission - we'll handle it in the callback
            return false;
        }
        
        // Save form state to hidden inputs
        function saveFormState() {
            console.log('üíæ saveFormState() called - saving current selections...');
            logAllSelections();
            
            // Save table selections
            const tableIds = selectedTables.map(t => t.id).join(',');
            document.getElementById('selectedTableIds').value = tableIds;
            console.log('üíæ Saved tableIds:', tableIds);
            
            // Save dish selections
            const dishIds = selectedDishes.map(d => `${d.id}:${d.quantity}`).join(',');
            document.getElementById('selectedDishIds').value = dishIds;
            console.log('üíæ Saved dishIds:', dishIds);
            
            // Save service selections
            const serviceIds = selectedServices.map(s => s.id).join(',');
            document.getElementById('selectedServiceIds').value = serviceIds;
            console.log('üíæ Saved serviceIds:', serviceIds);
            
            console.log('üíæ Form state saved successfully');
        }
        
        // Set minimum datetime to now + 30 minutes
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            now.setMinutes(now.getMinutes() + 30);
            const minDateTime = now.toISOString().slice(0, 16);
            const bookingTimeInput = document.getElementById('bookingTime');            
            
            // Load tables if restaurant is already selected (edit mode)
            if (document.getElementById('restaurantId').value) {
                loadTables().then(() => {
                    console.log('‚úÖ Tables loaded, now restoring form state...');
                    restoreFormState();
                }).catch((error) => {
                    console.error('‚ùå Error loading tables:', error);
                    // Still try to restore form state even if tables fail to load
                    restoreFormState();
                });
            } else {
                // Restore form state immediately if no restaurant selected
                restoreFormState();
            }
            
            // Add change listener for restaurant selection
            document.getElementById('restaurantId').addEventListener('change', function() {
                loadTables();
                clearFormData();
            });
            
            // Initialize total amount calculation will be handled after restore
            
            // Add event listeners for dish checkboxes to show/hide quantity controls
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('dish-checkbox')) {
                    const quantityControl = e.target.parentElement.querySelector('.quantity-control');
                    if (quantityControl) {
                        quantityControl.style.display = e.target.checked ? 'block' : 'none';
                    }
                }
            });
            
            // Load available vouchers
            loadAvailableVouchers();
            
            // Reload vouchers when restaurant changes
            document.getElementById('restaurantId').addEventListener('change', function() {
                console.log('Restaurant changed, reloading vouchers...');
                loadAvailableVouchers();
            });
        });
        
        // Load available vouchers for the customer
        function loadAvailableVouchers() {
            const restaurantId = document.getElementById('restaurantId').value;
            console.log('Loading vouchers for restaurant:', restaurantId);
            
            // Always use demo endpoint which handles authentication internally
            const url = restaurantId ? `/api/vouchers/demo?restaurantId=${restaurantId}` : '/api/vouchers/demo';
            
            fetch(url, {
                method: 'GET',
                credentials: 'include', // Include cookies for authentication
                headers: {
                    'X-Requested-With': 'XMLHttpRequest' // Indicate AJAX request
                }
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Failed to load vouchers');
                }
            })
            .then(vouchers => {
                availableVouchers = vouchers;
                console.log('Loaded vouchers:', vouchers);
                populateVoucherDropdown();
            })
            .catch(error => {
                console.error('Error loading vouchers:', error);
                // Show empty dropdown on error
                availableVouchers = [];
                populateVoucherDropdown();
            });
        }
        
        // Populate voucher dropdown
        function populateVoucherDropdown() {
            const voucherSelect = document.getElementById('voucherSelect');
            voucherSelect.innerHTML = '<option value="">-- Select a voucher --</option>';
            
            availableVouchers.forEach(voucher => {
                const option = document.createElement('option');
                option.value = voucher.code;
                option.textContent = `${voucher.code} - ${voucher.description} (${voucher.discountType === 'PERCENT' ? voucher.discountValue + '%' : '‚Ç´' + voucher.discountValue})`;
                option.dataset.voucherId = voucher.voucherId;
                option.dataset.discountType = voucher.discountType;
                option.dataset.discountValue = voucher.discountValue;
                option.dataset.maxDiscountAmount = voucher.maxDiscountAmount;
                voucherSelect.appendChild(option);
            });
        }
        
        // Validate selected voucher
        function validateSelectedVoucher() {
            const voucherSelect = document.getElementById('voucherSelect');
            const selectedOption = voucherSelect.options[voucherSelect.selectedIndex];
            
            if (!selectedOption.value) {
                showVoucherError('Please select a voucher');
                return;
            }
            
            const restaurantId = document.getElementById('restaurantId').value;
            const bookingTime = document.getElementById('bookingTime').value;
            const guestCount = document.getElementById('guestCount').value;
            
            if (!restaurantId) {
                showVoucherError('Please select a restaurant first');
                return;
            }
            
            if (!bookingTime) {
                showVoucherError('Please select booking time first');
                return;
            }
            
            if (!guestCount) {
                showVoucherError('Please enter number of guests first');
                return;
            }
            
            // Show loading state
            const validateBtn = document.getElementById('validateVoucherBtn');
            const originalText = validateBtn.innerHTML;
            validateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Applying...';
            validateBtn.disabled = true;
            
            // Prepare request data
            const requestData = {
                code: selectedOption.value,
                restaurantId: parseInt(restaurantId),
                bookingTime: bookingTime,
                guestCount: parseInt(guestCount),
                orderAmount: 1000000 // Placeholder amount - should be calculated from actual order
            };
            
            // Make API call
            fetch('/api/vouchers/validate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.valid) {
                    // Store voucher discount amount
                    voucherDiscount = data.calculatedDiscount ? parseFloat(data.calculatedDiscount) : 0;
                    
                    const discountText = data.calculatedDiscount ? 
                        `Discount: ${formatCurrency(data.calculatedDiscount)}` : 
                        'Voucher is valid';
                    showVoucherSuccess(discountText);
                } else {
                    // Reset voucher discount on error
                    voucherDiscount = 0;
                    const errorMessage = getVoucherErrorMessage(data.reason);
                    showVoucherError(errorMessage);
                }
            })
            .catch(error => {
                console.error('Error validating voucher:', error);
                showVoucherError('Error validating voucher. Please try again.');
            })
            .finally(() => {
                // Reset button state
                validateBtn.innerHTML = originalText;
                validateBtn.disabled = false;
            });
        }
        
        // Voucher validation function (legacy - keep for compatibility)
        function validateVoucher() {
            const voucherCode = document.getElementById('voucherCode').value.trim();
            const restaurantId = document.getElementById('restaurantId').value;
            const bookingTime = document.getElementById('bookingTime').value;
            const guestCount = document.getElementById('guestCount').value;
            
            if (!voucherCode) {
                showVoucherError('Please enter a voucher code');
                return;
            }
            
            if (!restaurantId) {
                showVoucherError('Please select a restaurant first');
                return;
            }
            
            if (!bookingTime) {
                showVoucherError('Please select booking time first');
                return;
            }
            
            if (!guestCount) {
                showVoucherError('Please enter number of guests first');
                return;
            }
            
            // Show loading state
            const validateBtn = document.getElementById('validateVoucherBtn');
            const originalText = validateBtn.innerHTML;
            validateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
            validateBtn.disabled = true;
            
            // Prepare request data
            const requestData = {
                code: voucherCode,
                restaurantId: parseInt(restaurantId),
                bookingTime: bookingTime,
                guestCount: parseInt(guestCount),
                orderAmount: 1000000 // Placeholder amount - should be calculated from actual order
            };
            
            // Make API call
            fetch('/api/vouchers/validate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.valid) {
                    // Store voucher discount amount
                    voucherDiscount = data.calculatedDiscount ? parseFloat(data.calculatedDiscount) : 0;
                    
                    const discountText = data.calculatedDiscount ? 
                        `Discount: ${formatCurrency(data.calculatedDiscount)}` : 
                        'Voucher is valid';
                    showVoucherSuccess(discountText);
                } else {
                    // Reset voucher discount on error
                    voucherDiscount = 0;
                    const errorMessage = getVoucherErrorMessage(data.reason);
                    showVoucherError(errorMessage);
                }
            })
            .catch(error => {
                console.error('Error validating voucher:', error);
                showVoucherError('Error validating voucher. Please try again.');
            })
            .finally(() => {
                // Reset button state
                validateBtn.innerHTML = originalText;
                validateBtn.disabled = false;
            });
        }
        
        function showVoucherSuccess(message) {
            hideVoucherMessages();
            document.getElementById('voucherSuccessText').textContent = message;
            document.getElementById('voucherSuccess').style.display = 'block';
            document.getElementById('voucherResult').style.display = 'block';
            
            // Update voucher discount in Booking Summary
            updateVoucherDiscountInSummary();
        }
        
        function showVoucherError(message) {
            hideVoucherMessages();
            document.getElementById('voucherErrorText').textContent = message;
            document.getElementById('voucherError').style.display = 'block';
            document.getElementById('voucherResult').style.display = 'block';
        }
        
        function hideVoucherMessages() {
            document.getElementById('voucherSuccess').style.display = 'none';
            document.getElementById('voucherError').style.display = 'none';
        }
        
        function getVoucherErrorMessage(reason) {
            const errorMessages = {
                'EMPTY_CODE': 'Please enter a voucher code',
                'NOT_FOUND': 'Voucher code not found',
                'INACTIVE': 'This voucher is not active',
                'NOT_STARTED': 'This voucher is not yet active',
                'EXPIRED': 'This voucher has expired',
                'RESTAURANT_SCOPE_MISMATCH': 'This voucher is not valid for the selected restaurant',
                'MIN_ORDER_NOT_MET': 'Order amount does not meet minimum requirement',
                'GLOBAL_LIMIT_REACHED': 'This voucher has reached its usage limit',
                'PER_CUSTOMER_LIMIT_REACHED': 'You have reached the usage limit for this voucher',
                'NOT_ASSIGNED': 'This voucher is not assigned to you',
                'LIMIT_REACHED': 'You have used this voucher too many times',
                'APPLICATION_ERROR': 'Error applying voucher. Please try again.'
            };
            return errorMessages[reason] || 'Invalid voucher code';
        }

        
        // Restore form state after conflict/error
        function restoreFormState() {
            console.log('üîÑ restoreFormState() called - restoring form state...');
            console.log('üîç Current URL:', window.location.href);
            console.log('üîç Is edit mode:', window.location.href.includes('/edit'));
            
            // Debug: Check hidden input values at the start of restoreFormState
            const selectedTableIds = document.getElementById('selectedTableIds').value;
            const selectedDishIds = document.getElementById('selectedDishIds').value;
            const serviceIdsInput = document.getElementById('selectedServiceIds');
            let selectedServiceIds = serviceIdsInput ? serviceIdsInput.value : '';

            if (serviceIdsInput && !selectedServiceIds && serviceIdsInput.dataset.initialValue) {
                selectedServiceIds = serviceIdsInput.dataset.initialValue;
                serviceIdsInput.value = selectedServiceIds;
                console.log('üîÅ Restored serviceIds from initial dataset:', selectedServiceIds);
            }
            console.log('üîç Hidden input values at START of restoreFormState():');
            console.log('  - selectedTableIds:', selectedTableIds);
            console.log('  - selectedDishIds:', selectedDishIds);
            console.log('  - selectedServiceIds:', selectedServiceIds);
            
            logAllSelections();
            
            // Check if we need to load data first
            const restaurantId = document.getElementById('restaurantId').value;
            if (restaurantId && (availableTables.length === 0 || availableDishes.length === 0 || availableServices.length === 0)) {
                console.log('üîÑ Data not loaded yet, loading first...');
                loadTables().then(() => {
                    console.log('‚úÖ Data loaded, now restoring form state...');
                    performRestore();
                }).catch((error) => {
                    console.error('‚ùå Error loading data:', error);
                    // Still try to restore with whatever data we have
                    performRestore();
                });
            } else {
                console.log('üîÑ Data already loaded, proceeding with restore...');
                performRestore();
            }
            
            function performRestore() {
                console.log('üîÑ performRestore() called...');
                console.log('üîç Data availability check:');
                console.log('  - availableTables.length:', availableTables.length);
                console.log('  - availableDishes.length:', availableDishes.length);
                console.log('  - availableServices.length:', availableServices.length);
                logAllSelections();
            
            // Debug: Check booking time input value
            const bookingTimeInput = document.getElementById('bookingTime');
            console.log('üîç Booking time input value:', bookingTimeInput.value);
            console.log('üîç Booking time input type:', bookingTimeInput.type);
            
            // Fix datetime format if needed
            const dataBookingTime = bookingTimeInput.getAttribute('data-booking-time');
            console.log('üîç Data booking time attribute:', dataBookingTime);
            
            if (dataBookingTime) {
                try {
                    if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/.test(dataBookingTime)) {
                        bookingTimeInput.value = dataBookingTime;
                        console.log('üîç Set booking time to (direct):', dataBookingTime);
                    } else if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}$/.test(dataBookingTime)) {
                        bookingTimeInput.value = dataBookingTime.slice(0, 16);
                        console.log('üîç Set booking time to (trimmed seconds):', bookingTimeInput.value);
                    } else if (/Z|[+-]\d{2}:?\d{2}$/.test(dataBookingTime)) {
                        const asDate = new Date(dataBookingTime);
                        const localDate = new Date(asDate.getTime() - asDate.getTimezoneOffset() * 60000);
                        bookingTimeInput.value = localDate.toISOString().slice(0, 16);
                        console.log('üîç Set booking time to (timezone adjusted):', bookingTimeInput.value);
                    } else {
                        const normalized = dataBookingTime.replace(' ', 'T');
                        bookingTimeInput.value = normalized.length >= 16 ? normalized.slice(0, 16) : normalized;
                        console.log('üîç Set booking time to (normalized):', bookingTimeInput.value);
                    }
                } catch (error) {
                    console.error('‚ùå Error formatting booking time:', error);
                }
            }
            
            // If still no value, try to get from Thymeleaf
            if (!bookingTimeInput.value) {
                const thValue = bookingTimeInput.getAttribute('th:value');
                console.log('üîç Thymeleaf value attribute:', thValue);
                
                if (thValue) {
                    bookingTimeInput.value = thValue;
                    console.log('üîç Set booking time from Thymeleaf:', bookingTimeInput.value);
                }
            }
            
            // Restore table selection if any
            const selectedTableIds = document.getElementById('selectedTableIds').value;
            console.log('üîç selectedTableIds from hidden input:', selectedTableIds);
            if (selectedTableIds) {
                const tableIds = selectedTableIds.split(',');
                selectedTables = [];
                
                // Find tables from availableTables array and add to selectedTables
                tableIds.forEach(tableId => {
                    console.log('üîç Looking for table with ID:', tableId, 'type:', typeof tableId);
                    console.log('üîç Available tables:', availableTables.map(t => ({ id: t.tableId, type: typeof t.tableId, name: t.tableName })));
                    
                    const table = availableTables.find(t => t.tableId == tableId);
                    if (table) {
                        selectedTables.push({
                            id: tableId,
                            name: table.tableName,
                            deposit: table.depositAmount || 0,
                            capacity: table.capacity
                        });
                        console.log('‚úÖ Added table to selectedTables:', table.tableName);
                    } else {
                        console.log('‚ùå Table not found in availableTables:', tableId);
                    }
                });
                
                console.log(`‚úÖ Restored ${selectedTables.length}/${tableIds.length} tables to selectedTables array`);
                updateTableSelectionUI();
            }
            
            // Restore dish selections if any
            const selectedDishIds = document.getElementById('selectedDishIds').value;
            console.log('üîç selectedDishIds from hidden input:', selectedDishIds);
            if (selectedDishIds) {
                const dishSelections = selectedDishIds.split(',');
                selectedDishes = [];
                
                // Find dishes from availableDishes array and add to selectedDishes
                dishSelections.forEach(selection => {
                    const [dishId, quantity] = selection.split(':');
                    if (dishId && quantity) {
                        console.log('üîç Looking for dish with ID:', dishId, 'type:', typeof dishId);
                    console.log('üîç Available dishes:', availableDishes.map(d => ({ 
                        dishId: d.dishId, 
                        type: typeof d.dishId, 
                        name: d.name 
                    })));
                        
                    // Find dish by dishId field
                    const dish = availableDishes.find(d => d.dishId == dishId);
                        if (dish) {
                            selectedDishes.push({
                                id: dishId,
                                name: dish.name,
                                price: dish.price,
                                quantity: parseInt(quantity)
                            });
                            console.log('‚úÖ Added dish to selectedDishes:', dish.name, 'x' + quantity);
                        } else {
                            console.log('‚ùå Dish not found in availableDishes:', dishId);
                        }
                    }
                });
                
                console.log(`‚úÖ Restored ${selectedDishes.length}/${dishSelections.length} dishes to selectedDishes array`);
                updateMenuSelectionUI();
            }
            
            // Restore service selections if any
            const selectedServiceIds = document.getElementById('selectedServiceIds').value;
            console.log('üîç selectedServiceIds from hidden input:', selectedServiceIds);
            if (selectedServiceIds) {
                const serviceIds = selectedServiceIds.split(',');
                selectedServices = [];
                
                // Find services from availableServices array and add to selectedServices
                console.log('üîç Starting services restore process...');
                console.log('üîç serviceIds to restore:', serviceIds);
                console.log('üîç availableServices before restore:', availableServices.map(s => ({ 
                    serviceId: s.serviceId, 
                    type: typeof s.serviceId, 
                    name: s.name 
                })));
                
                serviceIds.forEach((serviceId, index) => {
                    console.log(`üîç Processing service ${index + 1}/${serviceIds.length}:`, serviceId, 'type:', typeof serviceId);
                    
                    // Find service by serviceId field
                    const service = availableServices.find(s => s.serviceId == serviceId);
                    console.log('üîç Found service:', service ? service.name : 'NOT FOUND');
                    
                    if (service) {
                        selectedServices.push({
                            id: serviceId,
                            name: service.name,
                            price: service.price || 0
                        });
                        console.log('‚úÖ Added service to selectedServices:', service.name, 'price:', service.price);
                    } else {
                        console.log('‚ùå Service not found in availableServices:', serviceId);
                        console.log('üîç Available serviceIds:', availableServices.map(s => s.serviceId));
                    }
                });
                
                console.log(`‚úÖ Restored ${selectedServices.length}/${serviceIds.length} services to selectedServices array`);
                
                // Also mark services as selected in DOM
                console.log('üîç Starting DOM marking for services...');
                serviceIds.forEach((serviceId, index) => {
                    console.log(`üîç Looking for service card ${index + 1}/${serviceIds.length} with ID:`, serviceId);
                    
                    const serviceCard = document.querySelector(`.service-card[data-service-id="${serviceId}"]`) || 
                                      document.querySelector(`.service-card[data-id="${serviceId}"]`);
                    
                    console.log('üîç Found service card:', serviceCard ? 'YES' : 'NO');
                    if (serviceCard) {
                        console.log('üîç Service card details:', {
                            id: serviceCard.getAttribute('data-service-id') || serviceCard.getAttribute('data-id'),
                            name: serviceCard.querySelector('.card-title')?.textContent || 'No title',
                            classes: serviceCard.className
                        });
                        
                        serviceCard.classList.add('selected');
                        console.log('‚úÖ Marked service as selected in DOM:', serviceId);
                    } else {
                        console.log('‚ùå Service card not found in DOM:', serviceId);
                        console.log('üîç All service cards in DOM:', document.querySelectorAll('.service-card').length);
                        console.log('üîç Available service card IDs:', Array.from(document.querySelectorAll('.service-card')).map(card => 
                            card.getAttribute('data-service-id') || card.getAttribute('data-id')
                        ));
                    }
                });
            }
            
            // Update total amount after restoring all selections
            setTimeout(() => {
                updateTotalAmount();
            }, 2000);
            
            console.log('üîÑ performRestore() completed');
            logAllSelections();
            }
            
            console.log('üîÑ restoreFormState() completed');

            // Recalculate totals once restore is done to avoid early resets
            setTimeout(() => updateTotalAmount(), 0);
        }
        
        // Test function to debug voucher discount
        function testVoucherDiscount() {
            console.log('Testing voucher discount...');
            voucherDiscount = 50000; // Set test discount
            console.log('voucherDiscount set to:', voucherDiscount);
            
            // Force update the display
            const voucherDiscountRow = document.getElementById('voucherDiscountRow');
            const voucherDiscountDisplay = document.getElementById('voucherDiscountDisplay');
            
            if (voucherDiscountRow && voucherDiscountDisplay) {
                voucherDiscountRow.style.display = 'flex';
                voucherDiscountDisplay.textContent = '-' + formatCurrency(voucherDiscount);
                console.log('Voucher discount row updated:', voucherDiscountRow.style.display);
                console.log('Voucher discount amount updated:', voucherDiscountDisplay.textContent);
            } else {
                console.error('Voucher discount elements not found!');
            }
            
            updateTotalAmount();
        }
        
        function updateVoucherDiscountInSummary() {
            console.log('updateVoucherDiscountInSummary called, voucherDiscount:', voucherDiscount);
            const voucherDiscountRow = document.getElementById('voucherDiscountRow');
            const voucherDiscountDisplay = document.getElementById('voucherDiscountDisplay');
            
            console.log('voucherDiscountRow element:', voucherDiscountRow);
            console.log('voucherDiscountDisplay element:', voucherDiscountDisplay);
            
            if (voucherDiscount > 0) {
                // Show voucher discount row
                if (voucherDiscountRow) {
                    voucherDiscountRow.style.display = 'flex';
                    console.log('Voucher discount row shown');
                }
                if (voucherDiscountDisplay) {
                    voucherDiscountDisplay.textContent = '-' + formatCurrency(voucherDiscount);
                    console.log('Voucher discount amount updated to:', '-' + formatCurrency(voucherDiscount));
                }
                
                // Update hidden inputs
                const hiddenDiscountAmount = document.getElementById('voucherDiscountAmount');
                const hiddenCodeApplied = document.getElementById('voucherCodeApplied');
                
                if (hiddenDiscountAmount) {
                    hiddenDiscountAmount.value = voucherDiscount;
                }
                
                const voucherSelect = document.getElementById('voucherSelect');
                if (voucherSelect && hiddenCodeApplied) {
                    const selectedOption = voucherSelect.options[voucherSelect.selectedIndex];
                    hiddenCodeApplied.value = selectedOption ? selectedOption.value : '';
                }
                
                // Update total amount
                updateTotalAmount();
            } else {
                // Hide voucher discount row
                if (voucherDiscountRow) {
                    voucherDiscountRow.style.display = 'none';
                    console.log('Voucher discount row hidden');
                }
                
                // Reset hidden inputs
                const hiddenDiscountAmount = document.getElementById('voucherDiscountAmount');
                const hiddenCodeApplied = document.getElementById('voucherCodeApplied');
                
                if (hiddenDiscountAmount) {
                    hiddenDiscountAmount.value = '0';
                }
                if (hiddenCodeApplied) {
                    hiddenCodeApplied.value = '';
                }
                
                updateTotalAmount();
            }
        }
        
        // Helper functions for table status display
        function getStatusBadgeClass(status) {
            const statusValue = getTableStatusValue(status);
            switch(statusValue) {
                case 'AVAILABLE':
                    return 'table-status-badge table-status-available';
                case 'OCCUPIED':
                    return 'table-status-badge table-status-occupied';
                case 'RESERVED':
                    return 'table-status-badge table-status-reserved';
                case 'CLEANING':
                    return 'table-status-badge table-status-cleaning';
                case 'MAINTENANCE':
                    return 'table-status-badge table-status-maintenance';
                default:
                    return 'table-status-badge table-status-unknown';
            }
        }
        
        function getStatusDisplayName(status) {
            const statusValue = getTableStatusValue(status);
            switch(statusValue) {
                case 'AVAILABLE':
                    return 'C√≥ s·∫µn';
                case 'OCCUPIED':
                    return 'ƒêang s·ª≠ d·ª•ng';
                case 'RESERVED':
                    return 'ƒê√£ ƒë·∫∑t';
                case 'CLEANING':
                    return 'ƒêang d·ªçn d·∫πp';
                case 'MAINTENANCE':
                    return 'B·∫£o tr√¨';
                default:
                    return statusValue;
            }
        }
        
        function getTableStatusValue(status) {
            // Handle both string and object status
            if (typeof status === 'string') {
                return status.toUpperCase(); // Convert to uppercase for consistent comparison
            } else if (status && typeof status === 'object') {
                const value = status.value || status.name || 'UNKNOWN';
                return value.toUpperCase();
            }
            return 'UNKNOWN';
        }
        
        // ==================== SMART WAITLIST FUNCTIONALITY ====================
        
        // Global variables for Smart Waitlist
        let currentAvailabilityData = null;
        let selectedAlternativeTable = null;
        
        /**
         * Check availability before form submission
         */
        function checkAvailabilityAndShowPopup(restaurantId, bookingTime, guestCount, selectedTableIds) {
            console.log('üîç Checking availability before booking...');
            
            const params = new URLSearchParams({
                restaurantId: restaurantId,
                bookingTime: bookingTime,
                guestCount: guestCount
            });
            
            if (selectedTableIds && selectedTableIds.trim() !== '') {
                params.append('selectedTableIds', selectedTableIds);
            }
            
            fetch(`/api/booking/availability-check?${params}`)
                .then(response => response.json())
                .then(data => {
                    console.log('üìä Availability check response:', data);
                    currentAvailabilityData = data;
                    
                    if (data.hasConflict) {
                        console.log('‚ö†Ô∏è Conflict detected, showing Smart Waitlist popup');
                        showSmartWaitlistPopup(data);
                    } else {
                        console.log('‚úÖ No conflicts, proceeding with booking');
                        submitBookingForm();
                    }
                })
                .catch(error => {
                    console.error('‚ùå Error checking availability:', error);
                    // Fallback to normal booking if API fails
                    submitBookingForm();
                });
        }
        
        /**
         * Show Smart Waitlist popup with conflict information
         */
        function showSmartWaitlistPopup(data) {
            console.log('üé≠ Showing Smart Waitlist popup with data:', data);
            
            // Update popup title based on conflict type
            const popupTitle = document.getElementById('popupTitle');
            if (data.conflictType === 'SPECIFIC_TABLE') {
                popupTitle.textContent = 'Selected Tables Have Conflicts';
            } else if (data.conflictType === 'NO_AVAILABLE_TABLES') {
                popupTitle.textContent = 'No Tables Available for Party Size';
            }
            
            // Populate conflict content
            populateConflictContent(data);
            
            // Populate waitlist information
            populateWaitlistInfo(data.waitlistInfo);
            
            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('smartWaitlistModal'));
            modal.show();
        }
        
        /**
         * Populate conflict content based on conflict type
         */
        function populateConflictContent(data) {
            const conflictContent = document.getElementById('conflictContent');
            
            if (data.conflictType === 'SPECIFIC_TABLE') {
                let html = '<div class="alert alert-warning"><h6><i class="fas fa-exclamation-triangle"></i> Table Conflicts Detected:</h6>';
                
                data.conflictDetails.selectedTables.forEach(table => {
                    html += `<div class="mb-2">
                        <strong>${table.tableName}</strong> (Capacity: ${table.capacity} people)
                        <ul class="mb-0 mt-1">`;
                    
                    table.conflicts.forEach(conflict => {
                        const bookingTime = new Date(conflict.bookingTime).toLocaleString('vi-VN');
                        const endTime = new Date(conflict.endTime).toLocaleString('vi-VN');
                        html += `<li>Booking ${conflict.bookingId}: ${bookingTime} - ${endTime} (${conflict.guestCount} people, ${conflict.status})</li>`;
                    });
                    
                    html += '</ul></div>';
                });
                
                html += '</div>';
                conflictContent.innerHTML = html;
                
            } else if (data.conflictType === 'NO_AVAILABLE_TABLES') {
                conflictContent.innerHTML = `
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-ban"></i> No Available Tables</h6>
                        <p class="mb-0">All tables suitable for your party size are currently booked.</p>
                    </div>
                `;
            }
        }
        
        /**
         * Populate waitlist information
         */
        function populateWaitlistInfo(waitlistInfo) {
            if (!waitlistInfo) return;
            
            const waitTimeElement = document.getElementById('waitTime');
            const waitReasonElement = document.getElementById('waitReason');
            
            if (waitlistInfo.estimatedWaitTime) {
                const waitTime = new Date(waitlistInfo.estimatedWaitTime).toLocaleString('vi-VN');
                waitTimeElement.textContent = waitTime;
            }
            
            if (waitlistInfo.reason) {
                waitReasonElement.textContent = waitlistInfo.reason;
            }
        }
        
        /**
         * Join Smart Waitlist
         */
        function joinSmartWaitlist() {
            console.log('‚è∞ User chose to join waitlist');
            
            // Get form data with null checks
            const restaurantIdElement = document.getElementById('restaurantId');
            const guestCountElement = document.getElementById('guestCount');
            const bookingTimeElement = document.getElementById('bookingTime');
            
            if (!restaurantIdElement || !guestCountElement || !bookingTimeElement) {
                console.error('‚ùå Required form elements not found');
                showNotification('Form data not found. Please refresh the page and try again.', 'error');
                return;
            }
            
            const restaurantId = restaurantIdElement.value;
            const guestCount = parseInt(guestCountElement.value);
            const preferredBookingTime = bookingTimeElement.value;
            const specialRequests = ''; // No special requests field in current form
            
            // Get selected items
            const dishIds = document.getElementById('selectedDishIds').value || '';
            const serviceIds = document.getElementById('selectedServiceIds').value || '';
            const tableIds = document.getElementById('selectedTableIds').value || '';
            
            console.log('üîç Join waitlist data:', {
                restaurantId: restaurantId,
                guestCount: guestCount,
                preferredBookingTime: preferredBookingTime,
                specialRequests: specialRequests,
                dishIds: dishIds,
                serviceIds: serviceIds,
                tableIds: tableIds
            });
            
            // Call API to join waitlist
            fetch('/api/booking/join-waitlist', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    restaurantId: parseInt(restaurantId),
                    guestCount: guestCount,
                    preferredBookingTime: preferredBookingTime,
                    specialRequests: specialRequests,
                    dishIds: dishIds,
                    serviceIds: serviceIds,
                    tableIds: tableIds
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('‚úÖ Join waitlist response:', data);
                
                if (data.success) {
                    // Close the popup
                    const modal = bootstrap.Modal.getInstance(document.getElementById('smartWaitlistModal'));
                    modal.hide();
                    
                    // Show success message
                    showNotification(`Successfully joined waitlist! Queue position: ${data.queuePosition}, Estimated wait time: ${data.estimatedWaitTime} minutes`, 'success');
                } else {
                    showNotification(data.error || 'Failed to join waitlist', 'error');
                }
            })
            .catch(error => {
                console.error('‚ùå Error joining waitlist:', error);
                showNotification('Error joining waitlist. Please try again.', 'error');
            });
        }
        
        /**
         * Validate form before submission
         */
        function validateFormBeforeSubmit() {
            console.log('üîç Validating form before submission...');
            
            // Get form data
            const restaurantId = document.getElementById('restaurantId').value;
            const guestCount = parseInt(document.getElementById('guestCount').value);
            const bookingTime = document.getElementById('bookingTime').value;
            const tableId = document.getElementById('tableId').value;
            const tableIds = document.getElementById('selectedTableIds').value;
            
            console.log('   Restaurant ID:', restaurantId);
            console.log('   Guest Count:', guestCount);
            console.log('   Booking Time:', bookingTime);
            console.log('   Table ID:', tableId);
            console.log('   Table IDs:', tableIds);
            
            // 1. Validate required fields
            if (!restaurantId) {
                showNotification('Vui l√≤ng ch·ªçn nh√† h√†ng', 'error');
                return false;
            }
            
            if (!guestCount || guestCount < 1) {
                showNotification('S·ªë l∆∞·ª£ng kh√°ch ph·∫£i √≠t nh·∫•t 1 ng∆∞·ªùi', 'error');
                return false;
            }
            
            if (guestCount > 20) {
                showNotification('S·ªë l∆∞·ª£ng kh√°ch kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 20 ng∆∞·ªùi', 'error');
                return false;
            }
            
            if (!bookingTime) {
                showNotification('Vui l√≤ng ch·ªçn th·ªùi gian ƒë·∫∑t b√†n', 'error');
                return false;
            }
            
            // 2. Validate table selection
            if (!tableId && !tableIds) {
                showNotification('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt b√†n', 'error');
                return false;
            }
            
            // 3. Validate table capacity
            if (!validateTableCapacityBeforeSubmit(guestCount, tableId, tableIds)) {
                return false;
            }
            
            console.log('‚úÖ Form validation passed');
            return true;
        }
        
        /**
         * Validate table capacity before submission
         */
        function validateTableCapacityBeforeSubmit(guestCount, tableId, tableIds) {
            console.log('üîç Validating table capacity...');
            
            if (tableId) {
                // Single table validation
                const table = availableTables.find(t => t.tableId == tableId);
                if (table) {
                    console.log('   Table capacity:', table.capacity);
                    if (guestCount > table.capacity) {
                        showNotification(`S·ªë kh√°ch (${guestCount}) v∆∞·ª£t qu√° s·ª©c ch·ª©a c·ªßa b√†n ${table.tableName} (${table.capacity} ng∆∞·ªùi)`, 'error');
                        return false;
                    }
                }
            } else if (tableIds) {
                // Multiple tables validation
                const tableIdArray = tableIds.split(',');
                let totalCapacity = 0;
                let tableNames = [];
                
                for (const tableIdStr of tableIdArray) {
                    const table = availableTables.find(t => t.tableId == tableIdStr.trim());
                    if (table) {
                        totalCapacity += table.capacity;
                        tableNames.push(table.tableName);
                    }
                }
                
                console.log('   Total capacity:', totalCapacity);
                if (guestCount > totalCapacity) {
                    showNotification(`S·ªë kh√°ch (${guestCount}) v∆∞·ª£t qu√° t·ªïng s·ª©c ch·ª©a c·ªßa c√°c b√†n ƒë√£ ch·ªçn (${totalCapacity} ng∆∞·ªùi)`, 'error');
                    return false;
                }
            }
            
            console.log('‚úÖ Table capacity validation passed');
            return true;
        }
        
        /**
         * Submit booking form (original function)
         */
        function submitBookingForm() {
            console.log('üìù Submitting booking form...');
            
            // Validate form before submission
            if (!validateFormBeforeSubmit()) {
                console.log('‚ùå Form validation failed, not submitting');
                return;
            }
            
            // Save form state before submission
            saveFormState();
            
            // Find and submit the form
            const form = document.getElementById('bookingForm');
            if (!form) {
                console.error('‚ùå Booking form not found');
                showNotification('Form not found. Please refresh the page and try again.', 'error');
                return;
            }
            
            console.log('‚úÖ Form validation passed, submitting form...');
            form.submit();
        }
        
        /**
         * Show notification
         */
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }
        
        /**
         * Clear all form data when restaurant changes
         */
        function clearFormData() {
            console.log('üîÑ Clearing form data...');
            
            // Clear selected tables
            selectedTables = [];
            document.getElementById('selectedTableIds').value = '';
            document.getElementById('selectedTablesCount').textContent = 'No tables selected';
            document.getElementById('selectedTablesSummary').style.display = 'none';
            document.getElementById('selectedTablesList').innerHTML = '';
            
            // Clear selected dishes
            selectedDishes = [];
            document.getElementById('selectedDishIds').value = '';
            document.getElementById('selectedDishesCount').textContent = 'No items selected';
            document.getElementById('selectedDishesSummary').style.display = 'none';
            document.getElementById('selectedDishesList').innerHTML = '';
            
            // Clear selected services
            document.getElementById('selectedServiceIds').value = '';
            document.querySelectorAll('#servicesContainer input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Clear guest count
            document.getElementById('guestCount').value = '';
            
            // Clear booking time
            document.getElementById('bookingTime').value = '';
            
            console.log('‚úÖ Form data cleared');
        }
        
        // ==================== END SMART WAITLIST FUNCTIONALITY ====================
    </script>
</body>
</html> 
