<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle}">Chi tiết Booking - Book Eat</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Design System CSS -->
    <link th:href="@{/css/design-system.css}" rel="stylesheet">
    <!-- Booking Detail Custom CSS -->
    <link th:href="@{/css/booking-detail.css}" rel="stylesheet">
</head>
<body class="ds-bg-white booking-detail-page">
    <!-- Header -->
    <div th:with="activeNav='bookings'"
         th:replace="~{fragments/design-system-components :: unified-header}"></div>

    <main>
        <!-- Breadcrumb Section -->
        <section class="ds-bg-gray-50" style="padding: var(--ds-space-16) 0;">
            <div class="ds-container">
                <nav class="ds-breadcrumb" aria-label="breadcrumb">
                    <ol class="ds-breadcrumb-list">
                        <li class="ds-breadcrumb-item">
                            <a th:href="@{/restaurant-owner/dashboard}">Dashboard</a>
                        </li>
                        <li class="ds-breadcrumb-item">
                            <a th:href="@{/restaurant-owner/bookings}">Danh sách Booking</a>
                        </li>
                        <li class="ds-breadcrumb-item active">
                            <span th:text="${'Booking #BK' + #numbers.formatInteger(booking.bookingId, 3)}">Chi tiết Booking</span>
                        </li>
                    </ol>
                </nav>

                <div class="ds-flex ds-flex-col ds-items-center ds-text-center ds-gap-4">
                    <h1 class="ds-heading-2" th:text="${'Booking #BK' + #numbers.formatInteger(booking.bookingId, 3)}">Chi tiết Booking</h1>
                    <p class="ds-text-large ds-text-secondary" style="max-width: 640px;">
                        Xem và quản lý thông tin chi tiết đặt bàn của khách hàng
                    </p>
                </div>
            </div>
        </section>
        <!-- Booking Actions Section -->
        <section style="padding: var(--ds-space-8) 0;">
            <div class="ds-container">
                <div class="ds-card">
                    <div class="ds-card-body ds-flex ds-flex-col ds-gap-4 ds-items-center ds-text-center">
                        <h2 class="ds-heading-3">Quản lý Booking</h2>
                        <p class="ds-text-base ds-text-secondary">
                            Thực hiện các thao tác quản lý đặt bàn cho khách hàng
                        </p>
                        <div class="ds-flex ds-gap-4 ds-flex-wrap ds-justify-center ds-mt-2" th:if="${booking != null}">
                            <!-- Status update buttons -->
                            <form th:if="${booking.status.name() == 'PENDING'}" 
                                  th:action="@{/restaurant-owner/bookings/{id}/status(id=${booking.bookingId})}" 
                                  method="post" style="display: inline;">
                                <input type="hidden" name="status" value="CONFIRMED" />
                                <button type="submit" class="ds-btn ds-btn-primary ds-btn-lg">
                                    <i class="fas fa-check"></i>
                                    Xác nhận
                                </button>
                            </form>
                            
                            <form th:if="${booking.status.name() == 'PENDING' or booking.status.name() == 'CONFIRMED'}" 
                                  th:action="@{/restaurant-owner/bookings/{id}/status(id=${booking.bookingId})}" 
                                  method="post" style="display: inline;">
                                <input type="hidden" name="status" value="CANCELLED" />
                                <button type="submit" class="ds-btn ds-btn-secondary ds-btn-lg">
                                    <i class="fas fa-times"></i>
                                    Hủy
                                </button>
                            </form>
                            
                            <form th:if="${booking.status.name() == 'CONFIRMED'}" 
                                  th:action="@{/restaurant-owner/bookings/{id}/status(id=${booking.bookingId})}" 
                                  method="post" style="display: inline;">
                                <input type="hidden" name="status" value="COMPLETED" />
                                <button type="submit" class="ds-btn ds-btn-secondary ds-btn-lg">
                                    <i class="fas fa-check-circle"></i>
                                    Hoàn thành
                                </button>
                            </form>
                            
                            <form th:if="${booking.status.name() == 'CONFIRMED'}" 
                                  th:action="@{/restaurant-owner/bookings/{id}/status(id=${booking.bookingId})}" 
                                  method="post" style="display: inline;">
                                <input type="hidden" name="status" value="NO_SHOW" />
                                <button type="submit" class="ds-btn ds-btn-secondary ds-btn-lg">
                                    <i class="fas fa-user-times"></i>
                                    No Show
                                </button>
                            </form>
                            
                            <a th:href="@{/restaurant-owner/bookings}" class="ds-btn ds-btn-outline ds-btn-lg">
                                <i class="fas fa-arrow-left"></i>
                                Quay lại danh sách
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Booking Information -->
        <section style="padding: var(--ds-space-8) 0;">
            <div class="ds-container">
                <div class="ds-grid ds-grid-auto ds-gap-8" th:if="${booking != null}">
                    <!-- Customer Information -->
                    <article class="ds-card">
                        <div class="ds-card-body ds-flex ds-flex-col ds-gap-4">
                            <div class="ds-feature-icon">
                                <i class="fas fa-user"></i>
                            </div>
                            <h2 class="ds-heading-4">Thông tin khách hàng</h2>
                            <div class="ds-flex ds-flex-col ds-gap-3">
                                <div class="ds-flex ds-flex-col ds-gap-1">
                                    <span class="ds-text-sm ds-font-medium ds-text-primary">Tên khách hàng</span>
                                    <span class="ds-text-base" th:text="${(booking.customer != null and booking.customer.user != null and booking.customer.user.fullName != null) ? booking.customer.user.fullName : 'N/A'}">Nguyễn Văn A</span>
                                </div>
                                <div class="ds-flex ds-flex-col ds-gap-1">
                                    <span class="ds-text-sm ds-font-medium ds-text-primary">Số điện thoại</span>
                                    <span class="ds-text-base" th:text="${(booking.customer != null and booking.customer.user != null and booking.customer.user.phoneNumber != null) ? booking.customer.user.phoneNumber : 'N/A'}">0123 456 789</span>
                                </div>
                                <div class="ds-flex ds-flex-col ds-gap-1">
                                    <span class="ds-text-sm ds-font-medium ds-text-primary">Email</span>
                                    <span class="ds-text-base" th:text="${(booking.customer != null and booking.customer.user != null and booking.customer.user.email != null) ? booking.customer.user.email : 'N/A'}">customer@example.com</span>
                                </div>
                                <div class="ds-flex ds-flex-col ds-gap-1">
                                    <span class="ds-text-sm ds-font-medium ds-text-primary">Địa chỉ</span>
                                    <span class="ds-text-base" th:text="${(booking.customer != null and booking.customer.user != null and booking.customer.user.address != null) ? booking.customer.user.address : 'N/A'}">123 Đường ABC, Quận 1, TP.HCM</span>
                                </div>
                            </div>
                        </div>
                    </article>

                    <!-- Booking Details -->
                    <article class="ds-card">
                        <div class="ds-card-body ds-flex ds-flex-col ds-gap-4">
                            <div class="ds-feature-icon">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                            <h2 class="ds-heading-4">Chi tiết đặt bàn</h2>
                            <div class="ds-flex ds-flex-col ds-gap-3">
                                <div class="ds-flex ds-flex-col ds-gap-1">
                                    <span class="ds-text-sm ds-font-medium ds-text-primary">Trạng thái</span>
                                    <span class="ds-badge ds-badge-primary" 
                                          th:class="${'ds-badge ' + 
                                            (booking.status.name() == 'PENDING' ? 'ds-badge-warning' : 
                                            (booking.status.name() == 'CONFIRMED' ? 'ds-badge-success' : 
                                            (booking.status.name() == 'CANCELLED' ? 'ds-badge-error' : 
                                            (booking.status.name() == 'COMPLETED' ? 'ds-badge-info' : 'ds-badge-secondary'))))}"
                                          th:text="${booking.status.name()}">PENDING</span>
                                </div>
                                <div class="ds-flex ds-flex-col ds-gap-1">
                                    <span class="ds-text-sm ds-font-medium ds-text-primary">Thời gian đặt bàn</span>
                                    <span class="ds-text-base" th:text="${#temporals.format(booking.bookingTime, 'dd/MM/yyyy HH:mm')}">29/01/2025 18:30</span>
                                </div>
                                <div class="ds-flex ds-flex-col ds-gap-1">
                                    <span class="ds-text-sm ds-font-medium ds-text-primary">Số khách</span>
                                    <span class="ds-text-base" th:text="${booking.numberOfGuests} + ' người'">4 người</span>
                                </div>
                                <div class="ds-flex ds-flex-col ds-gap-1">
                                    <span class="ds-text-sm ds-font-medium ds-text-primary">Nhà hàng</span>
                                    <span class="ds-text-base" th:text="${(booking.restaurant != null and booking.restaurant.restaurantName != null) ? booking.restaurant.restaurantName : 'N/A'}">Nhà hàng ABC</span>
                                </div>
                                <div class="ds-flex ds-flex-col ds-gap-1">
                                    <span class="ds-text-sm ds-font-medium ds-text-primary">Ghi chú</span>
                                    <span class="ds-text-base" th:text="${booking.note != null ? booking.note : 'Không có ghi chú'}">Không có ghi chú</span>
                                </div>
                            </div>
                        </div>
                    </article>
                </div>
            </div>
        </section>

        <!-- Tables and Items -->
        <section class="ds-bg-gray-50" style="padding: var(--ds-space-8) 0;">
            <div class="ds-container">
                <div class="ds-grid ds-grid-auto ds-gap-8" th:if="${booking != null}">
                    <!-- Assigned Tables -->
                    <article class="ds-card">
                        <div class="ds-card-body ds-flex ds-flex-col ds-gap-4">
                            <div class="ds-feature-icon">
                                <i class="fas fa-table"></i>
                            </div>
                            <h2 class="ds-heading-4">Bàn được phân</h2>
                            <div th:if="${booking.bookingTables != null and !booking.bookingTables.empty}">
                                <div th:each="bookingTable : ${booking.bookingTables}" class="ds-flex ds-flex-col ds-gap-2 ds-p-3 ds-bg-gray-50 ds-rounded">
                                    <span class="ds-text-base ds-font-medium" th:text="${bookingTable.table.tableName}">Bàn T1</span>
                                    <span class="ds-text-sm ds-text-secondary">Phân bàn lúc: <span th:text="${#temporals.format(bookingTable.assignedAt, 'dd/MM/yyyy HH:mm')}">29/01/2025 18:00</span></span>
                                </div>
                            </div>
                            <div th:if="${booking.bookingTables == null or booking.bookingTables.empty}">
                                <p class="ds-text-base ds-text-secondary">Chưa phân bàn</p>
                            </div>
                        </div>
                    </article>

                    <!-- Dishes and Services -->
                    <article class="ds-card">
                        <div class="ds-card-body ds-flex ds-flex-col ds-gap-4">
                            <div class="ds-feature-icon">
                                <i class="fas fa-utensils"></i>
                            </div>
                            <h2 class="ds-heading-4">Món ăn & Dịch vụ</h2>
                            
                            <!-- Dishes -->
                            <div th:if="${booking.bookingDishes != null and !booking.bookingDishes.empty}">
                                <h3 class="ds-heading-5">Món ăn</h3>
                                <div th:each="bookingDish : ${booking.bookingDishes}" class="ds-flex ds-justify-between ds-items-center ds-p-3 ds-bg-gray-50 ds-rounded ds-mb-2">
                                    <span class="ds-text-base" th:text="${bookingDish.dish.name + ' x' + bookingDish.quantity}">Phở Bò x2</span>
                                    <span class="ds-text-base ds-font-medium ds-text-primary" th:text="${#numbers.formatDecimal(bookingDish.totalPrice, 0, 'COMMA', 0, 'POINT')} + 'đ'">200.000đ</span>
                                </div>
                            </div>
                            
                            <!-- Services -->
                            <div th:if="${booking.bookingServices != null and !booking.bookingServices.empty}">
                                <h3 class="ds-heading-5">Dịch vụ</h3>
                                <div th:each="bookingService : ${booking.bookingServices}" class="ds-flex ds-justify-between ds-items-center ds-p-3 ds-bg-gray-50 ds-rounded ds-mb-2">
                                    <span class="ds-text-base" th:text="${bookingService.service.name + ' x' + bookingService.quantity}">Dịch vụ VIP x1</span>
                                    <span class="ds-text-base ds-font-medium ds-text-primary" th:text="${#numbers.formatDecimal(bookingService.totalPrice, 0, 'COMMA', 0, 'POINT')} + 'đ'">100.000đ</span>
                                </div>
                            </div>
                            
                            <div th:if="${(booking.bookingDishes == null or booking.bookingDishes.empty) and (booking.bookingServices == null or booking.bookingServices.empty)}">
                                <p class="ds-text-base ds-text-secondary">Không có món ăn hoặc dịch vụ</p>
                            </div>
                        </div>
                    </article>
                </div>
            </div>
        </section>

        <!-- Payment Summary -->
        <section style="padding: var(--ds-space-8) 0;">
            <div class="ds-container">
                <div class="ds-card">
                    <div class="ds-card-body ds-flex ds-flex-col ds-gap-4">
                        <div class="ds-feature-icon">
                            <i class="fas fa-calculator"></i>
                        </div>
                        <h2 class="ds-heading-4">Tổng kết thanh toán</h2>
                        <div class="ds-grid ds-grid-auto ds-gap-6">
                            <div class="ds-flex ds-flex-col ds-gap-3">
                                <div class="ds-flex ds-justify-between ds-items-center ds-p-3 ds-bg-gray-50 ds-rounded">
                                    <span class="ds-text-base">Tiền đặt cọc</span>
                                    <span class="ds-text-base ds-font-medium" th:text="${#numbers.formatDecimal(booking.depositAmount, 0, 'COMMA', 0, 'POINT')} + 'đ'">500.000đ</span>
                                </div>
                                <div class="ds-flex ds-justify-between ds-items-center ds-p-3 ds-bg-gray-50 ds-rounded">
                                    <span class="ds-text-base">Tổng tiền món ăn</span>
                                    <span class="ds-text-base ds-font-medium" th:text="${#numbers.formatDecimal((booking.bookingDishes != null and !booking.bookingDishes.empty) ? #aggregates.sum(booking.bookingDishes.![totalPrice]) : 0, 0, 'COMMA', 0, 'POINT')} + 'đ'">200.000đ</span>
                                </div>
                                <div class="ds-flex ds-justify-between ds-items-center ds-p-3 ds-bg-gray-50 ds-rounded">
                                    <span class="ds-text-base">Tổng tiền dịch vụ</span>
                                    <span class="ds-text-base ds-font-medium" th:text="${#numbers.formatDecimal((booking.bookingServices != null and !booking.bookingServices.empty) ? #aggregates.sum(booking.bookingServices.![totalPrice]) : 0, 0, 'COMMA', 0, 'POINT')} + 'đ'">100.000đ</span>
                                </div>
                            </div>
                            <div class="ds-flex ds-flex-col ds-gap-3">
                                <div class="ds-flex ds-justify-between ds-items-center ds-p-4 ds-bg-primary ds-text-white ds-rounded">
                                    <span class="ds-text-lg ds-font-semibold">Tổng cộng</span>
                                    <span class="ds-text-xl ds-font-bold" 
                                          th:text="${#numbers.formatDecimal(booking.depositAmount + ((booking.bookingDishes != null and !booking.bookingDishes.empty) ? #aggregates.sum(booking.bookingDishes.![totalPrice]) : 0) + ((booking.bookingServices != null and !booking.bookingServices.empty) ? #aggregates.sum(booking.bookingServices.![totalPrice]) : 0), 0, 'COMMA', 0, 'POINT')} + 'đ'">800.000đ</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Booking Timeline -->
        <section class="ds-bg-gray-50" style="padding: var(--ds-space-8) 0;">
            <div class="ds-container">
                <div class="ds-card">
                    <div class="ds-card-body ds-flex ds-flex-col ds-gap-4">
                        <div class="ds-feature-icon">
                            <i class="fas fa-history"></i>
                        </div>
                        <h2 class="ds-heading-4">Lịch sử thay đổi</h2>
                        <div class="ds-flex ds-flex-col ds-gap-4">
                            <div class="ds-flex ds-gap-3 ds-items-start ds-p-3 ds-bg-gray-50 ds-rounded">
                                <div class="ds-w-3 ds-h-3 ds-bg-primary ds-rounded-full ds-mt-1"></div>
                                <div class="ds-flex ds-flex-col ds-gap-1">
                                    <h4 class="ds-text-base ds-font-medium">Đặt bàn được tạo</h4>
                                    <p class="ds-text-sm ds-text-secondary" th:text="${#temporals.format(booking.createdAt, 'dd/MM/yyyy HH:mm')}">29/01/2025 15:30</p>
                                </div>
                            </div>
                            <div th:if="${booking.status.name() != 'PENDING'}" class="ds-flex ds-gap-3 ds-items-start ds-p-3 ds-bg-gray-50 ds-rounded">
                                <div class="ds-w-3 ds-h-3 ds-bg-primary ds-rounded-full ds-mt-1"></div>
                                <div class="ds-flex ds-flex-col ds-gap-1">
                                    <h4 class="ds-text-base ds-font-medium" th:text="${ 'Trạng thái: ' + booking.status.name()}">Trạng thái: CONFIRMED</h4>
                                    <p class="ds-text-sm ds-text-secondary" th:text="${#temporals.format(booking.updatedAt, 'dd/MM/yyyy HH:mm')}">29/01/2025 16:00</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Error state -->
    <section style="padding: var(--ds-space-8) 0;" th:if="${booking == null}">
        <div class="ds-container">
            <div class="ds-card">
                <div class="ds-card-body ds-flex ds-flex-col ds-gap-4 ds-items-center ds-text-center">
                    <div class="ds-feature-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h1 class="ds-heading-3">Không tìm thấy booking</h1>
                    <p class="ds-text-base ds-text-secondary" th:text="${error != null ? error : 'Booking không tồn tại'}">Booking không tồn tại</p>
                    <a th:href="@{/restaurant-owner/bookings}" class="ds-btn ds-btn-primary ds-btn-lg">
                        <i class="fas fa-arrow-left"></i>
                        Quay lại danh sách
                    </a>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <div th:replace="~{fragments/design-system-components :: unified-footer}"></div>
    <div th:replace="~{fragments/resy-scripts :: basic-scripts}"></div>
</body>
</html>
