<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle} ?: 'Quản lý bàn - Book Eat'">Quản lý bàn - Book Eat</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link th:href="@{/css/design-system.css}" rel="stylesheet">
    <link th:href="@{/css/restaurant-admin.css}" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .table-form-hero {
            background: linear-gradient(135deg, #0f172a, #1f2937);
            color: #f8fafc;
            padding: var(--ds-space-12) 0;
            position: relative;
        }

        .table-form-hero::after {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(234, 179, 8, 0.18), rgba(59, 130, 246, 0.18));
            pointer-events: none;
        }

        .table-form-hero > * {
            position: relative;
            z-index: 1;
        }

        .table-form-breadcrumb {
            display: flex;
            flex-wrap: wrap;
            gap: var(--ds-space-2);
            font-size: 0.9rem;
            margin-bottom: var(--ds-space-4);
            align-items: center;
        }

        .table-form-breadcrumb a {
            color: rgba(248, 250, 252, 0.8);
            text-decoration: none;
        }

        .table-form-wrapper {
            display: grid;
            gap: var(--ds-space-5);
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        }

        .table-form-grid {
            display: grid;
            gap: var(--ds-space-4);
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        }

        .table-form-grid label span {
            font-weight: 600;
            display: block;
            margin-bottom: 0.35rem;
            color: #0f172a;
        }

        .table-form-grid input,
        .table-form-grid select,
        .table-form-grid textarea {
            width: 100%;
            border-radius: var(--ds-radius-lg);
            border: 1px solid #cbd5f5;
            padding: 0.75rem 1rem;
            font-size: 0.95rem;
        }

        .table-form-grid textarea {
            min-height: 120px;
            resize: vertical;
        }

        .table-form-grid .full-col {
            grid-column: 1 / -1;
        }

        .image-upload-panel {
            border: 2px dashed #cbd5f5;
            border-radius: var(--ds-radius-2xl);
            padding: var(--ds-space-5);
            background: #f8fafc;
            text-align: center;
        }

        .image-upload-panel input[type="file"] {
            display: none;
        }

        .image-upload-placeholder {
            display: flex;
            flex-direction: column;
            gap: var(--ds-space-3);
            align-items: center;
            color: #475569;
        }

        .image-upload-placeholder i {
            font-size: 2.2rem;
            color: #94a3b8;
        }

        .current-images-grid {
            display: grid;
            gap: var(--ds-space-4);
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            margin-top: var(--ds-space-4);
        }

        .current-image-card {
            background: var(--ds-primary-white);
            border-radius: var(--ds-radius-xl);
            box-shadow: 0 12px 28px rgba(15, 23, 42, 0.08);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: var(--ds-space-3);
        }

        .current-image-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .current-image-actions {
            display: flex;
            gap: var(--ds-space-2);
            justify-content: center;
            padding-bottom: var(--ds-space-3);
        }

        .multiple-images-preview {
            display: grid;
            gap: var(--ds-space-3);
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            margin-top: var(--ds-space-4);
        }

        .preview-image-item {
            position: relative;
            border-radius: var(--ds-radius-lg);
            overflow: hidden;
            box-shadow: 0 10px 24px rgba(15, 23, 42, 0.1);
        }

        .preview-image-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .remove-preview-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(220, 38, 38, 0.88);
            border: none;
            color: #fff;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ds-btn-sm {
            padding: 0.45rem 0.85rem;
            font-size: 0.85rem;
        }

        .ds-btn-secondary {
            background: linear-gradient(135deg, #e2e8f0, #cbd5f5);
            color: #0f172a;
        }

        .ds-btn-secondary:hover {
            background: linear-gradient(135deg, #cbd5f5, #94a3b8);
            color: #0f172a;
        }

        @media (max-width: 768px) {
            .table-form-wrapper {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="ds-bg-gray-50">
    <div th:with="activeNav='restaurants'"
         th:replace="~{fragments/design-system-components :: unified-header}"></div>

    <main>
        <section class="table-form-hero">
            <div class="ds-container ds-flex ds-flex-col ds-gap-4">
                <div class="table-form-breadcrumb">
                    <a th:href="@{/restaurant-owner/dashboard}">
                        <i class="fas fa-arrow-left me-1"></i>Dashboard
                    </a>
                    <span>/</span>
                    <a th:href="@{/restaurant-owner/profile}">Hồ sơ nhà hàng</a>
                    <span>/</span>
                    <a th:href="@{'/restaurant-owner/restaurants/' + ${restaurant.restaurantId} + '/tables'}"
                       th:text="${restaurant.restaurantName}">Nhà hàng</a>
                    <span>/</span>
                    <span th:text="${pageTitle}">Tạo bàn mới</span>
                </div>

                <div>
                    <h1 class="ds-heading-2 ds-mb-2" th:text="${pageTitle}">Quản lý bàn</h1>
                    <p class="ds-text-large ds-text-secondary ds-mb-0">
                        Cập nhật thông tin bàn cho <strong th:text="${restaurant.restaurantName}">Tên nhà hàng</strong>.
                        Giữ sơ đồ chỗ ngồi nhất quán và dễ quản lý.
                    </p>
                </div>
            </div>
        </section>

        <section class="ds-container ds-flex ds-flex-col ds-gap-5 ds-mt-6">
            <div th:if="${success}" class="ds-alert ds-alert-success" th:text="${success}"></div>
            <div th:if="${error}" class="ds-alert ds-alert-error" th:text="${error}"></div>

            <div class="ds-card ds-card-elevated">
                <div class="ds-card-body ds-flex ds-flex-col ds-gap-5">
                    <h2 class="ds-heading-4 ds-mb-0">
                        <i class="fas fa-chair me-2 text-primary"></i>
                        Thông tin bàn
                    </h2>

                    <form th:action="${table.tableId != null ? '/restaurant-owner/restaurants/' + restaurant.restaurantId + '/tables/' + table.tableId + '/edit' : '/restaurant-owner/restaurants/' + restaurant.restaurantId + '/tables/create'}"
                          th:object="${table}"
                          method="post"
                          enctype="multipart/form-data"
                          class="ds-flex ds-flex-col ds-gap-5">

                        <div class="table-form-grid">
                            <label>
                                <span>Tên bàn *</span>
                                <input type="text" th:field="*{tableName}" placeholder="Bàn VIP 01" required>
                            </label>

                            <label>
                                <span>Sức chứa *</span>
                                <input type="number" th:field="*{capacity}" min="1" max="20" placeholder="4" required>
                            </label>

                            <label>
                                <span>Trạng thái *</span>
                                <select th:field="*{status}" required>
                                    <option value="AVAILABLE">Có sẵn</option>
                                    <option value="OCCUPIED">Đang sử dụng</option>
                                    <option value="MAINTENANCE">Bảo trì</option>
                                    <option value="CLEANING">Đang dọn dẹp</option>
                                </select>
                            </label>

                            <label>
                                <span>Số tiền đặt cọc (VNĐ) *</span>
                                <input type="number" th:field="*{depositAmount}" placeholder="100000" min="0" step="1000" required>
                            </label>

                            <label class="full-col">
                                <span>Ảnh bàn (có thể tải nhiều ảnh)</span>
                                <div class="image-upload-panel" onclick="document.getElementById('tableImages').click()">
                                    <input type="file"
                                           id="tableImages"
                                           name="tableImages"
                                           accept="image/*"
                                           multiple
                                           onchange="previewMultipleImages(this, 'table-images-preview')">

                                    <div class="image-upload-placeholder" id="table-images-preview">
                                        <i class="fas fa-images"></i>
                                        <div>
                                            <strong>Thả ảnh của bạn vào đây hoặc bấm để chọn</strong>
                                            <p class="ds-text-small ds-text-secondary ds-mb-0">Hỗ trợ PNG, JPG, WebP (tối đa 20MB mỗi ảnh)</p>
                                        </div>
                                    </div>

                                    <div th:if="${table.hasImages()}" class="ds-flex ds-flex-col ds-gap-4 ds-mt-4">
                                        <h3 class="ds-heading-6 ds-mb-0">Ảnh đã tải lên</h3>
                                        <div class="current-images-grid">
                                            <div th:each="image, iterStat : ${table.tableImages}" class="current-image-card">
                                                <img th:src="${image.url}"
                                                     th:alt="${table.tableName + ' - Ảnh ' + (iterStat.index + 1)}"
                                                     loading="lazy">
                                                <div class="current-image-actions">
                                                    <a th:href="${image.url}" target="_blank" class="ds-btn ds-btn-secondary ds-btn-sm">
                                                        <i class="fas fa-eye"></i> Xem
                                                    </a>
                                                    <button type="button"
                                                            class="ds-btn ds-btn-danger ds-btn-sm"
                                                            th:onclick="'deleteTableImage(' + ${image.mediaId} + ')'">
                                                        <i class="fas fa-trash"></i> Xóa
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="ds-flex ds-justify-center">
                                            <button type="button"
                                                    class="ds-btn ds-btn-secondary ds-btn-sm"
                                                    onclick="removeCurrentImages('tableImages', 'table-images-preview')">
                                                <i class="fas fa-upload"></i> Tải ảnh khác
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </label>
                        </div>

                        <div class="ds-flex ds-gap-3 ds-flex-wrap">
                            <button type="submit" class="ds-btn ds-btn-primary ds-btn-lg">
                                <i class="fas fa-save"></i>
                                <span th:text="${table.tableId != null ? 'Cập nhật bàn' : 'Tạo bàn mới'}">Tạo bàn mới</span>
                            </button>
                            <a th:href="@{'/restaurant-owner/restaurants/' + ${restaurant.restaurantId} + '/tables'}"
                               class="ds-btn ds-btn-secondary ds-btn-lg">
                                <i class="fas fa-rotate-left"></i> Hủy
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </section>
    </main>

    <div th:replace="~{fragments/design-system-components :: unified-footer}"></div>
    <div th:replace="~{fragments/resy-scripts :: basic-scripts}"></div>

    <script>
        function previewMultipleImages(input, previewId) {
            const preview = document.getElementById(previewId);
            const files = input.files;

            if (!preview) return;

            if (files.length === 0) {
                preview.innerHTML = `
                    <div class="image-upload-placeholder">
                        <i class="fas fa-images"></i>
                        <div>
                            <strong>Thả ảnh của bạn vào đây hoặc bấm để chọn</strong>
                            <p class="ds-text-small ds-text-secondary ds-mb-0">Hỗ trợ PNG, JPG, WebP (tối đa 20MB mỗi ảnh)</p>
                        </div>
                    </div>
                `;
                return;
            }

            let html = '<div class="multiple-images-preview">';
            Array.from(files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    html += `
                        <div class="preview-image-item">
                            <img src="${event.target.result}" alt="Preview ${index + 1}">
                            <button type="button"
                                    class="remove-preview-btn"
                                    onclick="removePreviewImage(${index}, '${previewId}')">
                                &times;
                            </button>
                        </div>
                    `;
                    if (index === files.length - 1) {
                        preview.innerHTML = html + '</div>';
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        function removePreviewImage(index, previewId) {
            const input = document.getElementById('tableImages');
            if (!input) return;

            const files = Array.from(input.files);
            files.splice(index, 1);

            const dataTransfer = new DataTransfer();
            files.forEach(file => dataTransfer.items.add(file));
            input.files = dataTransfer.files;

            previewMultipleImages(input, previewId);
        }

        function removeCurrentImages(inputId, previewId) {
            const input = document.getElementById(inputId);
            if (input) {
                input.value = '';
                previewMultipleImages(input, previewId);
            }
        }

        function deleteTableImage(mediaId) {
            if (!confirm('Bạn có chắc chắn muốn xóa ảnh này?')) {
                return;
            }

            const pathParts = window.location.pathname.split('/');
            const restaurantId = pathParts[3];
            const tableId = pathParts[5];

            if (!restaurantId || !tableId) {
                alert('Không thể xác định nhà hàng hoặc bàn.');
                return;
            }

            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/restaurant-owner/restaurants/${restaurantId}/tables/${tableId}/images/delete/${mediaId}`;

            const csrfToken = document.querySelector('meta[name="_csrf"]');
            if (csrfToken) {
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = '_csrf';
                csrfInput.value = csrfToken.getAttribute('content');
                form.appendChild(csrfInput);
            }

            document.body.appendChild(form);
            form.submit();
        }
    </script>
</body>
</html>
