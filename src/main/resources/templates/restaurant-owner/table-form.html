<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle}">Chỉnh sửa bàn - Table Management</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Dashboard CSS -->
    <link th:href="@{/css/dashboard.css}" rel="stylesheet">

    <style>
        .table-form-page {
            background: var(--dashboard-bg);
        }

        .form-content-header {
            margin-bottom: 2rem;
        }

        .form-content-header .content-title {
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--dashboard-black);
            margin-bottom: 0.5rem;
        }

        .form-content-header .content-subtitle {
            color: var(--dashboard-gray);
            font-size: 0.95rem;
        }

        .form-card {
            background: var(--dashboard-white);
            border: 1px solid var(--dashboard-border);
            border-radius: 16px;
            box-shadow: 0 12px 32px rgba(15, 23, 42, 0.08);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .form-card-header {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--dashboard-border);
        }

        .form-card-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--dashboard-black);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-card-header h2 i {
            color: var(--primary-color);
        }

        .form-grid {
            display: grid;
            gap: 1.5rem;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-weight: 500;
            color: var(--dashboard-black);
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--dashboard-border);
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.2s;
            background: var(--dashboard-white);
            color: var(--dashboard-black);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .image-upload-panel {
            border: 2px dashed var(--dashboard-border);
            border-radius: 12px;
            padding: 2rem;
            background: var(--dashboard-bg);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .image-upload-panel:hover {
            border-color: var(--primary-color);
            background: rgba(59, 130, 246, 0.05);
        }

        .image-upload-panel input[type="file"] {
            display: none;
        }

        .image-upload-placeholder {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: center;
            color: var(--dashboard-gray);
        }

        .image-upload-placeholder i {
            font-size: 3rem;
            color: var(--dashboard-gray);
            opacity: 0.5;
        }

        .current-images-grid {
            display: grid;
            gap: 1rem;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            margin-top: 1.5rem;
        }

        .current-image-card {
            background: var(--dashboard-white);
            border: 1px solid var(--dashboard-border);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
        }

        .current-image-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .current-image-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            padding: 1rem;
        }

        .multiple-images-preview {
            display: grid;
            gap: 1rem;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            margin-top: 1.5rem;
        }

        .preview-image-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.1);
        }

        .preview-image-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .remove-preview-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(220, 38, 38, 0.9);
            border: none;
            color: #fff;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .remove-preview-btn:hover {
            background: rgba(220, 38, 38, 1);
            transform: scale(1.1);
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--dashboard-border);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.95rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-secondary {
            background: var(--dashboard-white);
            color: var(--dashboard-black);
            border: 1px solid var(--dashboard-border);
        }

        .btn-secondary:hover {
            background: var(--dashboard-bg);
            border-color: var(--dashboard-gray);
        }

        .btn-danger {
            background: #DC2626;
            color: white;
        }

        .btn-danger:hover {
            background: #B91C1C;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .alert {
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
        }

        .alert-success {
            background: #D1FAE5;
            color: #065F46;
            border: 1px solid #A7F3D0;
        }

        .alert-error {
            background: #FEE2E2;
            color: #991B1B;
            border: 1px solid #FCA5A5;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            .form-card {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body class="table-form-page">
    <!-- Dashboard Header -->
    <header class="dashboard-header">
        <div class="header-content">
            <div class="header-left">
                <a href="/" class="logo">Book Eat</a>
            </div>
            
            <div class="header-right">
                <div class="search-bar">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" placeholder="Tìm kiếm...">
                </div>
                
                <div class="user-info dropdown">
                    <div class="user-avatar" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-details">
                        <h5 sec:authentication="name">Restaurant Owner</h5>
                        <p>Quản lý nhà hàng</p>
                    </div>
                
                    <!-- Dropdown menu -->
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                        <li>
                            <a class="dropdown-item" th:href="@{/auth/profile}">
                                <i class="fas fa-user me-2"></i>
                                Profile
                            </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <form th:action="@{/logout}" method="post" class="d-inline">
                                <button type="submit" class="dropdown-item border-0 bg-transparent w-100 text-start">
                                    <i class="fas fa-sign-out-alt me-2"></i>
                                    Đăng xuất
                                </button>
                            </form>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Dashboard Layout -->
    <div class="dashboard-layout">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="sidebar-content">
                <div class="sidebar-brand">
                    <div class="sidebar-brand-icon">
                        <i class="fas fa-chair"></i>
                    </div>
                    <div class="sidebar-brand-text">
                        <h3>Quản lý bàn</h3>
                        <p>V 1.0</p>
                    </div>
                </div>
                
                <ul class="sidebar-menu">
                    <li>
                        <a th:href="${restaurant != null ? '/restaurant-owner/restaurants/' + restaurant.restaurantId + '/dashboard' : '/restaurant-owner/dashboard'}">
                            <i class="fas fa-chart-line"></i>
                            Tổng quan
                        </a>
                    </li>
                    <li>
                        <a th:href="${restaurant != null ? '/restaurant-owner/bookings?restaurantId=' + restaurant.restaurantId : '/restaurant-owner/bookings'}">
                            <i class="fas fa-calendar-check"></i>
                            Booking
                        </a>
                    </li>
                    <li>
                        <a th:href="${restaurant != null ? '/restaurant-owner/restaurants/' + restaurant.restaurantId + '/tables' : '/restaurant-owner/tables'}" class="active">
                            <i class="fas fa-chair"></i>
                            Quản lý bàn
                        </a>
                    </li>
                    <li>
                        <a href="/restaurant-owner/profile">
                            <i class="fas fa-store"></i>
                            Hồ sơ nhà hàng
                        </a>
                    </li>
                    <li>
                        <a th:href="${restaurant != null ? '/restaurant-owner/restaurants/' + restaurant.restaurantId + '/dishes' : '/restaurant-owner/menu'}">
                            <i class="fas fa-utensils"></i>
                            Thực đơn
                        </a>
                    </li>
                    <li>
                        <a href="/restaurant-owner/payments">
                            <i class="fas fa-credit-card"></i>
                            Thanh toán
                        </a>
                    </li>
                    <li>
                        <a href="/restaurant-owner/vouchers" th:href="${restaurant != null ? '/restaurant-owner/vouchers?restaurantId=' + restaurant.restaurantId : '/restaurant-owner/vouchers'}">
                            <i class="fas fa-ticket-alt"></i>
                            Voucher
                        </a>
                    </li>
                    <li>
                        <a th:href="${restaurant != null ? '/restaurant-owner/chat?restaurantId=' + restaurant.restaurantId : '/restaurant-owner/chat'}">
                            <i class="fas fa-comments"></i>
                            Tin nhắn
                        </a>
                    </li>
                    <li>
                        <a href="/restaurant-owner/reports">
                            <i class="fas fa-chart-bar"></i>
                            Báo cáo
                        </a>
                    </li>
                </ul>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <div class="form-content-header">
                <h1 class="content-title" th:text="${pageTitle}">Chỉnh sửa bàn</h1>
                <p class="content-subtitle">
                    Cập nhật thông tin bàn cho <strong th:text="${restaurant.restaurantName}">Nhà hàng</strong>.
                    Giữ sơ đồ chỗ ngồi nhất quán và dễ quản lý.
                </p>
            </div>

            <!-- Flash Messages -->
            <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
            <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

            <!-- Form Card -->
            <div class="form-card">
                <div class="form-card-header">
                    <h2>
                        <i class="fas fa-chair"></i>
                        Thông tin bàn
                    </h2>
                </div>

                <form th:action="${table.tableId != null ? '/restaurant-owner/restaurants/' + restaurant.restaurantId + '/tables/' + table.tableId + '/edit' : '/restaurant-owner/restaurants/' + restaurant.restaurantId + '/tables/create'}"
                      th:object="${table}"
                      method="post"
                      enctype="multipart/form-data">

                    <div class="form-grid">
                        <div class="form-group">
                            <label>Tên bàn *</label>
                            <input type="text" th:field="*{tableName}" placeholder="Bàn VIP 01" required>
                        </div>

                        <div class="form-group">
                            <label>Sức chứa *</label>
                            <input type="number" th:field="*{capacity}" min="1" max="20" placeholder="4" required>
                        </div>

                        <div class="form-group">
                            <label>Trạng thái *</label>
                            <select th:field="*{status}" required>
                                <option value="AVAILABLE">Có sẵn</option>
                                <option value="OCCUPIED">Đang sử dụng</option>
                                <option value="MAINTENANCE">Bảo trì</option>
                                <option value="CLEANING">Đang dọn dẹp</option>
                                <option value="RESERVED">Đã đặt</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Số tiền đặt cọc (VNĐ) *</label>
                            <input type="number" th:field="*{depositAmount}" placeholder="100000" min="0" step="1000" required>
                        </div>

                        <div class="form-group full-width">
                            <label>Ảnh bàn (có thể tải nhiều ảnh)</label>
                            <div class="image-upload-panel" onclick="document.getElementById('tableImages').click()">
                                <input type="file"
                                       id="tableImages"
                                       name="tableImages"
                                       accept="image/*"
                                       multiple
                                       onchange="previewMultipleImages(this, 'table-images-preview')">

                                <div class="image-upload-placeholder" id="table-images-preview">
                                    <i class="fas fa-images"></i>
                                    <div>
                                        <strong>Thả ảnh của bạn vào đây hoặc bấm để chọn</strong>
                                        <p style="margin: 0.5rem 0 0 0; font-size: 0.85rem; opacity: 0.7;">Hỗ trợ PNG, JPG, WebP (tối đa 20MB mỗi ảnh)</p>
                                    </div>
                                </div>

                                <div th:if="${table.hasImages()}" style="margin-top: 1.5rem;">
                                    <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: var(--dashboard-black);">Ảnh đã tải lên</h3>
                                    <div class="current-images-grid">
                                        <div th:each="image, iterStat : ${table.tableImages}" class="current-image-card">
                                            <img th:src="${image.url}"
                                                 th:alt="${table.tableName + ' - Ảnh ' + (iterStat.index + 1)}"
                                                 loading="lazy">
                                            <div class="current-image-actions">
                                                <a th:href="${image.url}" target="_blank" class="btn btn-secondary btn-sm">
                                                    <i class="fas fa-eye"></i> Xem
                                                </a>
                                                <button type="button"
                                                        class="btn btn-danger btn-sm"
                                                        th:attr="data-media-id=${image.mediaId}"
                                                        onclick="deleteTableImage(this.dataset.mediaId)">
                                                    <i class="fas fa-trash"></i> Xóa
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="text-align: center; margin-top: 1rem;">
                                        <button type="button"
                                                class="btn btn-secondary btn-sm"
                                                onclick="removeCurrentImages('tableImages', 'table-images-preview')">
                                            <i class="fas fa-upload"></i> Tải ảnh khác
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary text-dark">
                            <i class="fas fa-save"></i>
                            <span th:text="${table.tableId != null ? 'Cập nhật bàn' : 'Tạo bàn mới'}">Tạo bàn mới</span>
                        </button>
                        <a th:href="@{'/restaurant-owner/restaurants/' + ${restaurant.restaurantId} + '/tables'}"
                           class="btn btn-secondary text-dark">
                            <i class="fas fa-times"></i> Hủy
                        </a>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        function previewMultipleImages(input, previewId) {
            const preview = document.getElementById(previewId);
            const files = input.files;

            if (!preview) return;

            if (files.length === 0) {
                preview.innerHTML = `
                    <div class="image-upload-placeholder">
                        <i class="fas fa-images"></i>
                        <div>
                            <strong>Thả ảnh của bạn vào đây hoặc bấm để chọn</strong>
                            <p style="margin: 0.5rem 0 0 0; font-size: 0.85rem; opacity: 0.7;">Hỗ trợ PNG, JPG, WebP (tối đa 20MB mỗi ảnh)</p>
                        </div>
                    </div>
                `;
                return;
            }

            let html = '<div class="multiple-images-preview">';
            let loadedCount = 0;
            
            Array.from(files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    html += `
                        <div class="preview-image-item">
                            <img src="${event.target.result}" alt="Preview ${index + 1}">
                            <button type="button"
                                    class="remove-preview-btn"
                                    onclick="removePreviewImage(${index}, '${previewId}')">
                                &times;
                            </button>
                        </div>
                    `;
                    loadedCount++;
                    if (loadedCount === files.length) {
                        preview.innerHTML = html + '</div>';
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        function removePreviewImage(index, previewId) {
            const input = document.getElementById('tableImages');
            if (!input) return;

            const files = Array.from(input.files);
            files.splice(index, 1);

            const dataTransfer = new DataTransfer();
            files.forEach(file => dataTransfer.items.add(file));
            input.files = dataTransfer.files;

            previewMultipleImages(input, previewId);
        }

        function removeCurrentImages(inputId, previewId) {
            const input = document.getElementById(inputId);
            if (input) {
                input.value = '';
                previewMultipleImages(input, previewId);
            }
        }

        function deleteTableImage(mediaId) {
            if (!confirm('Bạn có chắc chắn muốn xóa ảnh này?')) {
                return;
            }

            const pathParts = window.location.pathname.split('/');
            const restaurantId = pathParts[3];
            const tableId = pathParts[5];

            if (!restaurantId || !tableId) {
                alert('Không thể xác định nhà hàng hoặc bàn.');
                return;
            }

            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/restaurant-owner/restaurants/${restaurantId}/tables/${tableId}/images/delete/${mediaId}`;

            const csrfToken = document.querySelector('meta[name="_csrf"]');
            if (csrfToken) {
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = '_csrf';
                csrfInput.value = csrfToken.getAttribute('content');
                form.appendChild(csrfInput);
            }

            document.body.appendChild(form);
            form.submit();
        }
    </script>
</body>
</html>
