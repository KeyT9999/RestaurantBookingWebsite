<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle}">Quản lý Bàn - Table Management</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Dashboard CSS -->
    <link th:href="@{/css/dashboard.css}" rel="stylesheet">
</head>
<body class="tables-page">
    <!-- Dashboard Header -->
    <header class="dashboard-header">
        <div class="header-content">
            <div class="header-left">
                <a href="/" class="logo">Book Eat</a>
                
                <!-- Restaurant Selector -->
                <div class="restaurant-selector" th:if="${restaurants != null and !restaurants.empty}">
                    <div class="restaurant-dropdown" onclick="toggleRestaurantMenu()">
                        <div class="restaurant-info">
                            <div class="restaurant-icon">
                                <i class="fas fa-store"></i>
                            </div>
                            <div class="restaurant-details">
                                <h4 th:text="${currentRestaurant != null ? currentRestaurant.restaurantName : 'Chọn nhà hàng'}">Nhà hàng mặc định</h4>
                                <p th:text="${currentRestaurant != null ? currentRestaurant.address : 'Địa chỉ nhà hàng'}">Địa chỉ nhà hàng</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-down dropdown-arrow"></i>
                    </div>
                    
                    <div class="restaurant-menu" id="restaurantMenu">
                        <div th:each="restaurant, iterStat : ${restaurants}" 
                             class="restaurant-item" 
                             th:classappend="${restaurant.restaurantId == restaurantId ? 'active' : ''}"
                             th:attr="data-restaurant-id=${restaurant.restaurantId}"
                             onclick="selectRestaurant(this.dataset.restaurantId)">
                            <div class="restaurant-info">
                                <div class="restaurant-icon">
                                    <i class="fas fa-store"></i>
                                </div>
                                <div class="restaurant-details">
                                    <h4 th:text="${restaurant.restaurantName}">Tên nhà hàng</h4>
                                    <p th:text="${restaurant.address}">Địa chỉ</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="header-right">
                <div class="search-bar">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" placeholder="Tìm kiếm...">
                </div>
                
                <div class="user-info dropdown">
                    <div class="user-avatar" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-details">
                        <h5 sec:authentication="name">Restaurant Owner</h5>
                        <p>Quản lý nhà hàng</p>
                    </div>
                
                    <!-- Dropdown menu -->
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                        <li>
                            <a class="dropdown-item" th:href="@{/auth/profile}">
                                <i class="fas fa-user me-2"></i>
                                Profile
                            </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item" th:href="@{/logout}">
                                <i class="fas fa-sign-out-alt me-2"></i>
                                Đăng xuất
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Dashboard Layout -->
    <div class="dashboard-layout">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="sidebar-content">
                <div class="sidebar-brand">
                    <div class="sidebar-brand-icon">
                        <i class="fas fa-tachometer-alt"></i>
                    </div>
                    <div class="sidebar-brand-text">
                        <h3>Dashboard</h3>
                        <p>V 1.0</p>
                    </div>
                </div>
                
                <ul class="sidebar-menu">
                    <li>
                        <a href="/restaurant-owner/dashboard" th:href="${restaurantId != null ? '/restaurant-owner/restaurants/' + restaurantId + '/dashboard' : '/restaurant-owner/dashboard'}">
                            <i class="fas fa-chart-line"></i>
                            Tổng quan
                        </a>
                    </li>
                    <li>
                        <a href="/restaurant-owner/bookings" th:href="${restaurantId != null ? '/restaurant-owner/bookings?restaurantId=' + restaurantId : '/restaurant-owner/bookings'}">
                            <i class="fas fa-calendar-check"></i>
                            Booking
                        </a>
                    </li>
                    <li>
                        <a href="/restaurant-owner/tables" th:href="${restaurantId != null ? '/restaurant-owner/restaurants/' + restaurantId + '/tables' : '/restaurant-owner/tables'}" class="active">
                            <i class="fas fa-chair"></i>
                            Quản lý bàn
                        </a>
                    </li>
                    <li>
                        <a href="/restaurant-owner/profile">
                            <i class="fas fa-store"></i>
                            Hồ sơ nhà hàng
                        </a>
                    </li>
                    <li>
                        <a href="/restaurant-owner/menu" th:href="${restaurantId != null ? '/restaurant-owner/restaurants/' + restaurantId + '/dishes' : '/restaurant-owner/menu'}">
                            <i class="fas fa-utensils"></i>
                            Thực đơn
                        </a>
                    </li>
                    <li>
                        <a href="/restaurant-owner/payments">
                            <i class="fas fa-credit-card"></i>
                            Thanh toán
                        </a>
                    </li>
                    <li>
                        <a href="/restaurant-owner/chat" th:href="${restaurantId != null ? '/restaurant-owner/chat?restaurantId=' + restaurantId : '/restaurant-owner/chat'}">
                            <i class="fas fa-comments"></i>
                            Tin nhắn
                            <span class="menu-badge" id="bookings-unread-badge" style="display: none;">0</span>
                        </a>
                    </li>
                    <li>
                        <a href="/restaurant-owner/reports">
                            <i class="fas fa-chart-bar"></i>
                            Báo cáo
                        </a>
                    </li>
                </ul>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <div class="content-header">
                <h1 class="content-title">Quản lý Bàn</h1>
                <p class="content-subtitle">Quản lý và theo dõi trạng thái bàn của nhà hàng</p>
            </div>

            <!-- Error Message -->
            <div th:if="${error != null}" class="alert alert-danger" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <span th:text="${error}">Có lỗi xảy ra</span>
            </div>

            <!-- Success Message -->
            <div th:if="${success != null}" class="alert alert-success" role="alert">
                <i class="fas fa-check-circle me-2"></i>
                <span th:text="${success}"></span>
            </div>

            <div class="kpi-grid tables-kpi">
                <div class="kpi-card total">
                    <div class="kpi-label">Tổng số bàn</div>
                    <div class="kpi-value" th:text="${tables != null ? tables.size() : 0}">0</div>
                    <div class="kpi-meta" th:text="${totalCapacity != null ? totalCapacity + ' chỗ ngồi' : '0 chỗ ngồi'}">0 chỗ ngồi</div>
                </div>
                <div class="kpi-card available">
                    <div class="kpi-label">Bàn đang trống</div>
                    <div class="kpi-value" th:text="${availableTables != null ? availableTables : 0}">0</div>
                    <div class="kpi-meta">Sẵn sàng đón khách</div>
                </div>
                <div class="kpi-card occupied">
                    <div class="kpi-label">Bàn đang phục vụ</div>
                    <div class="kpi-value" th:text="${occupiedTables != null ? occupiedTables : 0}">0</div>
                    <div class="kpi-meta">Cần được theo dõi</div>
                </div>
            </div>

            <div class="chart-card tables-catalog">
                <div class="chart-header">
                    <h3 class="chart-title">Danh sách bàn</h3>
                    <div class="chart-actions">
                        <a class="btn btn-ghost"
                           th:href="${restaurantId != null ? '/restaurant-owner/restaurants/' + restaurantId + '/tables/create' : '/restaurant-owner/tables/create'}">
                            <i class="fas fa-plus"></i>
                            Thêm bàn
                        </a>
                    </div>
                </div>
                <div class="chart-content">
                    <div class="tables-grid" th:if="${tables != null and !tables.isEmpty()}">
                        <article class="table-card" th:each="table : ${tables}">
                            <div class="table-card-header">
                                <div>
                                    <h3 class="table-title" th:text="${table.tableName}">Table name</h3>
                                    <div class="table-subtitle" th:text="${table.restaurant != null ? table.restaurant.restaurantName : 'Nhà hàng'}">Nhà hàng</div>
                                </div>
                                <span th:class="${'chip ' + 
                                    (table.status == null ? 'chip-default' :
                                    (table.status.name() == 'AVAILABLE' ? 'chip-available' :
                                    (table.status.name() == 'OCCUPIED' ? 'chip-occupied' :
                                    (table.status.name() == 'RESERVED' ? 'chip-reserved' :
                                    (table.status.name() == 'MAINTENANCE' ? 'chip-maintenance' : 'chip-default')))))}"
                                      th:text="${table.status != null ? table.status.name() : 'UNKNOWN'}">
                                </span>
                            </div>

                            <div class="table-carousel" th:if="${table.tableImages != null and !table.tableImages.isEmpty()}"
                                 th:id="|carousel-${table.tableId}|">
                                <div class="carousel-track">
                                    <div th:each="image, iterStat : ${table.tableImages}"
                                         class="carousel-slide"
                                         th:classappend="${iterStat.first} ? 'active' : ''">
                                        <img th:src="${image.url}"
                                             th:alt="|Hình ảnh ${table.tableName} - ${iterStat.index + 1}|"
                                             loading="lazy">
                                    </div>
                                </div>
                                <button class="carousel-btn prev"
                                        th:if="${#lists.size(table.tableImages) > 1}"
                                        th:attr="data-table-id=${table.tableId}"
                                        onclick="prevSlide(this.dataset.tableId)">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <button class="carousel-btn next"
                                        th:if="${#lists.size(table.tableImages) > 1}"
                                        th:attr="data-table-id=${table.tableId}"
                                        onclick="nextSlide(this.dataset.tableId)">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                                <div class="carousel-dots"
                                     th:if="${#lists.size(table.tableImages) > 1}">
                                    <button class="dot"
                                            th:each="image, iterStat : ${table.tableImages}"
                                            th:classappend="${iterStat.first} ? ' active' : ''"
                                            th:attr="data-table-id=${table.tableId}, data-slide-index=${iterStat.index}"
                                            onclick="goToSlide(this.dataset.tableId, this.dataset.slideIndex)">
                                    </button>
                                </div>
                            </div>
                            <div class="table-carousel placeholder"
                                 th:if="${table.tableImages == null or table.tableImages.isEmpty()}">
                                <div class="placeholder-content">
                                    <i class="fas fa-images"></i>
                                    <span>Chưa có hình ảnh</span>
                                </div>
                            </div>

                            <div class="table-meta">
                                <div class="table-meta-item">
                                    <span class="label">Sức chứa</span>
                                    <span class="value" th:text="${table.capacity} + ' khách'">0 khách</span>
                                </div>
                                <div class="table-meta-item">
                                    <span class="label">Đặt cọc</span>
                                    <span class="value"
                                          th:text="${#numbers.formatDecimal(table.depositAmount, 0, 'COMMA', 0, 'POINT')} + ' VND'">0 VND</span>
                                </div>
                            </div>

                            <div class="table-actions">
                                <a class="btn btn-secondary small"
                                   th:href="@{/restaurant-owner/restaurants/{restaurantId}/tables/{tableId}/edit(restaurantId=${restaurantId}, tableId=${table.tableId})}">
                                    <i class="fas fa-pen-to-square"></i>
                                    Chỉnh sửa
                                </a>
                                <form th:action="@{/restaurant-owner/restaurants/{restaurantId}/tables/{tableId}/delete(restaurantId=${restaurantId}, tableId=${table.tableId})}"
                                      method="post"
                                      onsubmit="return confirmDelete(this);">
                                    <button type="submit" class="btn btn-danger small">
                                        <i class="fas fa-trash"></i>
                                        Xóa
                                    </button>
                                </form>
                            </div>
                        </article>
                    </div>

                    <div class="tables-empty" th:if="${tables == null or tables.isEmpty()}">
                        <div class="empty-icon">
                            <i class="fas fa-chair"></i>
                        </div>
                        <h3>Chưa có bàn nào</h3>
                        <p>Tạo bàn đầu tiên để bắt đầu quản lý sơ đồ phục vụ.</p>
                        <a class="btn btn-primary"
                           th:href="${restaurantId != null ? '/restaurant-owner/restaurants/' + restaurantId + '/tables/create' : '/restaurant-owner/tables/create'}">
                            <i class="fas fa-plus-circle"></i>
                            Tạo bàn mới
                        </a>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Restaurant Selector - From Dashboard/Bookings
        function toggleRestaurantMenu() {
            const menu = document.getElementById('restaurantMenu');
            const dropdown = document.querySelector('.restaurant-dropdown');
            
            if (!menu || !dropdown) {
                return;
            }
            
            menu.classList.toggle('show');
            dropdown.classList.toggle('active');
        }

        function selectRestaurant(restaurantId) {
            // Convert to number if it's a string
            restaurantId = parseInt(restaurantId);
            
            // Find the clicked restaurant item
            const restaurantItems = document.querySelectorAll('.restaurant-item');
            let selectedItem = null;
            
            restaurantItems.forEach(item => {
                if (parseInt(item.dataset.restaurantId) === restaurantId) {
                    selectedItem = item;
                }
            });
            
            // Update UI to show selected restaurant immediately
            const menu = document.getElementById('restaurantMenu');
            const dropdown = document.querySelector('.restaurant-dropdown');
            
            if (selectedItem) {
                // Get restaurant info from selected item
                const restaurantName = selectedItem.querySelector('h4').textContent;
                const restaurantAddress = selectedItem.querySelector('p').textContent;
                
                // Update dropdown display
                const dropdownInfo = dropdown ? dropdown.querySelector('.restaurant-details') : null;
                if (dropdownInfo) {
                    const h4 = dropdownInfo.querySelector('h4');
                    const p = dropdownInfo.querySelector('p');
                    if (h4) h4.textContent = restaurantName;
                    if (p) p.textContent = restaurantAddress;
                }
                
                // Remove active class from all items
                restaurantItems.forEach(item => {
                    item.classList.remove('active');
                });
                
                // Add active class to selected item
                selectedItem.classList.add('active');
            }
            
            // Close menu
            if (menu) menu.classList.remove('show');
            if (dropdown) dropdown.classList.remove('active');
            
            // Reload page with selected restaurant
            window.location.href = '/restaurant-owner/restaurants/' + restaurantId + '/tables';
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const selector = document.querySelector('.restaurant-selector');
            if (selector && !selector.contains(event.target)) {
                const menu = document.getElementById('restaurantMenu');
                const dropdown = document.querySelector('.restaurant-dropdown');
                if (menu && dropdown) {
                    menu.classList.remove('show');
                    dropdown.classList.remove('active');
                }
            }
        });

        function getCarousel(tableId) {
            // Convert to string to ensure correct ID format
            const id = 'carousel-' + tableId;
            return document.getElementById(id);
        }

        function prevSlide(tableId) {
            // Convert to number if it's a string
            tableId = parseInt(tableId);
            const carousel = getCarousel(tableId);
            if (!carousel) { return; }
            const slides = carousel.querySelectorAll('.carousel-slide');
            const dots = carousel.querySelectorAll('.dot');
            if (!slides.length) { return; }

            let currentIndex = 0;
            slides.forEach((slide, index) => {
                if (slide.classList.contains('active')) {
                    currentIndex = index;
                }
            });

            slides[currentIndex].classList.remove('active');
            if (dots[currentIndex]) {
                dots[currentIndex].classList.remove('active');
            }

            const prevIndex = currentIndex === 0 ? slides.length - 1 : currentIndex - 1;

            slides[prevIndex].classList.add('active');
            if (dots[prevIndex]) {
                dots[prevIndex].classList.add('active');
            }
        }

        function nextSlide(tableId) {
            // Convert to number if it's a string
            tableId = parseInt(tableId);
            const carousel = getCarousel(tableId);
            if (!carousel) { return; }
            const slides = carousel.querySelectorAll('.carousel-slide');
            const dots = carousel.querySelectorAll('.dot');
            if (!slides.length) { return; }

            let currentIndex = 0;
            slides.forEach((slide, index) => {
                if (slide.classList.contains('active')) {
                    currentIndex = index;
                }
            });

            slides[currentIndex].classList.remove('active');
            if (dots[currentIndex]) {
                dots[currentIndex].classList.remove('active');
            }

            const nextIndex = currentIndex === slides.length - 1 ? 0 : currentIndex + 1;

            slides[nextIndex].classList.add('active');
            if (dots[nextIndex]) {
                dots[nextIndex].classList.add('active');
            }
        }

        function goToSlide(tableId, slideIndex) {
            // Convert to numbers if they're strings
            tableId = parseInt(tableId);
            slideIndex = parseInt(slideIndex);
            const carousel = getCarousel(tableId);
            if (!carousel) { return; }
            const slides = carousel.querySelectorAll('.carousel-slide');
            const dots = carousel.querySelectorAll('.dot');
            if (!slides.length) { return; }

            slides.forEach(slide => slide.classList.remove('active'));
            dots.forEach(dot => dot.classList.remove('active'));

            if (slides[slideIndex]) {
                slides[slideIndex].classList.add('active');
            }
            if (dots[slideIndex]) {
                dots[slideIndex].classList.add('active');
            }
        }

        function confirmDelete(form) {
            return confirm('Bạn có chắc chắn muốn xóa bàn này?');
        }
    </script>
</body>
</html>
