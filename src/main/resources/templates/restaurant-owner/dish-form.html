<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title th:text="${pageTitle}">Th√™m m√≥n m·ªõi</title>
    <link rel="stylesheet" th:href="@{/css/restaurant-admin.css}" />
</head>
<body>
    <!-- Breadcrumb Navigation -->
    <nav class="page-switch card">
        <div class="nav-breadcrumb">
            <a th:href="@{/}" class="nav-link">‚Üê Trang ch·ªß</a>
            <span class="nav-separator">|</span>
            <a th:href="@{/restaurant-owner/profile}" class="nav-link">H·ªì s∆° Nh√† h√†ng</a>
            <span class="nav-separator">|</span>
            <a th:href="@{'/restaurant-owner/restaurants/' + ${restaurant.restaurantId} + '/dishes'}" 
               class="nav-link" th:text="${restaurant.restaurantName}">T√™n nh√† h√†ng</a>
            <span class="nav-separator">|</span>
            <span class="nav-current" th:text="${pageTitle}">Th√™m m√≥n m·ªõi</span>
        </div>
    </nav>

    <div class="container">
        <!-- Flash Messages -->
        <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
        <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

        <!-- Form Header -->
        <div class="card">
            <h1 class="h1" th:text="${pageTitle}">Th√™m m√≥n m·ªõi</h1>
            <p class="muted" th:text="'Th√™m m√≥n ƒÉn m·ªõi v√†o menu c·ªßa ' + ${restaurant.restaurantName}">Th√™m m√≥n ƒÉn m·ªõi v√†o menu nh√† h√†ng</p>
        </div>

        <!-- Dish Form -->
        <div class="card">
            <form th:action="${dish.dishId != null ? 
                '/restaurant-owner/restaurants/' + restaurant.restaurantId + '/dishes/' + dish.dishId + '/edit' : 
                '/restaurant-owner/restaurants/' + restaurant.restaurantId + '/dishes/create'}" 
                  method="post" 
                  enctype="multipart/form-data">
                
                <div class="grid grid-2">
                    <label class="form-item">
                        <span class="form-label">T√™n m√≥n *</span>
                        <input type="text" 
                               name="name" 
                               th:value="${dish.name}"
                               placeholder="Ph·ªü b√≤ ƒë·∫∑c bi·ªát" 
                               required />
                    </label>
                    
                    <label class="form-item">
                        <span class="form-label">Danh m·ª•c *</span>
                        <select name="category" required>
                            <option value="">Ch·ªçn danh m·ª•c</option>
                            <option value="Starter" th:selected="${dish.category == 'Starter'}">Khai v·ªã</option>
                            <option value="Main" th:selected="${dish.category == 'Main'}">M√≥n ch√≠nh</option>
                            <option value="Dessert" th:selected="${dish.category == 'Dessert'}">Tr√°ng mi·ªáng</option>
                            <option value="Drink" th:selected="${dish.category == 'Drink'}">ƒê·ªì u·ªëng</option>
                        </select>
                    </label>
                    
                    <label class="form-item">
                        <span class="form-label">Gi√° (VNƒê) *</span>
                        <input type="number" 
                               name="price" 
                               th:value="${dish.price}"
                               placeholder="85000" 
                               min="0" 
                               step="1000" 
                               required />
                    </label>
                    
                    <label class="form-item">
                        <span class="form-label">Tr·∫°ng th√°i *</span>
                        <select name="status" required>
                            <option value="AVAILABLE" th:selected="${dish.status != null and dish.status.name() == 'AVAILABLE'}">C√≥ s·∫µn</option>
                            <option value="OUT_OF_STOCK" th:selected="${dish.status != null and dish.status.name() == 'OUT_OF_STOCK'}">H·∫øt h√†ng</option>
                            <option value="DISCONTINUED" th:selected="${dish.status != null and dish.status.name() == 'DISCONTINUED'}">Ng·ª´ng ph·ª•c v·ª•</option>
                        </select>
                    </label>
                    
                    <label class="form-item full">
                        <span class="form-label">M√¥ t·∫£ m√≥n</span>
                        <textarea name="description" 
                                  rows="3" 
                                  th:text="${dish.description}"
                                  placeholder="M√¥ t·∫£ chi ti·∫øt v·ªÅ m√≥n ƒÉn..."></textarea>
                    </label>
                    
                    <label class="form-item full">
                        <span class="form-label">·∫¢nh m√≥n ƒÉn</span>
                        <div class="image-upload-container">
                            <input type="file" 
                                   id="dishImage" 
                                   name="dishImage" 
                                   accept="image/*" 
                                   onchange="previewSingleImage(this, 'dish-image-preview')" />
                            <div class="image-preview" id="dish-image-preview">
                                <!-- Hi·ªÉn th·ªã ·∫£nh hi·ªán t·∫°i n·∫øu c√≥ (edit mode) -->
                                <div th:if="${dishImageUrl != null and !dishImageUrl.isEmpty()}">
                                    <div class="current-image-item">
                                        <img th:src="${dishImageUrl}" 
                                             alt="Current Dish Image" 
                                             style="max-width: 100%; max-height: 200px; border-radius: 4px;">
                                        <div class="current-image-info">
                                            <div class="image-details">
                                                <span class="image-name">dish_image.jpg</span>
                                                <span class="image-type">jpg</span>
                                            </div>
                                            <div class="image-actions">
                                                <a th:href="${dishImageUrl}" target="_blank" class="btn btn-sm btn-primary">Xem ·∫£nh</a>
                                                <button type="button" class="btn btn-sm btn-secondary" onclick="removeCurrentImage('dishImage', 'dish-image-preview')">Thay ƒë·ªïi</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Placeholder n·∫øu kh√¥ng c√≥ ·∫£nh -->
                                <div th:unless="${dishImageUrl != null and !dishImageUrl.isEmpty()}" class="preview-placeholder">
                                    <i class="icon">üçΩÔ∏è</i>
                                    <span>Ch·ªçn ·∫£nh m√≥n ƒÉn</span>
                                </div>
                            </div>
                            <small class="muted">PNG, JPG, WebP. T·ªëi ƒëa 5MB. T·ª∑ l·ªá khuy·∫øn ngh·ªã: 16:9</small>
                        </div>
                    </label>
                </div>
                
                <!-- Form Actions -->
                <div class="actions mt-8">
                    <button type="submit" class="btn">
                        <span th:text="${dish.dishId != null ? 'C·∫≠p nh·∫≠t m√≥n' : 'Th√™m m√≥n'}">Th√™m m√≥n</span>
                    </button>
                    <a th:href="@{'/restaurant-owner/restaurants/' + ${restaurant.restaurantId} + '/dishes'}" 
                       class="btn btn-ghost">H·ªßy</a>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Image preview functionality
        function previewSingleImage(input, previewId) {
            const preview = document.getElementById(previewId);
            const file = input.files[0];
            
            if (file) {
                // Validate file type
                const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
                if (!allowedTypes.includes(file.type)) {
                    alert('Ch·ªâ ch·∫•p nh·∫≠n file ·∫£nh ƒë·ªãnh d·∫°ng JPG, PNG, WebP!');
                    input.value = '';
                    return;
                }
                
                // Validate file size (5MB)
                const maxSize = 5 * 1024 * 1024; // 5MB
                if (file.size > maxSize) {
                    alert('K√≠ch th∆∞·ªõc file kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 5MB!');
                    input.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `
                        <div class="new-image-item">
                            <img src="${e.target.result}" alt="Preview" style="max-width: 100%; max-height: 200px; border-radius: 4px;">
                            <div class="image-info">
                                <div class="image-details">
                                    <span class="image-name">${file.name}</span>
                                    <span class="image-type">${file.type.split('/')[1].toUpperCase()}</span>
                                    <span class="image-size">${(file.size / 1024 / 1024).toFixed(2)} MB</span>
                                </div>
                                <div class="image-actions">
                                    <button type="button" class="btn btn-sm btn-secondary" onclick="removeNewImage('${input.id}', '${previewId}')">X√≥a</button>
                                </div>
                            </div>
                        </div>
                    `;
                };
                reader.onerror = function() {
                    alert('L·ªói khi ƒë·ªçc file ·∫£nh!');
                    input.value = '';
                };
                reader.readAsDataURL(file);
            }
        }

        function removeCurrentImage(inputId, previewId) {
            const input = document.getElementById(inputId);
            const preview = document.getElementById(previewId);
            
            input.value = '';
            preview.innerHTML = `
                <div class="preview-placeholder">
                    <i class="icon">üçΩÔ∏è</i>
                    <span>Ch·ªçn ·∫£nh m√≥n ƒÉn</span>
                </div>
            `;
        }

        function removeNewImage(inputId, previewId) {
            const input = document.getElementById(inputId);
            const preview = document.getElementById(previewId);
            
            input.value = '';
            preview.innerHTML = `
                <div class="preview-placeholder">
                    <i class="icon">üçΩÔ∏è</i>
                    <span>Ch·ªçn ·∫£nh m√≥n ƒÉn</span>
                </div>
            `;
        }
    </script>

    <style>
        /* Image Upload Styles */
        .image-upload-container {
            margin-bottom: 1rem;
        }
        
        .image-upload-container input[type="file"] {
            display: none;
        }
        
        .image-preview {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .image-preview:hover {
            border-color: #007bff;
            background-color: #f8f9fa;
        }
        
        .preview-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            color: #666;
        }
        
        .preview-placeholder .icon {
            font-size: 2rem;
        }
        
        .image-preview img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* Current image styles */
        .current-image-item {
            position: relative;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            margin: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .current-image-info {
            margin-top: 12px;
        }
        
        .image-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .image-name {
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
        }
        
        .image-type {
            background: #f3f4f6;
            color: #6b7280;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .image-size {
            background: #dbeafe;
            color: #1e40af;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .image-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        /* New image styles */
        .new-image-item {
            position: relative;
            background: white;
            border: 1px solid #10b981;
            border-radius: 8px;
            padding: 12px;
            margin: 5px;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.1);
        }
        
        .new-image-item .image-info {
            margin-top: 12px;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .image-details {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .image-actions {
                flex-direction: column;
            }
            
            .image-preview {
                min-height: 100px;
                padding: 15px;
            }
        }
        
        /* Form improvements */
        .grid.grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .grid.grid-2 .form-item.full {
            grid-column: 1 / -1;
        }
        
        @media (max-width: 768px) {
            .grid.grid-2 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</body>
</html>
