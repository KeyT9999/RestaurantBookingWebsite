<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title th:text="${pageTitle}">Qu·∫£n l√Ω ƒê·∫∑t b√†n - Booking Management</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Dashboard CSS -->
    <link th:href="@{/css/dashboard.css}" rel="stylesheet">
</head>
<body class="bookings-page">
    <!-- Dashboard Header -->
    <header class="dashboard-header">
        <div class="header-content">
            <div class="header-left">
                <a href="/" class="logo">Book Eat</a>
                
                <!-- Restaurant Selector -->
                <div class="restaurant-selector" th:if="${restaurants != null and !restaurants.empty}">
                    <div class="restaurant-dropdown" onclick="toggleRestaurantMenu()">
                        <div class="restaurant-info">
                            <div class="restaurant-icon">
                                <i class="fas fa-store"></i>
                            </div>
                            <div class="restaurant-details">
                                <h4 th:text="${currentRestaurant != null ? currentRestaurant.restaurantName : 'Ch·ªçn nh√† h√†ng'}">Nh√† h√†ng m·∫∑c ƒë·ªãnh</h4>
                                <p th:text="${currentRestaurant != null ? currentRestaurant.address : 'ƒê·ªãa ch·ªâ nh√† h√†ng'}">ƒê·ªãa ch·ªâ nh√† h√†ng</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-down dropdown-arrow"></i>
                    </div>
                    
                    <div class="restaurant-menu" id="restaurantMenu">
                        <div th:each="restaurant, iterStat : ${restaurants}" 
                             class="restaurant-item" 
                             th:classappend="${restaurant.restaurantId == restaurantId ? 'active' : ''}"
                             th:onclick="'selectRestaurant(' + ${restaurant.restaurantId} + ')'">
                            <div class="restaurant-info">
                                <div class="restaurant-icon">
                                    <i class="fas fa-store"></i>
                                </div>
                                <div class="restaurant-details">
                                    <h4 th:text="${restaurant.restaurantName}">T√™n nh√† h√†ng</h4>
                                    <p th:text="${restaurant.address}">ƒê·ªãa ch·ªâ</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="header-right">
                <div class="search-bar">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" placeholder="T√¨m ki·∫øm...">
                </div>
                
                <div class="user-info dropdown">
                    <div class="user-avatar" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-details">
                        <h5 sec:authentication="name">Restaurant Owner</h5>
                        <p>Qu·∫£n l√Ω nh√† h√†ng</p>
                    </div>
                
                    <!-- Dropdown menu -->
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                        <li>
                            <a class="dropdown-item" th:href="@{/auth/profile}">
                                <i class="fas fa-user me-2"></i>
                                Profile
                            </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item" th:href="@{/logout}">
                                <i class="fas fa-sign-out-alt me-2"></i>
                                ƒêƒÉng xu·∫•t
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Dashboard Layout -->
    <div class="dashboard-layout">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="sidebar-content">
                <div class="sidebar-brand">
                    <div class="sidebar-brand-icon">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="sidebar-brand-text">
                        <h3>Booking</h3>
                        <p>V 1.0</p>
                    </div>
                </div>
                
                <ul class="sidebar-menu">
                    <li>
                        <a href="/restaurant-owner/dashboard" th:href="${restaurantId != null ? '/restaurant-owner/restaurants/' + restaurantId + '/dashboard' : '/restaurant-owner/dashboard'}">
                            <i class="fas fa-chart-line"></i>
                            T·ªïng quan
                        </a>
                    </li>
                    <li>
                        <a href="/restaurant-owner/bookings" th:href="${restaurantId != null ? '/restaurant-owner/bookings?restaurantId=' + restaurantId : '/restaurant-owner/bookings'}" class="active">
                            <i class="fas fa-calendar-check"></i>
                            Booking
                        </a>
                    </li>
                    <li>
                        <a href="/restaurant-owner/tables" th:href="${restaurantId != null ? '/restaurant-owner/restaurants/' + restaurantId + '/tables' : '/restaurant-owner/tables'}">
                            <i class="fas fa-chair"></i>
                            Qu·∫£n l√Ω b√†n
                        </a>
                    </li>
                    <li>
                        <a href="/restaurant-owner/profile">
                            <i class="fas fa-store"></i>
                            H·ªì s∆° nh√† h√†ng
                        </a>
                    </li>
                    <li>
                        <a href="/restaurant-owner/menu" th:href="${restaurantId != null ? '/restaurant-owner/restaurants/' + restaurantId + '/dishes' : '/restaurant-owner/menu'}">
                            <i class="fas fa-utensils"></i>
                            Th·ª±c ƒë∆°n
                        </a>
                    </li>
                    <li>
                        <a href="#" th:href="${restaurantId != null ? '/restaurant-owner/restaurants/' + restaurantId + '/services' : '#'}">
                            <i class="fas fa-concierge-bell"></i>
                            D·ªãch v·ª•
                        </a>
                    </li>
                    <li>
                        <a href="#" th:href="${restaurantId != null ? '/restaurant-owner/restaurants/' + restaurantId + '/media' : '#'}">
                            <i class="fas fa-images"></i>
                            Media
                        </a>
                    </li>
                    <li>
                        <a href="/restaurant-owner/payments">
                            <i class="fas fa-credit-card"></i>
                            Thanh to√°n
                        </a>
                    </li>
                    <li>
                        <a href="/restaurant-owner/vouchers" th:href="${restaurantId != null ? '/restaurant-owner/vouchers?restaurantId=' + restaurantId : '/restaurant-owner/vouchers'}">
                            <i class="fas fa-ticket-alt"></i>
                            Voucher
                        </a>
                    </li>
                    <li>
                        <a href="/restaurant-owner/chat" th:href="${restaurantId != null ? '/restaurant-owner/chat?restaurantId=' + restaurantId : '/restaurant-owner/chat'}">
                            <i class="fas fa-comments"></i>
                            Tin nh·∫Øn
                            <span class="menu-badge" id="bookings-unread-badge" style="display: none;">0</span>
                        </a>
                    </li>
                    <li>
                        <a href="/restaurant-owner/reviews">
                            <i class="fas fa-star"></i>
                            ƒê√°nh gi√°
                        </a>
                    </li>
                </ul>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <div class="content-header">
                <h1 class="content-title">Restaurant Management Dashboard</h1>
                <p class="content-subtitle">Qu·∫£n l√Ω v√† theo d√µi ho·∫°t ƒë·ªông nh√† h√†ng c·ªßa b·∫°n</p>
            </div>

            <!-- Error Message -->
            <div th:if="${error != null}" class="alert alert-danger" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <span th:text="${error}">C√≥ l·ªói x·∫£y ra</span>
            </div>

            <!-- KPI Cards -->
            <div class="kpi-grid" th:if="${error == null}">
                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div class="kpi-trend positive">
                            <i class="fas fa-arrow-up"></i>
                            <span>+12.5%</span>
                        </div>
                    </div>
                    <div class="kpi-value" th:text="${totalBookings}">12</div>
                    <div class="kpi-label">T·ªïng c·ªông</div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="kpi-trend negative">
                            <i class="fas fa-arrow-down"></i>
                            <span>-3.1%</span>
                        </div>
                    </div>
                    <div class="kpi-value" th:text="${pendingBookings}">3</div>
                    <div class="kpi-label">Ch·ªù x√°c nh·∫≠n</div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="kpi-trend positive">
                            <i class="fas fa-arrow-up"></i>
                            <span>+8.2%</span>
                        </div>
                    </div>
                    <div class="kpi-value" th:text="${confirmedBookings}">8</div>
                    <div class="kpi-label">ƒê√£ x√°c nh·∫≠n</div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon">
                            <i class="fas fa-times-circle"></i>
                        </div>
                        <div class="kpi-trend negative">
                            <i class="fas fa-arrow-down"></i>
                            <span>-2.5%</span>
                        </div>
                    </div>
                    <div class="kpi-value" th:text="${cancelledBookings}">1</div>
                    <div class="kpi-label">ƒê√£ h·ªßy</div>
                </div>
            </div>


            <!-- Filters -->
            <div class="chart-card" th:if="${error == null}">
                <div class="chart-header">
                    <h3 class="chart-title">B·ªô l·ªçc</h3>
                </div>
                <div class="chart-content">
                    <form method="get" 
                          th:action="${isAllRestaurants} ? @{/restaurant-owner/bookings} : @{/restaurant-owner/bookings}" 
                          class="filter-form-compact">
                        <input type="hidden" name="restaurantId" th:value="${restaurantId}" />
                        <div class="filter-row-compact">
                            <div class="filter-group-compact">
                                <input type="date" name="date" th:value="${selectedDate}" class="filter-input-compact" placeholder="Ng√†y" title="Ch·ªçn ng√†y" />
                            </div>
                            <div class="filter-group-compact">
                                <select name="status" class="filter-input-compact" title="Ch·ªçn tr·∫°ng th√°i">
                                    <option value="">Tr·∫°ng th√°i</option>
                                    <option value="PENDING" th:selected="${selectedStatus == 'PENDING'}">PENDING</option>
                                    <option value="CONFIRMED" th:selected="${selectedStatus == 'CONFIRMED'}">CONFIRMED</option>
                                    <option value="CANCELLED" th:selected="${selectedStatus == 'CANCELLED'}">CANCELLED</option>
                                    <option value="COMPLETED" th:selected="${selectedStatus == 'COMPLETED'}">COMPLETED</option>
                                    <option value="NO_SHOW" th:selected="${selectedStatus == 'NO_SHOW'}">NO_SHOW</option>
                                </select>
                            </div>
                            <div class="filter-group-compact">
                                <select name="guestCount" class="filter-input-compact" title="Ch·ªçn s·ªë kh√°ch">
                                    <option value="">S·ªë kh√°ch</option>
                                    <option>1-2</option>
                                    <option>3-4</option>
                                    <option>5-6</option>
                                    <option>7+</option>
                                </select>
                            </div>
                            <div class="filter-group-compact">
                                <input type="text" name="search" placeholder="T√¨m ki·∫øm..." class="filter-input-compact" title="T√¨m theo t√™n ho·∫∑c s·ªë ƒëi·ªán tho·∫°i" />
                            </div>
                            <div class="filter-group-compact">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-filter"></i>
                                    L·ªçc
                                </button>
                            </div>
                            <div class="filter-group-compact">
                                <a th:href="${isAllRestaurants} ? @{/restaurant-owner/bookings} : @{/restaurant-owner/bookings}" class="btn btn-secondary">
                                    <i class="fas fa-times"></i>
                                    X√≥a l·ªçc
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Booking List -->
            <div class="chart-card" th:if="${error == null}">
                <div class="chart-header">
                    <h3 class="chart-title">Danh s√°ch ƒë·∫∑t b√†n</h3>
                </div>
                <div class="chart-content">
                    <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Kh√°ch h√†ng</th>
                            <th>Th·ªùi gian ƒë·∫∑t</th>
                            <th>Th·ªùi gian</th>
                            <th>S·ªë kh√°ch</th>
                            <th>B√†n</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>ƒê·∫∑t c·ªçc</th>
                            <th class="text-center">Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="booking : ${bookings}" th:if="${bookings != null and !bookings.empty}">
                            <td><strong th:text="'#BK' + ${booking.bookingId}">#BK001</strong></td>
                            <td>
                                <div>
                                    <strong th:text="${booking.customer != null and booking.customer.user != null and booking.customer.user.fullName != null ? booking.customer.user.fullName : 'N/A'}">Nguy·ªÖn VƒÉn A</strong><br>
                                    <small th:text="${booking.customer != null and booking.customer.user != null and booking.customer.user.phoneNumber != null ? booking.customer.user.phoneNumber : 'N/A'}">0123 456 789</small>
                                </div>
                            </td>
                            <td>
                                <div>
                                    <strong th:text="${booking.createdAt != null ? #temporals.format(booking.createdAt, 'dd/MM/yyyy') : 'N/A'}">29/01/2025</strong><br>
                                    <small th:text="${booking.createdAt != null ? #temporals.format(booking.createdAt, 'HH:mm') : 'N/A'}">14:30</small>
                                </div>
                            </td>
                            <td>
                                <div>
                                    <strong th:text="${#temporals.format(booking.bookingTime, 'dd/MM/yyyy')}">29/01/2025</strong><br>
                                    <small th:text="${#temporals.format(booking.bookingTime, 'HH:mm')}">18:30</small>
                                </div>
                            </td>
                            <td th:text="${booking.numberOfGuests} + ' ng∆∞·ªùi'">4 ng∆∞·ªùi</td>
                            <td>
                                <span th:if="${booking.bookingTables != null and !booking.bookingTables.empty}">
                                    <span th:each="bookingTable, iterStat : ${booking.bookingTables}" 
                                          th:text="${bookingTable.table.tableName + (iterStat.last ? '' : ', ')}">T1, T2</span>
                                </span>
                                <span th:if="${booking.bookingTables == null or booking.bookingTables.empty}">Ch∆∞a ch·ªçn b√†n</span>
                            </td>
                            <td>
                                <span th:class="${'chip ' + 
                                    (booking.status.name() == 'PENDING' ? 'chip-pending' :
                                    (booking.status.name() == 'CONFIRMED' ? 'chip-confirmed' :
                                    (booking.status.name() == 'CANCELLED' ? 'chip-cancelled' :
                                    (booking.status.name() == 'COMPLETED' ? 'chip-completed' : 'chip-default'))))}"
                                    th:text="${booking.status.name()}">
                                </span>
                            </td>
                            <td th:text="${#numbers.formatDecimal(booking.depositAmount, 0, 'COMMA', 0, 'POINT')} + 'ƒë'">500.000ƒë</td>
                            <td class="actions">
                                <button th:onclick="'openBookingDetail(' + ${booking.bookingId} + ')'" 
                                        class="btn btn-info small">
                                    <i class="fas fa-eye"></i>
                                    Xem
                                </button>
                                
                                <!-- Chat button -->
                                <a th:href="@{/restaurant-owner/chat?bookingId={id}(id=${booking.bookingId})}" 
                                   class="btn btn-primary small" 
                                   title="Chat v·ªõi kh√°ch h√†ng">
                                    <i class="fas fa-comments"></i>
                                    Chat
                                </a>
                                
                                <!-- Edit button for editable bookings -->
                                <a th:if="${booking.status.name() == 'PENDING' or booking.status.name() == 'CONFIRMED'}" 
                                   th:href="@{/booking/{id}/edit(id=${booking.bookingId})}" 
                                   class="btn btn-warning small">
                                    <i class="fas fa-edit"></i>
                                    Ch·ªânh s·ª≠a
                                </a>
                                
                                <!-- Status update buttons based on current status -->
                                <form th:if="${booking.status.name() == 'PENDING'}" 
                                      th:action="@{/restaurant-owner/bookings/{id}/status(id=${booking.bookingId})}" 
                                      method="post" style="display: inline;">
                                    <input type="hidden" name="status" value="CONFIRMED" />
                                    <button type="submit" class="btn btn-success small">
                                        <i class="fas fa-check"></i>
                                        X√°c nh·∫≠n
                                    </button>
                                </form>
                                
                                <!-- Cancel booking button with refund processing -->
                                <button th:if="${booking.status.name() == 'PENDING' or booking.status.name() == 'CONFIRMED'}" 
                                        class="btn btn-danger small" 
                                        th:data-booking-id="${booking.bookingId}"
                                        onclick="cancelBooking(this.dataset.bookingId)">
                                    <i class="fas fa-times"></i>
                                    H·ªßy booking
                                </button>
                                
                                <form th:if="${booking.status.name() == 'CONFIRMED'}" 
                                      th:action="@{/restaurant-owner/bookings/{id}/status(id=${booking.bookingId})}" 
                                      method="post" style="display: inline;">
                                    <input type="hidden" name="status" value="NO_SHOW" />
                                    <button type="submit" class="btn btn-secondary small">
                                        <i class="fas fa-user-times"></i>
                                        No Show
                                    </button>
                                </form>
                                
                                <!-- Check-in/Check-out buttons -->
                                <button th:if="${booking.status.name() == 'CONFIRMED' or booking.status.name() == 'COMPLETED'}" 
                                        class="btn btn-success small" 
                                        th:onclick="'checkInCustomer(' + ${booking.bookingId} + ')'">
                                    <i class="fas fa-sign-in-alt"></i>
                                    Check-in
                                </button>
                                
                                <button th:if="${booking.status.name() == 'CONFIRMED' or booking.status.name() == 'COMPLETED'}" 
                                        class="btn btn-secondary small" 
                                        th:onclick="'checkOutCustomer(' + ${booking.bookingId} + ')'">
                                    <i class="fas fa-sign-out-alt"></i>
                                    Check-out
                                </button>
                            </td>
                        </tr>
                        
                        <!-- Empty state -->
                        <tr th:if="${bookings == null or bookings.empty}">
                            <td colspan="8" style="text-align: center; padding: 2rem;">
                                <p class="muted">Kh√¥ng c√≥ booking n√†o</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
                    </div>
                </div>
            </div>

            <!-- Waitlist Section -->
            <div class="chart-card" th:if="${error == null and waitlists != null and !waitlists.empty}">
                <div class="chart-header">
                    <h3 class="chart-title">
                        <i class="fas fa-clock"></i> Danh s√°ch ch·ªù (Waitlist)
                        <span class="badge bg-warning text-dark ms-2" th:text="${waitingCount}">0</span>
                    </h3>
                </div>
                <div class="chart-content">
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Kh√°ch h√†ng</th>
                                    <th>Nh√† h√†ng</th>
                                    <th>Th·ªùi gian tham gia</th>
                                    <th>Th·ªùi gian mong mu·ªën</th>
                                    <th>S·ªë kh√°ch</th>
                                    <th>V·ªã tr√≠</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th class="text-center">Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="waitlist : ${waitlists}">
                                    <td><strong th:text="'#WL' + ${waitlist.waitlistId}">#WL001</strong></td>
                                    <td>
                                        <div>
                                            <strong th:text="${waitlist.customer != null and waitlist.customer.user != null and waitlist.customer.user.fullName != null ? waitlist.customer.user.fullName : 'N/A'}">Nguy·ªÖn VƒÉn A</strong><br>
                                            <small th:text="${waitlist.customer != null and waitlist.customer.user != null and waitlist.customer.user.phoneNumber != null ? waitlist.customer.user.phoneNumber : 'N/A'}">0123 456 789</small>
                                        </div>
                                    </td>
                                    <td th:text="${restaurantNames != null and restaurantNames[waitlist.restaurant.restaurantId] != null ? restaurantNames[waitlist.restaurant.restaurantId] : waitlist.restaurant.restaurantName}">Nh√† h√†ng ABC</td>
                                    <td>
                                        <div>
                                            <strong th:text="${#temporals.format(waitlist.joinTime, 'dd/MM/yyyy')}">10/11/2025</strong><br>
                                            <small th:text="${#temporals.format(waitlist.joinTime, 'HH:mm')}">16:30</small>
                                        </div>
                                    </td>
                                    <td>
                                        <div th:if="${waitlist.preferredBookingTime != null}">
                                            <strong th:text="${#temporals.format(waitlist.preferredBookingTime, 'dd/MM/yyyy')}">10/11/2025</strong><br>
                                            <small th:text="${#temporals.format(waitlist.preferredBookingTime, 'HH:mm')}">19:00</small>
                                        </div>
                                        <span th:if="${waitlist.preferredBookingTime == null}" class="text-muted">Ch∆∞a c√≥</span>
                                    </td>
                                    <td th:text="${waitlist.partySize} + ' ng∆∞·ªùi'">4 ng∆∞·ªùi</td>
                                    <td>
                                        <span class="badge bg-info" th:if="${waitlistQueuePositions != null and waitlistQueuePositions[waitlist.waitlistId] != null}" 
                                              th:text="'V·ªã tr√≠ #' + ${waitlistQueuePositions[waitlist.waitlistId]}">V·ªã tr√≠ #1</span>
                                        <span class="badge bg-secondary" th:if="${waitlistQueuePositions == null or waitlistQueuePositions[waitlist.waitlistId] == null}">N/A</span>
                                    </td>
                                    <td>
                                        <span th:class="${'chip ' + 
                                            (waitlist.status.name() == 'WAITING' ? 'chip-pending' :
                                            (waitlist.status.name() == 'CALLED' ? 'chip-info' :
                                            (waitlist.status.name() == 'SEATED' ? 'chip-success' :
                                            (waitlist.status.name() == 'CANCELLED' ? 'chip-cancelled' : 'chip-default'))))}"
                                            th:text="${waitlist.status.name()}">
                                        </span>
                                    </td>
                                    <td class="actions">
                                        <button th:onclick="'openWaitlistDetail(' + ${waitlist.waitlistId} + ')'" 
                                                class="btn btn-info small">
                                            <i class="fas fa-eye"></i>
                                            Chi ti·∫øt
                                        </button>
                                        
                                        <button th:if="${waitlist.status != null and waitlist.status.name() == 'WAITING'}" 
                                                class="btn btn-success small confirm-waitlist-btn" 
                                                th:attr="data-waitlist-id=${waitlist.waitlistId},data-preferred-time=${waitlist.preferredBookingTime != null ? #temporals.format(waitlist.preferredBookingTime, 'yyyy-MM-dd''T''HH:mm') : ''}"
                                                title="X√°c nh·∫≠n th√†nh booking">
                                            <i class="fas fa-check"></i>
                                            X√°c nh·∫≠n Booking
                                        </button>
                                        
                                        <form th:if="${waitlist.status != null and waitlist.status.name() == 'WAITING'}" 
                                              th:action="@{/restaurant-owner/waitlist/cancel/{id}(id=${waitlist.waitlistId})}" 
                                              method="post" 
                                              style="display: inline;">
                                            <button type="submit" class="btn btn-danger small" 
                                                    onclick="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy waitlist n√†y?')">
                                                <i class="fas fa-times"></i>
                                                H·ªßy
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Waitlist Detail Modal -->
    <div class="modal fade" id="waitlistDetailModal" tabindex="-1" aria-labelledby="waitlistDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="waitlistDetailModalLabel">
                        <i class="fas fa-clock me-2"></i>
                        Chi ti·∫øt Waitlist
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Loading State -->
                    <div id="waitlistDetailLoading" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">ƒêang t·∫£i...</span>
                        </div>
                        <p class="mt-3 text-muted">ƒêang t·∫£i th√¥ng tin waitlist...</p>
                    </div>

                    <!-- Error State -->
                    <div id="waitlistDetailError" class="text-center py-5" style="display: none;">
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <span id="waitlistDetailErrorMessage">Kh√¥ng th·ªÉ t·∫£i th√¥ng tin waitlist</span>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="loadWaitlistDetail()">
                            <i class="fas fa-refresh me-2"></i>
                            Th·ª≠ l·∫°i
                        </button>
                    </div>

                    <!-- Waitlist Detail Content -->
                    <div id="waitlistDetailContent" style="display: none;">
                        <div class="row">
                            <!-- C·ªôt tr√°i -->
                            <div class="col-md-6">
                                <!-- Waitlist Summary -->
                                <div class="card mb-3">
                                    <div class="card-header d-flex align-items-center">
                                        <i class="fas fa-clock me-2"></i>
                                        <h6 class="mb-0">Waitlist Summary</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="waitlistSummary">
                                            <!-- Waitlist summary will be populated by JavaScript -->
                                        </div>
                                    </div>
                                </div>

                                <!-- Kh√°ch h√†ng -->
                                <div class="card mb-3">
                                    <div class="card-header d-flex align-items-center">
                                        <i class="fas fa-user me-2"></i>
                                        <h6 class="mb-0">Kh√°ch h√†ng</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="waitlistCustomerInfo">
                                            <!-- Customer info will be populated by JavaScript -->
                                        </div>
                                    </div>
                                </div>

                                <!-- Th√¥ng tin Waitlist -->
                                <div class="card mb-3">
                                    <div class="card-header d-flex align-items-center">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <h6 class="mb-0">Th√¥ng tin Waitlist</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="waitlistInfo">
                                            <!-- Waitlist info will be populated by JavaScript -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- C·ªôt ph·∫£i -->
                            <div class="col-md-6">
                                <!-- B√†n mong mu·ªën -->
                                <div class="card mb-3">
                                    <div class="card-header d-flex align-items-center">
                                        <i class="fas fa-table me-2"></i>
                                        <h6 class="mb-0">B√†n mong mu·ªën</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="waitlistTables">
                                            <!-- Tables will be populated by JavaScript -->
                                        </div>
                                    </div>
                                </div>

                                <!-- M√≥n ƒÉn -->
                                <div class="card mb-3">
                                    <div class="card-header d-flex align-items-center">
                                        <i class="fas fa-utensils me-2"></i>
                                        <h6 class="mb-0">M√≥n ƒÉn</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="waitlistDishes">
                                            <!-- Dishes will be populated by JavaScript -->
                                        </div>
                                    </div>
                                </div>

                                <!-- D·ªãch v·ª• -->
                                <div class="card mb-3">
                                    <div class="card-header d-flex align-items-center">
                                        <i class="fas fa-concierge-bell me-2"></i>
                                        <h6 class="mb-0">D·ªãch v·ª•</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="waitlistServices">
                                            <!-- Services will be populated by JavaScript -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Waitlist Actions -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">Qu·∫£n l√Ω Waitlist</h6>
                                        <p class="card-text text-muted">Th·ª±c hi·ªán c√°c thao t√°c qu·∫£n l√Ω waitlist</p>
                                        <div id="waitlistActions" class="d-flex gap-2 justify-content-center flex-wrap">
                                            <!-- Actions will be populated by JavaScript -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>
                        ƒê√≥ng
                    </button>
                    <button type="button" class="btn btn-primary" onclick="location.reload()">
                        <i class="fas fa-refresh me-2"></i>
                        L√†m m·ªõi danh s√°ch
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Waitlist to Booking Modal -->
    <div id="confirmWaitlistModal" class="modal fade" tabindex="-1" aria-labelledby="confirmWaitlistModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmWaitlistModalLabel">X√°c nh·∫≠n Waitlist th√†nh Booking</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <strong>Th√¥ng tin:</strong> Waitlist s·∫Ω ƒë∆∞·ª£c chuy·ªÉn th√†nh booking v√† kh√°ch h√†ng s·∫Ω nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o x√°c nh·∫≠n.
                    </div>
                    
                    <form id="confirmWaitlistForm">
                        <input type="hidden" id="waitlistId" name="waitlistId">
                        
                        <div class="mb-3">
                            <label for="bookingTime" class="form-label">Th·ªùi gian ƒë·∫∑t b√†n <span class="text-danger">*</span></label>
                            <input type="datetime-local" 
                                   id="bookingTime" 
                                   name="bookingTime" 
                                   class="form-control" 
                                   required>
                            <small class="form-text text-muted">
                                Ch·ªçn th·ªùi gian ch√≠nh x√°c m√† kh√°ch h√†ng mu·ªën ƒë·∫∑t b√†n
                            </small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="notes" class="form-label">Ghi ch√∫</label>
                            <textarea id="notes" 
                                      name="notes" 
                                      class="form-control" 
                                      rows="3" 
                                      placeholder="Th√™m ghi ch√∫ cho booking..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="submit" form="confirmWaitlistForm" class="btn btn-success">
                        <i class="fas fa-check"></i> X√°c nh·∫≠n Booking
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Restaurant Selector - From Dashboard
        function toggleRestaurantMenu() {
            const menu = document.getElementById('restaurantMenu');
            const dropdown = document.querySelector('.restaurant-dropdown');
            
            menu.classList.toggle('show');
            dropdown.classList.toggle('active');
        }

        function selectRestaurant(restaurantId) {
            // Update UI to show selected restaurant immediately
            const menu = document.getElementById('restaurantMenu');
            const dropdown = document.querySelector('.restaurant-dropdown');
            const selectedItem = event.target.closest('.restaurant-item');
            
            // Get restaurant info from selected item
            const restaurantName = selectedItem.querySelector('h4').textContent;
            const restaurantAddress = selectedItem.querySelector('p').textContent;
            
            // Update dropdown display
            const dropdownInfo = dropdown.querySelector('.restaurant-details');
            dropdownInfo.querySelector('h4').textContent = restaurantName;
            dropdownInfo.querySelector('p').textContent = restaurantAddress;
            
            // Remove active class from all items
            document.querySelectorAll('.restaurant-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to selected item
            selectedItem.classList.add('active');
            
            // Close menu
            menu.classList.remove('show');
            dropdown.classList.remove('active');
            
            // Reload page with selected restaurant
            window.location.href = '/restaurant-owner/bookings?restaurantId=' + restaurantId;
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const selector = document.querySelector('.restaurant-selector');
            if (selector && !selector.contains(event.target)) {
                const menu = document.getElementById('restaurantMenu');
                const dropdown = document.querySelector('.restaurant-dropdown');
                if (menu && dropdown) {
                    menu.classList.remove('show');
                    dropdown.classList.remove('active');
                }
            }
        });

        // Confirm Waitlist to Booking functions
        function showConfirmWaitlistDialog(waitlistId, preferredBookingTime) {
            console.log('üîç showConfirmWaitlistDialog called with:', waitlistId, preferredBookingTime);
            
            const modalElement = document.getElementById('confirmWaitlistModal');
            if (!modalElement) {
                console.error('‚ùå Modal element not found');
                alert('L·ªói: Kh√¥ng t√¨m th·∫•y modal x√°c nh·∫≠n');
                return;
            }
            
            const modal = new bootstrap.Modal(modalElement);
            const waitlistIdInput = document.getElementById('waitlistId');
            if (!waitlistIdInput) {
                console.error('‚ùå waitlistId input not found');
                return;
            }
            waitlistIdInput.value = waitlistId;
            
            // Use preferred booking time if available, otherwise set default to current time + 30 minutes
            const bookingTimeInput = document.getElementById('bookingTime');
            if (!bookingTimeInput) {
                console.error('‚ùå bookingTime input not found');
                return;
            }
            
            if (preferredBookingTime && preferredBookingTime.trim() !== '') {
                try {
                    // Parse the datetime string (format: yyyy-MM-ddTHH:mm:ss or yyyy-MM-ddTHH:mm:ss.SSS)
                    let date = new Date(preferredBookingTime);
                    if (isNaN(date.getTime())) {
                        throw new Error('Invalid date');
                    }
                    
                    // Convert to local time for datetime-local input (not UTC)
                    // datetime-local needs format: yyyy-MM-ddTHH:mm (local time, not UTC)
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    const timeString = `${year}-${month}-${day}T${hours}:${minutes}`;
                    
                    bookingTimeInput.value = timeString;
                    console.log('‚úÖ Using preferred booking time (local):', timeString);
                } catch (e) {
                    console.error('‚ùå Failed to parse preferred booking time:', e);
                    // Fallback to default
                    const now = new Date();
                    now.setMinutes(now.getMinutes() + 30);
                    const year = now.getFullYear();
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const day = String(now.getDate()).padStart(2, '0');
                    const hours = String(now.getHours()).padStart(2, '0');
                    const minutes = String(now.getMinutes()).padStart(2, '0');
                    bookingTimeInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
                    console.log('‚ö†Ô∏è Using fallback time:', bookingTimeInput.value);
                }
            } else {
                const now = new Date();
                now.setMinutes(now.getMinutes() + 30);
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                bookingTimeInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
                console.log('‚ö†Ô∏è No preferred time, using default:', bookingTimeInput.value);
            }
            
            modal.show();
            console.log('‚úÖ Modal shown');
        }

        // Handle confirm waitlist form submission
        const confirmWaitlistForm = document.getElementById('confirmWaitlistForm');
        if (confirmWaitlistForm) {
            confirmWaitlistForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const waitlistId = document.getElementById('waitlistId').value;
                const bookingTime = document.getElementById('bookingTime').value;
                const notes = document.getElementById('notes').value;
                
                if (!waitlistId || !bookingTime) {
                    alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin');
                    return;
                }
                
                // üîß S·ª¨A: Ch·ªçn n√∫t submit theo id (d·ªÖ debug h∆°n)
                const submitBtn = document.getElementById('confirmWaitlistSubmitBtn');
                const originalText = submitBtn ? submitBtn.innerHTML : '';
                
                if (submitBtn) {
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ƒêang x·ª≠ l√Ω...';
                    submitBtn.disabled = true;
                }
                
                // üîß S·ª¨A: Convert datetime-local format to ISO-8601 format
                // datetime-local returns format: "yyyy-MM-ddTHH:mm" (local time)
                // Need to convert to ISO-8601: "yyyy-MM-ddTHH:mm:ss" (local time, not UTC)
                let bookingTimeISO = bookingTime;
                if (bookingTime && bookingTime.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/)) {
                    // Format: yyyy-MM-ddTHH:mm -> convert to yyyy-MM-ddTHH:mm:00 (keep local time)
                    bookingTimeISO = bookingTime + ':00';
                } else if (bookingTime && !bookingTime.includes(':')) {
                    // If format is wrong, try to fix it
                    bookingTimeISO = bookingTime + ':00';
                }
                
                console.log('üìÖ Booking time (local):', bookingTime, '-> ISO (local):', bookingTimeISO);
                
                // Call API
                fetch(`/restaurant-owner/waitlist/${waitlistId}/confirm-to-booking`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        bookingTime: bookingTimeISO,
                        notes: notes || ''
                    })
                })
                .then(async response => {
                    const responseText = await response.text();
                    console.log('üì° Response text:', responseText);
                    
                    if (!response.ok) {
                        let errorMessage = `HTTP error! status: ${response.status}`;
                        try {
                            const errorData = JSON.parse(responseText);
                            errorMessage = errorData.error || errorData.message || errorMessage;
                            console.error('‚ùå Error data:', errorData);
                        } catch (e) {
                            console.error('‚ùå Failed to parse error response:', e);
                        }
                        throw new Error(errorMessage);
                    }
                    
                    return JSON.parse(responseText);
                })
                .then(data => {
                    console.log('‚úÖ Response data:', data);
                    if (data.success) {
                        const bookingTime = new Date(data.bookingTime).toLocaleString('vi-VN');
                        showToast(`‚úÖ X√°c nh·∫≠n th√†nh c√¥ng! Booking ID: ${data.bookingId} | Th·ªùi gian: ${bookingTime} | S·ªë ng∆∞·ªùi: ${data.partySize}`, 'success');
                        const modal = bootstrap.Modal.getInstance(document.getElementById('confirmWaitlistModal'));
                        if (modal) {
                            modal.hide();
                        }
                        // Reload after a short delay to show toast
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    } else {
                        showToast('‚ùå L·ªói: ' + (data.error || 'Kh√¥ng th·ªÉ x√°c nh·∫≠n waitlist'), 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('‚ùå L·ªói k·∫øt n·ªëi: ' + error.message, 'error');
                })
                .finally(() => {
                    // Restore button state
                    if (submitBtn) {
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    }
                });
            });
        } else {
            console.warn('‚ö†Ô∏è confirmWaitlistForm not found');
        }

        // Demo functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Attach event listeners for confirm waitlist buttons
            document.querySelectorAll('.confirm-waitlist-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const waitlistId = this.getAttribute('data-waitlist-id');
                    const preferredBookingTime = this.getAttribute('data-preferred-time') || '';
                    console.log('üîç Button clicked:', waitlistId, preferredBookingTime);
                    showConfirmWaitlistDialog(waitlistId, preferredBookingTime);
                });
            });
            
            // Status filter
            const statusFilter = document.querySelector('select');
            if (statusFilter) {
                statusFilter.addEventListener('change', function() {
                    console.log('Filter by status:', this.value);
                });
            }

            // Date filter
            const dateFilter = document.querySelector('input[type="date"]');
            if (dateFilter) {
                dateFilter.addEventListener('change', function() {
                    console.log('Filter by date:', this.value);
                });
            }
        });

        // Check-in customer
        function checkInCustomer(bookingId) {
            if (confirm('X√°c nh·∫≠n check-in kh√°ch h√†ng?')) {
                fetch(`/api/staff/table-status/check-in/${bookingId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Check-in th√†nh c√¥ng!');
                        location.reload();
                    } else {
                        alert('L·ªói: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('C√≥ l·ªói x·∫£y ra khi check-in');
                });
            }
        }

        // Check-out customer
        function checkOutCustomer(bookingId) {
            if (confirm('X√°c nh·∫≠n check-out kh√°ch h√†ng?')) {
                fetch(`/api/staff/table-status/check-out/${bookingId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Check-out th√†nh c√¥ng!');
                        location.reload();
                    } else {
                        alert('L·ªói: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('C√≥ l·ªói x·∫£y ra khi check-out');
                });
            }
        }
        
        // Show cancel modal for restaurant owner
        function showCancelModal(bookingId) {
            document.getElementById('cancelBookingId').value = bookingId;
            const modal = new bootstrap.Modal(document.getElementById('cancelModal'));
            modal.show();
        }
        
        // Handle cancel booking form submission
        const cancelForm = document.getElementById('cancelForm');
        if (cancelForm) {
            cancelForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const bookingId = document.getElementById('cancelBookingId').value;
                const cancelReason = document.getElementById('cancelReason').value;
                
                if (!cancelReason.trim()) {
                    alert('Vui l√≤ng nh·∫≠p l√Ω do h·ªßy booking');
                    return;
                }
                
                // Submit cancel request
                fetch(`/restaurant-owner/api/bookings/${bookingId}/cancel`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `cancelReason=${encodeURIComponent(cancelReason)}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('ƒê√£ h·ªßy booking v√† t·∫°o refund request!');
                        location.reload();
                    } else {
                        alert('L·ªói: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('C√≥ l·ªói x·∫£y ra khi h·ªßy booking');
                });
            });
        }
        // Note: cancelForm may not exist on this page, which is fine
    </script>

    <!-- Booking Detail Modal -->
    <div class="modal fade" id="bookingDetailModal" tabindex="-1" aria-labelledby="bookingDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bookingDetailModalLabel">
                        <i class="fas fa-calendar-check me-2"></i>
                        Chi ti·∫øt Booking
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Loading State -->
                    <div id="bookingDetailLoading" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">ƒêang t·∫£i...</span>
                        </div>
                        <p class="mt-3 text-muted">ƒêang t·∫£i th√¥ng tin booking...</p>
                    </div>

                    <!-- Error State -->
                    <div id="bookingDetailError" class="text-center py-5" style="display: none;">
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <span id="bookingDetailErrorMessage">Kh√¥ng th·ªÉ t·∫£i th√¥ng tin booking</span>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="loadBookingDetail()">
                            <i class="fas fa-refresh me-2"></i>
                            Th·ª≠ l·∫°i
                        </button>
                    </div>

                    <!-- Booking Detail Content -->
                    <div id="bookingDetailContent" style="display: none;">
                        <div class="row">
                            <!-- C·ªôt tr√°i -->
                            <div class="col-md-6">
                                <!-- Booking Summary -->
                                <div class="card mb-3">
                                    <div class="card-header d-flex align-items-center">
                                        <i class="fas fa-calendar-check me-2"></i>
                                        <h6 class="mb-0">Booking Summary</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="bookingSummary">
                                            <!-- Booking summary will be populated by JavaScript -->
                                        </div>
                                    </div>
                                </div>

                                <!-- Kh√°ch h√†ng -->
                                <div class="card mb-3">
                                    <div class="card-header d-flex align-items-center">
                                        <i class="fas fa-user me-2"></i>
                                        <h6 class="mb-0">Kh√°ch h√†ng</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="customerInfo">
                                            <!-- Customer info will be populated by JavaScript -->
                                        </div>
                                    </div>
                                </div>

                                <!-- B√†n & S∆° ƒë·ªì -->
                                <div class="card mb-3">
                                    <div class="card-header d-flex align-items-center justify-content-between">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-table me-2"></i>
                                            <h6 class="mb-0">B√†n & S∆° ƒë·ªì</h6>
                                        </div>
                                        <button class="btn btn-sm btn-outline-primary" onclick="openTableSelectionModal()">
                                            <i class="fas fa-exchange-alt me-1"></i>ƒê·ªïi b√†n
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <div id="assignedTables">
                                            <!-- Tables will be populated by JavaScript -->
                                        </div>
                                    </div>
                                </div>

                                <!-- Thanh to√°n/ƒê·∫∑t c·ªçc -->
                                <div class="card mb-3">
                                    <div class="card-header d-flex align-items-center justify-content-between">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-credit-card me-2"></i>
                                            <h6 class="mb-0">Thanh to√°n/ƒê·∫∑t c·ªçc</h6>
                                        </div>
                                        <button class="btn btn-sm btn-outline-danger" onclick="openRefundModal()">
                                            <i class="fas fa-undo me-1"></i>Refund
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <div id="paymentInfo">
                                            <!-- Payment info will be populated by JavaScript -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- C·ªôt ph·∫£i -->
                            <div class="col-md-6">
                                <!-- Timeline (Ho·∫°t ƒë·ªông) -->
                                <div class="card mb-3">
                                    <div class="card-header d-flex align-items-center">
                                        <i class="fas fa-history me-2"></i>
                                        <h6 class="mb-0">Timeline (Ho·∫°t ƒë·ªông)</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="activityTimeline">
                                            <!-- Activity timeline will be populated by JavaScript -->
                                        </div>
                                    </div>
                                </div>

                                <!-- Ghi ch√∫ n·ªôi b·ªô -->
                                <div class="card mb-3">
                                    <div class="card-header d-flex align-items-center justify-content-between">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-sticky-note me-2"></i>
                                            <h6 class="mb-0">Ghi ch√∫ n·ªôi b·ªô</h6>
                                        </div>
                                        <button class="btn btn-sm btn-outline-primary" onclick="addInternalNote()">
                                            <i class="fas fa-plus me-1"></i>Th√™m
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <div id="internalNotes">
                                            <!-- Internal notes will be populated by JavaScript -->
                                        </div>
                                    </div>
                                </div>

                                <!-- L·ªãch s·ª≠ li√™n l·∫°c -->
                                <div class="card mb-3">
                                    <div class="card-header d-flex align-items-center">
                                        <i class="fas fa-comments me-2"></i>
                                        <h6 class="mb-0">L·ªãch s·ª≠ li√™n l·∫°c</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="communicationHistory">
                                            <!-- Communication history will be populated by JavaScript -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Booking Actions -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">Qu·∫£n l√Ω Booking</h6>
                                        <p class="card-text text-muted">Th·ª±c hi·ªán c√°c thao t√°c qu·∫£n l√Ω ƒë·∫∑t b√†n</p>
                                        <div id="bookingActions" class="d-flex gap-2 justify-content-center flex-wrap">
                                            <!-- Actions will be populated by JavaScript -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>
                        ƒê√≥ng
                    </button>
                    <button type="button" class="btn btn-primary" onclick="refreshBookingsList()">
                        <i class="fas fa-refresh me-2"></i>
                        L√†m m·ªõi danh s√°ch
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Table Selection Modal -->
    <div class="modal fade" id="tableSelectionModal" tabindex="-1" aria-labelledby="tableSelectionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tableSelectionModalLabel">
                        <i class="fas fa-table me-2"></i>
                        Ch·ªçn b√†n m·ªõi
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="availableTables">
                        <!-- Available tables will be populated by JavaScript -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-primary" onclick="confirmTableChange()">X√°c nh·∫≠n</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Refund Modal -->
    <div class="modal fade" id="refundModal" tabindex="-1" aria-labelledby="refundModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="refundModalLabel">
                        <i class="fas fa-undo me-2"></i>
                        X√°c nh·∫≠n ho√†n ti·ªÅn
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ho√†n ti·ªÅn cho booking n√†y?
                    </div>
                    <div id="refundDetails">
                        <!-- Refund details will be populated by JavaScript -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-danger" onclick="confirmRefund()">X√°c nh·∫≠n ho√†n ti·ªÅn</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Internal Note Modal -->
    <div class="modal fade" id="addNoteModal" tabindex="-1" aria-labelledby="addNoteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addNoteModalLabel">
                        <i class="fas fa-sticky-note me-2"></i>
                        Th√™m ghi ch√∫ n·ªôi b·ªô
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="noteContent" class="form-label">N·ªôi dung ghi ch√∫</label>
                        <textarea class="form-control" id="noteContent" rows="4" placeholder="Nh·∫≠p ghi ch√∫ n·ªôi b·ªô..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-primary" onclick="saveInternalNote()">L∆∞u ghi ch√∫</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Booking Detail Modal JavaScript -->
    <script>
        let currentBookingId = null;
        let currentWaitlistId = null;

        function openBookingDetail(bookingId) {
            currentBookingId = bookingId;
            const modal = new bootstrap.Modal(document.getElementById('bookingDetailModal'));
            modal.show();
            loadBookingDetail();
        }

        function loadBookingDetail() {
            if (!currentBookingId) return;

            console.log("üöÄ Loading booking detail for ID:", currentBookingId);

            // Show loading state
            document.getElementById('bookingDetailLoading').style.display = 'block';
            document.getElementById('bookingDetailError').style.display = 'none';
            document.getElementById('bookingDetailContent').style.display = 'none';

            // Fetch booking detail
            const url = `/restaurant-owner/bookings/${currentBookingId}/api`;
            console.log("üì° Fetching from URL:", url);
            
            fetch(url, {
                method: 'GET',
                credentials: 'same-origin', // Include cookies/session
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    console.log("üì° Response status:", response.status);
                    console.log("üì° Response headers:", response.headers);
                    if (!response.ok) {
                        throw new Error('Network response was not ok: ' + response.status);
                    }
                    return response.text(); // First get as text to see what we're getting
                })
                .then(text => {
                    console.log("üì° Raw response:", text);
                    try {
                        const data = JSON.parse(text);
                        console.log("üì° Parsed JSON:", data);
                        if (data.success) {
                            populateBookingDetail(data.booking);
                            document.getElementById('bookingDetailLoading').style.display = 'none';
                            document.getElementById('bookingDetailContent').style.display = 'block';
                        } else {
                            throw new Error(data.message || 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin booking');
                        }
                    } catch (parseError) {
                        console.error("‚ùå JSON Parse Error:", parseError);
                        console.error("‚ùå Raw text that failed to parse:", text);
                        throw new Error('Response is not valid JSON: ' + text.substring(0, 100));
                    }
                })
                .catch(error => {
                    console.error('‚ùå Error loading booking detail:', error);
                    document.getElementById('bookingDetailLoading').style.display = 'none';
                    document.getElementById('bookingDetailError').style.display = 'block';
                    document.getElementById('bookingDetailErrorMessage').textContent = error.message;
                });
        }

        function populateBookingSummary(booking) {
            const bookingSummary = document.getElementById('bookingSummary');
            const statusClass = getStatusClass(booking.status);
            
            bookingSummary.innerHTML = `
                <div class="row">
                    <div class="col-6 mb-2">
                        <small class="text-muted">Th·ªùi gian</small>
                        <div class="fw-medium">${formatDateTime(booking.bookingTime)}</div>
                    </div>
                    <div class="col-6 mb-2">
                        <small class="text-muted">S·ªë kh√°ch</small>
                        <div class="fw-medium">${booking.numberOfGuests} ng∆∞·ªùi</div>
                    </div>
                    <div class="col-6 mb-2">
                        <small class="text-muted">B√†n</small>
                        <div class="fw-medium">${booking.bookingTables && booking.bookingTables.length > 0 ? booking.bookingTables.map(t => t.tableName).join(', ') : 'Ch∆∞a ch·ªçn'}</div>
                    </div>
                    <div class="col-6 mb-2">
                        <small class="text-muted">Ngu·ªìn ƒë·∫∑t</small>
                        <div class="fw-medium">Website</div>
                    </div>
                    <div class="col-12 mb-2">
                        <small class="text-muted">Ghi ch√∫ kh√°ch</small>
                        <div class="fw-medium">${booking.note || 'Kh√¥ng c√≥ ghi ch√∫'}</div>
                    </div>
                </div>
            `;
        }

        function populateCustomerInfo(booking) {
            const customerInfo = document.getElementById('customerInfo');
            
            customerInfo.innerHTML = `
                <div class="row">
                    <div class="col-12 mb-2">
                        <small class="text-muted">T√™n</small>
                        <div class="fw-medium">${booking.customer?.fullName || 'N/A'}</div>
                    </div>
                    <div class="col-6 mb-2">
                        <small class="text-muted">SƒêT</small>
                        <div class="fw-medium">${booking.customer?.phoneNumber || 'N/A'}</div>
                    </div>
                    <div class="col-6 mb-2">
                        <small class="text-muted">Email</small>
                        <div class="fw-medium">${booking.customer?.email || 'N/A'}</div>
                    </div>
                    <div class="col-6 mb-2">
                        <small class="text-muted">L·ªãch s·ª≠/No-show</small>
                        <div class="fw-medium">
                            <span class="badge bg-success">0 l·∫ßn</span>
                        </div>
                    </div>
                    <div class="col-6 mb-2">
                        <small class="text-muted">T·ªïng chi ti√™u</small>
                        <div class="fw-medium text-success">${formatCurrency(calculateTotalSpending(booking))}</div>
                    </div>
                </div>
            `;
        }

        function populateAssignedTables(booking) {
            const assignedTables = document.getElementById('assignedTables');
            
            if (booking.bookingTables && booking.bookingTables.length > 0) {
                assignedTables.innerHTML = booking.bookingTables.map(table => `
                    <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded mb-2">
                        <div>
                            <div class="fw-medium">${table.tableName}</div>
                            <small class="text-muted">Ph√¢n b√†n: ${formatDateTime(table.assignedAt)}</small>
                        </div>
                        <span class="badge bg-success">ƒê√£ ph√¢n</span>
                    </div>
                `).join('');
            } else {
                assignedTables.innerHTML = `
                    <div class="text-center py-3">
                        <i class="fas fa-table text-muted fa-2x mb-2"></i>
                        <p class="text-muted mb-0">Ch∆∞a ph√¢n b√†n</p>
                    </div>
                `;
            }
        }

function populatePaymentInfo(booking) {
    const paymentInfo = document.getElementById('paymentInfo');
    const tableFeesTotal = booking.bookingTables ? booking.bookingTables.reduce((sum, table) => sum + (table.tableFee || 0), 0) : 0;
    const dishesTotal = booking.bookingDishes ? booking.bookingDishes.reduce((sum, dish) => sum + dish.totalPrice, 0) : 0;
    const servicesTotal = booking.bookingServices ? booking.bookingServices.reduce((sum, service) => sum + service.totalPrice, 0) : 0;
    const totalAmount = tableFeesTotal + dishesTotal + servicesTotal; // Total = subtotal (kh√¥ng c·ªông deposit)
    
    // Create dishes list HTML
    let dishesListHtml = '';
    if (booking.bookingDishes && booking.bookingDishes.length > 0) {
        dishesListHtml = `
            <div class="invoice-section-compact">
                <h6 class="invoice-section-title-compact">
                    <i class="fas fa-utensils me-1"></i>
                    M√≥n ƒÉn (${booking.bookingDishes.length})
                </h6>
                <div class="invoice-items-compact">
        `;
        
        booking.bookingDishes.forEach((dish, index) => {
            dishesListHtml += `
                <div class="invoice-item-compact d-flex justify-content-between align-items-center py-1 ${index < booking.bookingDishes.length - 1 ? 'border-bottom' : ''}">
                    <div class="flex-grow-1">
                        <div class="fw-medium text-dark small">${dish.dishName}</div>
                        <small class="text-muted">${dish.formattedPrice} √ó ${dish.quantity}</small>
                    </div>
                    <div class="text-end ms-2">
                        <div class="fw-medium text-primary small">${dish.formattedTotalPrice}</div>
                    </div>
                </div>
            `;
        });
        
        dishesListHtml += `
                </div>
            </div>
        `;
    }
    
    // Create services list HTML
    let servicesListHtml = '';
    if (booking.bookingServices && booking.bookingServices.length > 0) {
        servicesListHtml = `
            <div class="invoice-section-compact">
                <h6 class="invoice-section-title-compact">
                    <i class="fas fa-concierge-bell me-1"></i>
                    D·ªãch v·ª• (${booking.bookingServices.length})
                </h6>
                <div class="invoice-items-compact">
        `;
        
        booking.bookingServices.forEach((service, index) => {
            servicesListHtml += `
                <div class="invoice-item-compact d-flex justify-content-between align-items-center py-1 ${index < booking.bookingServices.length - 1 ? 'border-bottom' : ''}">
                    <div class="flex-grow-1">
                        <div class="fw-medium text-dark small">${service.serviceName}</div>
                        <small class="text-muted">${service.formattedPrice} √ó ${service.quantity}</small>
                    </div>
                    <div class="text-end ms-2">
                        <div class="fw-medium text-primary small">${service.formattedTotalPrice}</div>
                    </div>
                </div>
            `;
        });
        
        servicesListHtml += `
                </div>
            </div>
        `;
    }
    
    paymentInfo.innerHTML = `
        <div class="invoice-container">
            <div class="invoice-body">
                ${dishesListHtml}
                ${servicesListHtml}
                
                <div class="invoice-totals">
                    <div class="invoice-total-item">
                        <span class="text-muted">Ph√≠ b√†n:</span>
                        <span class="fw-medium">${formatCurrency(tableFeesTotal)}</span>
                    </div>
                    <div class="invoice-total-item">
                        <span class="text-muted">T·ªïng m√≥n ƒÉn:</span>
                        <span class="fw-medium">${formatCurrency(dishesTotal)}</span>
                    </div>
                    <div class="invoice-total-item">
                        <span class="text-muted">T·ªïng d·ªãch v·ª•:</span>
                        <span class="fw-medium">${formatCurrency(servicesTotal)}</span>
                    </div>
                    <div class="invoice-total-item invoice-total-final">
                        <span class="fw-bold">T·ªïng c·ªông:</span>
                        <span class="fw-bold text-primary fs-5">${formatCurrency(totalAmount)}</span>
                    </div>
                    <div class="invoice-total-item" style="border-top: 1px dashed #dee2e6; padding-top: 0.5rem; margin-top: 0.5rem;">
                        <span class="text-muted">Ti·ªÅn ƒë·∫∑t c·ªçc (10%):</span>
                        <span class="fw-medium text-warning">${formatCurrency(booking.depositAmount || 0)}</span>
                    </div>
                </div>
            </div>
        </div>
    `;
}

        function populateActivityTimeline(booking) {
            const activityTimeline = document.getElementById('activityTimeline');
            
            let timelineContent = `
                <div class="d-flex align-items-start mb-3">
                    <div class="bg-primary rounded-circle p-1 me-3 mt-1" style="width: 8px; height: 8px;"></div>
                    <div class="flex-grow-1">
                        <div class="fw-medium">Created</div>
                        <small class="text-muted">${formatDateTime(booking.createdAt)}</small>
                        <div class="text-muted small">H·ªá th·ªëng</div>
                    </div>
                </div>
            `;
            
            if (booking.status === 'CONFIRMED' || booking.status === 'COMPLETED' || booking.status === 'CANCELLED') {
                timelineContent += `
                    <div class="d-flex align-items-start mb-3">
                        <div class="bg-success rounded-circle p-1 me-3 mt-1" style="width: 8px; height: 8px;"></div>
                        <div class="flex-grow-1">
                            <div class="fw-medium">Confirmed</div>
                            <small class="text-muted">${formatDateTime(booking.updatedAt)}</small>
                            <div class="text-muted small">Restaurant Owner</div>
                        </div>
                    </div>
                `;
            }
            
            if (booking.status === 'COMPLETED') {
                timelineContent += `
                    <div class="d-flex align-items-start mb-3">
                        <div class="bg-info rounded-circle p-1 me-3 mt-1" style="width: 8px; height: 8px;"></div>
                        <div class="flex-grow-1">
                            <div class="fw-medium">Completed</div>
                            <small class="text-muted">${formatDateTime(booking.updatedAt)}</small>
                            <div class="text-muted small">Restaurant Owner</div>
                        </div>
                    </div>
                `;
            }
            
            if (booking.status === 'CANCELLED') {
                timelineContent += `
                    <div class="d-flex align-items-start mb-3">
                        <div class="bg-danger rounded-circle p-1 me-3 mt-1" style="width: 8px; height: 8px;"></div>
                        <div class="flex-grow-1">
                            <div class="fw-medium">Cancelled</div>
                            <small class="text-muted">${formatDateTime(booking.updatedAt)}</small>
                            <div class="text-muted small">Restaurant Owner</div>
                        </div>
                    </div>
                `;
            }
            
            activityTimeline.innerHTML = timelineContent;
        }

        function populateInternalNotes(booking) {
            const internalNotes = document.getElementById('internalNotes');
            
            // Use real data from API
            const notes = booking.internalNotes || [];
            
            if (notes.length > 0) {
                internalNotes.innerHTML = notes.map(note => `
                    <div class="d-flex justify-content-between align-items-start p-2 bg-light rounded mb-2">
                        <div class="flex-grow-1">
                            <div class="fw-medium">${note.content}</div>
                            <small class="text-muted">${note.author} - ${formatDateTime(note.createdAt)}</small>
                        </div>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteInternalNote(${note.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('');
            } else {
                internalNotes.innerHTML = `
                    <div class="text-center py-3">
                        <i class="fas fa-sticky-note text-muted fa-2x mb-2"></i>
                        <p class="text-muted mb-0">Ch∆∞a c√≥ ghi ch√∫ n·ªôi b·ªô</p>
                    </div>
                `;
            }
        }

        function populateCommunicationHistory(booking) {
            const communicationHistory = document.getElementById('communicationHistory');
            
            // Use real data from API
            const communications = booking.communicationHistory || [];
            
            if (communications.length > 0) {
                communicationHistory.innerHTML = communications.map(comm => `
                    <div class="d-flex align-items-start p-2 bg-light rounded mb-2">
                        <div class="me-2">
                            <i class="fas ${comm.type === 'MESSAGE' ? 'fa-comment' : comm.type === 'CALL' ? 'fa-phone' : 'fa-envelope'} 
                               ${comm.direction === 'INCOMING' ? 'text-primary' : 'text-success'}"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="fw-medium">${comm.content}</div>
                            <small class="text-muted">${formatDateTime(comm.timestamp)}</small>
                        </div>
                    </div>
                `).join('');
            } else {
                communicationHistory.innerHTML = `
                    <div class="text-center py-3">
                        <i class="fas fa-comments text-muted fa-2x mb-2"></i>
                        <p class="text-muted mb-0">Ch∆∞a c√≥ l·ªãch s·ª≠ li√™n l·∫°c</p>
                    </div>
                `;
            }
        }

        function calculateTotalSpending(booking) {
            const tableFeesTotal = booking.bookingTables ? booking.bookingTables.reduce((sum, table) => sum + (table.tableFee || 0), 0) : 0;
            const dishesTotal = booking.bookingDishes ? booking.bookingDishes.reduce((sum, dish) => sum + dish.totalPrice, 0) : 0;
            const servicesTotal = booking.bookingServices ? booking.bookingServices.reduce((sum, service) => sum + service.totalPrice, 0) : 0;
            return tableFeesTotal + dishesTotal + servicesTotal; // Total = subtotal (kh√¥ng c·ªông deposit)
        }

        function populateBookingActions(booking) {
            const actionsContainer = document.getElementById('bookingActions');
            let actions = '';

            if (booking.status === 'PENDING') {
                actions += `
                    <form style="display: inline;" onsubmit="updateBookingStatus(event, 'CONFIRMED')">
                        <button type="submit" class="btn btn-success btn-sm">
                            <i class="fas fa-check me-1"></i>X√°c nh·∫≠n
                        </button>
                    </form>
                `;
            }

            if (booking.status === 'PENDING' || booking.status === 'CONFIRMED') {
                actions += `
                    <form style="display: inline;" onsubmit="updateBookingStatus(event, 'CANCELLED')">
                        <button type="submit" class="btn btn-danger btn-sm">
                            <i class="fas fa-times me-1"></i>H·ªßy
                        </button>
                    </form>
                `;
            }

            if (booking.status === 'CONFIRMED') {
                actions += `
                    <form style="display: inline;" onsubmit="updateBookingStatus(event, 'COMPLETED')">
                        <button type="submit" class="btn btn-info btn-sm">
                            <i class="fas fa-check-circle me-1"></i>Ho√†n th√†nh
                        </button>
                    </form>
                    <form style="display: inline;" onsubmit="updateBookingStatus(event, 'NO_SHOW')">
                        <button type="submit" class="btn btn-warning btn-sm">
                            <i class="fas fa-user-times me-1"></i>No Show
                        </button>
                    </form>
                `;
            }

            actionsContainer.innerHTML = actions;
        }

        function updateBookingStatus(event, status) {
            event.preventDefault();
            
            if (!currentBookingId) return;

            const formData = new FormData();
            formData.append('status', status);

            fetch(`/restaurant-owner/bookings/${currentBookingId}/status`, {
                method: 'POST',
                credentials: 'same-origin', // Include cookies/session
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('C·∫≠p nh·∫≠t tr·∫°ng th√°i th√†nh c√¥ng!');
                    loadBookingDetail(); // Reload booking detail
                    refreshBookingsList(); // Refresh the main bookings list
                } else {
                    alert('L·ªói: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t tr·∫°ng th√°i');
            });
        }

        function getStatusClass(status) {
            switch (status) {
                case 'PENDING': return 'bg-warning text-dark';
                case 'CONFIRMED': return 'bg-success';
                case 'CANCELLED': return 'bg-danger';
                case 'COMPLETED': return 'bg-info';
                case 'NO_SHOW': return 'bg-secondary';
                default: return 'bg-secondary';
            }
        }

        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN') + ' ' + date.toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'});
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        function refreshBookingsList() {
            // Reload the current page to refresh the bookings list
            window.location.reload();
        }

        // Toast Notification Function
        function showToast(message, type = 'success') {
            const toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                // Fallback to alert if toast container doesn't exist
                alert(message);
                return;
            }
            
            const toastId = 'toast-' + Date.now();
            const toastElement = document.createElement('div');
            toastElement.id = toastId;
            toastElement.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} border-0`;
            toastElement.setAttribute('role', 'alert');
            toastElement.setAttribute('aria-live', 'assertive');
            toastElement.setAttribute('aria-atomic', 'true');
            
            const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle';
            toastElement.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-${icon} me-2"></i>
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            
            toastContainer.appendChild(toastElement);
            
            const toast = new bootstrap.Toast(toastElement, {
                autohide: true,
                delay: 5000
            });
            
            toast.show();
            
            // Remove toast element after it's hidden
            toastElement.addEventListener('hidden.bs.toast', function() {
                if (toastElement && toastElement.parentNode) {
                    toastElement.remove();
                }
            });
        }

        // Waitlist Detail Modal JavaScript
        function openWaitlistDetail(waitlistId) {
            currentWaitlistId = waitlistId;
            const modal = new bootstrap.Modal(document.getElementById('waitlistDetailModal'));
            modal.show();
            loadWaitlistDetail();
        }

        function loadWaitlistDetail() {
            if (!currentWaitlistId) return;

            console.log("üöÄ Loading waitlist detail for ID:", currentWaitlistId);

            // Show loading state
            document.getElementById('waitlistDetailLoading').style.display = 'block';
            document.getElementById('waitlistDetailError').style.display = 'none';
            document.getElementById('waitlistDetailContent').style.display = 'none';

            // Fetch waitlist detail
            const url = `/restaurant-owner/waitlist/${currentWaitlistId}/detail`;
            console.log("üì° Fetching from URL:", url);
            
            fetch(url, {
                method: 'GET',
                credentials: 'same-origin',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                console.log("üì° Response status:", response.status);
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log("üì° Parsed JSON:", data);
                if (data.success) {
                    populateWaitlistDetail(data.waitlist);
                    document.getElementById('waitlistDetailLoading').style.display = 'none';
                    document.getElementById('waitlistDetailContent').style.display = 'block';
                } else {
                    throw new Error(data.error || 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin waitlist');
                }
            })
            .catch(error => {
                console.error('‚ùå Error loading waitlist detail:', error);
                document.getElementById('waitlistDetailLoading').style.display = 'none';
                document.getElementById('waitlistDetailError').style.display = 'block';
                document.getElementById('waitlistDetailErrorMessage').textContent = error.message || 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin waitlist';
            });
        }

        function populateWaitlistDetail(waitlist) {
            populateWaitlistSummary(waitlist);
            populateWaitlistCustomerInfo(waitlist);
            populateWaitlistInfo(waitlist);
            populateWaitlistTables(waitlist);
            populateWaitlistDishes(waitlist);
            populateWaitlistServices(waitlist);
            populateWaitlistActions(waitlist);
        }

        function populateWaitlistSummary(waitlist) {
            const summary = document.getElementById('waitlistSummary');
            summary.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-muted">Waitlist ID:</span>
                    <span class="fw-bold">#WL${waitlist.waitlistId}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-muted">Tr·∫°ng th√°i:</span>
                    <span class="badge ${getWaitlistStatusClass(waitlist.status)}">${waitlist.status}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-muted">S·ªë ng∆∞·ªùi:</span>
                    <span class="fw-medium">${waitlist.partySize} ng∆∞·ªùi</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-muted">Th·ªùi gian tham gia:</span>
                    <span class="fw-medium">${formatDateTime(waitlist.joinTime)}</span>
                </div>
                ${waitlist.preferredBookingTime ? `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-muted">Th·ªùi gian mong mu·ªën:</span>
                    <span class="fw-medium">${formatDateTime(waitlist.preferredBookingTime)}</span>
                </div>
                ` : ''}
                ${waitlist.queuePosition ? `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-muted">V·ªã tr√≠:</span>
                    <span class="fw-medium">#${waitlist.queuePosition}</span>
                </div>
                ` : ''}
                ${waitlist.estimatedWaitTime ? `
                <div class="d-flex justify-content-between align-items-center">
                    <span class="text-muted">Th·ªùi gian ch·ªù ∆∞·ªõc t√≠nh:</span>
                    <span class="fw-medium">${waitlist.estimatedWaitTime} ph√∫t</span>
                </div>
                ` : ''}
            `;
        }

        function populateWaitlistCustomerInfo(waitlist) {
            const customerInfo = document.getElementById('waitlistCustomerInfo');
            customerInfo.innerHTML = `
                <div class="mb-2">
                    <span class="text-muted">T√™n:</span>
                    <span class="fw-medium ms-2">${waitlist.customerName || 'N/A'}</span>
                </div>
                ${waitlist.customerPhone ? `
                <div class="mb-2">
                    <span class="text-muted">S·ªë ƒëi·ªán tho·∫°i:</span>
                    <span class="fw-medium ms-2">${waitlist.customerPhone}</span>
                </div>
                ` : ''}
                ${waitlist.customerEmail ? `
                <div class="mb-2">
                    <span class="text-muted">Email:</span>
                    <span class="fw-medium ms-2">${waitlist.customerEmail}</span>
                </div>
                ` : ''}
            `;
        }

        function populateWaitlistInfo(waitlist) {
            const info = document.getElementById('waitlistInfo');
            info.innerHTML = `
                <div class="mb-2">
                    <span class="text-muted">Nh√† h√†ng:</span>
                    <span class="fw-medium ms-2">${waitlist.restaurantName || 'N/A'}</span>
                </div>
                ${waitlist.specialRequests ? `
                <div class="mb-2">
                    <span class="text-muted">Y√™u c·∫ßu ƒë·∫∑c bi·ªát:</span>
                    <span class="ms-2">${waitlist.specialRequests}</span>
                </div>
                ` : ''}
            `;
        }

        function populateWaitlistTables(waitlist) {
            const tables = document.getElementById('waitlistTables');
            if (waitlist.tables && waitlist.tables.length > 0) {
                tables.innerHTML = waitlist.tables.map(table => {
                    const tableFee = table.tableFee ? new Intl.NumberFormat('vi-VN').format(table.tableFee) + '‚Ç´' : '0‚Ç´';
                    return `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>${table.tableName}</span>
                        <div>
                            <span class="badge bg-info me-2">${table.capacity} ng∆∞·ªùi</span>
                            <span class="badge bg-success">${tableFee}</span>
                        </div>
                    </div>
                `;
                }).join('');
            } else {
                tables.innerHTML = '<p class="text-muted mb-0">Kh√¥ng c√≥ b√†n mong mu·ªën</p>';
            }
        }

        function populateWaitlistDishes(waitlist) {
            const dishes = document.getElementById('waitlistDishes');
            if (waitlist.dishes && waitlist.dishes.length > 0) {
                dishes.innerHTML = waitlist.dishes.map(dish => `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>${dish.dishName}</span>
                        <span class="badge bg-warning text-dark">x${dish.quantity}</span>
                    </div>
                `).join('');
            } else {
                dishes.innerHTML = '<p class="text-muted mb-0">Kh√¥ng c√≥ m√≥n ƒÉn</p>';
            }
        }

        function populateWaitlistServices(waitlist) {
            const services = document.getElementById('waitlistServices');
            if (waitlist.services && waitlist.services.length > 0) {
                services.innerHTML = waitlist.services.map(service => {
                    const price = service.price ? new Intl.NumberFormat('vi-VN').format(service.price) + '‚Ç´' : '';
                    return `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>${service.serviceName}</span>
                        <span class="badge bg-info">${price}</span>
                    </div>
                `;
                }).join('');
            } else {
                services.innerHTML = '<p class="text-muted mb-0">Kh√¥ng c√≥ d·ªãch v·ª•</p>';
            }
        }

        function populateWaitlistActions(waitlist) {
            const actions = document.getElementById('waitlistActions');
            let actionsHtml = '';
            
            if (waitlist.status === 'WAITING') {
                actionsHtml += `
                    <button class="btn btn-success btn-sm" onclick="showConfirmWaitlistDialog(${waitlist.waitlistId}, '${waitlist.preferredBookingTime || ''}')">
                        <i class="fas fa-check me-1"></i>X√°c nh·∫≠n Booking
                    </button>
                `;
            }
            
            if (waitlist.status === 'WAITING' || waitlist.status === 'CALLED') {
                actionsHtml += `
                    <button class="btn btn-danger btn-sm" onclick="cancelWaitlist(${waitlist.waitlistId})">
                        <i class="fas fa-times me-1"></i>H·ªßy Waitlist
                    </button>
                `;
            }
            
            actions.innerHTML = actionsHtml || '<p class="text-muted mb-0">Kh√¥ng c√≥ thao t√°c kh·∫£ d·ª•ng</p>';
        }

        function getWaitlistStatusClass(status) {
            switch(status) {
                case 'WAITING': return 'bg-warning text-dark';
                case 'CALLED': return 'bg-info';
                case 'SEATED': return 'bg-success';
                case 'CANCELLED': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }

        function cancelWaitlist(waitlistId) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy waitlist n√†y?')) return;
            
            fetch(`/restaurant-owner/waitlist/cancel/${waitlistId}`, {
                method: 'POST',
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ ƒê√£ h·ªßy waitlist th√†nh c√¥ng!');
                    location.reload();
                } else {
                    alert('‚ùå L·ªói: ' + (data.error || 'Kh√¥ng th·ªÉ h·ªßy waitlist'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('‚ùå L·ªói k·∫øt n·ªëi: ' + error.message);
            });
        }

        // Modal functions
        function openTableSelectionModal() {
            // Show loading state
            const availableTablesDiv = document.getElementById('availableTables');
            availableTablesDiv.innerHTML = `
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">ƒêang t·∫£i...</span>
                    </div>
                    <p class="mt-2 text-muted">ƒêang t·∫£i danh s√°ch b√†n...</p>
                </div>
            `;
            
            // Show modal first
            const modal = new bootstrap.Modal(document.getElementById('tableSelectionModal'));
            modal.show();
            
            // Fetch available tables from API
            const url = `/restaurant-owner/bookings/${currentBookingId}/available-tables`;
            console.log("üì° Fetching available tables from:", url);
            
            fetch(url, {
                method: 'GET',
                credentials: 'same-origin',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                console.log("üì° Response status:", response.status);
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log("üì° Available tables data:", data);
                if (data.success) {
                    populateAvailableTables(data.availableTables);
                } else {
                    throw new Error(data.message || 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch b√†n');
                }
            })
            .catch(error => {
                console.error('‚ùå Error loading available tables:', error);
                availableTablesDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        L·ªói khi t·∫£i danh s√°ch b√†n: ${error.message}
                    </div>
                `;
            });
        }

        function populateAvailableTables(tables) {
            const availableTablesDiv = document.getElementById('availableTables');
            
            if (tables.length > 0) {
                availableTablesDiv.innerHTML = tables.map(table => `
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="selectedTable" value="${table.id}" 
                               id="table${table.id}">
                        <label class="form-check-label" for="table${table.id}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="fw-medium">${table.name}</span>
                                    <small class="text-muted ms-2">(${table.capacity} ng∆∞·ªùi)</small>
                                </div>
                                <span class="badge bg-success">Tr·ªëng</span>
                            </div>
                        </label>
                    </div>
                `).join('');
            } else {
                availableTablesDiv.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Kh√¥ng c√≥ b√†n n√†o kh·∫£ d·ª•ng ƒë·ªÉ ƒë·ªïi
                    </div>
                `;
            }
        }

        function confirmTableChange() {
            const selectedTable = document.querySelector('input[name="selectedTable"]:checked');
            if (!selectedTable) {
                alert('Vui l√≤ng ch·ªçn b√†n m·ªõi');
                return;
            }
            
            const newTableId = selectedTable.value;
            const tableName = selectedTable.nextElementSibling.querySelector('.fw-medium').textContent;
            
            console.log("üîÑ Changing table to:", newTableId, tableName);
            
            // Show loading state
            const modalFooter = document.querySelector('#tableSelectionModal .modal-footer');
            const originalFooter = modalFooter.innerHTML;
            modalFooter.innerHTML = `
                <div class="spinner-border spinner-border-sm me-2" role="status">
                    <span class="visually-hidden">ƒêang x·ª≠ l√Ω...</span>
                </div>
                ƒêang ƒë·ªïi b√†n...
            `;
            
            // Make API call to change table
            const url = `/restaurant-owner/bookings/${currentBookingId}/change-table`;
            fetch(url, {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `newTableId=${newTableId}`
            })
            .then(response => {
                console.log("üì° Change table response status:", response.status);
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log("üì° Change table response:", data);
                if (data.success) {
                    alert(data.message || `ƒê√£ ƒë·ªïi b√†n th√†nh c√¥ng sang b√†n ${tableName}`);
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('tableSelectionModal'));
                    modal.hide();
                    
                    // Refresh the booking detail
                    loadBookingDetail();
                } else {
                    throw new Error(data.message || 'Kh√¥ng th·ªÉ ƒë·ªïi b√†n');
                }
            })
            .catch(error => {
                console.error('‚ùå Error changing table:', error);
                alert('L·ªói khi ƒë·ªïi b√†n: ' + error.message);
            })
            .finally(() => {
                // Restore original footer
                modalFooter.innerHTML = originalFooter;
            });
        }

        function openRefundModal() {
            const refundDetails = document.getElementById('refundDetails');
            refundDetails.innerHTML = `
                <div class="row">
                    <div class="col-6">
                        <small class="text-muted">S·ªë ti·ªÅn ƒë·∫∑t c·ªçc</small>
                        <div class="fw-bold text-primary">${formatCurrency(currentBooking?.depositAmount || 0)}</div>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Ph∆∞∆°ng th·ª©c ho√†n ti·ªÅn</small>
                        <div class="fw-medium">MoMo</div>
                    </div>
                </div>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('refundModal'));
            modal.show();
        }

        function confirmRefund() {
            // In real implementation, this would make an API call to process refund
            alert('ƒê√£ x·ª≠ l√Ω ho√†n ti·ªÅn th√†nh c√¥ng');
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('refundModal'));
            modal.hide();
            
            // Refresh the booking detail
            loadBookingDetail();
        }

        function addInternalNote() {
            const modal = new bootstrap.Modal(document.getElementById('addNoteModal'));
            modal.show();
        }

        function saveInternalNote() {
            const noteContent = document.getElementById('noteContent').value.trim();
            if (!noteContent) {
                alert('Vui l√≤ng nh·∫≠p n·ªôi dung ghi ch√∫');
                return;
            }
            
            console.log("üíæ Saving internal note:", noteContent);
            
            // Show loading state
            const modalFooter = document.querySelector('#addNoteModal .modal-footer');
            const originalFooter = modalFooter.innerHTML;
            modalFooter.innerHTML = `
                <div class="spinner-border spinner-border-sm me-2" role="status">
                    <span class="visually-hidden">ƒêang l∆∞u...</span>
                </div>
                ƒêang l∆∞u ghi ch√∫...
            `;
            
            // Make API call to add note
            const url = `/restaurant-owner/bookings/${currentBookingId}/add-note`;
            fetch(url, {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `content=${encodeURIComponent(noteContent)}`
            })
            .then(response => {
                console.log("üì° Add note response status:", response.status);
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log("üì° Add note response:", data);
                if (data.success) {
                    alert(data.message || 'ƒê√£ th√™m ghi ch√∫ th√†nh c√¥ng');
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addNoteModal'));
                    modal.hide();
                    
                    // Clear form
                    document.getElementById('noteContent').value = '';
                    
                    // Refresh the booking detail to show new note
                    loadBookingDetail();
                } else {
                    throw new Error(data.message || 'Kh√¥ng th·ªÉ th√™m ghi ch√∫');
                }
            })
            .catch(error => {
                console.error('‚ùå Error adding note:', error);
                alert('L·ªói khi th√™m ghi ch√∫: ' + error.message);
            })
            .finally(() => {
                // Restore original footer
                modalFooter.innerHTML = originalFooter;
            });
        }

        function deleteInternalNote(noteId) {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ghi ch√∫ n√†y?')) {
                console.log("üóëÔ∏è Deleting internal note:", noteId);
                
                // Make API call to delete note
                const url = `/restaurant-owner/bookings/${currentBookingId}/delete-note`;
                fetch(url, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: `noteId=${noteId}`
                })
                .then(response => {
                    console.log("üì° Delete note response status:", response.status);
                    if (!response.ok) {
                        throw new Error('Network response was not ok: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("üì° Delete note response:", data);
                    if (data.success) {
                        alert(data.message || 'ƒê√£ x√≥a ghi ch√∫ th√†nh c√¥ng');
                        
                        // Refresh the booking detail to remove the note
                        loadBookingDetail();
                    } else {
                        throw new Error(data.message || 'Kh√¥ng th·ªÉ x√≥a ghi ch√∫');
                    }
                })
                .catch(error => {
                    console.error('‚ùå Error deleting note:', error);
                    alert('L·ªói khi x√≥a ghi ch√∫: ' + error.message);
                });
            }
        }

        // Store current booking data globally for modal functions
        let currentBooking = null;

        function populateBookingDetail(booking) {
            currentBooking = booking; // Store globally
            
            // Update modal title
            document.getElementById('bookingDetailModalLabel').innerHTML = 
                `<i class="fas fa-calendar-check me-2"></i>Booking #BK${booking.bookingId.toString().padStart(3, '0')}`;

            // Populate Booking Summary
            populateBookingSummary(booking);
            
            // Populate Customer Info
            populateCustomerInfo(booking);
            
            // Populate Assigned Tables
            populateAssignedTables(booking);
            
            // Populate Payment Info
            populatePaymentInfo(booking);
            
            // Populate Activity Timeline
            populateActivityTimeline(booking);
            
            // Populate Internal Notes
            populateInternalNotes(booking);
            
            // Populate Communication History
            populateCommunicationHistory(booking);

            // Populate actions
            populateBookingActions(booking);
        }

        // Cancel booking function with bank account info
        function cancelBooking(bookingId) {
            // Check payment status first
            checkPaymentStatusAndCancel(bookingId);
        }
        
        // New function to check payment status before showing modal
        function checkPaymentStatusAndCancel(bookingId) {
            console.log('üîç Checking payment status for booking:', bookingId);
            
            fetch(`/restaurant-owner/api/bookings/${bookingId}/payment-status`, {
                method: 'GET',
                credentials: 'same-origin',
                headers: {
                    'Accept': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('üì° Payment status response:', data);
                
                if (!data.success) {
                    showToast('L·ªói: ' + (data.message || 'Kh√¥ng th·ªÉ ki·ªÉm tra tr·∫°ng th√°i thanh to√°n'), 'error');
                    return;
                }
                
                const paymentStatus = data.paymentStatus;
                const hasPayment = data.hasPayment;
                
                // If payment is COMPLETED, show bank account modal
                if (hasPayment && paymentStatus === 'COMPLETED') {
                    console.log('‚úÖ Payment is COMPLETED - showing bank account modal');
                    showCancelBookingModal(bookingId);
                } else {
                    // If payment is PENDING or no payment, cancel booking directly
                    console.log('‚ÑπÔ∏è Payment is PENDING or no payment - canceling booking directly');
                    cancelBookingDirectly(bookingId);
                }
            })
            .catch(error => {
                console.error('‚ùå Error checking payment status:', error);
                showToast('L·ªói khi ki·ªÉm tra tr·∫°ng th√°i thanh to√°n. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
            });
        }
        
        // New function to cancel booking directly (without bank account modal)
        function cancelBookingDirectly(bookingId) {
            // Store booking ID
            window.currentCancelBookingId = bookingId;
            
            // Set booking ID in modal
            document.getElementById('cancelReasonBookingId').value = bookingId;
            
            // Reset form
            document.getElementById('cancelReasonForm').reset();
            document.getElementById('cancelReasonBookingId').value = bookingId;
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('cancelReasonModal'));
            modal.show();
        }
        
        // Handle cancel reason form submission for restaurant owner
        document.addEventListener('DOMContentLoaded', function() {
            const confirmCancelReasonBtn = document.getElementById('confirmCancelReasonBtn');
            if (confirmCancelReasonBtn) {
                confirmCancelReasonBtn.addEventListener('click', function() {
                    const bookingId = document.getElementById('cancelReasonBookingId').value || window.currentCancelBookingId;
                    const cancelReason = document.getElementById('cancelReasonInput').value;
                    
                    if (!cancelReason || cancelReason.trim() === '') {
                        showToast('Vui l√≤ng nh·∫≠p l√Ω do h·ªßy booking', 'error');
                        return;
                    }
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('cancelReasonModal'));
                    if (modal) {
                        modal.hide();
                    }
                    
                    // Disable button
                    const submitBtn = this;
                    const originalText = submitBtn.innerHTML;
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> ƒêang x·ª≠ l√Ω...';
                    
                    // Submit cancel request without bank account info
                    fetch(`/restaurant-owner/api/bookings/${bookingId}/cancel`, {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'Accept': 'application/json'
                        },
                        body: `cancelReason=${encodeURIComponent(cancelReason)}&bankCode=&accountNumber=`
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showToast('‚úÖ ƒê√£ h·ªßy booking th√†nh c√¥ng!', 'success');
                            setTimeout(() => {
                                location.reload();
                            }, 1500);
                        } else {
                            showToast('‚ùå L·ªói: ' + (data.error || 'Kh√¥ng th·ªÉ h·ªßy booking'), 'error');
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = originalText;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showToast('‚ùå L·ªói k·∫øt n·ªëi: ' + error.message, 'error');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                    });
                });
            }
        });

        function showCancelBookingModal(bookingId) {
            // Create modal HTML
            const modalHtml = `
                <div class="modal fade" id="cancelBookingModal" tabindex="-1" aria-labelledby="cancelBookingModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="cancelBookingModalLabel">
                                    <i class="fas fa-times-circle text-danger me-2"></i>H·ªßy Booking
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>L∆∞u √Ω:</strong> H·ªßy booking s·∫Ω t·ª± ƒë·ªông t·∫°o refund request cho kh√°ch h√†ng.
                                </div>
                                
                                <form id="cancelBookingForm">
                                    <div class="mb-3">
                                        <label for="cancelReason" class="form-label">
                                            <i class="fas fa-comment me-1"></i>L√Ω do h·ªßy booking <span class="text-danger">*</span>
                                        </label>
                                        <textarea class="form-control" id="cancelReason" name="cancelReason" rows="3" 
                                                  placeholder="Nh·∫≠p l√Ω do h·ªßy booking..." required></textarea>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="bankCode" class="form-label">
                                            <i class="fas fa-university me-1"></i>M√£ ng√¢n h√†ng <span class="text-danger">*</span>
                                        </label>
                                        <select class="form-select" id="bankCode" name="bankCode" required>
                                            <option value="">ƒêang t·∫£i danh s√°ch ng√¢n h√†ng...</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="accountNumber" class="form-label">
                                            <i class="fas fa-credit-card me-1"></i>S·ªë t√†i kho·∫£n <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="accountNumber" name="accountNumber" 
                                               placeholder="Nh·∫≠p s·ªë t√†i kho·∫£n..." required>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-1"></i>H·ªßy
                                </button>
                                <button type="button" class="btn btn-danger" onclick="submitCancelBooking(${bookingId})">
                                    <i class="fas fa-check me-1"></i>X√°c nh·∫≠n h·ªßy
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('cancelBookingModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Load bank list from API
            loadBankList();
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('cancelBookingModal'));
            modal.show();
        }
        
        // VietQR lookup removed: requires auth; we simplify by skipping lookup
        
        function loadBankList() {
            const bankSelect = document.getElementById('bankCode');
            if (!bankSelect) return;
            
            // Show loading state
            bankSelect.innerHTML = '<option value="">ƒêang t·∫£i danh s√°ch ng√¢n h√†ng...</option>';
            
            fetch('/api/banks')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data) {
                        // Clear loading option
                        bankSelect.innerHTML = '<option value="">Ch·ªçn ng√¢n h√†ng</option>';
                        
                        // Add bank options
                        data.data.forEach(bank => {
                            const option = document.createElement('option');
                            option.value = bank.bin;
                            
                            // Ch·ªâ hi·ªÉn th·ªã ng√¢n h√†ng h·ªó tr·ª£ lookup
                            if (bank.lookupSupported) {
                                option.textContent = `${bank.shortName} (${bank.bin})`;
                                option.setAttribute('data-lookup-supported', 'true');
                            } else {
                                option.textContent = `${bank.shortName} (${bank.bin}) - Kh√¥ng h·ªó tr·ª£ lookup`;
                                option.setAttribute('data-lookup-supported', 'false');
                            }
                            
                            bankSelect.appendChild(option);
                        });
                    } else {
                        bankSelect.innerHTML = '<option value="">L·ªói t·∫£i danh s√°ch ng√¢n h√†ng</option>';
                    }
                })
                .catch(error => {
                    console.error('Error loading banks:', error);
                    bankSelect.innerHTML = '<option value="">L·ªói t·∫£i danh s√°ch ng√¢n h√†ng</option>';
                });
        }

        function submitCancelBooking(bookingId) {
            const form = document.getElementById('cancelBookingForm');
            const formData = new FormData(form);
            
            const cancelReason = formData.get('cancelReason');
            const bankCode = formData.get('bankCode');
            const accountNumber = formData.get('accountNumber');
            
            // Validate form
            if (!cancelReason || !bankCode || !accountNumber) {
                alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!");
                return;
            }
            
            if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy booking n√†y? H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông t·∫°o refund request cho kh√°ch h√†ng.")) {
                return;
            }

            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang h·ªßy...';
            button.disabled = true;

            fetch(`/restaurant-owner/api/bookings/${bookingId}/cancel`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin',
                body: `cancelReason=${encodeURIComponent(cancelReason)}&bankCode=${encodeURIComponent(bankCode)}&accountNumber=${encodeURIComponent(accountNumber)}`
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert("ƒê√£ h·ªßy booking v√† t·∫°o refund request th√†nh c√¥ng!");
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('cancelBookingModal'));
                    modal.hide();
                    location.reload();
                } else {
                    alert("L·ªói: " + data.message);
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("C√≥ l·ªói x·∫£y ra khi h·ªßy booking: " + error.message);
                button.innerHTML = originalText;
                button.disabled = false;
            });
        }
    </script>
    
<style>
    /* Invoice Styles */
    .invoice-container {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        border: 1px solid #e9ecef;
    }
    
    .invoice-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .invoice-title {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
    }
    
    .invoice-status .badge {
        font-size: 0.875rem;
        padding: 8px 12px;
    }
    
    /* Payment Header */
    .payment-header {
        background: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
        padding: 16px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .payment-title {
        font-size: 1rem;
        font-weight: 600;
        color: #495057;
        display: flex;
        align-items: center;
    }
    
    .payment-actions {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .payment-actions .badge {
        font-size: 0.875rem;
        padding: 6px 12px;
    }
    
    .invoice-body {
        padding: 20px;
    }
    
    .invoice-section {
        margin-bottom: 24px;
    }
    
    .invoice-section:last-of-type {
        margin-bottom: 0;
    }
    
    .invoice-section-title {
        color: #495057;
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 2px solid #e9ecef;
        display: flex;
        align-items: center;
    }
    
    /* Compact sections */
    .invoice-section-compact {
        margin-bottom: 16px;
    }
    
    .invoice-section-compact:last-of-type {
        margin-bottom: 0;
    }
    
    .invoice-section-title-compact {
        color: #495057;
        font-size: 0.875rem;
        font-weight: 600;
        margin-bottom: 8px;
        padding-bottom: 4px;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        align-items: center;
    }
    
    .invoice-items {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 12px;
        max-height: 300px;
        overflow-y: auto;
    }
    
    .invoice-item {
        transition: background-color 0.2s ease;
        padding: 12px !important;
        margin: 0 -12px;
        border-radius: 6px;
    }
    
    .invoice-item:hover {
        background-color: #e9ecef;
    }
    
    .invoice-item:last-child {
        border-bottom: none !important;
    }
    
    /* Compact items */
    .invoice-items-compact {
        background: #f8f9fa;
        border-radius: 6px;
        padding: 8px;
        max-height: 200px;
        overflow-y: auto;
    }
    
    .invoice-item-compact {
        transition: background-color 0.2s ease;
        padding: 6px !important;
        margin: 0 -8px;
        border-radius: 4px;
    }
    
    .invoice-item-compact:hover {
        background-color: #e9ecef;
    }
    
    .invoice-item-compact:last-child {
        border-bottom: none !important;
    }
    
    .invoice-subtotal {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 2px solid #dee2e6;
        background: #fff;
        border-radius: 6px;
        padding: 12px;
    }
    
    .invoice-totals {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
    }
    
    .invoice-total-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #e9ecef;
    }
    
    .invoice-total-item:last-child {
        border-bottom: none;
    }
    
    .invoice-total-final {
        margin-top: 12px;
        padding-top: 16px;
        border-top: 2px solid #007bff;
        background: #fff;
        border-radius: 6px;
        padding: 16px;
        font-size: 1.1rem;
    }
    
    .invoice-actions {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 8px;
    }
    
    .invoice-actions .badge {
        font-size: 0.875rem;
        padding: 6px 12px;
    }
    
    /* Scrollbar Styles */
    .invoice-items::-webkit-scrollbar,
    .invoice-items-compact::-webkit-scrollbar {
        width: 6px;
    }
    
    .invoice-items::-webkit-scrollbar-track,
    .invoice-items-compact::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }
    
    .invoice-items::-webkit-scrollbar-thumb,
    .invoice-items-compact::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }
    
    .invoice-items::-webkit-scrollbar-thumb:hover,
    .invoice-items-compact::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
        .invoice-header {
            flex-direction: column;
            gap: 12px;
            text-align: center;
        }
        
        .invoice-body {
            padding: 16px;
        }
        
        .invoice-item,
        .invoice-item-compact {
            flex-direction: column;
            gap: 8px;
        }
        
        .invoice-item .text-end,
        .invoice-item-compact .text-end {
            text-align: left !important;
        }
    }
    
    /* Animation */
    .invoice-container {
        animation: slideInUp 0.3s ease-out;
    }
    
    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

<!-- Cancel Reason Modal -->
<div class="modal fade" id="cancelReasonModal" tabindex="-1" aria-labelledby="cancelReasonModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cancelReasonModalLabel">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                    H·ªßy Booking
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-primary">Vui l√≤ng nh·∫≠p l√Ω do h·ªßy booking:</p>
                <form id="cancelReasonForm">
                    <div class="mb-3">
                        <label for="cancelReasonInput" class="form-label">L√Ω do h·ªßy <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="cancelReasonInput" name="cancelReason" rows="3" 
                                  placeholder="Nh·∫≠p l√Ω do h·ªßy booking..." required></textarea>
                    </div>
                    <input type="hidden" id="cancelReasonBookingId" name="bookingId" value="">
                </form>
                <div class="alert alert-warning">
                    <i class="fas fa-info-circle me-2"></i>
                    H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> H·ªßy
                </button>
                <button type="button" class="btn btn-danger" id="confirmCancelReasonBtn">
                    <i class="fas fa-check me-1"></i> X√°c nh·∫≠n h·ªßy
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1055;">
    <!-- Toasts will be dynamically added here -->
</div>

</body>
</html>
