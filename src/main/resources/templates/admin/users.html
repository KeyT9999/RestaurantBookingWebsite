<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Qu·∫£n l√Ω ng∆∞·ªùi d√πng - BookEat Admin</title>
	
	<!-- Google Fonts -->
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
	
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
	<link th:href="@{/css/design-system.css}" rel="stylesheet">
	<link th:href="@{/css/admin-dashboard.css}" rel="stylesheet">
	<link th:href="@{/css/luxury.css}" rel="stylesheet">
	
	<style>
		/* Typography base */
		body {
			font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
			font-weight: 400;
			line-height: 1.6;
		}
		
		/* Page layout follows light/blue baseline */
		.page-bg {
			background-color: #f5f6f8;
			min-height: 100vh;
		}
		
		
		/* Cards & containers */
		.filter-card {
			background: #ffffff;
			border: 1px solid rgba(226, 232, 240, 0.8);
			color: var(--text-dark);
			box-shadow: 0 10px 25px rgba(15, 23, 42, 0.06);
			border-radius: 16px;
		}
		
		.user-list-card {
			background: #ffffff;
			border: 1px solid rgba(226, 232, 240, 0.8);
			box-shadow: 0 12px 32px rgba(15, 23, 42, 0.08);
			border-radius: 20px;
			overflow: hidden;
		}
		
		.badge-role, .badge-status {
			font-size: .75rem;
			font-weight: 500;
		}
		
		.table-muted { color: var(--text-light); font-weight: 400; }
		
		.form-label { font-weight: 500; color: var(--text-dark); }
		
		/* Form controls align with booking form */
		.form-control, .form-select {
			background: var(--background-white);
			color: var(--text-dark);
			border: 1px solid var(--border-medium);
			border-radius: 6px;
		}
		
		.form-control::placeholder { color: var(--text-light); }
		
		.form-control:focus, .form-select:focus {
			background: var(--background-white);
			color: var(--text-dark);
			border-color: var(--primary-blue);
			box-shadow: 0 0 0 0.2rem rgba(74, 144, 226, 0.15);
		}
		
		.btn-gold { /* keep legacy, map to primary */
			background: var(--primary-blue);
			border-color: var(--primary-blue);
			color: var(--background-white);
			font-weight: 600;
			font-size: 0.95rem;
			padding: 0.6rem 1.2rem;
			border-radius: 8px;
			box-shadow: var(--shadow-button);
		}
		
		.btn-gold:hover {
			background: var(--primary-blue-dark);
			border-color: var(--primary-blue-dark);
			transform: translateY(-1px);
			box-shadow: var(--shadow-hover);
		}
		
		/* Users table */
		.users-table thead {
			background: #f7fafd;
			border-bottom: 1px solid rgba(209, 218, 230, 0.7);
		}
		
		.users-table thead th {
			font-size: 0.82rem;
			font-weight: 600;
			color: #4f647b;
			text-transform: uppercase;
			letter-spacing: .08em;
			padding: 0.85rem 1rem;
		}
		
		.users-table tbody tr {
			background: rgba(255, 255, 255, 0.98);
			border-bottom: 1px solid rgba(231, 238, 248, 0.8);
			transition: var(--transition);
		}
		
		.users-table tbody tr:hover {
			background: rgba(247, 250, 252, 0.92);
			border-color: rgba(15, 23, 42, 0.08);
		}
		
		.users-table td {
			padding: 0.95rem 1rem;
			color: var(--text-dark);
			vertical-align: middle;
		}
		
		.user-meta {
			display: flex;
			align-items: center;
			gap: 0.85rem;
		}
		
		.user-avatar {
			width: 44px;
			height: 44px;
			border-radius: 14px;
			background: rgba(74, 144, 226, 0.14);
			color: var(--primary-blue-dark);
			display: inline-flex;
			align-items: center;
			justify-content: center;
			font-weight: 600;
			font-size: 1rem;
		}
		
		.user-name {
			font-family: var(--font-heading);
			font-weight: 600;
			font-size: 1rem;
			color: var(--text-dark);
			margin-bottom: 2px;
		}
		
		.user-username {
			font-size: 0.82rem;
			color: #7b8ba0;
		}
		
		.role-badge {
			padding: 0.4rem 0.85rem;
			border-radius: 999px;
			font-size: 0.75rem;
			font-weight: 600;
			box-shadow: inset 0 1px 2px rgba(255,255,255,0.6);
		}
		
		.role-admin { background: linear-gradient(135deg, rgba(244,63,94,0.15), rgba(190,18,60,0.18)); color: #a41639; }
		.role-customer { background: linear-gradient(135deg, rgba(16,185,129,0.15), rgba(5,122,85,0.18)); color: #0f7a57; }
		.role-owner { background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(37,99,235,0.18)); color: #1d4ed8; }
		
		.status-badge {
			padding: 0.4rem 0.85rem;
			border-radius: 999px;
			font-size: 0.75rem;
			font-weight: 600;
			box-shadow: inset 0 1px 2px rgba(255,255,255,0.6);
		}
		
		.status-active { background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(22,163,74,0.18)); color: #178148; }
		.status-inactive { background: linear-gradient(135deg, rgba(251,191,36,0.2), rgba(217,119,6,0.18)); color: #9a5b08; }
		
		.actions-cell {
			display: flex;
			align-items: center;
			gap: 0.4rem;
		}
		
		.toggle-btn, .edit-btn { 
			border-radius: 8px; 
			transition: all 0.2s ease;
			font-weight: 500;
			font-size: 0.875rem;
			padding: 0.4rem 0.75rem;
		}
		.toggle-btn.btn-outline-danger {
			border-color: #dc3545;
			color: #dc3545;
		}
		.toggle-btn.btn-outline-danger:hover {
			background-color: #dc3545;
			color: #fff;
			border-color: #dc3545;
		}
		.toggle-btn.btn-outline-success {
			border-color: #28a745;
			color: #28a745;
		}
		.toggle-btn.btn-outline-success:hover {
			background-color: #28a745;
			color: #fff;
			border-color: #28a745;
		}
		.edit-btn:hover { 
			border-color: #4a90e2; 
			color: #4a90e2; 
			background-color: rgba(74,144,226,0.08); 
		}
		
		/* Toast styles */
		.toast-container { position: fixed; top: 120px; right: 20px; z-index: 1055; }
		.toast-custom { font-weight: 500; border-radius: 12px; border: none; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
		.toast-success { background: linear-gradient(var(--primary-blue), var(--primary-blue-dark)); color: #fff; }
		.toast-error { background: linear-gradient(#DC3545, #FD6C6C); color: #fff; }
		
		/* Loading spinner */
		.loading-spinner { animation: spin 1s linear infinite; }
		@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
		
		.csrf-token { display: none; }
		
		/* Ban/Unban Modal Styles */
		#banUnbanModal .modal-content {
			border-radius: 16px;
			border: 1px solid rgba(226, 232, 240, 0.8);
			box-shadow: 0 12px 32px rgba(15, 23, 42, 0.12);
		}
		
		#banUnbanModal .modal-header {
			border-bottom: 1px solid rgba(226, 232, 240, 0.8);
			padding: 1.25rem 1.5rem;
		}
		
		#banUnbanModal .modal-title {
			font-weight: 600;
			color: var(--text-dark);
			font-size: 1.25rem;
		}
		
		#banUnbanModal .modal-body {
			padding: 1.5rem;
		}
		
		#banUnbanModal .modal-footer {
			border-top: 1px solid rgba(226, 232, 240, 0.8);
			padding: 1rem 1.5rem;
		}
		
		#banUnbanModal .alert {
			border-radius: 8px;
			border: none;
			padding: 1rem;
		}
		
		#banUnbanModal .alert-warning {
			background-color: #fff3cd;
			color: #856404;
		}
		
		#banUnbanModal .alert-info {
			background-color: #d1ecf1;
			color: #0c5460;
		}
		
		#banUnbanModal #modalUserAvatar {
			font-size: 1.25rem;
			font-weight: 600;
		}
	</style>
</head>
<body class="page-bg">
	<div th:insert="fragments/flash :: flash"></div>
	<div th:with="activeNav='admin-users'"
	     th:replace="~{fragments/design-system-components :: unified-header}"></div>

	<main>
		<section style="padding: var(--ds-space-12) 0;">
			<div class="ds-container dashboard-shell">
				<!-- Admin Header -->
				<div th:with="headerTitle='Qu·∫£n l√Ω ng∆∞·ªùi d√πng', 
				             headerSubtitle='Qu·∫£n l√Ω v√† theo d√µi t·∫•t c·∫£ ng∆∞·ªùi d√πng trong h·ªá th·ªëng',
				             headerIcon='fa-users',
				             headerActionUrl=@{/admin/users/create},
				             headerActionText='Th√™m ng∆∞·ªùi d√πng m·ªõi',
				             headerActionIcon='fa-user-plus'"
				     th:replace="~{fragments/admin-header :: admin-header}"></div>

			<!-- Filter / Search -->
			<div class="card filter-card mb-4">
				<div class="card-body">
					<form method="get" th:action="@{/admin/users}">
						<div class="row g-3 align-items-end">
							<div class="col-md-4">
								<label class="form-label">T√¨m ki·∫øm ng∆∞·ªùi d√πng</label>
								<input class="form-control" name="q" th:value="${q}" placeholder="Nh·∫≠p username ho·∫∑c email...">
							</div>
							<div class="col-md-3">
								<label class="form-label">Vai tr√≤</label>
								<select name="role" class="form-select">
									<option th:selected="${role == null}" value="">T·∫•t c·∫£ vai tr√≤</option>
									<option value="admin" th:selected="${role?.getValue()=='admin'}">üëë Admin</option>
									<option value="customer" th:selected="${role?.getValue()=='customer'}">ÔøΩÔøΩ Customer</option>
									<option value="restaurant_owner" th:selected="${role?.getValue()=='restaurant_owner'}">ÔøΩÔøΩ Restaurant Owner</option>
								</select>
							</div>
							<div class="col-md-2">
								<label class="form-label">Hi·ªÉn th·ªã</label>
								<select name="size" class="form-select">
									<option th:selected="${size==10}" value="10">10 ng∆∞·ªùi</option>
									<option th:selected="${size==20}" value="20">20 ng∆∞·ªùi</option>
									<option th:selected="${size==50}" value="50">50 ng∆∞·ªùi</option>
								</select>
							</div>
							<div class="col-md-3 text-end">
								<input type="hidden" name="sortBy" th:value="${sortBy}">
								<input type="hidden" name="dir" th:value="${dir}">
								<button type="submit" class="btn btn-outline-secondary me-2">
									<i class="fas fa-search me-1"></i> T√¨m ki·∫øm
								</button>
								<a th:href="@{/admin/users}" class="btn btn-outline-secondary">
									<i class="fas fa-rotate-left me-1"></i> Reset
								</a>
							</div>
						</div>
					</form>
				</div>
			</div>

			<!-- Users list -->
			<div class="user-list-card" th:if="${users.totalElements > 0}">
				<div class="table-responsive">
					<table class="table align-middle users-table mb-0">
						<thead>
							<tr>
								<th>Ng∆∞·ªùi d√πng</th>
								<th>Vai tr√≤</th>
								<th>Tr·∫°ng th√°i</th>
								<th>T·∫°o l√∫c</th>
								<th>ƒêƒÉng nh·∫≠p g·∫ßn nh·∫•t</th>
								<th class="text-end">Thao t√°c</th>
							</tr>
						</thead>
						<tbody>
							<tr th:each="u : ${users.content}">
								<td>
									<div class="user-meta">
										<div class="user-avatar" th:text="${(#strings.isEmpty(u.fullName) ? u.username : u.fullName).substring(0,1).toUpperCase()}">U</div>
										<div>
											<div class="user-name" th:text="${#strings.isEmpty(u.fullName) ? u.username : u.fullName}">User name</div>
											<div class="small text-muted" th:text="${u.email}">email@example.com</div>
											<div class="user-username" th:text="'@' + ${u.username}">@username</div>
										</div>
									</div>
								</td>
								<td>
									<span class="role-badge"
									      th:classappend="${u.role.getValue()=='admin'} ? ' role-admin' : (${u.role.getValue()=='restaurant_owner'} ? ' role-owner' : ' role-customer')"
									      th:text="${u.role.getValue().toUpperCase()}">CUSTOMER</span>
								</td>
								<td>
									<span class="status-badge"
										  th:id="'status-badge-' + ${u.id}"
										  th:classappend="${u.active && u.emailVerified} ? ' status-active' : ' status-inactive'"
										  th:text="${u.active && u.emailVerified} ? 'Active' : 'Inactive'">Active</span>
								</td>
								<td>
									<div class="small text-muted" th:text="${#temporals.format(u.createdAt,'dd/MM/yyyy')}">17/11/2025</div>
								</td>
								<td>
									<div class="small text-muted" th:text="${u.lastLogin != null ? #temporals.format(u.lastLogin,'dd/MM/yyyy HH:mm') : 'Ch∆∞a bao gi·ªù'}">Ch∆∞a bao gi·ªù</div>
								</td>
								<td class="text-end">
									<div class="actions-cell justify-content-end">
										<button type="button"
										        class="btn btn-sm toggle-btn toggle-active-btn"
										        th:id="'toggle-btn-' + ${u.id}"
										        th:data-user-id="${u.id}"
										        th:data-current-status="${u.active && u.emailVerified}"
										        th:classappend="${u.active && u.emailVerified} ? 'btn-outline-danger' : 'btn-outline-success'"
										        th:title="${u.active && u.emailVerified} ? 'Kh√≥a t√†i kho·∫£n' : 'M·ªü kh√≥a t√†i kho·∫£n'">
											<i class="fas toggle-icon me-1" th:classappend="${u.active && u.emailVerified} ? ' fa-ban' : ' fa-check-circle'"></i>
											<span class="toggle-text" th:text="${u.active && u.emailVerified} ? 'Ban' : 'Unban'">Ban</span>
										</button>
										<a class="btn btn-outline-primary btn-sm edit-btn" th:href="@{|/admin/users/${u.id}/edit|}" title="Ch·ªânh s·ª≠a th√¥ng tin">
											<i class="fas fa-user-edit"></i>
										</a>
									</div>
									<form th:if="${u.deletedAt != null}" method="post" th:action="@{|/admin/users/${u.id}/restore|}" class="mt-2">
										<button type="submit" class="btn btn-outline-success btn-sm">
											<i class="fas fa-undo me-1"></i>Kh√¥i ph·ª•c
										</button>
									</form>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>

			<!-- Empty state -->
			<div class="alert alert-light text-center py-5 border" th:if="${users.totalElements == 0}">
				<i class="fas fa-users text-primary" style="font-size: 3rem; opacity: .5;"></i>
				<h5 class="mt-3 text-dark">Kh√¥ng c√≥ ng∆∞·ªùi d√πng n√†o</h5>
				<p class="mb-0 text-muted">Ch∆∞a c√≥ ng∆∞·ªùi d√πng n√†o ph√π h·ª£p v·ªõi ti√™u ch√≠ t√¨m ki·∫øm.</p>
			</div>

			<!-- Pagination -->
			<nav th:if="${users.totalPages > 1}" class="mt-5" aria-label="Users pagination">
				<ul class="pagination justify-content-center">
					<li class="page-item" th:classappend="${users.first} ? 'disabled'">
						<a class="page-link" th:href="@{|/admin/users?page=${users.number-1}&size=${size}&q=${q}&role=${role}&sortBy=${sortBy}&dir=${dir}|}" aria-label="Previous">
							<span aria-hidden="true">&laquo;</span>
						</a>
					</li>
					<li class="page-item" th:each="i : ${#numbers.sequence(0, users.totalPages-1)}" th:classappend="${i == users.number} ? 'active'">
						<a class="page-link" th:text="${i+1}" th:href="@{|/admin/users?page=${i}&size=${size}&q=${q}&role=${role}&sortBy=${sortBy}&dir=${dir}|}">1</a>
					</li>
					<li class="page-item" th:classappend="${users.last} ? 'disabled'">
						<a class="page-link" th:href="@{|/admin/users?page=${users.number+1}&size=${size}&q=${q}&role=${role}&sortBy=${sortBy}&dir=${dir}|}" aria-label="Next">
							<span aria-hidden="true">&raquo;</span>
						</a>
					</li>
				</ul>
			</nav>
			</div>
		</section>
	</main>

	<!-- Ban/Unban Confirmation Modal -->
	<div class="modal fade" id="banUnbanModal" tabindex="-1" aria-labelledby="banUnbanModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="banUnbanModalLabel">
						<i class="fas fa-exclamation-triangle text-warning me-2"></i>
						X√°c nh·∫≠n thao t√°c
					</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div class="d-flex align-items-start mb-3">
						<div class="flex-shrink-0">
							<div id="modalUserAvatar" class="user-avatar" style="width: 48px; height: 48px;">U</div>
						</div>
						<div class="flex-grow-1 ms-3">
							<h6 class="mb-1" id="modalUserName">User Name</h6>
							<p class="text-muted small mb-0" id="modalUserEmail">email@example.com</p>
						</div>
					</div>
					<div class="alert" id="modalAlert" role="alert">
						<p class="mb-0" id="modalMessage">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën th·ª±c hi·ªán thao t√°c n√†y?</p>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
					<button type="button" class="btn" id="confirmBanUnbanBtn">
						<i class="fas me-1" id="confirmIcon"></i>
						<span id="confirmText">X√°c nh·∫≠n</span>
					</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Toast Container -->
	<div class="toast-container" id="toastContainer"></div>

	<div th:replace="~{fragments/design-system-components :: unified-footer}"></div>
	<div th:replace="~{fragments/resy-scripts :: basic-scripts}"></div>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
	<script th:src="@{/js/main.js}" defer></script>
</body>
</html>
	
	<script>
	document.addEventListener('DOMContentLoaded', function() {
		const banUnbanModalEl = document.getElementById('banUnbanModal');
		const banUnbanModal = new bootstrap.Modal(banUnbanModalEl);
		let currentButton = null;
		let currentUserId = null;
		
		// Reset modal when closed
		banUnbanModalEl.addEventListener('hidden.bs.modal', function() {
			currentButton = null;
			currentUserId = null;
			const confirmBtn = document.getElementById('confirmBanUnbanBtn');
			confirmBtn.disabled = false;
			confirmBtn.querySelector('span').textContent = 'X√°c nh·∫≠n';
		});
		
		// Handle toggle active buttons - show confirmation modal
		document.querySelectorAll('.toggle-active-btn').forEach(button => {
			button.addEventListener('click', function(event) {
				event.preventDefault();
				
				currentButton = this;
				currentUserId = this.dataset.userId;
				const currentStatus = this.dataset.currentStatus === 'true';
				
				// Get user info from the table row
				const row = this.closest('tr');
				const userName = row.querySelector('.user-name')?.textContent || 'Ng∆∞·ªùi d√πng';
				const userEmail = row.querySelector('.small.text-muted')?.textContent || '';
				const userAvatar = row.querySelector('.user-avatar')?.textContent || 'U';
				
				// Update modal content
				document.getElementById('modalUserAvatar').textContent = userAvatar;
				document.getElementById('modalUserName').textContent = userName;
				document.getElementById('modalUserEmail').textContent = userEmail;
				
				// Set modal message and button based on action
				const confirmBtn = document.getElementById('confirmBanUnbanBtn');
				const confirmIcon = document.getElementById('confirmIcon');
				const confirmText = document.getElementById('confirmText');
				const modalAlert = document.getElementById('modalAlert');
				const modalMessage = document.getElementById('modalMessage');
				
				if (currentStatus) {
					// Will ban user
					modalMessage.textContent = `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën kh√≥a t√†i kho·∫£n c·ªßa "${userName}"? Ng∆∞·ªùi d√πng n√†y s·∫Ω kh√¥ng th·ªÉ ƒëƒÉng nh·∫≠p v√†o h·ªá th·ªëng.`;
					modalAlert.className = 'alert alert-warning';
					confirmBtn.className = 'btn btn-outline-danger';
					confirmIcon.className = 'fas fa-ban me-1';
					confirmText.textContent = 'Kh√≥a t√†i kho·∫£n';
				} else {
					// Will unban user
					modalMessage.textContent = `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën m·ªü kh√≥a t√†i kho·∫£n c·ªßa "${userName}"? Ng∆∞·ªùi d√πng n√†y s·∫Ω c√≥ th·ªÉ ƒëƒÉng nh·∫≠p l·∫°i v√†o h·ªá th·ªëng.`;
					modalAlert.className = 'alert alert-info';
					confirmBtn.className = 'btn btn-outline-success';
					confirmIcon.className = 'fas fa-check-circle me-1';
					confirmText.textContent = 'M·ªü kh√≥a t√†i kho·∫£n';
				}
				
				// Show modal
				banUnbanModal.show();
			});
		});
		
		// Handle confirm button in modal
		document.getElementById('confirmBanUnbanBtn').addEventListener('click', function() {
			if (!currentButton || !currentUserId) return;
			
			const button = currentButton;
			const userId = currentUserId;
			const icon = button.querySelector('.toggle-icon');
			const toggleText = button.querySelector('.toggle-text');
			
			// Disable button during request
			button.disabled = true;
			const originalIconClass = icon.className;
			icon.className = 'fas fa-spinner fa-spin loading-spinner';
			
			// Disable confirm button
			this.disabled = true;
			const originalConfirmText = this.querySelector('span').textContent;
			this.querySelector('span').textContent = 'ƒêang x·ª≠ l√Ω...';
			
			// AJAX request v·ªõi CSRF token
			fetch(`/admin/users/${userId}/toggle-active`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'X-Requested-With': 'XMLHttpRequest'
				},
				body: JSON.stringify({})
			})
			.then(response => {
				if (!response.ok) {
					throw new Error('Network response was not ok');
				}
				return response.json();
			})
			.then(data => {
				console.log('Toggle response:', data);
				
				if (data.success) {
					// Update status badge
					const badge = document.getElementById(`status-badge-${userId}`);
					
					if (data.data.newStatus === 'ACTIVE') {
						badge.className = 'status-badge status-active';
						badge.textContent = 'Active';
						if (icon) {
							icon.className = 'fas fa-ban toggle-icon me-1';
						}
						if (toggleText) {
							toggleText.textContent = 'Ban';
						}
						button.className = 'btn btn-sm toggle-btn toggle-active-btn btn-outline-danger';
						button.title = 'Kh√≥a t√†i kho·∫£n';
						button.dataset.currentStatus = 'true';
					} else {
						badge.className = 'status-badge status-inactive';
						badge.textContent = 'Inactive';
						if (icon) {
							icon.className = 'fas fa-check-circle toggle-icon me-1';
						}
						if (toggleText) {
							toggleText.textContent = 'Unban';
						}
						button.className = 'btn btn-sm toggle-btn toggle-active-btn btn-outline-success';
						button.title = 'M·ªü kh√≥a t√†i kho·∫£n';
						button.dataset.currentStatus = 'false';
					}
					
					// Close modal and show success message
					banUnbanModal.hide();
					showToast('success', data.message);
				} else {
					showToast('error', data.message || 'C√≥ l·ªói x·∫£y ra');
				}
			})
			.catch(error => {
				console.error('Toggle error:', error);
				showToast('error', 'Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi server. Vui l√≤ng th·ª≠ l·∫°i.');
			})
			.finally(() => {
				// Re-enable buttons
				button.disabled = false;
				this.disabled = false;
				this.querySelector('span').textContent = originalConfirmText;
				
				// Reset icon if there was an error (success case already updated it)
				if (icon && icon.className.includes('fa-spinner')) {
					icon.className = originalIconClass;
				}
				
				// Reset current references
				currentButton = null;
				currentUserId = null;
			});
		});
		
		// Show success message from URL parameters
		const urlParams = new URLSearchParams(window.location.search);
		const success = urlParams.get('success');
		const error = urlParams.get('error');
		
		if (success) {
			let message = '';
			switch(success) {
				case 'created': message = 'ƒê√£ t·∫°o ng∆∞·ªùi d√πng m·ªõi th√†nh c√¥ng!'; break;
				case 'updated': message = 'ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin ng∆∞·ªùi d√πng th√†nh c√¥ng!'; break;
			}
			if (message) {
				showToast('success', message);
				// Clean URL
				history.replaceState({}, document.title, window.location.pathname);
			}
		}
		
		// Show error messages
		if (error) {
			let message = '';
			switch(error) {
				case 'user_not_found': message = 'Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng!'; break;
				case 'load_failed': message = 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ng∆∞·ªùi d√πng!'; break;
				case 'update_failed': message = 'C·∫≠p nh·∫≠t th√¥ng tin th·∫•t b·∫°i!'; break;
				default: message = 'C√≥ l·ªói x·∫£y ra!'; break;
			}
			showToast('error', message);
			// Clean URL
			history.replaceState({}, document.title, window.location.pathname);
		}
	});
	
	function showToast(type, message) {
		const toastContainer = document.getElementById('toastContainer');
		
		const toastElement = document.createElement('div');
		toastElement.className = `toast toast-custom toast-${type}`;
		toastElement.setAttribute('role', 'alert');
		toastElement.innerHTML = `
			<div class="toast-body d-flex align-items-center">
				<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle'} me-3"></i>
				<span>${message}</span>
				<button type="button" class="btn-close btn-close-white ms-auto" data-bs-dismiss="toast" aria-label="Close"></button>
			</div>
		`;
		
		toastContainer.appendChild(toastElement);
		
		const toast = new bootstrap.Toast(toastElement, {
			autohide: true,
			delay: 4000
		});
		
		toast.show();
		
		// Remove toast element after it's hidden
		toastElement.addEventListener('hidden.bs.toast', function() {
			if (toastElement && toastElement.parentNode) {
				toastElement.remove();
			}
		});
	}
	</script>
</body>
</html>
