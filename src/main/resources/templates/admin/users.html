<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Quản lý người dùng - BookEat Admin</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
	<link th:href="@{/css/luxury.css}" rel="stylesheet">
	<style>
		.page-bg { background-color:#121212; min-height:100vh; }
		.section-title { color:#fff; font-family:'Playfair Display', serif; }
		.filter-card { background:#1A1A1A; border:1px solid rgba(212,175,55,.2); color:#E0E0E0; }
		.user-card { background:#1A1A1A; border:1px solid rgba(212,175,55,.2); color:#E0E0E0; border-radius:12px; transition:transform .15s ease, box-shadow .15s ease; }
		.user-card:hover { transform:translateY(-3px); box-shadow:0 10px 18px rgba(212,175,55,.15); }
		.user-avatar { width:56px; height:56px; border-radius:50%; background:linear-gradient(45deg,#D4AF37,#FFD700); color:#121212; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:1.15rem; }
		.badge-role { font-size:.8rem; }
		.badge-status { font-size:.8rem; }
		.table-muted { color:#BFBFBF; }
		.pagination .page-link { background:#1A1A1A; color:#D4AF37; border-color:rgba(212,175,55,.2); }
		.pagination .page-item.active .page-link { background:#D4AF37; color:#121212; border-color:#D4AF37; }
		.pagination .page-link:hover { background:#2A2A2A; color:#FFD700; }
		.form-control, .form-select { background:#2A2A2A; color:#E0E0E0; border:1px solid #444; }
		.form-control::placeholder { color:#8a8a8a; }
		.form-control:focus, .form-select:focus { background:#2A2A2A; color:#E0E0E0; border-color:#D4AF37; box-shadow:0 0 0 0.2rem rgba(212,175,55,.25); }
		.btn-gold { background:#D4AF37; border-color:#D4AF37; color:#121212; }
		.btn-gold:hover { background:#FFD700; border-color:#FFD700; color:#121212; }
		.link-clear { color:#E0E0E0; border-color:#E0E0E0; }
		.link-clear:hover { background:#E0E0E0; color:#121212; }
		
		/* Toast styles */
		.toast-container {
			position: fixed;
			top: 20px;
			right: 20px;
			z-index: 1055;
		}
		.toast-success {
			background-color: #198754;
			color: white;
		}
		.toast-error {
			background-color: #dc3545;
			color: white;
		}
	</style>
</head>
<body class="page-bg">
	<div th:replace="~{fragments/header :: site-header}"></div>

	<div class="container py-5">
		<div class="d-flex align-items-center justify-content-between mb-4">
			<h1 class="section-title mb-0">
				<i class="fas fa-users text-warning me-2"></i> Quản lý người dùng
			</h1>
			<a class="btn btn-gold" th:href="@{/admin/users/create}"><i class="fas fa-user-plus me-1"></i> Thêm người dùng</a>
		</div>

		<!-- Filter / Search -->
		<div class="card filter-card mb-4">
			<div class="card-body">
				<form method="get" th:action="@{/admin/users}">
					<div class="row g-3 align-items-end">
						<div class="col-md-4">
							<label class="form-label">Tìm kiếm</label>
							<input class="form-control" name="q" th:value="${q}" placeholder="Username hoặc email">
						</div>
						<div class="col-md-3">
							<label class="form-label">Vai trò</label>
							<select name="role" class="form-select">
								<option th:selected="${role == null}" value="">Tất cả</option>
								<option value="admin" th:selected="${role?.getValue()=='admin'}">Admin</option>
								<option value="customer" th:selected="${role?.getValue()=='customer'}">Customer</option>
								<option value="restaurant_owner" th:selected="${role?.getValue()=='restaurant_owner'}">Restaurant Owner</option>
							</select>
						</div>
						<div class="col-md-2">
							<label class="form-label">Mỗi trang</label>
							<select name="size" class="form-select">
								<option th:selected="${size==10}" value="10">10</option>
								<option th:selected="${size==20}" value="20">20</option>
								<option th:selected="${size==50}" value="50">50</option>
							</select>
						</div>
						<div class="col-md-3 text-end">
							<input type="hidden" name="sortBy" th:value="${sortBy}">
							<input type="hidden" name="dir" th:value="${dir}">
							<button type="submit" class="btn btn-outline-light me-2"><i class="fas fa-filter me-1"></i> Lọc</button>
							<a th:href="@{/admin/users}" class="btn btn-outline-light link-clear"><i class="fas fa-times me"> Xóa</a>
						</div>
					</div>
				</form>
			</div>
		</div>

		<!-- Users Grid -->
		<div class="row g-3" th:if="${users.totalElements > 0}">
			<div class="col-md-6 col-lg-4" th:each="u : ${users.content}">
				<div class="user-card p-3 h-100" th:data-user-id="${u.id}">
					<div class="d-flex align-items-center mb-3">
						<div class="user-avatar me-3" th:text="${(#strings.isEmpty(u.fullName) ? u.username : u.fullName).substring(0,1).toUpperCase()}">U</div>
						<div>
							<h5 class="mb-1 text-white" th:text="${#strings.isEmpty(u.fullName) ? u.username : u.fullName}">User</h5>
							<div class="table-muted small" th:text="${u.email}">email@example.com</div>
						</div>
					</div>
					<div class="mb-2"><span class="table-muted">Username:</span> <span th:text="${u.username}"></span></div>
					<div class="mb-2">
						<span class="table-muted">Role:</span>
						<span class="badge badge-role"
							  th:classappend="${u.role.getValue()=='admin'} ? ' bg-danger' : (${u.role.getValue()=='restaurant_owner'} ? ' bg-info' : ' bg-success')"
							  th:text="${u.role.getValue().toUpperCase()}">CUSTOMER</span>
					</div>
					<div class="mb-2">
						<span class="table-muted">Trạng thái:</span>
						<span class="badge badge-status" th:classappend="${u.active && u.emailVerified} ? ' bg-success' : ' bg-warning text-dark'" 
							  th:text="${u.active && u.emailVerified} ? 'Active' : 'Inactive'">Active</span>
					</div>
					<div class="mb-2"><span class="table-muted">Tạo lúc:</span> <span th:text="${#temporals.format(u.createdAt,'dd/MM/yyyy HH:mm')}"></span></div>
					<div class="mb-3"><span class="table-muted">Đăng nhập gần nhất:</span> <span th:text="${u.lastLogin != null ? #temporals.format(u.lastLogin,'dd/MM/yyyy HH:mm') : '-'}"></span></div>
					<div class="d-flex gap-2">
						<button type="button" class="btn btn-outline-light btn-sm toggle-active-btn" 
								th:data-user-id="${u.id}"
								th:data-current-active="${u.active && u.emailVerified}"
								th:title="${u.active && u.emailVerified} ? 'Khóa tài khoản' : 'Mở khóa tài khoản'">
							<i class="fas" th:classappend="${u.active && u.emailVerified} ? ' fa-lock' : ' fa-unlock'"></i>
						</button>
						<a class="btn btn-outline-light btn-sm" th:href="@{|/admin/users/${u.id}/edit|}" title="Chỉnh sửa">
							<i class="fas fa-user-pen"></i>
						</a>
					</div>
				</div>
			</div>
		</div>

		<!-- Empty state -->
		<div class="alert alert-secondary" th:if="${users.totalElements == 0}">
			<i class="fas fa-info-circle me-1"></i> Không có người dùng phù hợp.
		</div>

		<!-- Pagination -->
		<nav th:if="${users.totalPages > 1}" class="mt-4" aria-label="Users pagination">
			<ul class="pagination justify-content-center">
				<li class="page-item" th:classappend="${users.first} ? 'disabled'">
					<a class="page-link" th:href="@{|/admin/users?page=${users.number-1}&size=${size}&q=${q}&role=${role}&sortBy=${sortBy}&dir=${dir}|}" aria-label="Previous">
						<span aria-hidden="true">&laquo;</span>
					</a>
				</li>
				<li class="page-item" th:each="i : ${#numbers.sequence(0, users.totalPages-1)}" th:classappend="${i == users.number} ? 'active'">
					<a class="page-link" th:text="${i+1}" th:href="@{|/admin/users?page=${i}&size=${size}&q=${q}&role=${role}&sortBy=${sortBy}&dir=${dir}|}">1</a>
				</li>
				<li class="page-item" th:classappend="${users.last} ? 'disabled'">
					<a class="page-link" th:href="@{|/admin/users?page=${users.number+1}&size=${size}&q=${q}&role=${role}&sortBy=${sortBy}&dir=${dir}|}" aria-label="Next">
						<span aria-hidden="true">&raquo;</span>
					</a>
				</li>
			</ul>
		</nav>
	</div>

	<!-- Toast Container -->
	<div class="toast-container" id="toastContainer"></div>

	<div th:replace="~{fragments/footer :: site-footer}"></div>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
	<script th:src="@{/js/main.js}" defer></script>
	
	<script>
	document.addEventListener('DOMContentLoaded', function() {
		// Get CSRF token
		const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content') || 
						  document.querySelector('input[name="_csrf"]')?.value;
		
		// Handle toggle active buttons
		document.querySelectorAll('.toggle-active-btn').forEach(button => {
			button.addEventListener('click', function() {
				const userId = this.dataset.userId;
				const currentActive = this.dataset.currentActive === 'true';
				
				// Disable button during request
				this.disabled = true;
				const originalContent = this.innerHTML;
				this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
				
				fetch(`/admin/users/${userId}/toggle-active`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'X-Requested-With': 'XMLHttpRequest'
					},
					body: JSON.stringify({})
				})
				.then(response => response.json())
				.then(data => {
					if (data.success) {
						// Update UI
						const badge = this.closest('.user-card').querySelector('.badge-status');
						const icon = this.querySelector('i');
						
						if (data.data.active) {
							badge.className = 'badge badge-status bg-success';
							badge.textContent = 'Active';
							icon.className = 'fas fa-lock';
							this.title = 'Khóa tài khoản';
							this.dataset.currentActive = 'true';
						} else {
							badge.className = 'badge badge-status bg-warning text-dark';
							badge.textContent = 'Inactive';
							icon.className = 'fas fa-unlock';
							this.title = 'Mở khóa tài khoản';
							this.dataset.currentActive = 'false';
						}
						
						// Show success toast
						showToast('success', data.message);
					} else {
						showToast('error', data.message || 'Có lỗi xảy ra');
					}
				})
				.catch(error => {
					console.error('Error:', error);
					showToast('error', 'Có lỗi xảy ra khi kết nối với server');
				})
				.finally(() => {
					// Re-enable button
					this.disabled = false;
					this.innerHTML = originalContent;
				});
			});
		});
	});
	
	function showToast(type, message) {
		const toastContainer = document.getElementById('toastContainer');
		
		const toastElement = document.createElement('div');
		toastElement.className = `toast toast-${type}`;
		toastElement.innerHTML = `
			<div class="toast-body">
				<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} me-2"></i>
				${message}
			</div>
		`;
		
		toastContainer.appendChild(toastElement);
		
		const toast = new bootstrap.Toast(toastElement, {
			autohide: true,
			delay: 3000
		});
		
		toast.show();
		
		// Remove toast element after it's hidden
		toastElement.addEventListener('hidden.bs.toast', function() {
			toastElement.remove();
		});
	}
	</script>
</body>
</html>
