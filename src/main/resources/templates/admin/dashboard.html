<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - BookEat</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body {
            background: linear-gradient(135deg, #121212 0%, #1A1A1A 100%);
            min-height: 100vh;
            padding-top: 100px;
            color: #FFFFFF;
        }
        
        .stats-card {
            background: rgba(26, 26, 26, 0.9);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }
        
        .stats-card:hover {
            transform: translateY(-3px);
            border-color: #D4AF37;
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.15);
        }
        
        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #D4AF37;
            margin-bottom: 0.5rem;
        }
        
        .stats-label {
            color: #E0E0E0;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .chart-container {
            background: rgba(26, 26, 26, 0.9);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        /* Stabilize chart height to avoid reflow/relayout loops */
        .chart-container canvas { height: 320px !important; }
        
        .chart-title {
            color: #FFFFFF;
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        .table-container {
            background: rgba(26, 26, 26, 0.9);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .table-dark {
            --bs-table-bg: transparent;
            --bs-table-color: #E0E0E0;
            --bs-table-border-color: rgba(212, 175, 55, 0.2);
        }
        
        .table-dark th {
            border-color: rgba(212, 175, 55, 0.2);
            color: #D4AF37;
            font-weight: 600;
        }
        
        .table-dark td {
            border-color: rgba(212, 175, 55, 0.1);
        }
        
        .btn-gold {
            background: linear-gradient(135deg, #D4AF37 0%, #B8860B 100%);
            border: none;
            color: #000;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .btn-gold:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.3);
            color: #000;
        }
        
        .text-gold { color: #D4AF37 !important; }
        .text-success { color: #28a745 !important; }
        .text-warning { color: #ffc107 !important; }
        .text-danger { color: #dc3545 !important; }
    </style>
</head>

<body>
    <!-- Header Fragment -->
    <div th:insert="fragments/header :: site-header"></div>
    
    <!-- Main Content -->
    <main>
        <div class="container">
            <!-- Header -->
            <div class="row mb-5">
                <div class="col-12 text-center">
                    <h1 style="color: #FFFFFF; font-size: 2.5rem; font-weight: 700;">
                        <i class="fas fa-tachometer-alt"></i> Admin Dashboard
                    </h1>
                    <p style="color: #E0E0E0; font-size: 1.1rem;">Quản trị hệ thống BookEat</p>
                </div>
            </div>
            
            <!-- Error Message -->
            <div th:if="${error}" class="alert alert-danger" role="alert">
                <i class="fas fa-exclamation-triangle"></i> <span th:text="${error}"></span>
            </div>
            
            <!-- Withdrawal Statistics Cards -->
            <div class="row mb-4">
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="stats-card">
                        <div class="stats-number" th:text="${withdrawalStats != null ? withdrawalStats.pendingCount : 0}">0</div>
                        <div class="stats-label">Yêu cầu chờ xử lý</div>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="stats-card">
                        <div class="stats-number text-warning" th:text="${totalPendingAmount != null ? totalPendingAmount : 0}">0</div>
                        <div class="stats-label">Tiền chờ rút (VNĐ)</div>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="stats-card">
                        <div class="stats-number text-success" th:text="${totalWithdrawnAmount != null ? totalWithdrawnAmount : 0}">0</div>
                        <div class="stats-label">Đã rút (VNĐ)</div>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="stats-card">
                        <div class="stats-number text-gold" th:text="${totalCommission != null ? totalCommission : 0}">0</div>
                        <div class="stats-label">Hoa hồng thu được (VNĐ)</div>
                    </div>
                </div>
            </div>
            
            <!-- Charts Row -->
            <div class="row mb-4">
                <div class="col-lg-8 mb-4">
                    <div class="chart-container">
                        <h3 class="chart-title">
                            <i class="fas fa-chart-line"></i> Thống kê rút tiền theo tháng
                        </h3>
                        <canvas id="monthlyChart" width="400" height="200"></canvas>
                    </div>
                </div>
                
                <div class="col-lg-4 mb-4">
                    <div class="chart-container">
                        <h3 class="chart-title">
                            <i class="fas fa-chart-pie"></i> Phân bố trạng thái
                        </h3>
                        <canvas id="statusChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Top Restaurants Table -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="table-container">
                        <h3 class="chart-title">
                            <i class="fas fa-trophy"></i> Top nhà hàng rút tiền nhiều nhất
                        </h3>
                        <div class="table-responsive">
                            <table class="table table-dark table-hover">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Tên nhà hàng</th>
                                        <th>Tổng doanh thu</th>
                                        <th>Đã rút</th>
                                        <th>Đang chờ</th>
                                        <th>Số dư khả dụng</th>
                                        <th>Hoa hồng</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="restaurant, iterStat : ${topRestaurants}">
                                        <td th:text="${iterStat.index + 1}">1</td>
                                        <td>
                                            <strong th:text="${restaurant.restaurantName}">Pizza Italia</strong>
                                            <br><small class="text-muted" th:text="'ID: ' + ${restaurant.restaurantId}">ID: 18</small>
                                        </td>
                                        <td class="text-gold" th:text="${restaurant.totalRevenue} + ' VNĐ'">10,000,000 VNĐ</td>
                                        <td class="text-success" th:text="${restaurant.totalWithdrawn} + ' VNĐ'">2,200,000 VNĐ</td>
                                        <td class="text-warning" th:text="${restaurant.pendingWithdrawal} + ' VNĐ'">2,100,000 VNĐ</td>
                                        <td class="text-gold" th:text="${restaurant.availableBalance} + ' VNĐ'">4,950,000 VNĐ</td>
                                        <td class="text-gold" th:text="${restaurant.totalCommission} + ' VNĐ'">750,000 VNĐ</td>
                                    </tr>
                                    <tr th:if="${#lists.isEmpty(topRestaurants)}">
                                        <td colspan="7" class="text-center text-muted">Chưa có dữ liệu</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Restaurant Approval Statistics -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="chart-container">
                        <h3 class="chart-title">
                            <i class="fas fa-utensils"></i> Thống kê duyệt nhà hàng
                        </h3>
                        <div class="row">
                            <div class="col-lg-3 col-md-6 mb-3">
                                <div class="stats-card">
                                    <div class="stats-number text-warning" th:text="${pendingRestaurants}">0</div>
                                    <div class="stats-label">Chờ duyệt</div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 mb-3">
                                <div class="stats-card">
                                    <div class="stats-number text-success" th:text="${approvedRestaurants}">0</div>
                                    <div class="stats-label">Đã duyệt</div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 mb-3">
                                <div class="stats-card">
                                    <div class="stats-number text-danger" th:text="${rejectedRestaurants}">0</div>
                                    <div class="stats-label">Bị từ chối</div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 mb-3">
                                <div class="stats-card">
                                    <div class="stats-number text-secondary" th:text="${suspendedRestaurants}">0</div>
                                    <div class="stats-label">Tạm dừng</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Management Cards -->
            <div class="row">
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="stats-card">
                        <div class="stats-number">
                            <i class="fas fa-credit-card"></i>
                        </div>
                        <h3 style="color: #FFFFFF; font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem;">Quản lý rút tiền</h3>
                        <p style="color: #E0E0E0;">Xử lý yêu cầu rút tiền từ nhà hàng</p>
                        <a th:href="@{/admin/withdrawal}" class="btn btn-gold w-100">
                            <span>Quản lý rút tiền</span>
                        </a>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="stats-card">
                        <div class="stats-number">
                            <i class="fas fa-utensils"></i>
                            <span th:if="${pendingRestaurants > 0}" class="badge bg-warning ms-1" th:text="${pendingRestaurants}">0</span>
                        </div>
                        <h3 style="color: #FFFFFF; font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem;">Duyệt nhà hàng</h3>
                        <p style="color: #E0E0E0;">Quản lý yêu cầu đăng ký nhà hàng</p>
                        <a th:href="@{/admin/restaurant/requests}" class="btn btn-gold w-100">
                            <span>Duyệt nhà hàng</span>
                        </a>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="stats-card">
                        <div class="stats-number">
                            <i class="fas fa-users"></i>
                        </div>
                        <h3 style="color: #FFFFFF; font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem;">Quản lý người dùng</h3>
                        <p style="color: #E0E0E0;">Quản lý tài khoản người dùng</p>
                        <a th:href="@{/admin/users}" class="btn btn-gold w-100">
                            <span>Quản lý người dùng</span>
                        </a>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="stats-card">
                        <div class="stats-number">
                            <i class="fas fa-comments"></i>
                        </div>
                        <h3 style="color: #FFFFFF; font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem;">Quản lý chat</h3>
                        <p style="color: #E0E0E0;">Hỗ trợ khách hàng qua chat</p>
                        <a th:href="@{/admin/chat}" class="btn btn-gold w-100">
                            <span>Quản lý chat</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script th:inline="javascript">
        // Extract data from server
        const monthlyLabels = /*[[${monthlyStats != null ? monthlyStats.months : {}}]]*/ [];
        const monthlyAmounts = /*[[${monthlyStats != null ? monthlyStats.amounts : {}}]]*/ [];
        const pendingCount = /*[[${withdrawalStats != null ? withdrawalStats.pendingCount : 0}]]*/ 0;
        const succeededCount = /*[[${withdrawalStats != null ? withdrawalStats.succeededCount : 0}]]*/ 0;
        const rejectedCount = /*[[${withdrawalStats != null ? withdrawalStats.rejectedCount : 0}]]*/ 0;

        // Chart instance guards to avoid duplicate initializations
        if (!window.__charts__) { window.__charts__ = {}; }

        // Monthly Withdrawal Chart
        const monthlyCanvas = document.getElementById('monthlyChart');
        if (monthlyCanvas) {
            const monthlyCtx = monthlyCanvas.getContext('2d');
            if (window.__charts__.monthly) { window.__charts__.monthly.destroy(); }
            window.__charts__.monthly = new Chart(monthlyCtx, {
                type: 'line',
                data: {
                    labels: monthlyLabels,
                    datasets: [{
                        label: 'Số tiền rút (VNĐ)',
                        data: monthlyAmounts,
                        borderColor: '#D4AF37',
                        backgroundColor: 'rgba(212, 175, 55, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#E0E0E0' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#E0E0E0' },
                            grid: { color: 'rgba(212, 175, 55, 0.1)' }
                        },
                        y: {
                            ticks: {
                                color: '#E0E0E0',
                                callback: function(value) {
                                    return new Intl.NumberFormat('vi-VN').format(value) + ' VNĐ';
                                }
                            },
                            grid: { color: 'rgba(212, 175, 55, 0.1)' }
                        }
                    }
                }
            });
        }

        // Status Distribution Chart
        const statusCanvas = document.getElementById('statusChart');
        if (statusCanvas) {
            const statusCtx = statusCanvas.getContext('2d');
            if (window.__charts__.status) { window.__charts__.status.destroy(); }
            window.__charts__.status = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Chờ xử lý', 'Thành công', 'Từ chối'],
                    datasets: [{
                        data: [pendingCount, succeededCount, rejectedCount],
                        backgroundColor: ['#ffc107', '#28a745', '#dc3545'],
                        borderColor: '#1A1A1A',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#E0E0E0' } }
                    }
                }
            });
        }
    </script>
</body>
</html>
