<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Tạo thông báo mới - BookEat Admin</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
	<link th:href="@{/css/luxury.css}" rel="stylesheet">
	<!-- Flatpickr for calendar/time picker -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
	<style>
		.page-bg { background-color:#121212; min-height:100vh; }
		.section-title { color:#fff; font-family:'Playfair Display', serif; }
		.form-card { background:#1A1A1A; border:1px solid rgba(212,175,55,.2); color:#E0E0E0; }
		.form-control, .form-select { background:#2A2A2A; color:#E0E0E0; border:1px solid #444; }
		.form-control::placeholder { color:#8a8a8a; }
		.form-control:focus, .form-select:focus { background:#2A2A2A; color:#E0E0E0; border-color:#D4AF37; box-shadow:0 0 0 0.2rem rgba(212,175,55,.25); }
		.btn-gold { background:#D4AF37; border-color:#D4AF37; color:#121212; }
		.btn-gold:hover { background:#FFD700; border-color:#FFD700; color:#121212; }
		.link-clear { color:#E0E0E0; border-color:#E0E0E0; }
		.link-clear:hover { background:#E0E0E0; color:#121212; }
		.form-label { color:#E0E0E0; font-weight:500; }
		.form-check-input:checked { background-color:#D4AF37; border-color:#D4AF37; }
		.form-check-label { color:#E0E0E0; }
	</style>
</head>
<body class="page-bg">
	<div th:replace="~{fragments/header :: site-header}"></div>

	<div class="container py-5">
		<div class="row justify-content-center">
			<div class="col-lg-8">
				<div class="d-flex align-items-center mb-4">
					<a th:href="@{/admin/notifications}" class="btn btn-outline-light me-3">
						<i class="fas fa-arrow-left"></i>
					</a>
					<h1 class="section-title mb-0">
						<i class="fas fa-plus text-warning me-2"></i> Tạo thông báo mới
					</h1>
				</div>

				<div class="card form-card">
					<div class="card-body">
						<form th:action="@{/admin/notifications/create}" th:object="${notificationForm}" method="post">
							<div class="row g-3">
								<div class="col-md-6">
									<label for="type" class="form-label">
										<i class="fas fa-tag me-1"></i> Loại thông báo
									</label>
									<select th:field="*{type}" class="form-select" required>
										<option value="">-- Chọn loại thông báo --</option>
										<option th:each="type : ${notificationTypes}" 
												th:value="${type}" 
												th:text="${type}">SYSTEM_ANNOUNCEMENT</option>
									</select>
								</div>

								<div class="col-md-6">
									<label for="priority" class="form-label">
										<i class="fas fa-exclamation-triangle me-1"></i> Độ ưu tiên
									</label>
									<select th:field="*{priority}" class="form-select">
										<option value="0">Bình thường</option>
										<option value="1">Cao</option>
										<option value="2">Rất cao</option>
									</select>
								</div>

								<div class="col-12">
									<label for="title" class="form-label">
										<i class="fas fa-heading me-1"></i> Tiêu đề
									</label>
									<input th:field="*{title}" type="text" class="form-control" 
										   placeholder="Nhập tiêu đề thông báo" required maxlength="200">
								</div>

								<div class="col-12">
									<label for="content" class="form-label">
										<i class="fas fa-align-left me-1"></i> Nội dung
									</label>
									<textarea th:field="*{content}" class="form-control" rows="5" 
											  placeholder="Nhập nội dung thông báo" required></textarea>
								</div>

								<div class="col-12">
									<label for="linkUrl" class="form-label">
										<i class="fas fa-link me-1"></i> Link URL (tùy chọn)
									</label>
									<input th:field="*{linkUrl}" type="url" class="form-control" 
										   placeholder="https://example.com" maxlength="500">
								</div>

								<div class="col-12">
									<label for="audience" class="form-label">
										<i class="fas fa-users me-1"></i> Đối tượng nhận
									</label>
									<select id="audienceSelect" th:field="*{audience}" class="form-select" required>
										<option value="">-- Chọn đối tượng --</option>
										<option value="ALL">Tất cả người dùng</option>
										<option value="ROLE">Theo vai trò</option>
									</select>
								</div>

								<!-- Vai trò: hiển thị khi audience = ROLE -->
								<div class="col-12" id="rolesSection" style="display:none;">
									<label class="form-label">
										<i class="fas fa-user-tag me-1"></i> Vai trò
									</label>
									<div class="row g-2">
										<div class="col-md-4" th:each="role : ${userRoles}" th:if="${role.value != 'admin'}">
											<div class="form-check">
												<input th:field="*{targetRoles}" th:value="${role}"
													   class="form-check-input" type="checkbox">
												<label th:for="${'targetRoles' + role}" th:text="${role.displayName}"
													   class="form-check-label">Khách hàng</label>
											</div>
										</div>
									</div>
								</div>

								<div class="col-md-6">
									<label class="form-label d-block">
										<i class="fas fa-calendar-plus me-1"></i> Đặt lịch phát hành (tùy chọn)
									</label>
									<div class="form-check mb-2">
										<input id="schedulePublish" type="checkbox" class="form-check-input">
										<label for="schedulePublish" class="form-check-label">Bật đặt lịch</label>
									</div>
									<input id="publishAtInput" th:field="*{publishAt}" type="text" class="form-control datetime-picker" style="display:none;">
									<small class="form-text text-success">Nếu bật, thông báo sẽ được phát hành vào thời điểm đã chọn. Nếu tắt, hệ thống sẽ phát hành ngay sau khi gửi.</small>
								</div>

								<div class="col-md-6">
									<label for="expireAt" class="form-label">
										<i class="fas fa-calendar-times me-1"></i> Thời gian hết hạn (tùy chọn)
									</label>
									<input id="expireAtInput" th:field="*{expireAt}" type="text" class="form-control datetime-picker">
								</div>
							</div>

							<div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
								<a th:href="@{/admin/notifications}" class="btn btn-outline-light me-md-2">
									<i class="fas fa-times me-1"></i> Hủy
								</a>
								<button type="submit" class="btn btn-gold">
									<i class="fas fa-paper-plane me-1"></i> Gửi thông báo
								</button>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div th:replace="~{fragments/footer :: site-footer}"></div>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
	<script th:src="@{/js/main.js}" defer></script>
	<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
	<script>
		// Initialize flatpickr for all datetime pickers with AM/PM display, ISO submit
		const flatpickrOptions = {
			enableTime: true,
			altInput: true,
			altFormat: "d/m/Y h:i K", // show AM/PM to the user
			dateFormat: "Y-m-d\\TH:i", // submit ISO-8601 compatible
			time_24hr: false
		};
		const datetimeInputs = document.querySelectorAll('.datetime-picker');
		datetimeInputs.forEach(function(el){
			if (window.flatpickr) {
				flatpickr(el, flatpickrOptions);
			}
		});
	</script>
	<script>
		(function() {
			const audienceSelect = document.getElementById('audienceSelect');
			const rolesSection = document.getElementById('rolesSection');
			const scheduleCheckbox = document.getElementById('schedulePublish');
			const publishAtInput = document.getElementById('publishAtInput');
			let publishAtAltInput = null;
			if (publishAtInput && publishAtInput._flatpickr) {
				publishAtAltInput = publishAtInput._flatpickr.altInput || null;
			}

			function toggleRoleSection() {
				const value = audienceSelect.value;
				rolesSection.style.display = value === 'ROLE' ? '' : 'none';
			}

			function toggleSchedule() {
				const show = !!scheduleCheckbox.checked;
				publishAtInput.style.display = show ? '' : 'none';
				if (publishAtAltInput) {
					publishAtAltInput.style.display = show ? '' : 'none';
				}
				if (!show) {
					publishAtInput.value = '';
					if (publishAtInput._flatpickr) {
						publishAtInput._flatpickr.clear();
					}
				}
			}

			if (audienceSelect) {
				audienceSelect.addEventListener('change', toggleRoleSection);
				toggleRoleSection();
			}

			if (scheduleCheckbox && publishAtInput) {
				// If there is an initial value, turn on scheduling by default
				if (publishAtInput.value) {
					scheduleCheckbox.checked = true;
				}
				scheduleCheckbox.addEventListener('change', toggleSchedule);
				toggleSchedule();
			}
		})();
	</script>
</body>
</html> 