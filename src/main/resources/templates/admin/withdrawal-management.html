<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý rút tiền - Book Eat Admin</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link th:href="@{/css/design-system.css}" rel="stylesheet">

    <style>

        .ds-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--ds-space-2);
            padding: 0.35rem 0.85rem;
            border-radius: var(--ds-radius-full);
            font-size: var(--ds-font-size-sm);
            font-weight: 600;
            background: var(--ds-neutral-100);
            color: var(--ds-neutral-700);
        }

        .ds-table {
            width: 100%;
            border-collapse: collapse;
            font-size: var(--ds-font-size-sm);
        }

        .ds-table-responsive {
            border: 1px solid var(--ds-neutral-200);
            border-radius: var(--ds-radius-lg);
            background: var(--ds-primary-white);
            overflow: hidden;
            overflow-x: auto;
        }

        .ds-table thead th {
            background: var(--ds-neutral-50);
            color: var(--ds-neutral-700);
            font-weight: 600;
            padding: var(--ds-space-4);
            border-bottom: 1px solid var(--ds-neutral-200);
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.04em;
        }

        .ds-table tbody td {
            padding: var(--ds-space-4);
            border-bottom: 1px solid var(--ds-neutral-200);
            vertical-align: top;
        }

        .ds-table tbody tr:hover {
            background: var(--ds-neutral-50);
        }

        .status-pill {
            display: inline-flex;
            align-items: center;
            gap: var(--ds-space-2);
            padding: 0.25rem 0.75rem;
            border-radius: var(--ds-radius-full);
            font-weight: 600;
            font-size: 0.75rem;
        }

        .status-pill.pending {
            background: var(--ds-yellow-100);
            color: var(--ds-warning);
        }

        .status-pill.success {
            background: var(--ds-green-100);
            color: var(--ds-success);
        }

        .status-pill.rejected {
            background: #fee2e2;
            color: var(--ds-error);
        }

        .status-pill.unknown {
            background: var(--ds-neutral-100);
            color: var(--ds-neutral-700);
        }

        .withdrawal-filters .ds-btn {
            min-width: 140px;
        }

        .ds-modal-body p,
        .ds-modal-body span {
            font-size: var(--ds-font-size-sm);
        }
    </style>
</head>
<body class="ds-bg-gray-50">
    <div th:replace="~{fragments/design-system-components :: unified-header}"></div>

    <main>

        <section style="padding: var(--ds-space-12) 0;">
            <div class="ds-container ds-flex ds-flex-col ds-gap-6">
                <div class="ds-card ds-card-elevated">
                    <div class="ds-card-body ds-flex ds-flex-col ds-gap-6">
                        <div class="ds-flex ds-flex-wrap ds-gap-4 ds-justify-between ds-items-start">
                            <div class="ds-flex ds-flex-col ds-gap-1">
                                <h2 class="ds-heading-4 ds-mb-0">Danh sách yêu cầu rút tiền</h2>
                                <p class="ds-text-secondary ds-mb-0">
                                    Xem tình trạng từng yêu cầu và xác nhận chi trả ngay trên hệ thống.
                                </p>
                            </div>
                            <span class="ds-badge">
                                <i class="fas fa-clipboard-list"></i>
                                <span th:text="${withdrawals.size()} + ' yêu cầu'">0 yêu cầu</span>
                            </span>
                        </div>

                        <div th:if="${success}" class="ds-alert ds-alert-success">
                            <i class="fas fa-check-circle"></i>
                            <span th:text="${success}">Thao tác thành công.</span>
                        </div>
                        <div th:if="${error}" class="ds-alert ds-alert-error">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span th:text="${error}">Có lỗi xảy ra.</span>
                        </div>

                        <div class="withdrawal-filters ds-flex ds-flex-wrap ds-gap-2">
                            <a href="/admin/withdrawal"
                               class="ds-btn ds-btn-sm"
                               th:classappend="${filter == 'ALL'} ? ' ds-btn-primary' : ' ds-btn-outline'">
                                Tất cả
                            </a>
                            <a href="/admin/withdrawal?status=PENDING"
                               class="ds-btn ds-btn-sm"
                               th:classappend="${filter == 'PENDING'} ? ' ds-btn-primary' : ' ds-btn-outline'">
                                Chờ duyệt
                            </a>
                            <a href="/admin/withdrawal?status=SUCCEEDED"
                               class="ds-btn ds-btn-sm"
                               th:classappend="${filter == 'SUCCEEDED'} ? ' ds-btn-primary' : ' ds-btn-outline'">
                                Thành công
                            </a>
                            <a href="/admin/withdrawal?status=REJECTED"
                               class="ds-btn ds-btn-sm"
                               th:classappend="${filter == 'REJECTED'} ? ' ds-btn-primary' : ' ds-btn-outline'">
                                Từ chối
                            </a>
                        </div>

                        <div th:if="${#lists.isEmpty(withdrawals)}"
                             class="ds-card ds-card-outline ds-text-center ds-flex ds-flex-col ds-items-center ds-gap-3 ds-py-10">
                            <i class="fas fa-inbox fa-3x ds-text-muted"></i>
                            <h3 class="ds-heading-4 ds-mb-0">Chưa có yêu cầu rút tiền</h3>
                            <p class="ds-text-secondary ds-mb-0">
                                Khi nhà hàng tạo yêu cầu, bạn sẽ thấy thông tin chi tiết tại đây.
                            </p>
                        </div>

                        <div th:if="${!#lists.isEmpty(withdrawals)}" class="ds-table-responsive">
                            <table class="ds-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Người yêu cầu</th>
                                        <th>Nhà hàng</th>
                                        <th>Số tiền</th>
                                        <th>STK ngân hàng</th>
                                        <th>Ngân hàng</th>
                                        <th>Ngày tạo</th>
                                        <th>Trạng thái</th>
                                        <th>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="request : ${withdrawals}">
                                        <td>
                                            <strong th:text="'#' + ${request.requestId}">#123</strong>
                                        </td>
                                        <td>
                                            <div class="ds-flex ds-flex-col ds-gap-1">
                                                <span class="ds-text-primary ds-font-semibold"
                                                      th:text="${request.ownerName ?: 'N/A'}">Nguyễn Văn A</span>
                                                <small class="ds-text-secondary"
                                                       th:text="${request.ownerEmail ?: 'N/A'}">email@example.com</small>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="ds-flex ds-flex-col ds-gap-1">
                                                <span th:text="${request.restaurantName ?: 'N/A'}">Pizza Italia</span>
                                                <small class="ds-text-secondary"
                                                       th:text="'ID: ' + ${request.restaurantId}">ID: 18</small>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="ds-flex ds-flex-col ds-gap-1">
                                                <span class="ds-text-success ds-font-semibold"
                                                      th:text="${#numbers.formatDecimal(request.amount, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'">
                                                    1,000,000 VNĐ
                                                </span>
                                                <small class="ds-text-secondary"
                                                       th:text="${request.description ?: 'Rút tiền về tài khoản ngân hàng'}">
                                                    Ghi chú
                                                </small>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="ds-flex ds-flex-col ds-gap-1">
                                                <span th:text="${request.bankAccountNumber ?: 'N/A'}">1234567890</span>
                                                <small class="ds-text-secondary"
                                                       th:text="${request.accountHolderName ?: 'N/A'}">Tên chủ tài khoản</small>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="ds-flex ds-flex-col ds-gap-1">
                                                <span th:text="${request.bankName ?: 'N/A'}">Vietcombank</span>
                                                <small class="ds-text-secondary"
                                                       th:text="${request.bankCode ?: 'N/A'}">970436</small>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="ds-flex ds-flex-col ds-gap-1">
                                                <span th:text="${#temporals.format(request.createdAt, 'dd/MM/yyyy')}">08/10/2025</span>
                                                <small class="ds-text-secondary"
                                                       th:text="${#temporals.format(request.createdAt, 'HH:mm')}">14:04</small>
                                            </div>
                                        </td>
                                        <td>
                                            <span th:switch="${request.status.name()}">
                                                <span th:case="'PENDING'" class="status-pill pending">
                                                    <i class="fas fa-clock"></i> Chờ duyệt
                                                </span>
                                                <span th:case="'SUCCEEDED'" class="status-pill success">
                                                    <i class="fas fa-check-circle"></i> Thành công
                                                </span>
                                                <span th:case="'REJECTED'" class="status-pill rejected">
                                                    <i class="fas fa-xmark-circle"></i> Từ chối
                                                </span>
                                                <span th:case="*" class="status-pill unknown" th:text="${request.status.name()}">
                                                    UNKNOWN
                                                </span>
                                            </span>
                                        </td>
                                        <td>
                                            <div th:switch="${request.status.name()}" class="ds-flex ds-flex-col ds-gap-2">
                                                <div th:case="'PENDING'" class="ds-flex ds-flex-col ds-gap-2">
                                                    <button type="button"
                                                            class="ds-btn ds-btn-success ds-btn-sm"
                                                            th:attr="data-bs-toggle='modal', data-bs-target='#markPaidModal', data-request-id=${request.requestId}">
                                                        <i class="fas fa-check-circle"></i>
                                                        Chấp nhận
                                                    </button>
                                                    <button type="button"
                                                            class="ds-btn ds-btn-danger ds-btn-sm"
                                                            th:attr="data-bs-toggle='modal', data-bs-target='#rejectModal', data-request-id=${request.requestId}">
                                                        <i class="fas fa-xmark-circle"></i>
                                                        Từ chối
                                                    </button>
                                                </div>
                                                <div th:case="'SUCCEEDED'" class="ds-text-success ds-flex ds-gap-2 ds-items-center">
                                                    <i class="fas fa-check-circle"></i>
                                                    <span>Đã chuyển tiền</span>
                                                </div>
                                                <div th:case="'REJECTED'" class="ds-text-error ds-flex ds-gap-2 ds-items-center">
                                                    <i class="fas fa-ban"></i>
                                                    <span>Đã từ chối</span>
                                                </div>
                                                <div th:case="*" class="ds-text-secondary">-</div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div th:replace="~{fragments/design-system-components :: unified-footer}"></div>

    <!-- Mark Paid Modal -->
    <div class="modal fade" id="markPaidModal" tabindex="-1" aria-labelledby="markPaidModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form id="markPaidForm" method="post">
                    <div class="modal-header">
                        <h5 class="modal-title" id="markPaidModalLabel">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            Xác nhận đã chuyển tiền
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body ds-modal-body ds-flex ds-flex-col ds-gap-3">
                        <input type="hidden" name="requestId" id="markPaidRequestId" value="">
                        <div class="ds-alert ds-alert-info ds-mb-0">
                            <i class="fas fa-info-circle"></i>
                            <span>Hãy chắc chắn rằng bạn đã hoàn tất việc chuyển tiền cho nhà hàng trước khi xác nhận.</span>
                        </div>
                        <p class="ds-text-secondary ds-mb-0">
                            Sau khi xác nhận, trạng thái yêu cầu sẽ được cập nhật thành <strong>đã thanh toán</strong> và không thể hoàn tác.
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="ds-btn ds-btn-outline" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="ds-btn ds-btn-success">Xác nhận đã chuyển tiền</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Reject Modal -->
    <div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form id="rejectForm" method="post">
                    <div class="modal-header">
                        <h5 class="modal-title" id="rejectModalLabel">
                            <i class="fas fa-circle-exclamation text-danger me-2"></i>
                            Từ chối yêu cầu rút tiền
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body ds-modal-body ds-flex ds-flex-col ds-gap-3">
                        <input type="hidden" name="requestId" id="rejectRequestId" value="">
                        <div class="ds-alert ds-alert-warning ds-mb-0">
                            <i class="fas fa-triangle-exclamation"></i>
                            <span>Hành động này sẽ đánh dấu yêu cầu bị từ chối. Hãy nhập lý do rõ ràng để nhà hàng nắm thông tin.</span>
                        </div>
                        <div class="ds-flex ds-flex-col ds-gap-3">
                            <label for="rejectReason" class="ds-text-secondary ds-font-semibold">
                                Lý do từ chối <span class="ds-text-error">*</span>
                            </label>
                            <select class="form-select" id="rejectReason" name="rejectReason" required>
                                <option value="">-- Chọn lý do --</option>
                                <option value="THONG_TIN_SAI">Thông tin tài khoản ngân hàng không chính xác</option>
                                <option value="SO_TIEN_KHONG_HOP_LE">Số tiền rút không hợp lệ</option>
                                <option value="THIEU_CHUNG_TU">Thiếu chứng từ xác minh</option>
                                <option value="VI_PHAM_QUY_DINH">Vi phạm quy định của hệ thống</option>
                                <option value="KHAC">Lý do khác</option>
                            </select>
                        </div>
                        <div class="ds-flex ds-flex-col ds-gap-2">
                            <label for="rejectNote" class="ds-text-secondary ds-font-semibold">Ghi chú chi tiết</label>
                            <textarea class="form-control" id="rejectNote" name="rejectNote" rows="4"
                                      placeholder="Mô tả chi tiết lý do từ chối..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="ds-btn ds-btn-outline" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="ds-btn ds-btn-danger">Xác nhận từ chối</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div th:replace="~{fragments/resy-scripts :: basic-scripts}"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const markPaidModal = document.getElementById('markPaidModal');
            if (markPaidModal) {
                markPaidModal.addEventListener('show.bs.modal', function (event) {
                    const button = event.relatedTarget;
                    const requestId = button.getAttribute('data-request-id');
                    document.getElementById('markPaidRequestId').value = requestId;
                    document.getElementById('markPaidForm').action = '/admin/withdrawal/' + requestId + '/mark-paid';
                });
            }

            const rejectModal = document.getElementById('rejectModal');
            if (rejectModal) {
                rejectModal.addEventListener('show.bs.modal', function (event) {
                    const button = event.relatedTarget;
                    const requestId = button.getAttribute('data-request-id');
                    document.getElementById('rejectRequestId').value = requestId;
                    document.getElementById('rejectForm').action = '/admin/withdrawal/' + requestId + '/reject';
                });
            }
        });
    </script>
</body>
</html>
