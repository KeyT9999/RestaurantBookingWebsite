<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${pageTitle}">OpenAI Debug</title>
    <meta name="_csrf" th:if="${_csrf != null}" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:if="${_csrf != null}" th:content="${_csrf.headerName}" />
    <style>
        body { font-family: Inter, system-ui, Arial, sans-serif; margin: 24px; }
        .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
        .row { display: flex; gap: 12px; align-items: center; }
        textarea { width: 100%; min-height: 120px; padding: 10px; }
        button { padding: 8px 14px; border-radius: 8px; border: 1px solid #111827; background: #111827; color: #fff; cursor: pointer; }
        pre { background: #0b1020; color: #e5e7eb; padding: 12px; border-radius: 8px; overflow: auto; }
        .muted { color: #6b7280; }
        .grid { display: grid; gap: 10px; }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        input { width: 100%; padding: 8px 10px; }
        label { font-size: 12px; color: #374151; }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
</head>
<body>
    <h1>OpenAI Debug</h1>

    <div class="card">
        <h3>1) Check API key</h3>
        <div class="row">
            <button id="btn-check"><i class="fa-solid fa-heart-pulse"></i> Check</button>
            <span class="muted">GET /api/openai/check</span>
        </div>
        <pre id="out-check">(ch∆∞a ch·∫°y)</pre>
    </div>

    <div class="card">
        <h3>2) Th·ª≠ vi·∫øt l·∫°i</h3>
        <textarea id="text-input">Qu√°n kh√° ·ªïn, m√≥n n∆∞·ªõng th∆°m, ph·ª•c v·ª• nhanh.</textarea>
        <div class="row">
            <button id="btn-rewrite"><i class="fa-solid fa-wand-magic-sparkles"></i> Rewrite</button>
            <span class="muted">POST /api/openai/improve-sample</span>
        </div>
        <pre id="out-rewrite">(ch∆∞a ch·∫°y)</pre>
    </div>

    <div class="card">
        <h3>3) ü§ñ ƒêi·ªÅn t·ª± ƒë·ªông b·∫±ng AI</h3>
        <textarea id="autofill-input">Nh√† h√†ng: Country BBQ & Beer ‚Äì Tr·∫ßn B·∫°ch ƒê·∫±ng
ƒê·ªãa ch·ªâ: 45 Tr·∫ßn B·∫°ch ƒê·∫±ng, S∆°n Tr√†, ƒê√† N·∫µng
ƒêi·ªán tho·∫°i: 0901 234 567
Lo·∫°i ·∫©m th·ª±c: Vietnamese BBQ, Grill, Beer Garden
Gi·ªù m·ªü c·ª≠a: 10:30 - 22:30
Gi√° trung b√¨nh: 180000 VNƒê
Kho·∫£ng gi√°: 80000 - 290000 VNƒê
Th√¥ng b√°o: ƒêang m·ªü c·ª≠a: 10:30 - 22:30
M√¥ t·∫£: BBQ ngo√†i tr·ªùi tho√°ng m√°t, m√≥n n∆∞·ªõng than h·ªìng, bia l·∫°nh.
M√≥n ƒë·∫∑c s·∫Øc: s∆∞·ªùn n∆∞·ªõng m·∫≠t ong, b·∫°ch tu·ªôc sa t·∫ø, h√†u n∆∞·ªõng m·ª° h√†nh.
T·ªïng quan: ph√π h·ª£p t·ª• t·∫≠p b·∫°n b√®, li√™n hoan c√¥ng ty.</textarea>
        <div class="row">
            <button id="btn-autofill"><i class="fa-solid fa-robot"></i> Auto-Fill</button>
            <span class="muted">POST /api/restaurant/ai/auto-fill</span>
        </div>
        <pre id="out-autofill">(ch∆∞a ch·∫°y)</pre>
    </div>

    <div class="card">
        <h3>4) üçΩÔ∏è AI Food Recommendation (T∆∞ v·∫•n m√≥n ƒÉn)</h3>
        <p class="muted" style="margin-bottom: 12px;">Test AI g·ª£i √Ω m√≥n ƒÉn v√† t√¨m nh√† h√†ng ph√π h·ª£p</p>
        
        <div style="margin-bottom: 12px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">C√¢u h·ªèi c·ªßa b·∫°n:</label>
            <textarea id="food-query" style="width: 100%; min-height: 80px; padding: 10px; border-radius: 8px; border: 1px solid #d1d5db;">t√¥i mu·ªën ƒÉn ƒë·ªì healthy. ho·∫∑c t√¥i ƒëang t·∫≠p gym t√¥i n√™n ƒÉn ƒë·ªì g√¨</textarea>
        </div>
        
        <div style="margin-bottom: 16px; padding: 12px; background: #f9fafb; border-radius: 8px;">
            <label style="display: block; margin-bottom: 8px; font-size: 13px; color: #6b7280;">üìù V√≠ d·ª• nhanh (click ƒë·ªÉ ch·ªçn):</label>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                <button type="button" class="example-btn" onclick="document.getElementById('food-query').value='t√¥i ƒëang t·∫≠p gym t√¥i n√™n ƒÉn ƒë·ªì g√¨'" 
                    style="padding: 6px 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; font-size: 13px;">
                    üèãÔ∏è T·∫≠p gym
                </button>
                <button type="button" class="example-btn" onclick="document.getElementById('food-query').value='t√¥i mu·ªën ƒÉn ƒë·ªì healthy'" 
                    style="padding: 6px 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; font-size: 13px;">
                    ü•ó Healthy
                </button>
                <button type="button" class="example-btn" onclick="document.getElementById('food-query').value='t√¥i ƒëang gi·∫£m c√¢n mu·ªën ƒÉn g√¨ ƒë√≥'" 
                    style="padding: 6px 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; font-size: 13px;">
                    ‚öñÔ∏è Gi·∫£m c√¢n
                </button>
                <button type="button" class="example-btn" onclick="document.getElementById('food-query').value='t√¥i mu·ªën b·ªï sung protein'" 
                    style="padding: 6px 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; font-size: 13px;">
                    üí™ Protein
                </button>
                <button type="button" class="example-btn" onclick="document.getElementById('food-query').value='t√¥i mu·ªën ƒÉn g√† n∆∞·ªõng'" 
                    style="padding: 6px 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; font-size: 13px;">
                    üçó G√† n∆∞·ªõng
                </button>
            </div>
        </div>
        
        <div style="margin-bottom: 16px;" class="grid grid-2">
            <div>
                <label style="display: block; margin-bottom: 4px;">S·ªë l∆∞·ª£ng k·∫øt qu·∫£</label>
                <input id="food-maxResults" type="number" value="5" min="1" max="10" style="width: 100%; padding: 8px;" />
            </div>
            <div>
                <label style="display: block; margin-bottom: 4px;">V·ªã tr√≠ (optional)</label>
                <input id="food-location" type="text" placeholder="V√≠ d·ª•: Qu·∫≠n 1" style="width: 100%; padding: 8px;" />
            </div>
        </div>
        
        <div class="row">
            <button id="btn-food-recommend"><i class="fa-solid fa-utensils"></i> T√¨m nh√† h√†ng b·∫±ng AI</button>
            <span class="muted">POST /ai/search</span>
        </div>
        
        <div style="margin-top: 16px;">
            <strong>üìä K·∫øt qu·∫£ AI Analysis:</strong>
            <pre id="out-food-analysis" style="margin-top: 8px;">(ch∆∞a ch·∫°y)</pre>
        </div>
        
        <div style="margin-top: 16px;">
            <strong>üçΩÔ∏è M√≥n ƒÉn ƒë∆∞·ª£c ƒë·ªÅ xu·∫•t:</strong>
            <div id="suggested-foods-list" style="margin-top: 8px; padding: 12px; background: #f9fafb; border-radius: 8px; min-height: 40px;">
                <span class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu</span>
            </div>
        </div>
        
        <div style="margin-top: 16px;">
            <strong>üè™ Nh√† h√†ng ph√π h·ª£p:</strong>
            <div id="restaurant-recommendations" style="margin-top: 8px;">
                <span class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu</span>
            </div>
        </div>
        
        <div style="margin-top: 16px;">
            <strong>üìù Full Response (JSON):</strong>
            <pre id="out-food-full" style="margin-top: 8px;">(ch∆∞a ch·∫°y)</pre>
        </div>
    </div>

    <div class="card">
        <h3>5) Boxes xem tr∆∞·ªõc k·∫øt qu·∫£ Auto-Fill</h3>
        <div class="row">
            <button id="btn-autofill-and-fill"><i class="fa-solid fa-wand-magic-sparkles"></i> Auto-Fill ‚Üí ƒêi·ªÅn v√†o boxes</button>
            <span class="muted">S·ª≠ d·ª•ng n·ªôi dung ·ªü m·ª•c 3, g·ªçi API r·ªìi ƒëi·ªÅn v√†o c√°c √¥ b√™n d∆∞·ªõi</span>
        </div>
        <div class="grid grid-3" style="margin-top:12px">
            <div>
                <label>T√™n nh√† h√†ng</label>
                <input id="box-restaurantName" />
            </div>
            <div>
                <label>S·ªë ƒëi·ªán tho·∫°i</label>
                <input id="box-phone" />
            </div>
            <div>
                <label>Lo·∫°i ·∫©m th·ª±c</label>
                <input id="box-cuisineType" />
            </div>
            <div class="grid-2" style="grid-column:1 / -1; display:grid; gap:10px;">
                <div>
                    <label>Gi·ªù m·ªü c·ª≠a</label>
                    <input id="box-openingHours" />
                </div>
                <div>
                    <label>Tr·∫°ng th√°i</label>
                    <input id="box-statusMessage" />
                </div>
            </div>
            <div>
                <label>Gi√° trung b√¨nh</label>
                <input id="box-averagePrice" />
            </div>
            <div>
                <label>Gi√° th·∫•p nh·∫•t</label>
                <input id="box-priceRangeMin" />
            </div>
            <div>
                <label>Gi√° cao nh·∫•t</label>
                <input id="box-priceRangeMax" />
            </div>
            <div style="grid-column:1 / -1;">
                <label>ƒê·ªãa ch·ªâ</label>
                <input id="box-address" />
            </div>
            <div style="grid-column:1 / -1;">
                <label>M√¥ t·∫£ ng·∫Øn</label>
                <input id="box-description" />
            </div>
            <div style="grid-column:1 / -1;">
                <label>M√≥n ƒë·∫∑c s·∫Øc</label>
                <input id="box-signatureDishes" />
            </div>
            <div style="grid-column:1 / -1;">
                <label>T·ªïng quan</label>
                <input id="box-summaryHighlights" />
            </div>
        </div>
    </div>

    <script>
        function getCsrfHeaders() {
            const token = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
            const header = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content') || 'X-CSRF-TOKEN';
            return token ? { [header]: token } : {};
        }

        document.getElementById('btn-check').addEventListener('click', async () => {
            const out = document.getElementById('out-check');
            out.textContent = 'Loading...';
            try {
                const res = await fetch('/api/openai/check');
                const data = await res.json();
                out.textContent = JSON.stringify(data, null, 2);
            } catch (e) {
                out.textContent = e.message;
            }
        });

        document.getElementById('btn-rewrite').addEventListener('click', async () => {
            const out = document.getElementById('out-rewrite');
            const text = document.getElementById('text-input').value;
            out.textContent = 'Loading...';
            try {
                const res = await fetch('/api/openai/improve-sample', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...getCsrfHeaders() },
                    body: JSON.stringify({ text })
                });
                const data = await res.json();
                out.textContent = JSON.stringify(data, null, 2);
            } catch (e) {
                out.textContent = e.message;
            }
        });

        document.getElementById('btn-autofill').addEventListener('click', async () => {
            const out = document.getElementById('out-autofill');
            const text = document.getElementById('autofill-input').value;
            out.textContent = 'Loading...';
            try {
                const res = await fetch('/api/restaurant/ai/auto-fill', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...getCsrfHeaders() },
                    body: JSON.stringify({ longText: text })
                });
                
                // Check if response is OK
                if (!res.ok) {
                    const text = await res.text();
                    // Check if response is HTML (error page)
                    if (text.trim().startsWith('<!DOCTYPE') || text.trim().startsWith('<html')) {
                        out.textContent = `Error ${res.status}: Server returned HTML instead of JSON. This usually means:\n` +
                            `- Authentication required (please login first)\n` +
                            `- Access denied (check your user role)\n` +
                            `- Server error\n\n` +
                            `Response preview: ${text.substring(0, 200)}...`;
                    } else {
                        // Try to parse as JSON error
                        try {
                            const errorData = JSON.parse(text);
                            out.textContent = JSON.stringify(errorData, null, 2);
                        } catch {
                            out.textContent = `Error ${res.status}: ${text}`;
                        }
                    }
                    return;
                }
                
                // Parse JSON response
                const contentType = res.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const data = await res.json();
                    out.textContent = JSON.stringify(data, null, 2);
                } else {
                    const text = await res.text();
                    out.textContent = `Warning: Expected JSON but got ${contentType || 'unknown'}\n\n${text.substring(0, 500)}`;
                }
            } catch (e) {
                out.textContent = `Error: ${e.message}\n\nMake sure you are logged in and have the required permissions.`;
            }
        });

        document.getElementById('btn-food-recommend').addEventListener('click', async () => {
            const query = document.getElementById('food-query').value;
            const maxResults = parseInt(document.getElementById('food-maxResults').value) || 5;
            const location = document.getElementById('food-location').value || null;
            
            const outAnalysis = document.getElementById('out-food-analysis');
            const outFull = document.getElementById('out-food-full');
            const suggestedFoodsList = document.getElementById('suggested-foods-list');
            const restaurantRecommendations = document.getElementById('restaurant-recommendations');
            
            outAnalysis.textContent = 'Loading...';
            outFull.textContent = 'Loading...';
            suggestedFoodsList.innerHTML = '<span class="muted">ƒêang ph√¢n t√≠ch...</span>';
            restaurantRecommendations.innerHTML = '<span class="muted">ƒêang t√¨m ki·∫øm...</span>';
            
            try {
                const requestBody = {
                    query: query,
                    maxResults: maxResults
                };
                
                if (location) {
                    requestBody.locationQuery = location;
                }
                
                const res = await fetch('/ai/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...getCsrfHeaders() },
                    body: JSON.stringify(requestBody)
                });
                
                if (!res.ok) {
                    const text = await res.text();
                    outAnalysis.textContent = `Error ${res.status}: ${text}`;
                    outFull.textContent = `Error ${res.status}: ${text}`;
                    suggestedFoodsList.innerHTML = '<span style="color: #ef4444;">C√≥ l·ªói x·∫£y ra</span>';
                    restaurantRecommendations.innerHTML = '<span style="color: #ef4444;">C√≥ l·ªói x·∫£y ra</span>';
                    return;
                }
                
                const data = await res.json();
                
                // Display full JSON
                outFull.textContent = JSON.stringify(data, null, 2);
                
                // Display AI Analysis
                const analysisInfo = {
                    'Query g·ªëc': data.originalQuery,
                    'Intent Type': data.intentType || 'N/A',
                    'Search Strategy': data.searchStrategy || 'N/A',
                    'AI Interpretation': data.aiInterpretation || 'N/A',
                    'Explanation': data.explanation || 'N/A',
                    'T·ªïng s·ªë t√¨m th·∫•y': data.totalFound,
                    'S·ªë k·∫øt qu·∫£ tr·∫£ v·ªÅ': data.totalReturned
                };
                outAnalysis.textContent = JSON.stringify(analysisInfo, null, 2);
                
                // Display Suggested Foods
                if (data.suggestedFoods && data.suggestedFoods.length > 0) {
                    suggestedFoodsList.innerHTML = data.suggestedFoods
                        .map(food => `<span style="display: inline-block; background: #3b82f6; color: white; padding: 4px 12px; border-radius: 16px; margin: 4px; font-size: 14px;">${food}</span>`)
                        .join('');
                } else {
                    suggestedFoodsList.innerHTML = '<span class="muted">Kh√¥ng c√≥ m√≥n ƒÉn ƒë∆∞·ª£c ƒë·ªÅ xu·∫•t</span>';
                }
                
                // Display Restaurant Recommendations
                if (data.recommendations && data.recommendations.length > 0) {
                    restaurantRecommendations.innerHTML = data.recommendations
                        .map((rec, index) => {
                            const distanceText = rec.distanceKm ? `${rec.distanceKm.toFixed(1)} km` : 'N/A';
                            const rating = rec.rating || 'N/A';
                            const priceRange = rec.priceRange || 'N/A';
                            const cuisine = rec.cuisineType || 'N/A';
                            const address = rec.address || 'N/A';
                            const phone = rec.phone || 'N/A';
                            
                            return `
                                <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; margin-bottom: 12px; background: white;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                        <div>
                                            <strong style="font-size: 16px; color: #111827;">${index + 1}. ${rec.restaurantName}</strong>
                                            <div style="color: #6b7280; font-size: 14px; margin-top: 4px;">
                                                <i class="fa-solid fa-location-dot"></i> ${address}
                                            </div>
                                        </div>
                                        <span style="background: #10b981; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                            ‚≠ê ${rating}
                                        </span>
                                    </div>
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 8px; font-size: 13px; color: #6b7280;">
                                        <div><i class="fa-solid fa-utensils"></i> ${cuisine}</div>
                                        <div><i class="fa-solid fa-money-bill"></i> ${priceRange}</div>
                                        <div><i class="fa-solid fa-map-marker-alt"></i> ${distanceText}</div>
                                    </div>
                                    <div style="display: flex; gap: 8px; margin-top: 8px; font-size: 13px; color: #6b7280;">
                                        <div><i class="fa-solid fa-phone"></i> ${phone}</div>
                                    </div>
                                    ${rec.explanation ? `<div style="margin-top: 8px; padding: 8px; background: #f0f9ff; border-left: 3px solid #3b82f6; font-size: 13px; color: #1e40af;">${rec.explanation}</div>` : ''}
                                </div>
                            `;
                        })
                        .join('');
                } else {
                    restaurantRecommendations.innerHTML = '<div style="padding: 12px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; color: #991b1b;">Kh√¥ng t√¨m th·∫•y nh√† h√†ng ph√π h·ª£p. H√£y th·ª≠ c√¢u h·ªèi kh√°c!</div>';
                }
                
            } catch (e) {
                outAnalysis.textContent = `Error: ${e.message}`;
                outFull.textContent = `Error: ${e.message}`;
                suggestedFoodsList.innerHTML = '<span style="color: #ef4444;">C√≥ l·ªói x·∫£y ra</span>';
                restaurantRecommendations.innerHTML = '<span style="color: #ef4444;">C√≥ l·ªói x·∫£y ra</span>';
            }
        });

        document.getElementById('btn-autofill-and-fill').addEventListener('click', async () => {
            const text = document.getElementById('autofill-input').value;
            const out = document.getElementById('out-autofill');
            out.textContent = 'Loading...';
            try {
                const res = await fetch('/api/restaurant/ai/auto-fill', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...getCsrfHeaders() },
                    body: JSON.stringify({ longText: text })
                });
                
                // Check if response is OK
                if (!res.ok) {
                    const text = await res.text();
                    // Check if response is HTML (error page)
                    if (text.trim().startsWith('<!DOCTYPE') || text.trim().startsWith('<html')) {
                        out.textContent = `Error ${res.status}: Server returned HTML instead of JSON. This usually means:\n` +
                            `- Authentication required (please login first)\n` +
                            `- Access denied (check your user role)\n` +
                            `- Server error\n\n` +
                            `Response preview: ${text.substring(0, 200)}...`;
                    } else {
                        // Try to parse as JSON error
                        try {
                            const errorData = JSON.parse(text);
                            out.textContent = JSON.stringify(errorData, null, 2);
                        } catch {
                            out.textContent = `Error ${res.status}: ${text}`;
                        }
                    }
                    return;
                }
                
                // Parse JSON response
                const contentType = res.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const data = await res.json();
                    out.textContent = JSON.stringify(data, null, 2);
                    
                    // Fill form fields if successful
                    if (data && data.success && data.filledFields) {
                        const f = data.filledFields;
                        const set = (id, v) => { const el = document.getElementById('box-' + id); if (el && v !== undefined && v !== null) el.value = String(v); };
                        set('restaurantName', f.restaurantName);
                        set('phone', f.phone);
                        set('cuisineType', f.cuisineType);
                        set('openingHours', f.openingHours);
                        set('statusMessage', f.statusMessage);
                        set('averagePrice', f.averagePrice);
                        set('priceRangeMin', f.priceRangeMin);
                        set('priceRangeMax', f.priceRangeMax);
                        set('address', f.address);
                        set('description', f.description);
                        set('signatureDishes', f.signatureDishes);
                        set('summaryHighlights', f.summaryHighlights);
                    }
                } else {
                    const text = await res.text();
                    out.textContent = `Warning: Expected JSON but got ${contentType || 'unknown'}\n\n${text.substring(0, 500)}`;
                }
            } catch (e) {
                out.textContent = `Error: ${e.message}\n\nMake sure you are logged in and have the required permissions.`;
            }
        });
    </script>
</body>
</html>


