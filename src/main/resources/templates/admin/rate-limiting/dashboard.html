<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf?.token}">
    <meta name="_csrf_header" th:content="${_csrf?.headerName}">
    <title>Rate Limiting Dashboard - Admin Panel</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Home Resy Style CSS -->
    <link th:href="@{/css/home-resy.css}" rel="stylesheet">
    <!-- Login Modal CSS -->
    <link th:href="@{/css/login-modal.css}" rel="stylesheet">
    
    <style>
        /* ================================================
           RATE LIMITING DASHBOARD - BLACK & WHITE THEME
           Match typography and style with home page
           ================================================ */
        
        :root {
            /* Black & White Theme - Match home page */
            --resy-black: #1A1A1A;
            --resy-gray: #6B7280;
            --resy-light-gray: #F3F4F6;
            --resy-white: #FFFFFF;
            
            /* Spacing - Match home page */
            --space-xs: 0.5rem;
            --space-sm: 1rem;
            --space-md: 1.5rem;
            --space-lg: 2rem;
            --space-xl: 3rem;
            
            /* Border radius */
            --radius-sm: 0.5rem;
            --radius-md: 0.75rem;
            --radius-lg: 1rem;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.5;
            color: var(--resy-black);
            background: var(--resy-white);
            margin: 0;
            padding: 0;
        }

        /* Page Container */
        .rate-limiting-page {
            min-height: 100vh;
            padding-top: 0; /* Header is sticky */
        }

        /* Page Header Section */
        .page-header-section {
            background: var(--resy-white);
            border-bottom: 1px solid #E5E7EB;
            padding: var(--space-lg) 0;
            margin-bottom: var(--space-xl);
        }

        .page-header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 var(--space-sm);
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--resy-black);
            margin: 0 0 var(--space-xs) 0;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .page-title i {
            color: #2563EB;
        }

        .page-subtitle {
            font-size: 1rem;
            color: var(--resy-gray);
            margin: 0;
            font-weight: 400;
        }

        .page-actions {
            display: flex;
            gap: var(--space-sm);
            margin-top: var(--space-md);
        }

        /* Statistics Cards Grid */
        .stats-grid {
            max-width: 1200px;
            margin: 0 auto var(--space-xl);
            padding: 0 var(--space-sm);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-md);
        }

        .stat-card {
            background: var(--resy-white);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid #E5E7EB;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--resy-black);
            transition: width 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-card:hover::before {
            width: 6px;
        }

        .stat-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-md);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--resy-white);
        }

        /* Icon colors for different stat types */
        .stat-card:nth-child(1) .stat-icon {
            background: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%);
        }

        .stat-card:nth-child(2) .stat-icon {
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
        }

        .stat-card:nth-child(3) .stat-icon {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
        }

        .stat-card:nth-child(4) .stat-icon {
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--resy-black);
            margin: 0;
            line-height: 1.2;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--resy-gray);
            font-weight: 500;
            margin-top: var(--space-xs);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Content Container */
        .content-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 var(--space-sm);
        }

        /* Data Card */
        .data-card {
            background: var(--resy-white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid #E5E7EB;
            margin-bottom: var(--space-lg);
            overflow: hidden;
        }

        .data-card-header {
            background: var(--resy-black);
            color: var(--resy-white);
            padding: var(--space-md) var(--space-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 600;
            font-size: 1.125rem;
        }

        .data-card-header i {
            margin-right: var(--space-xs);
            color: var(--resy-white);
        }

        /* Icon colors in table headers */
        .table-modern th i {
            color: #2563EB;
            margin-right: 0.25rem;
        }

        .data-card-body {
            padding: var(--space-lg);
        }

        /* Table Styles */
        .table-modern {
            width: 100%;
            border-collapse: collapse;
        }

        .table-modern thead {
            background: var(--resy-light-gray);
        }

        .table-modern th {
            padding: var(--space-md);
            text-align: left;
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--resy-gray);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 2px solid #E5E7EB;
        }

        .table-modern td {
            padding: var(--space-md);
            border-bottom: 1px solid #F3F4F6;
            vertical-align: middle;
        }

        /* Actions column - ensure buttons display properly */
        .table-modern td:last-child {
            white-space: nowrap;
            min-width: 150px;
        }

        .table-modern tbody tr {
            transition: background-color 0.2s ease;
        }

        .table-modern tbody tr:hover {
            background-color: var(--resy-light-gray);
        }

        .table-modern tbody tr:last-child td {
            border-bottom: none;
        }

        /* Badge Styles - With Colors */
        .badge-modern {
            display: inline-flex;
            align-items: center;
            padding: 0.375rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            line-height: 1;
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.1);
            color: #EF4444;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.1);
            color: #F59E0B;
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.1);
            color: #10B981;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .badge-secondary {
            background: var(--resy-light-gray);
            color: var(--resy-gray);
        }

        /* Button Styles - Match home page */
        .btn-modern {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 8px 20px;
            border-radius: 6px;
            font-weight: 500;
            font-size: 14px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .btn-modern:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #2563EB;
            color: var(--resy-white);
        }

        .btn-primary:hover:not(:disabled) {
            background: #1D4ED8;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-danger {
            background: #EF4444;
            color: var(--resy-white);
        }

        .btn-danger:hover:not(:disabled) {
            background: #DC2626;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-success {
            background: #10B981;
            color: var(--resy-white);
        }

        .btn-success:hover:not(:disabled) {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-warning {
            background: #F59E0B;
            color: var(--resy-white);
        }

        .btn-warning:hover:not(:disabled) {
            background: #D97706;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid #E5E7EB;
            color: var(--resy-black);
        }

        .btn-outline:hover:not(:disabled) {
            background: var(--resy-light-gray);
            border-color: var(--resy-gray);
        }

        .btn-sm {
            padding: 0.5rem 0.75rem;
            font-size: 0.8125rem;
            min-width: auto;
            white-space: nowrap;
        }

        /* Alert Styles */
        .alert-modern {
            padding: var(--space-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-md);
            background: var(--resy-light-gray);
        }

        .alert-warning {
            border-left: 4px solid #F59E0B;
            background: rgba(245, 158, 11, 0.05);
        }

        .alert-danger {
            border-left: 4px solid #EF4444;
            background: rgba(239, 68, 68, 0.05);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: var(--space-xl);
            color: var(--resy-gray);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: var(--space-md);
            color: #10B981;
        }

        .empty-state p {
            margin: 0;
            font-size: 1rem;
        }

        /* Quick Actions Grid */
        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-md);
        }

        /* Modal Styles */
        .modal-content {
            border-radius: var(--radius-lg);
            border: none;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            background: var(--resy-black);
            color: var(--resy-white);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            padding: var(--space-lg);
        }

        .modal-title {
            font-weight: 600;
            font-size: 1.25rem;
        }

        .form-label {
            font-weight: 500;
            color: var(--resy-black);
            margin-bottom: var(--space-xs);
            font-size: 0.875rem;
        }

        .form-control,
        .form-select {
            border: 1px solid #E5E7EB;
            border-radius: var(--radius-md);
            padding: 0.625rem 0.875rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: #2563EB;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            outline: none;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .page-title {
                font-size: 1.5rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .page-actions {
                flex-direction: column;
            }

            .page-actions .btn-modern {
                width: 100%;
            }

            .table-modern {
                font-size: 0.875rem;
            }

            .table-modern th,
            .table-modern td {
                padding: var(--space-sm);
            }

            .actions-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Notification Toast */
        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            max-width: 500px;
        }
    </style>
</head>
<body>
    <!-- Header from Home Page -->
    <header class="header">
        <div class="container">
            <!-- Left Section: Logo only -->
            <div class="header-left">
                <a th:href="@{/}" class="logo">Book Eat</a>
            </div>
            
            <!-- Center Section: Navigation -->
            <div class="header-center">
                <nav>
                    <ul class="nav-menu">
                        <li><a th:href="@{/}">Trang chủ</a></li>
                        <li><a th:href="@{/restaurants}">Nhà hàng</a></li>
                    </ul>
                </nav>
            </div>
            
            <!-- Right Section: Actions -->
            <div class="header-right">
                <div class="header-actions">
                    <!-- Authenticated User Actions -->
                    <div sec:authorize="isAuthenticated()" class="user-actions">
                        <!-- Admin Dashboard -->
                        <a th:href="@{/admin/dashboard}" class="btn-resy" sec:authorize="hasRole('ADMIN')">
                            <i class="fas fa-cog"></i>
                            Admin
                        </a>
                        
                        <!-- User Profile Dropdown -->
                        <div class="user-dropdown">
                            <button class="btn-resy-outline dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-user-circle"></i>
                                <span sec:authentication="name">User</span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                    <a class="dropdown-item" th:href="@{/auth/profile}">
                                        <i class="fas fa-user me-2"></i>
                                        Profile
                                    </a>
                                </li>
                                <li sec:authorize="hasRole('ADMIN')">
                                    <a class="dropdown-item" th:href="@{/admin/dashboard}">
                                        <i class="fas fa-cog me-2"></i>
                                        Admin Dashboard
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <form th:action="@{/logout}" method="post" class="d-inline">
                                        <button type="submit" class="dropdown-item border-0 bg-transparent w-100 text-start">
                                            <i class="fas fa-sign-out-alt me-2"></i>
                                            Đăng xuất
                                        </button>
                                    </form>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="rate-limiting-page">
        <!-- Page Header -->
        <div class="page-header-section">
            <div class="page-header-content">
                <h1 class="page-title">
                    <i class="fas fa-shield-alt"></i>
                    Rate Limiting Dashboard
                </h1>
                <p class="page-subtitle">Advanced Security Monitoring & Management System</p>
                <div class="page-actions">
                    <button class="btn-modern btn-primary" onclick="refreshData()">
                        <i class="fas fa-sync-alt"></i>
                        <span>Refresh Data</span>
                    </button>
                    <button class="btn-modern btn-success" onclick="exportData()">
                        <i class="fas fa-download"></i>
                        <span>Export</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-card-header">
                    <div>
                        <div class="stat-number" th:text="${overallStats.totalRequests}">1000</div>
                        <div class="stat-label">Total Requests</div>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-card-header">
                    <div>
                        <div class="stat-number" th:text="${overallStats.blockedRequests}">50</div>
                        <div class="stat-label">Blocked Requests</div>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-ban"></i>
                    </div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-card-header">
                    <div>
                        <div class="stat-number" th:text="${overallStats.successfulRequests}">950</div>
                        <div class="stat-label">Successful Requests</div>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-card-header">
                    <div>
                        <div class="stat-number" th:text="${overallStats.blockedIps}">10</div>
                        <div class="stat-label">Blocked IPs</div>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="content-container">
            <div class="row">
                <!-- Top Blocked IPs -->
                <div class="col-lg-8 mb-4">
                    <div class="data-card">
                        <div class="data-card-header">
                            <span>
                                <i class="fas fa-list"></i>
                                Top Blocked IPs
                            </span>
                        </div>
                        <div class="data-card-body">
                            <div class="table-responsive">
                                <table class="table-modern">
                                    <thead>
                                        <tr>
                                            <th><i class="fas fa-globe"></i> IP Address</th>
                                            <th><i class="fas fa-chart-bar"></i> Blocked</th>
                                            <th><i class="fas fa-exclamation-triangle"></i> Risk</th>
                                            <th><i class="fas fa-tag"></i> Status</th>
                                            <th><i class="fas fa-cogs"></i> Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="ip : ${topBlockedIps}">
                                            <td>
                                                <strong th:text="${ip.ipAddress}">192.168.1.100</strong>
                                            </td>
                                            <td>
                                                <span class="badge-modern badge-warning" th:text="${ip.blockedCount}">15</span>
                                            </td>
                                            <td>
                                                <span th:if="${ip.riskScore > 80}" class="badge-modern badge-danger" th:text="${ip.riskScore} + '%'">85%</span>
                                                <span th:if="${ip.riskScore > 50 and ip.riskScore <= 80}" class="badge-modern badge-warning" th:text="${ip.riskScore} + '%'">65%</span>
                                                <span th:if="${ip.riskScore <= 50}" class="badge-modern badge-success" th:text="${ip.riskScore} + '%'">30%</span>
                                            </td>
                                            <td>
                                                <span th:if="${ip.isSuspicious}" class="badge-modern badge-danger">
                                                    <i class="fas fa-exclamation-triangle" style="color: #EF4444;"></i> Suspicious
                                                </span>
                                                <span th:unless="${ip.isSuspicious}" class="badge-modern badge-success">
                                                    <i class="fas fa-check" style="color: #10B981;"></i> Normal
                                                </span>
                                            </td>
                                            <td>
                                                <div style="display: flex; gap: 0.5rem; flex-wrap: nowrap; align-items: center; justify-content: flex-start;">
                                                    <button class="btn-modern btn-outline btn-sm" onclick="viewIpDetails('${ip.ipAddress}')" title="View Details" style="flex-shrink: 0;">
                                                        <i class="fas fa-eye" style="color: #2563EB;"></i>
                                                    </button>
                                                    <button class="btn-modern btn-danger btn-sm" onclick="blockIp('${ip.ipAddress}')" title="Block IP" style="flex-shrink: 0;">
                                                        <i class="fas fa-ban"></i>
                                                    </button>
                                                    <button class="btn-modern btn-success btn-sm" onclick="unblockIp('${ip.ipAddress}')" title="Unblock IP" style="flex-shrink: 0;">
                                                        <i class="fas fa-unlock"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr th:if="${#lists.isEmpty(topBlockedIps)}">
                                            <td colspan="5" class="empty-state">
                                                <i class="fas fa-check-circle"></i>
                                                <p>No blocked IPs found</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Alerts -->
                <div class="col-lg-4 mb-4">
                    <div class="data-card">
                        <div class="data-card-header">
                            <span>
                                <i class="fas fa-bell"></i>
                                Recent Alerts
                            </span>
                        </div>
                        <div class="data-card-body">
                            <div th:each="alert : ${recentAlerts}" class="alert-modern alert-warning">
                                <div style="display: flex; justify-content: space-between; align-items: start; gap: 1rem;">
                                    <div style="flex: 1;">
                                        <strong th:text="${alert.ipAddress}">192.168.1.100</strong>
                                        <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem;" th:text="${alert.message}">High risk score detected</p>
                                        <small style="color: var(--resy-gray);" th:text="${alert.severity}">HIGH</small>
                                    </div>
                                    <small style="color: var(--resy-gray); white-space: nowrap;" th:text="${alert.createdAt}">2025-10-12 23:00:00</small>
                                </div>
                            </div>
                            <div th:if="${#lists.isEmpty(recentAlerts)}" class="empty-state">
                                <i class="fas fa-check-circle"></i>
                                <p>No recent alerts</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Suspicious IPs -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="data-card">
                        <div class="data-card-header">
                            <span>
                                <i class="fas fa-exclamation-triangle"></i>
                                Suspicious IPs
                                <span class="badge-modern badge-warning ms-2" th:text="${#lists.size(suspiciousIps)}">0</span>
                            </span>
                        </div>
                        <div class="data-card-body">
                            <div class="table-responsive">
                                <table class="table-modern">
                                    <thead>
                                        <tr>
                                            <th><i class="fas fa-globe"></i> IP Address</th>
                                            <th><i class="fas fa-chart-bar"></i> Blocked</th>
                                            <th><i class="fas fa-exclamation-triangle"></i> Risk</th>
                                            <th><i class="fas fa-clock"></i> Detected</th>
                                            <th><i class="fas fa-cog"></i> Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="suspicious : ${suspiciousIps}">
                                            <td>
                                                <strong th:text="${suspicious.ipAddress}">192.168.1.100</strong>
                                                <br>
                                                <small style="color: var(--resy-gray); font-size: 0.75rem;" th:text="${suspicious.reason}">Rate limit exceeded multiple times</small>
                                            </td>
                                            <td>
                                                <span class="badge-modern badge-danger" th:text="${suspicious.blockedCount}">10</span>
                                            </td>
                                            <td>
                                                <span class="badge-modern badge-warning" th:text="${suspicious.riskScore} + '%'">85%</span>
                                            </td>
                                            <td>
                                                <small style="color: var(--resy-gray);" th:text="${suspicious.detectedAt}">2025-10-12 15:30</small>
                                            </td>
                                            <td>
                                                <div style="display: flex; gap: 0.5rem; flex-wrap: nowrap; align-items: center; justify-content: flex-start;">
                                                    <button class="btn-modern btn-outline btn-sm" onclick="viewIpDetails('${suspicious.ipAddress}')" title="View Details" style="flex-shrink: 0;">
                                                        <i class="fas fa-eye" style="color: #2563EB;"></i>
                                                    </button>
                                                    <button class="btn-modern btn-danger btn-sm" onclick="blockSuspiciousIp('${suspicious.ipAddress}')" title="Block IP" style="flex-shrink: 0;">
                                                        <i class="fas fa-ban"></i>
                                                    </button>
                                                    <button class="btn-modern btn-success btn-sm" onclick="clearSuspiciousFlag('${suspicious.ipAddress}')" title="Clear Flag" style="flex-shrink: 0;">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr th:if="${#lists.isEmpty(suspiciousIps)}">
                                            <td colspan="5" class="empty-state">
                                                <i class="fas fa-check-circle"></i>
                                                <p>No suspicious IPs detected</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Permanently Blocked IPs -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="data-card">
                        <div class="data-card-header">
                            <span>
                                <i class="fas fa-lock"></i>
                                Permanently Blocked IPs
                            </span>
                        </div>
                        <div class="data-card-body">
                            <div class="table-responsive">
                                <table class="table-modern">
                                    <thead>
                                        <tr>
                                            <th><i class="fas fa-globe"></i> IP Address</th>
                                            <th><i class="fas fa-file-text"></i> Reason</th>
                                            <th><i class="fas fa-clock"></i> Blocked At</th>
                                            <th><i class="fas fa-user"></i> Blocked By</th>
                                            <th><i class="fas fa-cogs"></i> Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="blocked : ${permanentlyBlocked}">
                                            <td>
                                                <strong th:text="${blocked.ipAddress}">192.168.1.102</strong>
                                            </td>
                                            <td th:text="${blocked.reason}">Multiple violations</td>
                                            <td th:text="${blocked.blockedAt}">2025-10-12 22:00:00</td>
                                            <td>
                                                <span class="badge-modern badge-secondary">ADMIN</span>
                                            </td>
                                            <td>
                                                <div style="display: flex; gap: 0.5rem; flex-wrap: nowrap; align-items: center; justify-content: flex-start;">
                                                    <button class="btn-modern btn-success btn-sm" onclick="unblockPermanent('${blocked.ipAddress}')" title="Unblock" style="flex-shrink: 0;">
                                                        <i class="fas fa-unlock"></i> Unblock
                                                    </button>
                                                    <button class="btn-modern btn-outline btn-sm" onclick="editBlockReason('${blocked.ipAddress}')" title="Edit Reason" style="flex-shrink: 0;">
                                                        <i class="fas fa-edit" style="color: #2563EB;"></i> Edit
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr th:if="${#lists.isEmpty(permanentlyBlocked)}">
                                            <td colspan="5" class="empty-state">
                                                <i class="fas fa-check-circle"></i>
                                                <p>No permanently blocked IPs</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="data-card">
                        <div class="data-card-header">
                            <span>
                                <i class="fas fa-bolt"></i>
                                Quick Actions
                            </span>
                        </div>
                        <div class="data-card-body">
                            <div class="actions-grid">
                                <button class="btn-modern btn-primary" onclick="clearAllBlocks()">
                                    <i class="fas fa-trash"></i>
                                    <span>Clear All Blocks</span>
                                </button>
                                <button class="btn-modern btn-warning" onclick="resetAllLimits()">
                                    <i class="fas fa-redo"></i>
                                    <span>Reset All Limits</span>
                                </button>
                                <button class="btn-modern btn-success" onclick="addWhitelistIp()">
                                    <i class="fas fa-plus"></i>
                                    <span>Add Whitelist IP</span>
                                </button>
                                <button class="btn-modern btn-danger" onclick="blockIpManual()">
                                    <i class="fas fa-ban"></i>
                                    <span>Block IP Manually</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Block IP Modal -->
    <div class="modal fade" id="blockIpModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-ban me-2"></i>Block IP Address
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="blockIpForm">
                        <div class="mb-3">
                            <label class="form-label">IP Address</label>
                            <input type="text" class="form-control" id="blockIpAddress" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Reason</label>
                            <select class="form-select" id="blockReason" required>
                                <option value="">Select a reason</option>
                                <option value="Suspicious activity">Suspicious activity</option>
                                <option value="Multiple violations">Multiple violations</option>
                                <option value="Bot behavior">Bot behavior</option>
                                <option value="Manual block">Manual block</option>
                                <option value="DDoS attack">DDoS attack</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notes (Optional)</label>
                            <textarea class="form-control" id="blockNotes" rows="3" placeholder="Additional notes..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-modern btn-outline" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn-modern btn-danger" onclick="confirmBlockIp()">Block IP</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Whitelist IP Modal -->
    <div class="modal fade" id="whitelistModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plus me-2"></i>Add Whitelist IP
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="whitelistForm">
                        <div class="mb-3">
                            <label class="form-label">IP Address</label>
                            <input type="text" class="form-control" id="whitelistIpAddress" placeholder="192.168.1.100" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <input type="text" class="form-control" id="whitelistDescription" placeholder="Trusted IP address">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-modern btn-outline" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn-modern btn-success" onclick="confirmAddWhitelist()">Add to Whitelist</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JavaScript -->
    <script>
        // Global variables
        let currentIpAddress = '';
        let blockModal = null;
        let whitelistModal = null;

        // Initialize modals
        document.addEventListener('DOMContentLoaded', function() {
            blockModal = new bootstrap.Modal(document.getElementById('blockIpModal'));
            whitelistModal = new bootstrap.Modal(document.getElementById('whitelistModal'));
        });

        // Refresh data
        function refreshData() {
            showNotification('Refreshing data...', 'info');
            setTimeout(() => {
                location.reload();
            }, 1000);
        }

        // Export data
        function exportData() {
            showNotification('Exporting data...', 'info');
            
            fetch('/admin/rate-limiting/api/export-data', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const blob = new Blob([JSON.stringify(data.data, null, 2)], { type: 'application/json' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `rate_limiting_data_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    showNotification(`Data exported successfully (${data.totalRecords} records)`, 'success');
                } else {
                    showNotification('Error exporting data: ' + data.message, 'error');
                }
            })
            .catch(error => {
                showNotification('Error exporting data: ' + error.message, 'error');
            });
        }

        // View IP details
        function viewIpDetails(ipAddress) {
            showNotification(`Viewing details for IP: ${ipAddress}`, 'info');
            alert(`IP Details for ${ipAddress}:\n\nThis would show detailed information about the IP address including:\n- Request history\n- Risk analysis\n- Geographic location\n- Associated user agents\n- Block/unblock history`);
        }

        // Block IP
        function blockIp(ipAddress) {
            currentIpAddress = ipAddress;
            document.getElementById('blockIpAddress').value = ipAddress;
            blockModal.show();
        }

        // Confirm block IP
        function confirmBlockIp() {
            const reason = document.getElementById('blockReason').value;
            const notes = document.getElementById('blockNotes').value;
            
            if (!reason) {
                showNotification('Please select a reason for blocking', 'error');
                return;
            }
            
            showNotification(`Blocking IP ${currentIpAddress}...`, 'info');
            
            fetch('/admin/rate-limiting/api/block-ip', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    ipAddress: currentIpAddress,
                    reason: reason,
                    notes: notes
                })
            })
            .then(response => response.json())
            .then(data => {
                blockModal.hide();
                showNotification(data.message, 'success');
                setTimeout(() => location.reload(), 1500);
            })
            .catch(error => {
                showNotification('Error blocking IP: ' + error.message, 'error');
            });
        }

        // Unblock IP
        function unblockIp(ipAddress) {
            if (confirm(`Are you sure you want to unblock IP ${ipAddress}?`)) {
                showNotification(`Unblocking IP ${ipAddress}...`, 'info');
                
                fetch('/admin/rate-limiting/api/unblock-ip', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ipAddress: ipAddress
                    })
                })
                .then(response => response.json())
                .then(data => {
                    showNotification(data.message, 'success');
                    setTimeout(() => location.reload(), 1500);
                })
                .catch(error => {
                    showNotification('Error unblocking IP: ' + error.message, 'error');
                });
            }
        }

        // Unblock permanent
        function unblockPermanent(ipAddress) {
            if (confirm(`Are you sure you want to remove permanent block for IP ${ipAddress}?`)) {
                showNotification(`Removing permanent block for IP ${ipAddress}...`, 'info');
                
                fetch('/admin/rate-limiting/api/unblock-permanent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ipAddress: ipAddress
                    })
                })
                .then(response => response.json())
                .then(data => {
                    showNotification(data.message, 'success');
                    setTimeout(() => location.reload(), 1500);
                })
                .catch(error => {
                    showNotification('Error removing permanent block: ' + error.message, 'error');
                });
            }
        }

        // Edit block reason
        function editBlockReason(ipAddress) {
            const newReason = prompt(`Enter new reason for blocking IP ${ipAddress}:`, 'Updated reason');
            if (newReason) {
                showNotification(`Updating block reason for IP ${ipAddress}...`, 'info');
                
                fetch('/admin/rate-limiting/api/edit-block-reason', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ipAddress: ipAddress,
                        newReason: newReason
                    })
                })
                .then(response => response.json())
                .then(data => {
                    showNotification(data.message, 'success');
                    setTimeout(() => location.reload(), 1500);
                })
                .catch(error => {
                    showNotification('Error updating block reason: ' + error.message, 'error');
                });
            }
        }

        // Block suspicious IP
        function blockSuspiciousIp(ipAddress) {
            currentIpAddress = ipAddress;
            document.getElementById('blockIpAddress').value = ipAddress;
            blockModal.show();
        }

        // Clear suspicious flag
        function clearSuspiciousFlag(ipAddress) {
            if (confirm(`Are you sure you want to clear the suspicious flag for IP ${ipAddress}?`)) {
                showNotification(`Clearing suspicious flag for IP ${ipAddress}...`, 'info');
                
                fetch('/admin/rate-limiting/api/clear-suspicious-flag', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ipAddress: ipAddress
                    })
                })
                .then(response => response.json())
                .then(data => {
                    showNotification(data.message, 'success');
                    setTimeout(() => location.reload(), 1500);
                })
                .catch(error => {
                    showNotification('Error clearing suspicious flag: ' + error.message, 'error');
                });
            }
        }

        // Clear all blocks
        function clearAllBlocks() {
            if (confirm('Are you sure you want to clear ALL rate limit blocks? This action cannot be undone.')) {
                showNotification('Clearing all rate limit blocks...', 'warning');
                
                fetch('/admin/rate-limiting/api/clear-all-blocks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    showNotification(data.message, 'success');
                    setTimeout(() => location.reload(), 1500);
                })
                .catch(error => {
                    showNotification('Error clearing blocks: ' + error.message, 'error');
                });
            }
        }

        // Reset all limits
        function resetAllLimits() {
            if (confirm('Are you sure you want to reset ALL rate limits? This will reset counters for all IPs.')) {
                showNotification('Resetting all rate limits...', 'warning');
                
                fetch('/admin/rate-limiting/api/reset-all-limits', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    showNotification(data.message, 'success');
                    setTimeout(() => location.reload(), 1500);
                })
                .catch(error => {
                    showNotification('Error resetting limits: ' + error.message, 'error');
                });
            }
        }

        // Add whitelist IP
        function addWhitelistIp() {
            whitelistModal.show();
        }

        // Confirm add whitelist
        function confirmAddWhitelist() {
            const ipAddress = document.getElementById('whitelistIpAddress').value;
            const description = document.getElementById('whitelistDescription').value;
            
            if (!ipAddress) {
                showNotification('Please enter an IP address', 'error');
                return;
            }
            
            showNotification(`Adding IP ${ipAddress} to whitelist...`, 'info');
            
            fetch('/admin/rate-limiting/api/whitelist-ip', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    ipAddress: ipAddress,
                    description: description
                })
            })
            .then(response => response.json())
            .then(data => {
                whitelistModal.hide();
                showNotification(data.message, 'success');
                document.getElementById('whitelistIpAddress').value = '';
                document.getElementById('whitelistDescription').value = '';
            })
            .catch(error => {
                showNotification('Error adding to whitelist: ' + error.message, 'error');
            });
        }

        // Block IP manually
        function blockIpManual() {
            const ipAddress = prompt('Enter IP address to block:', '192.168.1.100');
            if (ipAddress) {
                currentIpAddress = ipAddress;
                document.getElementById('blockIpAddress').value = ipAddress;
                blockModal.show();
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show notification-toast`;
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        // Auto refresh every 30 seconds
        setInterval(function() {
            fetch('/admin/rate-limiting/api/statistics')
                .then(response => response.json())
                .then(data => {
                    const statNumbers = document.querySelectorAll('.stat-number');
                    if (statNumbers.length >= 4) {
                        statNumbers[0].textContent = data.totalRequests || '1000';
                        statNumbers[1].textContent = data.blockedRequests || '50';
                        statNumbers[2].textContent = data.successfulRequests || '950';
                        statNumbers[3].textContent = data.blockedIps || '10';
                    }
                })
                .catch(error => console.log('Error refreshing data:', error));
        }, 30000);
    </script>
</body>
</html>

</body>
</html>
